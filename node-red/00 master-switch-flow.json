[
    {
        "id": "acde727d4cb42aaa",
        "type": "tab",
        "label": "Home Battery Master Switch",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "5b3831da1b35bb1d",
        "type": "group",
        "z": "acde727d4cb42aaa",
        "name": "Marstek master control switch",
        "style": {
            "label": true
        },
        "nodes": [
            "b9f84cc9f5a92c37",
            "db8935b06e0974bc",
            "ce0d5547e473555e",
            "64dc39c70599dfc4",
            "8b5ef482f35ef9c0"
        ],
        "x": 34,
        "y": 19,
        "w": 898,
        "h": 382
    },
    {
        "id": "8b5ef482f35ef9c0",
        "type": "group",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "964d538dd74d6c05",
            "0a5e50316b0d2b70",
            "9875fb4be6ce951f",
            "3141628fc4063a26",
            "9f47be1a4b1c355b",
            "06cec7476db26e79"
        ],
        "x": 414,
        "y": 99,
        "w": 492,
        "h": 222
    },
    {
        "id": "b9f84cc9f5a92c37",
        "type": "api-current-state",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 60,
        "wires": [
            [
                "db8935b06e0974bc"
            ]
        ]
    },
    {
        "id": "964d538dd74d6c05",
        "type": "function",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Set RS485 and Work Modes",
        "func": "// array for output \nlet outputArray = [];\n\n// battery to target\nconst target = `marstek_m${msg.battery_index}`;\n\n// Set | work mode\nconst workModeAction = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_user_work_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.work_mode)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.work_mode ? { payload: workModeAction, topic:\"user_work_mode\"}: null);\n\n// Set | rs485\nconst rs485Action = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_rs485_control_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.rs485)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.rs485 ? { payload: rs485Action, topic: \"rs485_control_mode\" } : null);\n\n// Store calls in msg to allow checking of loop results\nmsg.loop_result = { target, workModeAction, rs485Action };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Outputs\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 180,
        "wires": [
            [
                "0a5e50316b0d2b70"
            ],
            [
                "9875fb4be6ce951f"
            ],
            [
                "9f47be1a4b1c355b"
            ]
        ]
    },
    {
        "id": "db8935b06e0974bc",
        "type": "function",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// configurables\nlet workMode = null; // manual, anti-feed, ai, null = don't set or alter this setting\nlet rs485 = null;  // enable, disable, null = don't set or alter this setting\n\n// mode select\nswitch (msg.marstek_master_battery_mode) {\n    case \"Manual control\":\n        workMode = \"manual\";\n        rs485 = \"disable\";\n        break;\n    case \"Marstek control\":\n        // the user should select a work mode via the Marstek App or via select.marstek_mX_user_work_mode\n        rs485 = \"disable\";\n        break;\n    case \"Full control\":\n        rs485 = \"enable\";\n        break;\n    default:\n        node.status({fill:\"red\",shape:\"ring\",text:`Unhandled mode: ${msg.marstek_master_battery_mode}`});\n        return null; // stop flow\n}\n\n// Continue\nmsg.work_mode = workMode;\nmsg.rs485 = rs485;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 180,
        "wires": [
            [
                "964d538dd74d6c05"
            ]
        ]
    },
    {
        "id": "9f47be1a4b1c355b",
        "type": "function",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 240,
        "wires": [
            [
                "3141628fc4063a26",
                "06cec7476db26e79"
            ]
        ]
    },
    {
        "id": "3141628fc4063a26",
        "type": "switch",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 640,
        "y": 240,
        "wires": [
            [
                "964d538dd74d6c05"
            ],
            [
                "ce0d5547e473555e"
            ]
        ]
    },
    {
        "id": "0a5e50316b0d2b70",
        "type": "api-call-service",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Set work mode",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 800,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "9875fb4be6ce951f",
        "type": "api-call-service",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Set RS485",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 790,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "06cec7476db26e79",
        "type": "debug",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 510,
        "y": 280,
        "wires": []
    },
    {
        "id": "ce0d5547e473555e",
        "type": "debug",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 360,
        "wires": []
    },
    {
        "id": "64dc39c70599dfc4",
        "type": "server-state-changed",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Master control mode",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "marstek_master_battery_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 150,
        "y": 60,
        "wires": [
            [
                "b9f84cc9f5a92c37"
            ]
        ]
    },
    {
        "id": "176d29a.6f648d6",
        "type": "server",
        "name": "Home Assistant",
        "addon": true,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "",
        "connectionDelay": false,
        "cacheJson": false,
        "heartbeat": false,
        "heartbeatInterval": "",
        "statusSeparator": "",
        "enableGlobalContextStore": false
    },
    {
        "id": "f464264ff0889d6b",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.0"
        }
    }
]