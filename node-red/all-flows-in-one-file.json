[
    {
        "id": "706142e0afef1c37",
        "type": "tab",
        "label": "Home Battery Master Switch",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "5c6603769cfae348",
        "type": "tab",
        "label": "Home Battery PID presets",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "59063a3baf57637d",
        "type": "tab",
        "label": "Home Battery Start v4.3.3",
        "disabled": false,
        "info": "# Home battery control\r\nConsists of three flows:\r\n 1.  Start flow\r\n 1.  Control flow\r\n 1.  Master switch flow\r\n\r\n## Start flow\r\nThis is the starting point of your home battery control.\r\n\r\nIt starts with P1 measurement as a trigger.\r\nIt allows you to connect your battery sensors to the flow.\r\nIt ends with a function node, mapping your batteries to a battery_array\r\n\r\nThe battery_array is passed on to the control flow.\r\n\r\nWhen the control flow has calculated the desired corrections,\r\nit is passed back to this flow and applied to your batteries.",
        "env": []
    },
    {
        "id": "a216ce8676512c2f",
        "type": "tab",
        "label": "Strategy Charge PV v4.3.3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "cc5249a8fa23cd11",
        "type": "tab",
        "label": "Strategy Charge v4.3.3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "9e1c81935ce65263",
        "type": "tab",
        "label": "Strategy Dynamic v4.3.3",
        "disabled": false,
        "info": "Dynamic contract automated management",
        "env": []
    },
    {
        "id": "bac1b8ceb7669f2b",
        "type": "tab",
        "label": "Strategy Full stop v4.3.3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "5514ca6b1b2fc795",
        "type": "tab",
        "label": "Strategy Self-consumption v4.3.3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "884ad99f8a714fbe",
        "type": "tab",
        "label": "Strategy Sell v4.3.3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "89d1530aea5327c6",
        "type": "tab",
        "label": "Strategy Timed v4.3.3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "f0571d259f34553b",
        "type": "group",
        "z": "706142e0afef1c37",
        "name": "Marstek master control switch",
        "style": {
            "label": true
        },
        "nodes": [
            "8b8e58fa89ccf90b",
            "076b3b2d98e6bc52",
            "e56e594b4667a907",
            "4a4f68e0a0c8b8bd",
            "fa74bbefef94ef8e"
        ],
        "x": 34,
        "y": 19,
        "w": 898,
        "h": 382
    },
    {
        "id": "5b03aea3b44e53bd",
        "type": "group",
        "z": "5c6603769cfae348",
        "name": "PID presets",
        "style": {
            "label": true
        },
        "nodes": [
            "20e2bf5d647b2e5d",
            "31e23bb888624d76",
            "8aee68a7bb7f8b2e",
            "6ee5d18fc74c1946",
            "909810621235206d",
            "0eb3469ccb913fb9",
            "bc487342c51b71ac"
        ],
        "x": 34,
        "y": 19,
        "w": 632,
        "h": 242
    },
    {
        "id": "bea05866c4c488f5",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Start",
        "style": {
            "label": true,
            "stroke": "#009ac7"
        },
        "nodes": [
            "0c89620f78f2f4ef",
            "e9053f8c9496b04c",
            "a0b0196de591f8f5"
        ],
        "x": 34,
        "y": 19,
        "w": 652,
        "h": 82
    },
    {
        "id": "dce07674a07ac53b",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Strategy selection",
        "style": {
            "label": true
        },
        "nodes": [
            "4c175e813f75b9d9",
            "13c7ea09c9dbf0ed",
            "e4d456d0bc20f79b",
            "5c219897868334cc",
            "c9ae9437d3f66956",
            "f23f86825cf0a3d1",
            "05ea9a7dc76e3d80",
            "c36d6b5c4db224cf"
        ],
        "x": 34,
        "y": 839,
        "w": 812,
        "h": 162
    },
    {
        "id": "0b35ba610f52f04f",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Get batteries information",
        "style": {
            "label": true
        },
        "nodes": [
            "5225250bdf59525a",
            "026db848493f3166",
            "c83d594eb620158c",
            "b2029fe7a7e42be0",
            "63784c48c7223f7c",
            "70ed9a9cf4834cf3",
            "72261278517752ce",
            "9db32c035557e8dc"
        ],
        "x": 28,
        "y": 379,
        "w": 1664,
        "h": 242
    },
    {
        "id": "1aee044af1119570",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "On deploy and global logger",
        "style": {
            "label": true,
            "stroke": "#92d04f"
        },
        "nodes": [
            "659e2e54edfdc360",
            "0ba042d1972ab536",
            "092fedf08d51f006"
        ],
        "x": 1294,
        "y": 19,
        "w": 592,
        "h": 82
    },
    {
        "id": "798eeecf6db8cfc9",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Set Batteries",
        "style": {
            "label": true
        },
        "nodes": [
            "937ef8f7c7230efb",
            "64e437c3157ec537",
            "b6bbde7288bb7801",
            "ec88548dfe1d6caf",
            "7dcf7da07a79e24c",
            "4ef0e3ae811d18e1",
            "59d0fdb4ad45c417"
        ],
        "x": 34,
        "y": 1019,
        "w": 858,
        "h": 342
    },
    {
        "id": "ec8bbed7e42487f2",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Battery priority",
        "style": {
            "label": true
        },
        "nodes": [
            "bd7efdcea817b0b7",
            "8cc9f90f84d6cbe6",
            "23127bd588a1b4fc",
            "3b264b781302266e",
            "ad06d47a23dfa4ba",
            "ae635fad5304a589",
            "05fd146f9449f716",
            "e964084e62328bda",
            "76f78deb13f5fa69"
        ],
        "x": 34,
        "y": 739,
        "w": 1852,
        "h": 82
    },
    {
        "id": "7c0d89ddfb71a3e0",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Calculate totals",
        "style": {
            "label": true
        },
        "nodes": [
            "e935e81193dba8d1"
        ],
        "x": 34,
        "y": 639,
        "w": 212,
        "h": 82
    },
    {
        "id": "2ea0a7e531ef39e4",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Rate limiter",
        "style": {
            "label": true
        },
        "nodes": [
            "350efd05202fe26b",
            "8f6f14e7945d6e3f",
            "07a08a4d89f7bb25",
            "2c5766e8c091eaeb",
            "1520bd6cc3ca34cf",
            "e28342b88cef9490",
            "9e7e5422b1bcf6ea",
            "8cc370c1f995a2b8",
            "59fde12f6acd2295",
            "7907d408d1993e16"
        ],
        "x": 34,
        "y": 219,
        "w": 1402,
        "h": 122
    },
    {
        "id": "7a7344205735b39a",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Update UI: debug dashboard",
        "style": {
            "label": true,
            "stroke": "#3f5787"
        },
        "nodes": [
            "a7bdb29faaea9d71",
            "085abdeb02330a07",
            "5baa8cda5860b5a4",
            "88e057c961b1849f",
            "adce095aaf57c65f",
            "60b5b1efe51299ae"
        ],
        "x": 1234,
        "y": 1219,
        "w": 632,
        "h": 202
    },
    {
        "id": "4a3d44c2af78e412",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Update UI: usable energy",
        "style": {
            "label": true,
            "stroke": "#3f5787"
        },
        "nodes": [
            "6f93415ab9c74d06",
            "f353f4c838b53f75"
        ],
        "x": 1474,
        "y": 639,
        "w": 412,
        "h": 82
    },
    {
        "id": "825e1c268a1160cb",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Update UI: active sub-strategy",
        "style": {
            "label": true,
            "stroke": "#3f5787"
        },
        "nodes": [
            "ed457cf47f828f49",
            "9453982b65f1c6aa",
            "1b9eb35ff8aa80ef"
        ],
        "x": 1254,
        "y": 919,
        "w": 632,
        "h": 82
    },
    {
        "id": "b4565b43b4a004c7",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Insight",
        "style": {
            "label": true
        },
        "nodes": [
            "1da9c8cd44a4a345",
            "ebdac4d6dfe7cbf2",
            "5fdac9bbc9915ae2",
            "467d9bfdd3f1f1ec",
            "31616908343abdd3"
        ],
        "x": 34,
        "y": 119,
        "w": 892,
        "h": 82
    },
    {
        "id": "d4e59c272ae9c284",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Log and Error handling",
        "style": {
            "stroke": "#ff3f3f",
            "label": true
        },
        "nodes": [
            "9e03d6e607ea076f",
            "5f40dc49bb2e540f"
        ],
        "x": 1634,
        "y": 119,
        "w": 252,
        "h": 142
    },
    {
        "id": "941ddfadb9e6a315",
        "type": "group",
        "z": "59063a3baf57637d",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "bdc4cf85aa3fb39d",
            "b0ab500bc06a294b",
            "c6f6438baf85947f"
        ],
        "x": 1704,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "35bea22859f3fcba",
        "type": "group",
        "z": "a216ce8676512c2f",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "d09a0696a9b65104",
            "4f2b97920b83a56b"
        ],
        "x": 624,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "187270fe0271e694",
        "type": "group",
        "z": "a216ce8676512c2f",
        "name": "Start",
        "style": {
            "label": true
        },
        "nodes": [
            "095b3ff4cc937fc1",
            "2ae4d218319d5d75",
            "568de279b26b74ab"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "9b804de84213640a",
        "type": "group",
        "z": "a216ce8676512c2f",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "9f88648553b7a4ad",
            "5cbb79a5862fbca0",
            "4914b630b7f1e0c1"
        ],
        "x": 14,
        "y": 259,
        "w": 182,
        "h": 82
    },
    {
        "id": "2c95998a1e4dfc14",
        "type": "group",
        "z": "cc5249a8fa23cd11",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "b126dfeafe3f8120",
            "c633b654c40e1362",
            "fe9bc4e9c9e62e31"
        ],
        "x": 34,
        "y": 99,
        "w": 192,
        "h": 162
    },
    {
        "id": "a6b3cb9c833c85dc",
        "type": "group",
        "z": "cc5249a8fa23cd11",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "386b82cc4dd3c386",
            "84bc351c229e4c02",
            "ec3f4fadd1929942"
        ],
        "x": 34,
        "y": 479,
        "w": 192,
        "h": 142
    },
    {
        "id": "3dc7158e87cad4ea",
        "type": "group",
        "z": "cc5249a8fa23cd11",
        "name": "Export routine",
        "style": {
            "fill-opacity": "0.5",
            "label": true,
            "color": "#cccccc"
        },
        "nodes": [
            "23844cd4578daddd",
            "32930a5b0c22afaa",
            "1525f3b83e632cc1",
            "1c0e13007af82747",
            "853b6a0176a0e87d",
            "f0fc7328e4d0d24b",
            "39712a8540909db9",
            "37f2fd79b7d83ee4",
            "65fc2e500ed4abaf",
            "47833f2a91b0ec70"
        ],
        "x": 254,
        "y": 319,
        "w": 1192,
        "h": 182
    },
    {
        "id": "5c946ab9461182f2",
        "type": "group",
        "z": "cc5249a8fa23cd11",
        "name": "Decide import or stop",
        "style": {
            "label": true
        },
        "nodes": [
            "df6103f1afd5c741",
            "1c9dadc855747b3c",
            "fc1da8b440fe904b",
            "27f04e16ab84d45d",
            "7422ee68976dcd41",
            "d6b6c5c5ac1f1fe6",
            "fae51135f582fffa",
            "27c45f7e0a149656",
            "8dddaffec79431e0",
            "749411ac1ff41d4a",
            "58f1a2fc7d83eb54",
            "3bd007514830adbd",
            "d86110a25211ad24",
            "8c7c68306838dcbc",
            "293ecbb90224de03",
            "6e0e2e4b73431a06",
            "cc1bb708ce4e5ad3",
            "e789c38618e729d5",
            "b55009bfdf46eac7",
            "351397735f20735c"
        ],
        "x": 254,
        "y": 79,
        "w": 1928,
        "h": 207
    },
    {
        "id": "2a8d2dca66bef169",
        "type": "group",
        "z": "cc5249a8fa23cd11",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "6e06e9fb70e3bc78",
            "bb296a9b4d1102fc",
            "08b42314b1fa5216"
        ],
        "x": 34,
        "y": 379,
        "w": 182,
        "h": 82
    },
    {
        "id": "383fe26515bed160",
        "type": "group",
        "z": "9e1c81935ce65263",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "47ef65741ce2581e",
            "ee095bd0fb92f947"
        ],
        "x": 934,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "79dbcc4a1b9c4af9",
        "type": "group",
        "z": "9e1c81935ce65263",
        "name": "Home battery start",
        "style": {
            "label": true
        },
        "nodes": [
            "bdd75f533612acc4",
            "419e78196a0f07b0",
            "5bddd4194fa3ea0a"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "319f4ec179fdee82",
        "type": "group",
        "z": "9e1c81935ce65263",
        "name": "Plan",
        "style": {
            "label": true
        },
        "nodes": [
            "ea9edb27d790215c",
            "4017e182f7409f83",
            "9ba0ab785578a956",
            "7135aa07a8789db2",
            "4ca3e4168cb0a19f",
            "154236b91b5e54b5",
            "a44935d902985d30"
        ],
        "x": 228,
        "y": 273,
        "w": 1244,
        "h": 1034
    },
    {
        "id": "a9848e780d8c4ef0",
        "type": "group",
        "z": "9e1c81935ce65263",
        "name": "Execute",
        "style": {
            "label": true
        },
        "nodes": [
            "3a60df1ff16258a0",
            "015db5b2657513e8",
            "e76c82f85ae2b87b",
            "2ffaa39de8291169",
            "6f1b9f68188ef0ca"
        ],
        "x": 234,
        "y": 119,
        "w": 672,
        "h": 122
    },
    {
        "id": "593e49b92606df01",
        "type": "group",
        "z": "9e1c81935ce65263",
        "name": "Test area",
        "style": {
            "label": true
        },
        "nodes": [
            "32267b104f6c4335",
            "e065c750c1b11eff",
            "1678f13e48d213a4",
            "d5c9f4dd9d4ea7fb",
            "15b203b9329b1fcd",
            "2b92bba6029b9fa7",
            "dca7c14d01ff60f9",
            "5da7f77fcfaa9983"
        ],
        "x": 234,
        "y": 1479,
        "w": 912,
        "h": 162
    },
    {
        "id": "0186ef8f4e3ce1f2",
        "type": "group",
        "z": "9e1c81935ce65263",
        "name": "All data",
        "style": {
            "label": true
        },
        "nodes": [
            "8f42f0fb164b0203",
            "d1d1b0034a493a57",
            "a98fc515dd7eab9f",
            "1c32650a68b2d5d4",
            "b010d66c1e7ad270"
        ],
        "x": 234,
        "y": 1659,
        "w": 672,
        "h": 142
    },
    {
        "id": "f3012bea4c1ffe74",
        "type": "group",
        "z": "9e1c81935ce65263",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "c9e7d3f365c5790c",
            "c51489240cacdd2e",
            "772bdf7f9b9bdebf"
        ],
        "x": 24,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "3d5f7dda0f7eacb7",
        "type": "group",
        "z": "bac1b8ceb7669f2b",
        "name": "Strategy start",
        "style": {
            "label": true
        },
        "nodes": [
            "7cd4cd9678222aa0",
            "84d4995a9ca56bf0",
            "f1437fb7f3ae8d3a"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "a5ab43d65db72c3a",
        "type": "group",
        "z": "bac1b8ceb7669f2b",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "8ea4184555230145",
            "1a213fd11b4d2531"
        ],
        "x": 464,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "d4c19153d1348adf",
        "type": "group",
        "z": "bac1b8ceb7669f2b",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "d1e46476752bf753",
            "44883d8970eb03e3",
            "1def5e898b617f7f"
        ],
        "x": 14,
        "y": 259,
        "w": 182,
        "h": 82
    },
    {
        "id": "c1886c0e0af92e56",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "name": "Strategy start",
        "style": {
            "fill": "#ffffff",
            "label": true
        },
        "nodes": [
            "a38eba9cfa02e6c4",
            "b1e7ccd4b64c07a1",
            "5f7032fee27f69c3"
        ],
        "x": 54,
        "y": 79,
        "w": 212,
        "h": 162
    },
    {
        "id": "173ebd2c7496660d",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "name": "Battery solutions",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "740ff013f706dea7",
            "5ace8874ce162d7a",
            "27bc1a67ec485e76"
        ],
        "x": 64,
        "y": 1139,
        "w": 202,
        "h": 142
    },
    {
        "id": "562414d896e9cb7f",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "name": "Bumpless operation",
        "style": {
            "label": true,
            "stroke": "#bfdbef"
        },
        "nodes": [
            "85438831b3541f6e",
            "92b18321e428bb57",
            "2243dccdd919c7b6",
            "6ddd9cdf4c69c721"
        ],
        "x": 1614,
        "y": 19,
        "w": 252,
        "h": 242
    },
    {
        "id": "5f82a83792ef2689",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "name": "Bumpless operation - switching control modes",
        "style": {
            "stroke": "#bfdbef",
            "label": true
        },
        "nodes": [
            "568c58e7de65cb07",
            "2d0ccb826e66cf7e",
            "37b91d2b1e277236",
            "17f89a47358628fe",
            "cf9c7cd28e9d02fc",
            "b752c80f6054fee8",
            "b1bc49b9a790bd10",
            "f13192d3ff06d752",
            "59ad2bb51c8d827b",
            "4f72a2197181054f",
            "373abc5f598ed57c",
            "7f0690764f21fc96"
        ],
        "x": 1614,
        "y": 279,
        "w": 592,
        "h": 289.5
    },
    {
        "id": "784ae91b54b59bd0",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "name": "Inputs",
        "style": {
            "fill": "#7fb7df",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "4a6afeecba388786",
            "8f3e0afa5fbb2ebc"
        ],
        "x": 288,
        "y": 13,
        "w": 904,
        "h": 234
    },
    {
        "id": "cc7c652e269c5be9",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "name": "Pre processing",
        "style": {
            "fill": "#bfdbef",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "5c334db378550ed4",
            "e11606db86887af8",
            "64685d1b1184fd0b"
        ],
        "x": 288,
        "y": 273,
        "w": 1104,
        "h": 294
    },
    {
        "id": "7c5d240017e0fc40",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "name": "Control",
        "style": {
            "fill": "#7fb7df",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "8719db030e1ed765",
            "a37bfc04d3c18245"
        ],
        "x": 288,
        "y": 593,
        "w": 924,
        "h": 634
    },
    {
        "id": "c9787d2bebc68376",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "32b3cb5b4b300bda",
            "51258802c8d99561",
            "37a7dba2f12a9b10"
        ],
        "x": 54,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "148fba07c69fbaaf",
        "type": "group",
        "z": "884ad99f8a714fbe",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "38bb91b04c6c811d",
            "8c98ec1dabaafa23",
            "5e2b42ca40a25d33"
        ],
        "x": 34,
        "y": 99,
        "w": 192,
        "h": 162
    },
    {
        "id": "8d5e1ab006b4a5a2",
        "type": "group",
        "z": "884ad99f8a714fbe",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "6144f913d09c737e",
            "5bb20cc4c92f55e2",
            "b803cd0063a72e16"
        ],
        "x": 34,
        "y": 479,
        "w": 192,
        "h": 142
    },
    {
        "id": "f6662c6a556ba24f",
        "type": "group",
        "z": "884ad99f8a714fbe",
        "name": "Export routine",
        "style": {
            "fill-opacity": "0.5",
            "label": true,
            "color": "#cccccc"
        },
        "nodes": [
            "bac35001debaf802",
            "d52dd9a905df305c",
            "31e95c10ae3182f3",
            "9b1b8e0130d7b7aa",
            "810e47c5954f609d",
            "3c17ffb1d46e57c6",
            "eea8ef2a42e7ace3",
            "f6a52340d65389ed",
            "b5c85ef50382b2e6",
            "1733d4cbd9cdc560"
        ],
        "x": 254,
        "y": 319,
        "w": 1192,
        "h": 182
    },
    {
        "id": "11abcd3035953c42",
        "type": "group",
        "z": "884ad99f8a714fbe",
        "name": "Decide export or stop",
        "style": {
            "label": true
        },
        "nodes": [
            "9f5fde3d92e92513",
            "9ad0059b121918ce",
            "7fd3b8cc6b026197",
            "c7c1dd60d15e01c6",
            "5e72f5a0d0f504f9",
            "2bc1353e9aea970b",
            "c57d136b0ac2f19a",
            "0538d37be0889ccd",
            "3decfdde96bf46d7",
            "61e3de2e5d29a97b",
            "9e07935cfcb6a7ed",
            "601686d176680862",
            "c82bac434005502f",
            "496f19953301e6e7",
            "eac1424453781f87",
            "901d2f3310726133",
            "41c7a815d1224837",
            "28a9d3761fe7cf4b",
            "d6103c3bd4154011"
        ],
        "x": 254,
        "y": 79,
        "w": 1838,
        "h": 207
    },
    {
        "id": "6752e9a3feae2e7d",
        "type": "group",
        "z": "884ad99f8a714fbe",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "f6774a92f588394d",
            "bfa40d077828d503",
            "4b3ba74f290beebf"
        ],
        "x": 34,
        "y": 379,
        "w": 182,
        "h": 82
    },
    {
        "id": "1411bfdd17b2859f",
        "type": "group",
        "z": "89d1530aea5327c6",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "592194a2bf507f32",
            "871731fd98277587"
        ],
        "x": 1214,
        "y": 419,
        "w": 192,
        "h": 142
    },
    {
        "id": "f52d8e87807099ce",
        "type": "group",
        "z": "89d1530aea5327c6",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "d20c6c828252124e",
            "b90b28899033b272",
            "62bfc44fd94f458b"
        ],
        "x": 24,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "d088af62e0043785",
        "type": "group",
        "z": "89d1530aea5327c6",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "838b48c84778952b",
            "e11a32db9f9cbfcd",
            "ef1939a3c157c9e7"
        ],
        "x": 454,
        "y": 79,
        "w": 532,
        "h": 82
    },
    {
        "id": "51271d6180b1d6fa",
        "type": "group",
        "z": "89d1530aea5327c6",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "390dc0a152bcb8c6",
            "6ae3f3196caa1968",
            "7b3588f42ab2511b",
            "377ae5fa150eec59"
        ],
        "x": 254,
        "y": 179,
        "w": 732,
        "h": 82
    },
    {
        "id": "6ef0497f9750e793",
        "type": "group",
        "z": "89d1530aea5327c6",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "c215d65973ad0c6b"
        ],
        "x": 254,
        "y": 79,
        "w": 192,
        "h": 82
    },
    {
        "id": "ac876275eea3c10c",
        "type": "group",
        "z": "89d1530aea5327c6",
        "name": "Determine sub-strategy based on time period",
        "style": {
            "label": true
        },
        "nodes": [
            "95e4b234b09d1aee",
            "655b9aa50770dc0a",
            "6fb529b6dedcfa46",
            "9fa4454931f862bf",
            "a69911f3919ba57a",
            "c56e050f085ba0a6",
            "b1da1498e92f7d0d",
            "3e6a0662090e2d4f",
            "7d0f3a8b9745af95",
            "3af2abd858e47a08",
            "31fcb1c271f89b22",
            "cd4d19b597901746",
            "f8772cdd4dcb135b",
            "d0ab656f1e913076",
            "c321ac377a29a2d4",
            "aef10e28757c67f7",
            "33092dcce880ded0",
            "66a095da2f7c01e2",
            "d31a89baac9b3cb5",
            "42dd62adc753f11b",
            "8b1352b68c49d4d5"
        ],
        "x": 254,
        "y": 379,
        "w": 692,
        "h": 402
    },
    {
        "id": "0d39649ce9e273f8",
        "type": "group",
        "z": "89d1530aea5327c6",
        "name": "Execute sub-strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "3b0f43ac3f6078f6",
            "37f4117e45db0d46"
        ],
        "x": 984,
        "y": 419,
        "w": 192,
        "h": 142
    },
    {
        "id": "75e023842ba0d125",
        "type": "group",
        "z": "89d1530aea5327c6",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "103de563abac1af9",
            "03c34454a489b12a",
            "660e5cbe5954e217",
            "37d1f6d05c6d0a1d"
        ],
        "x": 254,
        "y": 279,
        "w": 732,
        "h": 82
    },
    {
        "id": "dd5d5208bfbe6c50",
        "type": "group",
        "z": "89d1530aea5327c6",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "27c5c9a1abd4447a",
            "8eb9e72095623d0d",
            "a420f3cc371bacb1"
        ],
        "x": 24,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "fa74bbefef94ef8e",
        "type": "group",
        "z": "706142e0afef1c37",
        "g": "f0571d259f34553b",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "d26bc843e4c5db25",
            "61936552dade84e9",
            "2fc689a92f105b41",
            "8146d3ea2b920192",
            "c73cf63563c9c3a5",
            "fde15b4462086354"
        ],
        "x": 414,
        "y": 99,
        "w": 492,
        "h": 222
    },
    {
        "id": "63784c48c7223f7c",
        "type": "group",
        "z": "59063a3baf57637d",
        "g": "0b35ba610f52f04f",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "6e46998efccc4f0f",
            "7e060309be15ad3f",
            "ad99b0d7f8d3dc7a",
            "884c138d0c76a105",
            "34169542866371cd",
            "b6fddae094a87429",
            "066c374727803465",
            "4fd95964179e9a74",
            "b28868630b184c67",
            "23c69fd97206165c"
        ],
        "x": 54,
        "y": 459,
        "w": 1612,
        "h": 82
    },
    {
        "id": "ec88548dfe1d6caf",
        "type": "group",
        "z": "59063a3baf57637d",
        "g": "798eeecf6db8cfc9",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "d5e5855c16ff9b93",
            "769af00902e6a149",
            "2934d0f9189a8827",
            "53f1cbbeaab9646f",
            "b0cd9dd46fc994eb",
            "c8484a6496568b34",
            "94e274ecfc4e6b1e"
        ],
        "x": 314,
        "y": 1059,
        "w": 552,
        "h": 222
    },
    {
        "id": "b55009bfdf46eac7",
        "type": "group",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "UI helper | set bounds for charge levels",
        "style": {
            "label": true,
            "stroke": "#3f93cf"
        },
        "nodes": [
            "308ead639f21f3d3",
            "d9869900ea4cc845",
            "762c2b5621ecfe8f"
        ],
        "x": 1464,
        "y": 159,
        "w": 692,
        "h": 82
    },
    {
        "id": "4a6afeecba388786",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "g": "784ae91b54b59bd0",
        "name": "PID control inputs",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "65ba171e4be3708f",
            "86377ee093805b8b",
            "919bccdcfdc61eb1",
            "cebbd3981242235f",
            "e62aafb8052ff7da",
            "099eef4dab59e963",
            "bced3dcd50a1545a",
            "90245d89be9bc125",
            "99cfdb825f801fd8"
        ],
        "x": 314,
        "y": 59,
        "w": 572,
        "h": 162
    },
    {
        "id": "8f3e0afa5fbb2ebc",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "g": "784ae91b54b59bd0",
        "name": "Advanced features",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "25a37940f6a5f2b4",
            "c757848ddf8b492d",
            "43da5f9faff9c6f4"
        ],
        "x": 914,
        "y": 39,
        "w": 252,
        "h": 182
    },
    {
        "id": "5c334db378550ed4",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "g": "cc7c652e269c5be9",
        "name": "",
        "style": {
            "fill": "#ffffff",
            "label": true
        },
        "nodes": [
            "f5044124f062433e",
            "de3606d8ce7f0d19",
            "eac58bac5c19c034",
            "d5a01506e48e0708"
        ],
        "x": 314,
        "y": 299,
        "w": 292,
        "h": 202
    },
    {
        "id": "e11606db86887af8",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "g": "cc7c652e269c5be9",
        "name": "Derivative - incl. bumpless operation",
        "style": {
            "label": true,
            "stroke": "#a4a4a4",
            "fill": "#ffffff"
        },
        "nodes": [
            "8c8c444b26e62cd5",
            "fad87cd701ba7a2f",
            "4a2712bd3bd8750a",
            "b0e1bc7fdc67a814",
            "49e2cc546740a3a7"
        ],
        "x": 614,
        "y": 399,
        "w": 752,
        "h": 142
    },
    {
        "id": "64685d1b1184fd0b",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "g": "cc7c652e269c5be9",
        "name": "Processing required? ",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "8d59fd82691e5eb2",
            "3a4947f122506bc9",
            "d5cba946bc7b0142"
        ],
        "x": 614,
        "y": 299,
        "w": 562,
        "h": 82
    },
    {
        "id": "8719db030e1ed765",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "g": "7c5d240017e0fc40",
        "name": "PID controller",
        "style": {
            "label": true,
            "fill": "#ffffff",
            "color": "#3f3f3f"
        },
        "nodes": [
            "d1e36bfcdc94f9bd",
            "ecc25b36c43ee975",
            "11439c6c9c122ee3",
            "0213ae880bfbc428",
            "c547c0ee749203ad",
            "01c44459de13dcb9",
            "4e4df8614dc4d03c",
            "7e773be39a93951c",
            "4c49075aa0a2c60b",
            "4990023fa30c8b0e",
            "1668a997ec2db7e3",
            "38dd1dd20354303b",
            "8ef262f6fb299ec2",
            "472acfc03b69788a",
            "b45be92a4961f5ee",
            "363eea4e7fb6fa3e",
            "4cd2ac40e42d7e21",
            "b7b8dd92a2effab8",
            "6316220a57018f7e",
            "0bd03eb81e5cabed"
        ],
        "x": 314,
        "y": 619,
        "w": 872,
        "h": 482
    },
    {
        "id": "a37bfc04d3c18245",
        "type": "group",
        "z": "5514ca6b1b2fc795",
        "g": "7c5d240017e0fc40",
        "name": "Distribution",
        "style": {
            "label": true,
            "fill": "#ffffff",
            "color": "#3f3f3f"
        },
        "nodes": [
            "d39518e171a8f45d",
            "02528b5f0b40515f"
        ],
        "x": 314,
        "y": 1119,
        "w": 452,
        "h": 82
    },
    {
        "id": "d6103c3bd4154011",
        "type": "group",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "UI helper | set bounds for charge levels",
        "style": {
            "label": true,
            "stroke": "#3f93cf"
        },
        "nodes": [
            "32e23cc0c2d08517",
            "291ad7c5c558cb14",
            "ca776716eb0dba24"
        ],
        "x": 1394,
        "y": 159,
        "w": 672,
        "h": 82
    },
    {
        "id": "4ca3e4168cb0a19f",
        "type": "group",
        "z": "9e1c81935ce65263",
        "g": "319f4ec179fdee82",
        "name": "API call to Data Source",
        "style": {
            "label": true
        },
        "nodes": [
            "5d3828fa878b96e1",
            "51955447fce56b26",
            "466378019e0dc875",
            "338acc73e19dc2ea",
            "41eb25ca56c567a9",
            "270459fa3d61a502",
            "50e84b8184986fb3",
            "d22893b87a6d7a9f",
            "ee9dd764e7851217",
            "c5a3235ad687da39",
            "bafd4b639ffb990d",
            "2f43baa24fb1b823",
            "7d75e3c907d0efa5",
            "634b05801baa4ea9",
            "d93b799f1011283e",
            "964043538db2a118",
            "dbc490b53cadf34d",
            "402880758fdb1d96",
            "53c7e13897bf1606",
            "2cff1346b63fe9f9"
        ],
        "x": 254,
        "y": 499,
        "w": 752,
        "h": 362
    },
    {
        "id": "154236b91b5e54b5",
        "type": "group",
        "z": "9e1c81935ce65263",
        "g": "319f4ec179fdee82",
        "name": "Update when",
        "style": {
            "label": true
        },
        "nodes": [
            "8487165684201295",
            "da3e171606c7dfca",
            "f5f7ea84129756bf",
            "5426188effacc641",
            "e8774b5ab323e662",
            "8c1f3458f7e87ef2",
            "eeee46277502b43e",
            "7cc3b4e072f332df",
            "72292ab013bb214a",
            "a2a1aad07a41be35",
            "0697d445416adfbc",
            "19c7d0e5ece3dd00",
            "22e4fafaef966fd7",
            "f385d2544b66ddee",
            "ac8df319cfad78ad",
            "af6a03d36d48a7d8",
            "e015763d0b952f57"
        ],
        "x": 254,
        "y": 299,
        "w": 1192,
        "h": 182
    },
    {
        "id": "a44935d902985d30",
        "type": "group",
        "z": "9e1c81935ce65263",
        "g": "319f4ec179fdee82",
        "name": "Determine strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "2e62f1c39e0b0dc3",
            "bb83810278be291c",
            "26e1ca0ee5ebfb07",
            "e30caddc9c684452",
            "850341b7536e1c16",
            "3e3a7eaade883823",
            "773f0f38687bf467",
            "bc1c0a99f91589a9",
            "92eeeb704aaa0bfc",
            "b5ecf03de5e4ca23",
            "e65065ba7454c5a2",
            "2ff7656d60360ce2",
            "170ff03203e89243",
            "882a3b79f37cc471",
            "8a7913f81b38a9e0",
            "6cfa38c6f6cd36df"
        ],
        "x": 254,
        "y": 879,
        "w": 872,
        "h": 402
    },
    {
        "id": "5997997551921646",
        "type": "junction",
        "z": "59063a3baf57637d",
        "x": 40,
        "y": 360,
        "wires": [
            [
                "b2029fe7a7e42be0"
            ]
        ]
    },
    {
        "id": "e789c38618e729d5",
        "type": "junction",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "x": 1490,
        "y": 260,
        "wires": [
            [
                "65fc2e500ed4abaf"
            ]
        ]
    },
    {
        "id": "19c7d0e5ece3dd00",
        "type": "junction",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "x": 640,
        "y": 340,
        "wires": [
            [
                "eeee46277502b43e"
            ]
        ]
    },
    {
        "id": "099eef4dab59e963",
        "type": "junction",
        "z": "5514ca6b1b2fc795",
        "g": "4a6afeecba388786",
        "x": 460,
        "y": 100,
        "wires": [
            [
                "90245d89be9bc125"
            ]
        ]
    },
    {
        "id": "90245d89be9bc125",
        "type": "junction",
        "z": "5514ca6b1b2fc795",
        "g": "4a6afeecba388786",
        "x": 700,
        "y": 100,
        "wires": [
            [
                "bced3dcd50a1545a",
                "99cfdb825f801fd8"
            ]
        ]
    },
    {
        "id": "99cfdb825f801fd8",
        "type": "junction",
        "z": "5514ca6b1b2fc795",
        "g": "4a6afeecba388786",
        "x": 720,
        "y": 120,
        "wires": [
            [
                "86377ee093805b8b"
            ]
        ]
    },
    {
        "id": "28a9d3761fe7cf4b",
        "type": "junction",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "x": 1440,
        "y": 260,
        "wires": [
            [
                "b5c85ef50382b2e6"
            ]
        ]
    },
    {
        "id": "176d29a.6f648d6",
        "type": "server",
        "name": "Home Assistant",
        "addon": true,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "",
        "connectionDelay": false,
        "cacheJson": false,
        "heartbeat": false,
        "heartbeatInterval": "",
        "statusSeparator": "",
        "enableGlobalContextStore": false
    },
    {
        "id": "8b8e58fa89ccf90b",
        "type": "api-current-state",
        "z": "706142e0afef1c37",
        "g": "f0571d259f34553b",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 60,
        "wires": [
            [
                "076b3b2d98e6bc52"
            ]
        ]
    },
    {
        "id": "d26bc843e4c5db25",
        "type": "function",
        "z": "706142e0afef1c37",
        "g": "fa74bbefef94ef8e",
        "name": "Set RS485 and Work Modes",
        "func": "// array for output \nlet outputArray = [];\n\n// battery to target\nconst target = `marstek_m${msg.battery_index}`;\n\n// Set | work mode\nconst workModeAction = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_user_work_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.work_mode)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.work_mode ? { payload: workModeAction, topic:\"user_work_mode\"}: null);\n\n// Set | rs485\nconst rs485Action = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_rs485_control_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.rs485)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.rs485 ? { payload: rs485Action, topic: \"rs485_control_mode\" } : null);\n\n// Store calls in msg to allow checking of loop results\nmsg.loop_result = { target, workModeAction, rs485Action };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Outputs\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 180,
        "wires": [
            [
                "61936552dade84e9"
            ],
            [
                "2fc689a92f105b41"
            ],
            [
                "c73cf63563c9c3a5"
            ]
        ]
    },
    {
        "id": "076b3b2d98e6bc52",
        "type": "function",
        "z": "706142e0afef1c37",
        "g": "f0571d259f34553b",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// configurables\nlet workMode = null; // manual, anti-feed, ai, null = don't set or alter this setting\nlet rs485 = null;  // enable, disable, null = don't set or alter this setting\n\n// mode select\nswitch (msg.marstek_master_battery_mode) {\n    case \"Manual control\":\n        workMode = \"manual\";\n        rs485 = \"disable\";\n        break;\n    case \"Marstek control\":\n        // the user should select a work mode via the Marstek App or via select.marstek_mX_user_work_mode\n        rs485 = \"disable\";\n        break;\n    case \"Full control\":\n        rs485 = \"enable\";\n        break;\n    default:\n        node.status({fill:\"red\",shape:\"ring\",text:`Unhandled mode: ${msg.marstek_master_battery_mode}`});\n        return null; // stop flow\n}\n\n// Continue\nmsg.work_mode = workMode;\nmsg.rs485 = rs485;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 180,
        "wires": [
            [
                "d26bc843e4c5db25"
            ]
        ]
    },
    {
        "id": "c73cf63563c9c3a5",
        "type": "function",
        "z": "706142e0afef1c37",
        "g": "fa74bbefef94ef8e",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 240,
        "wires": [
            [
                "8146d3ea2b920192",
                "fde15b4462086354"
            ]
        ]
    },
    {
        "id": "8146d3ea2b920192",
        "type": "switch",
        "z": "706142e0afef1c37",
        "g": "fa74bbefef94ef8e",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 640,
        "y": 240,
        "wires": [
            [
                "d26bc843e4c5db25"
            ],
            [
                "e56e594b4667a907"
            ]
        ]
    },
    {
        "id": "61936552dade84e9",
        "type": "api-call-service",
        "z": "706142e0afef1c37",
        "g": "fa74bbefef94ef8e",
        "name": "Set work mode",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 800,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "2fc689a92f105b41",
        "type": "api-call-service",
        "z": "706142e0afef1c37",
        "g": "fa74bbefef94ef8e",
        "name": "Set RS485",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 790,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "fde15b4462086354",
        "type": "debug",
        "z": "706142e0afef1c37",
        "g": "fa74bbefef94ef8e",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 510,
        "y": 280,
        "wires": []
    },
    {
        "id": "e56e594b4667a907",
        "type": "debug",
        "z": "706142e0afef1c37",
        "g": "f0571d259f34553b",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 360,
        "wires": []
    },
    {
        "id": "4a4f68e0a0c8b8bd",
        "type": "server-state-changed",
        "z": "706142e0afef1c37",
        "g": "f0571d259f34553b",
        "name": "Master control mode",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "marstek_master_battery_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 150,
        "y": 60,
        "wires": [
            [
                "8b8e58fa89ccf90b"
            ]
        ]
    },
    {
        "id": "20e2bf5d647b2e5d",
        "type": "server-state-changed",
        "z": "5c6603769cfae348",
        "g": "5b03aea3b44e53bd",
        "name": "PID preset selected",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.house_battery_control_pid_presets"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 150,
        "y": 100,
        "wires": [
            [
                "909810621235206d"
            ]
        ]
    },
    {
        "id": "31e23bb888624d76",
        "type": "api-call-service",
        "z": "5c6603769cfae348",
        "g": "5b03aea3b44e53bd",
        "name": "Kp",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_kp"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "8aee68a7bb7f8b2e",
        "type": "api-call-service",
        "z": "5c6603769cfae348",
        "g": "5b03aea3b44e53bd",
        "name": "Ki",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_ki"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "6ee5d18fc74c1946",
        "type": "api-call-service",
        "z": "5c6603769cfae348",
        "g": "5b03aea3b44e53bd",
        "name": "Kd",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_kd"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "909810621235206d",
        "type": "function",
        "z": "5c6603769cfae348",
        "g": "5b03aea3b44e53bd",
        "name": "Presets",
        "func": "// See: house_battery_control.yaml > input_select: > house_battery_control_pid_presets\nconst preset = RED.util.getMessageProperty(msg,\"payload\");\nnode.status({fill:\"green\",shape:\"dot\",text:`${preset}`});\n\n\n// Default values\nlet Kp = 0; // Proportional gain\nlet Ki = 0; // Integral gain\nlet Kd = 0; // Differentiating gain\nlet Si = 0; // % Input smoothing (a Low pass moving average filter)\nlet So = 0; // % Output smoothing (a Low pass moving average filter)\n\nswitch (preset) {\n    // For people who have unstable systems with every other preset\n    case \"Very safe\":\n        Kp = 0.1;\n        Ki = 0.1;\n        Si = 0; // without Kd, this is preferred to be zero.\n        So = 10; // %\n        break;\n    // Good starting point for most\n    case \"Safe\":\n        Kp = 0.3;\n        Ki = 0.3;\n        Kd = 0.1;\n        Si = 20; // %\n        So = 0; // %\n        break;\n    // Gitcodebob's October 2025 settings for 3.2kWp PV and 5kW battery transformer power\n    case \"Regular\":\n        Kp = 0.3;\n        Ki = 0.4;\n        Kd = 0.8;\n        Si = 50; // % This high amount of filtering allows the stronger Kd\n        So = 10; // %\n        break;\n    default:\n        // Don't change values\n        return null;\n}\n\n// Prepare for three outputs\nreturn [\n    { \"payload\": Kp },\n    { \"payload\": Ki },\n    { \"payload\": Kd },\n    { \"payload\": Si },\n    { \"payload\": So }\n];",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 100,
        "wires": [
            [
                "31e23bb888624d76"
            ],
            [
                "8aee68a7bb7f8b2e"
            ],
            [
                "6ee5d18fc74c1946"
            ],
            [
                "0eb3469ccb913fb9"
            ],
            [
                "bc487342c51b71ac"
            ]
        ]
    },
    {
        "id": "0eb3469ccb913fb9",
        "type": "api-call-service",
        "z": "5c6603769cfae348",
        "g": "5b03aea3b44e53bd",
        "name": "Input Smooth",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_signal_dampening"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 530,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "bc487342c51b71ac",
        "type": "api-call-service",
        "z": "5c6603769cfae348",
        "g": "5b03aea3b44e53bd",
        "name": "Output Smoothing",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output_dampening"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 550,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "0c89620f78f2f4ef",
        "type": "server-state-changed",
        "z": "59063a3baf57637d",
        "g": "bea05866c4c488f5",
        "name": "P1 meter",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.p1_meter_power"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": false,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "grid_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "timestamp",
                "propertyType": "msg",
                "value": "",
                "valueType": "date"
            }
        ],
        "x": 120,
        "y": 60,
        "wires": [
            [
                "e9053f8c9496b04c"
            ]
        ]
    },
    {
        "id": "e9053f8c9496b04c",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "bea05866c4c488f5",
        "name": "Master Control Mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.marstek_master_battery_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "master_mode",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 300,
        "y": 60,
        "wires": [
            [
                "a0b0196de591f8f5"
            ]
        ]
    },
    {
        "id": "a0b0196de591f8f5",
        "type": "switch",
        "z": "59063a3baf57637d",
        "g": "bea05866c4c488f5",
        "name": "when in \"Full Control\" mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 540,
        "y": 60,
        "wires": [
            [
                "1da9c8cd44a4a345"
            ]
        ]
    },
    {
        "id": "4c175e813f75b9d9",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "dce07674a07ac53b",
        "name": "Battery Strategy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy",
                "propertyType": "flow",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 140,
        "y": 880,
        "wires": [
            [
                "05ea9a7dc76e3d80"
            ]
        ]
    },
    {
        "id": "13c7ea09c9dbf0ed",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "dce07674a07ac53b",
        "name": "Strategy selection",
        "func": "// Logger\nconst logger = global.get(\"logger\");\n\n// INFLOW\nlet strategy = flow.get(\"house_battery_strategy\");\n\n// Configure msg.strategy object\nRED.util.setMessageProperty(msg,\"strategy.selected\",strategy,true);\nRED.util.setMessageProperty(msg,\"strategy.trace\",[],true);\n\n// stop on error\nif(msg.batteries === undefined) {\n    logger(this, \"Battery configuration undefined\", \"error\");\n    return null;\n}\nif(strategy === undefined) {\n    logger(this, \"Battery strategy undefined\", \"error\");\n    return null;\n}\n\n// select target flow based on the input_select `house_battery_strategy`\nmsg.target = `${strategy}`;\n\n// full stop trigger overrules ALL selected strategies\nconst stopTrigger = RED.util.getMessageProperty(msg,\"full_stop_trigger\");\nif(stopTrigger == \"on\" || stopTrigger === true || stopTrigger === 1) {\n    msg.target = 'Full stop';\n    // Explain\n    logger(this, `**Full Stop** strategy selected, due to (EV) stop trigger: '${stopTrigger}'`);\n}\n\n// add execution marker\nRED.util.setMessageProperty(msg,\"strategy.execution_start\",Date.now()); // when do we start executing the selected strategy\n\n// OUTPUT\nnode.status({fill:\"grey\",shape:\"dot\",text:msg.target});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 880,
        "wires": [
            [
                "5c219897868334cc",
                "e4d456d0bc20f79b"
            ]
        ]
    },
    {
        "id": "e4d456d0bc20f79b",
        "type": "link call",
        "z": "59063a3baf57637d",
        "g": "dce07674a07ac53b",
        "name": "Call \"Link in\" node",
        "links": [],
        "linkType": "dynamic",
        "timeout": "1.2",
        "x": 410,
        "y": 920,
        "wires": [
            [
                "c9ae9437d3f66956",
                "f23f86825cf0a3d1"
            ]
        ]
    },
    {
        "id": "5c219897868334cc",
        "type": "debug",
        "z": "59063a3baf57637d",
        "g": "dce07674a07ac53b",
        "name": "Input msg",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 680,
        "y": 880,
        "wires": []
    },
    {
        "id": "c9ae9437d3f66956",
        "type": "debug",
        "z": "59063a3baf57637d",
        "g": "dce07674a07ac53b",
        "name": "Returned msg",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 920,
        "wires": []
    },
    {
        "id": "f23f86825cf0a3d1",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "dce07674a07ac53b",
        "name": "Strategy evaluation",
        "func": "// add execution marker\nlet execution_end = Date.now();\nRED.util.setMessageProperty(msg, \"strategy.execution_end\", execution_end);\n\n// retrieve execution markers\nlet execution_start = RED.util.getMessageProperty(msg,\"strategy.execution_start\");\n\n// report execution time\nif (execution_start !== undefined && execution_end !== undefined) {\n    // exec time\n    let execution_time = (execution_end - execution_start) / 1000; // seconds\n    // report\n    if (execution_time <= 0) node.status({ fill: \"red\", shape: \"dot\", text: `negative or zero timing` });\n    if (execution_time > 0) node.status({ fill: \"green\", shape: \"dot\", text: `${execution_time} sec`});\n    if (execution_time >= 0.7) node.status({ fill: \"yellow\", shape: \"dot\", text: `${execution_time} sec` });\n    if (execution_time >= 1) node.status({ fill: \"red\", shape: \"dot\", text: `${execution_time} sec` });\n\n} else {\n    node.status({fill:\"grey\",shape:\"dot\",text:\"timing error\"});\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 960,
        "wires": [
            [
                "b6bbde7288bb7801",
                "c36d6b5c4db224cf",
                "ed457cf47f828f49"
            ]
        ]
    },
    {
        "id": "5225250bdf59525a",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "0b35ba610f52f04f",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// Init an array for battery status and value information\nmsg.batteries = [];\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 420,
        "wires": [
            [
                "6e46998efccc4f0f"
            ]
        ]
    },
    {
        "id": "70ed9a9cf4834cf3",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "0b35ba610f52f04f",
        "name": "Mapping",
        "func": "// Map to batteries array\nmsg.batteries.push({\n    id: `M${msg.battery_index}`,\n    power: parseInt(msg.battery_power,10),\n    charging_max: parseInt(msg.max_charge_power,10),\n    discharging_max: parseInt(msg.max_discharge_power,10),\n    soc: parseInt(msg.battery_state_of_charge,10),\n    soc_max: parseInt(msg.charging_cutoff_capacity,10),\n    soc_min: parseInt(msg.discharging_cutoff_capacity,10),\n    inverter: String(msg.inverter_state),\n    energy: Number(msg.battery_remaining_capacity),\n    energy_max: Number(msg.battery_total_energy),\n    rs485: String(msg.rs485_control_mode)\n    });\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 580,
        "wires": [
            [
                "72261278517752ce"
            ]
        ]
    },
    {
        "id": "026db848493f3166",
        "type": "switch",
        "z": "59063a3baf57637d",
        "g": "0b35ba610f52f04f",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 420,
        "y": 580,
        "wires": [
            [
                "6e46998efccc4f0f"
            ],
            [
                "9db32c035557e8dc"
            ]
        ]
    },
    {
        "id": "c83d594eb620158c",
        "type": "debug",
        "z": "59063a3baf57637d",
        "g": "0b35ba610f52f04f",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 770,
        "y": 580,
        "wires": []
    },
    {
        "id": "b2029fe7a7e42be0",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "0b35ba610f52f04f",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 420,
        "wires": [
            [
                "5225250bdf59525a"
            ]
        ]
    },
    {
        "id": "6e46998efccc4f0f",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "63784c48c7223f7c",
        "name": "Control mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "select.marstek_m{{battery_index}}_rs485_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "rs485_control_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 160,
        "y": 500,
        "wires": [
            [
                "066c374727803465"
            ]
        ]
    },
    {
        "id": "7e060309be15ad3f",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "63784c48c7223f7c",
        "name": "SoC",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_state_of_charge",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_state_of_charge",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 850,
        "y": 500,
        "wires": [
            [
                "b28868630b184c67"
            ]
        ]
    },
    {
        "id": "ad99b0d7f8d3dc7a",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "63784c48c7223f7c",
        "name": "Inverter state",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_inverter_state",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "inverter_state",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1270,
        "y": 500,
        "wires": [
            [
                "34169542866371cd"
            ]
        ]
    },
    {
        "id": "884c138d0c76a105",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "63784c48c7223f7c",
        "name": "Max discharge power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_discharge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_discharge_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 680,
        "y": 500,
        "wires": [
            [
                "7e060309be15ad3f"
            ]
        ]
    },
    {
        "id": "34169542866371cd",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "63784c48c7223f7c",
        "name": "Energy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_remaining_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_remaining_capacity",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1420,
        "y": 500,
        "wires": [
            [
                "4fd95964179e9a74"
            ]
        ]
    },
    {
        "id": "b6fddae094a87429",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "63784c48c7223f7c",
        "name": "Max charge power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_charge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_charge_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 470,
        "y": 500,
        "wires": [
            [
                "884c138d0c76a105"
            ]
        ]
    },
    {
        "id": "066c374727803465",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "63784c48c7223f7c",
        "name": "Power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_power",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "battery_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 310,
        "y": 500,
        "wires": [
            [
                "b6fddae094a87429"
            ]
        ]
    },
    {
        "id": "659e2e54edfdc360",
        "type": "api-call-service",
        "z": "59063a3baf57637d",
        "g": "1aee044af1119570",
        "name": "Node-RED status: OK",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.house_battery_control_has_node_red"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_boolean",
        "service": "turn_on",
        "x": 1760,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "0ba042d1972ab536",
        "type": "inject",
        "z": "59063a3baf57637d",
        "g": "1aee044af1119570",
        "name": "On deploy",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.1",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1410,
        "y": 60,
        "wires": [
            [
                "092fedf08d51f006",
                "9e03d6e607ea076f"
            ]
        ]
    },
    {
        "id": "d5e5855c16ff9b93",
        "type": "api-call-service",
        "z": "59063a3baf57637d",
        "g": "ec88548dfe1d6caf",
        "name": "Set mode (charge/discharge/stop)",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 660,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "769af00902e6a149",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "ec88548dfe1d6caf",
        "name": "Set Batteries",
        "func": "// Logger\nconst log = global.get(\"logger\");\n\n// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n// Output format and target\nlet outputArray = [];\nlet solution = msg.solutions[msg.battery_index-1]; // Base-0, thus -1\nif (solution === undefined) {\n    log(this,`Can't find solution for index ${msg.battery_index - 1} in ${msg.solutions}, aborting...`,\"error\");\n    return null;\n}\nlet target = `marstek_${solution.id.toLowerCase()}`;\n\n// Safety | Id exists\nlet battery = msg.batteries.find(battery => battery.id === solution.id);\nif (battery === undefined) {\n    log(`Can't set battery ${solution.id}, aborting...`,\"error\");\n    return null;\n}\n// Safety | Power limit\nsolution.power = Math.min(solution.power, solution.mode == CMODE.CHARGE ? battery.charging_max: battery.discharging_max);\n\n// Set | Mode\nconst serviceCallMode = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_forcible_charge_discharge`]\n    },\n    \"data\": {\n         \"option\": String(solution.mode) // forced charge mode (stop, charge, discharge)\n    }\n};\n// Add topic to allow correct 'on change' filtering\noutputArray.push({payload: serviceCallMode, topic:solution.id});\n\n// Set | Power\nconst serviceCallPower = {\n    \"action\": \"number.set_value\",\n    \"target\": {\n        \"entity_id\": [\n            `number.${target}_forcible_charge_power`,\n            `number.${target}_forcible_discharge_power`\n            ]\n    },\n    \"data\": {\n        \"value\": Number(solution.power)\n    } \n};\n// Add topic to allow correct 'on change' filtering\noutputArray.push({payload: serviceCallPower, topic:solution.id});\n\n// Store service calls in msg to allow checking of loop results\nmsg.loop_result = { target, serviceCallMode, serviceCallPower };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Explain\nlog(this,`${target} ${String(solution.mode)} @ ${Number(solution.power)} Watt`);\n\n// Output\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 1140,
        "wires": [
            [
                "d5e5855c16ff9b93"
            ],
            [
                "94e274ecfc4e6b1e"
            ],
            [
                "53f1cbbeaab9646f"
            ]
        ],
        "inputLabels": [
            "Msg with a battery_index"
        ],
        "outputLabels": [
            "Select MODE",
            "Set POWER",
            "Msg"
        ]
    },
    {
        "id": "937ef8f7c7230efb",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "798eeecf6db8cfc9",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = msg.battery_count;\n\n// Debug\nRED.util.setMessageProperty(msg, \"debug\", `## Cohort ${Date.now()} ##`);\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 1140,
        "wires": [
            [
                "769af00902e6a149"
            ]
        ]
    },
    {
        "id": "2934d0f9189a8827",
        "type": "switch",
        "z": "59063a3baf57637d",
        "g": "ec88548dfe1d6caf",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 740,
        "y": 1200,
        "wires": [
            [
                "769af00902e6a149"
            ],
            [
                "7dcf7da07a79e24c"
            ]
        ]
    },
    {
        "id": "53f1cbbeaab9646f",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "ec88548dfe1d6caf",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index -= 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 1200,
        "wires": [
            [
                "2934d0f9189a8827",
                "c8484a6496568b34"
            ]
        ]
    },
    {
        "id": "b0cd9dd46fc994eb",
        "type": "api-call-service",
        "z": "59063a3baf57637d",
        "g": "ec88548dfe1d6caf",
        "name": "Set power (W)",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 760,
        "y": 1140,
        "wires": [
            []
        ]
    },
    {
        "id": "64e437c3157ec537",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "798eeecf6db8cfc9",
        "name": "Timing start",
        "func": "RED.util.setMessageProperty(msg,\"setbatteries.execution_start\",Date.now());\nRED.util.setMessageProperty(msg,\"setbatteries.marker\", `M1_${Date.now()}`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 1100,
        "wires": [
            [
                "937ef8f7c7230efb"
            ]
        ]
    },
    {
        "id": "b6bbde7288bb7801",
        "type": "switch",
        "z": "59063a3baf57637d",
        "g": "798eeecf6db8cfc9",
        "name": "solutions present",
        "property": "solutions",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "undefined",
                "vt": "jsonata"
            },
            {
                "t": "neq",
                "v": "undefined",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 150,
        "y": 1060,
        "wires": [
            [
                "59d0fdb4ad45c417"
            ],
            [
                "64e437c3157ec537"
            ]
        ]
    },
    {
        "id": "7dcf7da07a79e24c",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "798eeecf6db8cfc9",
        "name": "Timing end",
        "func": "let start = RED.util.getMessageProperty(msg,\"setbatteries.execution_start\");\nlet end = Date.now();\nlet delta = end - start;\nlet timingString = `${delta/1000} sec`;\n\nnode.status({fill:\"green\",shape:\"dot\",text: timingString});\nmsg.delta = delta;\nmsg.timing = timingString;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 1320,
        "wires": [
            [
                "4ef0e3ae811d18e1",
                "085abdeb02330a07"
            ]
        ]
    },
    {
        "id": "c8484a6496568b34",
        "type": "debug",
        "z": "59063a3baf57637d",
        "g": "ec88548dfe1d6caf",
        "name": "Step result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 750,
        "y": 1240,
        "wires": []
    },
    {
        "id": "94e274ecfc4e6b1e",
        "type": "rbe",
        "z": "59063a3baf57637d",
        "g": "ec88548dfe1d6caf",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 590,
        "y": 1140,
        "wires": [
            [
                "b0cd9dd46fc994eb"
            ]
        ]
    },
    {
        "id": "4ef0e3ae811d18e1",
        "type": "debug",
        "z": "59063a3baf57637d",
        "g": "798eeecf6db8cfc9",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "debug",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 270,
        "y": 1320,
        "wires": []
    },
    {
        "id": "72261278517752ce",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "0b35ba610f52f04f",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 580,
        "wires": [
            [
                "026db848493f3166"
            ]
        ]
    },
    {
        "id": "bd7efdcea817b0b7",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "ec8bbed7e42487f2",
        "name": "Update battery order",
        "func": "// Cycles battery priority as follows\n// M=1 [1,2,3,4] | M=2 [2,3,4,1] | M=3 [3,4,1,2] | etc.\n// With M the battery to prioritize\n\n// msg.batteries (original order)\nlet currentArray = msg.batteries;\n\n// Prioritize the Mth battery\nconst M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// 1st battery has prio? Skip and continue without change\nif (M==1) return msg;\n\n// N equals the number of items to take from the front to the back of the array, effectivly rotating battery priority\nconst N = M - 1; // base-0 version of M\nnode.status({fill:\"blue\",shape:\"ring\",text:`N = ${N}`});\n\n// 1. Check if the array is valid and long enough\nif (!Array.isArray(currentArray) || currentArray.length < N) {\n    // Send an error or the original array back if the array is invalid/too short\n    node.error(`Array is not valid or shorter than ${N} items.`, msg);\n    return null;\n}\n\n// 2. Get the first N items (these will go to the back)\n// slice(0, N) retrieves elements from the start (index 0) up to index N (exclusive).\nlet firstN = currentArray.slice(0, N);\n\n// 3. Get the remaining items (these will stay at the front)\n// slice(N) retrieves elements from index N to the end of the array.\nlet remaining = currentArray.slice(N);\n\n// 4. Concatenate them: remaining items (front) + first N items (back)\nlet newArray = remaining.concat(firstN);\n\n// 5. Place the new array back into msg.batteries\nmsg.batteries = newArray;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 780,
        "wires": [
            [
                "4c175e813f75b9d9"
            ]
        ]
    },
    {
        "id": "8cc9f90f84d6cbe6",
        "type": "inject",
        "z": "59063a3baf57637d",
        "g": "ec8bbed7e42487f2",
        "name": "Every day 02:00",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 02 * * *",
        "once": false,
        "onceDelay": "5",
        "topic": "cycle_battery_priority",
        "payload": "",
        "payloadType": "date",
        "x": 610,
        "y": 780,
        "wires": [
            [
                "05fd146f9449f716"
            ]
        ]
    },
    {
        "id": "23127bd588a1b4fc",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "ec8bbed7e42487f2",
        "name": "Change priority",
        "func": "// Current prioritized battery is the Mth battery\nlet M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// Prioritize the next battery\nM += 1;\n\n// If the next battery does not exist, prioritize the first again\nif(M > msg.battery_count) M = 1;\n\n// Pass along as payload\nmsg.payload = M;\n\n// Show which battery has priority\nnode.status({fill:\"green\",shape:\"dot\",text:`Prioritize battery #${M}`});\n\n// Done\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1540,
        "y": 780,
        "wires": [
            [
                "ae635fad5304a589"
            ]
        ]
    },
    {
        "id": "3b264b781302266e",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "ec8bbed7e42487f2",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1350,
        "y": 780,
        "wires": [
            [
                "23127bd588a1b4fc"
            ]
        ]
    },
    {
        "id": "ad06d47a23dfa4ba",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "ec8bbed7e42487f2",
        "name": "Prioritize battery M",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_prioritize_battery",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "prioritize_battery",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 780,
        "wires": [
            [
                "bd7efdcea817b0b7"
            ]
        ]
    },
    {
        "id": "ae635fad5304a589",
        "type": "api-call-service",
        "z": "59063a3baf57637d",
        "g": "ec8bbed7e42487f2",
        "name": "Update prioritized battery",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_prioritize_battery"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1750,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "05fd146f9449f716",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "ec8bbed7e42487f2",
        "name": "Desired interval",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_control_priority_change_interval",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 780,
        "wires": [
            [
                "e964084e62328bda"
            ]
        ]
    },
    {
        "id": "e964084e62328bda",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "ec8bbed7e42487f2",
        "name": "Check interval ",
        "func": "// Manual priority, never pass\nif(msg.payload == \"Never\") {\n    node.status({fill:\"yellow\",shape:\"dot\",text:\"Auto cycle disabled\"});\n    return null;\n}\n\n// Daily interval, always pass\nif(msg.payload == \"Daily\") {\n    node.status({ fill: \"green\", shape: \"dot\", text: `Pass` });\n    return msg;\n}\n\n// Weekly interval\nconst today = new Date();\n// Get the day of the week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)\nconst dayOfWeek = today.getDay();\n\n// Check if the day is Sunday (which is represented by the number 0)\nif (dayOfWeek === 0) {\n    // If it is Sunday, pass\n    node.status({ fill: \"green\", shape: \"dot\", text: `Passed on Sunday` });\n    return msg;\n} else {\n    // If it is not Sunday, stop\n    node.status({ fill: \"yellow\", shape: \"dot\", text: `Halted, not Sunday` });\n    return null;\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 780,
        "wires": [
            [
                "76f78deb13f5fa69"
            ]
        ]
    },
    {
        "id": "76f78deb13f5fa69",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "ec8bbed7e42487f2",
        "name": "Current priority",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_prioritize_battery",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "prioritize_battery",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1160,
        "y": 780,
        "wires": [
            [
                "3b264b781302266e"
            ]
        ]
    },
    {
        "id": "e935e81193dba8d1",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "7c0d89ddfb71a3e0",
        "name": "Batteries (totals)",
        "func": "// batteries | calculate total and max. power delivered by batteries\nlet batteries = msg.batteries;\nlet batteries_total_power = 0;\nlet batteries_max_charging_power = 0;\nlet batteries_max_discharging_power = 0;\nlet batteries_available_energy = 0;\nlet batteries_max_energy = 0;\n\nbatteries.forEach(battery => {\n    batteries_total_power += Number(battery.power);\n    batteries_max_charging_power += Number(battery.charging_max);\n    batteries_max_discharging_power += Number(battery.discharging_max);\n    batteries_available_energy += Number(battery.energy - battery.energy_max*battery.soc_min/100);\n    batteries_max_energy += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_total_power\", batteries_total_power, true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_charge_power\", batteries_max_charging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_discharge_power\", batteries_max_discharging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_available_energy\",batteries_available_energy,true); // kWh usable\nRED.util.setMessageProperty(msg, \"batteries_max_energy\", batteries_max_energy, true); // kWh usable\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 680,
        "wires": [
            [
                "ad06d47a23dfa4ba",
                "f353f4c838b53f75"
            ]
        ],
        "inputLabels": [
            "Mapping (from Home Battery IO)"
        ]
    },
    {
        "id": "4fd95964179e9a74",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "63784c48c7223f7c",
        "name": "Energy max",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_total_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_total_energy",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1570,
        "y": 500,
        "wires": [
            [
                "70ed9a9cf4834cf3"
            ]
        ]
    },
    {
        "id": "9db32c035557e8dc",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "0b35ba610f52f04f",
        "name": "Loop end",
        "func": "// cleanup \ndelete msg.battery_index;\n\ndelete msg.battery_power;\ndelete msg.max_charge_power;\ndelete msg.max_discharge_power;\ndelete msg.battery_state_of_charge;\ndelete msg.charging_cutoff_capacity;\ndelete msg.discharging_cutoff_capacity;\ndelete msg.inverter_state;\ndelete msg.battery_remaining_capacity;\ndelete msg.battery_total_energy;\ndelete msg.rs485_control_mode;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 580,
        "wires": [
            [
                "c83d594eb620158c",
                "e935e81193dba8d1"
            ]
        ]
    },
    {
        "id": "6f93415ab9c74d06",
        "type": "api-call-service",
        "z": "59063a3baf57637d",
        "g": "4a3d44c2af78e412",
        "name": "Set total usable energy",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_total_available_energy"
        ],
        "labelId": [],
        "data": "{\"value\":$$.batteries_available_energy}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1760,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "05ea9a7dc76e3d80",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "dce07674a07ac53b",
        "name": "Full Stop Trigger",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.ev_is_charging",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "full_stop_trigger",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 140,
        "y": 940,
        "wires": [
            [
                "13c7ea09c9dbf0ed"
            ]
        ]
    },
    {
        "id": "f353f4c838b53f75",
        "type": "rbe",
        "z": "59063a3baf57637d",
        "g": "4a3d44c2af78e412",
        "name": "On change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "batteries_available_energy",
        "topi": "topic",
        "x": 1570,
        "y": 680,
        "wires": [
            [
                "6f93415ab9c74d06"
            ]
        ]
    },
    {
        "id": "350efd05202fe26b",
        "type": "switch",
        "z": "59063a3baf57637d",
        "g": "2ea0a7e531ef39e4",
        "name": "Select rate limit",
        "property": "p1_rate_limit.save_power",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 660,
        "y": 280,
        "wires": [
            [
                "2c5766e8c091eaeb"
            ],
            [
                "07a08a4d89f7bb25"
            ]
        ]
    },
    {
        "id": "8f6f14e7945d6e3f",
        "type": "delay",
        "z": "59063a3baf57637d",
        "g": "2ea0a7e531ef39e4",
        "name": "Rate limit",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": true,
        "outputs": 2,
        "x": 980,
        "y": 280,
        "wires": [
            [
                "9e7e5422b1bcf6ea"
            ],
            [
                "8cc370c1f995a2b8"
            ]
        ],
        "outputLabels": [
            "Pass",
            ""
        ]
    },
    {
        "id": "07a08a4d89f7bb25",
        "type": "change",
        "z": "59063a3baf57637d",
        "g": "2ea0a7e531ef39e4",
        "name": "1 msg/s",
        "rules": [
            {
                "t": "set",
                "p": "rate",
                "pt": "msg",
                "to": "1000",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 300,
        "wires": [
            [
                "8f6f14e7945d6e3f"
            ]
        ]
    },
    {
        "id": "2c5766e8c091eaeb",
        "type": "change",
        "z": "59063a3baf57637d",
        "g": "2ea0a7e531ef39e4",
        "name": "0.333 msg/s",
        "rules": [
            {
                "t": "set",
                "p": "rate",
                "pt": "msg",
                "to": "3000",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 830,
        "y": 260,
        "wires": [
            [
                "8f6f14e7945d6e3f"
            ]
        ]
    },
    {
        "id": "1520bd6cc3ca34cf",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "2ea0a7e531ef39e4",
        "name": "P1 change (20W or 2%)",
        "func": "// Switch between low and high rate limiting to decrease load and power consumption\n// --\n// The flow should always be rate limited by atleast the total execution time of strategies\n// The flow should not lock up indefinitly when grid_power is constant.\n// In the latter case, a more relaxed rate limit can help reduce system load.\n// Devs: don't set msg.rate directly. Use nodes, so novice users can easily read the flow.\n\n// Thresholds for change in power, before switching to high rate limit\nconst THRESHOLD_POWER = 20; // Watt change\nconst THRESHOLD_PERCENT = 2; // Percentage\nRED.util.setMessageProperty(msg, \"p1_rate_limit.threshold_power\", THRESHOLD_POWER,true);\nRED.util.setMessageProperty(msg, \"p1_rate_limit.threshold_percent\", THRESHOLD_PERCENT, true);\n\n// Get the previous value from this node's context\n// If it doesn't exist yet, initialize it as null\nlet previousValue = context.get('previousValue') || null;\nlet currentValue = Number(msg.grid_power);\n\n// Save the current value for the next time the node is triggered\ncontext.set('previousValue', currentValue);\n\n// Default rate limiting\nRED.util.setMessageProperty(msg,\"p1_rate_limit.save_power\",true);\n\n// Check if we have a valid history to compare with\nif (previousValue !== null) {\n    let powerChange = Math.abs(currentValue - previousValue);\n    let percentageChange = previousValue !== 0 ? Math.abs((powerChange / previousValue) * 100):0;\n\n    // Condition: Absolute difference > N Watt AND percentage change > M %\n    if (powerChange > THRESHOLD_POWER && percentageChange > THRESHOLD_PERCENT) {\n        // Enable faster refresh rate\n        RED.util.setMessageProperty(msg,\"p1_rate_limit.save_power\",false);\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 280,
        "wires": [
            [
                "350efd05202fe26b"
            ]
        ]
    },
    {
        "id": "e28342b88cef9490",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "2ea0a7e531ef39e4",
        "name": "CPU power saved",
        "func": "// Logger\nconst logger = global.get(\"logger\");\n\n// Passed or blocked\nconst hasPassed = msg.payload; // 0 = blocked, 1 = passed\n\n// 1. Get evaluations (Total attempts)\nlet evaluations = (context.get(\"p1_rate_limit_evaluations\") || 0) + 1;\ncontext.set(\"p1_rate_limit_evaluations\", evaluations);\n\n// 2. Increment and get passes (Filtered/successful events)\nlet passes = (context.get(\"p1_rate_limit_passes\") || 0) + hasPassed;\ncontext.set(\"p1_rate_limit_passes\", passes);\n\n// 3a. Calculate percentage (Rate of passing vs total evaluations)\nlet percentage = evaluations > 0 ? (passes / evaluations) * 100 : 0;\n// 3b. Display the percentage rate of not-passing as a measure of efficiency gained\npercentage = 100 - percentage;\n\n// 4. Update Node Status\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `Saved: ${percentage.toFixed(2)}% (${evaluations-passes}/${evaluations})`\n});\n\n// 5. Explain\n// On block\nif(hasPassed === 0) {\n    if(msg.p1_rate_limit.save_power === true) {\n        // This is good\n        logger(this, `<font color=\"#009ac7\">Power saved</font> by P1 Rate Limiter, execution stopped.`); \n    } else {\n        // This is not so good. P1 updates are coming in fast.\n        logger(this, `<font color=\"orange\">Blocked</font> by P1 Rate Limiter. ${Number(1000/msg.rate).toFixed(2)} messages per second exceeded.`); \n    }\n    \n    // Send message onward to debug dashboard\n    return msg;\n}\n// No output on pass\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1270,
        "y": 280,
        "wires": [
            [
                "59fde12f6acd2295"
            ]
        ]
    },
    {
        "id": "c36d6b5c4db224cf",
        "type": "debug",
        "z": "59063a3baf57637d",
        "g": "dce07674a07ac53b",
        "name": "Strategy evaluation",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 960,
        "wires": []
    },
    {
        "id": "9453982b65f1c6aa",
        "type": "api-call-service",
        "z": "59063a3baf57637d",
        "g": "825e1c268a1160cb",
        "name": "Show on dashboard",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_text.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_text.house_battery_strategy_active_sub_strategy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.ui_value_new}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_text",
        "service": "set_value",
        "x": 1760,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "ed457cf47f828f49",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "825e1c268a1160cb",
        "name": "current UI value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.house_battery_strategy_active_sub_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "ui_value_current",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1360,
        "y": 960,
        "wires": [
            [
                "1b9eb35ff8aa80ef"
            ]
        ]
    },
    {
        "id": "1b9eb35ff8aa80ef",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "825e1c268a1160cb",
        "name": "on new UI value",
        "func": "// Block when undefined (don't update UI)\nif(msg.ui_value_current === undefined) return null;\n\n// We show the 2nd strategy in the trace (if available) on the dashboard as the 'active sub-strategy'\nconst secondTraceEntry = msg.strategy?.trace?.[1];\nif (secondTraceEntry) {\n    // Handle case where 2nd flow is present\n    msg.ui_value_new =  secondTraceEntry.flow;\n} else {\n    // Handle case where the 2nd flow is missing\n    // Get a sensible alternative\n    msg.ui_value_new = msg.strategy?.selected || \"\"; // don't use unknown or unavailable as these are reserved HA keywords\n}\n\n// Improve human readability\nif(msg.ui_value_new == \"Self-consumption\" && secondTraceEntry?.flow_settings?.discharge_disabled === true){\n    msg.ui_value_new = \"Self-consumption (charge only)\";\n}\nif(msg.ui_value_new == \"Self-consumption\" && secondTraceEntry?.flow_settings?.charge_disabled === true){\n    msg.ui_value_new = \"Self-consumption (no charging)\";\n}\n\n// Node status for devs\nnode.status({fill:\"grey\",shape:\"dot\",text:`new: ${msg.ui_value_new}`});\n\n// Block when equal (don't update UI)\nif(msg.ui_value_current === msg.ui_value_new) return null;\n\n// Pass otherwise\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1560,
        "y": 960,
        "wires": [
            [
                "9453982b65f1c6aa"
            ]
        ]
    },
    {
        "id": "a7bdb29faaea9d71",
        "type": "ha-fire-event",
        "z": "59063a3baf57637d",
        "g": "7a7344205735b39a",
        "name": "Show on debug board",
        "server": "176d29a.6f648d6",
        "version": 0,
        "event": "update_trace_sensor",
        "data": "{\t   \"trace\": strategy.trace ? strategy.trace : [],\t   \"start\": strategy.execution_start ? strategy.execution_start : 0,\t   \"end\": strategy.execution_end ? strategy.execution_end : 0,\t   \"log\": log ? log : []\t}",
        "dataType": "jsonata",
        "x": 1740,
        "y": 1320,
        "wires": [
            []
        ]
    },
    {
        "id": "1da9c8cd44a4a345",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "b4565b43b4a004c7",
        "name": "Debug mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_control_is_debug_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "debug_mode",
                "propertyType": "msg",
                "value": "ha_boolean",
                "valueType": "entityState"
            },
            {
                "property": "debug_mode",
                "propertyType": "global",
                "value": "ha_boolean",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 130,
        "y": 160,
        "wires": [
            [
                "ebdac4d6dfe7cbf2"
            ]
        ]
    },
    {
        "id": "085abdeb02330a07",
        "type": "switch",
        "z": "59063a3baf57637d",
        "g": "7a7344205735b39a",
        "name": "Debug mode?",
        "property": "debug_mode",
        "propertyType": "global",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1540,
        "y": 1320,
        "wires": [
            [
                "a7bdb29faaea9d71"
            ]
        ]
    },
    {
        "id": "5fdac9bbc9915ae2",
        "type": "server-state-changed",
        "z": "59063a3baf57637d",
        "g": "b4565b43b4a004c7",
        "name": "On debug",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 2,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_boolean.house_battery_control_is_debug_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "on",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 380,
        "y": 160,
        "wires": [
            [
                "467d9bfdd3f1f1ec"
            ],
            []
        ]
    },
    {
        "id": "467d9bfdd3f1f1ec",
        "type": "trigger",
        "z": "59063a3baf57637d",
        "g": "b4565b43b4a004c7",
        "name": "disable debug after 5 minutes",
        "op1": "",
        "op2": "off",
        "op1type": "nul",
        "op2type": "str",
        "duration": "5",
        "extend": false,
        "overrideDelay": false,
        "units": "min",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 590,
        "y": 160,
        "wires": [
            [
                "31616908343abdd3"
            ]
        ]
    },
    {
        "id": "31616908343abdd3",
        "type": "api-call-service",
        "z": "59063a3baf57637d",
        "g": "b4565b43b4a004c7",
        "name": "Turn debug OFF",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.house_battery_control_is_debug_mode"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_boolean",
        "service": "turn_off",
        "x": 820,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "092fedf08d51f006",
        "type": "delay",
        "z": "59063a3baf57637d",
        "g": "1aee044af1119570",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1580,
        "y": 60,
        "wires": [
            [
                "659e2e54edfdc360"
            ]
        ]
    },
    {
        "id": "9e03d6e607ea076f",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "d4e59c272ae9c284",
        "name": "Custom logger",
        "func": "/**\n * Custom Logger Function\n * * Provides centralized logging, node-status updates, and message tracing.\n * Specifically designed for Home Battery Control logic within Node-RED.\n * \n * Debug dashboard updating:\n * A msg needs to reach 'Strategy Evaluation' or be passed to the \"Show on debug board\" trigger node.\n * Errors are automatically passed to the \"Show on debug board\" trigger node.\n * \n * * @param {object} callingNode - The context of the calling node (pass 'this').\n * @param {string} text - The log message/explanation.\n * @param {string} level - Log level: 'log', 'warn', 'error', or 'info' (default: 'info').\n * \n * Note: anything above 'info' will also write to the Node-RED log files \n * \n * * @usage: \n * const log = global.get(\"logger\");\n * log(this, \"Charging cycle started\");\n */\nconst customLogger = (callingNode, text, level = 'info') => {\n    \n    // Log only when debug_mode is ON\n    const debug_mode = global.get(\"debug_mode\") || false;\n    if(debug_mode == false) return null;\n\n    // Max log elements to keep\n    const MAX_ELEMENTS = 100;\n\n    // Create the YYYY-MM-DD HH:MM:SS.mmm format\n    const now = new Date();\n    const timestamp = now.getHours().toString().padStart(2, '0') + \":\" +\n                now.getMinutes().toString().padStart(2, '0') + \":\" +\n                now.getSeconds().toString().padStart(2, '0') + \".\" +\n                now.getMilliseconds().toString().padStart(3, '0');\n\n    const formattedTimeLevel = `${timestamp} [${level.toLowerCase()}]`;\n    \n    // Get the name of the node or fallback to the ID\n    const nodeName = callingNode.__node__ ? callingNode.__node__.name || callingNode.__node__.id : undefined;\n    // Get the name of the Flow/Tab\n    const flowName = callingNode.env.get(\"NR_FLOW_NAME\") || \"Unknown flow\";\n    // Explain to the Home Battery Control user what is going on\n    const formattedExplenation = `[${flowName} >> ${nodeName}]: ${text}`;\n\n    // Level icons\n    let icon = \"\";\n    switch (level) {\n        case \"info\":\n            icon = \"\";\n            break;\n        case \"log\":\n            icon = \"\";\n            break;\n        case \"warn\":\n            icon = \"\";      \n            break;\n        case \"error\":\n            icon = \"\";\n            break;\n    }\n\n    // Enrich msg with log info\n    const msg = callingNode.msg;\n    (msg.log = msg.log || []).push({ timestamp: timestamp, level:level, flow:flowName, node:nodeName, payload: text, icon: icon});\n\n    if (msg.log.length > MAX_ELEMENTS) {\n        // Slice keeps the last X elements\n        msg.log = msg.log.slice(-MAX_ELEMENTS);\n    }\n\n    // Log to the Node-RED system log\n    switch (level) {\n        case \"log\":\n            node.log(`${formattedExplenation}`);\n            break;\n        case \"warn\":\n            node.warn(`${formattedExplenation}`);       \n            break;\n        case \"error\":\n            node.error(`${formattedExplenation}`, callingNode.msg);\n            break;\n        default:\n            // don't log to logfiles by default\n    }\n\n};\n\nglobal.set('logger', customLogger);\nglobal.set('unhandledException', \"\");\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1740,
        "y": 160,
        "wires": [
            [
                "5f40dc49bb2e540f"
            ]
        ]
    },
    {
        "id": "9e7e5422b1bcf6ea",
        "type": "change",
        "z": "59063a3baf57637d",
        "g": "2ea0a7e531ef39e4",
        "name": "Pass",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "1",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1110,
        "y": 300,
        "wires": [
            [
                "e28342b88cef9490",
                "5997997551921646"
            ]
        ]
    },
    {
        "id": "8cc370c1f995a2b8",
        "type": "change",
        "z": "59063a3baf57637d",
        "g": "2ea0a7e531ef39e4",
        "name": "Block",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1110,
        "y": 260,
        "wires": [
            [
                "e28342b88cef9490"
            ]
        ]
    },
    {
        "id": "5baa8cda5860b5a4",
        "type": "link in",
        "z": "59063a3baf57637d",
        "g": "7a7344205735b39a",
        "name": "Update debug dashboard",
        "links": [
            "59fde12f6acd2295",
            "59d0fdb4ad45c417"
        ],
        "x": 1395,
        "y": 1260,
        "wires": [
            [
                "085abdeb02330a07",
                "60b5b1efe51299ae"
            ]
        ]
    },
    {
        "id": "59fde12f6acd2295",
        "type": "link out",
        "z": "59063a3baf57637d",
        "g": "2ea0a7e531ef39e4",
        "name": "goto Debug Dashboard update",
        "mode": "link",
        "links": [
            "5baa8cda5860b5a4"
        ],
        "x": 1395,
        "y": 280,
        "wires": []
    },
    {
        "id": "88e057c961b1849f",
        "type": "catch",
        "z": "59063a3baf57637d",
        "g": "7a7344205735b39a",
        "name": "Custom logger",
        "scope": [
            "9e03d6e607ea076f"
        ],
        "uncaught": false,
        "x": 1340,
        "y": 1380,
        "wires": [
            [
                "085abdeb02330a07",
                "adce095aaf57c65f"
            ]
        ]
    },
    {
        "id": "adce095aaf57c65f",
        "type": "debug",
        "z": "59063a3baf57637d",
        "g": "7a7344205735b39a",
        "name": "Via Catch",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "counter",
        "x": 1520,
        "y": 1380,
        "wires": []
    },
    {
        "id": "60b5b1efe51299ae",
        "type": "debug",
        "z": "59063a3baf57637d",
        "g": "7a7344205735b39a",
        "name": "Via link",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "counter",
        "x": 1520,
        "y": 1260,
        "wires": []
    },
    {
        "id": "59d0fdb4ad45c417",
        "type": "link out",
        "z": "59063a3baf57637d",
        "g": "798eeecf6db8cfc9",
        "name": "link out 1",
        "mode": "link",
        "links": [
            "5baa8cda5860b5a4"
        ],
        "x": 285,
        "y": 1060,
        "wires": []
    },
    {
        "id": "7907d408d1993e16",
        "type": "switch",
        "z": "59063a3baf57637d",
        "g": "2ea0a7e531ef39e4",
        "name": "Skip rate limiter during debug",
        "property": "debug_mode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 180,
        "y": 280,
        "wires": [
            [
                "1520bd6cc3ca34cf"
            ],
            [
                "5997997551921646"
            ]
        ]
    },
    {
        "id": "ebdac4d6dfe7cbf2",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "b4565b43b4a004c7",
        "name": "Notice",
        "func": "// Explain when debugging\nif(msg.debug_mode == true){\n    const log = global.get(\"logger\");\n    log(this, \"P1 Rate limiter is *disabled* during *debug mode*\");\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 235,
        "y": 160,
        "wires": [
            [
                "7907d408d1993e16"
            ]
        ],
        "l": false
    },
    {
        "id": "b28868630b184c67",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "63784c48c7223f7c",
        "name": "SoC min",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.marstek_m{{battery_index}}_discharging_cutoff_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "discharging_cutoff_capacity",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 980,
        "y": 500,
        "wires": [
            [
                "23c69fd97206165c"
            ]
        ]
    },
    {
        "id": "23c69fd97206165c",
        "type": "api-current-state",
        "z": "59063a3baf57637d",
        "g": "63784c48c7223f7c",
        "name": "SoC max",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.marstek_m{{battery_index}}_charging_cutoff_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charging_cutoff_capacity",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1120,
        "y": 500,
        "wires": [
            [
                "ad99b0d7f8d3dc7a"
            ]
        ]
    },
    {
        "id": "5f40dc49bb2e540f",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "d4e59c272ae9c284",
        "name": "Unhandled Exception",
        "func": "/**\n * Handles exceptions by extracting node details and routing them to a global logger.\n * This is designed to be called from within a Node-RED Function node or sub-flow.\n *\n * @param {Object} callingNode - The Node-RED 'this' context or msg object containing node metadata.\n * @param {Object} [callingNode.msg] - The message object associated with the error.\n * @param {Object} [callingNode.msg.error] - Error details provided by a Node-RED error catch.\n * @param {string} [callingNode.msg.error.message] - The specific error message.\n * @param {Object} [callingNode.msg.error.source] - The node that triggered the error.\n * * @example\n * // Usage in a Function Node:\n * const unhandledException = global.get('unhandledException');\n * unhandledException(this);\n */\nconst unhandledException = (callingNode) => {\n    // 1. Get the custom logger from global context\n    const log = global.get(\"logger\");\n\n    // 2. Extract error details from the msg object\n    const errorData = callingNode.msg?.error || {};\n    const errorMessage = errorData.message || \"Unknown error occurred\";\n    const sourceName = errorData.source ? (errorData.source.name || errorData.source.id) : \"Unknown Node\";\n    const sourceType = errorData.source ? errorData.source.type : \"unknown-type\";\n\n    // 3. Construct a user-friendly message for the logger\n    const friendlyMessage = `**Unhandled exception** (${sourceType} node) ${errorMessage}`;\n    callingNode.__node__ ??= {};\n    callingNode.__node__.name = sourceName;\n\n    // 4. Call the logger with level 'error'\n    // Note: the logger uses 'callingNode', we pass on whatever we have.\n    log(callingNode, friendlyMessage, 'error');\n\n};\n\nglobal.set('unhandledException', unhandledException);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1760,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "bdc4cf85aa3fb39d",
        "type": "catch",
        "z": "59063a3baf57637d",
        "g": "941ddfadb9e6a315",
        "name": "",
        "scope": null,
        "uncaught": true,
        "x": 1745,
        "y": 320,
        "wires": [
            [
                "b0ab500bc06a294b"
            ]
        ],
        "l": false
    },
    {
        "id": "b0ab500bc06a294b",
        "type": "function",
        "z": "59063a3baf57637d",
        "g": "941ddfadb9e6a315",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1795,
        "y": 320,
        "wires": [
            [
                "c6f6438baf85947f"
            ]
        ],
        "l": false
    },
    {
        "id": "c6f6438baf85947f",
        "type": "link out",
        "z": "59063a3baf57637d",
        "g": "941ddfadb9e6a315",
        "name": "link out 9",
        "mode": "return",
        "links": [],
        "x": 1845,
        "y": 320,
        "wires": []
    },
    {
        "id": "095b3ff4cc937fc1",
        "type": "link in",
        "z": "a216ce8676512c2f",
        "g": "187270fe0271e694",
        "name": "Charge PV",
        "links": [],
        "x": 100,
        "y": 160,
        "wires": [
            [
                "568de279b26b74ab"
            ]
        ],
        "l": true
    },
    {
        "id": "393db30f940eb849",
        "type": "comment",
        "z": "a216ce8676512c2f",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "2ae4d218319d5d75",
        "type": "comment",
        "z": "a216ce8676512c2f",
        "g": "187270fe0271e694",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "d09a0696a9b65104",
        "type": "link out",
        "z": "a216ce8676512c2f",
        "g": "35bea22859f3fcba",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 665,
        "y": 180,
        "wires": []
    },
    {
        "id": "4f2b97920b83a56b",
        "type": "comment",
        "z": "a216ce8676512c2f",
        "g": "35bea22859f3fcba",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 720,
        "y": 120,
        "wires": []
    },
    {
        "id": "fbbff0150d6e3c98",
        "type": "function",
        "z": "a216ce8676512c2f",
        "name": "Setup",
        "func": "// explain\nconst log = global.get(\"logger\");\nlog(this,\"Using self-consumption to charge with surplus PV\")\n\n// use the self consumption strategy to charge when there is PV surplus\nmsg.target = \"Self-consumption\";\n\n// tell that strategy to disalow discharging\nconst DISABLE_DISCHARGE = true;\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\",DISABLE_DISCHARGE,true);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 180,
        "wires": [
            [
                "2b3281f411542268"
            ]
        ]
    },
    {
        "id": "2b3281f411542268",
        "type": "link call",
        "z": "a216ce8676512c2f",
        "name": "Self-consumption",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 470,
        "y": 180,
        "wires": [
            [
                "f1ecc53d831bd866",
                "d09a0696a9b65104"
            ]
        ]
    },
    {
        "id": "f1ecc53d831bd866",
        "type": "debug",
        "z": "a216ce8676512c2f",
        "name": "Batteries charging?",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "batteries_charging",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 730,
        "y": 260,
        "wires": []
    },
    {
        "id": "568de279b26b74ab",
        "type": "change",
        "z": "a216ce8676512c2f",
        "g": "187270fe0271e694",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 90,
        "y": 200,
        "wires": [
            [
                "fbbff0150d6e3c98"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "9f88648553b7a4ad",
        "type": "catch",
        "z": "a216ce8676512c2f",
        "g": "9b804de84213640a",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 55,
        "y": 300,
        "wires": [
            [
                "5cbb79a5862fbca0"
            ]
        ],
        "l": false
    },
    {
        "id": "5cbb79a5862fbca0",
        "type": "function",
        "z": "a216ce8676512c2f",
        "g": "9b804de84213640a",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 105,
        "y": 300,
        "wires": [
            [
                "4914b630b7f1e0c1"
            ]
        ],
        "l": false
    },
    {
        "id": "4914b630b7f1e0c1",
        "type": "link out",
        "z": "a216ce8676512c2f",
        "g": "9b804de84213640a",
        "name": "link out 4",
        "mode": "return",
        "links": [],
        "x": 155,
        "y": 300,
        "wires": []
    },
    {
        "id": "57a620edd19d0813",
        "type": "comment",
        "z": "cc5249a8fa23cd11",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 140,
        "y": 60,
        "wires": []
    },
    {
        "id": "b126dfeafe3f8120",
        "type": "link in",
        "z": "cc5249a8fa23cd11",
        "g": "2c95998a1e4dfc14",
        "name": "Charge",
        "links": [],
        "x": 110,
        "y": 220,
        "wires": [
            [
                "fe9bc4e9c9e62e31"
            ]
        ],
        "l": true
    },
    {
        "id": "c633b654c40e1362",
        "type": "comment",
        "z": "cc5249a8fa23cd11",
        "g": "2c95998a1e4dfc14",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 130,
        "y": 140,
        "wires": []
    },
    {
        "id": "fe9bc4e9c9e62e31",
        "type": "change",
        "z": "cc5249a8fa23cd11",
        "g": "2c95998a1e4dfc14",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 180,
        "wires": [
            [
                "cc1bb708ce4e5ad3"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "386b82cc4dd3c386",
        "type": "link out",
        "z": "cc5249a8fa23cd11",
        "g": "a6b3cb9c833c85dc",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 185,
        "y": 580,
        "wires": []
    },
    {
        "id": "84bc351c229e4c02",
        "type": "comment",
        "z": "cc5249a8fa23cd11",
        "g": "a6b3cb9c833c85dc",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 130,
        "y": 520,
        "wires": []
    },
    {
        "id": "ec3f4fadd1929942",
        "type": "link in",
        "z": "cc5249a8fa23cd11",
        "g": "a6b3cb9c833c85dc",
        "name": "link to End",
        "links": [
            "27f04e16ab84d45d",
            "d86110a25211ad24",
            "37f2fd79b7d83ee4"
        ],
        "x": 75,
        "y": 580,
        "wires": [
            [
                "386b82cc4dd3c386"
            ]
        ]
    },
    {
        "id": "23844cd4578daddd",
        "type": "function",
        "z": "cc5249a8fa23cd11",
        "g": "3dc7158e87cad4ea",
        "name": "Max power solution",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\nlog(this, \"Charge at **max. power**\");\n\n// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// build solution\nmsg.batteries.forEach(battery => {\n    const calculatedPower = Number(battery.charging_max);\n\n    solution_array.push({\n        id: battery.id,\n        mode: \"charge\",\n        power: calculatedPower\n    });\n\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 360,
        "wires": [
            [
                "39712a8540909db9"
            ]
        ]
    },
    {
        "id": "32930a5b0c22afaa",
        "type": "link call",
        "z": "cc5249a8fa23cd11",
        "g": "3dc7158e87cad4ea",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1140,
        "y": 400,
        "wires": [
            [
                "1c0e13007af82747",
                "37f2fd79b7d83ee4"
            ]
        ]
    },
    {
        "id": "1525f3b83e632cc1",
        "type": "switch",
        "z": "cc5249a8fa23cd11",
        "g": "3dc7158e87cad4ea",
        "name": "Import at max power",
        "property": "house_battery_strategy_charge_has_max_power",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 760,
        "y": 380,
        "wires": [
            [
                "23844cd4578daddd"
            ],
            [
                "f0fc7328e4d0d24b"
            ]
        ]
    },
    {
        "id": "1c0e13007af82747",
        "type": "debug",
        "z": "cc5249a8fa23cd11",
        "g": "3dc7158e87cad4ea",
        "name": "Regulated",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1330,
        "y": 400,
        "wires": []
    },
    {
        "id": "853b6a0176a0e87d",
        "type": "debug",
        "z": "cc5249a8fa23cd11",
        "g": "3dc7158e87cad4ea",
        "name": "Maximum",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1320,
        "y": 360,
        "wires": []
    },
    {
        "id": "f0fc7328e4d0d24b",
        "type": "function",
        "z": "cc5249a8fa23cd11",
        "g": "3dc7158e87cad4ea",
        "name": "Regulated power",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = msg.house_battery_strategy_charge_target_power;\n// tell PID to avoid discharge solutions during charging.\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\",true,true);\n\n// Finally\nlog(this, `**Regulated** charging. Limit grid power: ${Math.floor(msg.house_battery_strategy_charge_target_power)} W`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 400,
        "wires": [
            [
                "32930a5b0c22afaa"
            ]
        ]
    },
    {
        "id": "39712a8540909db9",
        "type": "change",
        "z": "cc5249a8fa23cd11",
        "g": "3dc7158e87cad4ea",
        "name": "Continue",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Charge",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 360,
        "wires": [
            [
                "853b6a0176a0e87d",
                "37f2fd79b7d83ee4"
            ]
        ]
    },
    {
        "id": "37f2fd79b7d83ee4",
        "type": "link out",
        "z": "cc5249a8fa23cd11",
        "g": "3dc7158e87cad4ea",
        "name": "go to End",
        "mode": "link",
        "links": [
            "ec3f4fadd1929942"
        ],
        "x": 1320,
        "y": 460,
        "wires": [],
        "l": true
    },
    {
        "id": "65fc2e500ed4abaf",
        "type": "api-current-state",
        "z": "cc5249a8fa23cd11",
        "g": "3dc7158e87cad4ea",
        "name": "Use max power?",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_charge_has_max_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_charge_has_max_power",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 380,
        "wires": [
            [
                "47833f2a91b0ec70"
            ]
        ]
    },
    {
        "id": "47833f2a91b0ec70",
        "type": "api-current-state",
        "z": "cc5249a8fa23cd11",
        "g": "3dc7158e87cad4ea",
        "name": "Grid power limit",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_charge_target_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_charge_target_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 560,
        "y": 380,
        "wires": [
            [
                "1525f3b83e632cc1"
            ]
        ]
    },
    {
        "id": "df6103f1afd5c741",
        "type": "function",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Unknown -> Full stop",
        "func": "const log = global.get(\"logger\");\n\n// Unkown export goal\nlog(this, `**${msg.charge.goal}**; Charge goal not recognized. Fallback to **Full Stop**`,\"warn\");\n\n// Full stop\nmsg.target = \"Full stop\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 240,
        "wires": [
            [
                "1c9dadc855747b3c"
            ]
        ]
    },
    {
        "id": "1c9dadc855747b3c",
        "type": "link call",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 990,
        "y": 240,
        "wires": [
            [
                "27f04e16ab84d45d"
            ]
        ]
    },
    {
        "id": "fc1da8b440fe904b",
        "type": "api-current-state",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Energy reserve hi",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_charge_target_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charge.threshold_energy",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 200,
        "wires": [
            [
                "d6b6c5c5ac1f1fe6"
            ]
        ]
    },
    {
        "id": "27f04e16ab84d45d",
        "type": "link out",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "go to End",
        "mode": "link",
        "links": [
            "ec3f4fadd1929942"
        ],
        "x": 1190,
        "y": 240,
        "wires": [],
        "l": true
    },
    {
        "id": "7422ee68976dcd41",
        "type": "api-current-state",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "SoC reached",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_charge_target_soc",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charge.threshold_soc",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 780,
        "y": 160,
        "wires": [
            [
                "fae51135f582fffa"
            ]
        ]
    },
    {
        "id": "d6b6c5c5ac1f1fe6",
        "type": "function",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Check if hi",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Charge until: ${msg.charge.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nvar energy_threshold = Number(RED.util.getMessageProperty(msg,\"charge.threshold_energy\"));\nif (energy_threshold === undefined || energy_threshold <= 0){\n    log(this,`Desired energy reserve invalid '${energy_threshold}' kWh. I've set it to ${Number(msg.batteries_max_energy).toFixed(1)} kWh`,\"warn\");\n    energy_threshold = Math.floor(Number(msg.batteries_max_energy)*10)/10;\n}\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining >= energy_threshold) {\n    msg.charge.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh`, 'info');\n} else {\n    msg.charge.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.charge.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.charge.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 200,
        "wires": [
            [
                "8c7c68306838dcbc",
                "762c2b5621ecfe8f"
            ]
        ]
    },
    {
        "id": "fae51135f582fffa",
        "type": "function",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Check if SoC",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this, `Charge until: ${msg.charge.goal}`);\n\n// 2. Extract average SoC and desired SoC level\nlet batteries = msg.batteries;\nlet soc_avg = 0;\nlet count = 0; // could use msg.battery_count\nbatteries.forEach(battery => {\n    soc_avg += battery.soc;\n    count++;\n});\n// 2.1 Current avg. SoC\nsoc_avg = Math.round(soc_avg / count * 100) / 100;\n// 2.2 Charge until SoC (100% as fallback)\nvar soc_threshold = Number(RED.util.getMessageProperty(msg,\"charge.threshold_soc\"));\nif (soc_threshold === undefined || soc_threshold < 12){\n    log(this, `Desired SoC not set correctly '${soc_threshold}' %. I've set it to 100%.`,\"warn\");\n    soc_threshold = 100;\n}\n\n// 3. Logic: Determine if SoC level is at or above desired level\nif (soc_avg >= soc_threshold) {\n    msg.charge.threshold_reached = true;\n\n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n} else {\n    msg.charge.threshold_reached = false;\n\n    // User friendly feedback via the custom logger\n    log(this, `[OK] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({\n    fill: msg.charge.threshold_reached ? \"red\" : \"green\",\n    shape: \"dot\",\n    text: `Threshold reached: ${msg.charge.threshold_reached}`\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 160,
        "wires": [
            [
                "8c7c68306838dcbc"
            ]
        ]
    },
    {
        "id": "27c45f7e0a149656",
        "type": "change",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Batteries are full",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 790,
        "y": 120,
        "wires": [
            [
                "8dddaffec79431e0"
            ]
        ]
    },
    {
        "id": "8dddaffec79431e0",
        "type": "function",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Check if full",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Charge until: ${msg.charge.goal}`);\n\n// 2. Extract energy level from msg (and handle missing properties)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nconst energy_max = Number(RED.util.getMessageProperty(msg, \"batteries_max_energy\")) || 0;\nif(energy_max == 0) log(this,`Batteries max energy missing! ${msg.batteries_max_energy}`);\n// 2.1 Check if every battery's SoC is at or over the max\nconst isAtMax = msg.batteries.every(battery => battery.soc >= battery.soc_max);\n\n// 3. Logic: Determine if energy level is over or near 99.9% of max eneregy\nif (isAtMax) {\n    msg.charge.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] All batteries are full or at SoC_max_ (${energy_remaining} kWh).`, 'info');\n} else {\n    msg.charge.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Battery level ${energy_remaining.toFixed(2)} kWh below ${energy_max.toFixed(2)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.charge.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.charge.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 120,
        "wires": [
            [
                "8c7c68306838dcbc"
            ]
        ]
    },
    {
        "id": "749411ac1ff41d4a",
        "type": "switch",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Until reached",
        "property": "charge.threshold_reached",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1340,
        "y": 160,
        "wires": [
            [
                "58f1a2fc7d83eb54"
            ],
            [
                "e789c38618e729d5"
            ]
        ]
    },
    {
        "id": "58f1a2fc7d83eb54",
        "type": "function",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Yes -> Charge PV",
        "func": "// If any solar surplus remains, soak it up instead of waiting in Full stop.\nmsg.target = \"Charge PV\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1580,
        "y": 120,
        "wires": [
            [
                "3bd007514830adbd"
            ]
        ]
    },
    {
        "id": "3bd007514830adbd",
        "type": "link call",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 1760,
        "y": 120,
        "wires": [
            [
                "d86110a25211ad24"
            ]
        ]
    },
    {
        "id": "d86110a25211ad24",
        "type": "link out",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "go to End",
        "mode": "link",
        "links": [
            "ec3f4fadd1929942"
        ],
        "x": 1900,
        "y": 120,
        "wires": [],
        "l": true
    },
    {
        "id": "8c7c68306838dcbc",
        "type": "function",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Decided",
        "func": "const log = global.get(\"logger\");\n\nif(msg.charge.threshold_reached){\n    log(this,`Stop charging, Charge until ${msg.charge.goal} reached.`);\n} else {\n    log(this,`Continue charging.`);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1190,
        "y": 160,
        "wires": [
            [
                "749411ac1ff41d4a"
            ]
        ]
    },
    {
        "id": "293ecbb90224de03",
        "type": "switch",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Charge until",
        "property": "charge.goal",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "batteries are full",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "state of charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "energy reserve",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 4,
        "x": 590,
        "y": 180,
        "wires": [
            [
                "27c45f7e0a149656"
            ],
            [
                "7422ee68976dcd41"
            ],
            [
                "fc1da8b440fe904b"
            ],
            [
                "df6103f1afd5c741"
            ]
        ]
    },
    {
        "id": "6e0e2e4b73431a06",
        "type": "api-current-state",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Goal",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_charge_goal",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charge.goal",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 180,
        "wires": [
            [
                "293ecbb90224de03"
            ]
        ]
    },
    {
        "id": "cc1bb708ce4e5ad3",
        "type": "function",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "Init",
        "func": "msg.charge = {};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "6e0e2e4b73431a06",
                "351397735f20735c"
            ]
        ]
    },
    {
        "id": "308ead639f21f3d3",
        "type": "function",
        "z": "cc5249a8fa23cd11",
        "g": "b55009bfdf46eac7",
        "name": "Min/max",
        "func": "\n// Lower bound\nlet output = msg.charge.threshold_energy || 0; // kWh\noutput = Math.max(output, 0);\n\n// Upper bound\noutput = Math.min(output, msg.batteries_max_energy);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1800,
        "y": 200,
        "wires": [
            [
                "d9869900ea4cc845"
            ]
        ]
    },
    {
        "id": "d9869900ea4cc845",
        "type": "api-call-service",
        "z": "cc5249a8fa23cd11",
        "g": "b55009bfdf46eac7",
        "name": "Set desired energy reserve",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_charge_target_energy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.payload}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2010,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "762c2b5621ecfe8f",
        "type": "rbe",
        "z": "cc5249a8fa23cd11",
        "g": "b55009bfdf46eac7",
        "name": "Desired energy changed",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 1600,
        "y": 200,
        "wires": [
            [
                "308ead639f21f3d3"
            ]
        ]
    },
    {
        "id": "351397735f20735c",
        "type": "debug",
        "z": "cc5249a8fa23cd11",
        "g": "5c946ab9461182f2",
        "name": "debug 2",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 410,
        "y": 120,
        "wires": []
    },
    {
        "id": "6e06e9fb70e3bc78",
        "type": "catch",
        "z": "cc5249a8fa23cd11",
        "g": "2a8d2dca66bef169",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 75,
        "y": 420,
        "wires": [
            [
                "bb296a9b4d1102fc"
            ]
        ],
        "l": false
    },
    {
        "id": "bb296a9b4d1102fc",
        "type": "function",
        "z": "cc5249a8fa23cd11",
        "g": "2a8d2dca66bef169",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 125,
        "y": 420,
        "wires": [
            [
                "08b42314b1fa5216"
            ]
        ],
        "l": false
    },
    {
        "id": "08b42314b1fa5216",
        "type": "link out",
        "z": "cc5249a8fa23cd11",
        "g": "2a8d2dca66bef169",
        "name": "link out 3",
        "mode": "return",
        "links": [],
        "x": 175,
        "y": 420,
        "wires": []
    },
    {
        "id": "bdd75f533612acc4",
        "type": "link in",
        "z": "9e1c81935ce65263",
        "g": "79dbcc4a1b9c4af9",
        "name": "Dynamic",
        "links": [],
        "x": 100,
        "y": 160,
        "wires": [
            [
                "5bddd4194fa3ea0a"
            ]
        ],
        "l": true
    },
    {
        "id": "e9106562debed60b",
        "type": "comment",
        "z": "9e1c81935ce65263",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "419e78196a0f07b0",
        "type": "comment",
        "z": "9e1c81935ce65263",
        "g": "79dbcc4a1b9c4af9",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "47ef65741ce2581e",
        "type": "link out",
        "z": "9e1c81935ce65263",
        "g": "383fe26515bed160",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 975,
        "y": 180,
        "wires": []
    },
    {
        "id": "ee095bd0fb92f947",
        "type": "comment",
        "z": "9e1c81935ce65263",
        "g": "383fe26515bed160",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 1030,
        "y": 120,
        "wires": []
    },
    {
        "id": "5d3828fa878b96e1",
        "type": "api-render-template",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Cheapest",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{}",
        "resultsLocation": "dynamic.data_cheapest",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 460,
        "y": 640,
        "wires": [
            [
                "466378019e0dc875"
            ]
        ]
    },
    {
        "id": "51955447fce56b26",
        "type": "api-render-template",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Expensive",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "",
        "resultsLocation": "dynamic.data_expensive",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 470,
        "y": 700,
        "wires": [
            [
                "338acc73e19dc2ea"
            ]
        ]
    },
    {
        "id": "2e62f1c39e0b0dc3",
        "type": "debug",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Complete message",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 910,
        "y": 1200,
        "wires": []
    },
    {
        "id": "466378019e0dc875",
        "type": "json",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "",
        "property": "dynamic.data_cheapest",
        "action": "obj",
        "pretty": false,
        "x": 555,
        "y": 640,
        "wires": [
            [
                "d22893b87a6d7a9f"
            ]
        ],
        "l": false
    },
    {
        "id": "338acc73e19dc2ea",
        "type": "json",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "",
        "property": "dynamic.data_expensive",
        "action": "obj",
        "pretty": false,
        "x": 575,
        "y": 700,
        "wires": [
            [
                "dbc490b53cadf34d"
            ]
        ],
        "l": false
    },
    {
        "id": "bb83810278be291c",
        "type": "function",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Determine dynamic strategy",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// 1.   Input\n// Conversion\nconst CONVERSION_RATE = parseFloat(RED.util.getMessageProperty(msg, \"dynamic.value_conversion\")) || 1;\n\n// Extract start date objects\nlet start_cheapest = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.start\"));\nlet start_expensive = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_expensive.start\"));\nlet isCheapestNext = true;\n// stored price cheapest period\nlet lastCheapestPrice = context.last_cheapest_price || 0; // unit: cents/kWh\nconst nextCheapestPrice = parseInt(RED.util.getMessageProperty(msg, \"dynamic.data_cheapest.average\") / CONVERSION_RATE * 100); // unit: cents/kWh \n// average price expensive period\nconst lastExpensivePrice = parseInt(RED.util.getMessageProperty(msg, \"dynamic.data_expensive.average\") / CONVERSION_RATE * 100); // unit: cents/kWh\n// threshold rate for cheapest period\nconst cheapestThresholdCents = parseInt(RED.util.getMessageProperty(msg, \"dynamic.threshold_cheapest_cents\")) || 0; // unit: cents\n// threshold delta for expensive period\nconst deltaThresholdCents = parseInt(RED.util.getMessageProperty(msg, \"dynamic.min_delta_cents\")) || 0; // unit: cents\n\n// 1.1  Enums\nconst STRATEGY = {\n    CHEAPEST: RED.util.getMessageProperty(msg,\"dynamic.strategy_cheapest\") || \"Charge\", \n    NEUTRAL: RED.util.getMessageProperty(msg,\"dynamic.strategy_default\") || \"Charge PV\",\n    EXPENSIVE: RED.util.getMessageProperty(msg,\"dynamic.strategy_expensive\") || \"Self-consumption\"\n}\n\n// 1.2  Defaults   \nmsg.dynamic.avg_cheapest_tariff = 0;\nmsg.dynamic.avg_expensive_tariff = 0;\nmsg.dynamic.avg_delta = 0;\n\n// 2.   Tariffs\n// Check if the Date objects are valid. If 'Invalid Date', stop and warn the user.\nif (isNaN(start_cheapest.getTime()) || isNaN(start_expensive.getTime())) {\n    // warn user\n    log(this, `One or both dates are invalid. Cheap = ${start_cheapest}, Expensive = ${start_expensive}`,\"warn\");\n    node.status({fill:\"red\",shape:\"ring\",text:`One or both dates are invalid: ${start_cheapest}, ${start_expensive}`});\n    // fallback strategy\n    flow.set(\"dynamic_strategy\", STRATEGY.NEUTRAL);\n    // proceed to UI\n    return msg;\n}\n\n// Check if cheapest lies before expensive\nif (start_cheapest < start_expensive) {\n    log(this, `Cheapest moment lies before expensive moment. Cheapest moment: ${start_cheapest}, Expensive = ${start_expensive}`);\n    // store the cheapest price to compare it with future expensive rates, to determine if it's economical to discharge.\n    context.last_cheapest_price = nextCheapestPrice; // store for next iteration\n    lastCheapestPrice = nextCheapestPrice; // used for this iteration\n    log(this, `Cheapest price set to ${lastCheapestPrice} cents`);\n}\n\nif (lastCheapestPrice == 0) {\n    log(this, `I can't recall the tariff used for charging. Cheapest price set to '${lastCheapestPrice}' cents`);\n}\n\n// delta > N cents ? -> charging is economical\nconst delta = (lastExpensivePrice - lastCheapestPrice); // unit: cents\n\n// UI values\nmsg.dynamic.avg_cheapest_tariff = lastCheapestPrice;\nmsg.dynamic.avg_expensive_tariff = lastExpensivePrice;\nmsg.dynamic.avg_delta = delta;\n\n// 3.   Strategy selection logic\n// 3.1  is_now - which period have we entered?\n/** @type {boolean} */\nconst cheapestIsNow = RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.is_now\");\n/** @type {boolean} */\nconst expensiveIsNow = RED.util.getMessageProperty(msg, \"dynamic.data_expensive.is_now\");\n\n// 3.2  Set strategy\n// Default strategy\nmsg.dynamic.strategy = STRATEGY.NEUTRAL;\n\n// Cheapest period?\nif (cheapestIsNow && lastCheapestPrice <= cheapestThresholdCents) {\n    msg.dynamic.strategy = STRATEGY.CHEAPEST;\n    // Explain\n    log(this, `**Cheapest period is NOW**, price limit: ${lastCheapestPrice}/${cheapestThresholdCents} cents OK`);\n} else if(cheapestIsNow) {\n    // Explain why skipped\n    log(this, `**Cheapest period SKIPPED**, the cheapest period is too expensive today. Price limit: ${lastCheapestPrice}/${cheapestThresholdCents} cents.`);\n}\n\n// Expensive period?\nif (expensiveIsNow && delta >= deltaThresholdCents) {\n    msg.dynamic.strategy = STRATEGY.EXPENSIVE;\n    // Explain\n    log(this, `**Expensive period is NOW**, price delta: ${delta}>=${deltaThresholdCents} cents OK`);\n} else if(expensiveIsNow) {\n    // Explain why skipped\n    log(this, `**Expensive period SKIPPED**, price delta too small: ${lastExpensivePrice}-${lastCheapestPrice}=${delta} cents <= ${deltaThresholdCents} cents`); \n}\n\n// 3.3  Store the strategy in flow-context. The 'Execution' area will read from the flow-context.\nflow.set(\"dynamic_strategy\",msg.dynamic.strategy);\n\n// 4.   User feedback\n// Node status\nnode.status({ fill: \"blue\", shape: \"dot\", text: `${msg.dynamic.strategy}; ${cheapestIsNow} + ${expensiveIsNow} @ ${delta} cents` });\n// Explain\nlog(this, `Strategy set to **${msg.dynamic.strategy}**`);\n\n// Proceed to UI update\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 1120,
        "wires": [
            [
                "2e62f1c39e0b0dc3",
                "26e1ca0ee5ebfb07",
                "e30caddc9c684452",
                "850341b7536e1c16",
                "3e3a7eaade883823",
                "773f0f38687bf467",
                "bc1c0a99f91589a9",
                "92eeeb704aaa0bfc",
                "b5ecf03de5e4ca23"
            ]
        ]
    },
    {
        "id": "3a60df1ff16258a0",
        "type": "change",
        "z": "9e1c81935ce65263",
        "g": "a9848e780d8c4ef0",
        "name": "Set strategy",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "dynamic_strategy",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 200,
        "wires": [
            [
                "6f1b9f68188ef0ca"
            ]
        ]
    },
    {
        "id": "015db5b2657513e8",
        "type": "link call",
        "z": "9e1c81935ce65263",
        "g": "a9848e780d8c4ef0",
        "name": "Sub-strategy",
        "links": [],
        "linkType": "dynamic",
        "timeout": "3",
        "x": 810,
        "y": 180,
        "wires": [
            [
                "47ef65741ce2581e"
            ]
        ]
    },
    {
        "id": "26e1ca0ee5ebfb07",
        "type": "api-call-service",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Cheapest Start",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_cheapest_start"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.start).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 900,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "e30caddc9c684452",
        "type": "api-call-service",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Cheapest End",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_cheapest_end"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.end).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 900,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "850341b7536e1c16",
        "type": "api-call-service",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Expensive Start",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_expensive_start"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_expensive.start).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 900,
        "y": 1000,
        "wires": [
            []
        ]
    },
    {
        "id": "3e3a7eaade883823",
        "type": "api-call-service",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Expensive End",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_expensive_end"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_expensive.end).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 900,
        "y": 1040,
        "wires": [
            []
        ]
    },
    {
        "id": "8487165684201295",
        "type": "inject",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "Every 30 min",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "*/30 0-23 * * *",
        "once": false,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 380,
        "y": 420,
        "wires": [
            [
                "da3e171606c7dfca"
            ]
        ]
    },
    {
        "id": "e76c82f85ae2b87b",
        "type": "switch",
        "z": "9e1c81935ce65263",
        "g": "a9848e780d8c4ef0",
        "name": "Has strategy",
        "property": "dynamic_strategy",
        "propertyType": "flow",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 330,
        "y": 180,
        "wires": [
            [
                "2ffaa39de8291169"
            ],
            [
                "3a60df1ff16258a0"
            ]
        ]
    },
    {
        "id": "2ffaa39de8291169",
        "type": "change",
        "z": "9e1c81935ce65263",
        "g": "a9848e780d8c4ef0",
        "name": "Set Full stop",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Full stop",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 160,
        "wires": [
            [
                "6f1b9f68188ef0ca"
            ]
        ]
    },
    {
        "id": "e065c750c1b11eff",
        "type": "inject",
        "z": "9e1c81935ce65263",
        "g": "593e49b92606df01",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 1520,
        "wires": [
            [
                "32267b104f6c4335"
            ]
        ]
    },
    {
        "id": "32267b104f6c4335",
        "type": "api-render-template",
        "z": "9e1c81935ce65263",
        "g": "593e49b92606df01",
        "name": "Cheapest",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "cheapest",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 500,
        "y": 1520,
        "wires": [
            [
                "1678f13e48d213a4"
            ]
        ]
    },
    {
        "id": "1678f13e48d213a4",
        "type": "json",
        "z": "9e1c81935ce65263",
        "g": "593e49b92606df01",
        "name": "",
        "property": "cheapest",
        "action": "obj",
        "pretty": false,
        "x": 595,
        "y": 1520,
        "wires": [
            [
                "d5c9f4dd9d4ea7fb"
            ]
        ],
        "l": false
    },
    {
        "id": "d5c9f4dd9d4ea7fb",
        "type": "api-render-template",
        "z": "9e1c81935ce65263",
        "g": "593e49b92606df01",
        "name": "Expensive",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    lowest=false,\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "expensive",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 750,
        "y": 1520,
        "wires": [
            [
                "15b203b9329b1fcd"
            ]
        ]
    },
    {
        "id": "15b203b9329b1fcd",
        "type": "json",
        "z": "9e1c81935ce65263",
        "g": "593e49b92606df01",
        "name": "",
        "property": "expensive",
        "action": "obj",
        "pretty": false,
        "x": 855,
        "y": 1520,
        "wires": [
            [
                "2b92bba6029b9fa7",
                "dca7c14d01ff60f9",
                "5da7f77fcfaa9983"
            ]
        ],
        "l": false
    },
    {
        "id": "2b92bba6029b9fa7",
        "type": "debug",
        "z": "9e1c81935ce65263",
        "g": "593e49b92606df01",
        "name": "Cheap",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "cheapest.start",
        "targetType": "msg",
        "statusVal": "cheapest.start",
        "statusType": "auto",
        "x": 990,
        "y": 1560,
        "wires": []
    },
    {
        "id": "dca7c14d01ff60f9",
        "type": "debug",
        "z": "9e1c81935ce65263",
        "g": "593e49b92606df01",
        "name": "Expensive",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "expensive.start",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1010,
        "y": 1600,
        "wires": []
    },
    {
        "id": "8f42f0fb164b0203",
        "type": "api-render-template",
        "z": "9e1c81935ce65263",
        "g": "0186ef8f4e3ce1f2",
        "name": "All Zonneplan",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    include_tomorrow=true,\n    hours=\"all\",\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "all_data",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 480,
        "y": 1700,
        "wires": [
            [
                "a98fc515dd7eab9f"
            ]
        ]
    },
    {
        "id": "d1d1b0034a493a57",
        "type": "inject",
        "z": "9e1c81935ce65263",
        "g": "0186ef8f4e3ce1f2",
        "name": "Fetch",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 1700,
        "wires": [
            [
                "8f42f0fb164b0203"
            ]
        ]
    },
    {
        "id": "a98fc515dd7eab9f",
        "type": "json",
        "z": "9e1c81935ce65263",
        "g": "0186ef8f4e3ce1f2",
        "name": "",
        "property": "all_data",
        "action": "obj",
        "pretty": false,
        "x": 595,
        "y": 1700,
        "wires": [
            [
                "1c32650a68b2d5d4",
                "b010d66c1e7ad270"
            ]
        ],
        "l": false
    },
    {
        "id": "da3e171606c7dfca",
        "type": "delay",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 540,
        "y": 420,
        "wires": [
            [
                "af6a03d36d48a7d8"
            ]
        ]
    },
    {
        "id": "f5f7ea84129756bf",
        "type": "api-current-state",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "Source",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_data_source",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.data_source",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 860,
        "y": 380,
        "wires": [
            [
                "72292ab013bb214a"
            ]
        ]
    },
    {
        "id": "41eb25ca56c567a9",
        "type": "function",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Data source settings",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n/*    From cheapes-energy-hours macro\n      See: https://github.com/TheFes/cheapest-energy-hours/blob/main/documentation/1-source_data.md#data-provider-settings\n\n      - None (default selection)\n      - Zonneplan\n      - Amber Electric\n      - EasyEnergy, EnergyZero (core)\n      - ENTSO-E\n      - Frank Energie\n      - GE-Spot\n      - Tibber, Nordpool (core)\n      - Tibber (custom)\n      - Nordpool (custom)\n      - PVPC (Spain)\n      - Octopus Energy\n      - Omie\n*/\n\nswitch (msg.dynamic.data_source) {\n      case \"None\":\n            // Handle the 'None' case (e.g., no supplier selected or data is unavailable)\n            log(this,\"No data source selected.\");\n            // Add config here...\n            break;\n\n      case \"Zonneplan\":\n            // Code for Zonneplan (a Dutch energy supplier)\n            log(this,\"Processing Zonneplan data.\");\n            // Add config here...\n            msg.dynamic.sensor='sensor.zonneplan_current_electricity_tariff'; // when using: https://github.com/fsaris/home-assistant-zonneplan-one\n            msg.dynamic.attr_all='forecast';\n            msg.dynamic.value_key='electricity_price';\n            msg.dynamic.value_conversion = 10000000; // whole currency / kWh\n            break;\n\n      case \"Amber Electric\":\n            // Code for Amber Electric (Australian energy retailer)\n            log(this,\"Processing Amber Electric data.\");\n            // Add config here...\n            msg.dynamic.attr_all='forecasts'; \n            msg.dynamic.time_key='start_time'; \n            msg.dynamic.value_key='per_kwh';\n            break;\n\n      case \"EasyEnergy, EnergyZero (core)\":\n            // Code for EasyEnergy and EnergyZero (core/default implementation)\n            log(this,\"Processing EasyEnergy/EnergyZero core data.\");\n            // Add config here...\n            break;\n\n      case \"ENTSO-E\":\n            // Code for ENTSO-E (European Network of Transmission System Operators for Electricity)\n            log(this,\"Processing ENTSO-E data.\");\n            // Add config here...\n            msg.dynamic.attr_today='prices_today'; \n            msg.dynamic.attr_tomorrow='prices_tomorrow'; \n            msg.dynamic.time_key='time';\n            msg.dynamic.value_key='price';\n            break;\n\n      case \"Frank Energie\":\n            // Code for Frank Energie (Dutch energy supplier)\n            log(this,\"Processing Frank Energie data.\");\n            // Add config here...\n            msg.dynamic.attr_all = 'prices'; \n            msg.dynamic.time_key = 'from'; \n            msg.dynamic.value_key = 'price';\n            break;\n\n      case \"GE-Spot\":\n            // Code for GE-Spot (Global Electric Spot price)\n            log(this,\"Processing GE-Spot data.\");\n            // Add config here...\n            msg.dynamic.attr_today = 'today_hourly_prices'; // using the hourly version. today_interval_prices is per 15 mins\n            msg.dynamic.attr_tomorrow = 'tomorrow_hourly_prices'; // using the hourly version\n            msg.dynamic.time_key = 'time'; \n            msg.dynamic.value_key = 'value';\n            break;\n\n      case \"Tibber, Nordpool (core)\":\n            // Code for Tibber and Nordpool (core/default implementation)\n            log(this,\"Processing Tibber/Nordpool core data.\");\n            // Add config here...\n            msg.dynamic.sensor = 'sensor.tibber_ceh_prices';\n            msg.dynamic.attr_today = 'today';\n            msg.dynamic.attr_tomorrow = 'tomorrow';\n            msg.dynamic.time_key = 'start';\n            msg.dynamic.value_key = 'value';\n            msg.dynamic.datetime_in_data = true; // datetime is in the data\n            break;\n\n      case \"Tibber (custom)\":\n            // Code for a custom Tibber setup/configuration\n            log(this,\"Processing Tibber custom data.\");\n            // Add config here...\n            msg.dynamic.attr_today = 'today';\n            msg.dynamic.attr_tomorrow = 'tomorrow';\n            msg.dynamic.datetime_in_data = false;\n            break;\n\n      case \"Nordpool (custom)\":\n            // Code for a custom Nordpool setup/configuration\n            log(this,\"Processing Nordpool custom data.\");\n            // Add config here...\n            break;\n\n      case \"PVPC (Spain)\":\n            // Code for PVPC (Voluntary Price for Small Consumers in Spain)\n            log(this,\"Processing Spanish PVPC data.\");\n            // Add config here...\n            break;\n\n      case \"Octopus Energy\":\n            // Code for Octopus Energy (UK/international energy supplier)\n            log(this,\"Processing Octopus Energy data.\");\n            // Add config here...\n            msg.dynamic.attr_all = 'rates'; \n            msg.dynamic.value_key = 'value_incl_vat';\n            break;\n\n      case \"Omie\":\n            // Code for Omie (Iberian Energy Market Operator)\n            log(this,\"Processing Omie data.\");\n            // Add config here...\n            break;\n\n      default:\n            // Code to execute if the supplier does not match any of the above cases\n            node.warn(`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            log(this,`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            // Add default error handling...\n}\n\nlog(this, \"Performing API calls...\");\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 580,
        "wires": [
            [
                "270459fa3d61a502"
            ]
        ]
    },
    {
        "id": "5426188effacc641",
        "type": "api-current-state",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "Cheapest N hrs",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_cheapest_hrs",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.cheapest_hrs",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1100,
        "y": 380,
        "wires": [
            [
                "e8774b5ab323e662"
            ]
        ]
    },
    {
        "id": "e8774b5ab323e662",
        "type": "api-current-state",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "Expensive N hrs",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_expensive_hrs",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.expensive_hrs",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1100,
        "y": 420,
        "wires": [
            [
                "22e4fafaef966fd7"
            ]
        ]
    },
    {
        "id": "8c1f3458f7e87ef2",
        "type": "inject",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "On start",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 360,
        "y": 380,
        "wires": [
            [
                "e015763d0b952f57"
            ]
        ]
    },
    {
        "id": "eeee46277502b43e",
        "type": "function",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "Init",
        "func": "msg.dynamic = {};\nmsg.log = [];\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 380,
        "wires": [
            [
                "f5f7ea84129756bf"
            ]
        ]
    },
    {
        "id": "270459fa3d61a502",
        "type": "function",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Generate templates",
        "func": "// final template initialization\nmsg.dynamic.template_cheapest = \"\";\nmsg.dynamic.template_expensive = \"\";\n\n// temporary template parts\nlet template_start = \"\";\nlet template_common = [];\nlet template_cheapest = [];\nlet template_expensive = [];\nlet template_all = [];\nlet template_end = \"\";\n\n// 1. IMPROVEMENT: Use radix 10 and Logical OR (||) for cleaner default handling\nconst cheapest_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.cheapest_hrs\"), 10) || 1;\nconst expensive_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.expensive_hrs\"), 10) || 1;\n\n// load the macro\ntemplate_start = `{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n`;\ntemplate_end = `) | to_json }}`;\n\n// collect arguments | strings\nconst stringKeys = [\n    'sensor',\n    'attr_all',\n    'value_key',\n    'attr_today',\n    'attr_tomorrow',\n    'time_key'\n];\n\nstringKeys.forEach(key => {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}='${msg.dynamic[key]}'`);\n    }\n});\n\n// collect arguments | boolean, integer\nconst otherKeys = [\n    'datetime_in_data',\n    'data_minutes',\n];\n\notherKeys.forEach(key => {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}=${msg.dynamic[key]}`);\n    }\n});\n\n// copy common items\ntemplate_cheapest = [...template_common];\ntemplate_expensive = [...template_common];\ntemplate_all = [...template_common];\n\n// collect arguments | cheapest specific\ntemplate_cheapest.push(`hours=${cheapest_hrs}`);\n// template_cheapest.push(`include_tomorrow=true`);\ntemplate_cheapest.push(`mode=\"all\"`);\n\n// collect arguments | expensive specific\ntemplate_expensive.push(`hours=${expensive_hrs}`);\n// template_expensive.push(`include_tomorrow=true`);\ntemplate_expensive.push(`lowest=false`);\ntemplate_expensive.push(`mode=\"all\"`);\n\n// collect all hours | via extra call\ntemplate_all.push(`hours=\"all\"`);\ntemplate_all.push(`include_tomorrow=true`);\ntemplate_all.push(`mode=\"all\"`);\n\n/**\n * Formats an array of strings into a single string:\n * - Each item starts with 4 spaces.\n * - Each item ends with a comma, except the last one.\n * - Items are separated by a newline.\n */\nfunction formatTemplateArray(array) {\n    if (!array || array.length === 0) {\n        return \"\";\n    }\n\n    const indent = \"    \"; \n\n    const formatted_lines = array.map((element, index) => {\n        const suffix = (index < array.length - 1) ? \",\" : \"\";\n        return `${indent}${element}${suffix}`;\n    });\n\n    return formatted_lines.join('\\n');\n}\n\n// generate string templates\nconst template_cheapest_string = formatTemplateArray(template_cheapest);\nconst template_expensive_string = formatTemplateArray(template_expensive);\nconst template_all_string = formatTemplateArray(template_all);\n\n// done\nmsg.dynamic.template_cheapest = `${template_start}${template_cheapest_string}${template_end}`;\nmsg.dynamic.template_expensive = `${template_start}${template_expensive_string}${template_end}`;\nmsg.dynamic.template_all = `${template_start}${template_all_string}${template_end}`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 580,
        "wires": [
            [
                "bafd4b639ffb990d",
                "2f43baa24fb1b823",
                "50e84b8184986fb3",
                "402880758fdb1d96"
            ]
        ]
    },
    {
        "id": "bafd4b639ffb990d",
        "type": "debug",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Template cheapest",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_cheapest",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 850,
        "y": 600,
        "wires": []
    },
    {
        "id": "2f43baa24fb1b823",
        "type": "debug",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Template expensive",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_expensive",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 860,
        "y": 560,
        "wires": []
    },
    {
        "id": "50e84b8184986fb3",
        "type": "change",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_cheapest",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 640,
        "wires": [
            [
                "5d3828fa878b96e1"
            ]
        ]
    },
    {
        "id": "d22893b87a6d7a9f",
        "type": "change",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_expensive",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 700,
        "wires": [
            [
                "51955447fce56b26"
            ]
        ]
    },
    {
        "id": "ee9dd764e7851217",
        "type": "change",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Cleanup",
        "rules": [
            {
                "t": "delete",
                "p": "template",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 340,
        "y": 820,
        "wires": [
            [
                "c5a3235ad687da39"
            ]
        ]
    },
    {
        "id": "773f0f38687bf467",
        "type": "debug",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Log: activate 'debug mode' first",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "log",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 950,
        "y": 1240,
        "wires": []
    },
    {
        "id": "7cc3b4e072f332df",
        "type": "server-state-changed",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "User input",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.house_battery_strategy_dynamic_cheapest_hrs",
                "input_number.house_battery_strategy_dynamic_expensive_hrs",
                "input_select.house_battery_strategy_dynamic_data_source",
                "input_number.house_battery_strategy_dynamic_threshold_delta",
                "input_number.house_battery_strategy_dynamic_threshold_cheapest_period"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 360,
        "y": 340,
        "wires": [
            [
                "19c7d0e5ece3dd00"
            ]
        ]
    },
    {
        "id": "72292ab013bb214a",
        "type": "switch",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "Source selected?",
        "property": "dynamic.data_source",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "None",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 965,
        "y": 380,
        "wires": [
            [
                "0697d445416adfbc"
            ],
            [
                "5426188effacc641"
            ]
        ],
        "l": false
    },
    {
        "id": "a2a1aad07a41be35",
        "type": "debug",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "Not set",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1340,
        "y": 340,
        "wires": []
    },
    {
        "id": "bc1c0a99f91589a9",
        "type": "api-call-service",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Avg cheap tariff",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_cheapest_avg_tariff"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_cheapest_tariff }",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 900,
        "y": 1080,
        "wires": [
            []
        ]
    },
    {
        "id": "92eeeb704aaa0bfc",
        "type": "api-call-service",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Avg expensive tariff",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_expensive_avg_tariff"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_expensive_tariff}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 910,
        "y": 1120,
        "wires": [
            []
        ]
    },
    {
        "id": "b5ecf03de5e4ca23",
        "type": "api-call-service",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Avg delta",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_expensive_avg_delta"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_delta}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 880,
        "y": 1160,
        "wires": [
            []
        ]
    },
    {
        "id": "e65065ba7454c5a2",
        "type": "api-current-state",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Threshold delta",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_threshold_delta",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.min_delta_cents",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 360,
        "y": 1000,
        "wires": [
            [
                "170ff03203e89243"
            ]
        ]
    },
    {
        "id": "0697d445416adfbc",
        "type": "change",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "Set dynamic strategy to null",
        "rules": [
            {
                "t": "set",
                "p": "dynamic_strategy",
                "pt": "flow",
                "to": "null",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 340,
        "wires": [
            [
                "a2a1aad07a41be35"
            ]
        ]
    },
    {
        "id": "1c32650a68b2d5d4",
        "type": "debug",
        "z": "9e1c81935ce65263",
        "g": "0186ef8f4e3ce1f2",
        "name": "All data",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "all_data",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 1700,
        "wires": []
    },
    {
        "id": "5da7f77fcfaa9983",
        "type": "debug",
        "z": "9e1c81935ce65263",
        "g": "593e49b92606df01",
        "name": "Complete msg",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 1520,
        "wires": []
    },
    {
        "id": "5bddd4194fa3ea0a",
        "type": "change",
        "z": "9e1c81935ce65263",
        "g": "79dbcc4a1b9c4af9",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 90,
        "y": 200,
        "wires": [
            [
                "e76c82f85ae2b87b"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "6f1b9f68188ef0ca",
        "type": "function",
        "z": "9e1c81935ce65263",
        "g": "a9848e780d8c4ef0",
        "name": "Selected",
        "func": "// Logger\nconst log = global.get(\"logger\");\nlog(this,`${msg.target} strategy`);\n\n// Status\nnode.status({fill:\"green\",shape:\"dot\",text:`${msg.target}`});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 180,
        "wires": [
            [
                "015db5b2657513e8"
            ]
        ]
    },
    {
        "id": "c9e7d3f365c5790c",
        "type": "catch",
        "z": "9e1c81935ce65263",
        "g": "f3012bea4c1ffe74",
        "name": "",
        "scope": null,
        "uncaught": true,
        "x": 65,
        "y": 320,
        "wires": [
            [
                "c51489240cacdd2e"
            ]
        ],
        "l": false
    },
    {
        "id": "c51489240cacdd2e",
        "type": "function",
        "z": "9e1c81935ce65263",
        "g": "f3012bea4c1ffe74",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 115,
        "y": 320,
        "wires": [
            [
                "772bdf7f9b9bdebf"
            ]
        ],
        "l": false
    },
    {
        "id": "772bdf7f9b9bdebf",
        "type": "link out",
        "z": "9e1c81935ce65263",
        "g": "f3012bea4c1ffe74",
        "name": "link out 5",
        "mode": "return",
        "links": [],
        "x": 165,
        "y": 320,
        "wires": []
    },
    {
        "id": "2ff7656d60360ce2",
        "type": "api-current-state",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Threshold cheapest",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_threshold_cheapest_period",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.threshold_cheapest_cents",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 960,
        "wires": [
            [
                "e65065ba7454c5a2"
            ]
        ]
    },
    {
        "id": "170ff03203e89243",
        "type": "api-current-state",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Strategy default",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_default",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.strategy_default",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 360,
        "y": 1040,
        "wires": [
            [
                "882a3b79f37cc471"
            ]
        ]
    },
    {
        "id": "882a3b79f37cc471",
        "type": "api-current-state",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Strategy cheapest",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_cheapest",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.strategy_cheapest",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 1080,
        "wires": [
            [
                "8a7913f81b38a9e0"
            ]
        ]
    },
    {
        "id": "8a7913f81b38a9e0",
        "type": "api-current-state",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "Strategy expensive",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_expensive",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.strategy_expensive",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 1120,
        "wires": [
            [
                "bb83810278be291c"
            ]
        ]
    },
    {
        "id": "c5a3235ad687da39",
        "type": "function",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Cache data source",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\nconst dynamicData = msg.dynamic;\n\n// Helper to check for errors in the object\nconst isInvalid = (data) => {\n    if (!data) return true;\n    // Check if the stringified object contains \"error\"\n    return JSON.stringify(data).toLowerCase().includes(\"error\");\n};\n\nif (isInvalid(dynamicData)) {\n    // Explain issue\n    log(this, \"Invalid data received, clearing cache\", \"warn\");\n    // Clear cache\n    flow.set(\"cached_dynamic_data\", undefined);\n} else {\n    // Cache on success\n    log(this, \"Caching `msg.dynamic`\");\n    // Save the entire object to flow context\n    flow.set(\"cached_dynamic_data\", dynamicData);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 820,
        "wires": [
            [
                "634b05801baa4ea9"
            ]
        ]
    },
    {
        "id": "ea9edb27d790215c",
        "type": "catch",
        "z": "9e1c81935ce65263",
        "g": "319f4ec179fdee82",
        "name": "Catch group",
        "scope": "group",
        "uncaught": false,
        "x": 1090,
        "y": 560,
        "wires": [
            [
                "7135aa07a8789db2"
            ]
        ]
    },
    {
        "id": "4017e182f7409f83",
        "type": "debug",
        "z": "9e1c81935ce65263",
        "g": "319f4ec179fdee82",
        "name": "Strategy errors",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1320,
        "y": 560,
        "wires": []
    },
    {
        "id": "9ba0ab785578a956",
        "type": "comment",
        "z": "9e1c81935ce65263",
        "g": "319f4ec179fdee82",
        "name": "Cheapest Energy Hours - errors",
        "info": "\"No valid sensor found\" if price_data is none and not valid_sensor,\n\"No valid data in {}\".format(sensor) if price_data is none and data == [] and valid_sensor,\n\"No valid data in provided price_data\" if price_data is not none and not valid_price_data,\n\"Time key '{}' not found in data\".format(time_key) if data and time_key not in data[0],\n\"Value key '{}' not found in data\".format(value_key) if data and value_key not in data[0],\n\"Invalid mode '{}' selected\".format(mode) if mode not in modes,\n\"Boolean input expected for include_today, '{}' can not be processed as a boolean\".format(include_today) if include_today | bool(\"\") is not boolean,\n\"Boolean input expected for include_tomorrow, '{}' can not be processed as a boolean\".format(include_tomorrow) if include_tomorrow | bool(\"\") is not boolean,\n\"Boolean input expected for look_ahead, '{}' can not be processed as a boolean\".format(look_ahead) if look_ahead | bool(\"\") is not boolean,\n\"Boolean input expected for lowest, '{}' can not be processed as a boolean\".format(lowest) if lowest | bool(\"\") is not boolean,\n\"Boolean input expected for latest_possible, '{}' can not be processed as a boolean\".format(latest_possible) if latest_possible | bool(\"\") is not boolean,\n\"Numeric input or percentage expected for price_tolerance, '{}' can not be processed as a float or percentage\".format(price_tolerance) if not valid_pt,\n\"Numeric input expected for kwh, '{}' can not be processed as a float\".format(kwh) if kwh is not none and not kwh | is_number,\n\"Selected program '{}' is not available or has no data\".format(program) if program is not none and w is none,\n\"Selected start parameter is after the end parameter\" if start_end and data,\n\"{} hours between start and end, where {} hours are required\".format(end_start, h | round(3)) if not start_end and end_start < h | round(3) and data,\n\"Invalid combination of source data points per hour '{}' and number of weight points '{}'\".format(dp, dph) if all_keys and not wp_check",
        "x": 1150,
        "y": 520,
        "wires": []
    },
    {
        "id": "7135aa07a8789db2",
        "type": "function",
        "z": "9e1c81935ce65263",
        "g": "319f4ec179fdee82",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1195,
        "y": 560,
        "wires": [
            [
                "4017e182f7409f83"
            ]
        ],
        "l": false
    },
    {
        "id": "22e4fafaef966fd7",
        "type": "function",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "Cache check",
        "func": "// Check if cache can be used or a new call to Data Source is required\nconst log = global.get('logger');\n\n// Retrieve stored data from flow context\nconst previousValues = flow.get(\"previous_sensor_values\") || {};\nconst cachedData = flow.get(\"cached_dynamic_data\");\n\n// Create a string or object to represent current state\nconst currentValues = {\n    src: msg.dynamic.data_source,\n    hc: msg.dynamic.cheapest_hrs,\n    he: msg.dynamic.expensive_hrs\n};\n\n// Compare current with previous (JSON stringify is a quick way to compare objects)\nconst inputsMatch = JSON.stringify(currentValues) === JSON.stringify(previousValues);\n\n// Determine cache hit\nif (inputsMatch && cachedData){\n    // Cache HIT\n    node.status({ fill: \"green\", shape: \"dot\", text: `Cache hit` });\n    log(this,`*CACHE HIT* using stored tariff data`);\n\n    // Attach cached data to the message so following nodes can use it\n    msg.dynamic = cachedData;\n\n    // Output #1\n    return [msg, null];\n\n} else {\n    // Cache MISS\n    node.status({ fill: \"green\", shape: \"ring\", text: `Cache miss: ${JSON.stringify(currentValues) }` });\n\n    // Save current values for the next run\n    flow.set(\"previous_sensor_values\", currentValues);\n    \n    // Output #2\n    return [null, msg];\n}",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1270,
        "y": 420,
        "wires": [
            [
                "f385d2544b66ddee"
            ],
            [
                "ac8df319cfad78ad"
            ]
        ],
        "outputLabels": [
            "Cache HIT",
            "Cache MISS"
        ]
    },
    {
        "id": "f385d2544b66ddee",
        "type": "link out",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "from Cache Check ok",
        "mode": "link",
        "links": [
            "6cfa38c6f6cd36df"
        ],
        "x": 1375,
        "y": 400,
        "wires": []
    },
    {
        "id": "7d75e3c907d0efa5",
        "type": "link in",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "link Fetch from Data Source",
        "links": [
            "ac8df319cfad78ad"
        ],
        "x": 295,
        "y": 540,
        "wires": [
            [
                "41eb25ca56c567a9"
            ]
        ]
    },
    {
        "id": "ac8df319cfad78ad",
        "type": "link out",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "from Cache Check NoK",
        "mode": "link",
        "links": [
            "7d75e3c907d0efa5"
        ],
        "x": 1375,
        "y": 440,
        "wires": []
    },
    {
        "id": "6cfa38c6f6cd36df",
        "type": "link in",
        "z": "9e1c81935ce65263",
        "g": "a44935d902985d30",
        "name": "link Determine Strategy",
        "links": [
            "634b05801baa4ea9",
            "f385d2544b66ddee"
        ],
        "x": 295,
        "y": 920,
        "wires": [
            [
                "2ff7656d60360ce2"
            ]
        ]
    },
    {
        "id": "634b05801baa4ea9",
        "type": "link out",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "link out 12",
        "mode": "link",
        "links": [
            "6cfa38c6f6cd36df"
        ],
        "x": 635,
        "y": 820,
        "wires": []
    },
    {
        "id": "af6a03d36d48a7d8",
        "type": "function",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "Clear Cache",
        "func": "// Clear cache\nflow.set(\"cached_dynamic_data\", undefined);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 635,
        "y": 420,
        "wires": [
            [
                "eeee46277502b43e"
            ]
        ],
        "l": false
    },
    {
        "id": "b010d66c1e7ad270",
        "type": "ha-fire-event",
        "z": "9e1c81935ce65263",
        "g": "0186ef8f4e3ce1f2",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 0,
        "event": "update_energy_prices",
        "data": "msg.all_data",
        "dataType": "jsonata",
        "x": 760,
        "y": 1760,
        "wires": [
            []
        ]
    },
    {
        "id": "d93b799f1011283e",
        "type": "api-render-template",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "All",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "",
        "resultsLocation": "dynamic.data_all",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 450,
        "y": 760,
        "wires": [
            [
                "964043538db2a118"
            ]
        ]
    },
    {
        "id": "964043538db2a118",
        "type": "json",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "",
        "property": "dynamic.data_all",
        "action": "obj",
        "pretty": false,
        "x": 535,
        "y": 760,
        "wires": [
            [
                "ee9dd764e7851217",
                "53c7e13897bf1606"
            ]
        ],
        "l": false
    },
    {
        "id": "dbc490b53cadf34d",
        "type": "change",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_all",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 760,
        "wires": [
            [
                "d93b799f1011283e"
            ]
        ]
    },
    {
        "id": "2cff1346b63fe9f9",
        "type": "ha-fire-event",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Update energy prices",
        "server": "176d29a.6f648d6",
        "version": 0,
        "event": "update_energy_prices",
        "data": "msg.dynamic.data_all",
        "dataType": "jsonata",
        "x": 860,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "402880758fdb1d96",
        "type": "debug",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Template all",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_all",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 640,
        "wires": []
    },
    {
        "id": "53c7e13897bf1606",
        "type": "function",
        "z": "9e1c81935ce65263",
        "g": "4ca3e4168cb0a19f",
        "name": "Convert price",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Conversion\nconst CONVERSION_RATE = parseFloat(RED.util.getMessageProperty(msg, \"dynamic.value_conversion\")) || 1;\n\n// Check if the list exists and is an array to prevent errors\nif (msg.dynamic && msg.dynamic.data_all && Array.isArray(msg.dynamic.data_all.list)) {\n    \n    // Create a new array where each value is multiplied\n    if (Array.isArray(msg.dynamic.data_all?.list)) {\n        msg.dynamic.data_all.list = msg.dynamic.data_all.list.map(v => parseInt(v / CONVERSION_RATE * 100)); // cents\n    }\n\n    // Update other fields\n    if (msg.dynamic.data_all?.average) {\n        msg.dynamic.data_all.average = parseInt(msg.dynamic.data_all.average / CONVERSION_RATE * 100); // cents\n    }\n} else {\n    // Do not continue\n    log(this,\"*price data not updated* price data missing\");\n    return null;\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 760,
        "wires": [
            [
                "2cff1346b63fe9f9"
            ]
        ]
    },
    {
        "id": "e015763d0b952f57",
        "type": "function",
        "z": "9e1c81935ce65263",
        "g": "154236b91b5e54b5",
        "name": "Clear Cache",
        "func": "// Clear cache\nflow.set(\"cached_dynamic_data\", undefined);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 625,
        "y": 380,
        "wires": [
            [
                "eeee46277502b43e"
            ]
        ],
        "l": false
    },
    {
        "id": "7cd4cd9678222aa0",
        "type": "link in",
        "z": "bac1b8ceb7669f2b",
        "g": "3d5f7dda0f7eacb7",
        "name": "Full stop",
        "links": [],
        "x": 100,
        "y": 160,
        "wires": [
            [
                "f1437fb7f3ae8d3a"
            ]
        ],
        "l": true
    },
    {
        "id": "8ea4184555230145",
        "type": "link out",
        "z": "bac1b8ceb7669f2b",
        "g": "a5ab43d65db72c3a",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 505,
        "y": 180,
        "wires": []
    },
    {
        "id": "1f036a25c75ee78a",
        "type": "function",
        "z": "bac1b8ceb7669f2b",
        "name": "Stop all batteries",
        "func": "// Logger\nconst log = global.get(\"logger\");\nlog(this,`full stop`);\n\n// Process\nlet solution_array = [];\n\n// Add a solution per battery\nmsg.batteries.forEach(battery => {\n    solution_array.push({ id: battery.id, \n    mode: \"stop\", // disengages Marstek Battery\n    power: 0 }); // set power to 0W\n});\n\n// OUTPUT\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "8ea4184555230145"
            ]
        ]
    },
    {
        "id": "093ecea682cbadf9",
        "type": "comment",
        "z": "bac1b8ceb7669f2b",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "1a213fd11b4d2531",
        "type": "comment",
        "z": "bac1b8ceb7669f2b",
        "g": "a5ab43d65db72c3a",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 560,
        "y": 120,
        "wires": []
    },
    {
        "id": "84d4995a9ca56bf0",
        "type": "comment",
        "z": "bac1b8ceb7669f2b",
        "g": "3d5f7dda0f7eacb7",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "f1437fb7f3ae8d3a",
        "type": "change",
        "z": "bac1b8ceb7669f2b",
        "g": "3d5f7dda0f7eacb7",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 200,
        "wires": [
            [
                "1f036a25c75ee78a"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "d1e46476752bf753",
        "type": "catch",
        "z": "bac1b8ceb7669f2b",
        "g": "d4c19153d1348adf",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 55,
        "y": 300,
        "wires": [
            [
                "44883d8970eb03e3"
            ]
        ],
        "l": false
    },
    {
        "id": "44883d8970eb03e3",
        "type": "function",
        "z": "bac1b8ceb7669f2b",
        "g": "d4c19153d1348adf",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 105,
        "y": 300,
        "wires": [
            [
                "1def5e898b617f7f"
            ]
        ],
        "l": false
    },
    {
        "id": "1def5e898b617f7f",
        "type": "link out",
        "z": "bac1b8ceb7669f2b",
        "g": "d4c19153d1348adf",
        "name": "link out 6",
        "mode": "return",
        "links": [],
        "x": 155,
        "y": 300,
        "wires": []
    },
    {
        "id": "a38eba9cfa02e6c4",
        "type": "link in",
        "z": "5514ca6b1b2fc795",
        "g": "c1886c0e0af92e56",
        "name": "Self-consumption",
        "links": [],
        "x": 160,
        "y": 160,
        "wires": [
            [
                "5f7032fee27f69c3"
            ]
        ],
        "l": true
    },
    {
        "id": "b1e7ccd4b64c07a1",
        "type": "comment",
        "z": "5514ca6b1b2fc795",
        "g": "c1886c0e0af92e56",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the Link In in this start group exactly after the option configured in your\nselect_input.house_battery_strategy\n\nfound in the file:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nWill point to the flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 150,
        "y": 120,
        "wires": []
    },
    {
        "id": "bf6cd163dd72fd15",
        "type": "comment",
        "z": "5514ca6b1b2fc795",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "85438831b3541f6e",
        "type": "server-state-changed",
        "z": "5514ca6b1b2fc795",
        "g": "562414d896e9cb7f",
        "name": "User Ki change",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.house_battery_control_ki"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 100,
        "wires": [
            [
                "92b18321e428bb57"
            ]
        ]
    },
    {
        "id": "92b18321e428bb57",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "562414d896e9cb7f",
        "name": "Integral term adjust",
        "func": "// On change of Ki setting\nlet logdata = \"bumpless \";\nlet I_sum = flow.get(\"I_integral_sum\");\nlet Ki = msg.payload || 0;     // Integral gain\nlet Ki_last = context.get(\"house_battery_control_ki_last\")||0;\n\n// if Ki was or has become zero\nif(Ki == 0 || Ki_last == 0){\n    // passify the integral-sum\n    flow.set(\"I_integral_sum\",0);\n    context.set(\"house_battery_control_ki_last\", Ki);\n    logdata += `to/from 0, Ki=${Ki_last} -> ${Ki} | `;\n    // done\n    return { payload: logdata };\n}\n\n// change in Ki\nlet dKi = parseFloat(Ki/Ki_last);\nif(dKi <= 0) dKi = 1; // ignore erroneous changes\n\n// keep I-term constant by compensating the integral-sum for the change in Ki\n// e.g. if Ki got 10% smaller, then integral-sum should increase 10%, to keep the I-term constant\nlet I_sum_new = I_sum / dKi;\nlogdata += `change of I: from ${Ki_last} to ${Ki} (${dKi * 100}%) | `;\n\n// OUTFLOW\nflow.set(\"I_integral_sum\", I_sum_new);\ncontext.set(\"house_battery_control_ki_last\", Ki);\n\n// OUTPUT\nreturn { payload: logdata };",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\n// init last state\nlet Ki = flow.get(\"house_battery_control_ki\") || 0;\ncontext.set(\"house_battery_control_ki_last\", Ki);",
        "finalize": "",
        "libs": [],
        "x": 1730,
        "y": 160,
        "wires": [
            [
                "6ddd9cdf4c69c721"
            ]
        ]
    },
    {
        "id": "2243dccdd919c7b6",
        "type": "comment",
        "z": "5514ca6b1b2fc795",
        "g": "562414d896e9cb7f",
        "name": "Bumpless Ki changes",
        "info": "Recalc I-term whenever Ki changes\n\nNote: always be mindful of making changes to control parameters of systems in operation.",
        "x": 1740,
        "y": 60,
        "wires": []
    },
    {
        "id": "6ddd9cdf4c69c721",
        "type": "debug",
        "z": "5514ca6b1b2fc795",
        "g": "562414d896e9cb7f",
        "name": "Logdata",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1700,
        "y": 220,
        "wires": []
    },
    {
        "id": "568c58e7de65cb07",
        "type": "switch",
        "z": "5514ca6b1b2fc795",
        "g": "5f82a83792ef2689",
        "name": "Check for custom/auto mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Manual control",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Marstek control",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1855,
        "y": 520,
        "wires": [
            [
                "b752c80f6054fee8",
                "2d0ccb826e66cf7e"
            ],
            [
                "b752c80f6054fee8",
                "2d0ccb826e66cf7e"
            ],
            [
                "2d0ccb826e66cf7e"
            ]
        ],
        "l": false
    },
    {
        "id": "2d0ccb826e66cf7e",
        "type": "debug",
        "z": "5514ca6b1b2fc795",
        "g": "5f82a83792ef2689",
        "name": "Master control switch",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2060,
        "y": 520,
        "wires": []
    },
    {
        "id": "37b91d2b1e277236",
        "type": "server-state-changed",
        "z": "5514ca6b1b2fc795",
        "g": "5f82a83792ef2689",
        "name": "Master control mode",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1730,
        "y": 520,
        "wires": [
            [
                "568c58e7de65cb07"
            ]
        ]
    },
    {
        "id": "17f89a47358628fe",
        "type": "api-call-service",
        "z": "5514ca6b1b2fc795",
        "g": "5f82a83792ef2689",
        "name": "Integral PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_i_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2050,
        "y": 360,
        "wires": [
            [
                "cf9c7cd28e9d02fc"
            ]
        ]
    },
    {
        "id": "cf9c7cd28e9d02fc",
        "type": "api-call-service",
        "z": "5514ca6b1b2fc795",
        "g": "5f82a83792ef2689",
        "name": "Differential PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_d_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2060,
        "y": 400,
        "wires": [
            [
                "b1bc49b9a790bd10"
            ]
        ]
    },
    {
        "id": "b752c80f6054fee8",
        "type": "api-call-service",
        "z": "5514ca6b1b2fc795",
        "g": "5f82a83792ef2689",
        "name": "Proportinal PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_p_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2060,
        "y": 320,
        "wires": [
            [
                "17f89a47358628fe"
            ]
        ]
    },
    {
        "id": "b1bc49b9a790bd10",
        "type": "api-call-service",
        "z": "5514ca6b1b2fc795",
        "g": "5f82a83792ef2689",
        "name": "PID Output to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2050,
        "y": 440,
        "wires": [
            [
                "f13192d3ff06d752"
            ]
        ]
    },
    {
        "id": "f13192d3ff06d752",
        "type": "change",
        "z": "5514ca6b1b2fc795",
        "g": "5f82a83792ef2689",
        "name": "Integral sum to zero",
        "rules": [
            {
                "t": "set",
                "p": "I_integral_sum",
                "pt": "flow",
                "to": "0",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2060,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "65ba171e4be3708f",
        "type": "api-current-state",
        "z": "5514ca6b1b2fc795",
        "g": "4a6afeecba388786",
        "name": "Target grid consumption",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_target_grid_consumption_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_target_grid_consumption_in_w",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 120,
        "wires": [
            [
                "90245d89be9bc125"
            ]
        ],
        "info": "Set at 0 to strive for zero consumption"
    },
    {
        "id": "43da5f9faff9c6f4",
        "type": "api-current-state",
        "z": "5514ca6b1b2fc795",
        "g": "8f3e0afa5fbb2ebc",
        "name": "Hysteresis",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_hysteresis_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_hysteresis_in_w",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1010,
        "y": 120,
        "wires": [
            [
                "25a37940f6a5f2b4"
            ]
        ]
    },
    {
        "id": "86377ee093805b8b",
        "type": "api-current-state",
        "z": "5514ca6b1b2fc795",
        "g": "4a6afeecba388786",
        "name": "PID P-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_kp",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_kp",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 410,
        "y": 180,
        "wires": [
            [
                "919bccdcfdc61eb1"
            ]
        ]
    },
    {
        "id": "919bccdcfdc61eb1",
        "type": "api-current-state",
        "z": "5514ca6b1b2fc795",
        "g": "4a6afeecba388786",
        "name": "PID I-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_ki",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_ki",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 590,
        "y": 180,
        "wires": [
            [
                "cebbd3981242235f"
            ]
        ]
    },
    {
        "id": "cebbd3981242235f",
        "type": "api-current-state",
        "z": "5514ca6b1b2fc795",
        "g": "4a6afeecba388786",
        "name": "PID D-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_kd",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_kd",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 770,
        "y": 180,
        "wires": [
            [
                "c757848ddf8b492d"
            ]
        ]
    },
    {
        "id": "25a37940f6a5f2b4",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "8f3e0afa5fbb2ebc",
        "name": "Advanced settings",
        "func": "// 1. Hard coded advanced settings (flow level)\nflow.set(\"has_soc_charging_limiter\", true);         // slows charging from 90% to 100% to improve battery life\nflow.set(\"has_reverse_priority_discharge\", true);   // Prioritize discharging and charging the same battery when possible\nflow.set(\"master_gain\", 1);                         // Gain scheduling. Not Implemented!\n\n// 2. Configurable advanced settings (msg level)\nmsg.advanced_settings ||= {}; // creates 'advanced_settings' if it does net yet exist\nlet mas = msg.advanced_settings;\n\n// disable charge or dicharge solutions and changes them to stop solutions\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\", mas.discharge_disabled ?? false);\nRED.util.setMessageProperty(msg,\"advanced_settings.charge_disabled\", mas.charge_disabled ?? false);\n// The nullish coalescing (??) operator is a logical operator that returns its right-hand side operand when its left-hand side operand is null or undefined\n\n// 3. continue\nreturn msg;\n\n// Notes for home battery tinkerer friends:\n// Using RED.util.getMessageProperty / RED.util.setMessageProperty is more performant and safe.\n// If any part of the path (\"foo.bar\") is missing, it will return 'undefined' without throwing an error.",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1030,
        "y": 180,
        "wires": [
            [
                "de3606d8ce7f0d19"
            ]
        ]
    },
    {
        "id": "c757848ddf8b492d",
        "type": "api-current-state",
        "z": "5514ca6b1b2fc795",
        "g": "8f3e0afa5fbb2ebc",
        "name": "Idle time before Stop",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_idle_time",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "idle_time_minutes",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1040,
        "y": 80,
        "wires": [
            [
                "43da5f9faff9c6f4"
            ]
        ]
    },
    {
        "id": "f5044124f062433e",
        "type": "comment",
        "z": "5514ca6b1b2fc795",
        "g": "5c334db378550ed4",
        "name": "Setpoint ramping / damping",
        "info": "",
        "x": 460,
        "y": 460,
        "wires": []
    },
    {
        "id": "de3606d8ce7f0d19",
        "type": "api-current-state",
        "z": "5514ca6b1b2fc795",
        "g": "5c334db378550ed4",
        "name": "Error signal dampening",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_error_signal_dampening",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_error_signal_dampening",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 340,
        "wires": [
            [
                "eac58bac5c19c034"
            ]
        ]
    },
    {
        "id": "eac58bac5c19c034",
        "type": "api-current-state",
        "z": "5514ca6b1b2fc795",
        "g": "5c334db378550ed4",
        "name": "Output signal dampening",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_pid_output_dampening",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_pid_output_dampening",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 380,
        "wires": [
            [
                "d5a01506e48e0708"
            ]
        ]
    },
    {
        "id": "d5a01506e48e0708",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "5c334db378550ed4",
        "name": "Set: Error signal",
        "func": "// INPUTS\nlet P1_error_last = Number(context.get(\"p1_error_last\"))||0; // last error signal level in W\nlet dampening = Number(flow.get(\"house_battery_control_error_signal_dampening\")) || 0; // 0% - 100%\ndampening = dampening / 100; // to Number\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = Number(RED.util.getMessageProperty(msg,\"house_target_grid_consumption_in_w\")); // SP: target value\n\n// Calc error signal\nlet P1_error_unfiltered = P1_setpoint - P1_power;\n\n// Simple averaging filter\nlet P1_error_filtered = (1 - dampening) * P1_error_unfiltered + (dampening) * P1_error_last;\n\n// OUTFLOW\ncontext.set(\"p1_error_last\", P1_error_filtered);\n\n// OUTPUT\nmsg.grid_error = P1_error_filtered; // W (watt), error signal = SP - PV\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 420,
        "wires": [
            [
                "8d59fd82691e5eb2"
            ]
        ]
    },
    {
        "id": "8c8c444b26e62cd5",
        "type": "comment",
        "z": "5514ca6b1b2fc795",
        "g": "e11606db86887af8",
        "name": "Bumpless target grid consumption",
        "info": "The error value is used by default to calculate the derivative.\nWhen the target grid consumption (tgc) is changed, the system is takes the derivative of the process variable instead.\nThis prevents irratic behavior during sudden changes of the error or setpoint value.\n\ne.g. you change the setpoint from 0 to 100W \nThe error would make an instantanious jump and cause a huge derivative-term.\nThe pv stays continous and fluent.\n\nAfter 1 control tick the derivative is taken from error again.\nUntil the `tgc` is changed again.",
        "x": 780,
        "y": 440,
        "wires": []
    },
    {
        "id": "fad87cd701ba7a2f",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "e11606db86887af8",
        "name": "Derivative PV",
        "func": "var P1_power = msg.grid_power||0;\nvar P1_last_power = Number(context.get(\"p1_last_power\")) ||0;\n\n// PV derivative\nvar p1_derivative = P1_power - P1_last_power; // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_power\", P1_power);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 500,
        "wires": [
            [
                "49e2cc546740a3a7"
            ]
        ]
    },
    {
        "id": "4a2712bd3bd8750a",
        "type": "switch",
        "z": "5514ca6b1b2fc795",
        "g": "e11606db86887af8",
        "name": "Target grid consumption unchanged",
        "property": "house_target_grid_consumption_in_w",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "",
                "vt": "prev"
            },
            {
                "t": "neq",
                "v": "",
                "vt": "prev"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 780,
        "y": 480,
        "wires": [
            [
                "b0e1bc7fdc67a814"
            ],
            [
                "fad87cd701ba7a2f"
            ]
        ]
    },
    {
        "id": "b0e1bc7fdc67a814",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "e11606db86887af8",
        "name": "Derivative Error",
        "func": "var P1_error = msg.grid_error||0;\nvar P1_last_error = Number(context.get(\"p1_last_error\")) ||0;\n\n// Error derivative\n// note: error = -PV\n// note: for simplicity we assume 1 second time steps\nlet p1_derivative = -(P1_error - P1_last_error); // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_error\", P1_error);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 460,
        "wires": [
            [
                "49e2cc546740a3a7"
            ]
        ]
    },
    {
        "id": "49e2cc546740a3a7",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "e11606db86887af8",
        "name": "Derivative final value",
        "func": "\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1240,
        "y": 480,
        "wires": [
            [
                "d1e36bfcdc94f9bd"
            ]
        ]
    },
    {
        "id": "8d59fd82691e5eb2",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "64685d1b1184fd0b",
        "name": "Deadband (15W)",
        "func": "// Deadband\n// Stop processing if error is within .. Watt of target grid consumption.\n// This to reduce CPU loads \n\n// Logger\nconst log = global.get(\"logger\");\n\n// P1\nlet P1_error = msg.grid_error; // Watt\nlet P1_deadband = 15; // Watt\n\n// TODO\n// based on last 'assignable power' and current error, if (error > assignable power) the system will never enter the deadband. And keep calculating each interation.\n// however since we don't know if the is the assignable power will change, until we calculate the Control Value / load balancer\n// we could end up in a deadlock if we simply stop execution here, based on assignable power alone.\n\n// Within Deadband\nif(Math.abs(P1_error) < P1_deadband) {\n    // stop processing\n    node.status({fill:\"yellow\",shape:\"dot\",text:`Halt, ${Math.round(Math.abs(P1_error))} W`});\n    log(this, `**Stopped processing** power saving, ${Math.round(Math.abs(P1_error))} W is within deadband of ${P1_deadband} W`);\n    msg.payload = 'halted by deadband';\n    return msg;\n} \n\n// Outside deadband\nnode.status({fill:\"green\",shape:\"dot\",text:`Pass, ${Math.round(Math.abs(P1_error))} W`});\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 340,
        "wires": [
            [
                "3a4947f122506bc9"
            ]
        ]
    },
    {
        "id": "d1e36bfcdc94f9bd",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "Calculate corrections",
        "func": "// Logger\nvar logdata = \"\"; // deprecated\nconst log = global.get(\"logger\");\n\n// Timing\nlet time_last = context.get('time_last') || Date.now(); // Milliseconds\nlet time_current = Date.now(); // Milliseconds\nlet time_delta = (time_current - time_last) / 1000; // Convert to seconds\n// note: due to inherent 1 sec intervals of P1 meter we omit dt terms. This is mostly for bug checking and optimizations.\n\n// Batteries\nvar B_power = msg.batteries_total_power; // charging is positive, discharging negative\nvar anti_windup_threshold = Number(flow.get(\"batteries_total_assignable_power\")) || 0; // max available charge/discharge power.\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = flow.get(\"house_target_grid_consumption_in_w\"); // SP: target value\nvar P1_error = msg.grid_error;  // W (watt), error signal = SP - PV\nvar P1_derivative = msg.grid_derivative; // Derivative of PV, not the error\n\n// PID values\nvar Kp = flow.get(\"house_battery_control_kp\") || 0.75;  // Proportional gain\nvar Ki = flow.get(\"house_battery_control_ki\") || 0;     // Integral gain        Ki = Kp/Ti\nvar Kd = flow.get(\"house_battery_control_kd\") || 0;     // Derivative gain      Kd = Kp*Td\n\n// helpers\nvar I_integral_sum = context.get('I_integral_sum') || 0;\nvar Gm = flow.get(\"master_gain\")||1; // gain scheduling\n\n// optimizations\nvar hysteresis = flow.get(\"house_battery_control_hysteresis_in_w\"); // W (watt)\n\n// advanced settings\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\");\nconst isChargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.charge_disabled\");\n\n// -- PID regulator --\n// Proportional term\nlet p_term = Gm * Kp * P1_error;\n\n// Integral term\nlet integral_max = 0;\nif (Ki > 0) {\n    // Integral term | integrate\n    I_integral_sum += P1_error; \n    // Integral term | apply anti-windup\n    integral_max = anti_windup_threshold / Ki; // the anti-windup value is set to the current controlable range of the batteries, given by the previous load balancer calculations\n    I_integral_sum = Math.min(Math.max(I_integral_sum, -integral_max), integral_max);\n} else {\n    // If Ki is 0, keep everything 0\n    I_integral_sum = 0;\n    integral_max = 0;\n}\n\n// Integral term | the term\nlet i_term = Ki * I_integral_sum;\n\n// Integral term | explain\nlogdata += `anti_windup_threshold=${anti_windup_threshold}, integral_max=${integral_max}| `; // deprecated\n\n// Differential term\nlet d_term = Gm * Kd * (-P1_derivative); // omitted '/time_delta'. inherent P1 refresh fequency.\n\n// Total PID output\nvar PID_output = p_term + i_term + d_term; // W (watt), the control input for the battery packs\n\n// Charging or Discharging states\nvar B_was_charging = context.get(\"batteries_charging_last\") || false;\nvar B_is_charging = PID_output > 0 ? true : false;\n\n// Explain\nlogdata += `U(${time_delta}s)[${PID_output}] = P(${Kp})[${p_term}] + I(${Ki})[${i_term}] + D(${Kd})[${d_term}] | `; // deprecated\nlog(this,`**PID Controller**`);\nlog(this,`Step size: ${time_delta} s`);\nif(Kp == 0 && Ki == 0 && Kd == 0) {\n    log(this, `<font color=\"orange\">**Controller disabled**</font> All PID gains are 0. Choose a PID preset or set gains > 0.`,\"warn\");\n} else {\n    log(this, `P-term: ${Math.floor(p_term)} W @ P-gain ${Kp}`);\n    log(this, `I-term: ${Math.floor(i_term)} W @ I-gain ${Ki} (max. ${anti_windup_threshold} W)`);\n    log(this, `D-term: ${Math.floor(d_term)} W @ D-gain ${Kd}`);\n    log(this, `**PID ${B_is_charging ? 'Charge' : 'Discharge'}:** ${Math.floor(p_term)} + ${Math.floor(i_term)} + ${Math.floor(d_term)} = **${Math.round(PID_output)} Watt**`);\n}\n\n// Only one of the advanced settings below can be active at once.\n// Advanced setting | discharge disabled\nif(isDischargeDisabled && !B_is_charging) {\n    // log explain\n    logdata += `Discharging disabled, PID unwound U(${time_delta})[0]=0+0+0 | `;\n    log(this,'**PID set to 0**. Discharge was disabled via `msg.advanced_settings`.');\n    // Set all PID terms to 0 and unwind integral sum\n    PID_output = 0;\n    p_term = 0;\n    i_term = 0;\n    d_term = 0;\n    I_integral_sum = 0; // unwind\n    // maintain charge scenario\n    B_is_charging = true;\n    \n// Advanced setting | charge disabled\n} else if (isChargeDisabled && B_is_charging) {\n    // log explain\n    logdata += `Charging disabled, PID unwound U(${time_delta})[0]=0+0+0 | `;\n    log(this,'**PID set to 0**. Charge was disabled via `msg.advanced_settings`.');\n    // Set all PID terms to 0 and unwind integral sum\n    PID_output = 0;\n    p_term = 0;\n    i_term = 0;\n    d_term = 0;\n    I_integral_sum = 0; // unwind\n    // maintain discharge scenario\n    B_is_charging = false;\n\n// Advanced setting | hysteresis\n} else if \n// prevents excessive switching between (dis)charge mode around the zero point.\n// if new PID_output lies within hysteresis, it will not switch charge mode. \n// set hysteresis to 0, to apply no hysteresis\n(B_is_charging !== B_was_charging && Math.abs(PID_output) < hysteresis){\n    // log explain\n    logdata += `Hysteresis prevented charge mode switch from ${B_was_charging ? \"charging\" : \"discharging\"} to ${B_is_charging ? \"charging\" : \"discharging\"} as ${Math.abs(PID_output)}W <= ${hysteresis}(hyst) | `;\n    log(this,`Hysteresis prevented charge mode switch from ${B_was_charging ? \"charging\" : \"discharging\"} to ${B_is_charging ? \"charging\" : \"discharging\"} as ${Math.abs(PID_output)}W <= ${hysteresis}(hyst)`);\n    // prevent negative charging or positive discharging values (not allowed)\n    PID_output = (PID_output < 0 && B_is_charging) || ((PID_output > 0 && !B_is_charging)) ? 0 : PID_output;\n    // maintain previous scenario\n    B_is_charging = B_was_charging;\n} \n\n// save for next iteration\ncontext.set(\"batteries_charging_last\", B_is_charging); //boolean\n\n// OUTFLOW\ncontext.set(\"time_last\", Date.now());\ncontext.set(\"I_integral_sum\", I_integral_sum);\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_charging\", B_is_charging, true);\nRED.util.setMessageProperty(msg, \"I_integral_sum\", I_integral_sum,true);\nmsg.payload = Number(PID_output);\n\n\nreturn [msg, // payload = PID_output\n        { payload: Number(P1_error)},\n        { payload: parseFloat(p_term)},\n        { payload: parseFloat(i_term)},\n        { payload: parseFloat(d_term)},\n        { payload: B_is_charging},\n        { payload: logdata }];",
        "outputs": 7,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 700,
        "wires": [
            [
                "8ef262f6fb299ec2"
            ],
            [
                "11439c6c9c122ee3"
            ],
            [
                "b7b8dd92a2effab8"
            ],
            [
                "b45be92a4961f5ee"
            ],
            [
                "6316220a57018f7e"
            ],
            [
                "0bd03eb81e5cabed"
            ],
            [
                "ecc25b36c43ee975"
            ]
        ],
        "inputLabels": [
            "battery_array"
        ]
    },
    {
        "id": "ecc25b36c43ee975",
        "type": "debug",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "Logdata",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 1060,
        "wires": []
    },
    {
        "id": "11439c6c9c122ee3",
        "type": "api-call-service",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "Error Signal",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_signal"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 730,
        "y": 760,
        "wires": [
            [
                "1668a997ec2db7e3"
            ]
        ]
    },
    {
        "id": "0213ae880bfbc428",
        "type": "api-call-service",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "PID Output",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 730,
        "y": 700,
        "wires": [
            [
                "4c49075aa0a2c60b"
            ]
        ]
    },
    {
        "id": "c547c0ee749203ad",
        "type": "api-call-service",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "Proportinal term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_p_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 920,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "01c44459de13dcb9",
        "type": "api-call-service",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "Integral term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_i_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 910,
        "y": 880,
        "wires": [
            []
        ]
    },
    {
        "id": "4e4df8614dc4d03c",
        "type": "api-call-service",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "Differential term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_d_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 920,
        "y": 940,
        "wires": [
            []
        ]
    },
    {
        "id": "7e773be39a93951c",
        "type": "debug",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "Charging",
        "active": false,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 900,
        "y": 1060,
        "wires": []
    },
    {
        "id": "4c49075aa0a2c60b",
        "type": "smooth",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "",
        "property": "payload",
        "action": "sd",
        "count": "8",
        "round": "",
        "mult": "single",
        "reduce": false,
        "x": 900,
        "y": 700,
        "wires": [
            [
                "4990023fa30c8b0e"
            ]
        ]
    },
    {
        "id": "4990023fa30c8b0e",
        "type": "api-call-service",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "PID deviation",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output_deviation"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1070,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "1668a997ec2db7e3",
        "type": "smooth",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "",
        "property": "payload",
        "action": "sd",
        "count": "8",
        "round": "",
        "mult": "single",
        "reduce": false,
        "x": 900,
        "y": 760,
        "wires": [
            [
                "38dd1dd20354303b"
            ]
        ]
    },
    {
        "id": "38dd1dd20354303b",
        "type": "api-call-service",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "Error deviation",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_deviation"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1080,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "8ef262f6fb299ec2",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "Output dampening",
        "func": "// INPUT\nlet PID_unfiltered = msg.payload; // W Watt\nlet PID_last = context.get(\"PID_last\")||0; // W watt\nlet PID_damp = Number(flow.get(\"house_battery_control_pid_output_dampening\"))||0; // 0% - 100%\nPID_damp = PID_damp/100; // to Number\n\n// simple averaging filter\nlet PID_filtered = (1-PID_damp)*PID_unfiltered + (PID_damp)*PID_last;\n\n// OUTFLOW\ncontext.set(\"PID_last\", PID_filtered);\n\n// OUTPUT\nmsg.payload = Number(PID_filtered)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 660,
        "wires": [
            [
                "472acfc03b69788a"
            ]
        ]
    },
    {
        "id": "472acfc03b69788a",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "Output failsafe",
        "func": "// INFLOW\nlet maxCharge = msg.batteries_max_charge_power||undefined;\nlet maxDischarge = msg.batteries_max_discharge_power||undefined;\nlet isCharging = msg.batteries_charging||undefined;\nlet PID_output = msg.payload; // Watt\n\n// No failsafe\nif (maxCharge === undefined || maxDischarge == undefined) {\n    node.status({ fill: \"red\", shape: \"dot\", text: \"disabled\" });\n    node.warn(`Output Failsafe is INACTIVE. Max charge or discharge limits are undefined`);\n    // continue without safeguard\n    return msg;\n} \n\n// limit\nlet limit = 0;\n\n// charging state unknown\nif(isCharging === undefined) {\n    // limit on lowest of charge / discharge\n    limit = Math.min(maxCharge,maxDischarge);    \n}\n// charging state known\nlimit = isCharging ? maxCharge : maxDischarge;\n\n// Safe output\nif (PID_output <= limit){\n    node.status({ fill: \"green\", shape: \"dot\", text: \"safe\" });\n    return msg;\n} \n\n// Unsafe, limit output\nnode.status({ fill: \"yellow\", shape: \"ring\", text: \"power limiting\" });\nmsg.payload = Number(limit);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1080,
        "y": 660,
        "wires": [
            [
                "d39518e171a8f45d",
                "0213ae880bfbc428"
            ]
        ]
    },
    {
        "id": "b45be92a4961f5ee",
        "type": "rbe",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 880,
        "wires": [
            [
                "01c44459de13dcb9"
            ]
        ]
    },
    {
        "id": "d39518e171a8f45d",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "a37bfc04d3c18245",
        "name": "Load distribution",
        "func": "// Logger\nconst log = global.get(\"logger\");\nlog(this,\"**PID load distribution**\");\n\n// INPUT\nvar batteries = msg.batteries; // Battery configuration as provided by `Home Batteries IO` flow\nvar isCharging = msg.batteries_charging; // Are we in a battery charging scenario?\nvar hasChargingLimiter = flow.get(\"has_soc_charging_limiter\") || false; // Battery life improvement\nvar hasReverseDischargePriority = flow.get(\"has_reverse_priority_discharge\") || false; // Prioritize (dis)charging the same battery\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\"); // Disallow discharging?\n\n// how much power do the batteries need to compensate?\nvar unassigned_power = Math.round(Math.abs(msg.payload)); // Power in W to compensate using batteries\nlog(this,`How much power do the batteries need to compensate: ${unassigned_power} W`);\n\n// inits \nvar solution_array = []; // load distribution solutions\nvar batteries_total_assignable_power = 0; // Current max. available total (dis)charge power. Exceeding this max should trigger the anti-windup routine for the Integral terms\n\n// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n/**\n** Battery life improvement (slow charge near max SoC)\n* @param {number} soc\n* @param {number} max_power\n*/\nfunction chargingLimiter(soc, max_power) {\n    // Must be greater than zero\n    let limitedPower = Math.max(0, max_power); \n\n    // Limit charge at high SoC\n    if (hasChargingLimiter) {\n        if (soc >= 98)      limitedPower = Math.min(300, limitedPower);\n        else if (soc >= 95) limitedPower = Math.min(500, limitedPower);\n        else if (soc >= 85) limitedPower = Math.min(1500, limitedPower);\n    }\n    return limitedPower;\n}\n\n/**\n* battery life improvement (disconnects battery only if the battery is not used for ... seconds)\n* @param {string | number} batteryID\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getStopSolution(batteryID) {\n    // idle time, before stop is given to inverter relay.\n    let time_idle_minimum = flow.get(\"idle_time_minutes\")*60*1000||0; // Milliseconds\n\n    // retrieve last registered active times for each battery based on their ids\n    let lasttime_active = context.get(\"lasttime_active\");\n    \n    // battery exists in register \n    if(lasttime_active[batteryID] !== undefined){\n        // timing\n        let time_last = lasttime_active[batteryID]; // Milliseconds \n        let time_now = Date.now();                  // Milliseconds \n        let time_idle = (time_now - time_last); // Milliseconds\n        \n        // battery is ready for STOP\n        if (time_idle >= time_idle_minimum) {\n            log(this,`Battery ${batteryID} [STOP]: 0 Watt and disconnect relay.`);\n            return {id: batteryID, mode: CMODE.STOP, power:0}; // STOP or 0 Watt disconnects relay\n        }\n        \n        // battery is kept IDLE, while awaiting minimum inactive time\n        log(this,`Battery ${batteryID} [IDLE]: 1 Watt for ${Math.round((time_idle_minimum-time_idle)/1000)}s. Keep relay engaged.`);\n        return { id: batteryID, mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE, power: 1 }; // 1 Watt keeps battery IDLE, keeping relay engaged\n    }\n\n    // battery missing in register\n    log(this,`Battery ${batteryID} [IDLE]: unknown last active time`);\n    return getActiveSolution(batteryID, 1); // set a last active time and engage idle state\n}\n\n/**\n* Get battery solution and register a last active time.\n* @param {any} batteryID\n* @param {number} assigned_power\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getActiveSolution(batteryID, assigned_power){\n    // register battery as active\n    let lasttime_active = context.get(\"lasttime_active\")||[]; // last registered active times for each battery based on their ids\n    lasttime_active[batteryID] = Date.now();\n    context.set(\"lasttime_active\", lasttime_active);\n\n    // solution\n    return {\n        id: batteryID,\n        mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE,\n        power: Math.round(assigned_power)\n    };\n}\n\n// -- BATTERY DISCHARGE PRIORITY\nif (!isCharging && hasReverseDischargePriority) {\n   batteries.reverse();\n}\n\n// -- LOAD BALANCER --\nbatteries.forEach((/** @type {{ id: any; soc: number; soc_min: number; soc_max: number; rs485: string; charging_max: number; discharging_max: any; }} */ battery) => {\n    \n    // Explain\n    log(this, `Battery ${battery.id}: ${battery.soc}% (min: ${battery.soc_min}%, max: ${battery.soc_max}%) ; RS485: ${battery.rs485=='enable'?'OK':'Nok'}`);\n\n    // track if the battery should be skipped and why\n    let skipReason = null;\n    if (battery.rs485 !== \"enable\") {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because RS485 is not 'enable'`;\n    } else if (isCharging && battery.soc >= battery.soc_max) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because SoC (${battery.soc}%) >= Max (${battery.soc_max}%) while charging`;\n    } else if (!isCharging && battery.soc <= battery.soc_min) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because SoC (${battery.soc}%) <= Min (${battery.soc_min}%) while discharging`;\n    } else if (!isCharging && isDischargeDisabled) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped, discharging was disabled via msg property`;\n    }\n\n    // battery NOT AVAIABLE, skip via soft stop\n    if (skipReason !== null) {\n        log(this, skipReason);                      // communicate reason\n        let solution = getStopSolution(battery.id); // get a soft stop solution for this battery\n        solution_array.push(solution);              // add solution, do not update last active time.\n        // next battery\n        return; \n    }\n\n    // battery is AVAILABLE, assign power\n    let battery_assignable_power = isCharging ? chargingLimiter(battery.soc, battery.charging_max) : battery.discharging_max;\n    let assign = Math.min(unassigned_power, battery_assignable_power);\n    \n    // select solution\n    var solution;\n    if (assign <= 0 ) {\n        // no power solution\n        solution = getStopSolution(battery.id); // a soft stop solution\n        assign = 0;\n    } else {\n        // assigned power solution\n        solution = getActiveSolution(battery.id, Math.round(assign));\n    }\n    solution_array.push(solution);\n    \n    // Explain: charge limiting\n    if(unassigned_power > battery_assignable_power && battery_assignable_power < battery.charging_max) {\n        log(this,`Charging limited to protect battery (${battery.soc}%): ${battery.charging_max}W -> ${battery_assignable_power}W`);\n    }\n    // Explain: solution result\n    log(this, `<font color=\"#009ac7\">Battery ${solution.id}</font>: assigned to ${solution.mode} with ${solution.power}W / ${isCharging ? battery.charging_max : battery.discharging_max }W max.`)\n\n    // remaining power to assign\n    unassigned_power -= assign;\n    batteries_total_assignable_power += Number(battery_assignable_power);\n});\n\n// battery discharge priority - put solutions back in initial order\nif (!isCharging && hasReverseDischargePriority) {\n    solution_array.reverse();\n}\n\n// store solutions in msg\nRED.util.setMessageProperty(msg, \"solutions\", solution_array,true);\n\n// OUTFLOW\nflow.set(\"batteries_total_assignable_power\", batteries_total_assignable_power); // this is set for the anti-windup calculation in the earlier 'calculate corrections' node, which will pick this up during next iteration.\n\n// OUTPUT\nreturn msg; // to Home Battery flow",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\ncontext.set(\"lasttime_active\",[]);",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 1160,
        "wires": [
            [
                "02528b5f0b40515f",
                "740ff013f706dea7"
            ]
        ],
        "inputLabels": [
            "isCharging (boolean)"
        ]
    },
    {
        "id": "02528b5f0b40515f",
        "type": "debug",
        "z": "5514ca6b1b2fc795",
        "g": "a37bfc04d3c18245",
        "name": "Load distribution",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "solutions",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 1160,
        "wires": []
    },
    {
        "id": "3a4947f122506bc9",
        "type": "switch",
        "z": "5514ca6b1b2fc795",
        "g": "64685d1b1184fd0b",
        "name": "Pass or Halt",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "halted by deadband",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "halted by deadband",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 340,
        "wires": [
            [
                "d5cba946bc7b0142"
            ],
            [
                "4a2712bd3bd8750a"
            ]
        ]
    },
    {
        "id": "740ff013f706dea7",
        "type": "link out",
        "z": "5514ca6b1b2fc795",
        "g": "173ebd2c7496660d",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 225,
        "y": 1240,
        "wires": []
    },
    {
        "id": "5ace8874ce162d7a",
        "type": "comment",
        "z": "5514ca6b1b2fc795",
        "g": "173ebd2c7496660d",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 170,
        "y": 1180,
        "wires": []
    },
    {
        "id": "d5cba946bc7b0142",
        "type": "link out",
        "z": "5514ca6b1b2fc795",
        "g": "64685d1b1184fd0b",
        "name": "go to End",
        "mode": "link",
        "links": [
            "27bc1a67ec485e76"
        ],
        "x": 1090,
        "y": 340,
        "wires": [],
        "inputLabels": [
            "Halt"
        ],
        "l": true
    },
    {
        "id": "27bc1a67ec485e76",
        "type": "link in",
        "z": "5514ca6b1b2fc795",
        "g": "173ebd2c7496660d",
        "name": "link to End",
        "links": [
            "d5cba946bc7b0142"
        ],
        "x": 105,
        "y": 1240,
        "wires": [
            [
                "740ff013f706dea7"
            ]
        ]
    },
    {
        "id": "363eea4e7fb6fa3e",
        "type": "api-call-service",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "Is charging",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "",
        "service": "",
        "x": 1070,
        "y": 1000,
        "wires": [
            []
        ]
    },
    {
        "id": "4cd2ac40e42d7e21",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "Config action",
        "func": "const value = msg.payload;\nconst target = \"input_boolean.house_battery_control_is_charging\";\n\nmsg.payload = {\n    \"action\": value?\"input_boolean.turn_on\":\"input_boolean.turn_off\",\n    \"target\": {\n        \"entity_id\": [target]\n    },\n    \"data\": {}\n}\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 1000,
        "wires": [
            [
                "363eea4e7fb6fa3e"
            ]
        ]
    },
    {
        "id": "e62aafb8052ff7da",
        "type": "switch",
        "z": "5514ca6b1b2fc795",
        "g": "4a6afeecba388786",
        "name": "Target",
        "property": "house_target_grid_consumption_in_w",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 390,
        "y": 120,
        "wires": [
            [
                "099eef4dab59e963"
            ],
            [
                "65ba171e4be3708f"
            ]
        ]
    },
    {
        "id": "bced3dcd50a1545a",
        "type": "debug",
        "z": "5514ca6b1b2fc795",
        "g": "4a6afeecba388786",
        "name": "Target",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "house_target_grid_consumption_in_w",
        "targetType": "msg",
        "statusVal": "house_target_grid_consumption_in_w",
        "statusType": "auto",
        "x": 790,
        "y": 100,
        "wires": []
    },
    {
        "id": "59ad2bb51c8d827b",
        "type": "server-state-changed",
        "z": "5514ca6b1b2fc795",
        "g": "5f82a83792ef2689",
        "name": "Strategy changes",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_text.house_battery_strategy_active_sub_strategy",
                "input_select.house_battery_strategy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 340,
        "wires": [
            [
                "4f72a2197181054f"
            ]
        ]
    },
    {
        "id": "4f72a2197181054f",
        "type": "switch",
        "z": "5514ca6b1b2fc795",
        "g": "5f82a83792ef2689",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full stop",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1855,
        "y": 340,
        "wires": [
            [
                "b752c80f6054fee8"
            ]
        ],
        "l": false
    },
    {
        "id": "373abc5f598ed57c",
        "type": "server-state-changed",
        "z": "5514ca6b1b2fc795",
        "g": "5f82a83792ef2689",
        "name": "Full stop trigger",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.ev_is_charging"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 420,
        "wires": [
            [
                "7f0690764f21fc96"
            ]
        ]
    },
    {
        "id": "7f0690764f21fc96",
        "type": "switch",
        "z": "5514ca6b1b2fc795",
        "g": "5f82a83792ef2689",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1855,
        "y": 420,
        "wires": [
            [
                "b752c80f6054fee8"
            ]
        ],
        "l": false
    },
    {
        "id": "b7b8dd92a2effab8",
        "type": "rbe",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 820,
        "wires": [
            [
                "c547c0ee749203ad"
            ]
        ]
    },
    {
        "id": "6316220a57018f7e",
        "type": "rbe",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 940,
        "wires": [
            [
                "4e4df8614dc4d03c"
            ]
        ]
    },
    {
        "id": "0bd03eb81e5cabed",
        "type": "rbe",
        "z": "5514ca6b1b2fc795",
        "g": "8719db030e1ed765",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 1000,
        "wires": [
            [
                "4cd2ac40e42d7e21",
                "7e773be39a93951c"
            ]
        ]
    },
    {
        "id": "5f7032fee27f69c3",
        "type": "change",
        "z": "5514ca6b1b2fc795",
        "g": "c1886c0e0af92e56",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 190,
        "y": 200,
        "wires": [
            [
                "e62aafb8052ff7da"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "32b3cb5b4b300bda",
        "type": "catch",
        "z": "5514ca6b1b2fc795",
        "g": "c9787d2bebc68376",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 95,
        "y": 320,
        "wires": [
            [
                "51258802c8d99561"
            ]
        ],
        "l": false
    },
    {
        "id": "51258802c8d99561",
        "type": "function",
        "z": "5514ca6b1b2fc795",
        "g": "c9787d2bebc68376",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 145,
        "y": 320,
        "wires": [
            [
                "37a7dba2f12a9b10"
            ]
        ],
        "l": false
    },
    {
        "id": "37a7dba2f12a9b10",
        "type": "link out",
        "z": "5514ca6b1b2fc795",
        "g": "c9787d2bebc68376",
        "name": "link out 7",
        "mode": "return",
        "links": [],
        "x": 195,
        "y": 320,
        "wires": []
    },
    {
        "id": "1db82302b4d716e3",
        "type": "comment",
        "z": "884ad99f8a714fbe",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 140,
        "y": 60,
        "wires": []
    },
    {
        "id": "38bb91b04c6c811d",
        "type": "link in",
        "z": "884ad99f8a714fbe",
        "g": "148fba07c69fbaaf",
        "name": "Sell",
        "links": [],
        "x": 110,
        "y": 220,
        "wires": [
            [
                "5e2b42ca40a25d33"
            ]
        ],
        "l": true
    },
    {
        "id": "8c98ec1dabaafa23",
        "type": "comment",
        "z": "884ad99f8a714fbe",
        "g": "148fba07c69fbaaf",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 130,
        "y": 140,
        "wires": []
    },
    {
        "id": "5e2b42ca40a25d33",
        "type": "change",
        "z": "884ad99f8a714fbe",
        "g": "148fba07c69fbaaf",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 180,
        "wires": [
            [
                "41c7a815d1224837"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "6144f913d09c737e",
        "type": "link out",
        "z": "884ad99f8a714fbe",
        "g": "8d5e1ab006b4a5a2",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 185,
        "y": 580,
        "wires": []
    },
    {
        "id": "5bb20cc4c92f55e2",
        "type": "comment",
        "z": "884ad99f8a714fbe",
        "g": "8d5e1ab006b4a5a2",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 130,
        "y": 520,
        "wires": []
    },
    {
        "id": "bac35001debaf802",
        "type": "function",
        "z": "884ad99f8a714fbe",
        "g": "f6662c6a556ba24f",
        "name": "Max power solution",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\nlog(this, \"Discharge at **max. power**\");\n\n// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// build solution\nmsg.batteries.forEach(battery => {\n    const calculatedPower = Number(battery.discharging_max);\n\n    solution_array.push({\n        id: battery.id,\n        mode: \"discharge\",\n        power: calculatedPower\n    });\n\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 360,
        "wires": [
            [
                "eea8ef2a42e7ace3"
            ]
        ]
    },
    {
        "id": "d52dd9a905df305c",
        "type": "link call",
        "z": "884ad99f8a714fbe",
        "g": "f6662c6a556ba24f",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1140,
        "y": 400,
        "wires": [
            [
                "9b1b8e0130d7b7aa",
                "f6a52340d65389ed"
            ]
        ]
    },
    {
        "id": "31e95c10ae3182f3",
        "type": "switch",
        "z": "884ad99f8a714fbe",
        "g": "f6662c6a556ba24f",
        "name": "Export at max power",
        "property": "house_battery_strategy_sell_has_max_power",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 760,
        "y": 380,
        "wires": [
            [
                "bac35001debaf802"
            ],
            [
                "3c17ffb1d46e57c6"
            ]
        ]
    },
    {
        "id": "9b1b8e0130d7b7aa",
        "type": "debug",
        "z": "884ad99f8a714fbe",
        "g": "f6662c6a556ba24f",
        "name": "Regulated",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1330,
        "y": 400,
        "wires": []
    },
    {
        "id": "810e47c5954f609d",
        "type": "debug",
        "z": "884ad99f8a714fbe",
        "g": "f6662c6a556ba24f",
        "name": "Maximum",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1320,
        "y": 360,
        "wires": []
    },
    {
        "id": "3c17ffb1d46e57c6",
        "type": "function",
        "z": "884ad99f8a714fbe",
        "g": "f6662c6a556ba24f",
        "name": "Regulated power",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = -msg.house_battery_strategy_sell_target_power; // negative, we are exporting to grid.\n// tell PID to avoid charge solutions during Selling.\nRED.util.setMessageProperty(msg,\"advanced_settings.charge_disabled\",true,true);\n\n// Finally\nlog(this, `**Regulated** discharging. Max. grid power: ${Math.floor(msg.house_battery_strategy_sell_target_power)} W`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 400,
        "wires": [
            [
                "d52dd9a905df305c"
            ]
        ]
    },
    {
        "id": "eea8ef2a42e7ace3",
        "type": "change",
        "z": "884ad99f8a714fbe",
        "g": "f6662c6a556ba24f",
        "name": "Continue",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Charge",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 360,
        "wires": [
            [
                "810e47c5954f609d",
                "f6a52340d65389ed"
            ]
        ]
    },
    {
        "id": "32e23cc0c2d08517",
        "type": "function",
        "z": "884ad99f8a714fbe",
        "g": "d6103c3bd4154011",
        "name": "Min/max",
        "func": "\n// Lower bound\nlet output = msg.sell.threshold_energy | 0; // kWh\noutput = Math.max(output, 0);\n\n// Upper bound\nlet max_reserve = 0; // kWh\nmsg.batteries.forEach(battery => {\n    max_reserve += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\noutput = Math.min(output, max_reserve);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1720,
        "y": 200,
        "wires": [
            [
                "291ad7c5c558cb14"
            ]
        ]
    },
    {
        "id": "291ad7c5c558cb14",
        "type": "api-call-service",
        "z": "884ad99f8a714fbe",
        "g": "d6103c3bd4154011",
        "name": "Set desired energy reserve",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_sell_target_energy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.payload}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1920,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "ca776716eb0dba24",
        "type": "rbe",
        "z": "884ad99f8a714fbe",
        "g": "d6103c3bd4154011",
        "name": "Desired energy changed",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 1530,
        "y": 200,
        "wires": [
            [
                "32e23cc0c2d08517"
            ]
        ]
    },
    {
        "id": "901d2f3310726133",
        "type": "api-current-state",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Goal",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_sell_goal",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.goal",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 180,
        "wires": [
            [
                "eac1424453781f87"
            ]
        ]
    },
    {
        "id": "eac1424453781f87",
        "type": "switch",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Sell until",
        "property": "sell.goal",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "batteries are empty",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "state of charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "energy reserve",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 4,
        "x": 580,
        "y": 180,
        "wires": [
            [
                "0538d37be0889ccd"
            ],
            [
                "5e72f5a0d0f504f9"
            ],
            [
                "7fd3b8cc6b026197"
            ],
            [
                "9f5fde3d92e92513"
            ]
        ]
    },
    {
        "id": "9f5fde3d92e92513",
        "type": "function",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Unknown -> Full stop",
        "func": "const log = global.get(\"logger\");\n\n// Unkown export goal\nlog(this, `**${msg.sell.goal}**; Sell goal not recognized. Fallback to **Full Stop**`,\"warn\");\n\n// Full stop\nmsg.target = \"Full stop\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 240,
        "wires": [
            [
                "9ad0059b121918ce"
            ]
        ]
    },
    {
        "id": "41c7a815d1224837",
        "type": "function",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Init",
        "func": "msg.sell = {};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "901d2f3310726133"
            ]
        ]
    },
    {
        "id": "9ad0059b121918ce",
        "type": "link call",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 940,
        "y": 240,
        "wires": [
            [
                "c7c1dd60d15e01c6"
            ]
        ]
    },
    {
        "id": "7fd3b8cc6b026197",
        "type": "api-current-state",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Energy reserve low",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.threshold_energy",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 750,
        "y": 200,
        "wires": [
            [
                "2bc1353e9aea970b"
            ]
        ]
    },
    {
        "id": "b803cd0063a72e16",
        "type": "link in",
        "z": "884ad99f8a714fbe",
        "g": "8d5e1ab006b4a5a2",
        "name": "link to End",
        "links": [
            "c7c1dd60d15e01c6",
            "c82bac434005502f",
            "f6a52340d65389ed"
        ],
        "x": 75,
        "y": 580,
        "wires": [
            [
                "6144f913d09c737e"
            ]
        ]
    },
    {
        "id": "c7c1dd60d15e01c6",
        "type": "link out",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "go to End",
        "mode": "link",
        "links": [
            "b803cd0063a72e16"
        ],
        "x": 1140,
        "y": 240,
        "wires": [],
        "l": true
    },
    {
        "id": "5e72f5a0d0f504f9",
        "type": "api-current-state",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "SoC low",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_soc",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.threshold_soc",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 720,
        "y": 160,
        "wires": [
            [
                "c57d136b0ac2f19a"
            ]
        ]
    },
    {
        "id": "2bc1353e9aea970b",
        "type": "function",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Check if low",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Sell until: ${msg.sell.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nvar energy_threshold = Number(RED.util.getMessageProperty(msg,\"sell.threshold_energy\"));\nif (energy_threshold === undefined || energy_threshold < 0){\n    log(this,`Desired energy reserve not set correctly '${energy_threshold}' kWh`,\"warn\");\n    energy_threshold = 0;\n}\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining <= energy_threshold) {\n    msg.sell.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.sell.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.sell.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 200,
        "wires": [
            [
                "496f19953301e6e7",
                "ca776716eb0dba24"
            ]
        ]
    },
    {
        "id": "c57d136b0ac2f19a",
        "type": "function",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Check if low",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this, `Sell until: ${msg.sell.goal}`);\n\n// 2. Extract average SoC and desired SoC level\nlet batteries = msg.batteries;\nlet soc_avg = 0;\nlet count = 0; // could use msg.battery_count\nbatteries.forEach(battery => {\n    soc_avg += battery.soc;\n    count++;\n});\n// 2a.  Current avg. SoC\nsoc_avg = Math.round(soc_avg / count * 100) / 100;\n// 2b.  Sell until SoC (12% as fallback)\nvar soc_threshold = Number(RED.util.getMessageProperty(msg,\"sell.threshold_soc\"));\nif (soc_threshold === undefined || soc_threshold < 12){\n    log(this, `Desired SoC not set correctly '${soc_threshold}' %. I've set it to 12%.`,\"warn\");\n    soc_threshold = 12;\n}\n\n// 3. Logic: Determine if SoC level is at or below desired level\nif (soc_avg <= msg.payload) {\n    msg.sell.threshold_reached = true;\n\n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n\n    // User friendly feedback via the custom logger\n    log(this, `[OK] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({\n    fill: msg.sell.threshold_reached ? \"red\" : \"green\",\n    shape: \"dot\",\n    text: `Threshold reached: ${msg.sell.threshold_reached}`\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 160,
        "wires": [
            [
                "496f19953301e6e7"
            ]
        ]
    },
    {
        "id": "0538d37be0889ccd",
        "type": "change",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Batteries are empty",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 120,
        "wires": [
            [
                "3decfdde96bf46d7"
            ]
        ]
    },
    {
        "id": "3decfdde96bf46d7",
        "type": "function",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Check if empty",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Sell until: ${msg.sell.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining <= 0) {\n    msg.sell.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] All batteries are empty or at SoC_min_ (${energy_remaining} kWh).`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Battery level ${energy_remaining.toFixed(2)} kWh above 0 kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.sell.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.sell.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 960,
        "y": 120,
        "wires": [
            [
                "496f19953301e6e7"
            ]
        ]
    },
    {
        "id": "61e3de2e5d29a97b",
        "type": "switch",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Until reached",
        "property": "sell.threshold_reached",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1290,
        "y": 160,
        "wires": [
            [
                "9e07935cfcb6a7ed"
            ],
            [
                "28a9d3761fe7cf4b"
            ]
        ]
    },
    {
        "id": "9e07935cfcb6a7ed",
        "type": "function",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Yes -> Full stop",
        "func": "\nmsg.target = \"Full stop\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1520,
        "y": 120,
        "wires": [
            [
                "601686d176680862"
            ]
        ]
    },
    {
        "id": "601686d176680862",
        "type": "link call",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 1680,
        "y": 120,
        "wires": [
            [
                "c82bac434005502f"
            ]
        ]
    },
    {
        "id": "c82bac434005502f",
        "type": "link out",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "go to End",
        "mode": "link",
        "links": [
            "b803cd0063a72e16"
        ],
        "x": 1820,
        "y": 120,
        "wires": [],
        "l": true
    },
    {
        "id": "496f19953301e6e7",
        "type": "function",
        "z": "884ad99f8a714fbe",
        "g": "11abcd3035953c42",
        "name": "Decided",
        "func": "const log = global.get(\"logger\");\n\nif(msg.sell.threshold_reached){\n    log(this,`Stop discharging, Sell until ${msg.sell.goal} reached.`);\n} else {\n    log(this,`Continue discharging.`);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1140,
        "y": 160,
        "wires": [
            [
                "61e3de2e5d29a97b"
            ]
        ]
    },
    {
        "id": "f6a52340d65389ed",
        "type": "link out",
        "z": "884ad99f8a714fbe",
        "g": "f6662c6a556ba24f",
        "name": "go to End",
        "mode": "link",
        "links": [
            "b803cd0063a72e16"
        ],
        "x": 1320,
        "y": 460,
        "wires": [],
        "l": true
    },
    {
        "id": "f6774a92f588394d",
        "type": "catch",
        "z": "884ad99f8a714fbe",
        "g": "6752e9a3feae2e7d",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 75,
        "y": 420,
        "wires": [
            [
                "bfa40d077828d503"
            ]
        ],
        "l": false
    },
    {
        "id": "b5c85ef50382b2e6",
        "type": "api-current-state",
        "z": "884ad99f8a714fbe",
        "g": "f6662c6a556ba24f",
        "name": "Use max power?",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_sell_has_max_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_sell_has_max_power",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 380,
        "wires": [
            [
                "1733d4cbd9cdc560"
            ]
        ]
    },
    {
        "id": "1733d4cbd9cdc560",
        "type": "api-current-state",
        "z": "884ad99f8a714fbe",
        "g": "f6662c6a556ba24f",
        "name": "Grid power limit",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_sell_target_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 560,
        "y": 380,
        "wires": [
            [
                "31e95c10ae3182f3"
            ]
        ]
    },
    {
        "id": "bfa40d077828d503",
        "type": "function",
        "z": "884ad99f8a714fbe",
        "g": "6752e9a3feae2e7d",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 125,
        "y": 420,
        "wires": [
            [
                "4b3ba74f290beebf"
            ]
        ],
        "l": false
    },
    {
        "id": "4b3ba74f290beebf",
        "type": "link out",
        "z": "884ad99f8a714fbe",
        "g": "6752e9a3feae2e7d",
        "name": "link out 2",
        "mode": "return",
        "links": [],
        "x": 175,
        "y": 420,
        "wires": []
    },
    {
        "id": "d20c6c828252124e",
        "type": "link in",
        "z": "89d1530aea5327c6",
        "g": "f52d8e87807099ce",
        "name": "Timed",
        "links": [],
        "x": 110,
        "y": 160,
        "wires": [
            [
                "62bfc44fd94f458b"
            ]
        ],
        "l": true
    },
    {
        "id": "b7af0385bc40a8e5",
        "type": "comment",
        "z": "89d1530aea5327c6",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 130,
        "y": 40,
        "wires": []
    },
    {
        "id": "b90b28899033b272",
        "type": "comment",
        "z": "89d1530aea5327c6",
        "g": "f52d8e87807099ce",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 120,
        "y": 120,
        "wires": []
    },
    {
        "id": "592194a2bf507f32",
        "type": "link out",
        "z": "89d1530aea5327c6",
        "g": "1411bfdd17b2859f",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 1255,
        "y": 520,
        "wires": []
    },
    {
        "id": "871731fd98277587",
        "type": "comment",
        "z": "89d1530aea5327c6",
        "g": "1411bfdd17b2859f",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 1310,
        "y": 460,
        "wires": []
    },
    {
        "id": "838b48c84778952b",
        "type": "api-current-state",
        "z": "89d1530aea5327c6",
        "g": "d088af62e0043785",
        "name": "Period A start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_a1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_a1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 550,
        "y": 120,
        "wires": [
            [
                "e11a32db9f9cbfcd"
            ]
        ]
    },
    {
        "id": "e11a32db9f9cbfcd",
        "type": "api-current-state",
        "z": "89d1530aea5327c6",
        "g": "d088af62e0043785",
        "name": "Period A end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_a2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_a2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 120,
        "wires": [
            [
                "ef1939a3c157c9e7"
            ]
        ]
    },
    {
        "id": "390dc0a152bcb8c6",
        "type": "api-current-state",
        "z": "89d1530aea5327c6",
        "g": "51271d6180b1d6fa",
        "name": "Period B start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_b1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_b1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 220,
        "wires": [
            [
                "6ae3f3196caa1968"
            ]
        ]
    },
    {
        "id": "6ae3f3196caa1968",
        "type": "api-current-state",
        "z": "89d1530aea5327c6",
        "g": "51271d6180b1d6fa",
        "name": "Period B end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_b2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_b2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 220,
        "wires": [
            [
                "7b3588f42ab2511b"
            ]
        ]
    },
    {
        "id": "ef1939a3c157c9e7",
        "type": "api-current-state",
        "z": "89d1530aea5327c6",
        "g": "d088af62e0043785",
        "name": "Strat during A",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_a",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_a",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 120,
        "wires": [
            [
                "377ae5fa150eec59"
            ]
        ]
    },
    {
        "id": "7b3588f42ab2511b",
        "type": "api-current-state",
        "z": "89d1530aea5327c6",
        "g": "51271d6180b1d6fa",
        "name": "Strat during B",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_b",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_b",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 220,
        "wires": [
            [
                "37d1f6d05c6d0a1d"
            ]
        ]
    },
    {
        "id": "377ae5fa150eec59",
        "type": "api-current-state",
        "z": "89d1530aea5327c6",
        "g": "51271d6180b1d6fa",
        "name": "Has period B",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_period_b",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_period_b",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 220,
        "wires": [
            [
                "390dc0a152bcb8c6"
            ]
        ]
    },
    {
        "id": "72292077776b69a6",
        "type": "inject",
        "z": "89d1530aea5327c6",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 40,
        "wires": [
            [
                "c215d65973ad0c6b"
            ]
        ]
    },
    {
        "id": "95e4b234b09d1aee",
        "type": "change",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 460,
        "wires": [
            [
                "6fb529b6dedcfa46"
            ]
        ]
    },
    {
        "id": "655b9aa50770dc0a",
        "type": "change",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "set Strat A",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_a",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 420,
        "wires": [
            [
                "d0ab656f1e913076",
                "3af2abd858e47a08"
            ]
        ]
    },
    {
        "id": "6fb529b6dedcfa46",
        "type": "switch",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "has period B",
        "property": "house_battery_strategy_timed_has_period_b",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 500,
        "wires": [
            [
                "d0ab656f1e913076",
                "31fcb1c271f89b22"
            ],
            [
                "c56e050f085ba0a6"
            ]
        ]
    },
    {
        "id": "9fa4454931f862bf",
        "type": "function",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "config A",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_a1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_a2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 440,
        "wires": [
            [
                "a69911f3919ba57a"
            ]
        ]
    },
    {
        "id": "a69911f3919ba57a",
        "type": "time-range-switch",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "Period A",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 440,
        "wires": [
            [
                "655b9aa50770dc0a"
            ],
            [
                "95e4b234b09d1aee"
            ]
        ]
    },
    {
        "id": "c56e050f085ba0a6",
        "type": "function",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "config B",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_b1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_b2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 580,
        "wires": [
            [
                "b1da1498e92f7d0d"
            ]
        ]
    },
    {
        "id": "b1da1498e92f7d0d",
        "type": "time-range-switch",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "Period B",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 580,
        "wires": [
            [
                "3e6a0662090e2d4f"
            ],
            [
                "7d0f3a8b9745af95"
            ]
        ]
    },
    {
        "id": "3e6a0662090e2d4f",
        "type": "change",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "set Strat B",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_b",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 560,
        "wires": [
            [
                "d0ab656f1e913076",
                "cd4d19b597901746"
            ]
        ]
    },
    {
        "id": "7d0f3a8b9745af95",
        "type": "change",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 600,
        "wires": [
            [
                "c321ac377a29a2d4"
            ]
        ]
    },
    {
        "id": "c215d65973ad0c6b",
        "type": "api-current-state",
        "z": "89d1530aea5327c6",
        "g": "6ef0497f9750e793",
        "name": "Default Strat",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_0",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_0",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 120,
        "wires": [
            [
                "838b48c84778952b"
            ]
        ]
    },
    {
        "id": "3b0f43ac3f6078f6",
        "type": "link call",
        "z": "89d1530aea5327c6",
        "g": "0d39649ce9e273f8",
        "name": "Sub strategy",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1080,
        "y": 520,
        "wires": [
            [
                "592194a2bf507f32"
            ]
        ]
    },
    {
        "id": "d0ab656f1e913076",
        "type": "change",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "Select flow",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "timed_strategy",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 850,
        "y": 520,
        "wires": [
            [
                "3b0f43ac3f6078f6",
                "37f4117e45db0d46"
            ]
        ]
    },
    {
        "id": "3af2abd858e47a08",
        "type": "debug",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "A",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 420,
        "wires": []
    },
    {
        "id": "31fcb1c271f89b22",
        "type": "debug",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 460,
        "wires": []
    },
    {
        "id": "cd4d19b597901746",
        "type": "debug",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "B",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 560,
        "wires": []
    },
    {
        "id": "f8772cdd4dcb135b",
        "type": "debug",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 600,
        "wires": []
    },
    {
        "id": "37f4117e45db0d46",
        "type": "debug",
        "z": "89d1530aea5327c6",
        "g": "0d39649ce9e273f8",
        "name": "Target",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "target",
        "targetType": "msg",
        "statusVal": "target",
        "statusType": "auto",
        "x": 1060,
        "y": 460,
        "wires": []
    },
    {
        "id": "103de563abac1af9",
        "type": "api-current-state",
        "z": "89d1530aea5327c6",
        "g": "75e023842ba0d125",
        "name": "Period C start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_c1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_c1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 320,
        "wires": [
            [
                "03c34454a489b12a"
            ]
        ]
    },
    {
        "id": "03c34454a489b12a",
        "type": "api-current-state",
        "z": "89d1530aea5327c6",
        "g": "75e023842ba0d125",
        "name": "Period C end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_c2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_c2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 320,
        "wires": [
            [
                "660e5cbe5954e217"
            ]
        ]
    },
    {
        "id": "660e5cbe5954e217",
        "type": "api-current-state",
        "z": "89d1530aea5327c6",
        "g": "75e023842ba0d125",
        "name": "Strat during C",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_c",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_c",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 320,
        "wires": [
            [
                "9fa4454931f862bf"
            ]
        ]
    },
    {
        "id": "37d1f6d05c6d0a1d",
        "type": "api-current-state",
        "z": "89d1530aea5327c6",
        "g": "75e023842ba0d125",
        "name": "Has period C",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_period_c",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_period_c",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 320,
        "wires": [
            [
                "103de563abac1af9"
            ]
        ]
    },
    {
        "id": "c321ac377a29a2d4",
        "type": "switch",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "has period C",
        "property": "house_battery_strategy_timed_has_period_c",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 640,
        "wires": [
            [
                "d0ab656f1e913076",
                "f8772cdd4dcb135b"
            ],
            [
                "33092dcce880ded0"
            ]
        ]
    },
    {
        "id": "aef10e28757c67f7",
        "type": "debug",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "C",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 700,
        "wires": []
    },
    {
        "id": "33092dcce880ded0",
        "type": "function",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "config C",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_c1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_c2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 720,
        "wires": [
            [
                "66a095da2f7c01e2"
            ]
        ]
    },
    {
        "id": "66a095da2f7c01e2",
        "type": "time-range-switch",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "Period C",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 720,
        "wires": [
            [
                "d31a89baac9b3cb5"
            ],
            [
                "42dd62adc753f11b"
            ]
        ]
    },
    {
        "id": "d31a89baac9b3cb5",
        "type": "change",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "set Strat C",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_c",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 700,
        "wires": [
            [
                "aef10e28757c67f7",
                "d0ab656f1e913076"
            ]
        ]
    },
    {
        "id": "42dd62adc753f11b",
        "type": "change",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 740,
        "wires": [
            [
                "d0ab656f1e913076",
                "8b1352b68c49d4d5"
            ]
        ]
    },
    {
        "id": "8b1352b68c49d4d5",
        "type": "debug",
        "z": "89d1530aea5327c6",
        "g": "ac876275eea3c10c",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 740,
        "wires": []
    },
    {
        "id": "62bfc44fd94f458b",
        "type": "change",
        "z": "89d1530aea5327c6",
        "g": "f52d8e87807099ce",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 200,
        "wires": [
            [
                "c215d65973ad0c6b"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "27c5c9a1abd4447a",
        "type": "catch",
        "z": "89d1530aea5327c6",
        "g": "dd5d5208bfbe6c50",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 65,
        "y": 320,
        "wires": [
            [
                "8eb9e72095623d0d"
            ]
        ],
        "l": false
    },
    {
        "id": "8eb9e72095623d0d",
        "type": "function",
        "z": "89d1530aea5327c6",
        "g": "dd5d5208bfbe6c50",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 115,
        "y": 320,
        "wires": [
            [
                "a420f3cc371bacb1"
            ]
        ],
        "l": false
    },
    {
        "id": "a420f3cc371bacb1",
        "type": "link out",
        "z": "89d1530aea5327c6",
        "g": "dd5d5208bfbe6c50",
        "name": "link out 8",
        "mode": "return",
        "links": [],
        "x": 165,
        "y": 320,
        "wires": []
    },
    {
        "id": "75c23316c3a1ed36",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.3",
            "node-red-node-smooth": "0.1.2",
            "node-red-contrib-time-range-switch": "1.2.0"
        }
    }
]