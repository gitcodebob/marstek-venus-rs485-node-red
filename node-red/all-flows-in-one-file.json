[
    {
        "id":  "acde727d4cb42aaa",
        "type":  "tab",
        "label":  "Home Battery Master Switch",
        "disabled":  false,
        "info":  "",
        "env":  [

                ]
    },
    {
        "id":  "5b3831da1b35bb1d",
        "type":  "group",
        "z":  "acde727d4cb42aaa",
        "name":  "Marstek master control switch",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "b9f84cc9f5a92c37",
                      "db8935b06e0974bc",
                      "ce0d5547e473555e",
                      "64dc39c70599dfc4",
                      "8b5ef482f35ef9c0"
                  ],
        "x":  34,
        "y":  19,
        "w":  898,
        "h":  382
    },
    {
        "id":  "8b5ef482f35ef9c0",
        "type":  "group",
        "z":  "acde727d4cb42aaa",
        "g":  "5b3831da1b35bb1d",
        "name":  "Loop",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "964d538dd74d6c05",
                      "0a5e50316b0d2b70",
                      "9875fb4be6ce951f",
                      "3141628fc4063a26",
                      "9f47be1a4b1c355b",
                      "06cec7476db26e79"
                  ],
        "x":  414,
        "y":  99,
        "w":  492,
        "h":  222
    },
    {
        "id":  "b9f84cc9f5a92c37",
        "type":  "api-current-state",
        "z":  "acde727d4cb42aaa",
        "g":  "5b3831da1b35bb1d",
        "name":  "Your battery count",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_count",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "battery_count",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  350,
        "y":  60,
        "wires":  [
                      [
                          "db8935b06e0974bc"
                      ]
                  ]
    },
    {
        "id":  "964d538dd74d6c05",
        "type":  "function",
        "z":  "acde727d4cb42aaa",
        "g":  "8b5ef482f35ef9c0",
        "name":  "Set RS485 and Work Modes",
        "func":  "// array for output \nlet outputArray = [];\n\n// battery to target\nconst target = `marstek_m${msg.battery_index}`;\n\n// Set | work mode\nconst workModeAction = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_user_work_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.work_mode)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.work_mode ? { payload: workModeAction, topic:\"user_work_mode\"}: null);\n\n// Set | rs485\nconst rs485Action = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_rs485_control_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.rs485)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.rs485 ? { payload: rs485Action, topic: \"rs485_control_mode\" } : null);\n\n// Store calls in msg to allow checking of loop results\nmsg.loop_result = { target, workModeAction, rs485Action };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Outputs\nreturn outputArray;",
        "outputs":  3,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  560,
        "y":  180,
        "wires":  [
                      [
                          "0a5e50316b0d2b70"
                      ],
                      [
                          "9875fb4be6ce951f"
                      ],
                      [
                          "9f47be1a4b1c355b"
                      ]
                  ]
    },
    {
        "id":  "db8935b06e0974bc",
        "type":  "function",
        "z":  "acde727d4cb42aaa",
        "g":  "5b3831da1b35bb1d",
        "name":  "Loop start",
        "func":  "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// configurables\nlet workMode = null; // manual, anti-feed, ai, null = don\u0027t set or alter this setting\nlet rs485 = null;  // enable, disable, null = don\u0027t set or alter this setting\n\n// mode select\nswitch (msg.marstek_master_battery_mode) {\n    case \"Manual control\":\n        workMode = \"manual\";\n        rs485 = \"disable\";\n        break;\n    case \"Marstek control\":\n        // the user should select a work mode via the Marstek App or via select.marstek_mX_user_work_mode\n        rs485 = \"disable\";\n        break;\n    case \"Full control\":\n        rs485 = \"enable\";\n        break;\n    default:\n        node.status({fill:\"red\",shape:\"ring\",text:`Unhandled mode: ${msg.marstek_master_battery_mode}`});\n        return null; // stop flow\n}\n\n// Continue\nmsg.work_mode = workMode;\nmsg.rs485 = rs485;\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  320,
        "y":  180,
        "wires":  [
                      [
                          "964d538dd74d6c05"
                      ]
                  ]
    },
    {
        "id":  "9f47be1a4b1c355b",
        "type":  "function",
        "z":  "acde727d4cb42aaa",
        "g":  "8b5ef482f35ef9c0",
        "name":  "Loop step",
        "func":  "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  500,
        "y":  240,
        "wires":  [
                      [
                          "3141628fc4063a26",
                          "06cec7476db26e79"
                      ]
                  ]
    },
    {
        "id":  "3141628fc4063a26",
        "type":  "switch",
        "z":  "acde727d4cb42aaa",
        "g":  "8b5ef482f35ef9c0",
        "name":  "Loop until",
        "property":  "battery_index",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "lte",
                          "v":  "battery_count",
                          "vt":  "msg"
                      },
                      {
                          "t":  "else"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  2,
        "x":  640,
        "y":  240,
        "wires":  [
                      [
                          "964d538dd74d6c05"
                      ],
                      [
                          "ce0d5547e473555e"
                      ]
                  ]
    },
    {
        "id":  "0a5e50316b0d2b70",
        "type":  "api-call-service",
        "z":  "acde727d4cb42aaa",
        "g":  "8b5ef482f35ef9c0",
        "name":  "Set work mode",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [

                     ],
        "labelId":  [

                    ],
        "data":  "",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  false,
        "domain":  "input_text",
        "service":  "set_value",
        "x":  800,
        "y":  140,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "9875fb4be6ce951f",
        "type":  "api-call-service",
        "z":  "acde727d4cb42aaa",
        "g":  "8b5ef482f35ef9c0",
        "name":  "Set RS485",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [

                     ],
        "labelId":  [

                    ],
        "data":  "",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  false,
        "domain":  "input_text",
        "service":  "set_value",
        "x":  790,
        "y":  180,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "06cec7476db26e79",
        "type":  "debug",
        "z":  "acde727d4cb42aaa",
        "g":  "8b5ef482f35ef9c0",
        "name":  "Loop result",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "loop_result",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  510,
        "y":  280,
        "wires":  [

                  ]
    },
    {
        "id":  "ce0d5547e473555e",
        "type":  "debug",
        "z":  "acde727d4cb42aaa",
        "g":  "5b3831da1b35bb1d",
        "name":  "Done",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  false,
        "complete":  "payload",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  830,
        "y":  360,
        "wires":  [

                  ]
    },
    {
        "id":  "64dc39c70599dfc4",
        "type":  "server-state-changed",
        "z":  "acde727d4cb42aaa",
        "g":  "5b3831da1b35bb1d",
        "name":  "Master control mode",
        "server":  "176d29a.6f648d6",
        "version":  6,
        "outputs":  1,
        "exposeAsEntityConfig":  "",
        "entities":  {
                         "entity":  [
                                        "input_select.marstek_master_battery_mode"
                                    ],
                         "substring":  [

                                       ],
                         "regex":  [

                                   ]
                     },
        "outputInitially":  false,
        "stateType":  "str",
        "ifState":  "",
        "ifStateType":  "str",
        "ifStateOperator":  "is",
        "outputOnlyOnStateChange":  true,
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "ignorePrevStateNull":  false,
        "ignorePrevStateUnknown":  false,
        "ignorePrevStateUnavailable":  false,
        "ignoreCurrentStateUnknown":  false,
        "ignoreCurrentStateUnavailable":  false,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "eventData"
                                 },
                                 {
                                     "property":  "topic",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "triggerId"
                                 },
                                 {
                                     "property":  "marstek_master_battery_mode",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 }
                             ],
        "x":  150,
        "y":  60,
        "wires":  [
                      [
                          "b9f84cc9f5a92c37"
                      ]
                  ]
    },
    {
        "id":  "176d29a.6f648d6",
        "type":  "server",
        "name":  "Home Assistant",
        "addon":  true,
        "rejectUnauthorizedCerts":  true,
        "ha_boolean":  "",
        "connectionDelay":  false,
        "cacheJson":  false,
        "heartbeat":  false,
        "heartbeatInterval":  "",
        "statusSeparator":  "",
        "enableGlobalContextStore":  false
    },
    {
        "id":  "f464264ff0889d6b",
        "type":  "global-config",
        "env":  [

                ],
        "modules":  {
                        "node-red-contrib-home-assistant-websocket":  "0.80.0"
                    }
    },
    {
        "id":  "900dac71a5028dca",
        "type":  "tab",
        "label":  "Home Battery PID presets",
        "disabled":  false,
        "info":  "",
        "env":  [

                ]
    },
    {
        "id":  "e44a5d4c33f3cab1",
        "type":  "group",
        "z":  "900dac71a5028dca",
        "name":  "PID presets",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "4ea9a477ecf0c446",
                      "25b5a08a5bf89ac0",
                      "8feaf80456317a3e",
                      "570ba6efb8eb8dc7",
                      "f91f14aa5a48bda6",
                      "6ef258c42572df05",
                      "54fa9aa06d0d9224"
                  ],
        "x":  34,
        "y":  19,
        "w":  632,
        "h":  242
    },
    {
        "id":  "4ea9a477ecf0c446",
        "type":  "server-state-changed",
        "z":  "900dac71a5028dca",
        "g":  "e44a5d4c33f3cab1",
        "name":  "PID preset selected",
        "server":  "176d29a.6f648d6",
        "version":  6,
        "outputs":  1,
        "exposeAsEntityConfig":  "",
        "entities":  {
                         "entity":  [
                                        "input_select.house_battery_control_pid_presets"
                                    ],
                         "substring":  [

                                       ],
                         "regex":  [

                                   ]
                     },
        "outputInitially":  false,
        "stateType":  "str",
        "ifState":  "",
        "ifStateType":  "str",
        "ifStateOperator":  "is",
        "outputOnlyOnStateChange":  true,
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "ignorePrevStateNull":  false,
        "ignorePrevStateUnknown":  false,
        "ignorePrevStateUnavailable":  false,
        "ignoreCurrentStateUnknown":  false,
        "ignoreCurrentStateUnavailable":  false,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "eventData"
                                 },
                                 {
                                     "property":  "topic",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "triggerId"
                                 }
                             ],
        "x":  150,
        "y":  100,
        "wires":  [
                      [
                          "f91f14aa5a48bda6"
                      ]
                  ]
    },
    {
        "id":  "25b5a08a5bf89ac0",
        "type":  "api-call-service",
        "z":  "900dac71a5028dca",
        "g":  "e44a5d4c33f3cab1",
        "name":  "Kp",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_kp"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  510,
        "y":  60,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "8feaf80456317a3e",
        "type":  "api-call-service",
        "z":  "900dac71a5028dca",
        "g":  "e44a5d4c33f3cab1",
        "name":  "Ki",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_ki"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  510,
        "y":  100,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "570ba6efb8eb8dc7",
        "type":  "api-call-service",
        "z":  "900dac71a5028dca",
        "g":  "e44a5d4c33f3cab1",
        "name":  "Kd",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_kd"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  510,
        "y":  140,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "f91f14aa5a48bda6",
        "type":  "function",
        "z":  "900dac71a5028dca",
        "g":  "e44a5d4c33f3cab1",
        "name":  "Presets",
        "func":  "// See: house_battery_control.yaml \u003e input_select: \u003e house_battery_control_pid_presets\nconst preset = RED.util.getMessageProperty(msg,\"payload\");\nnode.status({fill:\"green\",shape:\"dot\",text:`${preset}`});\n\n\n// Default values\nlet Kp = 0; // Proportional gain\nlet Ki = 0; // Integral gain\nlet Kd = 0; // Differentiating gain\nlet Si = 0; // % Input smoothing (a Low pass moving average filter)\nlet So = 0; // % Output smoothing (a Low pass moving average filter)\n\nswitch (preset) {\n    // For people who have unstable systems with every other preset\n    case \"Very safe\":\n        Kp = 0.1;\n        Ki = 0.1;\n        Si = 0; // without Kd, this is preferred to be zero.\n        So = 10; // %\n        break;\n    // Good starting point for most\n    case \"Safe\":\n        Kp = 0.3;\n        Ki = 0.3;\n        Kd = 0.1;\n        Si = 20; // %\n        So = 0; // %\n        break;\n    // Gitcodebob\u0027s October 2025 settings for 3.2kWp PV and 5kW battery transformer power\n    case \"Regular\":\n        Kp = 0.3;\n        Ki = 0.4;\n        Kd = 0.8;\n        Si = 50; // % This high amount of filtering allows the stronger Kd\n        So = 10; // %\n        break;\n    default:\n        // Don\u0027t change values\n        return null;\n}\n\n// Prepare for three outputs\nreturn [\n    { \"payload\": Kp },\n    { \"payload\": Ki },\n    { \"payload\": Kd },\n    { \"payload\": Si },\n    { \"payload\": So }\n];",
        "outputs":  5,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  320,
        "y":  100,
        "wires":  [
                      [
                          "25b5a08a5bf89ac0"
                      ],
                      [
                          "8feaf80456317a3e"
                      ],
                      [
                          "570ba6efb8eb8dc7"
                      ],
                      [
                          "6ef258c42572df05"
                      ],
                      [
                          "54fa9aa06d0d9224"
                      ]
                  ]
    },
    {
        "id":  "6ef258c42572df05",
        "type":  "api-call-service",
        "z":  "900dac71a5028dca",
        "g":  "e44a5d4c33f3cab1",
        "name":  "Input Smooth",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_error_signal_dampening"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  530,
        "y":  180,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "54fa9aa06d0d9224",
        "type":  "api-call-service",
        "z":  "900dac71a5028dca",
        "g":  "e44a5d4c33f3cab1",
        "name":  "Output Smoothing",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_pid_output_dampening"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  550,
        "y":  220,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "176d29a.6f648d6",
        "type":  "server",
        "name":  "Home Assistant",
        "addon":  true,
        "rejectUnauthorizedCerts":  true,
        "ha_boolean":  "",
        "connectionDelay":  false,
        "cacheJson":  false,
        "heartbeat":  false,
        "heartbeatInterval":  "",
        "statusSeparator":  "",
        "enableGlobalContextStore":  false
    },
    {
        "id":  "7f5460695ee75513",
        "type":  "tab",
        "label":  "Home Battery Start v4.4.0",
        "disabled":  false,
        "info":  "# Home battery control\r\nConsists of three flows:\r\n 1.  Start flow\r\n 1.  Control flow\r\n 1.  Master switch flow\r\n\r\n## Start flow\r\nThis is the starting point of your home battery control.\r\n\r\nIt starts with P1 measurement as a trigger.\r\nIt allows you to connect your battery sensors to the flow.\r\nIt ends with a function node, mapping your batteries to a battery_array\r\n\r\nThe battery_array is passed on to the control flow.\r\n\r\nWhen the control flow has calculated the desired corrections,\r\nit is passed back to this flow and applied to your batteries.",
        "env":  [

                ]
    },
    {
        "id":  "e236d97d2cb590c2",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Start",
        "style":  {
                      "label":  true,
                      "stroke":  "#009ac7"
                  },
        "nodes":  [
                      "02105df21fd3f154",
                      "521830dd997fb760",
                      "2d1c249bb1372a6f"
                  ],
        "x":  34,
        "y":  19,
        "w":  652,
        "h":  82
    },
    {
        "id":  "617afc9cbb21c3aa",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Strategy selection",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "fd6f71b6d259a253",
                      "870c65331d4de04a",
                      "0a2f9e785f1ac084",
                      "b9a2d758a783451c",
                      "75e246686f8995fa",
                      "ad80e4c14044b9c3",
                      "e582ef72f9409841",
                      "389c20eb60815daa"
                  ],
        "x":  34,
        "y":  839,
        "w":  812,
        "h":  162
    },
    {
        "id":  "bea22cae65f8e9d5",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Get batteries information",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "3b96a3df1fe485d0",
                      "3adf017d0a8c68f1",
                      "4475679b8f0c9a3f",
                      "2a93575110ffee22",
                      "c256db967cf5dccc",
                      "a6a78389c0ab1103",
                      "8444b99d3d720a22",
                      "631e6ef53280c103"
                  ],
        "x":  34,
        "y":  379,
        "w":  1678,
        "h":  242
    },
    {
        "id":  "ce0f62beb80fb964",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "On deploy and global logger",
        "style":  {
                      "label":  true,
                      "stroke":  "#92d04f"
                  },
        "nodes":  [
                      "e693695841a12ac8",
                      "eeebb84fc6def5c6",
                      "865a81da38673369"
                  ],
        "x":  1294,
        "y":  19,
        "w":  592,
        "h":  82
    },
    {
        "id":  "21298cd658864626",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Set Batteries",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "bb6f3cf4edb4f977",
                      "352483664e820fd7",
                      "e5555fd58dfee589",
                      "d7fbf710d03761d6",
                      "d0ce241d9ea6f086",
                      "3f0b8cc39f691728",
                      "af4ca03218ec55a8"
                  ],
        "x":  34,
        "y":  1019,
        "w":  858,
        "h":  342
    },
    {
        "id":  "9ac08b1aad767c5c",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Battery priority",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "d052cbb2f10625cd",
                      "b97a2b2a5acdfc07",
                      "c85ac0d07531991d",
                      "d089c6f978c961dc",
                      "704760e15e517c51",
                      "4999c7c0edd04f97",
                      "a80ff70aaad78903",
                      "534e46973fed8a7d",
                      "3406580ca55f7cad"
                  ],
        "x":  34,
        "y":  739,
        "w":  1852,
        "h":  82
    },
    {
        "id":  "f2ed876cb907fed0",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Calculate totals",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "5c1e81677075b9b2"
                  ],
        "x":  34,
        "y":  639,
        "w":  212,
        "h":  82
    },
    {
        "id":  "73a209cdfb340e2c",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Rate limiter",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "34613848a6705d55",
                      "e2734a25bdd9bb39",
                      "198b7abaf4ea58d5",
                      "f8f7bdd49c35a132",
                      "b4673e76e39534f9",
                      "2b08b7c04ae567cc",
                      "da4ad49d21e836d6",
                      "9ef721615468fb63",
                      "ca04c6dab2cdd767",
                      "0f02732cd4c432b1"
                  ],
        "x":  34,
        "y":  219,
        "w":  1402,
        "h":  122
    },
    {
        "id":  "e00f6aabc81f50d8",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Update UI: debug dashboard",
        "style":  {
                      "label":  true,
                      "stroke":  "#3f5787"
                  },
        "nodes":  [
                      "e1e1a146910ee317",
                      "bf4561c98529266b",
                      "a5ce8fa89d580ec2",
                      "21e1c111622cfdf6",
                      "a75be4dcdbf976de",
                      "f482d76d148c4843"
                  ],
        "x":  1234,
        "y":  1219,
        "w":  632,
        "h":  202
    },
    {
        "id":  "9fa096c047eb284a",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Update UI: usable energy",
        "style":  {
                      "label":  true,
                      "stroke":  "#3f5787"
                  },
        "nodes":  [
                      "dd27de3cbba4d663",
                      "5ea1d7f0e5defb34"
                  ],
        "x":  1474,
        "y":  639,
        "w":  412,
        "h":  82
    },
    {
        "id":  "4ae6ca31e75c67a6",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Update UI: active sub-strategy",
        "style":  {
                      "label":  true,
                      "stroke":  "#3f5787"
                  },
        "nodes":  [
                      "1de0dd76b0f5d05a",
                      "b304e1aea4e4c595",
                      "3c1651104fca1edd"
                  ],
        "x":  1254,
        "y":  919,
        "w":  632,
        "h":  82
    },
    {
        "id":  "cdc369e394194098",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Insight",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "de7fd17c236aa837",
                      "d14ce10d1801776b",
                      "5ad26a3d44faed29",
                      "b01c579b8c3811a2",
                      "62252f491c4da1ea"
                  ],
        "x":  34,
        "y":  119,
        "w":  852,
        "h":  82
    },
    {
        "id":  "ec3ddc2036ced526",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Log and Error handling",
        "style":  {
                      "stroke":  "#ff3f3f",
                      "label":  true
                  },
        "nodes":  [
                      "ebf13a696e1103d4",
                      "15a8447d656db5a6"
                  ],
        "x":  1634,
        "y":  119,
        "w":  252,
        "h":  142
    },
    {
        "id":  "220907b737bc4473",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "name":  "Unhandled exceptions",
        "style":  {
                      "label":  true,
                      "stroke":  "#d88a8a",
                      "color":  "#d88a8a"
                  },
        "nodes":  [
                      "c6435283baa61870",
                      "046207800a78a6b8",
                      "220f903862df4c11"
                  ],
        "x":  1704,
        "y":  279,
        "w":  182,
        "h":  82
    },
    {
        "id":  "c256db967cf5dccc",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "g":  "bea22cae65f8e9d5",
        "name":  "Loop",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "c1dc366a95ab39fb",
                      "d817dffdc25bf134",
                      "314138d90b7039a4",
                      "53b79e31f72d3d06",
                      "8fa7e0ebb2c9fc2a",
                      "c31eede04af7c0de",
                      "14e87e8913158506",
                      "2586ea7beeb67ff1",
                      "a110998f48a4695a",
                      "2e2223c87c18f763"
                  ],
        "x":  74,
        "y":  459,
        "w":  1612,
        "h":  82
    },
    {
        "id":  "d7fbf710d03761d6",
        "type":  "group",
        "z":  "7f5460695ee75513",
        "g":  "21298cd658864626",
        "name":  "Loop",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "d98f534e50c7d44e",
                      "2041773d947f3c33",
                      "0b66e5e9b4c1a35e",
                      "59277e9cb2fbf7a1",
                      "19e190d2c14c6e16",
                      "51cf0ebb503e1325",
                      "7541d9a9301c62cf"
                  ],
        "x":  314,
        "y":  1059,
        "w":  552,
        "h":  222
    },
    {
        "id":  "9f254ea4ab071dd8",
        "type":  "junction",
        "z":  "7f5460695ee75513",
        "x":  40,
        "y":  360,
        "wires":  [
                      [
                          "2a93575110ffee22"
                      ]
                  ]
    },
    {
        "id":  "02105df21fd3f154",
        "type":  "server-state-changed",
        "z":  "7f5460695ee75513",
        "g":  "e236d97d2cb590c2",
        "name":  "P1 meter",
        "server":  "176d29a.6f648d6",
        "version":  6,
        "outputs":  1,
        "exposeAsEntityConfig":  "",
        "entities":  {
                         "entity":  [
                                        "sensor.p1_meter_power"
                                    ],
                         "substring":  [

                                       ],
                         "regex":  [

                                   ]
                     },
        "outputInitially":  false,
        "stateType":  "str",
        "ifState":  "",
        "ifStateType":  "str",
        "ifStateOperator":  "is",
        "outputOnlyOnStateChange":  false,
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "ignorePrevStateNull":  true,
        "ignorePrevStateUnknown":  true,
        "ignorePrevStateUnavailable":  true,
        "ignoreCurrentStateUnknown":  true,
        "ignoreCurrentStateUnavailable":  true,
        "outputProperties":  [
                                 {
                                     "property":  "grid_power",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "eventData"
                                 },
                                 {
                                     "property":  "topic",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "triggerId"
                                 },
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "timestamp",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "date"
                                 }
                             ],
        "x":  120,
        "y":  60,
        "wires":  [
                      [
                          "521830dd997fb760"
                      ]
                  ]
    },
    {
        "id":  "521830dd997fb760",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "e236d97d2cb590c2",
        "name":  "Master Control Mode",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.marstek_master_battery_mode",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "master_mode",
                                     "propertyType":  "flow",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  300,
        "y":  60,
        "wires":  [
                      [
                          "2d1c249bb1372a6f"
                      ]
                  ]
    },
    {
        "id":  "2d1c249bb1372a6f",
        "type":  "switch",
        "z":  "7f5460695ee75513",
        "g":  "e236d97d2cb590c2",
        "name":  "when in \"Full Control\" mode",
        "property":  "payload",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "Full control",
                          "vt":  "str"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  1,
        "x":  540,
        "y":  60,
        "wires":  [
                      [
                          "de7fd17c236aa837"
                      ]
                  ]
    },
    {
        "id":  "fd6f71b6d259a253",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "617afc9cbb21c3aa",
        "name":  "Battery Strategy",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.house_battery_strategy",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy",
                                     "propertyType":  "flow",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  140,
        "y":  880,
        "wires":  [
                      [
                          "e582ef72f9409841"
                      ]
                  ]
    },
    {
        "id":  "870c65331d4de04a",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "617afc9cbb21c3aa",
        "name":  "Strategy selection",
        "func":  "// Logger\nconst logger = global.get(\"logger\");\n\n// INFLOW\nlet strategy = flow.get(\"house_battery_strategy\");\n\n// Configure msg.strategy object\nRED.util.setMessageProperty(msg,\"strategy.selected\",strategy,true);\nRED.util.setMessageProperty(msg,\"strategy.trace\",[],true);\n\n// stop on error\nif(msg.batteries === undefined) {\n    logger(this, \"Battery configuration undefined\", \"error\");\n    return null;\n}\nif(strategy === undefined) {\n    logger(this, \"Battery strategy undefined\", \"error\");\n    return null;\n}\n\n// select target flow based on the input_select `house_battery_strategy`\nmsg.target = `${strategy}`;\n\n// full stop trigger overrules ALL selected strategies\nconst stopTrigger = RED.util.getMessageProperty(msg,\"full_stop_trigger\");\nif(stopTrigger == \"on\" || stopTrigger === true || stopTrigger === 1) {\n    msg.target = \u0027Full stop\u0027;\n    // Explain\n    logger(this, `**Full Stop** strategy selected, due to (EV) stop trigger: \u0027${stopTrigger}\u0027`);\n}\n\n// add execution marker\nRED.util.setMessageProperty(msg,\"strategy.execution_start\",Date.now()); // when do we start executing the selected strategy\n\n// OUTPUT\nnode.status({fill:\"grey\",shape:\"dot\",text:msg.target});\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  410,
        "y":  880,
        "wires":  [
                      [
                          "b9a2d758a783451c",
                          "0a2f9e785f1ac084"
                      ]
                  ]
    },
    {
        "id":  "0a2f9e785f1ac084",
        "type":  "link call",
        "z":  "7f5460695ee75513",
        "g":  "617afc9cbb21c3aa",
        "name":  "Call \"Link in\" node",
        "links":  [

                  ],
        "linkType":  "dynamic",
        "timeout":  "1.2",
        "x":  410,
        "y":  920,
        "wires":  [
                      [
                          "75e246686f8995fa",
                          "ad80e4c14044b9c3"
                      ]
                  ]
    },
    {
        "id":  "b9a2d758a783451c",
        "type":  "debug",
        "z":  "7f5460695ee75513",
        "g":  "617afc9cbb21c3aa",
        "name":  "Input msg",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "true",
        "targetType":  "full",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  680,
        "y":  880,
        "wires":  [

                  ]
    },
    {
        "id":  "75e246686f8995fa",
        "type":  "debug",
        "z":  "7f5460695ee75513",
        "g":  "617afc9cbb21c3aa",
        "name":  "Returned msg",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "true",
        "targetType":  "full",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  700,
        "y":  920,
        "wires":  [

                  ]
    },
    {
        "id":  "ad80e4c14044b9c3",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "617afc9cbb21c3aa",
        "name":  "Strategy evaluation",
        "func":  "// add execution marker\nlet execution_end = Date.now();\nRED.util.setMessageProperty(msg, \"strategy.execution_end\", execution_end);\n\n// retrieve execution markers\nlet execution_start = RED.util.getMessageProperty(msg,\"strategy.execution_start\");\n\n// report execution time\nif (execution_start !== undefined \u0026\u0026 execution_end !== undefined) {\n    // exec time\n    let execution_time = (execution_end - execution_start) / 1000; // seconds\n    // report\n    if (execution_time \u003c= 0) node.status({ fill: \"red\", shape: \"dot\", text: `negative or zero timing` });\n    if (execution_time \u003e 0) node.status({ fill: \"green\", shape: \"dot\", text: `${execution_time} sec`});\n    if (execution_time \u003e= 0.7) node.status({ fill: \"yellow\", shape: \"dot\", text: `${execution_time} sec` });\n    if (execution_time \u003e= 1) node.status({ fill: \"red\", shape: \"dot\", text: `${execution_time} sec` });\n\n} else {\n    node.status({fill:\"grey\",shape:\"dot\",text:\"timing error\"});\n}\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  410,
        "y":  960,
        "wires":  [
                      [
                          "e5555fd58dfee589",
                          "389c20eb60815daa",
                          "1de0dd76b0f5d05a"
                      ]
                  ]
    },
    {
        "id":  "3b96a3df1fe485d0",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "bea22cae65f8e9d5",
        "name":  "Loop start",
        "func":  "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// Init an array for battery status and value information\nmsg.batteries = [];\n\n// Continue\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  320,
        "y":  420,
        "wires":  [
                      [
                          "c1dc366a95ab39fb"
                      ]
                  ]
    },
    {
        "id":  "a6a78389c0ab1103",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "bea22cae65f8e9d5",
        "name":  "Mapping",
        "func":  "// Map to batteries array\nmsg.batteries.push({\n    id: `M${msg.battery_index}`,\n    power: parseInt(msg.battery_power,10),\n    charging_max: parseInt(msg.max_charge_power,10),\n    discharging_max: parseInt(msg.max_discharge_power,10),\n    soc: parseInt(msg.battery_state_of_charge,10),\n    soc_max: parseInt(msg.charging_cutoff_capacity,10),\n    soc_min: parseInt(msg.discharging_cutoff_capacity,10),\n    inverter: String(msg.inverter_state),\n    energy: Number(msg.battery_remaining_capacity),\n    energy_max: Number(msg.battery_total_energy),\n    rs485: String(msg.rs485_control_mode)\n    });\n\n// Continue\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  140,
        "y":  580,
        "wires":  [
                      [
                          "8444b99d3d720a22"
                      ]
                  ]
    },
    {
        "id":  "3adf017d0a8c68f1",
        "type":  "switch",
        "z":  "7f5460695ee75513",
        "g":  "bea22cae65f8e9d5",
        "name":  "Loop until",
        "property":  "battery_index",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "lte",
                          "v":  "battery_count",
                          "vt":  "msg"
                      },
                      {
                          "t":  "else"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  2,
        "x":  420,
        "y":  580,
        "wires":  [
                      [
                          "c1dc366a95ab39fb"
                      ],
                      [
                          "631e6ef53280c103"
                      ]
                  ]
    },
    {
        "id":  "4475679b8f0c9a3f",
        "type":  "debug",
        "z":  "7f5460695ee75513",
        "g":  "bea22cae65f8e9d5",
        "name":  "Loop result",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "true",
        "targetType":  "full",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  770,
        "y":  580,
        "wires":  [

                  ]
    },
    {
        "id":  "2a93575110ffee22",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "bea22cae65f8e9d5",
        "name":  "Your battery count",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_count",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "battery_count",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  150,
        "y":  420,
        "wires":  [
                      [
                          "3b96a3df1fe485d0"
                      ]
                  ]
    },
    {
        "id":  "c1dc366a95ab39fb",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "c256db967cf5dccc",
        "name":  "Control mode",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "select.marstek_m{{battery_index}}_rs485_control_mode",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "rs485_control_mode",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  180,
        "y":  500,
        "wires":  [
                      [
                          "14e87e8913158506"
                      ]
                  ]
    },
    {
        "id":  "d817dffdc25bf134",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "c256db967cf5dccc",
        "name":  "SoC",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "sensor.marstek_m{{battery_index}}_battery_state_of_charge",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "battery_state_of_charge",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  870,
        "y":  500,
        "wires":  [
                      [
                          "a110998f48a4695a"
                      ]
                  ]
    },
    {
        "id":  "314138d90b7039a4",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "c256db967cf5dccc",
        "name":  "Inverter state",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "sensor.marstek_m{{battery_index}}_inverter_state",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "inverter_state",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  1290,
        "y":  500,
        "wires":  [
                      [
                          "8fa7e0ebb2c9fc2a"
                      ]
                  ]
    },
    {
        "id":  "53b79e31f72d3d06",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "c256db967cf5dccc",
        "name":  "Max discharge power",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "number.marstek_m{{battery_index}}_max_discharge_power",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "max_discharge_power",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  700,
        "y":  500,
        "wires":  [
                      [
                          "d817dffdc25bf134"
                      ]
                  ]
    },
    {
        "id":  "8fa7e0ebb2c9fc2a",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "c256db967cf5dccc",
        "name":  "Energy",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "sensor.marstek_m{{battery_index}}_battery_remaining_capacity",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "battery_remaining_capacity",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  1440,
        "y":  500,
        "wires":  [
                      [
                          "2586ea7beeb67ff1"
                      ]
                  ]
    },
    {
        "id":  "c31eede04af7c0de",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "c256db967cf5dccc",
        "name":  "Max charge power",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "number.marstek_m{{battery_index}}_max_charge_power",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "max_charge_power",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  490,
        "y":  500,
        "wires":  [
                      [
                          "53b79e31f72d3d06"
                      ]
                  ]
    },
    {
        "id":  "14e87e8913158506",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "c256db967cf5dccc",
        "name":  "Power",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "sensor.marstek_m{{battery_index}}_battery_power",
        "state_type":  "str",
        "blockInputOverrides":  false,
        "outputProperties":  [
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "battery_power",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  330,
        "y":  500,
        "wires":  [
                      [
                          "c31eede04af7c0de"
                      ]
                  ]
    },
    {
        "id":  "e693695841a12ac8",
        "type":  "api-call-service",
        "z":  "7f5460695ee75513",
        "g":  "ce0f62beb80fb964",
        "name":  "Node-RED status: OK",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_boolean.turn_on",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_boolean.house_battery_control_has_node_red"
                     ],
        "labelId":  [

                    ],
        "data":  "",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  false,
        "domain":  "input_boolean",
        "service":  "turn_on",
        "x":  1760,
        "y":  60,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "eeebb84fc6def5c6",
        "type":  "inject",
        "z":  "7f5460695ee75513",
        "g":  "ce0f62beb80fb964",
        "name":  "On deploy",
        "props":  [
                      {
                          "p":  "payload"
                      },
                      {
                          "p":  "topic",
                          "vt":  "str"
                      }
                  ],
        "repeat":  "",
        "crontab":  "",
        "once":  true,
        "onceDelay":  "0.1",
        "topic":  "",
        "payload":  "",
        "payloadType":  "date",
        "x":  1410,
        "y":  60,
        "wires":  [
                      [
                          "865a81da38673369",
                          "ebf13a696e1103d4"
                      ]
                  ]
    },
    {
        "id":  "d98f534e50c7d44e",
        "type":  "api-call-service",
        "z":  "7f5460695ee75513",
        "g":  "d7fbf710d03761d6",
        "name":  "Set mode (charge/discharge/stop)",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [

                     ],
        "labelId":  [

                    ],
        "data":  "",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  false,
        "domain":  "input_text",
        "service":  "set_value",
        "x":  660,
        "y":  1100,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "2041773d947f3c33",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "d7fbf710d03761d6",
        "name":  "Set Batteries",
        "func":  "// Logger\nconst log = global.get(\"logger\");\n\n// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n// Output format and target\nlet outputArray = [];\nlet solution = msg.solutions[msg.battery_index-1]; // Base-0, thus -1\nif (solution === undefined) {\n    log(this,`Can\u0027t find solution for index ${msg.battery_index - 1} in ${msg.solutions}, aborting...`,\"error\");\n    return null;\n}\nlet target = `marstek_${solution.id.toLowerCase()}`;\n\n// Safety | Id exists\nlet battery = msg.batteries.find(battery =\u003e battery.id === solution.id);\nif (battery === undefined) {\n    log(`Can\u0027t set battery ${solution.id}, aborting...`,\"error\");\n    return null;\n}\n// Safety | Power limit\nsolution.power = Math.min(solution.power, solution.mode == CMODE.CHARGE ? battery.charging_max: battery.discharging_max);\n\n// Set | Mode\nconst serviceCallMode = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_forcible_charge_discharge`]\n    },\n    \"data\": {\n         \"option\": String(solution.mode) // forced charge mode (stop, charge, discharge)\n    }\n};\n// Add topic to allow correct \u0027on change\u0027 filtering\noutputArray.push({payload: serviceCallMode, topic:solution.id});\n\n// Set | Power\nconst serviceCallPower = {\n    \"action\": \"number.set_value\",\n    \"target\": {\n        \"entity_id\": [\n            `number.${target}_forcible_charge_power`,\n            `number.${target}_forcible_discharge_power`\n            ]\n    },\n    \"data\": {\n        \"value\": Number(solution.power)\n    } \n};\n// Add topic to allow correct \u0027on change\u0027 filtering\noutputArray.push({payload: serviceCallPower, topic:solution.id});\n\n// Store service calls in msg to allow checking of loop results\nmsg.loop_result = { target, serviceCallMode, serviceCallPower };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Explain\nlog(this,`${target} ${String(solution.mode)} @ ${Number(solution.power)} Watt`);\n\n// Output\nreturn outputArray;",
        "outputs":  3,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  410,
        "y":  1140,
        "wires":  [
                      [
                          "d98f534e50c7d44e"
                      ],
                      [
                          "7541d9a9301c62cf"
                      ],
                      [
                          "59277e9cb2fbf7a1"
                      ]
                  ],
        "inputLabels":  [
                            "Msg with a battery_index"
                        ],
        "outputLabels":  [
                             "Select MODE",
                             "Set POWER",
                             "Msg"
                         ]
    },
    {
        "id":  "bb6f3cf4edb4f977",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "21298cd658864626",
        "name":  "Loop start",
        "func":  "// loop through the number of batteries set by the user\nmsg.battery_index = msg.battery_count;\n\n// Debug\nRED.util.setMessageProperty(msg, \"debug\", `## Cohort ${Date.now()} ##`);\n\n// Continue\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  120,
        "y":  1140,
        "wires":  [
                      [
                          "2041773d947f3c33"
                      ]
                  ]
    },
    {
        "id":  "0b66e5e9b4c1a35e",
        "type":  "switch",
        "z":  "7f5460695ee75513",
        "g":  "d7fbf710d03761d6",
        "name":  "Loop until",
        "property":  "battery_index",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "gt",
                          "v":  "0",
                          "vt":  "num"
                      },
                      {
                          "t":  "else"
                      }
                  ],
        "checkall":  "false",
        "repair":  false,
        "outputs":  2,
        "x":  740,
        "y":  1200,
        "wires":  [
                      [
                          "2041773d947f3c33"
                      ],
                      [
                          "d0ce241d9ea6f086"
                      ]
                  ]
    },
    {
        "id":  "59277e9cb2fbf7a1",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "d7fbf710d03761d6",
        "name":  "Loop step",
        "func":  "// Step index down\nmsg.battery_index -= 1;\n\n// Continue\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  580,
        "y":  1200,
        "wires":  [
                      [
                          "0b66e5e9b4c1a35e",
                          "51cf0ebb503e1325"
                      ]
                  ]
    },
    {
        "id":  "19e190d2c14c6e16",
        "type":  "api-call-service",
        "z":  "7f5460695ee75513",
        "g":  "d7fbf710d03761d6",
        "name":  "Set power (W)",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [

                     ],
        "labelId":  [

                    ],
        "data":  "",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  false,
        "domain":  "input_text",
        "service":  "set_value",
        "x":  760,
        "y":  1140,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "352483664e820fd7",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "21298cd658864626",
        "name":  "Timing start",
        "func":  "RED.util.setMessageProperty(msg,\"setbatteries.execution_start\",Date.now());\nRED.util.setMessageProperty(msg,\"setbatteries.marker\", `M1_${Date.now()}`);\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  130,
        "y":  1100,
        "wires":  [
                      [
                          "bb6f3cf4edb4f977"
                      ]
                  ]
    },
    {
        "id":  "e5555fd58dfee589",
        "type":  "switch",
        "z":  "7f5460695ee75513",
        "g":  "21298cd658864626",
        "name":  "solutions present",
        "property":  "solutions",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "undefined",
                          "vt":  "jsonata"
                      },
                      {
                          "t":  "neq",
                          "v":  "undefined",
                          "vt":  "jsonata"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  2,
        "x":  150,
        "y":  1060,
        "wires":  [
                      [
                          "af4ca03218ec55a8"
                      ],
                      [
                          "352483664e820fd7"
                      ]
                  ]
    },
    {
        "id":  "d0ce241d9ea6f086",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "21298cd658864626",
        "name":  "Timing end",
        "func":  "let start = RED.util.getMessageProperty(msg,\"setbatteries.execution_start\");\nlet end = Date.now();\nlet delta = end - start;\nlet timingString = `${delta/1000} sec`;\n\nnode.status({fill:\"green\",shape:\"dot\",text: timingString});\nmsg.delta = delta;\nmsg.timing = timingString;\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  130,
        "y":  1320,
        "wires":  [
                      [
                          "3f0b8cc39f691728",
                          "bf4561c98529266b"
                      ]
                  ]
    },
    {
        "id":  "51cf0ebb503e1325",
        "type":  "debug",
        "z":  "7f5460695ee75513",
        "g":  "d7fbf710d03761d6",
        "name":  "Step result",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "loop_result",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  750,
        "y":  1240,
        "wires":  [

                  ]
    },
    {
        "id":  "7541d9a9301c62cf",
        "type":  "rbe",
        "z":  "7f5460695ee75513",
        "g":  "d7fbf710d03761d6",
        "name":  "on change",
        "func":  "rbe",
        "gap":  "",
        "start":  "",
        "inout":  "out",
        "septopics":  true,
        "property":  "payload",
        "topi":  "topic",
        "x":  590,
        "y":  1140,
        "wires":  [
                      [
                          "19e190d2c14c6e16"
                      ]
                  ]
    },
    {
        "id":  "3f0b8cc39f691728",
        "type":  "debug",
        "z":  "7f5460695ee75513",
        "g":  "21298cd658864626",
        "name":  "Done",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  false,
        "complete":  "debug",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  270,
        "y":  1320,
        "wires":  [

                  ]
    },
    {
        "id":  "8444b99d3d720a22",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "bea22cae65f8e9d5",
        "name":  "Loop step",
        "func":  "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  280,
        "y":  580,
        "wires":  [
                      [
                          "3adf017d0a8c68f1"
                      ]
                  ]
    },
    {
        "id":  "d052cbb2f10625cd",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "9ac08b1aad767c5c",
        "name":  "Update battery order",
        "func":  "// Cycles battery priority as follows\n// M=1 [1,2,3,4] | M=2 [2,3,4,1] | M=3 [3,4,1,2] | etc.\n// With M the battery to prioritize\n\n// msg.batteries (original order)\nlet currentArray = msg.batteries;\n\n// Prioritize the Mth battery\nconst M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// 1st battery has prio? Skip and continue without change\nif (M==1) return msg;\n\n// N equals the number of items to take from the front to the back of the array, effectivly rotating battery priority\nconst N = M - 1; // base-0 version of M\nnode.status({fill:\"blue\",shape:\"ring\",text:`N = ${N}`});\n\n// 1. Check if the array is valid and long enough\nif (!Array.isArray(currentArray) || currentArray.length \u003c N) {\n    // Send an error or the original array back if the array is invalid/too short\n    node.error(`Array is not valid or shorter than ${N} items.`, msg);\n    return null;\n}\n\n// 2. Get the first N items (these will go to the back)\n// slice(0, N) retrieves elements from the start (index 0) up to index N (exclusive).\nlet firstN = currentArray.slice(0, N);\n\n// 3. Get the remaining items (these will stay at the front)\n// slice(N) retrieves elements from index N to the end of the array.\nlet remaining = currentArray.slice(N);\n\n// 4. Concatenate them: remaining items (front) + first N items (back)\nlet newArray = remaining.concat(firstN);\n\n// 5. Place the new array back into msg.batteries\nmsg.batteries = newArray;\n\nreturn msg;\n",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  360,
        "y":  780,
        "wires":  [
                      [
                          "fd6f71b6d259a253"
                      ]
                  ]
    },
    {
        "id":  "b97a2b2a5acdfc07",
        "type":  "inject",
        "z":  "7f5460695ee75513",
        "g":  "9ac08b1aad767c5c",
        "name":  "Every day 02:00",
        "props":  [
                      {
                          "p":  "payload"
                      },
                      {
                          "p":  "topic",
                          "vt":  "str"
                      }
                  ],
        "repeat":  "",
        "crontab":  "00 02 * * *",
        "once":  false,
        "onceDelay":  "5",
        "topic":  "cycle_battery_priority",
        "payload":  "",
        "payloadType":  "date",
        "x":  610,
        "y":  780,
        "wires":  [
                      [
                          "a80ff70aaad78903"
                      ]
                  ]
    },
    {
        "id":  "c85ac0d07531991d",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "9ac08b1aad767c5c",
        "name":  "Change priority",
        "func":  "// Current prioritized battery is the Mth battery\nlet M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// Prioritize the next battery\nM += 1;\n\n// If the next battery does not exist, prioritize the first again\nif(M \u003e msg.battery_count) M = 1;\n\n// Pass along as payload\nmsg.payload = M;\n\n// Show which battery has priority\nnode.status({fill:\"green\",shape:\"dot\",text:`Prioritize battery #${M}`});\n\n// Done\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1540,
        "y":  780,
        "wires":  [
                      [
                          "4999c7c0edd04f97"
                      ]
                  ]
    },
    {
        "id":  "d089c6f978c961dc",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "9ac08b1aad767c5c",
        "name":  "Your battery count",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_count",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "battery_count",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  1350,
        "y":  780,
        "wires":  [
                      [
                          "c85ac0d07531991d"
                      ]
                  ]
    },
    {
        "id":  "704760e15e517c51",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "9ac08b1aad767c5c",
        "name":  "Prioritize battery M",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_control_prioritize_battery",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "prioritize_battery",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  150,
        "y":  780,
        "wires":  [
                      [
                          "d052cbb2f10625cd"
                      ]
                  ]
    },
    {
        "id":  "4999c7c0edd04f97",
        "type":  "api-call-service",
        "z":  "7f5460695ee75513",
        "g":  "9ac08b1aad767c5c",
        "name":  "Update prioritized battery",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_prioritize_battery"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  1750,
        "y":  780,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "a80ff70aaad78903",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "9ac08b1aad767c5c",
        "name":  "Desired interval",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.house_battery_control_priority_change_interval",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  800,
        "y":  780,
        "wires":  [
                      [
                          "534e46973fed8a7d"
                      ]
                  ]
    },
    {
        "id":  "534e46973fed8a7d",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "9ac08b1aad767c5c",
        "name":  "Check interval ",
        "func":  "// Manual priority, never pass\nif(msg.payload == \"Never\") {\n    node.status({fill:\"yellow\",shape:\"dot\",text:\"Auto cycle disabled\"});\n    return null;\n}\n\n// Daily interval, always pass\nif(msg.payload == \"Daily\") {\n    node.status({ fill: \"green\", shape: \"dot\", text: `Pass` });\n    return msg;\n}\n\n// Weekly interval\nconst today = new Date();\n// Get the day of the week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)\nconst dayOfWeek = today.getDay();\n\n// Check if the day is Sunday (which is represented by the number 0)\nif (dayOfWeek === 0) {\n    // If it is Sunday, pass\n    node.status({ fill: \"green\", shape: \"dot\", text: `Passed on Sunday` });\n    return msg;\n} else {\n    // If it is not Sunday, stop\n    node.status({ fill: \"yellow\", shape: \"dot\", text: `Halted, not Sunday` });\n    return null;\n}",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  980,
        "y":  780,
        "wires":  [
                      [
                          "3406580ca55f7cad"
                      ]
                  ]
    },
    {
        "id":  "3406580ca55f7cad",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "9ac08b1aad767c5c",
        "name":  "Current priority",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_control_prioritize_battery",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "prioritize_battery",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  1160,
        "y":  780,
        "wires":  [
                      [
                          "d089c6f978c961dc"
                      ]
                  ]
    },
    {
        "id":  "5c1e81677075b9b2",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "f2ed876cb907fed0",
        "name":  "Batteries (totals)",
        "func":  "// batteries | calculate total and max. power delivered by batteries\nlet batteries = msg.batteries;\nlet batteries_total_power = 0;\nlet batteries_max_charging_power = 0;\nlet batteries_max_discharging_power = 0;\nlet batteries_available_energy = 0;\nlet batteries_max_energy = 0;\n\nbatteries.forEach(battery =\u003e {\n    batteries_total_power += Number(battery.power);\n    batteries_max_charging_power += Number(battery.charging_max);\n    batteries_max_discharging_power += Number(battery.discharging_max);\n    batteries_available_energy += Number(battery.energy - battery.energy_max*battery.soc_min/100);\n    batteries_max_energy += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_total_power\", batteries_total_power, true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_charge_power\", batteries_max_charging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_discharge_power\", batteries_max_discharging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_available_energy\",batteries_available_energy,true); // kWh usable\nRED.util.setMessageProperty(msg, \"batteries_max_energy\", batteries_max_energy, true); // kWh usable\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  140,
        "y":  680,
        "wires":  [
                      [
                          "704760e15e517c51",
                          "5ea1d7f0e5defb34"
                      ]
                  ],
        "inputLabels":  [
                            "Mapping (from Home Battery IO)"
                        ]
    },
    {
        "id":  "2586ea7beeb67ff1",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "c256db967cf5dccc",
        "name":  "Energy max",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "sensor.marstek_m{{battery_index}}_battery_total_energy",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "battery_total_energy",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  1590,
        "y":  500,
        "wires":  [
                      [
                          "a6a78389c0ab1103"
                      ]
                  ]
    },
    {
        "id":  "631e6ef53280c103",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "bea22cae65f8e9d5",
        "name":  "Loop end",
        "func":  "// cleanup \ndelete msg.battery_index;\n\ndelete msg.battery_power;\ndelete msg.max_charge_power;\ndelete msg.max_discharge_power;\ndelete msg.battery_state_of_charge;\ndelete msg.charging_cutoff_capacity;\ndelete msg.discharging_cutoff_capacity;\ndelete msg.inverter_state;\ndelete msg.battery_remaining_capacity;\ndelete msg.battery_total_energy;\ndelete msg.rs485_control_mode;\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  580,
        "y":  580,
        "wires":  [
                      [
                          "4475679b8f0c9a3f",
                          "5c1e81677075b9b2"
                      ]
                  ]
    },
    {
        "id":  "dd27de3cbba4d663",
        "type":  "api-call-service",
        "z":  "7f5460695ee75513",
        "g":  "9fa096c047eb284a",
        "name":  "Set total usable energy",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_total_available_energy"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\":$$.batteries_available_energy}",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  1760,
        "y":  680,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "e582ef72f9409841",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "617afc9cbb21c3aa",
        "name":  "Full Stop Trigger",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "sensor.ev_is_charging",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "full_stop_trigger",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  140,
        "y":  940,
        "wires":  [
                      [
                          "870c65331d4de04a"
                      ]
                  ]
    },
    {
        "id":  "5ea1d7f0e5defb34",
        "type":  "rbe",
        "z":  "7f5460695ee75513",
        "g":  "9fa096c047eb284a",
        "name":  "On change",
        "func":  "rbe",
        "gap":  "",
        "start":  "",
        "inout":  "out",
        "septopics":  false,
        "property":  "batteries_available_energy",
        "topi":  "topic",
        "x":  1570,
        "y":  680,
        "wires":  [
                      [
                          "dd27de3cbba4d663"
                      ]
                  ]
    },
    {
        "id":  "34613848a6705d55",
        "type":  "switch",
        "z":  "7f5460695ee75513",
        "g":  "73a209cdfb340e2c",
        "name":  "Select rate limit",
        "property":  "p1_rate_limit.save_power",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "true"
                      },
                      {
                          "t":  "false"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  2,
        "x":  660,
        "y":  280,
        "wires":  [
                      [
                          "f8f7bdd49c35a132"
                      ],
                      [
                          "198b7abaf4ea58d5"
                      ]
                  ]
    },
    {
        "id":  "e2734a25bdd9bb39",
        "type":  "delay",
        "z":  "7f5460695ee75513",
        "g":  "73a209cdfb340e2c",
        "name":  "Rate limit",
        "pauseType":  "rate",
        "timeout":  "5",
        "timeoutUnits":  "seconds",
        "rate":  "1",
        "nbRateUnits":  "3",
        "rateUnits":  "second",
        "randomFirst":  "1",
        "randomLast":  "5",
        "randomUnits":  "seconds",
        "drop":  true,
        "allowrate":  true,
        "outputs":  2,
        "x":  980,
        "y":  280,
        "wires":  [
                      [
                          "da4ad49d21e836d6"
                      ],
                      [
                          "9ef721615468fb63"
                      ]
                  ],
        "outputLabels":  [
                             "Pass",
                             ""
                         ]
    },
    {
        "id":  "198b7abaf4ea58d5",
        "type":  "change",
        "z":  "7f5460695ee75513",
        "g":  "73a209cdfb340e2c",
        "name":  "1 msg/s",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "rate",
                          "pt":  "msg",
                          "to":  "1000",
                          "tot":  "num"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  820,
        "y":  300,
        "wires":  [
                      [
                          "e2734a25bdd9bb39"
                      ]
                  ]
    },
    {
        "id":  "f8f7bdd49c35a132",
        "type":  "change",
        "z":  "7f5460695ee75513",
        "g":  "73a209cdfb340e2c",
        "name":  "0.333 msg/s",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "rate",
                          "pt":  "msg",
                          "to":  "3000",
                          "tot":  "num"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  830,
        "y":  260,
        "wires":  [
                      [
                          "e2734a25bdd9bb39"
                      ]
                  ]
    },
    {
        "id":  "b4673e76e39534f9",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "73a209cdfb340e2c",
        "name":  "P1 change (20W or 2%)",
        "func":  "// Switch between low and high rate limiting to decrease load and power consumption\n// --\n// The flow should always be rate limited by atleast the total execution time of strategies\n// The flow should not lock up indefinitly when grid_power is constant.\n// In the latter case, a more relaxed rate limit can help reduce system load.\n// Devs: don\u0027t set msg.rate directly. Use nodes, so novice users can easily read the flow.\n\n// Thresholds for change in power, before switching to high rate limit\nconst THRESHOLD_POWER = 20; // Watt change\nconst THRESHOLD_PERCENT = 2; // Percentage\nRED.util.setMessageProperty(msg, \"p1_rate_limit.threshold_power\", THRESHOLD_POWER,true);\nRED.util.setMessageProperty(msg, \"p1_rate_limit.threshold_percent\", THRESHOLD_PERCENT, true);\n\n// Get the previous value from this node\u0027s context\n// If it doesn\u0027t exist yet, initialize it as null\nlet previousValue = context.get(\u0027previousValue\u0027) || null;\nlet currentValue = Number(msg.grid_power);\n\n// Save the current value for the next time the node is triggered\ncontext.set(\u0027previousValue\u0027, currentValue);\n\n// Default rate limiting\nRED.util.setMessageProperty(msg,\"p1_rate_limit.save_power\",true);\n\n// Check if we have a valid history to compare with\nif (previousValue !== null) {\n    let powerChange = Math.abs(currentValue - previousValue);\n    let percentageChange = previousValue !== 0 ? Math.abs((powerChange / previousValue) * 100):0;\n\n    // Condition: Absolute difference \u003e N Watt AND percentage change \u003e M %\n    if (powerChange \u003e THRESHOLD_POWER \u0026\u0026 percentageChange \u003e THRESHOLD_PERCENT) {\n        // Enable faster refresh rate\n        RED.util.setMessageProperty(msg,\"p1_rate_limit.save_power\",false);\n    }\n}\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  450,
        "y":  280,
        "wires":  [
                      [
                          "34613848a6705d55"
                      ]
                  ]
    },
    {
        "id":  "2b08b7c04ae567cc",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "73a209cdfb340e2c",
        "name":  "CPU power saved",
        "func":  "// Logger\nconst logger = global.get(\"logger\");\n\n// Passed or blocked\nconst hasPassed = msg.payload; // 0 = blocked, 1 = passed\n\n// 1. Get evaluations (Total attempts)\nlet evaluations = (context.get(\"p1_rate_limit_evaluations\") || 0) + 1;\ncontext.set(\"p1_rate_limit_evaluations\", evaluations);\n\n// 2. Increment and get passes (Filtered/successful events)\nlet passes = (context.get(\"p1_rate_limit_passes\") || 0) + hasPassed;\ncontext.set(\"p1_rate_limit_passes\", passes);\n\n// 3a. Calculate percentage (Rate of passing vs total evaluations)\nlet percentage = evaluations \u003e 0 ? (passes / evaluations) * 100 : 0;\n// 3b. Display the percentage rate of not-passing as a measure of efficiency gained\npercentage = 100 - percentage;\n\n// 4. Update Node Status\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `Saved: ${percentage.toFixed(2)}% (${evaluations-passes}/${evaluations})`\n});\n\n// 5. Explain\n// On block\nif(hasPassed === 0) {\n    if(msg.p1_rate_limit.save_power === true) {\n        // This is good\n        logger(this, `\u003cfont color=\"#009ac7\"\u003ePower saved\u003c/font\u003e by P1 Rate Limiter, execution stopped.`); \n    } else {\n        // This is not so good. P1 updates are coming in fast.\n        logger(this, `\u003cfont color=\"orange\"\u003eBlocked\u003c/font\u003e by P1 Rate Limiter. ${Number(1000/msg.rate).toFixed(2)} messages per second exceeded.`); \n    }\n    \n    // Send message onward to debug dashboard\n    return msg;\n}\n// No output on pass\nreturn null;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1270,
        "y":  280,
        "wires":  [
                      [
                          "ca04c6dab2cdd767"
                      ]
                  ]
    },
    {
        "id":  "389c20eb60815daa",
        "type":  "debug",
        "z":  "7f5460695ee75513",
        "g":  "617afc9cbb21c3aa",
        "name":  "Strategy evaluation",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "strategy",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  710,
        "y":  960,
        "wires":  [

                  ]
    },
    {
        "id":  "b304e1aea4e4c595",
        "type":  "api-call-service",
        "z":  "7f5460695ee75513",
        "g":  "4ae6ca31e75c67a6",
        "name":  "Show on dashboard",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_text.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_text.house_battery_strategy_active_sub_strategy"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": $$.ui_value_new}",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_text",
        "service":  "set_value",
        "x":  1760,
        "y":  960,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "1de0dd76b0f5d05a",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "4ae6ca31e75c67a6",
        "name":  "current UI value",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_text.house_battery_strategy_active_sub_strategy",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "ui_value_current",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  1360,
        "y":  960,
        "wires":  [
                      [
                          "3c1651104fca1edd"
                      ]
                  ]
    },
    {
        "id":  "3c1651104fca1edd",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "4ae6ca31e75c67a6",
        "name":  "on new UI value",
        "func":  "// Block when undefined (don\u0027t update UI)\nif(msg.ui_value_current === undefined) return null;\n\n// We show the 2nd strategy in the trace (if available) on the dashboard as the \u0027active sub-strategy\u0027\nconst secondTraceEntry = msg.strategy?.trace?.[1];\nif (secondTraceEntry) {\n    // Handle case where 2nd flow is present\n    msg.ui_value_new =  secondTraceEntry.flow;\n} else {\n    // Handle case where the 2nd flow is missing\n    // Get a sensible alternative\n    msg.ui_value_new = msg.strategy?.selected || \"\"; // don\u0027t use unknown or unavailable as these are reserved HA keywords\n}\n\n// Improve human readability\nif(msg.ui_value_new == \"Self-consumption\" \u0026\u0026 secondTraceEntry?.flow_settings?.discharge_disabled === true){\n    msg.ui_value_new = \"Self-consumption (charge only)\";\n}\nif(msg.ui_value_new == \"Self-consumption\" \u0026\u0026 secondTraceEntry?.flow_settings?.charge_disabled === true){\n    msg.ui_value_new = \"Self-consumption (no charging)\";\n}\n\n// Node status for devs\nnode.status({fill:\"grey\",shape:\"dot\",text:`new: ${msg.ui_value_new}`});\n\n// Block when equal (don\u0027t update UI)\nif(msg.ui_value_current === msg.ui_value_new) return null;\n\n// Pass otherwise\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1560,
        "y":  960,
        "wires":  [
                      [
                          "b304e1aea4e4c595"
                      ]
                  ]
    },
    {
        "id":  "e1e1a146910ee317",
        "type":  "ha-fire-event",
        "z":  "7f5460695ee75513",
        "g":  "e00f6aabc81f50d8",
        "name":  "Show on debug board",
        "server":  "176d29a.6f648d6",
        "version":  0,
        "event":  "update_trace_sensor",
        "data":  "{\t   \"trace\": $$.strategy.trace ? $$.strategy.trace : [],\t   \"start\": $$.strategy.execution_start ? $$.strategy.execution_start : 0,\t   \"end\": $$.strategy.execution_end ? $$.strategy.execution_end : 0,\t   \"log\": $$.log ? $$.log : []\t}",
        "dataType":  "jsonata",
        "x":  1740,
        "y":  1320,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "de7fd17c236aa837",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "cdc369e394194098",
        "name":  "Insight mode",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_boolean.house_battery_control_is_debug_mode",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "debug_mode",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  130,
        "y":  160,
        "wires":  [
                      [
                          "d14ce10d1801776b"
                      ]
                  ]
    },
    {
        "id":  "bf4561c98529266b",
        "type":  "switch",
        "z":  "7f5460695ee75513",
        "g":  "e00f6aabc81f50d8",
        "name":  "Debug mode?",
        "property":  "debug_mode",
        "propertyType":  "global",
        "rules":  [
                      {
                          "t":  "true"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  1,
        "x":  1540,
        "y":  1320,
        "wires":  [
                      [
                          "e1e1a146910ee317"
                      ]
                  ]
    },
    {
        "id":  "5ad26a3d44faed29",
        "type":  "server-state-changed",
        "z":  "7f5460695ee75513",
        "g":  "cdc369e394194098",
        "name":  "Turned ON",
        "server":  "176d29a.6f648d6",
        "version":  6,
        "outputs":  2,
        "exposeAsEntityConfig":  "",
        "entities":  {
                         "entity":  [
                                        "input_boolean.house_battery_control_is_debug_mode"
                                    ],
                         "substring":  [

                                       ],
                         "regex":  [

                                   ]
                     },
        "outputInitially":  false,
        "stateType":  "str",
        "ifState":  "on",
        "ifStateType":  "str",
        "ifStateOperator":  "is",
        "outputOnlyOnStateChange":  true,
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "ignorePrevStateNull":  false,
        "ignorePrevStateUnknown":  false,
        "ignorePrevStateUnavailable":  false,
        "ignoreCurrentStateUnknown":  false,
        "ignoreCurrentStateUnavailable":  false,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "eventData"
                                 },
                                 {
                                     "property":  "topic",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "triggerId"
                                 }
                             ],
        "x":  380,
        "y":  160,
        "wires":  [
                      [
                          "b01c579b8c3811a2"
                      ],
                      [

                      ]
                  ]
    },
    {
        "id":  "b01c579b8c3811a2",
        "type":  "trigger",
        "z":  "7f5460695ee75513",
        "g":  "cdc369e394194098",
        "name":  "disable after 5 minutes",
        "op1":  "",
        "op2":  "off",
        "op1type":  "nul",
        "op2type":  "str",
        "duration":  "5",
        "extend":  false,
        "overrideDelay":  false,
        "units":  "min",
        "reset":  "",
        "bytopic":  "all",
        "topic":  "topic",
        "outputs":  1,
        "x":  560,
        "y":  160,
        "wires":  [
                      [
                          "62252f491c4da1ea"
                      ]
                  ]
    },
    {
        "id":  "62252f491c4da1ea",
        "type":  "api-call-service",
        "z":  "7f5460695ee75513",
        "g":  "cdc369e394194098",
        "name":  "Turn insight OFF",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_boolean.turn_off",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_boolean.house_battery_control_is_debug_mode"
                     ],
        "labelId":  [

                    ],
        "data":  "",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_boolean",
        "service":  "turn_off",
        "x":  770,
        "y":  160,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "865a81da38673369",
        "type":  "delay",
        "z":  "7f5460695ee75513",
        "g":  "ce0f62beb80fb964",
        "name":  "",
        "pauseType":  "delay",
        "timeout":  "2",
        "timeoutUnits":  "seconds",
        "rate":  "1",
        "nbRateUnits":  "1",
        "rateUnits":  "second",
        "randomFirst":  "1",
        "randomLast":  "5",
        "randomUnits":  "seconds",
        "drop":  false,
        "allowrate":  false,
        "outputs":  1,
        "x":  1580,
        "y":  60,
        "wires":  [
                      [
                          "e693695841a12ac8"
                      ]
                  ]
    },
    {
        "id":  "ebf13a696e1103d4",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "ec3ddc2036ced526",
        "name":  "Custom logger",
        "func":  "/**\n * Custom Logger Function\n * * Provides centralized logging, node-status updates, and message tracing.\n * Specifically designed for Home Battery Control logic within Node-RED.\n * \n * Debug dashboard updating:\n * A msg needs to reach \u0027Strategy Evaluation\u0027 or be passed to the \"Show on debug board\" trigger node.\n * Errors are automatically passed to the \"Show on debug board\" trigger node.\n * \n * * @param {object} callingNode - The context of the calling node (pass \u0027this\u0027).\n * @param {string} text - The log message/explanation.\n * @param {string} level - Log level: \u0027log\u0027, \u0027warn\u0027, \u0027error\u0027, or \u0027info\u0027 (default: \u0027info\u0027).\n * \n * Note: anything above \u0027info\u0027 will also write to the Node-RED log files \n * \n * * @usage: \n * const log = global.get(\"logger\");\n * log(this, \"Charging cycle started\");\n */\nconst customLogger = (callingNode, text, level = \u0027info\u0027) =\u003e {\n    \n    // Log only when debug_mode is ON\n    const debug_mode = global.get(\"debug_mode\") || false;\n    if(debug_mode == false) return null;\n\n    // Max log elements to keep\n    const MAX_ELEMENTS = 100;\n\n    // Create the YYYY-MM-DD HH:MM:SS.mmm format\n    const now = new Date();\n    const timestamp = now.getHours().toString().padStart(2, \u00270\u0027) + \":\" +\n                now.getMinutes().toString().padStart(2, \u00270\u0027) + \":\" +\n                now.getSeconds().toString().padStart(2, \u00270\u0027) + \".\" +\n                now.getMilliseconds().toString().padStart(3, \u00270\u0027);\n\n    const formattedTimeLevel = `${timestamp} [${level.toLowerCase()}]`;\n    \n    // Get the name of the node or fallback to the ID\n    const nodeName = callingNode.__node__ ? callingNode.__node__.name || callingNode.__node__.id : undefined;\n    // Get the name of the Flow/Tab\n    const flowName = callingNode.env.get(\"NR_FLOW_NAME\") || \"Unknown flow\";\n    // Explain to the Home Battery Control user what is going on\n    const formattedExplenation = `[${flowName} \u003e\u003e ${nodeName}]: ${text}`;\n\n    // Level icons\n    let icon = \"âšª\";\n    switch (level) {\n        case \"info\":\n            icon = \"â„¹ï¸\";\n            break;\n        case \"log\":\n            icon = \"ðŸ”§\";\n            break;\n        case \"warn\":\n            icon = \"âš ï¸\";      \n            break;\n        case \"error\":\n            icon = \"âŒ\";\n            break;\n    }\n\n    // Enrich msg with log info\n    const msg = callingNode.msg;\n    (msg.log = msg.log || []).push({ timestamp: timestamp, level:level, flow:flowName, node:nodeName, payload: text, icon: icon});\n\n    if (msg.log.length \u003e MAX_ELEMENTS) {\n        // Slice keeps the last X elements\n        msg.log = msg.log.slice(-MAX_ELEMENTS);\n    }\n\n    // Log to the Node-RED system log\n    switch (level) {\n        case \"log\":\n            node.log(`${formattedExplenation}`);\n            break;\n        case \"warn\":\n            node.warn(`${formattedExplenation}`);       \n            break;\n        case \"error\":\n            node.error(`${formattedExplenation}`, callingNode.msg);\n            break;\n        default:\n            // don\u0027t log to logfiles by default\n    }\n\n};\n\nglobal.set(\u0027logger\u0027, customLogger);\nglobal.set(\u0027unhandledException\u0027, \"\");\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1740,
        "y":  160,
        "wires":  [
                      [
                          "15a8447d656db5a6"
                      ]
                  ]
    },
    {
        "id":  "da4ad49d21e836d6",
        "type":  "change",
        "z":  "7f5460695ee75513",
        "g":  "73a209cdfb340e2c",
        "name":  "Pass",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "payload",
                          "pt":  "msg",
                          "to":  "1",
                          "tot":  "num"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  1110,
        "y":  300,
        "wires":  [
                      [
                          "2b08b7c04ae567cc",
                          "9f254ea4ab071dd8"
                      ]
                  ]
    },
    {
        "id":  "9ef721615468fb63",
        "type":  "change",
        "z":  "7f5460695ee75513",
        "g":  "73a209cdfb340e2c",
        "name":  "Block",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "payload",
                          "pt":  "msg",
                          "to":  "0",
                          "tot":  "num"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  1110,
        "y":  260,
        "wires":  [
                      [
                          "2b08b7c04ae567cc"
                      ]
                  ]
    },
    {
        "id":  "a5ce8fa89d580ec2",
        "type":  "link in",
        "z":  "7f5460695ee75513",
        "g":  "e00f6aabc81f50d8",
        "name":  "Update debug dashboard",
        "links":  [
                      "ca04c6dab2cdd767",
                      "af4ca03218ec55a8",
                      "220f903862df4c11"
                  ],
        "x":  1395,
        "y":  1260,
        "wires":  [
                      [
                          "bf4561c98529266b",
                          "f482d76d148c4843"
                      ]
                  ]
    },
    {
        "id":  "ca04c6dab2cdd767",
        "type":  "link out",
        "z":  "7f5460695ee75513",
        "g":  "73a209cdfb340e2c",
        "name":  "goto Debug Dashboard update",
        "mode":  "link",
        "links":  [
                      "a5ce8fa89d580ec2"
                  ],
        "x":  1395,
        "y":  280,
        "wires":  [

                  ]
    },
    {
        "id":  "21e1c111622cfdf6",
        "type":  "catch",
        "z":  "7f5460695ee75513",
        "g":  "e00f6aabc81f50d8",
        "name":  "Custom logger",
        "scope":  [
                      "ebf13a696e1103d4"
                  ],
        "uncaught":  false,
        "x":  1340,
        "y":  1380,
        "wires":  [
                      [
                          "bf4561c98529266b",
                          "a75be4dcdbf976de"
                      ]
                  ]
    },
    {
        "id":  "a75be4dcdbf976de",
        "type":  "debug",
        "z":  "7f5460695ee75513",
        "g":  "e00f6aabc81f50d8",
        "name":  "Via Catch",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "true",
        "targetType":  "full",
        "statusVal":  "",
        "statusType":  "counter",
        "x":  1520,
        "y":  1380,
        "wires":  [

                  ]
    },
    {
        "id":  "f482d76d148c4843",
        "type":  "debug",
        "z":  "7f5460695ee75513",
        "g":  "e00f6aabc81f50d8",
        "name":  "Via link",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "true",
        "targetType":  "full",
        "statusVal":  "",
        "statusType":  "counter",
        "x":  1520,
        "y":  1260,
        "wires":  [

                  ]
    },
    {
        "id":  "af4ca03218ec55a8",
        "type":  "link out",
        "z":  "7f5460695ee75513",
        "g":  "21298cd658864626",
        "name":  "link out 1",
        "mode":  "link",
        "links":  [
                      "a5ce8fa89d580ec2"
                  ],
        "x":  285,
        "y":  1060,
        "wires":  [

                  ]
    },
    {
        "id":  "0f02732cd4c432b1",
        "type":  "switch",
        "z":  "7f5460695ee75513",
        "g":  "73a209cdfb340e2c",
        "name":  "Skip rate limiter during debug",
        "property":  "debug_mode",
        "propertyType":  "global",
        "rules":  [
                      {
                          "t":  "false"
                      },
                      {
                          "t":  "true"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  2,
        "x":  180,
        "y":  280,
        "wires":  [
                      [
                          "b4673e76e39534f9"
                      ],
                      [
                          "9f254ea4ab071dd8"
                      ]
                  ]
    },
    {
        "id":  "d14ce10d1801776b",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "cdc369e394194098",
        "name":  "Notice",
        "func":  "// enable or disable Insights Mode\nif(msg.debug_mode == \"on\"){\n    // ENABLED - explain to user\n    const log = global.get(\"logger\");\n    log(this, \"P1 Rate limiter is *disabled* during *debug mode*\");\n\n    // Set global (setting this via current state node has proven irriliable)\n    global.set(\"debug_mode\", true);\n} else {\n    // DISABLED - set global\n    global.set(\"debug_mode\", false);\n}\n\n// Clean up - only use the global\ndelete msg.debug_mode;\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  235,
        "y":  160,
        "wires":  [
                      [
                          "0f02732cd4c432b1"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "a110998f48a4695a",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "c256db967cf5dccc",
        "name":  "SoC min",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.marstek_m{{battery_index}}_discharging_cutoff_capacity",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "discharging_cutoff_capacity",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  1000,
        "y":  500,
        "wires":  [
                      [
                          "2e2223c87c18f763"
                      ]
                  ]
    },
    {
        "id":  "2e2223c87c18f763",
        "type":  "api-current-state",
        "z":  "7f5460695ee75513",
        "g":  "c256db967cf5dccc",
        "name":  "SoC max",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.marstek_m{{battery_index}}_charging_cutoff_capacity",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "charging_cutoff_capacity",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  1140,
        "y":  500,
        "wires":  [
                      [
                          "314138d90b7039a4"
                      ]
                  ]
    },
    {
        "id":  "15a8447d656db5a6",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "ec3ddc2036ced526",
        "name":  "Unhandled Exception",
        "func":  "/**\n * Handles exceptions by extracting node details and routing them to a global logger.\n * This is designed to be called from within a Node-RED Function node or sub-flow.\n *\n * @param {Object} callingNode - The Node-RED \u0027this\u0027 context or msg object containing node metadata.\n * @param {Object} [callingNode.msg] - The message object associated with the error.\n * @param {Object} [callingNode.msg.error] - Error details provided by a Node-RED error catch.\n * @param {string} [callingNode.msg.error.message] - The specific error message.\n * @param {Object} [callingNode.msg.error.source] - The node that triggered the error.\n * * @example\n * // Usage in a Function Node:\n * const unhandledException = global.get(\u0027unhandledException\u0027);\n * unhandledException(this);\n */\nconst unhandledException = (callingNode) =\u003e {\n    // 1. Get the custom logger from global context\n    const log = global.get(\"logger\");\n\n    // 2. Extract error details from the msg object\n    const errorData = callingNode.msg?.error || {};\n    const errorMessage = errorData.message || \"Unknown error occurred\";\n    const sourceName = errorData.source ? (errorData.source.name || errorData.source.id) : \"Unknown Node\";\n    const sourceType = errorData.source ? errorData.source.type : \"unknown-type\";\n\n    // 3. Construct a user-friendly message for the logger\n    const friendlyMessage = `**Unhandled exception** (${sourceType} node) ${errorMessage}`;\n    callingNode.__node__ ??= {};\n    callingNode.__node__.name = sourceName;\n\n    // 4. Call the logger with level \u0027error\u0027\n    // Note: the logger uses \u0027callingNode\u0027, we pass on whatever we have.\n    log(callingNode, friendlyMessage, \u0027error\u0027);\n\n};\n\nglobal.set(\u0027unhandledException\u0027, unhandledException);\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1760,
        "y":  220,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "c6435283baa61870",
        "type":  "catch",
        "z":  "7f5460695ee75513",
        "g":  "220907b737bc4473",
        "name":  "",
        "scope":  null,
        "uncaught":  true,
        "x":  1745,
        "y":  320,
        "wires":  [
                      [
                          "046207800a78a6b8"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "046207800a78a6b8",
        "type":  "function",
        "z":  "7f5460695ee75513",
        "g":  "220907b737bc4473",
        "name":  "Unhandled Exception",
        "func":  "const handle = global.get(\u0027unhandledException\u0027);\n\nhandle(this);\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1795,
        "y":  320,
        "wires":  [
                      [
                          "220f903862df4c11"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "220f903862df4c11",
        "type":  "link out",
        "z":  "7f5460695ee75513",
        "g":  "220907b737bc4473",
        "name":  "link out 9",
        "mode":  "link",
        "links":  [
                      "a5ce8fa89d580ec2"
                  ],
        "x":  1845,
        "y":  320,
        "wires":  [

                  ]
    },
    {
        "id":  "176d29a.6f648d6",
        "type":  "server",
        "name":  "Home Assistant",
        "addon":  true,
        "rejectUnauthorizedCerts":  true,
        "ha_boolean":  "",
        "connectionDelay":  false,
        "cacheJson":  false,
        "heartbeat":  false,
        "heartbeatInterval":  "",
        "statusSeparator":  "",
        "enableGlobalContextStore":  false
    },
    {
        "id":  "cd22a297f60341dc",
        "type":  "global-config",
        "env":  [

                ],
        "modules":  {
                        "node-red-contrib-home-assistant-websocket":  "0.80.3"
                    }
    },
    {
        "id":  "a630e82fe7e8cfbe",
        "type":  "tab",
        "label":  "Strategy Charge v4.4.0",
        "disabled":  false,
        "info":  "",
        "env":  [

                ]
    },
    {
        "id":  "7a96f9281d1a24ee",
        "type":  "group",
        "z":  "a630e82fe7e8cfbe",
        "name":  "Configuration",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "398c4b246729e267",
                      "99a46bf6290b9da8",
                      "37128d5a7f8d3fac"
                  ],
        "x":  34,
        "y":  99,
        "w":  192,
        "h":  162
    },
    {
        "id":  "918df93dcc419a42",
        "type":  "group",
        "z":  "a630e82fe7e8cfbe",
        "name":  "Battery solutions",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "e6d8dc32c1ba70c9",
                      "d8992960a62e8c9c",
                      "583d5a6c585b11d4"
                  ],
        "x":  34,
        "y":  479,
        "w":  192,
        "h":  142
    },
    {
        "id":  "b757ec0851310259",
        "type":  "group",
        "z":  "a630e82fe7e8cfbe",
        "name":  "Export routine",
        "style":  {
                      "fill-opacity":  "0.5",
                      "label":  true,
                      "color":  "#cccccc"
                  },
        "nodes":  [
                      "74bb3648299adbf7",
                      "bf3b2b014ac213b7",
                      "f519e7ee73b4975d",
                      "8d53521b7d9ee060",
                      "75904b336b7b22ae",
                      "b9d1768e33de5aa6",
                      "f39cfdee5a59e5db",
                      "5be87eab5b4776ce",
                      "b21214cb0c20d290",
                      "01c04a890b0bffb6"
                  ],
        "x":  254,
        "y":  319,
        "w":  1192,
        "h":  182
    },
    {
        "id":  "5959322bdec01c15",
        "type":  "group",
        "z":  "a630e82fe7e8cfbe",
        "name":  "Decide import or stop",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "92d64edd0ae5d65d",
                      "4491189ca0a4c215",
                      "f8251f768dd3ee4e",
                      "259dde4504fdd59a",
                      "897136ea53821778",
                      "f23df562230cb98a",
                      "707a1e8eeaa2513e",
                      "bb8389fa30c2b9fd",
                      "1340613cd5c71695",
                      "b8a49471d00efc2b",
                      "4ff1ffaf98a16543",
                      "acc64c2269aa4057",
                      "58650199ecd58446",
                      "418f07d11fdf4cb2",
                      "711e4427104baa3d",
                      "6001f1063e7f129d",
                      "feaf77a2d67a31d0",
                      "10a5131843a568b8",
                      "1fecf8a6c7a23d70",
                      "0454f476e5a759d3"
                  ],
        "x":  254,
        "y":  79,
        "w":  1928,
        "h":  207
    },
    {
        "id":  "1fecf8a6c7a23d70",
        "type":  "group",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "UI helper | set bounds for charge levels",
        "style":  {
                      "label":  true,
                      "stroke":  "#3f93cf"
                  },
        "nodes":  [
                      "f3e7ffd19df9c1ee",
                      "444691a796ca56fe",
                      "27cfd005b02861b3"
                  ],
        "x":  1464,
        "y":  159,
        "w":  692,
        "h":  82
    },
    {
        "id":  "afebfb6a35f6a0c7",
        "type":  "group",
        "z":  "a630e82fe7e8cfbe",
        "name":  "Unhandled exceptions",
        "style":  {
                      "label":  true,
                      "stroke":  "#d88a8a",
                      "color":  "#d88a8a"
                  },
        "nodes":  [
                      "f23879efb432f0db",
                      "a689d6ceced72732",
                      "9b81fcbf318a1c09"
                  ],
        "x":  34,
        "y":  379,
        "w":  182,
        "h":  82
    },
    {
        "id":  "10a5131843a568b8",
        "type":  "junction",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "x":  1490,
        "y":  260,
        "wires":  [
                      [
                          "b21214cb0c20d290"
                      ]
                  ]
    },
    {
        "id":  "b7a801679f527954",
        "type":  "comment",
        "z":  "a630e82fe7e8cfbe",
        "name":  "Home Battery Strategy",
        "info":  "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon\u0027t modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x":  140,
        "y":  60,
        "wires":  [

                  ]
    },
    {
        "id":  "398c4b246729e267",
        "type":  "link in",
        "z":  "a630e82fe7e8cfbe",
        "g":  "7a96f9281d1a24ee",
        "name":  "Charge",
        "links":  [

                  ],
        "x":  110,
        "y":  220,
        "wires":  [
                      [
                          "37128d5a7f8d3fac"
                      ]
                  ],
        "l":  true
    },
    {
        "id":  "99a46bf6290b9da8",
        "type":  "comment",
        "z":  "a630e82fe7e8cfbe",
        "g":  "7a96f9281d1a24ee",
        "name":  "Start (readme)",
        "info":  "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the \u003cselect\u003e option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select \u0027AcmE example\u0027\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled \u0027AcmE example\u0027 (case sensitive).",
        "x":  130,
        "y":  140,
        "wires":  [

                  ]
    },
    {
        "id":  "37128d5a7f8d3fac",
        "type":  "change",
        "z":  "a630e82fe7e8cfbe",
        "g":  "7a96f9281d1a24ee",
        "name":  "Trace",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "strategy.trace",
                          "pt":  "msg",
                          "to":  "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                          "tot":  "jsonata"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  110,
        "y":  180,
        "wires":  [
                      [
                          "feaf77a2d67a31d0"
                      ]
                  ],
        "info":  "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id":  "e6d8dc32c1ba70c9",
        "type":  "link out",
        "z":  "a630e82fe7e8cfbe",
        "g":  "918df93dcc419a42",
        "name":  "Return",
        "mode":  "return",
        "links":  [

                  ],
        "x":  185,
        "y":  580,
        "wires":  [

                  ]
    },
    {
        "id":  "d8992960a62e8c9c",
        "type":  "comment",
        "z":  "a630e82fe7e8cfbe",
        "g":  "918df93dcc419a42",
        "name":  "End (readme)",
        "info":  "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x":  130,
        "y":  520,
        "wires":  [

                  ]
    },
    {
        "id":  "583d5a6c585b11d4",
        "type":  "link in",
        "z":  "a630e82fe7e8cfbe",
        "g":  "918df93dcc419a42",
        "name":  "link to End",
        "links":  [
                      "259dde4504fdd59a",
                      "58650199ecd58446",
                      "5be87eab5b4776ce"
                  ],
        "x":  75,
        "y":  580,
        "wires":  [
                      [
                          "e6d8dc32c1ba70c9"
                      ]
                  ]
    },
    {
        "id":  "74bb3648299adbf7",
        "type":  "function",
        "z":  "a630e82fe7e8cfbe",
        "g":  "b757ec0851310259",
        "name":  "Max power solution",
        "func":  "// Logger, usage: log(this, \"\");\nconst log = global.get(\u0027logger\u0027);\nlog(this, \"Charge at **max. power**\");\n\n// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// build solution\nmsg.batteries.forEach(battery =\u003e {\n    const calculatedPower = Number(battery.charging_max);\n\n    solution_array.push({\n        id: battery.id,\n        mode: \"charge\",\n        power: calculatedPower\n    });\n\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  970,
        "y":  360,
        "wires":  [
                      [
                          "f39cfdee5a59e5db"
                      ]
                  ]
    },
    {
        "id":  "bf3b2b014ac213b7",
        "type":  "link call",
        "z":  "a630e82fe7e8cfbe",
        "g":  "b757ec0851310259",
        "name":  "Call flow",
        "links":  [

                  ],
        "linkType":  "dynamic",
        "timeout":  "30",
        "x":  1140,
        "y":  400,
        "wires":  [
                      [
                          "8d53521b7d9ee060",
                          "5be87eab5b4776ce"
                      ]
                  ]
    },
    {
        "id":  "f519e7ee73b4975d",
        "type":  "switch",
        "z":  "a630e82fe7e8cfbe",
        "g":  "b757ec0851310259",
        "name":  "Import at max power",
        "property":  "house_battery_strategy_charge_has_max_power",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "on",
                          "vt":  "str"
                      },
                      {
                          "t":  "else"
                      }
                  ],
        "checkall":  "false",
        "repair":  false,
        "outputs":  2,
        "x":  760,
        "y":  380,
        "wires":  [
                      [
                          "74bb3648299adbf7"
                      ],
                      [
                          "b9d1768e33de5aa6"
                      ]
                  ]
    },
    {
        "id":  "8d53521b7d9ee060",
        "type":  "debug",
        "z":  "a630e82fe7e8cfbe",
        "g":  "b757ec0851310259",
        "name":  "Regulated",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "payload",
        "targetType":  "msg",
        "statusVal":  "payload",
        "statusType":  "auto",
        "x":  1330,
        "y":  400,
        "wires":  [

                  ]
    },
    {
        "id":  "75904b336b7b22ae",
        "type":  "debug",
        "z":  "a630e82fe7e8cfbe",
        "g":  "b757ec0851310259",
        "name":  "Maximum",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "payload",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "counter",
        "x":  1320,
        "y":  360,
        "wires":  [

                  ]
    },
    {
        "id":  "b9d1768e33de5aa6",
        "type":  "function",
        "z":  "a630e82fe7e8cfbe",
        "g":  "b757ec0851310259",
        "name":  "Regulated power",
        "func":  "// Logger, usage: log(this, \"\");\nconst log = global.get(\u0027logger\u0027);\n\n// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = msg.house_battery_strategy_charge_target_power;\n// tell PID to avoid discharge solutions during charging.\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\",true,true);\n\n// Finally\nlog(this, `**Regulated** charging. Limit grid power: ${Math.floor(msg.house_battery_strategy_charge_target_power)} W`);\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  970,
        "y":  400,
        "wires":  [
                      [
                          "bf3b2b014ac213b7"
                      ]
                  ]
    },
    {
        "id":  "f39cfdee5a59e5db",
        "type":  "change",
        "z":  "a630e82fe7e8cfbe",
        "g":  "b757ec0851310259",
        "name":  "Continue",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "target",
                          "pt":  "msg",
                          "to":  "Charge",
                          "tot":  "str"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  1140,
        "y":  360,
        "wires":  [
                      [
                          "75904b336b7b22ae",
                          "5be87eab5b4776ce"
                      ]
                  ]
    },
    {
        "id":  "5be87eab5b4776ce",
        "type":  "link out",
        "z":  "a630e82fe7e8cfbe",
        "g":  "b757ec0851310259",
        "name":  "go to End",
        "mode":  "link",
        "links":  [
                      "583d5a6c585b11d4"
                  ],
        "x":  1320,
        "y":  460,
        "wires":  [

                  ],
        "l":  true
    },
    {
        "id":  "b21214cb0c20d290",
        "type":  "api-current-state",
        "z":  "a630e82fe7e8cfbe",
        "g":  "b757ec0851310259",
        "name":  "Use max power?",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_boolean.house_battery_strategy_charge_has_max_power",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_charge_has_max_power",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  370,
        "y":  380,
        "wires":  [
                      [
                          "01c04a890b0bffb6"
                      ]
                  ]
    },
    {
        "id":  "01c04a890b0bffb6",
        "type":  "api-current-state",
        "z":  "a630e82fe7e8cfbe",
        "g":  "b757ec0851310259",
        "name":  "Grid power limit",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_strategy_charge_target_power",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_charge_target_power",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  560,
        "y":  380,
        "wires":  [
                      [
                          "f519e7ee73b4975d"
                      ]
                  ]
    },
    {
        "id":  "92d64edd0ae5d65d",
        "type":  "function",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Unknown -\u003e Full stop",
        "func":  "const log = global.get(\"logger\");\n\n// Unkown export goal\nlog(this, `**${msg.charge.goal}**; Charge goal not recognized. Fallback to **Full Stop**`,\"warn\");\n\n// Full stop\nmsg.target = \"Full stop\";\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  810,
        "y":  240,
        "wires":  [
                      [
                          "4491189ca0a4c215"
                      ]
                  ]
    },
    {
        "id":  "4491189ca0a4c215",
        "type":  "link call",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Call flow",
        "links":  [

                  ],
        "linkType":  "dynamic",
        "timeout":  "5",
        "x":  990,
        "y":  240,
        "wires":  [
                      [
                          "259dde4504fdd59a"
                      ]
                  ]
    },
    {
        "id":  "f8251f768dd3ee4e",
        "type":  "api-current-state",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Energy reserve hi",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_strategy_charge_target_energy",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "charge.threshold_energy",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  800,
        "y":  200,
        "wires":  [
                      [
                          "f23df562230cb98a"
                      ]
                  ]
    },
    {
        "id":  "259dde4504fdd59a",
        "type":  "link out",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "go to End",
        "mode":  "link",
        "links":  [
                      "583d5a6c585b11d4"
                  ],
        "x":  1190,
        "y":  240,
        "wires":  [

                  ],
        "l":  true
    },
    {
        "id":  "897136ea53821778",
        "type":  "api-current-state",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "SoC reached",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_strategy_charge_target_soc",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "charge.threshold_soc",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  780,
        "y":  160,
        "wires":  [
                      [
                          "707a1e8eeaa2513e"
                      ]
                  ]
    },
    {
        "id":  "f23df562230cb98a",
        "type":  "function",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Check if hi",
        "func":  "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Charge until: ${msg.charge.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nvar energy_threshold = Number(RED.util.getMessageProperty(msg,\"charge.threshold_energy\"));\nif (energy_threshold === undefined || energy_threshold \u003c= 0){\n    log(this,`Desired energy reserve invalid \u0027${energy_threshold}\u0027 kWh. I\u0027ve set it to ${Number(msg.batteries_max_energy).toFixed(1)} kWh`,\"warn\");\n    energy_threshold = Math.floor(Number(msg.batteries_max_energy)*10)/10;\n}\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining \u003e= energy_threshold) {\n    msg.charge.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh`, \u0027info\u0027);\n} else {\n    msg.charge.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh.`, \u0027info\u0027);\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.charge.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.charge.threshold_reached}` \n});\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1000,
        "y":  200,
        "wires":  [
                      [
                          "418f07d11fdf4cb2",
                          "27cfd005b02861b3"
                      ]
                  ]
    },
    {
        "id":  "707a1e8eeaa2513e",
        "type":  "function",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Check if SoC",
        "func":  "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this, `Charge until: ${msg.charge.goal}`);\n\n// 2. Extract average SoC and desired SoC level\nlet batteries = msg.batteries;\nlet soc_avg = 0;\nlet count = 0; // could use msg.battery_count\nbatteries.forEach(battery =\u003e {\n    soc_avg += battery.soc;\n    count++;\n});\n// 2.1 Current avg. SoC\nsoc_avg = Math.round(soc_avg / count * 100) / 100;\n// 2.2 Charge until SoC (100% as fallback)\nvar soc_threshold = Number(RED.util.getMessageProperty(msg,\"charge.threshold_soc\"));\nif (soc_threshold === undefined || soc_threshold \u003c 12){\n    log(this, `Desired SoC not set correctly \u0027${soc_threshold}\u0027 %. I\u0027ve set it to 100%.`,\"warn\");\n    soc_threshold = 100;\n}\n\n// 3. Logic: Determine if SoC level is at or above desired level\nif (soc_avg \u003e= soc_threshold) {\n    msg.charge.threshold_reached = true;\n\n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, \u0027info\u0027);\n} else {\n    msg.charge.threshold_reached = false;\n\n    // User friendly feedback via the custom logger\n    log(this, `[OK] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, \u0027info\u0027);\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({\n    fill: msg.charge.threshold_reached ? \"red\" : \"green\",\n    shape: \"dot\",\n    text: `Threshold reached: ${msg.charge.threshold_reached}`\n});\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1000,
        "y":  160,
        "wires":  [
                      [
                          "418f07d11fdf4cb2"
                      ]
                  ]
    },
    {
        "id":  "bb8389fa30c2b9fd",
        "type":  "change",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Batteries are full",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "payload",
                          "pt":  "msg",
                          "to":  "0",
                          "tot":  "num"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  790,
        "y":  120,
        "wires":  [
                      [
                          "1340613cd5c71695"
                      ]
                  ]
    },
    {
        "id":  "1340613cd5c71695",
        "type":  "function",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Check if full",
        "func":  "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Charge until: ${msg.charge.goal}`);\n\n// 2. Extract energy level from msg (and handle missing properties)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nconst energy_max = Number(RED.util.getMessageProperty(msg, \"batteries_max_energy\")) || 0;\nif(energy_max == 0) log(this,`Batteries max energy missing! ${msg.batteries_max_energy}`);\n// 2.1 Check if every battery\u0027s SoC is at or over the max\nconst isAtMax = msg.batteries.every(battery =\u003e battery.soc \u003e= battery.soc_max);\n\n// 3. Logic: Determine if energy level is over or near 99.9% of max eneregy\nif (isAtMax) {\n    msg.charge.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] All batteries are full or at SoC_max_ (${energy_remaining} kWh).`, \u0027info\u0027);\n} else {\n    msg.charge.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Battery level ${energy_remaining.toFixed(2)} kWh below ${energy_max.toFixed(2)} kWh.`, \u0027info\u0027);\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.charge.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.charge.threshold_reached}` \n});\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1000,
        "y":  120,
        "wires":  [
                      [
                          "418f07d11fdf4cb2"
                      ]
                  ]
    },
    {
        "id":  "b8a49471d00efc2b",
        "type":  "switch",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Until reached",
        "property":  "charge.threshold_reached",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "true"
                      },
                      {
                          "t":  "false"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  2,
        "x":  1340,
        "y":  160,
        "wires":  [
                      [
                          "4ff1ffaf98a16543"
                      ],
                      [
                          "10a5131843a568b8"
                      ]
                  ]
    },
    {
        "id":  "4ff1ffaf98a16543",
        "type":  "function",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Yes -\u003e Charge PV",
        "func":  "// If any solar surplus remains, soak it up instead of waiting in Full stop.\nmsg.target = \"Charge PV\";\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1580,
        "y":  120,
        "wires":  [
                      [
                          "acc64c2269aa4057"
                      ]
                  ]
    },
    {
        "id":  "acc64c2269aa4057",
        "type":  "link call",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Call flow",
        "links":  [

                  ],
        "linkType":  "dynamic",
        "timeout":  "5",
        "x":  1760,
        "y":  120,
        "wires":  [
                      [
                          "58650199ecd58446"
                      ]
                  ]
    },
    {
        "id":  "58650199ecd58446",
        "type":  "link out",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "go to End",
        "mode":  "link",
        "links":  [
                      "583d5a6c585b11d4"
                  ],
        "x":  1900,
        "y":  120,
        "wires":  [

                  ],
        "l":  true
    },
    {
        "id":  "418f07d11fdf4cb2",
        "type":  "function",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Decided",
        "func":  "const log = global.get(\"logger\");\n\nif(msg.charge.threshold_reached){\n    log(this,`Stop charging, Charge until ${msg.charge.goal} reached.`);\n} else {\n    log(this,`Continue charging.`);\n}\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1190,
        "y":  160,
        "wires":  [
                      [
                          "b8a49471d00efc2b"
                      ]
                  ]
    },
    {
        "id":  "711e4427104baa3d",
        "type":  "switch",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Charge until",
        "property":  "charge.goal",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "batteries are full",
                          "vt":  "str"
                      },
                      {
                          "t":  "eq",
                          "v":  "state of charge",
                          "vt":  "str"
                      },
                      {
                          "t":  "eq",
                          "v":  "energy reserve",
                          "vt":  "str"
                      },
                      {
                          "t":  "else"
                      }
                  ],
        "checkall":  "false",
        "repair":  false,
        "outputs":  4,
        "x":  590,
        "y":  180,
        "wires":  [
                      [
                          "bb8389fa30c2b9fd"
                      ],
                      [
                          "897136ea53821778"
                      ],
                      [
                          "f8251f768dd3ee4e"
                      ],
                      [
                          "92d64edd0ae5d65d"
                      ]
                  ]
    },
    {
        "id":  "6001f1063e7f129d",
        "type":  "api-current-state",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Goal",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.house_battery_strategy_charge_goal",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "charge.goal",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  450,
        "y":  180,
        "wires":  [
                      [
                          "711e4427104baa3d"
                      ]
                  ]
    },
    {
        "id":  "feaf77a2d67a31d0",
        "type":  "function",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "Init",
        "func":  "msg.charge = {};\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  330,
        "y":  180,
        "wires":  [
                      [
                          "6001f1063e7f129d",
                          "0454f476e5a759d3"
                      ]
                  ]
    },
    {
        "id":  "f3e7ffd19df9c1ee",
        "type":  "function",
        "z":  "a630e82fe7e8cfbe",
        "g":  "1fecf8a6c7a23d70",
        "name":  "Min/max",
        "func":  "\n// Lower bound\nlet output = msg.charge.threshold_energy || 0; // kWh\noutput = Math.max(output, 0);\n\n// Upper bound\noutput = Math.min(output, msg.batteries_max_energy);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1800,
        "y":  200,
        "wires":  [
                      [
                          "444691a796ca56fe"
                      ]
                  ]
    },
    {
        "id":  "444691a796ca56fe",
        "type":  "api-call-service",
        "z":  "a630e82fe7e8cfbe",
        "g":  "1fecf8a6c7a23d70",
        "name":  "Set desired energy reserve",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_strategy_charge_target_energy"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": $$.payload}",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  2010,
        "y":  200,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "27cfd005b02861b3",
        "type":  "rbe",
        "z":  "a630e82fe7e8cfbe",
        "g":  "1fecf8a6c7a23d70",
        "name":  "Desired energy changed",
        "func":  "rbe",
        "gap":  "",
        "start":  "",
        "inout":  "out",
        "septopics":  false,
        "property":  "payload",
        "topi":  "topic",
        "x":  1600,
        "y":  200,
        "wires":  [
                      [
                          "f3e7ffd19df9c1ee"
                      ]
                  ]
    },
    {
        "id":  "0454f476e5a759d3",
        "type":  "debug",
        "z":  "a630e82fe7e8cfbe",
        "g":  "5959322bdec01c15",
        "name":  "debug 2",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "payload",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "counter",
        "x":  410,
        "y":  120,
        "wires":  [

                  ]
    },
    {
        "id":  "f23879efb432f0db",
        "type":  "catch",
        "z":  "a630e82fe7e8cfbe",
        "g":  "afebfb6a35f6a0c7",
        "name":  "",
        "scope":  null,
        "uncaught":  false,
        "x":  75,
        "y":  420,
        "wires":  [
                      [
                          "a689d6ceced72732"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "a689d6ceced72732",
        "type":  "function",
        "z":  "a630e82fe7e8cfbe",
        "g":  "afebfb6a35f6a0c7",
        "name":  "Unhandled Exception",
        "func":  "const handle = global.get(\u0027unhandledException\u0027);\n\nhandle(this);\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  125,
        "y":  420,
        "wires":  [
                      [
                          "9b81fcbf318a1c09"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "9b81fcbf318a1c09",
        "type":  "link out",
        "z":  "a630e82fe7e8cfbe",
        "g":  "afebfb6a35f6a0c7",
        "name":  "link out 3",
        "mode":  "return",
        "links":  [

                  ],
        "x":  175,
        "y":  420,
        "wires":  [

                  ]
    },
    {
        "id":  "176d29a.6f648d6",
        "type":  "server",
        "name":  "Home Assistant",
        "addon":  true,
        "rejectUnauthorizedCerts":  true,
        "ha_boolean":  "",
        "connectionDelay":  false,
        "cacheJson":  false,
        "heartbeat":  false,
        "heartbeatInterval":  "",
        "statusSeparator":  "",
        "enableGlobalContextStore":  false
    },
    {
        "id":  "99345ea3284e39c0",
        "type":  "global-config",
        "env":  [

                ],
        "modules":  {
                        "node-red-contrib-home-assistant-websocket":  "0.80.3"
                    }
    },
    {
        "id":  "676ceac4c521834d",
        "type":  "tab",
        "label":  "Strategy Charge PV v4.4.0",
        "disabled":  false,
        "info":  "",
        "env":  [

                ]
    },
    {
        "id":  "9889d591bcc38e89",
        "type":  "group",
        "z":  "676ceac4c521834d",
        "name":  "Battery solutions",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "87be4b85f89829b6",
                      "d62d870eb44d3582"
                  ],
        "x":  624,
        "y":  79,
        "w":  192,
        "h":  142
    },
    {
        "id":  "72059e541379a869",
        "type":  "group",
        "z":  "676ceac4c521834d",
        "name":  "Start",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "a5e9e484430e1720",
                      "bf548077ba6ca350",
                      "be2a48e071dee195"
                  ],
        "x":  14,
        "y":  79,
        "w":  192,
        "h":  162
    },
    {
        "id":  "6e6682265db1e9ee",
        "type":  "group",
        "z":  "676ceac4c521834d",
        "name":  "Unhandled exceptions",
        "style":  {
                      "label":  true,
                      "stroke":  "#d88a8a",
                      "color":  "#d88a8a"
                  },
        "nodes":  [
                      "524b61f06ac20ae7",
                      "b068ce351aa5b926",
                      "0d26b7f936be7947"
                  ],
        "x":  14,
        "y":  259,
        "w":  182,
        "h":  82
    },
    {
        "id":  "a5e9e484430e1720",
        "type":  "link in",
        "z":  "676ceac4c521834d",
        "g":  "72059e541379a869",
        "name":  "Charge PV",
        "links":  [

                  ],
        "x":  100,
        "y":  160,
        "wires":  [
                      [
                          "be2a48e071dee195"
                      ]
                  ],
        "l":  true
    },
    {
        "id":  "13aeb5c39ba83e0a",
        "type":  "comment",
        "z":  "676ceac4c521834d",
        "name":  "Home Battery Strategy",
        "info":  "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon\u0027t modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x":  120,
        "y":  40,
        "wires":  [

                  ]
    },
    {
        "id":  "bf548077ba6ca350",
        "type":  "comment",
        "z":  "676ceac4c521834d",
        "g":  "72059e541379a869",
        "name":  "Start (readme)",
        "info":  "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the \u003cselect\u003e option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select \u0027AcmE example\u0027\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled \u0027AcmE example\u0027 (case sensitive).",
        "x":  110,
        "y":  120,
        "wires":  [

                  ]
    },
    {
        "id":  "87be4b85f89829b6",
        "type":  "link out",
        "z":  "676ceac4c521834d",
        "g":  "9889d591bcc38e89",
        "name":  "Return",
        "mode":  "return",
        "links":  [

                  ],
        "x":  665,
        "y":  180,
        "wires":  [

                  ]
    },
    {
        "id":  "d62d870eb44d3582",
        "type":  "comment",
        "z":  "676ceac4c521834d",
        "g":  "9889d591bcc38e89",
        "name":  "End (readme)",
        "info":  "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x":  720,
        "y":  120,
        "wires":  [

                  ]
    },
    {
        "id":  "682972c51f2870ed",
        "type":  "function",
        "z":  "676ceac4c521834d",
        "name":  "Setup",
        "func":  "// explain\nconst log = global.get(\"logger\");\nlog(this,\"Using self-consumption to charge with surplus PV\")\n\n// use the self consumption strategy to charge when there is PV surplus\nmsg.target = \"Self-consumption\";\n\n// tell that strategy to disalow discharging\nconst DISABLE_DISCHARGE = true;\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\",DISABLE_DISCHARGE,true);\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  310,
        "y":  180,
        "wires":  [
                      [
                          "17645a134fe6d941"
                      ]
                  ]
    },
    {
        "id":  "17645a134fe6d941",
        "type":  "link call",
        "z":  "676ceac4c521834d",
        "name":  "Self-consumption",
        "links":  [

                  ],
        "linkType":  "dynamic",
        "timeout":  "5",
        "x":  470,
        "y":  180,
        "wires":  [
                      [
                          "d612533a5317bb76",
                          "87be4b85f89829b6"
                      ]
                  ]
    },
    {
        "id":  "d612533a5317bb76",
        "type":  "debug",
        "z":  "676ceac4c521834d",
        "name":  "Batteries charging?",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "batteries_charging",
        "targetType":  "msg",
        "statusVal":  "payload",
        "statusType":  "auto",
        "x":  730,
        "y":  260,
        "wires":  [

                  ]
    },
    {
        "id":  "be2a48e071dee195",
        "type":  "change",
        "z":  "676ceac4c521834d",
        "g":  "72059e541379a869",
        "name":  "Trace",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "strategy.trace",
                          "pt":  "msg",
                          "to":  "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                          "tot":  "jsonata"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  90,
        "y":  200,
        "wires":  [
                      [
                          "682972c51f2870ed"
                      ]
                  ],
        "info":  "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id":  "524b61f06ac20ae7",
        "type":  "catch",
        "z":  "676ceac4c521834d",
        "g":  "6e6682265db1e9ee",
        "name":  "",
        "scope":  null,
        "uncaught":  false,
        "x":  55,
        "y":  300,
        "wires":  [
                      [
                          "b068ce351aa5b926"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "b068ce351aa5b926",
        "type":  "function",
        "z":  "676ceac4c521834d",
        "g":  "6e6682265db1e9ee",
        "name":  "Unhandled Exception",
        "func":  "const handle = global.get(\u0027unhandledException\u0027);\n\nhandle(this);\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  105,
        "y":  300,
        "wires":  [
                      [
                          "0d26b7f936be7947"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "0d26b7f936be7947",
        "type":  "link out",
        "z":  "676ceac4c521834d",
        "g":  "6e6682265db1e9ee",
        "name":  "link out 4",
        "mode":  "return",
        "links":  [

                  ],
        "x":  155,
        "y":  300,
        "wires":  [

                  ]
    },
    {
        "id":  "07c2cad2b434e852",
        "type":  "tab",
        "label":  "Strategy Dynamic v4.4.0",
        "disabled":  false,
        "info":  "Dynamic contract automated management",
        "env":  [

                ]
    },
    {
        "id":  "0d1c848a79a2cc88",
        "type":  "group",
        "z":  "07c2cad2b434e852",
        "name":  "Battery solutions",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "47b198d28308dc41",
                      "35c93645023c087b"
                  ],
        "x":  934,
        "y":  79,
        "w":  192,
        "h":  142
    },
    {
        "id":  "f2db5201c2533640",
        "type":  "group",
        "z":  "07c2cad2b434e852",
        "name":  "Home battery start",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "1171e155377fedd2",
                      "07f426c7733faf07",
                      "96fb1d1906bb1409"
                  ],
        "x":  14,
        "y":  79,
        "w":  192,
        "h":  162
    },
    {
        "id":  "129fcbab388b5e4b",
        "type":  "group",
        "z":  "07c2cad2b434e852",
        "name":  "Plan",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "d61be082028491a7",
                      "13e9cbacc106d2a8",
                      "496204469be0f0c0",
                      "2e86abb2935aba9c",
                      "3262bf8323599c02",
                      "c5038c359cd68abd",
                      "8c31e5f5a5a27de8"
                  ],
        "x":  228,
        "y":  273,
        "w":  1244,
        "h":  1054
    },
    {
        "id":  "b6fefcd33af36bf2",
        "type":  "group",
        "z":  "07c2cad2b434e852",
        "name":  "Execute",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "7fe3d6c1ce192883",
                      "3fa468003cd94acd",
                      "e272124293b40aeb",
                      "4543fe44cc846742",
                      "5a75560391befa37"
                  ],
        "x":  234,
        "y":  119,
        "w":  672,
        "h":  122
    },
    {
        "id":  "81709525cdc25410",
        "type":  "group",
        "z":  "07c2cad2b434e852",
        "name":  "Test area",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "d368783101b245b5",
                      "112f5f90b4b145bb",
                      "8a91cd336bb28266",
                      "a136c0daa75ae149",
                      "004b471c35064800",
                      "9973dcb96d6d2f55",
                      "6510e03f1398d5f4",
                      "ced59ec71a043342"
                  ],
        "x":  234,
        "y":  1479,
        "w":  912,
        "h":  162
    },
    {
        "id":  "e681f8531d5e6e5f",
        "type":  "group",
        "z":  "07c2cad2b434e852",
        "name":  "All data",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "1bebb27b2bad23de",
                      "581f04a86e737d5b",
                      "a517a28c626ccbc8",
                      "a18cc9706936ab5a",
                      "6d34858ef484f2c3"
                  ],
        "x":  234,
        "y":  1659,
        "w":  672,
        "h":  142
    },
    {
        "id":  "483ab3bd68ac6e38",
        "type":  "group",
        "z":  "07c2cad2b434e852",
        "name":  "Unhandled exceptions",
        "style":  {
                      "label":  true,
                      "stroke":  "#d88a8a",
                      "color":  "#d88a8a"
                  },
        "nodes":  [
                      "3673345e464d2bdb",
                      "223c1c24685b90d5",
                      "038cd97542fa16fc"
                  ],
        "x":  24,
        "y":  279,
        "w":  182,
        "h":  82
    },
    {
        "id":  "3262bf8323599c02",
        "type":  "group",
        "z":  "07c2cad2b434e852",
        "g":  "129fcbab388b5e4b",
        "name":  "API call to Data Source",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "ee13c52058f6f591",
                      "f326ee1afc340c48",
                      "86b8dba1e6cb50ac",
                      "07fb00e5a637d037",
                      "ef7c0a337307bf74",
                      "c7883feb8b3d7ee5",
                      "9a38215838980d72",
                      "1350a7978831f30f",
                      "018761757d6ddf7b",
                      "59cd6ae303b7afa4",
                      "6e989b0e5c7cf3f6",
                      "b03939e3449d3064",
                      "6ba3a1f665d40e9b",
                      "8f7d0ffe033a5d2e",
                      "a5c7382e09883cde",
                      "9e1aa94620413143",
                      "f451432079ac8133",
                      "22d5155ac4b0ec82",
                      "f1067e94ed157eca",
                      "3db4b690645db6ba"
                  ],
        "x":  254,
        "y":  519,
        "w":  752,
        "h":  362
    },
    {
        "id":  "c5038c359cd68abd",
        "type":  "group",
        "z":  "07c2cad2b434e852",
        "g":  "129fcbab388b5e4b",
        "name":  "Update when",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "7d7329b919edfec9",
                      "6377eed01fd6cf2c",
                      "3bd28294cfb1f3eb",
                      "ec07540e4271f463",
                      "cd79161282ff0f2f",
                      "fb21652c713abc90",
                      "9e560348ee335ba1",
                      "082558a90abd9f8c",
                      "3b4267436ee03576",
                      "2a6e33cc87aa7221",
                      "6eeae62f7de78ca6",
                      "8b111d3e68952669",
                      "f9f57e89bc9e7f9b",
                      "e1d3d27ed0f823d5",
                      "623ab6bfaec74d52",
                      "33c33befc9e6d436",
                      "b169a4da76d9ca46",
                      "0bbc71b06a0dbe5e"
                  ],
        "x":  254,
        "y":  299,
        "w":  1192,
        "h":  202
    },
    {
        "id":  "8c31e5f5a5a27de8",
        "type":  "group",
        "z":  "07c2cad2b434e852",
        "g":  "129fcbab388b5e4b",
        "name":  "Determine strategy",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "b6a5ef084f9522a2",
                      "5da03558b30d3290",
                      "b32ee5375f92f493",
                      "fb73833d2b196ee1",
                      "3f5ab61dcbb6c293",
                      "29bcdcea59ca28f4",
                      "7c318e0aa0fb868d",
                      "6491fddce70826c7",
                      "2d80e807bb1c60e9",
                      "4d7c4fa6f54a79a4",
                      "80a410bf4cddb6cd",
                      "49ccc70aaf344a8a",
                      "ac40e2ac7a41e22a",
                      "e79dda0d9d4d8870",
                      "6c98fc543bba3c7a",
                      "1dbb7efd95aee252"
                  ],
        "x":  254,
        "y":  899,
        "w":  872,
        "h":  402
    },
    {
        "id":  "8b111d3e68952669",
        "type":  "junction",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "x":  640,
        "y":  340,
        "wires":  [
                      [
                          "9e560348ee335ba1"
                      ]
                  ]
    },
    {
        "id":  "1171e155377fedd2",
        "type":  "link in",
        "z":  "07c2cad2b434e852",
        "g":  "f2db5201c2533640",
        "name":  "Dynamic",
        "links":  [

                  ],
        "x":  100,
        "y":  160,
        "wires":  [
                      [
                          "96fb1d1906bb1409"
                      ]
                  ],
        "l":  true
    },
    {
        "id":  "6d141b32c6d37d97",
        "type":  "comment",
        "z":  "07c2cad2b434e852",
        "name":  "Home Battery Strategy",
        "info":  "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon\u0027t modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x":  120,
        "y":  40,
        "wires":  [

                  ]
    },
    {
        "id":  "07f426c7733faf07",
        "type":  "comment",
        "z":  "07c2cad2b434e852",
        "g":  "f2db5201c2533640",
        "name":  "Start (readme)",
        "info":  "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the \u003cselect\u003e option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select \u0027AcmE example\u0027\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled \u0027AcmE example\u0027 (case sensitive).",
        "x":  110,
        "y":  120,
        "wires":  [

                  ]
    },
    {
        "id":  "47b198d28308dc41",
        "type":  "link out",
        "z":  "07c2cad2b434e852",
        "g":  "0d1c848a79a2cc88",
        "name":  "Return",
        "mode":  "return",
        "links":  [

                  ],
        "x":  975,
        "y":  180,
        "wires":  [

                  ]
    },
    {
        "id":  "35c93645023c087b",
        "type":  "comment",
        "z":  "07c2cad2b434e852",
        "g":  "0d1c848a79a2cc88",
        "name":  "End (readme)",
        "info":  "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x":  1030,
        "y":  120,
        "wires":  [

                  ]
    },
    {
        "id":  "ee13c52058f6f591",
        "type":  "api-render-template",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Cheapest",
        "server":  "176d29a.6f648d6",
        "version":  0,
        "template":  "{}",
        "resultsLocation":  "dynamic.data_cheapest",
        "resultsLocationType":  "msg",
        "templateLocation":  "",
        "templateLocationType":  "none",
        "x":  460,
        "y":  660,
        "wires":  [
                      [
                          "86b8dba1e6cb50ac"
                      ]
                  ]
    },
    {
        "id":  "f326ee1afc340c48",
        "type":  "api-render-template",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Expensive",
        "server":  "176d29a.6f648d6",
        "version":  0,
        "template":  "",
        "resultsLocation":  "dynamic.data_expensive",
        "resultsLocationType":  "msg",
        "templateLocation":  "",
        "templateLocationType":  "none",
        "x":  470,
        "y":  720,
        "wires":  [
                      [
                          "07fb00e5a637d037"
                      ]
                  ]
    },
    {
        "id":  "b6a5ef084f9522a2",
        "type":  "debug",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Complete message",
        "active":  true,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "true",
        "targetType":  "full",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  910,
        "y":  1220,
        "wires":  [

                  ]
    },
    {
        "id":  "86b8dba1e6cb50ac",
        "type":  "json",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "",
        "property":  "dynamic.data_cheapest",
        "action":  "obj",
        "pretty":  false,
        "x":  555,
        "y":  660,
        "wires":  [
                      [
                          "1350a7978831f30f"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "07fb00e5a637d037",
        "type":  "json",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "",
        "property":  "dynamic.data_expensive",
        "action":  "obj",
        "pretty":  false,
        "x":  575,
        "y":  720,
        "wires":  [
                      [
                          "f451432079ac8133"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "5da03558b30d3290",
        "type":  "function",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Determine dynamic strategy",
        "func":  "// logger, usage: log(this, \"\");\nconst log = global.get(\u0027logger\u0027);\n\n// 1.   Input\n// Conversion\nconst CONVERSION_RATE = parseFloat(RED.util.getMessageProperty(msg, \"dynamic.value_conversion\")) || 1;\n\n// extract start/end date objects\nconst start_cheapest = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.start\"));\nconst start_expensive = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_expensive.start\"));\nconst end_cheapest = new Date(RED.util.getMessageProperty(msg, \"dynamic.data_cheapest.end\"));\nconst end_expensive = new Date(RED.util.getMessageProperty(msg, \"dynamic.data_expensive.end\"));\nlet isCheapestNext = true;\n// stored price cheapest period\nlet lastCheapestPrice = context.last_cheapest_price || 0; // unit: cents/kWh\nconst nextCheapestPrice = parseInt(RED.util.getMessageProperty(msg, \"dynamic.data_cheapest.average\") / CONVERSION_RATE * 100); // unit: cents/kWh \n// average price expensive period\nconst lastExpensivePrice = parseInt(RED.util.getMessageProperty(msg, \"dynamic.data_expensive.average\") / CONVERSION_RATE * 100); // unit: cents/kWh\n// threshold rate for cheapest period\nconst cheapestThresholdCents = parseInt(RED.util.getMessageProperty(msg, \"dynamic.threshold_cheapest_cents\")) || 0; // unit: cents\n// threshold delta for expensive period\nconst deltaThresholdCents = parseInt(RED.util.getMessageProperty(msg, \"dynamic.min_delta_cents\")) || 0; // unit: cents\n\n// 1.1  Enums\nconst STRATEGY = {\n    CHEAPEST: RED.util.getMessageProperty(msg,\"dynamic.strategy_cheapest\") || \"Charge\", \n    NEUTRAL: RED.util.getMessageProperty(msg,\"dynamic.strategy_default\") || \"Charge PV\",\n    EXPENSIVE: RED.util.getMessageProperty(msg,\"dynamic.strategy_expensive\") || \"Self-consumption\"\n}\n\n// 1.2  Defaults   \nmsg.dynamic.avg_cheapest_tariff = 0;\nmsg.dynamic.avg_expensive_tariff = 0;\nmsg.dynamic.avg_delta = 0;\n\n// 2.   Tariffs\n// Check if the Date objects are valid. If \u0027Invalid Date\u0027, stop and warn the user.\nif (isNaN(start_cheapest.getTime()) || isNaN(start_expensive.getTime())) {\n    // warn user\n    log(this, `One or both dates are invalid. Cheap = ${start_cheapest}, Expensive = ${start_expensive}`,\"warn\");\n    node.status({fill:\"red\",shape:\"ring\",text:`One or both dates are invalid: ${start_cheapest}, ${start_expensive}`});\n    // fallback strategy\n    flow.set(\"dynamic_strategy\", STRATEGY.NEUTRAL);\n    // proceed to UI\n    return msg;\n}\n\n// Check if cheapest lies before expensive\nif (start_cheapest \u003c start_expensive) {\n    log(this, `Cheapest moment lies before expensive moment. Cheapest moment: ${start_cheapest}, Expensive = ${start_expensive}`);\n    // store the cheapest price to compare it with future expensive rates, to determine if it\u0027s economical to discharge.\n    context.last_cheapest_price = nextCheapestPrice; // store for next iteration\n    lastCheapestPrice = nextCheapestPrice; // used for this iteration\n    log(this, `Cheapest price set to ${lastCheapestPrice} cents`);\n}\n\nif (lastCheapestPrice == 0) {\n    log(this, `I can\u0027t recall the tariff used for charging. Cheapest price set to \u0027${lastCheapestPrice}\u0027 cents`);\n}\n\n// delta \u003e N cents ? -\u003e charging is economical\nconst delta = (lastExpensivePrice - lastCheapestPrice); // unit: cents\n\n// UI values\nmsg.dynamic.avg_cheapest_tariff = lastCheapestPrice;\nmsg.dynamic.avg_expensive_tariff = lastExpensivePrice;\nmsg.dynamic.avg_delta = delta;\n\n// 3.   Strategy selection logic\n// for string time\nfunction isTimeInPeriod(startStr, endStr) {\n    const now = new Date();\n    const start = new Date(startStr);\n    const end = new Date(endStr);\n    return (now \u003e= start \u0026\u0026 now \u003c end);\n}\n// 3.1  is_now - which period have we entered?\nconst now = new Date();\n/** @type {boolean} */\nconst cheapestIsNow = now \u003e= start_cheapest \u0026\u0026 now \u003c= end_cheapest;\n// const cheapestIsNow = RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.is_now\");\n/** @type {boolean} */\nconst expensiveIsNow = now \u003e= start_expensive \u0026\u0026 now \u003c= end_expensive;\n// const expensiveIsNow = RED.util.getMessageProperty(msg, \"dynamic.data_expensive.is_now\");\n\n// 3.2  Set strategy\n// Default strategy\nmsg.dynamic.strategy = STRATEGY.NEUTRAL;\n\n// Cheapest period?\nif (cheapestIsNow \u0026\u0026 lastCheapestPrice \u003c= cheapestThresholdCents) {\n    msg.dynamic.strategy = STRATEGY.CHEAPEST;\n    // Explain\n    log(this, `**Cheapest period is NOW**, price limit: ${lastCheapestPrice}/${cheapestThresholdCents} cents OK`);\n} else if(cheapestIsNow) {\n    // Explain why skipped\n    log(this, `**Cheapest period SKIPPED**, the cheapest period is too expensive today. Price limit: ${lastCheapestPrice}/${cheapestThresholdCents} cents.`);\n}\n\n// Expensive period?\nif (expensiveIsNow \u0026\u0026 delta \u003e= deltaThresholdCents) {\n    msg.dynamic.strategy = STRATEGY.EXPENSIVE;\n    // Explain\n    log(this, `**Expensive period is NOW**, price delta: ${delta}\u003e=${deltaThresholdCents} cents OK`);\n} else if(expensiveIsNow) {\n    // Explain why skipped\n    log(this, `**Expensive period SKIPPED**, price delta too small: ${lastExpensivePrice}-${lastCheapestPrice}=${delta} cents \u003c= ${deltaThresholdCents} cents`); \n}\n\n// 3.3  Store the strategy in flow-context. The \u0027Execution\u0027 area will read from the flow-context.\nflow.set(\"dynamic_strategy\",msg.dynamic.strategy);\n\n// 4.   User feedback\n// Node status\nnode.status({ fill: \"blue\", shape: \"dot\", text: `${msg.dynamic.strategy}; ${cheapestIsNow} + ${expensiveIsNow} @ ${delta} cents` });\n// Explain\nlog(this, `Strategy set to **${msg.dynamic.strategy}**`);\n\n// Proceed to UI update\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  620,
        "y":  1140,
        "wires":  [
                      [
                          "b6a5ef084f9522a2",
                          "b32ee5375f92f493",
                          "fb73833d2b196ee1",
                          "3f5ab61dcbb6c293",
                          "29bcdcea59ca28f4",
                          "7c318e0aa0fb868d",
                          "6491fddce70826c7",
                          "2d80e807bb1c60e9",
                          "4d7c4fa6f54a79a4"
                      ]
                  ]
    },
    {
        "id":  "7fe3d6c1ce192883",
        "type":  "change",
        "z":  "07c2cad2b434e852",
        "g":  "b6fefcd33af36bf2",
        "name":  "Set strategy",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "target",
                          "pt":  "msg",
                          "to":  "dynamic_strategy",
                          "tot":  "flow"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  510,
        "y":  200,
        "wires":  [
                      [
                          "5a75560391befa37"
                      ]
                  ]
    },
    {
        "id":  "3fa468003cd94acd",
        "type":  "link call",
        "z":  "07c2cad2b434e852",
        "g":  "b6fefcd33af36bf2",
        "name":  "Sub-strategy",
        "links":  [

                  ],
        "linkType":  "dynamic",
        "timeout":  "3",
        "x":  810,
        "y":  180,
        "wires":  [
                      [
                          "47b198d28308dc41"
                      ]
                  ]
    },
    {
        "id":  "b32ee5375f92f493",
        "type":  "api-call-service",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Cheapest Start",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_datetime.set_datetime",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_datetime.house_battery_strategy_dynamic_cheapest_start"
                     ],
        "labelId":  [

                    ],
        "data":  "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.start).format(\u0027YYYY-MM-DD HH:mm:ss\u0027)\t}",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_datetime",
        "service":  "set_datetime",
        "x":  900,
        "y":  940,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "fb73833d2b196ee1",
        "type":  "api-call-service",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Cheapest End",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_datetime.set_datetime",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_datetime.house_battery_strategy_dynamic_cheapest_end"
                     ],
        "labelId":  [

                    ],
        "data":  "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.end).format(\u0027YYYY-MM-DD HH:mm:ss\u0027)\t}",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_datetime",
        "service":  "set_datetime",
        "x":  900,
        "y":  980,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "3f5ab61dcbb6c293",
        "type":  "api-call-service",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Expensive Start",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_datetime.set_datetime",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_datetime.house_battery_strategy_dynamic_expensive_start"
                     ],
        "labelId":  [

                    ],
        "data":  "{\t    \"datetime\": $moment($$.dynamic.data_expensive.start).format(\u0027YYYY-MM-DD HH:mm:ss\u0027)\t}",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_datetime",
        "service":  "set_datetime",
        "x":  900,
        "y":  1020,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "29bcdcea59ca28f4",
        "type":  "api-call-service",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Expensive End",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_datetime.set_datetime",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_datetime.house_battery_strategy_dynamic_expensive_end"
                     ],
        "labelId":  [

                    ],
        "data":  "{\t    \"datetime\": $moment($$.dynamic.data_expensive.end).format(\u0027YYYY-MM-DD HH:mm:ss\u0027)\t}",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_datetime",
        "service":  "set_datetime",
        "x":  900,
        "y":  1060,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "7d7329b919edfec9",
        "type":  "inject",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Every 60 min",
        "props":  [
                      {
                          "p":  "payload"
                      },
                      {
                          "p":  "topic",
                          "vt":  "str"
                      }
                  ],
        "repeat":  "",
        "crontab":  "0 0-23 * * *",
        "once":  false,
        "onceDelay":  "3",
        "topic":  "",
        "payload":  "",
        "payloadType":  "date",
        "x":  380,
        "y":  420,
        "wires":  [
                      [
                          "6377eed01fd6cf2c"
                      ]
                  ]
    },
    {
        "id":  "e272124293b40aeb",
        "type":  "switch",
        "z":  "07c2cad2b434e852",
        "g":  "b6fefcd33af36bf2",
        "name":  "Has strategy",
        "property":  "dynamic_strategy",
        "propertyType":  "flow",
        "rules":  [
                      {
                          "t":  "null"
                      },
                      {
                          "t":  "else"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  2,
        "x":  330,
        "y":  180,
        "wires":  [
                      [
                          "4543fe44cc846742"
                      ],
                      [
                          "7fe3d6c1ce192883"
                      ]
                  ]
    },
    {
        "id":  "4543fe44cc846742",
        "type":  "change",
        "z":  "07c2cad2b434e852",
        "g":  "b6fefcd33af36bf2",
        "name":  "Set Full stop",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "target",
                          "pt":  "msg",
                          "to":  "Full stop",
                          "tot":  "str"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  510,
        "y":  160,
        "wires":  [
                      [
                          "5a75560391befa37"
                      ]
                  ]
    },
    {
        "id":  "112f5f90b4b145bb",
        "type":  "inject",
        "z":  "07c2cad2b434e852",
        "g":  "81709525cdc25410",
        "name":  "Test",
        "props":  [
                      {
                          "p":  "payload"
                      },
                      {
                          "p":  "topic",
                          "vt":  "str"
                      }
                  ],
        "repeat":  "",
        "crontab":  "",
        "once":  false,
        "onceDelay":  0.1,
        "topic":  "",
        "payload":  "",
        "payloadType":  "date",
        "x":  330,
        "y":  1520,
        "wires":  [
                      [
                          "d368783101b245b5"
                      ]
                  ]
    },
    {
        "id":  "d368783101b245b5",
        "type":  "api-render-template",
        "z":  "07c2cad2b434e852",
        "g":  "81709525cdc25410",
        "name":  "Cheapest",
        "server":  "176d29a.6f648d6",
        "version":  0,
        "template":  "{% from \u0027cheapest_energy_hours.jinja\u0027 import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation":  "cheapest",
        "resultsLocationType":  "msg",
        "templateLocation":  "",
        "templateLocationType":  "none",
        "x":  500,
        "y":  1520,
        "wires":  [
                      [
                          "8a91cd336bb28266"
                      ]
                  ]
    },
    {
        "id":  "8a91cd336bb28266",
        "type":  "json",
        "z":  "07c2cad2b434e852",
        "g":  "81709525cdc25410",
        "name":  "",
        "property":  "cheapest",
        "action":  "obj",
        "pretty":  false,
        "x":  595,
        "y":  1520,
        "wires":  [
                      [
                          "a136c0daa75ae149"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "a136c0daa75ae149",
        "type":  "api-render-template",
        "z":  "07c2cad2b434e852",
        "g":  "81709525cdc25410",
        "name":  "Expensive",
        "server":  "176d29a.6f648d6",
        "version":  0,
        "template":  "{% from \u0027cheapest_energy_hours.jinja\u0027 import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    lowest=false,\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation":  "expensive",
        "resultsLocationType":  "msg",
        "templateLocation":  "",
        "templateLocationType":  "none",
        "x":  750,
        "y":  1520,
        "wires":  [
                      [
                          "004b471c35064800"
                      ]
                  ]
    },
    {
        "id":  "004b471c35064800",
        "type":  "json",
        "z":  "07c2cad2b434e852",
        "g":  "81709525cdc25410",
        "name":  "",
        "property":  "expensive",
        "action":  "obj",
        "pretty":  false,
        "x":  855,
        "y":  1520,
        "wires":  [
                      [
                          "9973dcb96d6d2f55",
                          "6510e03f1398d5f4",
                          "ced59ec71a043342"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "9973dcb96d6d2f55",
        "type":  "debug",
        "z":  "07c2cad2b434e852",
        "g":  "81709525cdc25410",
        "name":  "Cheap",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "cheapest.start",
        "targetType":  "msg",
        "statusVal":  "cheapest.start",
        "statusType":  "auto",
        "x":  990,
        "y":  1560,
        "wires":  [

                  ]
    },
    {
        "id":  "6510e03f1398d5f4",
        "type":  "debug",
        "z":  "07c2cad2b434e852",
        "g":  "81709525cdc25410",
        "name":  "Expensive",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "expensive.start",
        "targetType":  "msg",
        "statusVal":  "payload",
        "statusType":  "auto",
        "x":  1010,
        "y":  1600,
        "wires":  [

                  ]
    },
    {
        "id":  "1bebb27b2bad23de",
        "type":  "api-render-template",
        "z":  "07c2cad2b434e852",
        "g":  "e681f8531d5e6e5f",
        "name":  "All Zonneplan",
        "server":  "176d29a.6f648d6",
        "version":  0,
        "template":  "{% from \u0027cheapest_energy_hours.jinja\u0027 import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    include_tomorrow=true,\n    hours=\"all\",\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation":  "all_data",
        "resultsLocationType":  "msg",
        "templateLocation":  "",
        "templateLocationType":  "none",
        "x":  480,
        "y":  1700,
        "wires":  [
                      [
                          "a517a28c626ccbc8"
                      ]
                  ]
    },
    {
        "id":  "581f04a86e737d5b",
        "type":  "inject",
        "z":  "07c2cad2b434e852",
        "g":  "e681f8531d5e6e5f",
        "name":  "Fetch",
        "props":  [
                      {
                          "p":  "payload"
                      },
                      {
                          "p":  "topic",
                          "vt":  "str"
                      }
                  ],
        "repeat":  "",
        "crontab":  "",
        "once":  false,
        "onceDelay":  0.1,
        "topic":  "",
        "payload":  "",
        "payloadType":  "date",
        "x":  330,
        "y":  1700,
        "wires":  [
                      [
                          "1bebb27b2bad23de"
                      ]
                  ]
    },
    {
        "id":  "a517a28c626ccbc8",
        "type":  "json",
        "z":  "07c2cad2b434e852",
        "g":  "e681f8531d5e6e5f",
        "name":  "",
        "property":  "all_data",
        "action":  "obj",
        "pretty":  false,
        "x":  595,
        "y":  1700,
        "wires":  [
                      [
                          "a18cc9706936ab5a",
                          "6d34858ef484f2c3"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "6377eed01fd6cf2c",
        "type":  "delay",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "",
        "pauseType":  "delay",
        "timeout":  "1",
        "timeoutUnits":  "minutes",
        "rate":  "1",
        "nbRateUnits":  "1",
        "rateUnits":  "second",
        "randomFirst":  "1",
        "randomLast":  "5",
        "randomUnits":  "seconds",
        "drop":  false,
        "allowrate":  false,
        "outputs":  1,
        "x":  540,
        "y":  420,
        "wires":  [
                      [
                          "33c33befc9e6d436"
                      ]
                  ]
    },
    {
        "id":  "3bd28294cfb1f3eb",
        "type":  "api-current-state",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Source",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.house_battery_strategy_dynamic_data_source",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "dynamic.data_source",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  860,
        "y":  380,
        "wires":  [
                      [
                          "3b4267436ee03576"
                      ]
                  ]
    },
    {
        "id":  "ef7c0a337307bf74",
        "type":  "function",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Data source settings",
        "func":  "// logger, usage: log(this, \"\");\nconst log = global.get(\u0027logger\u0027);\n\n/*    From cheapes-energy-hours macro\n      See: https://github.com/TheFes/cheapest-energy-hours/blob/main/documentation/1-source_data.md#data-provider-settings\n\n      - None (default selection)\n      - Zonneplan\n      - Amber Electric\n      - EasyEnergy, EnergyZero (core)\n      - ENTSO-E\n      - Frank Energie\n      - GE-Spot\n      - Tibber, Nordpool (core)\n      - Tibber (custom)\n      - Nordpool (custom)\n      - PVPC (Spain)\n      - Octopus Energy\n      - Omie\n*/\n\nswitch (msg.dynamic.data_source) {\n      case \"None\":\n            // Handle the \u0027None\u0027 case (e.g., no supplier selected or data is unavailable)\n            log(this,\"No data source selected.\");\n            // Add config here...\n            break;\n\n      case \"Zonneplan\":\n            // Code for Zonneplan (a Dutch energy supplier)\n            log(this,\"Processing Zonneplan data.\");\n            // Add config here...\n            msg.dynamic.sensor=\u0027sensor.zonneplan_current_electricity_tariff\u0027; // when using: https://github.com/fsaris/home-assistant-zonneplan-one\n            msg.dynamic.attr_all=\u0027forecast\u0027;\n            msg.dynamic.value_key=\u0027electricity_price\u0027;\n            msg.dynamic.value_conversion = 10000000; // whole currency / kWh\n            break;\n\n      case \"Amber Electric\":\n            // Code for Amber Electric (Australian energy retailer)\n            log(this,\"Processing Amber Electric data.\");\n            // Add config here...\n            msg.dynamic.attr_all=\u0027forecasts\u0027; \n            msg.dynamic.time_key=\u0027start_time\u0027; \n            msg.dynamic.value_key=\u0027per_kwh\u0027;\n            break;\n\n      case \"EasyEnergy, EnergyZero (core)\":\n            // Code for EasyEnergy and EnergyZero (core/default implementation)\n            log(this,\"Processing EasyEnergy/EnergyZero core data.\");\n            // Add config here...\n            break;\n\n      case \"ENTSO-E\":\n            // Code for ENTSO-E (European Network of Transmission System Operators for Electricity)\n            log(this,\"Processing ENTSO-E data.\");\n            // Add config here...\n            msg.dynamic.attr_today=\u0027prices_today\u0027; \n            msg.dynamic.attr_tomorrow=\u0027prices_tomorrow\u0027; \n            msg.dynamic.time_key=\u0027time\u0027;\n            msg.dynamic.value_key=\u0027price\u0027;\n            break;\n\n      case \"Frank Energie\":\n            // Code for Frank Energie (Dutch energy supplier)\n            log(this,\"Processing Frank Energie data.\");\n            // Add config here...\n            msg.dynamic.sensor = \u0027sensor.frank_energie_prijzen_gemiddelde_elektriciteitsprijs_alle_uren_all_in\u0027; // when using: https://github.com/HiDiHo01/home-assistant-frank_energie\n            msg.dynamic.attr_all = \u0027prices\u0027; \n            msg.dynamic.time_key = \u0027from\u0027; \n            msg.dynamic.value_key = \u0027price\u0027;\n            break;\n\n      case \"GE-Spot\":\n            // Code for GE-Spot (Global Electric Spot price)\n            log(this,\"Processing GE-Spot data.\");\n            // Add config here...\n            msg.dynamic.attr_today = \u0027today_hourly_prices\u0027; // using the hourly version. today_interval_prices is per 15 mins\n            msg.dynamic.attr_tomorrow = \u0027tomorrow_hourly_prices\u0027; // using the hourly version\n            msg.dynamic.time_key = \u0027time\u0027; \n            msg.dynamic.value_key = \u0027value\u0027;\n            break;\n\n      case \"Tibber, Nordpool (core)\":\n            // Code for Tibber and Nordpool (core/default implementation)\n            log(this,\"Processing Tibber/Nordpool core data.\");\n            // Add config here...\n            msg.dynamic.sensor = \u0027sensor.tibber_ceh_prices\u0027;\n            msg.dynamic.attr_today = \u0027today\u0027;\n            msg.dynamic.attr_tomorrow = \u0027tomorrow\u0027;\n            msg.dynamic.time_key = \u0027start\u0027;\n            msg.dynamic.value_key = \u0027value\u0027;\n            msg.dynamic.datetime_in_data = true; // datetime is in the data\n            break;\n\n      case \"Tibber (custom)\":\n            // Code for a custom Tibber setup/configuration\n            log(this,\"Processing Tibber custom data.\");\n            // Add config here...\n            msg.dynamic.attr_today = \u0027today\u0027;\n            msg.dynamic.attr_tomorrow = \u0027tomorrow\u0027;\n            msg.dynamic.datetime_in_data = false;\n            break;\n\n      case \"Nordpool (custom)\":\n            // Code for a custom Nordpool setup/configuration\n            log(this,\"Processing Nordpool custom data.\");\n            // Add config here...\n            break;\n\n      case \"PVPC (Spain)\":\n            // Code for PVPC (Voluntary Price for Small Consumers in Spain)\n            log(this,\"Processing Spanish PVPC data.\");\n            // Add config here...\n            break;\n\n      case \"Octopus Energy\":\n            // Code for Octopus Energy (UK/international energy supplier)\n            log(this,\"Processing Octopus Energy data.\");\n            // Add config here...\n            msg.dynamic.attr_all = \u0027rates\u0027; \n            msg.dynamic.value_key = \u0027value_incl_vat\u0027;\n            break;\n\n      case \"Omie\":\n            // Code for Omie (Iberian Energy Market Operator)\n            log(this,\"Processing Omie data.\");\n            // Add config here...\n            break;\n\n      default:\n            // Code to execute if the supplier does not match any of the above cases\n            node.warn(`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            log(this,`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            // Add default error handling...\n}\n\nlog(this, \"Performing API calls...\");\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  380,
        "y":  600,
        "wires":  [
                      [
                          "c7883feb8b3d7ee5"
                      ]
                  ]
    },
    {
        "id":  "ec07540e4271f463",
        "type":  "api-current-state",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Cheapest N hrs",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_strategy_dynamic_cheapest_hrs",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "dynamic.cheapest_hrs",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  1100,
        "y":  380,
        "wires":  [
                      [
                          "cd79161282ff0f2f"
                      ]
                  ]
    },
    {
        "id":  "cd79161282ff0f2f",
        "type":  "api-current-state",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Expensive N hrs",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_strategy_dynamic_expensive_hrs",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "dynamic.expensive_hrs",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  1100,
        "y":  420,
        "wires":  [
                      [
                          "f9f57e89bc9e7f9b"
                      ]
                  ]
    },
    {
        "id":  "fb21652c713abc90",
        "type":  "inject",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Check period",
        "props":  [
                      {
                          "p":  "payload"
                      },
                      {
                          "p":  "topic",
                          "vt":  "str"
                      }
                  ],
        "repeat":  "",
        "crontab":  "*/15 0-23 * * *",
        "once":  true,
        "onceDelay":  "3",
        "topic":  "",
        "payload":  "",
        "payloadType":  "date",
        "x":  380,
        "y":  380,
        "wires":  [
                      [
                          "9e560348ee335ba1"
                      ]
                  ]
    },
    {
        "id":  "9e560348ee335ba1",
        "type":  "function",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Init",
        "func":  "msg.dynamic = {};\nmsg.log = [];\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  730,
        "y":  380,
        "wires":  [
                      [
                          "3bd28294cfb1f3eb"
                      ]
                  ]
    },
    {
        "id":  "c7883feb8b3d7ee5",
        "type":  "function",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Generate templates",
        "func":  "// final template initialization\nmsg.dynamic.template_cheapest = \"\";\nmsg.dynamic.template_expensive = \"\";\n\n// temporary template parts\nlet template_start = \"\";\nlet template_common = [];\nlet template_cheapest = [];\nlet template_expensive = [];\nlet template_all = [];\nlet template_end = \"\";\n\n// 1. IMPROVEMENT: Use radix 10 and Logical OR (||) for cleaner default handling\nconst cheapest_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.cheapest_hrs\"), 10) || 1;\nconst expensive_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.expensive_hrs\"), 10) || 1;\n\n// load the macro\ntemplate_start = `{% from \u0027cheapest_energy_hours.jinja\u0027 import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n`;\ntemplate_end = `) | to_json }}`;\n\n// collect arguments | strings\nconst stringKeys = [\n    \u0027sensor\u0027,\n    \u0027attr_all\u0027,\n    \u0027value_key\u0027,\n    \u0027attr_today\u0027,\n    \u0027attr_tomorrow\u0027,\n    \u0027time_key\u0027\n];\n\nstringKeys.forEach(key =\u003e {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}=\u0027${msg.dynamic[key]}\u0027`);\n    }\n});\n\n// collect arguments | boolean, integer\nconst otherKeys = [\n    \u0027datetime_in_data\u0027,\n    \u0027data_minutes\u0027,\n];\n\notherKeys.forEach(key =\u003e {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}=${msg.dynamic[key]}`);\n    }\n});\n\n// copy common items\ntemplate_cheapest = [...template_common];\ntemplate_expensive = [...template_common];\ntemplate_all = [...template_common];\n\n// collect arguments | cheapest specific\ntemplate_cheapest.push(`hours=${cheapest_hrs}`);\n// template_cheapest.push(`include_tomorrow=true`);\ntemplate_cheapest.push(`mode=\"all\"`);\n\n// collect arguments | expensive specific\ntemplate_expensive.push(`hours=${expensive_hrs}`);\n// template_expensive.push(`include_tomorrow=true`);\ntemplate_expensive.push(`lowest=false`);\ntemplate_expensive.push(`mode=\"all\"`);\n\n// collect all hours | via extra call\ntemplate_all.push(`hours=\"all\"`);\ntemplate_all.push(`include_tomorrow=true`);\ntemplate_all.push(`mode=\"all\"`);\n\n/**\n * Formats an array of strings into a single string:\n * - Each item starts with 4 spaces.\n * - Each item ends with a comma, except the last one.\n * - Items are separated by a newline.\n */\nfunction formatTemplateArray(array) {\n    if (!array || array.length === 0) {\n        return \"\";\n    }\n\n    const indent = \"    \"; \n\n    const formatted_lines = array.map((element, index) =\u003e {\n        const suffix = (index \u003c array.length - 1) ? \",\" : \"\";\n        return `${indent}${element}${suffix}`;\n    });\n\n    return formatted_lines.join(\u0027\\n\u0027);\n}\n\n// generate string templates\nconst template_cheapest_string = formatTemplateArray(template_cheapest);\nconst template_expensive_string = formatTemplateArray(template_expensive);\nconst template_all_string = formatTemplateArray(template_all);\n\n// done\nmsg.dynamic.template_cheapest = `${template_start}${template_cheapest_string}${template_end}`;\nmsg.dynamic.template_expensive = `${template_start}${template_expensive_string}${template_end}`;\nmsg.dynamic.template_all = `${template_start}${template_all_string}${template_end}`;\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  590,
        "y":  600,
        "wires":  [
                      [
                          "6e989b0e5c7cf3f6",
                          "b03939e3449d3064",
                          "9a38215838980d72",
                          "22d5155ac4b0ec82"
                      ]
                  ]
    },
    {
        "id":  "6e989b0e5c7cf3f6",
        "type":  "debug",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Template cheapest",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "dynamic.template_cheapest",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  850,
        "y":  620,
        "wires":  [

                  ]
    },
    {
        "id":  "b03939e3449d3064",
        "type":  "debug",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Template expensive",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "dynamic.template_expensive",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  860,
        "y":  580,
        "wires":  [

                  ]
    },
    {
        "id":  "9a38215838980d72",
        "type":  "change",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Set",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "template",
                          "pt":  "msg",
                          "to":  "dynamic.template_cheapest",
                          "tot":  "msg"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  330,
        "y":  660,
        "wires":  [
                      [
                          "ee13c52058f6f591"
                      ]
                  ]
    },
    {
        "id":  "1350a7978831f30f",
        "type":  "change",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Set",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "template",
                          "pt":  "msg",
                          "to":  "dynamic.template_expensive",
                          "tot":  "msg"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  330,
        "y":  720,
        "wires":  [
                      [
                          "f326ee1afc340c48"
                      ]
                  ]
    },
    {
        "id":  "018761757d6ddf7b",
        "type":  "change",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Cleanup",
        "rules":  [
                      {
                          "t":  "delete",
                          "p":  "template",
                          "pt":  "msg"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  340,
        "y":  840,
        "wires":  [
                      [
                          "59cd6ae303b7afa4"
                      ]
                  ]
    },
    {
        "id":  "7c318e0aa0fb868d",
        "type":  "debug",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Log: activate \u0027debug mode\u0027 first",
        "active":  true,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "log",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  950,
        "y":  1260,
        "wires":  [

                  ]
    },
    {
        "id":  "082558a90abd9f8c",
        "type":  "server-state-changed",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "User input",
        "server":  "176d29a.6f648d6",
        "version":  6,
        "outputs":  1,
        "exposeAsEntityConfig":  "",
        "entities":  {
                         "entity":  [
                                        "input_number.house_battery_strategy_dynamic_cheapest_hrs",
                                        "input_number.house_battery_strategy_dynamic_expensive_hrs",
                                        "input_select.house_battery_strategy_dynamic_data_source",
                                        "input_number.house_battery_strategy_dynamic_threshold_delta",
                                        "input_number.house_battery_strategy_dynamic_threshold_cheapest_period"
                                    ],
                         "substring":  [

                                       ],
                         "regex":  [

                                   ]
                     },
        "outputInitially":  false,
        "stateType":  "str",
        "ifState":  "",
        "ifStateType":  "str",
        "ifStateOperator":  "is",
        "outputOnlyOnStateChange":  true,
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "ignorePrevStateNull":  false,
        "ignorePrevStateUnknown":  false,
        "ignorePrevStateUnavailable":  false,
        "ignoreCurrentStateUnknown":  false,
        "ignoreCurrentStateUnavailable":  false,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "eventData"
                                 },
                                 {
                                     "property":  "topic",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "triggerId"
                                 }
                             ],
        "x":  360,
        "y":  340,
        "wires":  [
                      [
                          "8b111d3e68952669"
                      ]
                  ]
    },
    {
        "id":  "3b4267436ee03576",
        "type":  "switch",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Source selected?",
        "property":  "dynamic.data_source",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "None",
                          "vt":  "str"
                      },
                      {
                          "t":  "else"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  2,
        "x":  965,
        "y":  380,
        "wires":  [
                      [
                          "6eeae62f7de78ca6"
                      ],
                      [
                          "ec07540e4271f463"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "2a6e33cc87aa7221",
        "type":  "debug",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Not set",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "payload",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "counter",
        "x":  1340,
        "y":  340,
        "wires":  [

                  ]
    },
    {
        "id":  "6491fddce70826c7",
        "type":  "api-call-service",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Avg cheap tariff",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_strategy_dynamic_cheapest_avg_tariff"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": $$.dynamic.avg_cheapest_tariff }",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  900,
        "y":  1100,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "2d80e807bb1c60e9",
        "type":  "api-call-service",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Avg expensive tariff",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_strategy_dynamic_expensive_avg_tariff"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": $$.dynamic.avg_expensive_tariff}",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  910,
        "y":  1140,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "4d7c4fa6f54a79a4",
        "type":  "api-call-service",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Avg delta",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_strategy_dynamic_expensive_avg_delta"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": $$.dynamic.avg_delta}",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  880,
        "y":  1180,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "80a410bf4cddb6cd",
        "type":  "api-current-state",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Threshold delta",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_strategy_dynamic_threshold_delta",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "dynamic.min_delta_cents",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  360,
        "y":  1020,
        "wires":  [
                      [
                          "ac40e2ac7a41e22a"
                      ]
                  ]
    },
    {
        "id":  "6eeae62f7de78ca6",
        "type":  "change",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Set dynamic strategy to null",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "dynamic_strategy",
                          "pt":  "flow",
                          "to":  "null",
                          "tot":  "json"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  1140,
        "y":  340,
        "wires":  [
                      [
                          "2a6e33cc87aa7221"
                      ]
                  ]
    },
    {
        "id":  "a18cc9706936ab5a",
        "type":  "debug",
        "z":  "07c2cad2b434e852",
        "g":  "e681f8531d5e6e5f",
        "name":  "All data",
        "active":  true,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "all_data",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  700,
        "y":  1700,
        "wires":  [

                  ]
    },
    {
        "id":  "ced59ec71a043342",
        "type":  "debug",
        "z":  "07c2cad2b434e852",
        "g":  "81709525cdc25410",
        "name":  "Complete msg",
        "active":  true,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "true",
        "targetType":  "full",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  1020,
        "y":  1520,
        "wires":  [

                  ]
    },
    {
        "id":  "96fb1d1906bb1409",
        "type":  "change",
        "z":  "07c2cad2b434e852",
        "g":  "f2db5201c2533640",
        "name":  "Trace",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "strategy.trace",
                          "pt":  "msg",
                          "to":  "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                          "tot":  "jsonata"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  90,
        "y":  200,
        "wires":  [
                      [
                          "e272124293b40aeb"
                      ]
                  ],
        "info":  "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id":  "5a75560391befa37",
        "type":  "function",
        "z":  "07c2cad2b434e852",
        "g":  "b6fefcd33af36bf2",
        "name":  "Selected",
        "func":  "// Logger\nconst log = global.get(\"logger\");\nlog(this,`${msg.target} strategy`);\n\n// Status\nnode.status({fill:\"green\",shape:\"dot\",text:`${msg.target}`});\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  660,
        "y":  180,
        "wires":  [
                      [
                          "3fa468003cd94acd"
                      ]
                  ]
    },
    {
        "id":  "3673345e464d2bdb",
        "type":  "catch",
        "z":  "07c2cad2b434e852",
        "g":  "483ab3bd68ac6e38",
        "name":  "",
        "scope":  null,
        "uncaught":  true,
        "x":  65,
        "y":  320,
        "wires":  [
                      [
                          "223c1c24685b90d5"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "223c1c24685b90d5",
        "type":  "function",
        "z":  "07c2cad2b434e852",
        "g":  "483ab3bd68ac6e38",
        "name":  "Unhandled Exception",
        "func":  "const handle = global.get(\u0027unhandledException\u0027);\n\nhandle(this);\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  115,
        "y":  320,
        "wires":  [
                      [
                          "038cd97542fa16fc"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "038cd97542fa16fc",
        "type":  "link out",
        "z":  "07c2cad2b434e852",
        "g":  "483ab3bd68ac6e38",
        "name":  "link out 5",
        "mode":  "return",
        "links":  [

                  ],
        "x":  165,
        "y":  320,
        "wires":  [

                  ]
    },
    {
        "id":  "49ccc70aaf344a8a",
        "type":  "api-current-state",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Threshold cheapest",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_strategy_dynamic_threshold_cheapest_period",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "dynamic.threshold_cheapest_cents",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  370,
        "y":  980,
        "wires":  [
                      [
                          "80a410bf4cddb6cd"
                      ]
                  ]
    },
    {
        "id":  "ac40e2ac7a41e22a",
        "type":  "api-current-state",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Strategy default",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.house_battery_strategy_dynamic_default",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "dynamic.strategy_default",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  360,
        "y":  1060,
        "wires":  [
                      [
                          "e79dda0d9d4d8870"
                      ]
                  ]
    },
    {
        "id":  "e79dda0d9d4d8870",
        "type":  "api-current-state",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Strategy cheapest",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.house_battery_strategy_dynamic_cheapest",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "dynamic.strategy_cheapest",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  370,
        "y":  1100,
        "wires":  [
                      [
                          "6c98fc543bba3c7a"
                      ]
                  ]
    },
    {
        "id":  "6c98fc543bba3c7a",
        "type":  "api-current-state",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "Strategy expensive",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.house_battery_strategy_dynamic_expensive",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "dynamic.strategy_expensive",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  370,
        "y":  1140,
        "wires":  [
                      [
                          "5da03558b30d3290"
                      ]
                  ]
    },
    {
        "id":  "59cd6ae303b7afa4",
        "type":  "function",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Cache data source",
        "func":  "// logger, usage: log(this, \"\");\nconst log = global.get(\u0027logger\u0027);\n\nconst dynamicData = msg.dynamic;\n\n// Helper to check for errors in the object\nconst isInvalid = (data) =\u003e {\n    if (!data) return true;\n    // Check if the stringified object contains \"error\"\n    return JSON.stringify(data).toLowerCase().includes(\"error\");\n};\n\nif (isInvalid(dynamicData)) {\n    // Explain issue\n    log(this, \"Invalid data received, clearing cache\", \"warn\");\n    // Clear cache\n    flow.set(\"cached_dynamic_data\", undefined);\n} else {\n    // Cache on success\n    log(this, \"Caching `msg.dynamic`\");\n    // Save the entire object to flow context\n    flow.set(\"cached_dynamic_data\", dynamicData);\n}\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  510,
        "y":  840,
        "wires":  [
                      [
                          "8f7d0ffe033a5d2e"
                      ]
                  ]
    },
    {
        "id":  "d61be082028491a7",
        "type":  "catch",
        "z":  "07c2cad2b434e852",
        "g":  "129fcbab388b5e4b",
        "name":  "Catch group",
        "scope":  "group",
        "uncaught":  false,
        "x":  1090,
        "y":  580,
        "wires":  [
                      [
                          "2e86abb2935aba9c"
                      ]
                  ]
    },
    {
        "id":  "13e9cbacc106d2a8",
        "type":  "debug",
        "z":  "07c2cad2b434e852",
        "g":  "129fcbab388b5e4b",
        "name":  "Strategy errors",
        "active":  true,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "true",
        "targetType":  "full",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  1320,
        "y":  580,
        "wires":  [

                  ]
    },
    {
        "id":  "496204469be0f0c0",
        "type":  "comment",
        "z":  "07c2cad2b434e852",
        "g":  "129fcbab388b5e4b",
        "name":  "Cheapest Energy Hours - errors",
        "info":  "\"No valid sensor found\" if price_data is none and not valid_sensor,\n\"No valid data in {}\".format(sensor) if price_data is none and data == [] and valid_sensor,\n\"No valid data in provided price_data\" if price_data is not none and not valid_price_data,\n\"Time key \u0027{}\u0027 not found in data\".format(time_key) if data and time_key not in data[0],\n\"Value key \u0027{}\u0027 not found in data\".format(value_key) if data and value_key not in data[0],\n\"Invalid mode \u0027{}\u0027 selected\".format(mode) if mode not in modes,\n\"Boolean input expected for include_today, \u0027{}\u0027 can not be processed as a boolean\".format(include_today) if include_today | bool(\"\") is not boolean,\n\"Boolean input expected for include_tomorrow, \u0027{}\u0027 can not be processed as a boolean\".format(include_tomorrow) if include_tomorrow | bool(\"\") is not boolean,\n\"Boolean input expected for look_ahead, \u0027{}\u0027 can not be processed as a boolean\".format(look_ahead) if look_ahead | bool(\"\") is not boolean,\n\"Boolean input expected for lowest, \u0027{}\u0027 can not be processed as a boolean\".format(lowest) if lowest | bool(\"\") is not boolean,\n\"Boolean input expected for latest_possible, \u0027{}\u0027 can not be processed as a boolean\".format(latest_possible) if latest_possible | bool(\"\") is not boolean,\n\"Numeric input or percentage expected for price_tolerance, \u0027{}\u0027 can not be processed as a float or percentage\".format(price_tolerance) if not valid_pt,\n\"Numeric input expected for kwh, \u0027{}\u0027 can not be processed as a float\".format(kwh) if kwh is not none and not kwh | is_number,\n\"Selected program \u0027{}\u0027 is not available or has no data\".format(program) if program is not none and w is none,\n\"Selected start parameter is after the end parameter\" if start_end and data,\n\"{} hours between start and end, where {} hours are required\".format(end_start, h | round(3)) if not start_end and end_start \u003c h | round(3) and data,\n\"Invalid combination of source data points per hour \u0027{}\u0027 and number of weight points \u0027{}\u0027\".format(dp, dph) if all_keys and not wp_check",
        "x":  1150,
        "y":  540,
        "wires":  [

                  ]
    },
    {
        "id":  "2e86abb2935aba9c",
        "type":  "function",
        "z":  "07c2cad2b434e852",
        "g":  "129fcbab388b5e4b",
        "name":  "Unhandled Exception",
        "func":  "const handle = global.get(\u0027unhandledException\u0027);\n\nhandle(this);\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1195,
        "y":  580,
        "wires":  [
                      [
                          "13e9cbacc106d2a8"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "f9f57e89bc9e7f9b",
        "type":  "function",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Cache check",
        "func":  "// Check if cache can be used or a new call to Data Source is required\nconst log = global.get(\u0027logger\u0027);\n\n// Retrieve stored data from flow context\nconst previousValues = flow.get(\"previous_sensor_values\") || {};\nconst cachedData = flow.get(\"cached_dynamic_data\");\n\n// Create a string or object to represent current state\nconst currentValues = {\n    src: msg.dynamic.data_source,\n    hc: msg.dynamic.cheapest_hrs,\n    he: msg.dynamic.expensive_hrs\n};\n\n// Compare current with previous (JSON stringify is a quick way to compare objects)\nconst inputsMatch = JSON.stringify(currentValues) === JSON.stringify(previousValues);\n\n// Determine cache hit\nif (inputsMatch \u0026\u0026 cachedData){\n    // Cache HIT\n    node.status({ fill: \"green\", shape: \"dot\", text: `Cache hit` });\n    log(this,`*CACHE HIT* using stored tariff data`);\n\n    // Attach cached data to the message so following nodes can use it\n    msg.dynamic = cachedData;\n\n    // Output #1\n    return [msg, null];\n\n} else {\n    // Cache MISS\n    node.status({ fill: \"green\", shape: \"ring\", text: `Cache miss: ${JSON.stringify(currentValues) }` });\n\n    // Save current values for the next run\n    flow.set(\"previous_sensor_values\", currentValues);\n    \n    // Output #2\n    return [null, msg];\n}",
        "outputs":  2,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1270,
        "y":  420,
        "wires":  [
                      [
                          "e1d3d27ed0f823d5"
                      ],
                      [
                          "623ab6bfaec74d52"
                      ]
                  ],
        "outputLabels":  [
                             "Cache HIT",
                             "Cache MISS"
                         ]
    },
    {
        "id":  "e1d3d27ed0f823d5",
        "type":  "link out",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "from Cache Check ok",
        "mode":  "link",
        "links":  [
                      "1dbb7efd95aee252"
                  ],
        "x":  1375,
        "y":  400,
        "wires":  [

                  ]
    },
    {
        "id":  "6ba3a1f665d40e9b",
        "type":  "link in",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "link Fetch from Data Source",
        "links":  [
                      "623ab6bfaec74d52"
                  ],
        "x":  295,
        "y":  560,
        "wires":  [
                      [
                          "ef7c0a337307bf74"
                      ]
                  ]
    },
    {
        "id":  "623ab6bfaec74d52",
        "type":  "link out",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "from Cache Check NoK",
        "mode":  "link",
        "links":  [
                      "6ba3a1f665d40e9b"
                  ],
        "x":  1375,
        "y":  440,
        "wires":  [

                  ]
    },
    {
        "id":  "1dbb7efd95aee252",
        "type":  "link in",
        "z":  "07c2cad2b434e852",
        "g":  "8c31e5f5a5a27de8",
        "name":  "link Determine Strategy",
        "links":  [
                      "8f7d0ffe033a5d2e",
                      "e1d3d27ed0f823d5"
                  ],
        "x":  295,
        "y":  940,
        "wires":  [
                      [
                          "49ccc70aaf344a8a"
                      ]
                  ]
    },
    {
        "id":  "8f7d0ffe033a5d2e",
        "type":  "link out",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "link out 12",
        "mode":  "link",
        "links":  [
                      "1dbb7efd95aee252"
                  ],
        "x":  635,
        "y":  840,
        "wires":  [

                  ]
    },
    {
        "id":  "33c33befc9e6d436",
        "type":  "function",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Clear Cache",
        "func":  "// Clear cache\nflow.set(\"cached_dynamic_data\", undefined);\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  635,
        "y":  420,
        "wires":  [
                      [
                          "9e560348ee335ba1"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "6d34858ef484f2c3",
        "type":  "ha-fire-event",
        "z":  "07c2cad2b434e852",
        "g":  "e681f8531d5e6e5f",
        "name":  "",
        "server":  "176d29a.6f648d6",
        "version":  0,
        "event":  "update_energy_prices",
        "data":  "msg.all_data",
        "dataType":  "jsonata",
        "x":  760,
        "y":  1760,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "a5c7382e09883cde",
        "type":  "api-render-template",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "All",
        "server":  "176d29a.6f648d6",
        "version":  0,
        "template":  "",
        "resultsLocation":  "dynamic.data_all",
        "resultsLocationType":  "msg",
        "templateLocation":  "",
        "templateLocationType":  "none",
        "x":  450,
        "y":  780,
        "wires":  [
                      [
                          "9e1aa94620413143"
                      ]
                  ]
    },
    {
        "id":  "9e1aa94620413143",
        "type":  "json",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "",
        "property":  "dynamic.data_all",
        "action":  "obj",
        "pretty":  false,
        "x":  535,
        "y":  780,
        "wires":  [
                      [
                          "018761757d6ddf7b",
                          "f1067e94ed157eca"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "f451432079ac8133",
        "type":  "change",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Set",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "template",
                          "pt":  "msg",
                          "to":  "dynamic.template_all",
                          "tot":  "msg"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  330,
        "y":  780,
        "wires":  [
                      [
                          "a5c7382e09883cde"
                      ]
                  ]
    },
    {
        "id":  "3db4b690645db6ba",
        "type":  "ha-fire-event",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Update energy prices",
        "server":  "176d29a.6f648d6",
        "version":  0,
        "event":  "update_energy_prices",
        "data":  "msg.dynamic.data_all",
        "dataType":  "jsonata",
        "x":  860,
        "y":  780,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "22d5155ac4b0ec82",
        "type":  "debug",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Template all",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "dynamic.template_all",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  830,
        "y":  660,
        "wires":  [

                  ]
    },
    {
        "id":  "f1067e94ed157eca",
        "type":  "function",
        "z":  "07c2cad2b434e852",
        "g":  "3262bf8323599c02",
        "name":  "Convert price",
        "func":  "// logger, usage: log(this, \"\");\nconst log = global.get(\u0027logger\u0027);\n\n// Conversion\nconst CONVERSION_RATE = parseFloat(RED.util.getMessageProperty(msg, \"dynamic.value_conversion\")) || 1;\n\n// Check if the list exists and is an array to prevent errors\nif (msg.dynamic \u0026\u0026 msg.dynamic.data_all \u0026\u0026 Array.isArray(msg.dynamic.data_all.list)) {\n    \n    // Create a new array where each value is multiplied\n    if (Array.isArray(msg.dynamic.data_all?.list)) {\n        msg.dynamic.data_all.list = msg.dynamic.data_all.list.map(v =\u003e v / CONVERSION_RATE * 100); // cents\n    }\n\n    // Update other fields\n    if (msg.dynamic.data_all?.average) {\n        msg.dynamic.data_all.average = parseInt(msg.dynamic.data_all.average / CONVERSION_RATE * 100); // cents\n    }\n} else {\n    // Do not continue\n    log(this,\"*price data not updated* price data missing\");\n    return null;\n}\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  670,
        "y":  780,
        "wires":  [
                      [
                          "3db4b690645db6ba"
                      ]
                  ]
    },
    {
        "id":  "b169a4da76d9ca46",
        "type":  "inject",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Test",
        "props":  [
                      {
                          "p":  "payload"
                      },
                      {
                          "p":  "topic",
                          "vt":  "str"
                      }
                  ],
        "repeat":  "",
        "crontab":  "",
        "once":  false,
        "onceDelay":  0.1,
        "topic":  "",
        "payload":  "",
        "payloadType":  "date",
        "x":  410,
        "y":  460,
        "wires":  [
                      [
                          "0bbc71b06a0dbe5e"
                      ]
                  ]
    },
    {
        "id":  "0bbc71b06a0dbe5e",
        "type":  "api-call-service",
        "z":  "07c2cad2b434e852",
        "g":  "c5038c359cd68abd",
        "name":  "Debug ON",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_boolean.turn_on",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_boolean.house_battery_control_is_debug_mode"
                     ],
        "labelId":  [

                    ],
        "data":  "",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [
                                 {
                                     "property":  "debug_mode",
                                     "propertyType":  "global",
                                     "value":  "true",
                                     "valueType":  "bool"
                                 }
                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_boolean",
        "service":  "turn_on",
        "x":  550,
        "y":  460,
        "wires":  [
                      [
                          "33c33befc9e6d436"
                      ]
                  ]
    },
    {
        "id":  "176d29a.6f648d6",
        "type":  "server",
        "name":  "Home Assistant",
        "addon":  true,
        "rejectUnauthorizedCerts":  true,
        "ha_boolean":  "",
        "connectionDelay":  false,
        "cacheJson":  false,
        "heartbeat":  false,
        "heartbeatInterval":  "",
        "statusSeparator":  "",
        "enableGlobalContextStore":  false
    },
    {
        "id":  "7e488d9cf932802a",
        "type":  "global-config",
        "env":  [

                ],
        "modules":  {
                        "node-red-contrib-home-assistant-websocket":  "0.80.3"
                    }
    },
    {
        "id":  "5ca05ae5a089b8d2",
        "type":  "tab",
        "label":  "Strategy Full stop v4.4.0",
        "disabled":  false,
        "info":  "",
        "env":  [

                ]
    },
    {
        "id":  "c3404a37fd9ce4af",
        "type":  "group",
        "z":  "5ca05ae5a089b8d2",
        "name":  "Strategy start",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "fedca8b9c6861865",
                      "4febdc440faf9d73",
                      "86fc6690200ea1d5"
                  ],
        "x":  14,
        "y":  79,
        "w":  192,
        "h":  162
    },
    {
        "id":  "807415e9b7aacdfa",
        "type":  "group",
        "z":  "5ca05ae5a089b8d2",
        "name":  "Battery solutions",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "5ac782a79cce3909",
                      "1dca26be7c0dd61b"
                  ],
        "x":  464,
        "y":  79,
        "w":  192,
        "h":  142
    },
    {
        "id":  "baecf4a2995e8afe",
        "type":  "group",
        "z":  "5ca05ae5a089b8d2",
        "name":  "Unhandled exceptions",
        "style":  {
                      "label":  true,
                      "stroke":  "#d88a8a",
                      "color":  "#d88a8a"
                  },
        "nodes":  [
                      "527dbdfa3c0b7d81",
                      "dbd5b285d0e8b8d2",
                      "23b4b597108b5ea8"
                  ],
        "x":  14,
        "y":  259,
        "w":  182,
        "h":  82
    },
    {
        "id":  "fedca8b9c6861865",
        "type":  "link in",
        "z":  "5ca05ae5a089b8d2",
        "g":  "c3404a37fd9ce4af",
        "name":  "Full stop",
        "links":  [

                  ],
        "x":  100,
        "y":  160,
        "wires":  [
                      [
                          "86fc6690200ea1d5"
                      ]
                  ],
        "l":  true
    },
    {
        "id":  "5ac782a79cce3909",
        "type":  "link out",
        "z":  "5ca05ae5a089b8d2",
        "g":  "807415e9b7aacdfa",
        "name":  "Return",
        "mode":  "return",
        "links":  [

                  ],
        "x":  505,
        "y":  180,
        "wires":  [

                  ]
    },
    {
        "id":  "488bf4f7bb7829f7",
        "type":  "function",
        "z":  "5ca05ae5a089b8d2",
        "name":  "Stop all batteries",
        "func":  "// Logger\nconst log = global.get(\"logger\");\nlog(this,`full stop`);\n\n// Process\nlet solution_array = [];\n\n// Add a solution per battery\nmsg.batteries.forEach(battery =\u003e {\n    solution_array.push({ id: battery.id, \n    mode: \"stop\", // disengages Marstek Battery\n    power: 0 }); // set power to 0W\n});\n\n// OUTPUT\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  330,
        "y":  180,
        "wires":  [
                      [
                          "5ac782a79cce3909"
                      ]
                  ]
    },
    {
        "id":  "b374e478ef33e8a4",
        "type":  "comment",
        "z":  "5ca05ae5a089b8d2",
        "name":  "Home Battery Strategy",
        "info":  "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon\u0027t modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x":  120,
        "y":  40,
        "wires":  [

                  ]
    },
    {
        "id":  "1dca26be7c0dd61b",
        "type":  "comment",
        "z":  "5ca05ae5a089b8d2",
        "g":  "807415e9b7aacdfa",
        "name":  "End (readme)",
        "info":  "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x":  560,
        "y":  120,
        "wires":  [

                  ]
    },
    {
        "id":  "4febdc440faf9d73",
        "type":  "comment",
        "z":  "5ca05ae5a089b8d2",
        "g":  "c3404a37fd9ce4af",
        "name":  "Start (readme)",
        "info":  "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the \u003cselect\u003e option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select \u0027AcmE example\u0027\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled \u0027AcmE example\u0027 (case sensitive).",
        "x":  110,
        "y":  120,
        "wires":  [

                  ]
    },
    {
        "id":  "86fc6690200ea1d5",
        "type":  "change",
        "z":  "5ca05ae5a089b8d2",
        "g":  "c3404a37fd9ce4af",
        "name":  "Trace",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "strategy.trace",
                          "pt":  "msg",
                          "to":  "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                          "tot":  "jsonata"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  110,
        "y":  200,
        "wires":  [
                      [
                          "488bf4f7bb7829f7"
                      ]
                  ],
        "info":  "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id":  "527dbdfa3c0b7d81",
        "type":  "catch",
        "z":  "5ca05ae5a089b8d2",
        "g":  "baecf4a2995e8afe",
        "name":  "",
        "scope":  null,
        "uncaught":  false,
        "x":  55,
        "y":  300,
        "wires":  [
                      [
                          "dbd5b285d0e8b8d2"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "dbd5b285d0e8b8d2",
        "type":  "function",
        "z":  "5ca05ae5a089b8d2",
        "g":  "baecf4a2995e8afe",
        "name":  "Unhandled Exception",
        "func":  "const handle = global.get(\u0027unhandledException\u0027);\n\nhandle(this);\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  105,
        "y":  300,
        "wires":  [
                      [
                          "23b4b597108b5ea8"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "23b4b597108b5ea8",
        "type":  "link out",
        "z":  "5ca05ae5a089b8d2",
        "g":  "baecf4a2995e8afe",
        "name":  "link out 6",
        "mode":  "return",
        "links":  [

                  ],
        "x":  155,
        "y":  300,
        "wires":  [

                  ]
    },
    {
        "id":  "2dc255585c9021ad",
        "type":  "tab",
        "label":  "Strategy Self-consumption v4.4.0",
        "disabled":  false,
        "info":  "",
        "env":  [

                ]
    },
    {
        "id":  "ba3cab11cfa58369",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "name":  "Strategy start",
        "style":  {
                      "fill":  "#ffffff",
                      "label":  true
                  },
        "nodes":  [
                      "653d5ecae07626a1",
                      "c685bb5d5b350a17",
                      "6333a8d8470cd4f5"
                  ],
        "x":  54,
        "y":  79,
        "w":  212,
        "h":  162
    },
    {
        "id":  "481e254058a8227d",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "name":  "Battery solutions",
        "style":  {
                      "label":  true,
                      "fill":  "#ffffff"
                  },
        "nodes":  [
                      "188b6d74052d7b75",
                      "d6ba85caf21c6c7a",
                      "02843f3df46ffe5b"
                  ],
        "x":  64,
        "y":  1139,
        "w":  202,
        "h":  142
    },
    {
        "id":  "4bd04882ac08f740",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "name":  "Bumpless operation",
        "style":  {
                      "label":  true,
                      "stroke":  "#bfdbef"
                  },
        "nodes":  [
                      "8319c2bf362f5d55",
                      "c07fd441a19ddcd6",
                      "751cc0061f48cf83",
                      "1526a33d800732ac"
                  ],
        "x":  1614,
        "y":  19,
        "w":  252,
        "h":  242
    },
    {
        "id":  "fa53931ece8d9e5c",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "name":  "Bumpless operation - switching control modes",
        "style":  {
                      "stroke":  "#bfdbef",
                      "label":  true
                  },
        "nodes":  [
                      "af9242d4df5098ea",
                      "2d4aaea3163ee0b0",
                      "3c7a17a46ed568bb",
                      "b67191747e0bfe44",
                      "bdcb744226755ff7",
                      "2a5a379c33bdc594",
                      "ce822e5f44a30bc2",
                      "a98d3ba5387274d6",
                      "e2f0589bab3add2b",
                      "85a1019efd05b4bd",
                      "bc18c2754c562a1a",
                      "332d68169bd129ff"
                  ],
        "x":  1614,
        "y":  279,
        "w":  592,
        "h":  289.5
    },
    {
        "id":  "b9b7c6e5106b3a7c",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "name":  "Inputs",
        "style":  {
                      "fill":  "#7fb7df",
                      "label":  true,
                      "color":  "#ffffff"
                  },
        "nodes":  [
                      "d4bd6010b2a82002",
                      "b753f4385c7d13bd"
                  ],
        "x":  288,
        "y":  13,
        "w":  904,
        "h":  234
    },
    {
        "id":  "f9161a30652a1e37",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "name":  "Pre processing",
        "style":  {
                      "fill":  "#bfdbef",
                      "label":  true,
                      "color":  "#ffffff"
                  },
        "nodes":  [
                      "289b3a4f3ed9895e",
                      "15a8430ec8fd32cd",
                      "085064404e672245"
                  ],
        "x":  288,
        "y":  273,
        "w":  1104,
        "h":  294
    },
    {
        "id":  "e90c3db5ee8c6a36",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "name":  "Control",
        "style":  {
                      "fill":  "#7fb7df",
                      "label":  true,
                      "color":  "#ffffff"
                  },
        "nodes":  [
                      "0538d5e767988695",
                      "81378689693e940b"
                  ],
        "x":  288,
        "y":  593,
        "w":  924,
        "h":  634
    },
    {
        "id":  "ff7db384260f1b22",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "name":  "Unhandled exceptions",
        "style":  {
                      "label":  true,
                      "stroke":  "#d88a8a",
                      "color":  "#d88a8a"
                  },
        "nodes":  [
                      "916c17ae8b44a945",
                      "768fa0dcf7e8e3b5",
                      "30ea27bc433988a5"
                  ],
        "x":  54,
        "y":  279,
        "w":  182,
        "h":  82
    },
    {
        "id":  "d4bd6010b2a82002",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "g":  "b9b7c6e5106b3a7c",
        "name":  "PID control inputs",
        "style":  {
                      "label":  true,
                      "fill":  "#ffffff"
                  },
        "nodes":  [
                      "89c318c6c8728833",
                      "e5144d3a238687bb",
                      "8ce405166bb8ae24",
                      "ae7e3834fba26c76",
                      "c7386c2b9a7d1cc0",
                      "edbd6dfed6ba7652",
                      "8bc9658f77284e22",
                      "800b817e2d30700f",
                      "fd84a7d1648928c8"
                  ],
        "x":  314,
        "y":  59,
        "w":  572,
        "h":  162
    },
    {
        "id":  "b753f4385c7d13bd",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "g":  "b9b7c6e5106b3a7c",
        "name":  "Advanced features",
        "style":  {
                      "label":  true,
                      "fill":  "#ffffff"
                  },
        "nodes":  [
                      "f6c435539e7250e3",
                      "fe2a55ed5fe6bed5",
                      "58b564f75d3c21c3"
                  ],
        "x":  914,
        "y":  39,
        "w":  252,
        "h":  182
    },
    {
        "id":  "289b3a4f3ed9895e",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "g":  "f9161a30652a1e37",
        "name":  "",
        "style":  {
                      "fill":  "#ffffff",
                      "label":  true
                  },
        "nodes":  [
                      "858221520cee3dc5",
                      "735a9b3b250cd260",
                      "cd0dc47e2ff890dd",
                      "7726f1429c179f68"
                  ],
        "x":  314,
        "y":  299,
        "w":  292,
        "h":  202
    },
    {
        "id":  "15a8430ec8fd32cd",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "g":  "f9161a30652a1e37",
        "name":  "Derivative - incl. bumpless operation",
        "style":  {
                      "label":  true,
                      "stroke":  "#a4a4a4",
                      "fill":  "#ffffff"
                  },
        "nodes":  [
                      "7976d4a42e873093",
                      "823be9b66feeb0da",
                      "72ac88c55f926b58",
                      "e002c8dde1136e44",
                      "700e6af7e2972644"
                  ],
        "x":  614,
        "y":  399,
        "w":  752,
        "h":  142
    },
    {
        "id":  "085064404e672245",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "g":  "f9161a30652a1e37",
        "name":  "Processing required? ",
        "style":  {
                      "label":  true,
                      "fill":  "#ffffff"
                  },
        "nodes":  [
                      "ea326ab0246b8c13",
                      "deae32c2aaf84154",
                      "2f97f335f207820a"
                  ],
        "x":  614,
        "y":  299,
        "w":  562,
        "h":  82
    },
    {
        "id":  "0538d5e767988695",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "g":  "e90c3db5ee8c6a36",
        "name":  "PID controller",
        "style":  {
                      "label":  true,
                      "fill":  "#ffffff",
                      "color":  "#3f3f3f"
                  },
        "nodes":  [
                      "a826eba0ed0ac7fc",
                      "e0644847be635f58",
                      "ad085261cf8a2cc1",
                      "2dc42d364f58d67f",
                      "7ede0bd5857ee7a0",
                      "5370c30d8cdab4b8",
                      "ed568c00a0795773",
                      "e05c810323db1ceb",
                      "16582ddbc62d0305",
                      "303bb8cea00177f9",
                      "829124787188e159",
                      "d4422f8539cc8ecf",
                      "71d8d3b4f6ef9310",
                      "4563c0e2adab2fee",
                      "9de6d5774b6b0bfa",
                      "729b998cf3b87cc7",
                      "83a1a6be0e294782",
                      "3db366538fbac912",
                      "f41cc8bd3b060241",
                      "817e304f8bb80d64"
                  ],
        "x":  314,
        "y":  619,
        "w":  872,
        "h":  482
    },
    {
        "id":  "81378689693e940b",
        "type":  "group",
        "z":  "2dc255585c9021ad",
        "g":  "e90c3db5ee8c6a36",
        "name":  "Distribution",
        "style":  {
                      "label":  true,
                      "fill":  "#ffffff",
                      "color":  "#3f3f3f"
                  },
        "nodes":  [
                      "3acf8bf116f857e1",
                      "9197f431cd22f55c"
                  ],
        "x":  314,
        "y":  1119,
        "w":  452,
        "h":  82
    },
    {
        "id":  "edbd6dfed6ba7652",
        "type":  "junction",
        "z":  "2dc255585c9021ad",
        "g":  "d4bd6010b2a82002",
        "x":  460,
        "y":  100,
        "wires":  [
                      [
                          "800b817e2d30700f"
                      ]
                  ]
    },
    {
        "id":  "800b817e2d30700f",
        "type":  "junction",
        "z":  "2dc255585c9021ad",
        "g":  "d4bd6010b2a82002",
        "x":  700,
        "y":  100,
        "wires":  [
                      [
                          "8bc9658f77284e22",
                          "fd84a7d1648928c8"
                      ]
                  ]
    },
    {
        "id":  "fd84a7d1648928c8",
        "type":  "junction",
        "z":  "2dc255585c9021ad",
        "g":  "d4bd6010b2a82002",
        "x":  720,
        "y":  120,
        "wires":  [
                      [
                          "e5144d3a238687bb"
                      ]
                  ]
    },
    {
        "id":  "653d5ecae07626a1",
        "type":  "link in",
        "z":  "2dc255585c9021ad",
        "g":  "ba3cab11cfa58369",
        "name":  "Self-consumption",
        "links":  [

                  ],
        "x":  160,
        "y":  160,
        "wires":  [
                      [
                          "6333a8d8470cd4f5"
                      ]
                  ],
        "l":  true
    },
    {
        "id":  "c685bb5d5b350a17",
        "type":  "comment",
        "z":  "2dc255585c9021ad",
        "g":  "ba3cab11cfa58369",
        "name":  "Start (readme)",
        "info":  "# Setting up your battery strategy flow\n\n## Setup\nName the Link In in this start group exactly after the option configured in your\nselect_input.house_battery_strategy\n\nfound in the file:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nWill point to the flow containing a Link In node\ncalled \u0027AcmE example\u0027 (case sensitive).",
        "x":  150,
        "y":  120,
        "wires":  [

                  ]
    },
    {
        "id":  "9b4c669af44fc4a8",
        "type":  "comment",
        "z":  "2dc255585c9021ad",
        "name":  "Home Battery Strategy",
        "info":  "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon\u0027t modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x":  120,
        "y":  40,
        "wires":  [

                  ]
    },
    {
        "id":  "8319c2bf362f5d55",
        "type":  "server-state-changed",
        "z":  "2dc255585c9021ad",
        "g":  "4bd04882ac08f740",
        "name":  "User Ki change",
        "server":  "176d29a.6f648d6",
        "version":  6,
        "outputs":  1,
        "exposeAsEntityConfig":  "",
        "entities":  {
                         "entity":  [
                                        "input_number.house_battery_control_ki"
                                    ],
                         "substring":  [

                                       ],
                         "regex":  [

                                   ]
                     },
        "outputInitially":  false,
        "stateType":  "str",
        "ifState":  "",
        "ifStateType":  "str",
        "ifStateOperator":  "is",
        "outputOnlyOnStateChange":  true,
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "ignorePrevStateNull":  true,
        "ignorePrevStateUnknown":  true,
        "ignorePrevStateUnavailable":  true,
        "ignoreCurrentStateUnknown":  true,
        "ignoreCurrentStateUnavailable":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "eventData"
                                 },
                                 {
                                     "property":  "topic",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "triggerId"
                                 }
                             ],
        "x":  1720,
        "y":  100,
        "wires":  [
                      [
                          "c07fd441a19ddcd6"
                      ]
                  ]
    },
    {
        "id":  "c07fd441a19ddcd6",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "4bd04882ac08f740",
        "name":  "Integral term adjust",
        "func":  "// On change of Ki setting\nlet logdata = \"bumpless \";\nlet I_sum = flow.get(\"I_integral_sum\");\nlet Ki = msg.payload || 0;     // Integral gain\nlet Ki_last = context.get(\"house_battery_control_ki_last\")||0;\n\n// if Ki was or has become zero\nif(Ki == 0 || Ki_last == 0){\n    // passify the integral-sum\n    flow.set(\"I_integral_sum\",0);\n    context.set(\"house_battery_control_ki_last\", Ki);\n    logdata += `to/from 0, Ki=${Ki_last} -\u003e ${Ki} | `;\n    // done\n    return { payload: logdata };\n}\n\n// change in Ki\nlet dKi = parseFloat(Ki/Ki_last);\nif(dKi \u003c= 0) dKi = 1; // ignore erroneous changes\n\n// keep I-term constant by compensating the integral-sum for the change in Ki\n// e.g. if Ki got 10% smaller, then integral-sum should increase 10%, to keep the I-term constant\nlet I_sum_new = I_sum / dKi;\nlogdata += `change of I: from ${Ki_last} to ${Ki} (${dKi * 100}%) | `;\n\n// OUTFLOW\nflow.set(\"I_integral_sum\", I_sum_new);\ncontext.set(\"house_battery_control_ki_last\", Ki);\n\n// OUTPUT\nreturn { payload: logdata };",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "// Code added here will be run once\n// whenever the node is started.\n\n// init last state\nlet Ki = flow.get(\"house_battery_control_ki\") || 0;\ncontext.set(\"house_battery_control_ki_last\", Ki);",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1730,
        "y":  160,
        "wires":  [
                      [
                          "1526a33d800732ac"
                      ]
                  ]
    },
    {
        "id":  "751cc0061f48cf83",
        "type":  "comment",
        "z":  "2dc255585c9021ad",
        "g":  "4bd04882ac08f740",
        "name":  "Bumpless Ki changes",
        "info":  "Recalc I-term whenever Ki changes\n\nNote: always be mindful of making changes to control parameters of systems in operation.",
        "x":  1740,
        "y":  60,
        "wires":  [

                  ]
    },
    {
        "id":  "1526a33d800732ac",
        "type":  "debug",
        "z":  "2dc255585c9021ad",
        "g":  "4bd04882ac08f740",
        "name":  "Logdata",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "payload",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  1700,
        "y":  220,
        "wires":  [

                  ]
    },
    {
        "id":  "af9242d4df5098ea",
        "type":  "switch",
        "z":  "2dc255585c9021ad",
        "g":  "fa53931ece8d9e5c",
        "name":  "Check for custom/auto mode",
        "property":  "payload",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "Manual control",
                          "vt":  "str"
                      },
                      {
                          "t":  "eq",
                          "v":  "Marstek control",
                          "vt":  "str"
                      },
                      {
                          "t":  "eq",
                          "v":  "Full control",
                          "vt":  "str"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  3,
        "x":  1855,
        "y":  520,
        "wires":  [
                      [
                          "2a5a379c33bdc594",
                          "2d4aaea3163ee0b0"
                      ],
                      [
                          "2a5a379c33bdc594",
                          "2d4aaea3163ee0b0"
                      ],
                      [
                          "2d4aaea3163ee0b0"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "2d4aaea3163ee0b0",
        "type":  "debug",
        "z":  "2dc255585c9021ad",
        "g":  "fa53931ece8d9e5c",
        "name":  "Master control switch",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "true",
        "targetType":  "full",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  2060,
        "y":  520,
        "wires":  [

                  ]
    },
    {
        "id":  "3c7a17a46ed568bb",
        "type":  "server-state-changed",
        "z":  "2dc255585c9021ad",
        "g":  "fa53931ece8d9e5c",
        "name":  "Master control mode",
        "server":  "176d29a.6f648d6",
        "version":  6,
        "outputs":  1,
        "exposeAsEntityConfig":  "",
        "entities":  {
                         "entity":  [
                                        "input_select.marstek_master_battery_mode"
                                    ],
                         "substring":  [

                                       ],
                         "regex":  [

                                   ]
                     },
        "outputInitially":  false,
        "stateType":  "str",
        "ifState":  "",
        "ifStateType":  "str",
        "ifStateOperator":  "is",
        "outputOnlyOnStateChange":  true,
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "ignorePrevStateNull":  false,
        "ignorePrevStateUnknown":  false,
        "ignorePrevStateUnavailable":  false,
        "ignoreCurrentStateUnknown":  false,
        "ignoreCurrentStateUnavailable":  false,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "eventData"
                                 },
                                 {
                                     "property":  "topic",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "triggerId"
                                 }
                             ],
        "x":  1730,
        "y":  520,
        "wires":  [
                      [
                          "af9242d4df5098ea"
                      ]
                  ]
    },
    {
        "id":  "b67191747e0bfe44",
        "type":  "api-call-service",
        "z":  "2dc255585c9021ad",
        "g":  "fa53931ece8d9e5c",
        "name":  "Integral PID to zero",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_i_term"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"0\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  2050,
        "y":  360,
        "wires":  [
                      [
                          "bdcb744226755ff7"
                      ]
                  ]
    },
    {
        "id":  "bdcb744226755ff7",
        "type":  "api-call-service",
        "z":  "2dc255585c9021ad",
        "g":  "fa53931ece8d9e5c",
        "name":  "Differential PID to zero",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_d_term"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"0\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  2060,
        "y":  400,
        "wires":  [
                      [
                          "ce822e5f44a30bc2"
                      ]
                  ]
    },
    {
        "id":  "2a5a379c33bdc594",
        "type":  "api-call-service",
        "z":  "2dc255585c9021ad",
        "g":  "fa53931ece8d9e5c",
        "name":  "Proportinal PID to zero",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_p_term"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"0\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  2060,
        "y":  320,
        "wires":  [
                      [
                          "b67191747e0bfe44"
                      ]
                  ]
    },
    {
        "id":  "ce822e5f44a30bc2",
        "type":  "api-call-service",
        "z":  "2dc255585c9021ad",
        "g":  "fa53931ece8d9e5c",
        "name":  "PID Output to zero",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_pid_output"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"0\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  2050,
        "y":  440,
        "wires":  [
                      [
                          "a98d3ba5387274d6"
                      ]
                  ]
    },
    {
        "id":  "a98d3ba5387274d6",
        "type":  "change",
        "z":  "2dc255585c9021ad",
        "g":  "fa53931ece8d9e5c",
        "name":  "Integral sum to zero",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "I_integral_sum",
                          "pt":  "flow",
                          "to":  "0",
                          "tot":  "str"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  2060,
        "y":  480,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "89c318c6c8728833",
        "type":  "api-current-state",
        "z":  "2dc255585c9021ad",
        "g":  "d4bd6010b2a82002",
        "name":  "Target grid consumption",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_target_grid_consumption_in_w",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_target_grid_consumption_in_w",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  570,
        "y":  120,
        "wires":  [
                      [
                          "800b817e2d30700f"
                      ]
                  ],
        "info":  "Set at 0 to strive for zero consumption"
    },
    {
        "id":  "58b564f75d3c21c3",
        "type":  "api-current-state",
        "z":  "2dc255585c9021ad",
        "g":  "b753f4385c7d13bd",
        "name":  "Hysteresis",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_control_hysteresis_in_w",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_control_hysteresis_in_w",
                                     "propertyType":  "flow",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  1010,
        "y":  120,
        "wires":  [
                      [
                          "f6c435539e7250e3"
                      ]
                  ]
    },
    {
        "id":  "e5144d3a238687bb",
        "type":  "api-current-state",
        "z":  "2dc255585c9021ad",
        "g":  "d4bd6010b2a82002",
        "name":  "PID P-value",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_control_kp",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_control_kp",
                                     "propertyType":  "flow",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  410,
        "y":  180,
        "wires":  [
                      [
                          "8ce405166bb8ae24"
                      ]
                  ]
    },
    {
        "id":  "8ce405166bb8ae24",
        "type":  "api-current-state",
        "z":  "2dc255585c9021ad",
        "g":  "d4bd6010b2a82002",
        "name":  "PID I-value",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_control_ki",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_control_ki",
                                     "propertyType":  "flow",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  590,
        "y":  180,
        "wires":  [
                      [
                          "ae7e3834fba26c76"
                      ]
                  ]
    },
    {
        "id":  "ae7e3834fba26c76",
        "type":  "api-current-state",
        "z":  "2dc255585c9021ad",
        "g":  "d4bd6010b2a82002",
        "name":  "PID D-value",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_control_kd",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_control_kd",
                                     "propertyType":  "flow",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  770,
        "y":  180,
        "wires":  [
                      [
                          "fe2a55ed5fe6bed5"
                      ]
                  ]
    },
    {
        "id":  "f6c435539e7250e3",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "b753f4385c7d13bd",
        "name":  "Advanced settings",
        "func":  "// 1. Hard coded advanced settings (flow level)\nflow.set(\"has_soc_charging_limiter\", true);         // slows charging from 90% to 100% to improve battery life\nflow.set(\"has_reverse_priority_discharge\", true);   // Prioritize discharging and charging the same battery when possible\nflow.set(\"master_gain\", 1);                         // Gain scheduling. Not Implemented!\n\n// 2. Configurable advanced settings (msg level)\nmsg.advanced_settings ||= {}; // creates \u0027advanced_settings\u0027 if it does net yet exist\nlet mas = msg.advanced_settings;\n\n// disable charge or dicharge solutions and changes them to stop solutions\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\", mas.discharge_disabled ?? false);\nRED.util.setMessageProperty(msg,\"advanced_settings.charge_disabled\", mas.charge_disabled ?? false);\n// The nullish coalescing (??) operator is a logical operator that returns its right-hand side operand when its left-hand side operand is null or undefined\n\n// 3. continue\nreturn msg;\n\n// Notes for home battery tinkerer friends:\n// Using RED.util.getMessageProperty / RED.util.setMessageProperty is more performant and safe.\n// If any part of the path (\"foo.bar\") is missing, it will return \u0027undefined\u0027 without throwing an error.",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1030,
        "y":  180,
        "wires":  [
                      [
                          "735a9b3b250cd260"
                      ]
                  ]
    },
    {
        "id":  "fe2a55ed5fe6bed5",
        "type":  "api-current-state",
        "z":  "2dc255585c9021ad",
        "g":  "b753f4385c7d13bd",
        "name":  "Idle time before Stop",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_control_idle_time",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "idle_time_minutes",
                                     "propertyType":  "flow",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  1040,
        "y":  80,
        "wires":  [
                      [
                          "58b564f75d3c21c3"
                      ]
                  ]
    },
    {
        "id":  "858221520cee3dc5",
        "type":  "comment",
        "z":  "2dc255585c9021ad",
        "g":  "289b3a4f3ed9895e",
        "name":  "Setpoint ramping / damping",
        "info":  "",
        "x":  460,
        "y":  460,
        "wires":  [

                  ]
    },
    {
        "id":  "735a9b3b250cd260",
        "type":  "api-current-state",
        "z":  "2dc255585c9021ad",
        "g":  "289b3a4f3ed9895e",
        "name":  "Error signal dampening",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_control_error_signal_dampening",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_control_error_signal_dampening",
                                     "propertyType":  "flow",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  450,
        "y":  340,
        "wires":  [
                      [
                          "cd0dc47e2ff890dd"
                      ]
                  ]
    },
    {
        "id":  "cd0dc47e2ff890dd",
        "type":  "api-current-state",
        "z":  "2dc255585c9021ad",
        "g":  "289b3a4f3ed9895e",
        "name":  "Output signal dampening",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_control_pid_output_dampening",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_control_pid_output_dampening",
                                     "propertyType":  "flow",
                                     "value":  "",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  450,
        "y":  380,
        "wires":  [
                      [
                          "7726f1429c179f68"
                      ]
                  ]
    },
    {
        "id":  "7726f1429c179f68",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "289b3a4f3ed9895e",
        "name":  "Set: Error signal",
        "func":  "// INPUTS\nlet P1_error_last = Number(context.get(\"p1_error_last\"))||0; // last error signal level in W\nlet dampening = Number(flow.get(\"house_battery_control_error_signal_dampening\")) || 0; // 0% - 100%\ndampening = dampening / 100; // to Number\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = Number(RED.util.getMessageProperty(msg,\"house_target_grid_consumption_in_w\")); // SP: target value\n\n// Calc error signal\nlet P1_error_unfiltered = P1_setpoint - P1_power;\n\n// Simple averaging filter\nlet P1_error_filtered = (1 - dampening) * P1_error_unfiltered + (dampening) * P1_error_last;\n\n// OUTFLOW\ncontext.set(\"p1_error_last\", P1_error_filtered);\n\n// OUTPUT\nmsg.grid_error = P1_error_filtered; // W (watt), error signal = SP - PV\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  420,
        "y":  420,
        "wires":  [
                      [
                          "ea326ab0246b8c13"
                      ]
                  ]
    },
    {
        "id":  "7976d4a42e873093",
        "type":  "comment",
        "z":  "2dc255585c9021ad",
        "g":  "15a8430ec8fd32cd",
        "name":  "Bumpless target grid consumption",
        "info":  "The error value is used by default to calculate the derivative.\nWhen the target grid consumption (tgc) is changed, the system is takes the derivative of the process variable instead.\nThis prevents irratic behavior during sudden changes of the error or setpoint value.\n\ne.g. you change the setpoint from 0 to 100W \nThe error would make an instantanious jump and cause a huge derivative-term.\nThe pv stays continous and fluent.\n\nAfter 1 control tick the derivative is taken from error again.\nUntil the `tgc` is changed again.",
        "x":  780,
        "y":  440,
        "wires":  [

                  ]
    },
    {
        "id":  "823be9b66feeb0da",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "15a8430ec8fd32cd",
        "name":  "Derivative PV",
        "func":  "var P1_power = msg.grid_power||0;\nvar P1_last_power = Number(context.get(\"p1_last_power\")) ||0;\n\n// PV derivative\nvar p1_derivative = P1_power - P1_last_power; // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_power\", P1_power);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1040,
        "y":  500,
        "wires":  [
                      [
                          "700e6af7e2972644"
                      ]
                  ]
    },
    {
        "id":  "72ac88c55f926b58",
        "type":  "switch",
        "z":  "2dc255585c9021ad",
        "g":  "15a8430ec8fd32cd",
        "name":  "Target grid consumption unchanged",
        "property":  "house_target_grid_consumption_in_w",
        "propertyType":  "flow",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "",
                          "vt":  "prev"
                      },
                      {
                          "t":  "neq",
                          "v":  "",
                          "vt":  "prev"
                      }
                  ],
        "checkall":  "false",
        "repair":  false,
        "outputs":  2,
        "x":  780,
        "y":  480,
        "wires":  [
                      [
                          "e002c8dde1136e44"
                      ],
                      [
                          "823be9b66feeb0da"
                      ]
                  ]
    },
    {
        "id":  "e002c8dde1136e44",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "15a8430ec8fd32cd",
        "name":  "Derivative Error",
        "func":  "var P1_error = msg.grid_error||0;\nvar P1_last_error = Number(context.get(\"p1_last_error\")) ||0;\n\n// Error derivative\n// note: error = -PV\n// note: for simplicity we assume 1 second time steps\nlet p1_derivative = -(P1_error - P1_last_error); // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_error\", P1_error);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1040,
        "y":  460,
        "wires":  [
                      [
                          "700e6af7e2972644"
                      ]
                  ]
    },
    {
        "id":  "700e6af7e2972644",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "15a8430ec8fd32cd",
        "name":  "Derivative final value",
        "func":  "\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1240,
        "y":  480,
        "wires":  [
                      [
                          "a826eba0ed0ac7fc"
                      ]
                  ]
    },
    {
        "id":  "ea326ab0246b8c13",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "085064404e672245",
        "name":  "Deadband (15W)",
        "func":  "// Deadband\n// Stop processing if error is within .. Watt of target grid consumption.\n// This to reduce CPU loads \n\n// Logger\nconst log = global.get(\"logger\");\n\n// P1\nlet P1_error = msg.grid_error; // Watt\nlet P1_deadband = 15; // Watt\n\n// TODO\n// based on last \u0027assignable power\u0027 and current error, if (error \u003e assignable power) the system will never enter the deadband. And keep calculating each interation.\n// however since we don\u0027t know if the is the assignable power will change, until we calculate the Control Value / load balancer\n// we could end up in a deadlock if we simply stop execution here, based on assignable power alone.\n\n// Within Deadband\nif(Math.abs(P1_error) \u003c P1_deadband) {\n    // stop processing\n    node.status({fill:\"yellow\",shape:\"dot\",text:`Halt, ${Math.round(Math.abs(P1_error))} W`});\n    log(this, `**Stopped processing** ðŸŒ¿power saving, ${Math.round(Math.abs(P1_error))} W is within deadband of ${P1_deadband} W`);\n    msg.payload = \u0027halted by deadband\u0027;\n    return msg;\n} \n\n// Outside deadband\nnode.status({fill:\"green\",shape:\"dot\",text:`Pass, ${Math.round(Math.abs(P1_error))} W`});\nreturn msg;\n",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  730,
        "y":  340,
        "wires":  [
                      [
                          "deae32c2aaf84154"
                      ]
                  ]
    },
    {
        "id":  "a826eba0ed0ac7fc",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "Calculate corrections",
        "func":  "// Logger\nvar logdata = \"\"; // deprecated\nconst log = global.get(\"logger\");\n\n// Timing\nlet time_last = context.get(\u0027time_last\u0027) || Date.now(); // Milliseconds\nlet time_current = Date.now(); // Milliseconds\nlet time_delta = (time_current - time_last) / 1000; // Convert to seconds\n// note: due to inherent 1 sec intervals of P1 meter we omit dt terms. This is mostly for bug checking and optimizations.\n\n// Batteries\nvar B_power = msg.batteries_total_power; // charging is positive, discharging negative\nvar anti_windup_threshold = Number(flow.get(\"batteries_total_assignable_power\")) || 0; // max available charge/discharge power.\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = flow.get(\"house_target_grid_consumption_in_w\"); // SP: target value\nvar P1_error = msg.grid_error;  // W (watt), error signal = SP - PV\nvar P1_derivative = msg.grid_derivative; // Derivative of PV, not the error\n\n// PID values\nvar Kp = flow.get(\"house_battery_control_kp\") || 0.75;  // Proportional gain\nvar Ki = flow.get(\"house_battery_control_ki\") || 0;     // Integral gain        Ki = Kp/Ti\nvar Kd = flow.get(\"house_battery_control_kd\") || 0;     // Derivative gain      Kd = Kp*Td\n\n// helpers\nvar I_integral_sum = context.get(\u0027I_integral_sum\u0027) || 0;\nvar Gm = flow.get(\"master_gain\")||1; // gain scheduling\n\n// optimizations\nvar hysteresis = flow.get(\"house_battery_control_hysteresis_in_w\"); // W (watt)\n\n// advanced settings\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\");\nconst isChargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.charge_disabled\");\n\n// -- PID regulator --\n// Proportional term\nlet p_term = Gm * Kp * P1_error;\n\n// Integral term\nlet integral_max = 0;\nif (Ki \u003e 0) {\n    // Integral term | integrate\n    I_integral_sum += P1_error; \n    // Integral term | apply anti-windup\n    integral_max = anti_windup_threshold / Ki; // the anti-windup value is set to the current controlable range of the batteries, given by the previous load balancer calculations\n    I_integral_sum = Math.min(Math.max(I_integral_sum, -integral_max), integral_max);\n} else {\n    // If Ki is 0, keep everything 0\n    I_integral_sum = 0;\n    integral_max = 0;\n}\n\n// Integral term | the term\nlet i_term = Ki * I_integral_sum;\n\n// Integral term | explain\nlogdata += `anti_windup_threshold=${anti_windup_threshold}, integral_max=${integral_max}| `; // deprecated\n\n// Differential term\nlet d_term = Gm * Kd * (-P1_derivative); // omitted \u0027/time_delta\u0027. inherent P1 refresh fequency.\n\n// Total PID output\nvar PID_output = p_term + i_term + d_term; // W (watt), the control input for the battery packs\n\n// Charging or Discharging states\nvar B_was_charging = context.get(\"batteries_charging_last\") || false;\nvar B_is_charging = PID_output \u003e 0 ? true : false;\n\n// Explain\nlogdata += `U(${time_delta}s)[${PID_output}] = P(${Kp})[${p_term}] + I(${Ki})[${i_term}] + D(${Kd})[${d_term}] | `; // deprecated\nlog(this,`**PID Controller**`);\nlog(this,`Step size: ${time_delta} s`);\nif(Kp == 0 \u0026\u0026 Ki == 0 \u0026\u0026 Kd == 0) {\n    log(this, `\u003cfont color=\"orange\"\u003e**Controller disabled**\u003c/font\u003e All PID gains are 0. Choose a PID preset or set gains \u003e 0.`,\"warn\");\n} else {\n    log(this, `P-term: ${Math.floor(p_term)} W @ P-gain ${Kp}`);\n    log(this, `I-term: ${Math.floor(i_term)} W @ I-gain ${Ki} (max. ${anti_windup_threshold} W)`);\n    log(this, `D-term: ${Math.floor(d_term)} W @ D-gain ${Kd}`);\n    log(this, `**PID ${B_is_charging ? \u0027Charge\u0027 : \u0027Discharge\u0027}:** ${Math.floor(p_term)} + ${Math.floor(i_term)} + ${Math.floor(d_term)} = **${Math.round(PID_output)} Watt**`);\n}\n\n// Only one of the advanced settings below can be active at once.\n// Advanced setting | discharge disabled\nif(isDischargeDisabled \u0026\u0026 !B_is_charging) {\n    // log explain\n    logdata += `Discharging disabled, PID unwound U(${time_delta})[0]=0+0+0 | `;\n    log(this,\u0027**PID set to 0**. Discharge was disabled via `msg.advanced_settings`.\u0027);\n    // Set all PID terms to 0 and unwind integral sum\n    PID_output = 0;\n    p_term = 0;\n    i_term = 0;\n    d_term = 0;\n    I_integral_sum = 0; // unwind\n    // maintain charge scenario\n    B_is_charging = true;\n    \n// Advanced setting | charge disabled\n} else if (isChargeDisabled \u0026\u0026 B_is_charging) {\n    // log explain\n    logdata += `Charging disabled, PID unwound U(${time_delta})[0]=0+0+0 | `;\n    log(this,\u0027**PID set to 0**. Charge was disabled via `msg.advanced_settings`.\u0027);\n    // Set all PID terms to 0 and unwind integral sum\n    PID_output = 0;\n    p_term = 0;\n    i_term = 0;\n    d_term = 0;\n    I_integral_sum = 0; // unwind\n    // maintain discharge scenario\n    B_is_charging = false;\n\n// Advanced setting | hysteresis\n} else if \n// prevents excessive switching between (dis)charge mode around the zero point.\n// if new PID_output lies within hysteresis, it will not switch charge mode. \n// set hysteresis to 0, to apply no hysteresis\n(B_is_charging !== B_was_charging \u0026\u0026 Math.abs(PID_output) \u003c hysteresis){\n    // log explain\n    logdata += `Hysteresis prevented charge mode switch from ${B_was_charging ? \"charging\" : \"discharging\"} to ${B_is_charging ? \"charging\" : \"discharging\"} as ${Math.abs(PID_output)}W \u003c= ${hysteresis}(hyst) | `;\n    log(this,`Hysteresis prevented charge mode switch from ${B_was_charging ? \"charging\" : \"discharging\"} to ${B_is_charging ? \"charging\" : \"discharging\"} as ${Math.abs(PID_output)}W \u003c= ${hysteresis}(hyst)`);\n    // prevent negative charging or positive discharging values (not allowed)\n    PID_output = (PID_output \u003c 0 \u0026\u0026 B_is_charging) || ((PID_output \u003e 0 \u0026\u0026 !B_is_charging)) ? 0 : PID_output;\n    // maintain previous scenario\n    B_is_charging = B_was_charging;\n} \n\n// save for next iteration\ncontext.set(\"batteries_charging_last\", B_is_charging); //boolean\n\n// OUTFLOW\ncontext.set(\"time_last\", Date.now());\ncontext.set(\"I_integral_sum\", I_integral_sum);\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_charging\", B_is_charging, true);\nRED.util.setMessageProperty(msg, \"I_integral_sum\", I_integral_sum,true);\nmsg.payload = Number(PID_output);\n\n\nreturn [msg, // payload = PID_output\n        { payload: Number(P1_error)},\n        { payload: parseFloat(p_term)},\n        { payload: parseFloat(i_term)},\n        { payload: parseFloat(d_term)},\n        { payload: B_is_charging},\n        { payload: logdata }];",
        "outputs":  7,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  440,
        "y":  700,
        "wires":  [
                      [
                          "71d8d3b4f6ef9310"
                      ],
                      [
                          "ad085261cf8a2cc1"
                      ],
                      [
                          "3db366538fbac912"
                      ],
                      [
                          "9de6d5774b6b0bfa"
                      ],
                      [
                          "f41cc8bd3b060241"
                      ],
                      [
                          "817e304f8bb80d64"
                      ],
                      [
                          "e0644847be635f58"
                      ]
                  ],
        "inputLabels":  [
                            "battery_array"
                        ]
    },
    {
        "id":  "e0644847be635f58",
        "type":  "debug",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "Logdata",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "payload",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  720,
        "y":  1060,
        "wires":  [

                  ]
    },
    {
        "id":  "ad085261cf8a2cc1",
        "type":  "api-call-service",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "Error Signal",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_error_signal"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  730,
        "y":  760,
        "wires":  [
                      [
                          "829124787188e159"
                      ]
                  ]
    },
    {
        "id":  "2dc42d364f58d67f",
        "type":  "api-call-service",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "PID Output",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_pid_output"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  730,
        "y":  700,
        "wires":  [
                      [
                          "16582ddbc62d0305"
                      ]
                  ]
    },
    {
        "id":  "7ede0bd5857ee7a0",
        "type":  "api-call-service",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "Proportinal term",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_p_term"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  920,
        "y":  820,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "5370c30d8cdab4b8",
        "type":  "api-call-service",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "Integral term",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_i_term"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  910,
        "y":  880,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "ed568c00a0795773",
        "type":  "api-call-service",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "Differential term",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_d_term"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  920,
        "y":  940,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "e05c810323db1ceb",
        "type":  "debug",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "Charging",
        "active":  false,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "payload",
        "targetType":  "msg",
        "statusVal":  "payload",
        "statusType":  "auto",
        "x":  900,
        "y":  1060,
        "wires":  [

                  ]
    },
    {
        "id":  "16582ddbc62d0305",
        "type":  "smooth",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "",
        "property":  "payload",
        "action":  "sd",
        "count":  "8",
        "round":  "",
        "mult":  "single",
        "reduce":  false,
        "x":  900,
        "y":  700,
        "wires":  [
                      [
                          "303bb8cea00177f9"
                      ]
                  ]
    },
    {
        "id":  "303bb8cea00177f9",
        "type":  "api-call-service",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "PID deviation",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_pid_output_deviation"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  1070,
        "y":  700,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "829124787188e159",
        "type":  "smooth",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "",
        "property":  "payload",
        "action":  "sd",
        "count":  "8",
        "round":  "",
        "mult":  "single",
        "reduce":  false,
        "x":  900,
        "y":  760,
        "wires":  [
                      [
                          "d4422f8539cc8ecf"
                      ]
                  ]
    },
    {
        "id":  "d4422f8539cc8ecf",
        "type":  "api-call-service",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "Error deviation",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_control_error_deviation"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": \"{{payload}}\"}",
        "dataType":  "json",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  1080,
        "y":  760,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "71d8d3b4f6ef9310",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "Output dampening",
        "func":  "// INPUT\nlet PID_unfiltered = msg.payload; // W Watt\nlet PID_last = context.get(\"PID_last\")||0; // W watt\nlet PID_damp = Number(flow.get(\"house_battery_control_pid_output_dampening\"))||0; // 0% - 100%\nPID_damp = PID_damp/100; // to Number\n\n// simple averaging filter\nlet PID_filtered = (1-PID_damp)*PID_unfiltered + (PID_damp)*PID_last;\n\n// OUTFLOW\ncontext.set(\"PID_last\", PID_filtered);\n\n// OUTPUT\nmsg.payload = Number(PID_filtered)\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  750,
        "y":  660,
        "wires":  [
                      [
                          "4563c0e2adab2fee"
                      ]
                  ]
    },
    {
        "id":  "4563c0e2adab2fee",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "Output failsafe",
        "func":  "// INFLOW\nlet maxCharge = msg.batteries_max_charge_power||undefined;\nlet maxDischarge = msg.batteries_max_discharge_power||undefined;\nlet isCharging = msg.batteries_charging||undefined;\nlet PID_output = msg.payload; // Watt\n\n// No failsafe\nif (maxCharge === undefined || maxDischarge == undefined) {\n    node.status({ fill: \"red\", shape: \"dot\", text: \"disabled\" });\n    node.warn(`Output Failsafe is INACTIVE. Max charge or discharge limits are undefined`);\n    // continue without safeguard\n    return msg;\n} \n\n// limit\nlet limit = 0;\n\n// charging state unknown\nif(isCharging === undefined) {\n    // limit on lowest of charge / discharge\n    limit = Math.min(maxCharge,maxDischarge);    \n}\n// charging state known\nlimit = isCharging ? maxCharge : maxDischarge;\n\n// Safe output\nif (PID_output \u003c= limit){\n    node.status({ fill: \"green\", shape: \"dot\", text: \"safe\" });\n    return msg;\n} \n\n// Unsafe, limit output\nnode.status({ fill: \"yellow\", shape: \"ring\", text: \"power limiting\" });\nmsg.payload = Number(limit);\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1080,
        "y":  660,
        "wires":  [
                      [
                          "3acf8bf116f857e1",
                          "2dc42d364f58d67f"
                      ]
                  ]
    },
    {
        "id":  "9de6d5774b6b0bfa",
        "type":  "rbe",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "on change",
        "func":  "rbe",
        "gap":  "",
        "start":  "",
        "inout":  "out",
        "septopics":  false,
        "property":  "payload",
        "topi":  "topic",
        "x":  730,
        "y":  880,
        "wires":  [
                      [
                          "5370c30d8cdab4b8"
                      ]
                  ]
    },
    {
        "id":  "3acf8bf116f857e1",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "81378689693e940b",
        "name":  "Load distribution",
        "func":  "// Logger\nconst log = global.get(\"logger\");\nlog(this,\"**PID load distribution**\");\n\n// INPUT\nvar batteries = msg.batteries; // Battery configuration as provided by `Home Batteries IO` flow\nvar isCharging = msg.batteries_charging; // Are we in a battery charging scenario?\nvar hasChargingLimiter = flow.get(\"has_soc_charging_limiter\") || false; // Battery life improvement\nvar hasReverseDischargePriority = flow.get(\"has_reverse_priority_discharge\") || false; // Prioritize (dis)charging the same battery\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\"); // Disallow discharging?\n\n// how much power do the batteries need to compensate?\nvar unassigned_power = Math.round(Math.abs(msg.payload)); // Power in W to compensate using batteries\nlog(this,`How much power do the batteries need to compensate: ${unassigned_power} W`);\n\n// inits \nvar solution_array = []; // load distribution solutions\nvar batteries_total_assignable_power = 0; // Current max. available total (dis)charge power. Exceeding this max should trigger the anti-windup routine for the Integral terms\n\n// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n/**\n** Battery life improvement (slow charge near max SoC)\n* @param {number} soc\n* @param {number} max_power\n*/\nfunction chargingLimiter(soc, max_power) {\n    // Must be greater than zero\n    let limitedPower = Math.max(0, max_power); \n\n    // Limit charge at high SoC\n    if (hasChargingLimiter) {\n        if (soc \u003e= 98)      limitedPower = Math.min(300, limitedPower);\n        else if (soc \u003e= 95) limitedPower = Math.min(500, limitedPower);\n        else if (soc \u003e= 85) limitedPower = Math.min(1500, limitedPower);\n    }\n    return limitedPower;\n}\n\n/**\n* battery life improvement (disconnects battery only if the battery is not used for ... seconds)\n* @param {string | number} batteryID\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getStopSolution(batteryID) {\n    // idle time, before stop is given to inverter relay.\n    let time_idle_minimum = flow.get(\"idle_time_minutes\")*60*1000||0; // Milliseconds\n\n    // retrieve last registered active times for each battery based on their ids\n    let lasttime_active = context.get(\"lasttime_active\");\n    \n    // battery exists in register \n    if(lasttime_active[batteryID] !== undefined){\n        // timing\n        let time_last = lasttime_active[batteryID]; // Milliseconds \n        let time_now = Date.now();                  // Milliseconds \n        let time_idle = (time_now - time_last); // Milliseconds\n        \n        // battery is ready for STOP\n        if (time_idle \u003e= time_idle_minimum) {\n            log(this,`Battery ${batteryID} [STOP]: 0 Watt and disconnect relay.`);\n            return {id: batteryID, mode: CMODE.STOP, power:0}; // STOP or 0 Watt disconnects relay\n        }\n        \n        // battery is kept IDLE, while awaiting minimum inactive time\n        log(this,`Battery ${batteryID} [IDLE]: 1 Watt for ${Math.round((time_idle_minimum-time_idle)/1000)}s. Keep relay engaged.`);\n        return { id: batteryID, mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE, power: 1 }; // 1 Watt keeps battery IDLE, keeping relay engaged\n    }\n\n    // battery missing in register\n    log(this,`Battery ${batteryID} [IDLE]: unknown last active time`);\n    return getActiveSolution(batteryID, 1); // set a last active time and engage idle state\n}\n\n/**\n* Get battery solution and register a last active time.\n* @param {any} batteryID\n* @param {number} assigned_power\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getActiveSolution(batteryID, assigned_power){\n    // register battery as active\n    let lasttime_active = context.get(\"lasttime_active\")||[]; // last registered active times for each battery based on their ids\n    lasttime_active[batteryID] = Date.now();\n    context.set(\"lasttime_active\", lasttime_active);\n\n    // solution\n    return {\n        id: batteryID,\n        mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE,\n        power: Math.round(assigned_power)\n    };\n}\n\n// -- BATTERY DISCHARGE PRIORITY\nif (!isCharging \u0026\u0026 hasReverseDischargePriority) {\n   batteries.reverse();\n}\n\n// -- LOAD BALANCER --\nbatteries.forEach((/** @type {{ id: any; soc: number; soc_min: number; soc_max: number; rs485: string; charging_max: number; discharging_max: any; }} */ battery) =\u003e {\n    \n    // Explain\n    log(this, `Battery ${battery.id}: ${battery.soc}% (min: ${battery.soc_min}%, max: ${battery.soc_max}%) ; RS485: ${battery.rs485==\u0027enable\u0027?\u0027OK\u0027:\u0027Nok\u0027}`);\n\n    // track if the battery should be skipped and why\n    let skipReason = null;\n    if (battery.rs485 !== \"enable\") {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because RS485 is not \u0027enable\u0027`;\n    } else if (isCharging \u0026\u0026 battery.soc \u003e= battery.soc_max) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because SoC (${battery.soc}%) \u003e= Max (${battery.soc_max}%) while charging`;\n    } else if (!isCharging \u0026\u0026 battery.soc \u003c= battery.soc_min) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because SoC (${battery.soc}%) \u003c= Min (${battery.soc_min}%) while discharging`;\n    } else if (!isCharging \u0026\u0026 isDischargeDisabled) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped, discharging was disabled via msg property`;\n    }\n\n    // battery NOT AVAIABLE, skip via soft stop\n    if (skipReason !== null) {\n        log(this, skipReason);                      // communicate reason\n        let solution = getStopSolution(battery.id); // get a soft stop solution for this battery\n        solution_array.push(solution);              // add solution, do not update last active time.\n        // next battery\n        return; \n    }\n\n    // battery is AVAILABLE, assign power\n    let battery_assignable_power = isCharging ? chargingLimiter(battery.soc, battery.charging_max) : battery.discharging_max;\n    let assign = Math.min(unassigned_power, battery_assignable_power);\n    \n    // select solution\n    var solution;\n    if (assign \u003c= 0 ) {\n        // no power solution\n        solution = getStopSolution(battery.id); // a soft stop solution\n        assign = 0;\n    } else {\n        // assigned power solution\n        solution = getActiveSolution(battery.id, Math.round(assign));\n    }\n    solution_array.push(solution);\n    \n    // Explain: charge limiting\n    if(unassigned_power \u003e battery_assignable_power \u0026\u0026 battery_assignable_power \u003c battery.charging_max) {\n        log(this,`Charging limited to protect battery (${battery.soc}%): ${battery.charging_max}W -\u003e ${battery_assignable_power}W`);\n    }\n    // Explain: solution result\n    log(this, `\u003cfont color=\"#009ac7\"\u003eBattery ${solution.id}\u003c/font\u003e: assigned to ${solution.mode} with ${solution.power}W / ${isCharging ? battery.charging_max : battery.discharging_max }W max.`)\n\n    // remaining power to assign\n    unassigned_power -= assign;\n    batteries_total_assignable_power += Number(battery_assignable_power);\n});\n\n// battery discharge priority - put solutions back in initial order\nif (!isCharging \u0026\u0026 hasReverseDischargePriority) {\n    solution_array.reverse();\n}\n\n// store solutions in msg\nRED.util.setMessageProperty(msg, \"solutions\", solution_array,true);\n\n// OUTFLOW\nflow.set(\"batteries_total_assignable_power\", batteries_total_assignable_power); // this is set for the anti-windup calculation in the earlier \u0027calculate corrections\u0027 node, which will pick this up during next iteration.\n\n// OUTPUT\nreturn msg; // to Home Battery flow",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "// Code added here will be run once\n// whenever the node is started.\n\ncontext.set(\"lasttime_active\",[]);",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  420,
        "y":  1160,
        "wires":  [
                      [
                          "9197f431cd22f55c",
                          "188b6d74052d7b75"
                      ]
                  ],
        "inputLabels":  [
                            "isCharging (boolean)"
                        ]
    },
    {
        "id":  "9197f431cd22f55c",
        "type":  "debug",
        "z":  "2dc255585c9021ad",
        "g":  "81378689693e940b",
        "name":  "Load distribution",
        "active":  false,
        "tosidebar":  true,
        "console":  false,
        "tostatus":  false,
        "complete":  "solutions",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "auto",
        "x":  640,
        "y":  1160,
        "wires":  [

                  ]
    },
    {
        "id":  "deae32c2aaf84154",
        "type":  "switch",
        "z":  "2dc255585c9021ad",
        "g":  "085064404e672245",
        "name":  "Pass or Halt",
        "property":  "payload",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "halted by deadband",
                          "vt":  "str"
                      },
                      {
                          "t":  "neq",
                          "v":  "halted by deadband",
                          "vt":  "str"
                      }
                  ],
        "checkall":  "false",
        "repair":  false,
        "outputs":  2,
        "x":  910,
        "y":  340,
        "wires":  [
                      [
                          "2f97f335f207820a"
                      ],
                      [
                          "72ac88c55f926b58"
                      ]
                  ]
    },
    {
        "id":  "188b6d74052d7b75",
        "type":  "link out",
        "z":  "2dc255585c9021ad",
        "g":  "481e254058a8227d",
        "name":  "Return",
        "mode":  "return",
        "links":  [

                  ],
        "x":  225,
        "y":  1240,
        "wires":  [

                  ]
    },
    {
        "id":  "d6ba85caf21c6c7a",
        "type":  "comment",
        "z":  "2dc255585c9021ad",
        "g":  "481e254058a8227d",
        "name":  "End (readme)",
        "info":  "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x":  170,
        "y":  1180,
        "wires":  [

                  ]
    },
    {
        "id":  "2f97f335f207820a",
        "type":  "link out",
        "z":  "2dc255585c9021ad",
        "g":  "085064404e672245",
        "name":  "go to End",
        "mode":  "link",
        "links":  [
                      "02843f3df46ffe5b"
                  ],
        "x":  1090,
        "y":  340,
        "wires":  [

                  ],
        "inputLabels":  [
                            "Halt"
                        ],
        "l":  true
    },
    {
        "id":  "02843f3df46ffe5b",
        "type":  "link in",
        "z":  "2dc255585c9021ad",
        "g":  "481e254058a8227d",
        "name":  "link to End",
        "links":  [
                      "2f97f335f207820a"
                  ],
        "x":  105,
        "y":  1240,
        "wires":  [
                      [
                          "188b6d74052d7b75"
                      ]
                  ]
    },
    {
        "id":  "729b998cf3b87cc7",
        "type":  "api-call-service",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "Is charging",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [

                     ],
        "labelId":  [

                    ],
        "data":  "",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  false,
        "domain":  "",
        "service":  "",
        "x":  1070,
        "y":  1000,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "83a1a6be0e294782",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "Config action",
        "func":  "const value = msg.payload;\nconst target = \"input_boolean.house_battery_control_is_charging\";\n\nmsg.payload = {\n    \"action\": value?\"input_boolean.turn_on\":\"input_boolean.turn_off\",\n    \"target\": {\n        \"entity_id\": [target]\n    },\n    \"data\": {}\n}\n\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  910,
        "y":  1000,
        "wires":  [
                      [
                          "729b998cf3b87cc7"
                      ]
                  ]
    },
    {
        "id":  "c7386c2b9a7d1cc0",
        "type":  "switch",
        "z":  "2dc255585c9021ad",
        "g":  "d4bd6010b2a82002",
        "name":  "Target",
        "property":  "house_target_grid_consumption_in_w",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "nnull"
                      },
                      {
                          "t":  "else"
                      }
                  ],
        "checkall":  "false",
        "repair":  false,
        "outputs":  2,
        "x":  390,
        "y":  120,
        "wires":  [
                      [
                          "edbd6dfed6ba7652"
                      ],
                      [
                          "89c318c6c8728833"
                      ]
                  ]
    },
    {
        "id":  "8bc9658f77284e22",
        "type":  "debug",
        "z":  "2dc255585c9021ad",
        "g":  "d4bd6010b2a82002",
        "name":  "Target",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "house_target_grid_consumption_in_w",
        "targetType":  "msg",
        "statusVal":  "house_target_grid_consumption_in_w",
        "statusType":  "auto",
        "x":  790,
        "y":  100,
        "wires":  [

                  ]
    },
    {
        "id":  "e2f0589bab3add2b",
        "type":  "server-state-changed",
        "z":  "2dc255585c9021ad",
        "g":  "fa53931ece8d9e5c",
        "name":  "Strategy changes",
        "server":  "176d29a.6f648d6",
        "version":  6,
        "outputs":  1,
        "exposeAsEntityConfig":  "",
        "entities":  {
                         "entity":  [
                                        "input_text.house_battery_strategy_active_sub_strategy",
                                        "input_select.house_battery_strategy"
                                    ],
                         "substring":  [

                                       ],
                         "regex":  [

                                   ]
                     },
        "outputInitially":  false,
        "stateType":  "str",
        "ifState":  "",
        "ifStateType":  "str",
        "ifStateOperator":  "is",
        "outputOnlyOnStateChange":  true,
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "ignorePrevStateNull":  false,
        "ignorePrevStateUnknown":  false,
        "ignorePrevStateUnavailable":  false,
        "ignoreCurrentStateUnknown":  false,
        "ignoreCurrentStateUnavailable":  false,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "eventData"
                                 },
                                 {
                                     "property":  "topic",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "triggerId"
                                 }
                             ],
        "x":  1720,
        "y":  340,
        "wires":  [
                      [
                          "85a1019efd05b4bd"
                      ]
                  ]
    },
    {
        "id":  "85a1019efd05b4bd",
        "type":  "switch",
        "z":  "2dc255585c9021ad",
        "g":  "fa53931ece8d9e5c",
        "name":  "",
        "property":  "payload",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "Full stop",
                          "vt":  "str"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  1,
        "x":  1855,
        "y":  340,
        "wires":  [
                      [
                          "2a5a379c33bdc594"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "bc18c2754c562a1a",
        "type":  "server-state-changed",
        "z":  "2dc255585c9021ad",
        "g":  "fa53931ece8d9e5c",
        "name":  "Full stop trigger",
        "server":  "176d29a.6f648d6",
        "version":  6,
        "outputs":  1,
        "exposeAsEntityConfig":  "",
        "entities":  {
                         "entity":  [
                                        "sensor.ev_is_charging"
                                    ],
                         "substring":  [

                                       ],
                         "regex":  [

                                   ]
                     },
        "outputInitially":  false,
        "stateType":  "str",
        "ifState":  "",
        "ifStateType":  "str",
        "ifStateOperator":  "is",
        "outputOnlyOnStateChange":  true,
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "ignorePrevStateNull":  false,
        "ignorePrevStateUnknown":  false,
        "ignorePrevStateUnavailable":  false,
        "ignoreCurrentStateUnknown":  false,
        "ignoreCurrentStateUnavailable":  false,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "eventData"
                                 },
                                 {
                                     "property":  "topic",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "triggerId"
                                 }
                             ],
        "x":  1720,
        "y":  420,
        "wires":  [
                      [
                          "332d68169bd129ff"
                      ]
                  ]
    },
    {
        "id":  "332d68169bd129ff",
        "type":  "switch",
        "z":  "2dc255585c9021ad",
        "g":  "fa53931ece8d9e5c",
        "name":  "",
        "property":  "payload",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "on",
                          "vt":  "str"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  1,
        "x":  1855,
        "y":  420,
        "wires":  [
                      [
                          "2a5a379c33bdc594"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "3db366538fbac912",
        "type":  "rbe",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "on change",
        "func":  "rbe",
        "gap":  "",
        "start":  "",
        "inout":  "out",
        "septopics":  false,
        "property":  "payload",
        "topi":  "topic",
        "x":  730,
        "y":  820,
        "wires":  [
                      [
                          "7ede0bd5857ee7a0"
                      ]
                  ]
    },
    {
        "id":  "f41cc8bd3b060241",
        "type":  "rbe",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "on change",
        "func":  "rbe",
        "gap":  "",
        "start":  "",
        "inout":  "out",
        "septopics":  false,
        "property":  "payload",
        "topi":  "topic",
        "x":  730,
        "y":  940,
        "wires":  [
                      [
                          "ed568c00a0795773"
                      ]
                  ]
    },
    {
        "id":  "817e304f8bb80d64",
        "type":  "rbe",
        "z":  "2dc255585c9021ad",
        "g":  "0538d5e767988695",
        "name":  "on change",
        "func":  "rbe",
        "gap":  "",
        "start":  "",
        "inout":  "out",
        "septopics":  false,
        "property":  "payload",
        "topi":  "topic",
        "x":  730,
        "y":  1000,
        "wires":  [
                      [
                          "83a1a6be0e294782",
                          "e05c810323db1ceb"
                      ]
                  ]
    },
    {
        "id":  "6333a8d8470cd4f5",
        "type":  "change",
        "z":  "2dc255585c9021ad",
        "g":  "ba3cab11cfa58369",
        "name":  "Trace",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "strategy.trace",
                          "pt":  "msg",
                          "to":  "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                          "tot":  "jsonata"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  190,
        "y":  200,
        "wires":  [
                      [
                          "c7386c2b9a7d1cc0"
                      ]
                  ],
        "info":  "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id":  "916c17ae8b44a945",
        "type":  "catch",
        "z":  "2dc255585c9021ad",
        "g":  "ff7db384260f1b22",
        "name":  "",
        "scope":  null,
        "uncaught":  false,
        "x":  95,
        "y":  320,
        "wires":  [
                      [
                          "768fa0dcf7e8e3b5"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "768fa0dcf7e8e3b5",
        "type":  "function",
        "z":  "2dc255585c9021ad",
        "g":  "ff7db384260f1b22",
        "name":  "Unhandled Exception",
        "func":  "const handle = global.get(\u0027unhandledException\u0027);\n\nhandle(this);\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  145,
        "y":  320,
        "wires":  [
                      [
                          "30ea27bc433988a5"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "30ea27bc433988a5",
        "type":  "link out",
        "z":  "2dc255585c9021ad",
        "g":  "ff7db384260f1b22",
        "name":  "link out 7",
        "mode":  "return",
        "links":  [

                  ],
        "x":  195,
        "y":  320,
        "wires":  [

                  ]
    },
    {
        "id":  "176d29a.6f648d6",
        "type":  "server",
        "name":  "Home Assistant",
        "addon":  true,
        "rejectUnauthorizedCerts":  true,
        "ha_boolean":  "",
        "connectionDelay":  false,
        "cacheJson":  false,
        "heartbeat":  false,
        "heartbeatInterval":  "",
        "statusSeparator":  "",
        "enableGlobalContextStore":  false
    },
    {
        "id":  "4daf6e7bcce195d0",
        "type":  "global-config",
        "env":  [

                ],
        "modules":  {
                        "node-red-contrib-home-assistant-websocket":  "0.80.3",
                        "node-red-node-smooth":  "0.1.2"
                    }
    },
    {
        "id":  "6819518feb29bc2f",
        "type":  "tab",
        "label":  "Strategy Sell v4.4.0",
        "disabled":  false,
        "info":  "",
        "env":  [

                ]
    },
    {
        "id":  "c012a4c4654b9f8a",
        "type":  "group",
        "z":  "6819518feb29bc2f",
        "name":  "Configuration",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "88d140e6db042b42",
                      "66db40302e9e54a9",
                      "5301303a8eae52c7"
                  ],
        "x":  34,
        "y":  99,
        "w":  192,
        "h":  162
    },
    {
        "id":  "983d4445f8c86ed1",
        "type":  "group",
        "z":  "6819518feb29bc2f",
        "name":  "Battery solutions",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "46490841f83ca3c7",
                      "4e38b658e7dbc35d",
                      "c1d213fc3151fb6d"
                  ],
        "x":  34,
        "y":  479,
        "w":  192,
        "h":  142
    },
    {
        "id":  "b2480d3856f6ea64",
        "type":  "group",
        "z":  "6819518feb29bc2f",
        "name":  "Export routine",
        "style":  {
                      "fill-opacity":  "0.5",
                      "label":  true,
                      "color":  "#cccccc"
                  },
        "nodes":  [
                      "6a6931a955f6c833",
                      "7b620c3dfb807edd",
                      "e22ebb011efbc4cc",
                      "de700cf82683f543",
                      "57cd95668e56442b",
                      "0bfef3b4938f4e6d",
                      "69e76030bcba4b66",
                      "01795fe3a266986e",
                      "347d48605c61b1a5",
                      "71e11b40285b7f6e"
                  ],
        "x":  254,
        "y":  319,
        "w":  1192,
        "h":  182
    },
    {
        "id":  "dd8b19e7bf513b66",
        "type":  "group",
        "z":  "6819518feb29bc2f",
        "name":  "Decide export or stop",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "9b8f31e557c91443",
                      "bfb394f0af0d5dfa",
                      "ea3d471c1dee0bc9",
                      "7c6de3ac6b10c8a7",
                      "246388ca4d83ed2a",
                      "87bda5c8c5691235",
                      "929c73ef65cba467",
                      "91fd111095f02cd2",
                      "770a96b489b4b655",
                      "de3975c8a07bb567",
                      "7ad032aaeafc7c5f",
                      "af437663036aaea8",
                      "6d09d52baf6887ea",
                      "edb741bf5d78cf0d",
                      "f5ba7fd8b5bb7462",
                      "0caffb6f3dcf54aa",
                      "64ce1b00832934c8",
                      "50111f095ccb54db",
                      "35e1677dd1e4b3ac"
                  ],
        "x":  254,
        "y":  79,
        "w":  1838,
        "h":  207
    },
    {
        "id":  "303aed49c7d7423b",
        "type":  "group",
        "z":  "6819518feb29bc2f",
        "name":  "Unhandled exceptions",
        "style":  {
                      "label":  true,
                      "stroke":  "#d88a8a",
                      "color":  "#d88a8a"
                  },
        "nodes":  [
                      "db058dac42db1b30",
                      "182b31853a6284f3",
                      "90901c3a5ef64aad"
                  ],
        "x":  34,
        "y":  379,
        "w":  182,
        "h":  82
    },
    {
        "id":  "35e1677dd1e4b3ac",
        "type":  "group",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "UI helper | set bounds for charge levels",
        "style":  {
                      "label":  true,
                      "stroke":  "#3f93cf"
                  },
        "nodes":  [
                      "68c0d0e1616cfaf9",
                      "eaf7016bb6a0b532",
                      "81b185c39bea545f"
                  ],
        "x":  1394,
        "y":  159,
        "w":  672,
        "h":  82
    },
    {
        "id":  "50111f095ccb54db",
        "type":  "junction",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "x":  1440,
        "y":  260,
        "wires":  [
                      [
                          "347d48605c61b1a5"
                      ]
                  ]
    },
    {
        "id":  "31f22bd0985bda56",
        "type":  "comment",
        "z":  "6819518feb29bc2f",
        "name":  "Home Battery Strategy",
        "info":  "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon\u0027t modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x":  140,
        "y":  60,
        "wires":  [

                  ]
    },
    {
        "id":  "88d140e6db042b42",
        "type":  "link in",
        "z":  "6819518feb29bc2f",
        "g":  "c012a4c4654b9f8a",
        "name":  "Sell",
        "links":  [

                  ],
        "x":  110,
        "y":  220,
        "wires":  [
                      [
                          "5301303a8eae52c7"
                      ]
                  ],
        "l":  true
    },
    {
        "id":  "66db40302e9e54a9",
        "type":  "comment",
        "z":  "6819518feb29bc2f",
        "g":  "c012a4c4654b9f8a",
        "name":  "Start (readme)",
        "info":  "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the \u003cselect\u003e option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select \u0027AcmE example\u0027\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled \u0027AcmE example\u0027 (case sensitive).",
        "x":  130,
        "y":  140,
        "wires":  [

                  ]
    },
    {
        "id":  "5301303a8eae52c7",
        "type":  "change",
        "z":  "6819518feb29bc2f",
        "g":  "c012a4c4654b9f8a",
        "name":  "Trace",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "strategy.trace",
                          "pt":  "msg",
                          "to":  "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                          "tot":  "jsonata"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  110,
        "y":  180,
        "wires":  [
                      [
                          "64ce1b00832934c8"
                      ]
                  ],
        "info":  "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id":  "46490841f83ca3c7",
        "type":  "link out",
        "z":  "6819518feb29bc2f",
        "g":  "983d4445f8c86ed1",
        "name":  "Return",
        "mode":  "return",
        "links":  [

                  ],
        "x":  185,
        "y":  580,
        "wires":  [

                  ]
    },
    {
        "id":  "4e38b658e7dbc35d",
        "type":  "comment",
        "z":  "6819518feb29bc2f",
        "g":  "983d4445f8c86ed1",
        "name":  "End (readme)",
        "info":  "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x":  130,
        "y":  520,
        "wires":  [

                  ]
    },
    {
        "id":  "6a6931a955f6c833",
        "type":  "function",
        "z":  "6819518feb29bc2f",
        "g":  "b2480d3856f6ea64",
        "name":  "Max power solution",
        "func":  "// Logger, usage: log(this, \"\");\nconst log = global.get(\u0027logger\u0027);\nlog(this, \"Discharge at **max. power**\");\n\n// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// build solution\nmsg.batteries.forEach(battery =\u003e {\n    const calculatedPower = Number(battery.discharging_max);\n\n    solution_array.push({\n        id: battery.id,\n        mode: \"discharge\",\n        power: calculatedPower\n    });\n\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  970,
        "y":  360,
        "wires":  [
                      [
                          "69e76030bcba4b66"
                      ]
                  ]
    },
    {
        "id":  "7b620c3dfb807edd",
        "type":  "link call",
        "z":  "6819518feb29bc2f",
        "g":  "b2480d3856f6ea64",
        "name":  "Call flow",
        "links":  [

                  ],
        "linkType":  "dynamic",
        "timeout":  "30",
        "x":  1140,
        "y":  400,
        "wires":  [
                      [
                          "de700cf82683f543",
                          "01795fe3a266986e"
                      ]
                  ]
    },
    {
        "id":  "e22ebb011efbc4cc",
        "type":  "switch",
        "z":  "6819518feb29bc2f",
        "g":  "b2480d3856f6ea64",
        "name":  "Export at max power",
        "property":  "house_battery_strategy_sell_has_max_power",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "on",
                          "vt":  "str"
                      },
                      {
                          "t":  "else"
                      }
                  ],
        "checkall":  "false",
        "repair":  false,
        "outputs":  2,
        "x":  760,
        "y":  380,
        "wires":  [
                      [
                          "6a6931a955f6c833"
                      ],
                      [
                          "0bfef3b4938f4e6d"
                      ]
                  ]
    },
    {
        "id":  "de700cf82683f543",
        "type":  "debug",
        "z":  "6819518feb29bc2f",
        "g":  "b2480d3856f6ea64",
        "name":  "Regulated",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "payload",
        "targetType":  "msg",
        "statusVal":  "payload",
        "statusType":  "auto",
        "x":  1330,
        "y":  400,
        "wires":  [

                  ]
    },
    {
        "id":  "57cd95668e56442b",
        "type":  "debug",
        "z":  "6819518feb29bc2f",
        "g":  "b2480d3856f6ea64",
        "name":  "Maximum",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "payload",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "counter",
        "x":  1320,
        "y":  360,
        "wires":  [

                  ]
    },
    {
        "id":  "0bfef3b4938f4e6d",
        "type":  "function",
        "z":  "6819518feb29bc2f",
        "g":  "b2480d3856f6ea64",
        "name":  "Regulated power",
        "func":  "// Logger, usage: log(this, \"\");\nconst log = global.get(\u0027logger\u0027);\n\n// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = -msg.house_battery_strategy_sell_target_power; // negative, we are exporting to grid.\n// tell PID to avoid charge solutions during Selling.\nRED.util.setMessageProperty(msg,\"advanced_settings.charge_disabled\",true,true);\n\n// Finally\nlog(this, `**Regulated** discharging. Max. grid power: ${Math.floor(msg.house_battery_strategy_sell_target_power)} W`);\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  970,
        "y":  400,
        "wires":  [
                      [
                          "7b620c3dfb807edd"
                      ]
                  ]
    },
    {
        "id":  "69e76030bcba4b66",
        "type":  "change",
        "z":  "6819518feb29bc2f",
        "g":  "b2480d3856f6ea64",
        "name":  "Continue",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "target",
                          "pt":  "msg",
                          "to":  "Charge",
                          "tot":  "str"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  1140,
        "y":  360,
        "wires":  [
                      [
                          "57cd95668e56442b",
                          "01795fe3a266986e"
                      ]
                  ]
    },
    {
        "id":  "68c0d0e1616cfaf9",
        "type":  "function",
        "z":  "6819518feb29bc2f",
        "g":  "35e1677dd1e4b3ac",
        "name":  "Min/max",
        "func":  "\n// Lower bound\nlet output = msg.sell.threshold_energy | 0; // kWh\noutput = Math.max(output, 0);\n\n// Upper bound\nlet max_reserve = 0; // kWh\nmsg.batteries.forEach(battery =\u003e {\n    max_reserve += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\noutput = Math.min(output, max_reserve);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1720,
        "y":  200,
        "wires":  [
                      [
                          "eaf7016bb6a0b532"
                      ]
                  ]
    },
    {
        "id":  "eaf7016bb6a0b532",
        "type":  "api-call-service",
        "z":  "6819518feb29bc2f",
        "g":  "35e1677dd1e4b3ac",
        "name":  "Set desired energy reserve",
        "server":  "176d29a.6f648d6",
        "version":  7,
        "debugenabled":  false,
        "action":  "input_number.set_value",
        "floorId":  [

                    ],
        "areaId":  [

                   ],
        "deviceId":  [

                     ],
        "entityId":  [
                         "input_number.house_battery_strategy_sell_target_energy"
                     ],
        "labelId":  [

                    ],
        "data":  "{\"value\": $$.payload}",
        "dataType":  "jsonata",
        "mergeContext":  "",
        "mustacheAltTags":  false,
        "outputProperties":  [

                             ],
        "queue":  "none",
        "blockInputOverrides":  true,
        "domain":  "input_number",
        "service":  "set_value",
        "x":  1920,
        "y":  200,
        "wires":  [
                      [

                      ]
                  ]
    },
    {
        "id":  "81b185c39bea545f",
        "type":  "rbe",
        "z":  "6819518feb29bc2f",
        "g":  "35e1677dd1e4b3ac",
        "name":  "Desired energy changed",
        "func":  "rbe",
        "gap":  "",
        "start":  "",
        "inout":  "out",
        "septopics":  false,
        "property":  "payload",
        "topi":  "topic",
        "x":  1530,
        "y":  200,
        "wires":  [
                      [
                          "68c0d0e1616cfaf9"
                      ]
                  ]
    },
    {
        "id":  "0caffb6f3dcf54aa",
        "type":  "api-current-state",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Goal",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.house_battery_strategy_sell_goal",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "sell.goal",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  450,
        "y":  180,
        "wires":  [
                      [
                          "f5ba7fd8b5bb7462"
                      ]
                  ]
    },
    {
        "id":  "f5ba7fd8b5bb7462",
        "type":  "switch",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Sell until",
        "property":  "sell.goal",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "batteries are empty",
                          "vt":  "str"
                      },
                      {
                          "t":  "eq",
                          "v":  "state of charge",
                          "vt":  "str"
                      },
                      {
                          "t":  "eq",
                          "v":  "energy reserve",
                          "vt":  "str"
                      },
                      {
                          "t":  "else"
                      }
                  ],
        "checkall":  "false",
        "repair":  false,
        "outputs":  4,
        "x":  580,
        "y":  180,
        "wires":  [
                      [
                          "91fd111095f02cd2"
                      ],
                      [
                          "246388ca4d83ed2a"
                      ],
                      [
                          "ea3d471c1dee0bc9"
                      ],
                      [
                          "9b8f31e557c91443"
                      ]
                  ]
    },
    {
        "id":  "9b8f31e557c91443",
        "type":  "function",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Unknown -\u003e Full stop",
        "func":  "const log = global.get(\"logger\");\n\n// Unkown export goal\nlog(this, `**${msg.sell.goal}**; Sell goal not recognized. Fallback to **Full Stop**`,\"warn\");\n\n// Full stop\nmsg.target = \"Full stop\";\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  760,
        "y":  240,
        "wires":  [
                      [
                          "bfb394f0af0d5dfa"
                      ]
                  ]
    },
    {
        "id":  "64ce1b00832934c8",
        "type":  "function",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Init",
        "func":  "msg.sell = {};\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  330,
        "y":  180,
        "wires":  [
                      [
                          "0caffb6f3dcf54aa"
                      ]
                  ]
    },
    {
        "id":  "bfb394f0af0d5dfa",
        "type":  "link call",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Call flow",
        "links":  [

                  ],
        "linkType":  "dynamic",
        "timeout":  "5",
        "x":  940,
        "y":  240,
        "wires":  [
                      [
                          "7c6de3ac6b10c8a7"
                      ]
                  ]
    },
    {
        "id":  "ea3d471c1dee0bc9",
        "type":  "api-current-state",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Energy reserve low",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_strategy_sell_target_energy",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "sell.threshold_energy",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  750,
        "y":  200,
        "wires":  [
                      [
                          "87bda5c8c5691235"
                      ]
                  ]
    },
    {
        "id":  "c1d213fc3151fb6d",
        "type":  "link in",
        "z":  "6819518feb29bc2f",
        "g":  "983d4445f8c86ed1",
        "name":  "link to End",
        "links":  [
                      "7c6de3ac6b10c8a7",
                      "6d09d52baf6887ea",
                      "01795fe3a266986e"
                  ],
        "x":  75,
        "y":  580,
        "wires":  [
                      [
                          "46490841f83ca3c7"
                      ]
                  ]
    },
    {
        "id":  "7c6de3ac6b10c8a7",
        "type":  "link out",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "go to End",
        "mode":  "link",
        "links":  [
                      "c1d213fc3151fb6d"
                  ],
        "x":  1140,
        "y":  240,
        "wires":  [

                  ],
        "l":  true
    },
    {
        "id":  "246388ca4d83ed2a",
        "type":  "api-current-state",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "SoC low",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_strategy_sell_target_soc",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "sell.threshold_soc",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  720,
        "y":  160,
        "wires":  [
                      [
                          "929c73ef65cba467"
                      ]
                  ]
    },
    {
        "id":  "87bda5c8c5691235",
        "type":  "function",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Check if low",
        "func":  "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Sell until: ${msg.sell.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nvar energy_threshold = Number(RED.util.getMessageProperty(msg,\"sell.threshold_energy\"));\nif (energy_threshold === undefined || energy_threshold \u003c 0){\n    log(this,`Desired energy reserve not set correctly \u0027${energy_threshold}\u0027 kWh`,\"warn\");\n    energy_threshold = 0;\n}\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining \u003c= energy_threshold) {\n    msg.sell.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh`, \u0027info\u0027);\n} else {\n    msg.sell.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh.`, \u0027info\u0027);\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.sell.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.sell.threshold_reached}` \n});\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  950,
        "y":  200,
        "wires":  [
                      [
                          "edb741bf5d78cf0d",
                          "81b185c39bea545f"
                      ]
                  ]
    },
    {
        "id":  "929c73ef65cba467",
        "type":  "function",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Check if low",
        "func":  "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this, `Sell until: ${msg.sell.goal}`);\n\n// 2. Extract average SoC and desired SoC level\nlet batteries = msg.batteries;\nlet soc_avg = 0;\nlet count = 0; // could use msg.battery_count\nbatteries.forEach(battery =\u003e {\n    soc_avg += battery.soc;\n    count++;\n});\n// 2a.  Current avg. SoC\nsoc_avg = Math.round(soc_avg / count * 100) / 100;\n// 2b.  Sell until SoC (12% as fallback)\nvar soc_threshold = Number(RED.util.getMessageProperty(msg,\"sell.threshold_soc\"));\nif (soc_threshold === undefined || soc_threshold \u003c 12){\n    log(this, `Desired SoC not set correctly \u0027${soc_threshold}\u0027 %. I\u0027ve set it to 12%.`,\"warn\");\n    soc_threshold = 12;\n}\n\n// 3. Logic: Determine if SoC level is at or below desired level\nif (soc_avg \u003c= msg.payload) {\n    msg.sell.threshold_reached = true;\n\n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, \u0027info\u0027);\n} else {\n    msg.sell.threshold_reached = false;\n\n    // User friendly feedback via the custom logger\n    log(this, `[OK] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, \u0027info\u0027);\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({\n    fill: msg.sell.threshold_reached ? \"red\" : \"green\",\n    shape: \"dot\",\n    text: `Threshold reached: ${msg.sell.threshold_reached}`\n});\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  950,
        "y":  160,
        "wires":  [
                      [
                          "edb741bf5d78cf0d"
                      ]
                  ]
    },
    {
        "id":  "91fd111095f02cd2",
        "type":  "change",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Batteries are empty",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "payload",
                          "pt":  "msg",
                          "to":  "0",
                          "tot":  "num"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  750,
        "y":  120,
        "wires":  [
                      [
                          "770a96b489b4b655"
                      ]
                  ]
    },
    {
        "id":  "770a96b489b4b655",
        "type":  "function",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Check if empty",
        "func":  "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Sell until: ${msg.sell.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining \u003c= 0) {\n    msg.sell.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] All batteries are empty or at SoC_min_ (${energy_remaining} kWh).`, \u0027info\u0027);\n} else {\n    msg.sell.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Battery level ${energy_remaining.toFixed(2)} kWh above 0 kWh.`, \u0027info\u0027);\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.sell.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.sell.threshold_reached}` \n});\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  960,
        "y":  120,
        "wires":  [
                      [
                          "edb741bf5d78cf0d"
                      ]
                  ]
    },
    {
        "id":  "de3975c8a07bb567",
        "type":  "switch",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Until reached",
        "property":  "sell.threshold_reached",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "true"
                      },
                      {
                          "t":  "false"
                      }
                  ],
        "checkall":  "true",
        "repair":  false,
        "outputs":  2,
        "x":  1290,
        "y":  160,
        "wires":  [
                      [
                          "7ad032aaeafc7c5f"
                      ],
                      [
                          "50111f095ccb54db"
                      ]
                  ]
    },
    {
        "id":  "7ad032aaeafc7c5f",
        "type":  "function",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Yes -\u003e Full stop",
        "func":  "\nmsg.target = \"Full stop\";\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1520,
        "y":  120,
        "wires":  [
                      [
                          "af437663036aaea8"
                      ]
                  ]
    },
    {
        "id":  "af437663036aaea8",
        "type":  "link call",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Call flow",
        "links":  [

                  ],
        "linkType":  "dynamic",
        "timeout":  "5",
        "x":  1680,
        "y":  120,
        "wires":  [
                      [
                          "6d09d52baf6887ea"
                      ]
                  ]
    },
    {
        "id":  "6d09d52baf6887ea",
        "type":  "link out",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "go to End",
        "mode":  "link",
        "links":  [
                      "c1d213fc3151fb6d"
                  ],
        "x":  1820,
        "y":  120,
        "wires":  [

                  ],
        "l":  true
    },
    {
        "id":  "edb741bf5d78cf0d",
        "type":  "function",
        "z":  "6819518feb29bc2f",
        "g":  "dd8b19e7bf513b66",
        "name":  "Decided",
        "func":  "const log = global.get(\"logger\");\n\nif(msg.sell.threshold_reached){\n    log(this,`Stop discharging, Sell until ${msg.sell.goal} reached.`);\n} else {\n    log(this,`Continue discharging.`);\n}\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  1140,
        "y":  160,
        "wires":  [
                      [
                          "de3975c8a07bb567"
                      ]
                  ]
    },
    {
        "id":  "01795fe3a266986e",
        "type":  "link out",
        "z":  "6819518feb29bc2f",
        "g":  "b2480d3856f6ea64",
        "name":  "go to End",
        "mode":  "link",
        "links":  [
                      "c1d213fc3151fb6d"
                  ],
        "x":  1320,
        "y":  460,
        "wires":  [

                  ],
        "l":  true
    },
    {
        "id":  "db058dac42db1b30",
        "type":  "catch",
        "z":  "6819518feb29bc2f",
        "g":  "303aed49c7d7423b",
        "name":  "",
        "scope":  null,
        "uncaught":  false,
        "x":  75,
        "y":  420,
        "wires":  [
                      [
                          "182b31853a6284f3"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "347d48605c61b1a5",
        "type":  "api-current-state",
        "z":  "6819518feb29bc2f",
        "g":  "b2480d3856f6ea64",
        "name":  "Use max power?",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_boolean.house_battery_strategy_sell_has_max_power",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_sell_has_max_power",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  370,
        "y":  380,
        "wires":  [
                      [
                          "71e11b40285b7f6e"
                      ]
                  ]
    },
    {
        "id":  "71e11b40285b7f6e",
        "type":  "api-current-state",
        "z":  "6819518feb29bc2f",
        "g":  "b2480d3856f6ea64",
        "name":  "Grid power limit",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_number.house_battery_strategy_sell_target_power",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_sell_target_power",
                                     "propertyType":  "msg",
                                     "value":  "number",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  560,
        "y":  380,
        "wires":  [
                      [
                          "e22ebb011efbc4cc"
                      ]
                  ]
    },
    {
        "id":  "182b31853a6284f3",
        "type":  "function",
        "z":  "6819518feb29bc2f",
        "g":  "303aed49c7d7423b",
        "name":  "Unhandled Exception",
        "func":  "const handle = global.get(\u0027unhandledException\u0027);\n\nhandle(this);\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  125,
        "y":  420,
        "wires":  [
                      [
                          "90901c3a5ef64aad"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "90901c3a5ef64aad",
        "type":  "link out",
        "z":  "6819518feb29bc2f",
        "g":  "303aed49c7d7423b",
        "name":  "link out 2",
        "mode":  "return",
        "links":  [

                  ],
        "x":  175,
        "y":  420,
        "wires":  [

                  ]
    },
    {
        "id":  "176d29a.6f648d6",
        "type":  "server",
        "name":  "Home Assistant",
        "addon":  true,
        "rejectUnauthorizedCerts":  true,
        "ha_boolean":  "",
        "connectionDelay":  false,
        "cacheJson":  false,
        "heartbeat":  false,
        "heartbeatInterval":  "",
        "statusSeparator":  "",
        "enableGlobalContextStore":  false
    },
    {
        "id":  "a0691f57dd534c02",
        "type":  "global-config",
        "env":  [

                ],
        "modules":  {
                        "node-red-contrib-home-assistant-websocket":  "0.80.3"
                    }
    },
    {
        "id":  "059df42b6fb40c8f",
        "type":  "tab",
        "label":  "Strategy Timed v4.4.0",
        "disabled":  false,
        "info":  "",
        "env":  [

                ]
    },
    {
        "id":  "54c94ebd89da685d",
        "type":  "group",
        "z":  "059df42b6fb40c8f",
        "name":  "Battery solutions",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "dfe2c6a1bea7855e",
                      "862400c6d21dd101"
                  ],
        "x":  1214,
        "y":  419,
        "w":  192,
        "h":  142
    },
    {
        "id":  "47542b9ca6cbeca7",
        "type":  "group",
        "z":  "059df42b6fb40c8f",
        "style":  {
                      "stroke":  "#565656",
                      "stroke-opacity":  "1",
                      "fill":  "#3a3a3a",
                      "fill-opacity":  "0.5",
                      "label":  true,
                      "label-position":  "nw",
                      "color":  "#cccccc"
                  },
        "nodes":  [
                      "2526333e20dd12a7",
                      "1454735410b05248",
                      "6db1379591bfe759"
                  ],
        "x":  24,
        "y":  79,
        "w":  192,
        "h":  162
    },
    {
        "id":  "9c4e09f921f03854",
        "type":  "group",
        "z":  "059df42b6fb40c8f",
        "style":  {
                      "stroke":  "#565656",
                      "stroke-opacity":  "1",
                      "fill":  "#3a3a3a",
                      "fill-opacity":  "0.5",
                      "label":  true,
                      "label-position":  "nw",
                      "color":  "#cccccc"
                  },
        "nodes":  [
                      "fb150113a4c1de3c",
                      "3a41d48c81926976",
                      "2d7ba70c066363c0"
                  ],
        "x":  454,
        "y":  79,
        "w":  532,
        "h":  82
    },
    {
        "id":  "326723fc916894d1",
        "type":  "group",
        "z":  "059df42b6fb40c8f",
        "style":  {
                      "stroke":  "#565656",
                      "stroke-opacity":  "1",
                      "fill":  "#3a3a3a",
                      "fill-opacity":  "0.5",
                      "label":  true,
                      "label-position":  "nw",
                      "color":  "#cccccc"
                  },
        "nodes":  [
                      "d0c66ec7e53841f8",
                      "1dd62f335fa0392d",
                      "3d6b81b908d110c9",
                      "95a2097fd2b90b20"
                  ],
        "x":  254,
        "y":  179,
        "w":  732,
        "h":  82
    },
    {
        "id":  "c3bf08334b36b559",
        "type":  "group",
        "z":  "059df42b6fb40c8f",
        "style":  {
                      "stroke":  "#565656",
                      "stroke-opacity":  "1",
                      "fill":  "#3a3a3a",
                      "fill-opacity":  "0.5",
                      "label":  true,
                      "label-position":  "nw",
                      "color":  "#cccccc"
                  },
        "nodes":  [
                      "781d2ddbdd72e2b7"
                  ],
        "x":  254,
        "y":  79,
        "w":  192,
        "h":  82
    },
    {
        "id":  "c89689164328352d",
        "type":  "group",
        "z":  "059df42b6fb40c8f",
        "name":  "Determine sub-strategy based on time period",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "14c1279b689c4df0",
                      "19579bdfea370e1c",
                      "8fd2a175e4d213ba",
                      "7860ba68827463ce",
                      "6d165e26bcff9ed4",
                      "4aeef0d0ed5c67dd",
                      "3a62780ffe351c2d",
                      "9d5167ce7c43746e",
                      "27ee1e841ce5b2c0",
                      "d112ed1e5a183b13",
                      "a636b630f3a9c1fc",
                      "07ad1169b9613dc9",
                      "bc3d259ced5fde17",
                      "556dd462477b15fe",
                      "186805b4463f923c",
                      "0fb9198963763397",
                      "8e322b2e6f2aea1e",
                      "9897b7f3dc833704",
                      "f2df8dc9510bd4f2",
                      "6e56572d2180359c",
                      "b342ac6090a56194"
                  ],
        "x":  254,
        "y":  379,
        "w":  692,
        "h":  402
    },
    {
        "id":  "87822a8a14e45fc9",
        "type":  "group",
        "z":  "059df42b6fb40c8f",
        "name":  "Execute sub-strategy",
        "style":  {
                      "label":  true
                  },
        "nodes":  [
                      "9ba25cf153586bc6",
                      "9180815f676d24ec"
                  ],
        "x":  984,
        "y":  419,
        "w":  192,
        "h":  142
    },
    {
        "id":  "de9a63f0b8b3e254",
        "type":  "group",
        "z":  "059df42b6fb40c8f",
        "style":  {
                      "stroke":  "#565656",
                      "stroke-opacity":  "1",
                      "fill":  "#3a3a3a",
                      "fill-opacity":  "0.5",
                      "label":  true,
                      "label-position":  "nw",
                      "color":  "#cccccc"
                  },
        "nodes":  [
                      "ae687ab1c8fcf60e",
                      "7a5edc228dc385b9",
                      "d7faeecdf09ca23f",
                      "1ffbe114697d433f"
                  ],
        "x":  254,
        "y":  279,
        "w":  732,
        "h":  82
    },
    {
        "id":  "9f48c9fdc05ee4fb",
        "type":  "group",
        "z":  "059df42b6fb40c8f",
        "name":  "Unhandled exceptions",
        "style":  {
                      "label":  true,
                      "stroke":  "#d88a8a",
                      "color":  "#d88a8a"
                  },
        "nodes":  [
                      "03e443615c7073c3",
                      "b984d39ccd73cd62",
                      "59f0d60f98e74381"
                  ],
        "x":  24,
        "y":  279,
        "w":  182,
        "h":  82
    },
    {
        "id":  "2526333e20dd12a7",
        "type":  "link in",
        "z":  "059df42b6fb40c8f",
        "g":  "47542b9ca6cbeca7",
        "name":  "Timed",
        "links":  [

                  ],
        "x":  110,
        "y":  160,
        "wires":  [
                      [
                          "6db1379591bfe759"
                      ]
                  ],
        "l":  true
    },
    {
        "id":  "996cf4bf92e045e9",
        "type":  "comment",
        "z":  "059df42b6fb40c8f",
        "name":  "Home Battery Strategy",
        "info":  "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon\u0027t modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x":  130,
        "y":  40,
        "wires":  [

                  ]
    },
    {
        "id":  "1454735410b05248",
        "type":  "comment",
        "z":  "059df42b6fb40c8f",
        "g":  "47542b9ca6cbeca7",
        "name":  "Start (readme)",
        "info":  "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the \u003cselect\u003e option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select \u0027AcmE example\u0027\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled \u0027AcmE example\u0027 (case sensitive).",
        "x":  120,
        "y":  120,
        "wires":  [

                  ]
    },
    {
        "id":  "dfe2c6a1bea7855e",
        "type":  "link out",
        "z":  "059df42b6fb40c8f",
        "g":  "54c94ebd89da685d",
        "name":  "Return",
        "mode":  "return",
        "links":  [

                  ],
        "x":  1255,
        "y":  520,
        "wires":  [

                  ]
    },
    {
        "id":  "862400c6d21dd101",
        "type":  "comment",
        "z":  "059df42b6fb40c8f",
        "g":  "54c94ebd89da685d",
        "name":  "End (readme)",
        "info":  "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x":  1310,
        "y":  460,
        "wires":  [

                  ]
    },
    {
        "id":  "fb150113a4c1de3c",
        "type":  "api-current-state",
        "z":  "059df42b6fb40c8f",
        "g":  "9c4e09f921f03854",
        "name":  "Period A start",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_datetime.house_battery_strategy_timed_period_a1",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_timed_period_a1",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  550,
        "y":  120,
        "wires":  [
                      [
                          "3a41d48c81926976"
                      ]
                  ]
    },
    {
        "id":  "3a41d48c81926976",
        "type":  "api-current-state",
        "z":  "059df42b6fb40c8f",
        "g":  "9c4e09f921f03854",
        "name":  "Period A end",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_datetime.house_battery_strategy_timed_period_a2",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_timed_period_a2",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  710,
        "y":  120,
        "wires":  [
                      [
                          "2d7ba70c066363c0"
                      ]
                  ]
    },
    {
        "id":  "d0c66ec7e53841f8",
        "type":  "api-current-state",
        "z":  "059df42b6fb40c8f",
        "g":  "326723fc916894d1",
        "name":  "Period B start",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_datetime.house_battery_strategy_timed_period_b1",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_timed_period_b1",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  540,
        "y":  220,
        "wires":  [
                      [
                          "1dd62f335fa0392d"
                      ]
                  ]
    },
    {
        "id":  "1dd62f335fa0392d",
        "type":  "api-current-state",
        "z":  "059df42b6fb40c8f",
        "g":  "326723fc916894d1",
        "name":  "Period B end",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_datetime.house_battery_strategy_timed_period_b2",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_timed_period_b2",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  710,
        "y":  220,
        "wires":  [
                      [
                          "3d6b81b908d110c9"
                      ]
                  ]
    },
    {
        "id":  "2d7ba70c066363c0",
        "type":  "api-current-state",
        "z":  "059df42b6fb40c8f",
        "g":  "9c4e09f921f03854",
        "name":  "Strat during A",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.house_battery_strategy_timed_strat_a",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_timed_strat_a",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  880,
        "y":  120,
        "wires":  [
                      [
                          "95a2097fd2b90b20"
                      ]
                  ]
    },
    {
        "id":  "3d6b81b908d110c9",
        "type":  "api-current-state",
        "z":  "059df42b6fb40c8f",
        "g":  "326723fc916894d1",
        "name":  "Strat during B",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.house_battery_strategy_timed_strat_b",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_timed_strat_b",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  880,
        "y":  220,
        "wires":  [
                      [
                          "1ffbe114697d433f"
                      ]
                  ]
    },
    {
        "id":  "95a2097fd2b90b20",
        "type":  "api-current-state",
        "z":  "059df42b6fb40c8f",
        "g":  "326723fc916894d1",
        "name":  "Has period B",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_boolean.house_battery_strategy_timed_has_period_b",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_timed_has_period_b",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  350,
        "y":  220,
        "wires":  [
                      [
                          "d0c66ec7e53841f8"
                      ]
                  ]
    },
    {
        "id":  "01a134155e9375c8",
        "type":  "inject",
        "z":  "059df42b6fb40c8f",
        "name":  "Test",
        "props":  [
                      {
                          "p":  "payload"
                      },
                      {
                          "p":  "topic",
                          "vt":  "str"
                      }
                  ],
        "repeat":  "",
        "crontab":  "",
        "once":  false,
        "onceDelay":  0.1,
        "topic":  "",
        "payload":  "",
        "payloadType":  "date",
        "x":  330,
        "y":  40,
        "wires":  [
                      [
                          "781d2ddbdd72e2b7"
                      ]
                  ]
    },
    {
        "id":  "14c1279b689c4df0",
        "type":  "change",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "set Strat 0",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "timed_strategy",
                          "pt":  "msg",
                          "to":  "house_battery_strategy_timed_strat_0",
                          "tot":  "msg"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  630,
        "y":  460,
        "wires":  [
                      [
                          "8fd2a175e4d213ba"
                      ]
                  ]
    },
    {
        "id":  "19579bdfea370e1c",
        "type":  "change",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "set Strat A",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "timed_strategy",
                          "pt":  "msg",
                          "to":  "house_battery_strategy_timed_strat_a",
                          "tot":  "msg"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  630,
        "y":  420,
        "wires":  [
                      [
                          "556dd462477b15fe",
                          "d112ed1e5a183b13"
                      ]
                  ]
    },
    {
        "id":  "8fd2a175e4d213ba",
        "type":  "switch",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "has period B",
        "property":  "house_battery_strategy_timed_has_period_b",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "off",
                          "vt":  "str"
                      },
                      {
                          "t":  "eq",
                          "v":  "on",
                          "vt":  "str"
                      }
                  ],
        "checkall":  "false",
        "repair":  false,
        "outputs":  2,
        "x":  630,
        "y":  500,
        "wires":  [
                      [
                          "556dd462477b15fe",
                          "a636b630f3a9c1fc"
                      ],
                      [
                          "4aeef0d0ed5c67dd"
                      ]
                  ]
    },
    {
        "id":  "7860ba68827463ce",
        "type":  "function",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "config A",
        "func":  "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,\u0027house_battery_strategy_timed_period_a1\u0027),\n    endTime: RED.util.getMessageProperty(msg,\u0027house_battery_strategy_timed_period_a2\u0027),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  340,
        "y":  440,
        "wires":  [
                      [
                          "6d165e26bcff9ed4"
                      ]
                  ]
    },
    {
        "id":  "6d165e26bcff9ed4",
        "type":  "time-range-switch",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "Period A",
        "lat":  "",
        "lon":  "",
        "startTime":  "00:00",
        "endTime":  "00:00",
        "startOffset":  0,
        "endOffset":  0,
        "x":  480,
        "y":  440,
        "wires":  [
                      [
                          "19579bdfea370e1c"
                      ],
                      [
                          "14c1279b689c4df0"
                      ]
                  ]
    },
    {
        "id":  "4aeef0d0ed5c67dd",
        "type":  "function",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "config B",
        "func":  "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,\u0027house_battery_strategy_timed_period_b1\u0027),\n    endTime: RED.util.getMessageProperty(msg,\u0027house_battery_strategy_timed_period_b2\u0027),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  340,
        "y":  580,
        "wires":  [
                      [
                          "3a62780ffe351c2d"
                      ]
                  ]
    },
    {
        "id":  "3a62780ffe351c2d",
        "type":  "time-range-switch",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "Period B",
        "lat":  "",
        "lon":  "",
        "startTime":  "00:00",
        "endTime":  "00:00",
        "startOffset":  0,
        "endOffset":  0,
        "x":  480,
        "y":  580,
        "wires":  [
                      [
                          "9d5167ce7c43746e"
                      ],
                      [
                          "27ee1e841ce5b2c0"
                      ]
                  ]
    },
    {
        "id":  "9d5167ce7c43746e",
        "type":  "change",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "set Strat B",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "timed_strategy",
                          "pt":  "msg",
                          "to":  "house_battery_strategy_timed_strat_b",
                          "tot":  "msg"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  630,
        "y":  560,
        "wires":  [
                      [
                          "556dd462477b15fe",
                          "07ad1169b9613dc9"
                      ]
                  ]
    },
    {
        "id":  "27ee1e841ce5b2c0",
        "type":  "change",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "set Strat 0",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "timed_strategy",
                          "pt":  "msg",
                          "to":  "house_battery_strategy_timed_strat_0",
                          "tot":  "msg"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  630,
        "y":  600,
        "wires":  [
                      [
                          "186805b4463f923c"
                      ]
                  ]
    },
    {
        "id":  "781d2ddbdd72e2b7",
        "type":  "api-current-state",
        "z":  "059df42b6fb40c8f",
        "g":  "c3bf08334b36b559",
        "name":  "Default Strat",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.house_battery_strategy_timed_strat_0",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_timed_strat_0",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  350,
        "y":  120,
        "wires":  [
                      [
                          "fb150113a4c1de3c"
                      ]
                  ]
    },
    {
        "id":  "9ba25cf153586bc6",
        "type":  "link call",
        "z":  "059df42b6fb40c8f",
        "g":  "87822a8a14e45fc9",
        "name":  "Sub strategy",
        "links":  [

                  ],
        "linkType":  "dynamic",
        "timeout":  "30",
        "x":  1080,
        "y":  520,
        "wires":  [
                      [
                          "dfe2c6a1bea7855e"
                      ]
                  ]
    },
    {
        "id":  "556dd462477b15fe",
        "type":  "change",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "Select flow",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "target",
                          "pt":  "msg",
                          "to":  "timed_strategy",
                          "tot":  "msg"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  850,
        "y":  520,
        "wires":  [
                      [
                          "9ba25cf153586bc6",
                          "9180815f676d24ec"
                      ]
                  ]
    },
    {
        "id":  "d112ed1e5a183b13",
        "type":  "debug",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "A",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "strategy",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "counter",
        "x":  830,
        "y":  420,
        "wires":  [

                  ]
    },
    {
        "id":  "a636b630f3a9c1fc",
        "type":  "debug",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "0",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "strategy",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "counter",
        "x":  830,
        "y":  460,
        "wires":  [

                  ]
    },
    {
        "id":  "07ad1169b9613dc9",
        "type":  "debug",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "B",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "strategy",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "counter",
        "x":  830,
        "y":  560,
        "wires":  [

                  ]
    },
    {
        "id":  "bc3d259ced5fde17",
        "type":  "debug",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "0",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "strategy",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "counter",
        "x":  830,
        "y":  600,
        "wires":  [

                  ]
    },
    {
        "id":  "9180815f676d24ec",
        "type":  "debug",
        "z":  "059df42b6fb40c8f",
        "g":  "87822a8a14e45fc9",
        "name":  "Target",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "target",
        "targetType":  "msg",
        "statusVal":  "target",
        "statusType":  "auto",
        "x":  1060,
        "y":  460,
        "wires":  [

                  ]
    },
    {
        "id":  "ae687ab1c8fcf60e",
        "type":  "api-current-state",
        "z":  "059df42b6fb40c8f",
        "g":  "de9a63f0b8b3e254",
        "name":  "Period C start",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_datetime.house_battery_strategy_timed_period_c1",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_timed_period_c1",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  540,
        "y":  320,
        "wires":  [
                      [
                          "7a5edc228dc385b9"
                      ]
                  ]
    },
    {
        "id":  "7a5edc228dc385b9",
        "type":  "api-current-state",
        "z":  "059df42b6fb40c8f",
        "g":  "de9a63f0b8b3e254",
        "name":  "Period C end",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_datetime.house_battery_strategy_timed_period_c2",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_timed_period_c2",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  710,
        "y":  320,
        "wires":  [
                      [
                          "d7faeecdf09ca23f"
                      ]
                  ]
    },
    {
        "id":  "d7faeecdf09ca23f",
        "type":  "api-current-state",
        "z":  "059df42b6fb40c8f",
        "g":  "de9a63f0b8b3e254",
        "name":  "Strat during C",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_select.house_battery_strategy_timed_strat_c",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_timed_strat_c",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  880,
        "y":  320,
        "wires":  [
                      [
                          "7860ba68827463ce"
                      ]
                  ]
    },
    {
        "id":  "1ffbe114697d433f",
        "type":  "api-current-state",
        "z":  "059df42b6fb40c8f",
        "g":  "de9a63f0b8b3e254",
        "name":  "Has period C",
        "server":  "176d29a.6f648d6",
        "version":  3,
        "outputs":  1,
        "halt_if":  "",
        "halt_if_type":  "str",
        "halt_if_compare":  "is",
        "entity_id":  "input_boolean.house_battery_strategy_timed_has_period_c",
        "state_type":  "str",
        "blockInputOverrides":  true,
        "outputProperties":  [
                                 {
                                     "property":  "payload",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 },
                                 {
                                     "property":  "data",
                                     "propertyType":  "msg",
                                     "value":  "",
                                     "valueType":  "entity"
                                 },
                                 {
                                     "property":  "house_battery_strategy_timed_has_period_c",
                                     "propertyType":  "msg",
                                     "value":  "string",
                                     "valueType":  "entityState"
                                 }
                             ],
        "for":  "0",
        "forType":  "num",
        "forUnits":  "minutes",
        "override_topic":  false,
        "state_location":  "payload",
        "override_payload":  "msg",
        "entity_location":  "data",
        "override_data":  "msg",
        "x":  350,
        "y":  320,
        "wires":  [
                      [
                          "ae687ab1c8fcf60e"
                      ]
                  ]
    },
    {
        "id":  "186805b4463f923c",
        "type":  "switch",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "has period C",
        "property":  "house_battery_strategy_timed_has_period_c",
        "propertyType":  "msg",
        "rules":  [
                      {
                          "t":  "eq",
                          "v":  "off",
                          "vt":  "str"
                      },
                      {
                          "t":  "eq",
                          "v":  "on",
                          "vt":  "str"
                      }
                  ],
        "checkall":  "false",
        "repair":  false,
        "outputs":  2,
        "x":  630,
        "y":  640,
        "wires":  [
                      [
                          "556dd462477b15fe",
                          "bc3d259ced5fde17"
                      ],
                      [
                          "8e322b2e6f2aea1e"
                      ]
                  ]
    },
    {
        "id":  "0fb9198963763397",
        "type":  "debug",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "C",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "strategy",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "counter",
        "x":  830,
        "y":  700,
        "wires":  [

                  ]
    },
    {
        "id":  "8e322b2e6f2aea1e",
        "type":  "function",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "config C",
        "func":  "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,\u0027house_battery_strategy_timed_period_c1\u0027),\n    endTime: RED.util.getMessageProperty(msg,\u0027house_battery_strategy_timed_period_c2\u0027),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  340,
        "y":  720,
        "wires":  [
                      [
                          "9897b7f3dc833704"
                      ]
                  ]
    },
    {
        "id":  "9897b7f3dc833704",
        "type":  "time-range-switch",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "Period C",
        "lat":  "",
        "lon":  "",
        "startTime":  "00:00",
        "endTime":  "00:00",
        "startOffset":  0,
        "endOffset":  0,
        "x":  480,
        "y":  720,
        "wires":  [
                      [
                          "f2df8dc9510bd4f2"
                      ],
                      [
                          "6e56572d2180359c"
                      ]
                  ]
    },
    {
        "id":  "f2df8dc9510bd4f2",
        "type":  "change",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "set Strat C",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "timed_strategy",
                          "pt":  "msg",
                          "to":  "house_battery_strategy_timed_strat_c",
                          "tot":  "msg"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  630,
        "y":  700,
        "wires":  [
                      [
                          "0fb9198963763397",
                          "556dd462477b15fe"
                      ]
                  ]
    },
    {
        "id":  "6e56572d2180359c",
        "type":  "change",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "set Strat 0",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "timed_strategy",
                          "pt":  "msg",
                          "to":  "house_battery_strategy_timed_strat_0",
                          "tot":  "msg"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  630,
        "y":  740,
        "wires":  [
                      [
                          "556dd462477b15fe",
                          "b342ac6090a56194"
                      ]
                  ]
    },
    {
        "id":  "b342ac6090a56194",
        "type":  "debug",
        "z":  "059df42b6fb40c8f",
        "g":  "c89689164328352d",
        "name":  "0",
        "active":  true,
        "tosidebar":  false,
        "console":  false,
        "tostatus":  true,
        "complete":  "strategy",
        "targetType":  "msg",
        "statusVal":  "",
        "statusType":  "counter",
        "x":  830,
        "y":  740,
        "wires":  [

                  ]
    },
    {
        "id":  "6db1379591bfe759",
        "type":  "change",
        "z":  "059df42b6fb40c8f",
        "g":  "47542b9ca6cbeca7",
        "name":  "Trace",
        "rules":  [
                      {
                          "t":  "set",
                          "p":  "strategy.trace",
                          "pt":  "msg",
                          "to":  "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                          "tot":  "jsonata"
                      }
                  ],
        "action":  "",
        "property":  "",
        "from":  "",
        "to":  "",
        "reg":  false,
        "x":  110,
        "y":  200,
        "wires":  [
                      [
                          "781d2ddbdd72e2b7"
                      ]
                  ],
        "info":  "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id":  "03e443615c7073c3",
        "type":  "catch",
        "z":  "059df42b6fb40c8f",
        "g":  "9f48c9fdc05ee4fb",
        "name":  "",
        "scope":  null,
        "uncaught":  false,
        "x":  65,
        "y":  320,
        "wires":  [
                      [
                          "b984d39ccd73cd62"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "b984d39ccd73cd62",
        "type":  "function",
        "z":  "059df42b6fb40c8f",
        "g":  "9f48c9fdc05ee4fb",
        "name":  "Unhandled Exception",
        "func":  "const handle = global.get(\u0027unhandledException\u0027);\n\nhandle(this);\n\nreturn msg;",
        "outputs":  1,
        "timeout":  0,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  115,
        "y":  320,
        "wires":  [
                      [
                          "59f0d60f98e74381"
                      ]
                  ],
        "l":  false
    },
    {
        "id":  "59f0d60f98e74381",
        "type":  "link out",
        "z":  "059df42b6fb40c8f",
        "g":  "9f48c9fdc05ee4fb",
        "name":  "link out 8",
        "mode":  "return",
        "links":  [

                  ],
        "x":  165,
        "y":  320,
        "wires":  [

                  ]
    },
    {
        "id":  "176d29a.6f648d6",
        "type":  "server",
        "name":  "Home Assistant",
        "addon":  true,
        "rejectUnauthorizedCerts":  true,
        "ha_boolean":  "",
        "connectionDelay":  false,
        "cacheJson":  false,
        "heartbeat":  false,
        "heartbeatInterval":  "",
        "statusSeparator":  "",
        "enableGlobalContextStore":  false
    },
    {
        "id":  "af169a08cc56cdc4",
        "type":  "global-config",
        "env":  [

                ],
        "modules":  {
                        "node-red-contrib-home-assistant-websocket":  "0.80.3",
                        "node-red-contrib-time-range-switch":  "1.2.0"
                    }
    }
]
