[
    {
        "id": "896149ae00e704f5",
        "type": "tab",
        "label": "Home Battery Start v4.4.0-beta.2",
        "disabled": false,
        "info": "# Home battery control\r\nConsists of three flows:\r\n 1.  Start flow\r\n 1.  Control flow\r\n 1.  Master switch flow\r\n\r\n## Start flow\r\nThis is the starting point of your home battery control.\r\n\r\nIt starts with P1 measurement as a trigger.\r\nIt allows you to connect your battery sensors to the flow.\r\nIt ends with a function node, mapping your batteries to a battery_array\r\n\r\nThe battery_array is passed on to the control flow.\r\n\r\nWhen the control flow has calculated the desired corrections,\r\nit is passed back to this flow and applied to your batteries.",
        "env": []
    },
    {
        "id": "71116bfb3e38272c",
        "type": "tab",
        "label": "Home Battery Master Switch",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "aefce97eaa15d031",
        "type": "tab",
        "label": "Home Battery PID presets",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "676ceac4c521834d",
        "type": "tab",
        "label": "Strategy Charge PV v4.4.0-beta.2",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "1d62f5f10ba713f5",
        "type": "tab",
        "label": "Strategy Charge v4.4.0-beta.2",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "43e2c4565d34c242",
        "type": "tab",
        "label": "Strategy Dynamic v4.4.0-beta.2",
        "disabled": false,
        "info": "Dynamic contract automated management",
        "env": []
    },
    {
        "id": "5ca05ae5a089b8d2",
        "type": "tab",
        "label": "Strategy Full stop v4.4.0-beta.2",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "e184a39d1337c413",
        "type": "tab",
        "label": "Strategy Self-consumption v4.4.0-beta.2",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "5560f85f8090bf93",
        "type": "tab",
        "label": "Strategy Sell v4.4.0-beta.2",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "9a0e893446c26063",
        "type": "tab",
        "label": "Strategy Timed v4.4.0-beta.2",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "3976d86aa766d5a3",
        "type": "group",
        "z": "71116bfb3e38272c",
        "name": "Marstek master control switch",
        "style": {
            "label": true
        },
        "nodes": [
            "9445ea2e038dc4ff",
            "4d1c080186bf44c1",
            "fd6b0418a04bd26e",
            "ae01513077bdc25c",
            "034635b1ad500f69"
        ],
        "x": 34,
        "y": 19,
        "w": 898,
        "h": 382
    },
    {
        "id": "034635b1ad500f69",
        "type": "group",
        "z": "71116bfb3e38272c",
        "g": "3976d86aa766d5a3",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "3721d34b6a06e92e",
            "c459bdbef50be840",
            "6941c0d003d9dfc4",
            "b1076b886d0ae381",
            "e99d7127740fa14c",
            "30f8033fefac3897"
        ],
        "x": 414,
        "y": 99,
        "w": 492,
        "h": 222
    },
    {
        "id": "1ee5df773a0c4c46",
        "type": "group",
        "z": "aefce97eaa15d031",
        "name": "PID presets",
        "style": {
            "label": true
        },
        "nodes": [
            "f94bf3447ab1d3b6",
            "d9895fc84a647ea7",
            "180c9ef663adb682",
            "3087a5414ad9b62b",
            "85d81c076e277a20",
            "65d44233d785dfd9",
            "1b3bbed0be250d2b"
        ],
        "x": 34,
        "y": 19,
        "w": 632,
        "h": 242
    },
    {
        "id": "9889d591bcc38e89",
        "type": "group",
        "z": "676ceac4c521834d",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "87be4b85f89829b6",
            "d62d870eb44d3582"
        ],
        "x": 624,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "72059e541379a869",
        "type": "group",
        "z": "676ceac4c521834d",
        "name": "Start",
        "style": {
            "label": true
        },
        "nodes": [
            "a5e9e484430e1720",
            "bf548077ba6ca350",
            "be2a48e071dee195"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "6e6682265db1e9ee",
        "type": "group",
        "z": "676ceac4c521834d",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "524b61f06ac20ae7",
            "b068ce351aa5b926",
            "0d26b7f936be7947"
        ],
        "x": 14,
        "y": 259,
        "w": 182,
        "h": 82
    },
    {
        "id": "42159425f580075e",
        "type": "group",
        "z": "1d62f5f10ba713f5",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "65734383849629c6",
            "fddebee8d55be594",
            "a7e9b0ce381f5391"
        ],
        "x": 34,
        "y": 99,
        "w": 192,
        "h": 162
    },
    {
        "id": "849ecaade3aef957",
        "type": "group",
        "z": "1d62f5f10ba713f5",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "64d0bc689e0ec8d6",
            "bd97ba77809dd2c6",
            "69dca23dc0fde23a"
        ],
        "x": 34,
        "y": 479,
        "w": 192,
        "h": 142
    },
    {
        "id": "5a81ff9e8db2ca54",
        "type": "group",
        "z": "1d62f5f10ba713f5",
        "name": "Export routine",
        "style": {
            "fill-opacity": "0.5",
            "label": true,
            "color": "#cccccc"
        },
        "nodes": [
            "c72054350fa6275c",
            "cac7cff4025e6a9c",
            "1ef64b89e33e96de",
            "4bdab085defea2ee",
            "4bb990f2c3abc24e",
            "83fd4c160e428cf7",
            "aed94acf6dabea08",
            "e5b39c30f5b3859f",
            "fbe734165a41f66d",
            "082952f1b7f48d3b"
        ],
        "x": 254,
        "y": 319,
        "w": 1192,
        "h": 182
    },
    {
        "id": "44362bab0730561d",
        "type": "group",
        "z": "1d62f5f10ba713f5",
        "name": "Decide import or stop",
        "style": {
            "label": true
        },
        "nodes": [
            "6c0337fdec2983e9",
            "8929eed5d72dfed2",
            "fded88bfc00c76dd",
            "59b9f4945525df99",
            "f1af526f892414eb",
            "f380d11b820c4464",
            "0a071e39f37a28d7",
            "d6d0c3edb4ce5d15",
            "d84d8c12d10e505e",
            "ad40872cb6be0ad4",
            "f4a47ba5e8e0fcaa",
            "0b4d1fdcfb6a20c3",
            "1cecaa06aadd8cf2",
            "4667445f9a27a9d8",
            "1346727f82d33b6c",
            "b27ff494f6634ba9",
            "fd473b331f7e4663",
            "1af4d6d4a4760a8f",
            "327d0c28a11a705b",
            "fe1672746de4d3e1"
        ],
        "x": 254,
        "y": 79,
        "w": 1928,
        "h": 207
    },
    {
        "id": "327d0c28a11a705b",
        "type": "group",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "UI helper | set bounds for charge levels",
        "style": {
            "label": true,
            "stroke": "#3f93cf"
        },
        "nodes": [
            "72855d465c41b0ba",
            "8a7bf3d74e7276cf",
            "55b3fc51c2f3a0f4"
        ],
        "x": 1464,
        "y": 159,
        "w": 692,
        "h": 82
    },
    {
        "id": "a5850d6fc8d26fb3",
        "type": "group",
        "z": "1d62f5f10ba713f5",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "80a6da8b34d1f912",
            "aebb282c786f309d",
            "97b699bb128980d8"
        ],
        "x": 34,
        "y": 379,
        "w": 182,
        "h": 82
    },
    {
        "id": "05cb765beecd73cb",
        "type": "group",
        "z": "43e2c4565d34c242",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "f4c768e760e225d6",
            "f7919bf7f92d3335"
        ],
        "x": 934,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "dfa924afde42337c",
        "type": "group",
        "z": "43e2c4565d34c242",
        "name": "Home battery start",
        "style": {
            "label": true
        },
        "nodes": [
            "945de7fd5b370681",
            "69d14213c816cde1",
            "50dc607821101faf"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "fab67345066b14d4",
        "type": "group",
        "z": "43e2c4565d34c242",
        "name": "Plan",
        "style": {
            "label": true
        },
        "nodes": [
            "541095778cf7ea18",
            "016a52713f269f32",
            "4d50c682eac8903e",
            "1f1e3c94cb7cb585",
            "67366e68865750d3",
            "5b357349653af8f2",
            "ccaba979a2207c48"
        ],
        "x": 228,
        "y": 273,
        "w": 1244,
        "h": 1054
    },
    {
        "id": "6db710bf5c0d9ebd",
        "type": "group",
        "z": "43e2c4565d34c242",
        "name": "Execute",
        "style": {
            "label": true
        },
        "nodes": [
            "a66315a27f30818d",
            "d2d2d04b67466fbe",
            "1a175947a9cf9868",
            "82bc8c259e762fae",
            "6a70dd9bdcd5c801"
        ],
        "x": 234,
        "y": 119,
        "w": 672,
        "h": 122
    },
    {
        "id": "48c46e82f679cf46",
        "type": "group",
        "z": "43e2c4565d34c242",
        "name": "Test area",
        "style": {
            "label": true
        },
        "nodes": [
            "b598b6f2379450ed",
            "6957a57cc6e3bc51",
            "8c069c2aa3530361",
            "94a388e6c2cac376",
            "7919837e29c1125d",
            "aeba7268ed3b560d",
            "954a07430e3bf915",
            "551330f71b044604"
        ],
        "x": 234,
        "y": 1479,
        "w": 912,
        "h": 162
    },
    {
        "id": "2b9c51b9468b61d4",
        "type": "group",
        "z": "43e2c4565d34c242",
        "name": "All data",
        "style": {
            "label": true
        },
        "nodes": [
            "2715a31140d45541",
            "2caea70fa7734239",
            "15bed74d128dd42c",
            "e7bcb8e91e50c70e",
            "af99a757b80e5498"
        ],
        "x": 234,
        "y": 1659,
        "w": 672,
        "h": 142
    },
    {
        "id": "3be7aaf17aea51c8",
        "type": "group",
        "z": "43e2c4565d34c242",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "5cf8996f6c686075",
            "d1479b091824388d",
            "91b3355ce8069f27"
        ],
        "x": 24,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "67366e68865750d3",
        "type": "group",
        "z": "43e2c4565d34c242",
        "g": "fab67345066b14d4",
        "name": "API call to Data Source",
        "style": {
            "label": true
        },
        "nodes": [
            "1a6246ca9abf2e83",
            "c843bdeae79c0e58",
            "9860b755ba4b2d4e",
            "8262ba7519609e5a",
            "ef1da1d3a7216433",
            "f9d73dbee7d1d101",
            "6bd50ca39c76d914",
            "772f3e317433da1c",
            "a8208c750ae4a8f5",
            "eef1de260499e2e8",
            "21e31d9b506fda62",
            "08ab42d46d6b4a73",
            "25837266d45b787a",
            "89c9eb1d187f7737",
            "1d4a3f92488da986",
            "b9a41d9435cf8abd",
            "0bb50184686abc06",
            "1bd71d96b5e5525c",
            "daff0725d784350d",
            "97f82f3fae5a5912"
        ],
        "x": 254,
        "y": 519,
        "w": 752,
        "h": 362
    },
    {
        "id": "5b357349653af8f2",
        "type": "group",
        "z": "43e2c4565d34c242",
        "g": "fab67345066b14d4",
        "name": "Update when",
        "style": {
            "label": true
        },
        "nodes": [
            "3361691261d2f519",
            "8ab73e892d2154d9",
            "3c087a25af39d14b",
            "0d1c173cfa69474f",
            "88c7fbbb50fc9eb1",
            "1a661e75892b6c74",
            "a2c606034d1f2eaa",
            "03e0666c92b71771",
            "02148ab5c5eaaaf9",
            "8420e8ebe5336bac",
            "9518a456438a2d54",
            "b345941d67039862",
            "22b6bb41ec336a29",
            "fa3b6960bceef6ce",
            "685af86a816c2521",
            "a2e93b4c096f585c",
            "e27caf3c58554974",
            "e81dbb3b2450ad3a"
        ],
        "x": 254,
        "y": 299,
        "w": 1192,
        "h": 202
    },
    {
        "id": "ccaba979a2207c48",
        "type": "group",
        "z": "43e2c4565d34c242",
        "g": "fab67345066b14d4",
        "name": "Determine strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "3deb7fec0af7839e",
            "bbf0eca8289cd464",
            "f0163b0eeaf865e2",
            "110b3b19eb5133bc",
            "56ada86c06d721f7",
            "a95299c1bf1a13bc",
            "36c0d33885ed6329",
            "53acf427d49b2573",
            "1d789d31e8675fde",
            "20e01029024a4f0f",
            "cb43481920102fc0",
            "e7e2014216c27578",
            "213320a3faa32b56",
            "144cc66c5aa6fb0b",
            "d96bb293f1c1ceef",
            "4c12a8b240ab8a88"
        ],
        "x": 254,
        "y": 899,
        "w": 872,
        "h": 402
    },
    {
        "id": "c3404a37fd9ce4af",
        "type": "group",
        "z": "5ca05ae5a089b8d2",
        "name": "Strategy start",
        "style": {
            "label": true
        },
        "nodes": [
            "fedca8b9c6861865",
            "4febdc440faf9d73",
            "86fc6690200ea1d5"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "807415e9b7aacdfa",
        "type": "group",
        "z": "5ca05ae5a089b8d2",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "5ac782a79cce3909",
            "1dca26be7c0dd61b"
        ],
        "x": 464,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "baecf4a2995e8afe",
        "type": "group",
        "z": "5ca05ae5a089b8d2",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "527dbdfa3c0b7d81",
            "dbd5b285d0e8b8d2",
            "23b4b597108b5ea8"
        ],
        "x": 14,
        "y": 259,
        "w": 182,
        "h": 82
    },
    {
        "id": "2723688565a9c634",
        "type": "group",
        "z": "e184a39d1337c413",
        "name": "Strategy start",
        "style": {
            "fill": "#ffffff",
            "label": true
        },
        "nodes": [
            "3e88f5da0e69b42e",
            "c9840b5b8c7e49d7",
            "2b0b72f6a6e652a6"
        ],
        "x": 54,
        "y": 79,
        "w": 212,
        "h": 162
    },
    {
        "id": "0d6f19cec0c5c388",
        "type": "group",
        "z": "e184a39d1337c413",
        "name": "Battery solutions",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "f6226c2306ee9ee8",
            "313746f89f906284",
            "21acb676497f2452"
        ],
        "x": 64,
        "y": 1139,
        "w": 202,
        "h": 142
    },
    {
        "id": "92e61a0d500abb84",
        "type": "group",
        "z": "e184a39d1337c413",
        "name": "Bumpless operation",
        "style": {
            "label": true,
            "stroke": "#bfdbef"
        },
        "nodes": [
            "41747318b3f3f31d",
            "9e0bb28502245d26",
            "33ecc7bc513540ea",
            "a512c47ab67139c1"
        ],
        "x": 1614,
        "y": 19,
        "w": 252,
        "h": 242
    },
    {
        "id": "489c527c7313abfc",
        "type": "group",
        "z": "e184a39d1337c413",
        "name": "Bumpless operation - switching control modes",
        "style": {
            "stroke": "#bfdbef",
            "label": true
        },
        "nodes": [
            "b99d192bd81adb9c",
            "cd2ae66170b830ae",
            "7ce8c913944fc7cc",
            "34e4aaedcf1d736b",
            "9deda6a4d55421d3",
            "0fd4752631dcec3a",
            "2a2b58a2598e4907",
            "d825c145ae53c8e3",
            "49508ff3632a4d89",
            "267cf0b23eb8b5ba",
            "d304d131cf82b6e5",
            "b22c73b405d4e045"
        ],
        "x": 1614,
        "y": 279,
        "w": 592,
        "h": 289.5
    },
    {
        "id": "48db379ff2becb41",
        "type": "group",
        "z": "e184a39d1337c413",
        "name": "Inputs",
        "style": {
            "fill": "#7fb7df",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "286f10603840ceb3",
            "40f615ce16c4b2e1"
        ],
        "x": 288,
        "y": 13,
        "w": 904,
        "h": 234
    },
    {
        "id": "948129bcfd0c7f43",
        "type": "group",
        "z": "e184a39d1337c413",
        "name": "Pre processing",
        "style": {
            "fill": "#bfdbef",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "a53fb0a853ac670a",
            "9cae1e81780f6ce0",
            "ed840ffedfca971b"
        ],
        "x": 288,
        "y": 273,
        "w": 1104,
        "h": 294
    },
    {
        "id": "46ea1a32d8d14f77",
        "type": "group",
        "z": "e184a39d1337c413",
        "name": "Control",
        "style": {
            "fill": "#7fb7df",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "4e86a2ef81e3975b",
            "adda2ff093095af5"
        ],
        "x": 288,
        "y": 593,
        "w": 924,
        "h": 634
    },
    {
        "id": "4a92bbdb762ecdb9",
        "type": "group",
        "z": "e184a39d1337c413",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "a5a6cf2c39391430",
            "23cb9db5c6ec72c6",
            "4737d9d2ca4490b6"
        ],
        "x": 54,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "286f10603840ceb3",
        "type": "group",
        "z": "e184a39d1337c413",
        "g": "48db379ff2becb41",
        "name": "PID control inputs",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "7913d5674b438fab",
            "16cd178b1d21594b",
            "92e069c4fc3861e3",
            "d59f5a16ea57793f",
            "9e94ec0db734b8ef",
            "7562b977cfd31aa3",
            "cfe162e53efce392",
            "77234f588c6afaf4",
            "d6aab6f107b83c3b"
        ],
        "x": 314,
        "y": 59,
        "w": 572,
        "h": 162
    },
    {
        "id": "40f615ce16c4b2e1",
        "type": "group",
        "z": "e184a39d1337c413",
        "g": "48db379ff2becb41",
        "name": "Advanced features",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "249d2299dc07a4c6",
            "683d4daf39f4e598",
            "dd5f97660464a511"
        ],
        "x": 914,
        "y": 39,
        "w": 252,
        "h": 182
    },
    {
        "id": "a53fb0a853ac670a",
        "type": "group",
        "z": "e184a39d1337c413",
        "g": "948129bcfd0c7f43",
        "name": "",
        "style": {
            "fill": "#ffffff",
            "label": true
        },
        "nodes": [
            "af966047935faa0d",
            "72e3f43085489268",
            "13eb9c583fc3cfdd",
            "0e2a5f169f67e8a3"
        ],
        "x": 314,
        "y": 299,
        "w": 292,
        "h": 202
    },
    {
        "id": "9cae1e81780f6ce0",
        "type": "group",
        "z": "e184a39d1337c413",
        "g": "948129bcfd0c7f43",
        "name": "Derivative - incl. bumpless operation",
        "style": {
            "label": true,
            "stroke": "#a4a4a4",
            "fill": "#ffffff"
        },
        "nodes": [
            "af60facf037aa8b5",
            "0b8a2a11d42eb8a6",
            "1265f27ede4ef136",
            "390f41c303dfa5dd",
            "beecf72a05a8eaee"
        ],
        "x": 614,
        "y": 399,
        "w": 752,
        "h": 142
    },
    {
        "id": "ed840ffedfca971b",
        "type": "group",
        "z": "e184a39d1337c413",
        "g": "948129bcfd0c7f43",
        "name": "Processing required? ",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "5f0c4cdaaabbc848",
            "6ffae2de520d2ae0",
            "0a39a237120c812e"
        ],
        "x": 614,
        "y": 299,
        "w": 562,
        "h": 82
    },
    {
        "id": "4e86a2ef81e3975b",
        "type": "group",
        "z": "e184a39d1337c413",
        "g": "46ea1a32d8d14f77",
        "name": "PID controller",
        "style": {
            "label": true,
            "fill": "#ffffff",
            "color": "#3f3f3f"
        },
        "nodes": [
            "4a535ea5b5d712c7",
            "eecf5f770104b73e",
            "816fd55c2a6c9da0",
            "57b1e671994ce79a",
            "d6af403451692bb1",
            "c5c81b813bef18ee",
            "13cedb5ac2c99528",
            "12445fefbe81761d",
            "2bdc609a4d5236ab",
            "df2b5ebb83debc1b",
            "507c788f0acbdf5c",
            "a401c28b2f97d446",
            "cea41ec36a638d36",
            "643312ca6cafd95c",
            "1b5abf7326e94e89",
            "5c06841b47b468a5",
            "f20e44649ce394bd",
            "6222f1affee6e1d3",
            "6cb5f9c415ad542c",
            "54eeded097177b56"
        ],
        "x": 314,
        "y": 619,
        "w": 872,
        "h": 482
    },
    {
        "id": "adda2ff093095af5",
        "type": "group",
        "z": "e184a39d1337c413",
        "g": "46ea1a32d8d14f77",
        "name": "Distribution",
        "style": {
            "label": true,
            "fill": "#ffffff",
            "color": "#3f3f3f"
        },
        "nodes": [
            "5d6112b5e9fa0f62",
            "613b62b398624e27"
        ],
        "x": 314,
        "y": 1119,
        "w": 452,
        "h": 82
    },
    {
        "id": "1c447224bfccb47e",
        "type": "group",
        "z": "5560f85f8090bf93",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "23a49040e8762c14",
            "6e6fa505265ed7d4",
            "1585997ce4e375fa"
        ],
        "x": 34,
        "y": 99,
        "w": 192,
        "h": 162
    },
    {
        "id": "7000a014340b8aa4",
        "type": "group",
        "z": "5560f85f8090bf93",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "4c391f0a7231e0d1",
            "250d7fc386319ab1",
            "ce270f2f20b38713"
        ],
        "x": 34,
        "y": 479,
        "w": 192,
        "h": 142
    },
    {
        "id": "63f47da4656147c6",
        "type": "group",
        "z": "5560f85f8090bf93",
        "name": "Export routine",
        "style": {
            "fill-opacity": "0.5",
            "label": true,
            "color": "#cccccc"
        },
        "nodes": [
            "80cc93e9d3c758c9",
            "ae2e9e3cee8a11c0",
            "05e750be9ede996c",
            "8e67d1074e2b1f4f",
            "4f7753fdc47e1195",
            "c303f76532ba3722",
            "cbb1894870a4500c",
            "c2d00cbf314a1986",
            "5ebb90ca750f527c",
            "f0935e40e4c2bf8b"
        ],
        "x": 254,
        "y": 319,
        "w": 1192,
        "h": 182
    },
    {
        "id": "892a7ef3c44be3b7",
        "type": "group",
        "z": "5560f85f8090bf93",
        "name": "Decide export or stop",
        "style": {
            "label": true
        },
        "nodes": [
            "554fe61d9e4f4966",
            "747d9f12df1b36f5",
            "f5dcd5acd1cc1825",
            "68ac9883e13717da",
            "0d3c58e22f086ee2",
            "e84c64bd23fd75de",
            "ffcc3f03a7eb105b",
            "de451e4751f76e34",
            "2d205a925226693d",
            "f4e2ac17a3a1fa1f",
            "a3f9474e3a282c0d",
            "3e0117fd21ee8699",
            "397a9c7d1f920201",
            "0d670b1abdc56326",
            "913f774385a11310",
            "149db2e6fda1048e",
            "ff44b6c41fc405ef",
            "15421437c9729318",
            "5d0d14309a330b0a"
        ],
        "x": 254,
        "y": 79,
        "w": 1838,
        "h": 207
    },
    {
        "id": "e0d8d71eefdf1dd7",
        "type": "group",
        "z": "5560f85f8090bf93",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "79bf5f08c5e3e32a",
            "be738ca647956f14",
            "0cf408811df047c5"
        ],
        "x": 34,
        "y": 379,
        "w": 182,
        "h": 82
    },
    {
        "id": "5d0d14309a330b0a",
        "type": "group",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "UI helper | set bounds for charge levels",
        "style": {
            "label": true,
            "stroke": "#3f93cf"
        },
        "nodes": [
            "727ec8317fa8b94c",
            "f3d2032b57923bc1",
            "5c959a0e67fac748"
        ],
        "x": 1394,
        "y": 159,
        "w": 672,
        "h": 82
    },
    {
        "id": "6e733110b6527394",
        "type": "group",
        "z": "9a0e893446c26063",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "511dd53be62577be",
            "db46b8682c3dce9a"
        ],
        "x": 1214,
        "y": 419,
        "w": 192,
        "h": 142
    },
    {
        "id": "a459df64905d9b19",
        "type": "group",
        "z": "9a0e893446c26063",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "6bd77bbe501066aa",
            "22855ce20ff97d4b",
            "e9c4097572299ed8"
        ],
        "x": 24,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "67431ee65fa08b83",
        "type": "group",
        "z": "9a0e893446c26063",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "7ed0bffa2cd51adf",
            "049bccc9ed4b07a9",
            "d5de970480264a45"
        ],
        "x": 454,
        "y": 79,
        "w": 532,
        "h": 82
    },
    {
        "id": "37190b7d1d24db11",
        "type": "group",
        "z": "9a0e893446c26063",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "92aa1909b8a07503",
            "082ea5df6ede1394",
            "00c8c0d856df091b",
            "107d88137b2e4166"
        ],
        "x": 254,
        "y": 179,
        "w": 732,
        "h": 82
    },
    {
        "id": "117b470e420cdbdb",
        "type": "group",
        "z": "9a0e893446c26063",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "1ffa4cf0651fb6db"
        ],
        "x": 254,
        "y": 79,
        "w": 192,
        "h": 82
    },
    {
        "id": "d0c663c09ccb94f9",
        "type": "group",
        "z": "9a0e893446c26063",
        "name": "Determine sub-strategy based on time period",
        "style": {
            "label": true
        },
        "nodes": [
            "5a1a8f3d9c3fabce",
            "6276beee454b0faf",
            "03efcfb13944c7ce",
            "2e31cf3d98972bc0",
            "e1e4a1198c575418",
            "1c01da2540a3a36f",
            "f201a4fe3f63e338",
            "60b0be4ed6636e40",
            "8a7093a5d4a8186c",
            "2293a96189a7e6bc",
            "c201dad8fc5e03ca",
            "7125d42fb077af11",
            "9d5bc3fb6beeb590",
            "fef8e9938f9c04d4",
            "4f56bf0d99e521c5",
            "fa03edc1a23d6fb1",
            "3933d7a1ec2cc79c",
            "7b304f1333c82679",
            "0f71edfec9200132",
            "03a30ff3cd0768d8",
            "c85ac3a5125dfc4e"
        ],
        "x": 254,
        "y": 379,
        "w": 692,
        "h": 402
    },
    {
        "id": "903595f5e42d7154",
        "type": "group",
        "z": "9a0e893446c26063",
        "name": "Execute sub-strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "f3a2126ec649bed7",
            "f4fb91b1d053877e"
        ],
        "x": 984,
        "y": 419,
        "w": 192,
        "h": 142
    },
    {
        "id": "bd64b4be97f657f1",
        "type": "group",
        "z": "9a0e893446c26063",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "dad5602acce67ee0",
            "b84e3bdf51a7af16",
            "dabb7e7a3ed2adb7",
            "361b605c37749a37"
        ],
        "x": 254,
        "y": 279,
        "w": 732,
        "h": 82
    },
    {
        "id": "d182a8ebdd6fce4b",
        "type": "group",
        "z": "9a0e893446c26063",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "8f9d9ad6aebfacfa",
            "d8fe0be0b1a51ef7",
            "64258a0ea5d78832"
        ],
        "x": 24,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "6e2bceef3c55744c",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Start",
        "style": {
            "label": true,
            "stroke": "#009ac7"
        },
        "nodes": [
            "09bd7478158a6b53",
            "3ad6f661a3eabe02",
            "abe78e166b6a1c3d"
        ],
        "x": 34,
        "y": 19,
        "w": 652,
        "h": 82
    },
    {
        "id": "ce64d528f7526b9b",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Strategy selection",
        "style": {
            "label": true
        },
        "nodes": [
            "e100f79d5077b5fc",
            "4747baf7d3ad444c",
            "63302d6ac092c4fe",
            "c447589601c38de6",
            "d9f1ad7875f692c0",
            "2e46954ae78682d5",
            "3d973e1ecf1692b9",
            "b01af54fc746ef65"
        ],
        "x": 34,
        "y": 839,
        "w": 812,
        "h": 162
    },
    {
        "id": "445db1a1b028a1a0",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Get batteries information",
        "style": {
            "label": true
        },
        "nodes": [
            "6286249ec1d54825",
            "298a8422f93e8a66",
            "fd4e39841be12338",
            "4bce51f320bad9d4",
            "27e1bb709915ab2a",
            "5da7fd57a8978766",
            "43327471855bf648",
            "f2792a73e109c2b4"
        ],
        "x": 28,
        "y": 379,
        "w": 1664,
        "h": 242
    },
    {
        "id": "7e6c83082c98a4e1",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "On deploy and global logger",
        "style": {
            "label": true,
            "stroke": "#92d04f"
        },
        "nodes": [
            "17774e0c7ab34f0a",
            "9d164c5a2415585b",
            "ee3da4a66658939b"
        ],
        "x": 1294,
        "y": 19,
        "w": 592,
        "h": 82
    },
    {
        "id": "cd62a51934a7605b",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Set Batteries",
        "style": {
            "label": true
        },
        "nodes": [
            "b8d48491051b2f25",
            "d7067c3a4df79c31",
            "948a8a72d3709fd7",
            "ae2072683883f2f4",
            "85bec23e6485f663",
            "6fe2716ba561c0e0",
            "67760d289c0fadf0"
        ],
        "x": 34,
        "y": 1019,
        "w": 858,
        "h": 342
    },
    {
        "id": "7a4b0f08af941aea",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Battery priority",
        "style": {
            "label": true
        },
        "nodes": [
            "442790db0683aa3d",
            "6d50e040c9febf3b",
            "8af4f52d3b3c3106",
            "3de01c4d2d7d1e60",
            "3f78c6a777f70e0b",
            "4b732cb3bb1b3b19",
            "ca90eaf94fb051a4",
            "69f668331f3cfb7b",
            "e83878df31ca0eae"
        ],
        "x": 34,
        "y": 739,
        "w": 1852,
        "h": 82
    },
    {
        "id": "ea6cc613bfe841bb",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Calculate totals",
        "style": {
            "label": true
        },
        "nodes": [
            "0fd88dec02bd82f4"
        ],
        "x": 34,
        "y": 639,
        "w": 212,
        "h": 82
    },
    {
        "id": "87e06966531158e0",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Rate limiter",
        "style": {
            "label": true
        },
        "nodes": [
            "6127089a6b09fc20",
            "19baa8a0ae6ff146",
            "da12b683f16c6c90",
            "7fd87ced33d65773",
            "7830bf5117267666",
            "117056516f4acad3",
            "6a0d3b0a69e079f2",
            "8d3983a18d0672b1",
            "74231ab0ac8a9bf3",
            "33f59e815c544c72"
        ],
        "x": 34,
        "y": 219,
        "w": 1402,
        "h": 122
    },
    {
        "id": "f707a237741b883e",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Update UI: debug dashboard",
        "style": {
            "label": true,
            "stroke": "#3f5787"
        },
        "nodes": [
            "86c2fc69cf8670d3",
            "e3109b4987bd2052",
            "c670a8188dbde4ad",
            "d7af078f93c4d49c",
            "c1a73ca9f605592a",
            "27426ce1abe86bed"
        ],
        "x": 1234,
        "y": 1219,
        "w": 632,
        "h": 202
    },
    {
        "id": "ec0cef9248af421c",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Update UI: usable energy",
        "style": {
            "label": true,
            "stroke": "#3f5787"
        },
        "nodes": [
            "530c5b48e3a83384",
            "5879c49df831d7d1"
        ],
        "x": 1474,
        "y": 639,
        "w": 412,
        "h": 82
    },
    {
        "id": "b47380234c403509",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Update UI: active sub-strategy",
        "style": {
            "label": true,
            "stroke": "#3f5787"
        },
        "nodes": [
            "e1d8e3f34380666f",
            "3c49f1b6792b97f1",
            "4060a0352f8c87e8"
        ],
        "x": 1254,
        "y": 919,
        "w": 632,
        "h": 82
    },
    {
        "id": "e65f575b74b19bb9",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Insight",
        "style": {
            "label": true
        },
        "nodes": [
            "8c7901c2d594eb5e",
            "ebd3c5326f8b1c63",
            "82c713e12cd98ef6",
            "7a5be6f3ef637ac6",
            "f9911b0521ab8c28"
        ],
        "x": 34,
        "y": 119,
        "w": 892,
        "h": 82
    },
    {
        "id": "ad7a5414466d8f84",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Log and Error handling",
        "style": {
            "stroke": "#ff3f3f",
            "label": true
        },
        "nodes": [
            "08b7c4f99857f738",
            "05fd4084142a3320"
        ],
        "x": 1634,
        "y": 119,
        "w": 252,
        "h": 142
    },
    {
        "id": "e5a8857331dda097",
        "type": "group",
        "z": "896149ae00e704f5",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "a916d5b455768326",
            "f8b7d295f0527b7d",
            "de078f117cac0b2c"
        ],
        "x": 1704,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "27e1bb709915ab2a",
        "type": "group",
        "z": "896149ae00e704f5",
        "g": "445db1a1b028a1a0",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "5f2098d81a0f6b6a",
            "769824851b93376e",
            "bed6e6ec4422acde",
            "03c4db8b07c370ae",
            "1ca6023265a69afe",
            "281ada86746816fe",
            "ed931af38522e368",
            "d59bf530cfa1a51a",
            "e6794aecfb35f261",
            "d5f43067dec64c67"
        ],
        "x": 54,
        "y": 459,
        "w": 1612,
        "h": 82
    },
    {
        "id": "ae2072683883f2f4",
        "type": "group",
        "z": "896149ae00e704f5",
        "g": "cd62a51934a7605b",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "da243ed334e99ad3",
            "c4a63c0537e7c0e5",
            "fa28ffac21177015",
            "586a1dd49b14da1c",
            "3bafdd1450fb5518",
            "56bbcfd3fa50aaff",
            "1580c7cf092044db"
        ],
        "x": 314,
        "y": 1059,
        "w": 552,
        "h": 222
    },
    {
        "id": "1af4d6d4a4760a8f",
        "type": "junction",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "x": 1490,
        "y": 260,
        "wires": [
            [
                "fbe734165a41f66d"
            ]
        ]
    },
    {
        "id": "b345941d67039862",
        "type": "junction",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "x": 640,
        "y": 340,
        "wires": [
            [
                "a2c606034d1f2eaa"
            ]
        ]
    },
    {
        "id": "7562b977cfd31aa3",
        "type": "junction",
        "z": "e184a39d1337c413",
        "g": "286f10603840ceb3",
        "x": 460,
        "y": 100,
        "wires": [
            [
                "77234f588c6afaf4"
            ]
        ]
    },
    {
        "id": "77234f588c6afaf4",
        "type": "junction",
        "z": "e184a39d1337c413",
        "g": "286f10603840ceb3",
        "x": 700,
        "y": 100,
        "wires": [
            [
                "cfe162e53efce392",
                "d6aab6f107b83c3b"
            ]
        ]
    },
    {
        "id": "d6aab6f107b83c3b",
        "type": "junction",
        "z": "e184a39d1337c413",
        "g": "286f10603840ceb3",
        "x": 720,
        "y": 120,
        "wires": [
            [
                "16cd178b1d21594b"
            ]
        ]
    },
    {
        "id": "15421437c9729318",
        "type": "junction",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "x": 1440,
        "y": 260,
        "wires": [
            [
                "5ebb90ca750f527c"
            ]
        ]
    },
    {
        "id": "60c49814c3c8fa48",
        "type": "junction",
        "z": "896149ae00e704f5",
        "x": 40,
        "y": 360,
        "wires": [
            [
                "4bce51f320bad9d4"
            ]
        ]
    },
    {
        "id": "176d29a.6f648d6",
        "type": "server",
        "name": "Home Assistant",
        "addon": true,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "",
        "connectionDelay": false,
        "cacheJson": false,
        "heartbeat": false,
        "heartbeatInterval": "",
        "statusSeparator": "",
        "enableGlobalContextStore": false
    },
    {
        "id": "09bd7478158a6b53",
        "type": "server-state-changed",
        "z": "896149ae00e704f5",
        "g": "6e2bceef3c55744c",
        "name": "P1 meter",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.p1_meter_power"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": false,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "grid_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "timestamp",
                "propertyType": "msg",
                "value": "",
                "valueType": "date"
            }
        ],
        "x": 120,
        "y": 60,
        "wires": [
            [
                "3ad6f661a3eabe02"
            ]
        ]
    },
    {
        "id": "3ad6f661a3eabe02",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "6e2bceef3c55744c",
        "name": "Master Control Mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.marstek_master_battery_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "master_mode",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 300,
        "y": 60,
        "wires": [
            [
                "abe78e166b6a1c3d"
            ]
        ]
    },
    {
        "id": "abe78e166b6a1c3d",
        "type": "switch",
        "z": "896149ae00e704f5",
        "g": "6e2bceef3c55744c",
        "name": "when in \"Full Control\" mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 540,
        "y": 60,
        "wires": [
            [
                "8c7901c2d594eb5e"
            ]
        ]
    },
    {
        "id": "e100f79d5077b5fc",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "ce64d528f7526b9b",
        "name": "Battery Strategy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy",
                "propertyType": "flow",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 140,
        "y": 880,
        "wires": [
            [
                "3d973e1ecf1692b9"
            ]
        ]
    },
    {
        "id": "4747baf7d3ad444c",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "ce64d528f7526b9b",
        "name": "Strategy selection",
        "func": "// Logger\nconst logger = global.get(\"logger\");\n\n// INFLOW\nlet strategy = flow.get(\"house_battery_strategy\");\n\n// Configure msg.strategy object\nRED.util.setMessageProperty(msg,\"strategy.selected\",strategy,true);\nRED.util.setMessageProperty(msg,\"strategy.trace\",[],true);\n\n// stop on error\nif(msg.batteries === undefined) {\n    logger(this, \"Battery configuration undefined\", \"error\");\n    return null;\n}\nif(strategy === undefined) {\n    logger(this, \"Battery strategy undefined\", \"error\");\n    return null;\n}\n\n// select target flow based on the input_select `house_battery_strategy`\nmsg.target = `${strategy}`;\n\n// full stop trigger overrules ALL selected strategies\nconst stopTrigger = RED.util.getMessageProperty(msg,\"full_stop_trigger\");\nif(stopTrigger == \"on\" || stopTrigger === true || stopTrigger === 1) {\n    msg.target = 'Full stop';\n    // Explain\n    logger(this, `**Full Stop** strategy selected, due to (EV) stop trigger: '${stopTrigger}'`);\n}\n\n// add execution marker\nRED.util.setMessageProperty(msg,\"strategy.execution_start\",Date.now()); // when do we start executing the selected strategy\n\n// OUTPUT\nnode.status({fill:\"grey\",shape:\"dot\",text:msg.target});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 880,
        "wires": [
            [
                "c447589601c38de6",
                "63302d6ac092c4fe"
            ]
        ]
    },
    {
        "id": "63302d6ac092c4fe",
        "type": "link call",
        "z": "896149ae00e704f5",
        "g": "ce64d528f7526b9b",
        "name": "Call \"Link in\" node",
        "links": [],
        "linkType": "dynamic",
        "timeout": "1.2",
        "x": 410,
        "y": 920,
        "wires": [
            [
                "d9f1ad7875f692c0",
                "2e46954ae78682d5"
            ]
        ]
    },
    {
        "id": "c447589601c38de6",
        "type": "debug",
        "z": "896149ae00e704f5",
        "g": "ce64d528f7526b9b",
        "name": "Input msg",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 680,
        "y": 880,
        "wires": []
    },
    {
        "id": "d9f1ad7875f692c0",
        "type": "debug",
        "z": "896149ae00e704f5",
        "g": "ce64d528f7526b9b",
        "name": "Returned msg",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 920,
        "wires": []
    },
    {
        "id": "2e46954ae78682d5",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "ce64d528f7526b9b",
        "name": "Strategy evaluation",
        "func": "// add execution marker\nlet execution_end = Date.now();\nRED.util.setMessageProperty(msg, \"strategy.execution_end\", execution_end);\n\n// retrieve execution markers\nlet execution_start = RED.util.getMessageProperty(msg,\"strategy.execution_start\");\n\n// report execution time\nif (execution_start !== undefined && execution_end !== undefined) {\n    // exec time\n    let execution_time = (execution_end - execution_start) / 1000; // seconds\n    // report\n    if (execution_time <= 0) node.status({ fill: \"red\", shape: \"dot\", text: `negative or zero timing` });\n    if (execution_time > 0) node.status({ fill: \"green\", shape: \"dot\", text: `${execution_time} sec`});\n    if (execution_time >= 0.7) node.status({ fill: \"yellow\", shape: \"dot\", text: `${execution_time} sec` });\n    if (execution_time >= 1) node.status({ fill: \"red\", shape: \"dot\", text: `${execution_time} sec` });\n\n} else {\n    node.status({fill:\"grey\",shape:\"dot\",text:\"timing error\"});\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 960,
        "wires": [
            [
                "948a8a72d3709fd7",
                "b01af54fc746ef65",
                "e1d8e3f34380666f"
            ]
        ]
    },
    {
        "id": "6286249ec1d54825",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "445db1a1b028a1a0",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// Init an array for battery status and value information\nmsg.batteries = [];\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 420,
        "wires": [
            [
                "5f2098d81a0f6b6a"
            ]
        ]
    },
    {
        "id": "5da7fd57a8978766",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "445db1a1b028a1a0",
        "name": "Mapping",
        "func": "// Map to batteries array\nmsg.batteries.push({\n    id: `M${msg.battery_index}`,\n    power: parseInt(msg.battery_power,10),\n    charging_max: parseInt(msg.max_charge_power,10),\n    discharging_max: parseInt(msg.max_discharge_power,10),\n    soc: parseInt(msg.battery_state_of_charge,10),\n    soc_max: parseInt(msg.charging_cutoff_capacity,10),\n    soc_min: parseInt(msg.discharging_cutoff_capacity,10),\n    inverter: String(msg.inverter_state),\n    energy: Number(msg.battery_remaining_capacity),\n    energy_max: Number(msg.battery_total_energy),\n    rs485: String(msg.rs485_control_mode)\n    });\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 580,
        "wires": [
            [
                "43327471855bf648"
            ]
        ]
    },
    {
        "id": "298a8422f93e8a66",
        "type": "switch",
        "z": "896149ae00e704f5",
        "g": "445db1a1b028a1a0",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 420,
        "y": 580,
        "wires": [
            [
                "5f2098d81a0f6b6a"
            ],
            [
                "f2792a73e109c2b4"
            ]
        ]
    },
    {
        "id": "fd4e39841be12338",
        "type": "debug",
        "z": "896149ae00e704f5",
        "g": "445db1a1b028a1a0",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 770,
        "y": 580,
        "wires": []
    },
    {
        "id": "4bce51f320bad9d4",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "445db1a1b028a1a0",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 420,
        "wires": [
            [
                "6286249ec1d54825"
            ]
        ]
    },
    {
        "id": "5f2098d81a0f6b6a",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "27e1bb709915ab2a",
        "name": "Control mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "select.marstek_m{{battery_index}}_rs485_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "rs485_control_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 160,
        "y": 500,
        "wires": [
            [
                "ed931af38522e368"
            ]
        ]
    },
    {
        "id": "769824851b93376e",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "27e1bb709915ab2a",
        "name": "SoC",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_state_of_charge",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_state_of_charge",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 850,
        "y": 500,
        "wires": [
            [
                "e6794aecfb35f261"
            ]
        ]
    },
    {
        "id": "bed6e6ec4422acde",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "27e1bb709915ab2a",
        "name": "Inverter state",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_inverter_state",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "inverter_state",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1270,
        "y": 500,
        "wires": [
            [
                "1ca6023265a69afe"
            ]
        ]
    },
    {
        "id": "03c4db8b07c370ae",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "27e1bb709915ab2a",
        "name": "Max discharge power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_discharge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_discharge_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 680,
        "y": 500,
        "wires": [
            [
                "769824851b93376e"
            ]
        ]
    },
    {
        "id": "1ca6023265a69afe",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "27e1bb709915ab2a",
        "name": "Energy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_remaining_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_remaining_capacity",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1420,
        "y": 500,
        "wires": [
            [
                "d59bf530cfa1a51a"
            ]
        ]
    },
    {
        "id": "281ada86746816fe",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "27e1bb709915ab2a",
        "name": "Max charge power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_charge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_charge_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 470,
        "y": 500,
        "wires": [
            [
                "03c4db8b07c370ae"
            ]
        ]
    },
    {
        "id": "ed931af38522e368",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "27e1bb709915ab2a",
        "name": "Power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_power",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "battery_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 310,
        "y": 500,
        "wires": [
            [
                "281ada86746816fe"
            ]
        ]
    },
    {
        "id": "17774e0c7ab34f0a",
        "type": "api-call-service",
        "z": "896149ae00e704f5",
        "g": "7e6c83082c98a4e1",
        "name": "Node-RED status: OK",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.house_battery_control_has_node_red"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_boolean",
        "service": "turn_on",
        "x": 1760,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "9d164c5a2415585b",
        "type": "inject",
        "z": "896149ae00e704f5",
        "g": "7e6c83082c98a4e1",
        "name": "On deploy",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.1",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1410,
        "y": 60,
        "wires": [
            [
                "ee3da4a66658939b",
                "08b7c4f99857f738"
            ]
        ]
    },
    {
        "id": "da243ed334e99ad3",
        "type": "api-call-service",
        "z": "896149ae00e704f5",
        "g": "ae2072683883f2f4",
        "name": "Set mode (charge/discharge/stop)",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 660,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "c4a63c0537e7c0e5",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "ae2072683883f2f4",
        "name": "Set Batteries",
        "func": "// Logger\nconst log = global.get(\"logger\");\n\n// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n// Output format and target\nlet outputArray = [];\nlet solution = msg.solutions[msg.battery_index-1]; // Base-0, thus -1\nif (solution === undefined) {\n    log(this,`Can't find solution for index ${msg.battery_index - 1} in ${msg.solutions}, aborting...`,\"error\");\n    return null;\n}\nlet target = `marstek_${solution.id.toLowerCase()}`;\n\n// Safety | Id exists\nlet battery = msg.batteries.find(battery => battery.id === solution.id);\nif (battery === undefined) {\n    log(`Can't set battery ${solution.id}, aborting...`,\"error\");\n    return null;\n}\n// Safety | Power limit\nsolution.power = Math.min(solution.power, solution.mode == CMODE.CHARGE ? battery.charging_max: battery.discharging_max);\n\n// Set | Mode\nconst serviceCallMode = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_forcible_charge_discharge`]\n    },\n    \"data\": {\n         \"option\": String(solution.mode) // forced charge mode (stop, charge, discharge)\n    }\n};\n// Add topic to allow correct 'on change' filtering\noutputArray.push({payload: serviceCallMode, topic:solution.id});\n\n// Set | Power\nconst serviceCallPower = {\n    \"action\": \"number.set_value\",\n    \"target\": {\n        \"entity_id\": [\n            `number.${target}_forcible_charge_power`,\n            `number.${target}_forcible_discharge_power`\n            ]\n    },\n    \"data\": {\n        \"value\": Number(solution.power)\n    } \n};\n// Add topic to allow correct 'on change' filtering\noutputArray.push({payload: serviceCallPower, topic:solution.id});\n\n// Store service calls in msg to allow checking of loop results\nmsg.loop_result = { target, serviceCallMode, serviceCallPower };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Explain\nlog(this,`${target} ${String(solution.mode)} @ ${Number(solution.power)} Watt`);\n\n// Output\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 1140,
        "wires": [
            [
                "da243ed334e99ad3"
            ],
            [
                "1580c7cf092044db"
            ],
            [
                "586a1dd49b14da1c"
            ]
        ],
        "inputLabels": [
            "Msg with a battery_index"
        ],
        "outputLabels": [
            "Select MODE",
            "Set POWER",
            "Msg"
        ]
    },
    {
        "id": "b8d48491051b2f25",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "cd62a51934a7605b",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = msg.battery_count;\n\n// Debug\nRED.util.setMessageProperty(msg, \"debug\", `## Cohort ${Date.now()} ##`);\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 1140,
        "wires": [
            [
                "c4a63c0537e7c0e5"
            ]
        ]
    },
    {
        "id": "fa28ffac21177015",
        "type": "switch",
        "z": "896149ae00e704f5",
        "g": "ae2072683883f2f4",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 740,
        "y": 1200,
        "wires": [
            [
                "c4a63c0537e7c0e5"
            ],
            [
                "85bec23e6485f663"
            ]
        ]
    },
    {
        "id": "586a1dd49b14da1c",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "ae2072683883f2f4",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index -= 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 1200,
        "wires": [
            [
                "fa28ffac21177015",
                "56bbcfd3fa50aaff"
            ]
        ]
    },
    {
        "id": "3bafdd1450fb5518",
        "type": "api-call-service",
        "z": "896149ae00e704f5",
        "g": "ae2072683883f2f4",
        "name": "Set power (W)",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 760,
        "y": 1140,
        "wires": [
            []
        ]
    },
    {
        "id": "d7067c3a4df79c31",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "cd62a51934a7605b",
        "name": "Timing start",
        "func": "RED.util.setMessageProperty(msg,\"setbatteries.execution_start\",Date.now());\nRED.util.setMessageProperty(msg,\"setbatteries.marker\", `M1_${Date.now()}`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 1100,
        "wires": [
            [
                "b8d48491051b2f25"
            ]
        ]
    },
    {
        "id": "948a8a72d3709fd7",
        "type": "switch",
        "z": "896149ae00e704f5",
        "g": "cd62a51934a7605b",
        "name": "solutions present",
        "property": "solutions",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "undefined",
                "vt": "jsonata"
            },
            {
                "t": "neq",
                "v": "undefined",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 150,
        "y": 1060,
        "wires": [
            [
                "67760d289c0fadf0"
            ],
            [
                "d7067c3a4df79c31"
            ]
        ]
    },
    {
        "id": "85bec23e6485f663",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "cd62a51934a7605b",
        "name": "Timing end",
        "func": "let start = RED.util.getMessageProperty(msg,\"setbatteries.execution_start\");\nlet end = Date.now();\nlet delta = end - start;\nlet timingString = `${delta/1000} sec`;\n\nnode.status({fill:\"green\",shape:\"dot\",text: timingString});\nmsg.delta = delta;\nmsg.timing = timingString;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 1320,
        "wires": [
            [
                "6fe2716ba561c0e0",
                "e3109b4987bd2052"
            ]
        ]
    },
    {
        "id": "56bbcfd3fa50aaff",
        "type": "debug",
        "z": "896149ae00e704f5",
        "g": "ae2072683883f2f4",
        "name": "Step result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 750,
        "y": 1240,
        "wires": []
    },
    {
        "id": "1580c7cf092044db",
        "type": "rbe",
        "z": "896149ae00e704f5",
        "g": "ae2072683883f2f4",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 590,
        "y": 1140,
        "wires": [
            [
                "3bafdd1450fb5518"
            ]
        ]
    },
    {
        "id": "6fe2716ba561c0e0",
        "type": "debug",
        "z": "896149ae00e704f5",
        "g": "cd62a51934a7605b",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "debug",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 270,
        "y": 1320,
        "wires": []
    },
    {
        "id": "43327471855bf648",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "445db1a1b028a1a0",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 580,
        "wires": [
            [
                "298a8422f93e8a66"
            ]
        ]
    },
    {
        "id": "442790db0683aa3d",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "7a4b0f08af941aea",
        "name": "Update battery order",
        "func": "// Cycles battery priority as follows\n// M=1 [1,2,3,4] | M=2 [2,3,4,1] | M=3 [3,4,1,2] | etc.\n// With M the battery to prioritize\n\n// msg.batteries (original order)\nlet currentArray = msg.batteries;\n\n// Prioritize the Mth battery\nconst M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// 1st battery has prio? Skip and continue without change\nif (M==1) return msg;\n\n// N equals the number of items to take from the front to the back of the array, effectivly rotating battery priority\nconst N = M - 1; // base-0 version of M\nnode.status({fill:\"blue\",shape:\"ring\",text:`N = ${N}`});\n\n// 1. Check if the array is valid and long enough\nif (!Array.isArray(currentArray) || currentArray.length < N) {\n    // Send an error or the original array back if the array is invalid/too short\n    node.error(`Array is not valid or shorter than ${N} items.`, msg);\n    return null;\n}\n\n// 2. Get the first N items (these will go to the back)\n// slice(0, N) retrieves elements from the start (index 0) up to index N (exclusive).\nlet firstN = currentArray.slice(0, N);\n\n// 3. Get the remaining items (these will stay at the front)\n// slice(N) retrieves elements from index N to the end of the array.\nlet remaining = currentArray.slice(N);\n\n// 4. Concatenate them: remaining items (front) + first N items (back)\nlet newArray = remaining.concat(firstN);\n\n// 5. Place the new array back into msg.batteries\nmsg.batteries = newArray;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 780,
        "wires": [
            [
                "e100f79d5077b5fc"
            ]
        ]
    },
    {
        "id": "6d50e040c9febf3b",
        "type": "inject",
        "z": "896149ae00e704f5",
        "g": "7a4b0f08af941aea",
        "name": "Every day 02:00",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 02 * * *",
        "once": false,
        "onceDelay": "5",
        "topic": "cycle_battery_priority",
        "payload": "",
        "payloadType": "date",
        "x": 610,
        "y": 780,
        "wires": [
            [
                "ca90eaf94fb051a4"
            ]
        ]
    },
    {
        "id": "8af4f52d3b3c3106",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "7a4b0f08af941aea",
        "name": "Change priority",
        "func": "// Current prioritized battery is the Mth battery\nlet M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// Prioritize the next battery\nM += 1;\n\n// If the next battery does not exist, prioritize the first again\nif(M > msg.battery_count) M = 1;\n\n// Pass along as payload\nmsg.payload = M;\n\n// Show which battery has priority\nnode.status({fill:\"green\",shape:\"dot\",text:`Prioritize battery #${M}`});\n\n// Done\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1540,
        "y": 780,
        "wires": [
            [
                "4b732cb3bb1b3b19"
            ]
        ]
    },
    {
        "id": "3de01c4d2d7d1e60",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "7a4b0f08af941aea",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1350,
        "y": 780,
        "wires": [
            [
                "8af4f52d3b3c3106"
            ]
        ]
    },
    {
        "id": "3f78c6a777f70e0b",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "7a4b0f08af941aea",
        "name": "Prioritize battery M",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_prioritize_battery",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "prioritize_battery",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 780,
        "wires": [
            [
                "442790db0683aa3d"
            ]
        ]
    },
    {
        "id": "4b732cb3bb1b3b19",
        "type": "api-call-service",
        "z": "896149ae00e704f5",
        "g": "7a4b0f08af941aea",
        "name": "Update prioritized battery",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_prioritize_battery"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1750,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "ca90eaf94fb051a4",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "7a4b0f08af941aea",
        "name": "Desired interval",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_control_priority_change_interval",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 780,
        "wires": [
            [
                "69f668331f3cfb7b"
            ]
        ]
    },
    {
        "id": "69f668331f3cfb7b",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "7a4b0f08af941aea",
        "name": "Check interval ",
        "func": "// Manual priority, never pass\nif(msg.payload == \"Never\") {\n    node.status({fill:\"yellow\",shape:\"dot\",text:\"Auto cycle disabled\"});\n    return null;\n}\n\n// Daily interval, always pass\nif(msg.payload == \"Daily\") {\n    node.status({ fill: \"green\", shape: \"dot\", text: `Pass` });\n    return msg;\n}\n\n// Weekly interval\nconst today = new Date();\n// Get the day of the week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)\nconst dayOfWeek = today.getDay();\n\n// Check if the day is Sunday (which is represented by the number 0)\nif (dayOfWeek === 0) {\n    // If it is Sunday, pass\n    node.status({ fill: \"green\", shape: \"dot\", text: `Passed on Sunday` });\n    return msg;\n} else {\n    // If it is not Sunday, stop\n    node.status({ fill: \"yellow\", shape: \"dot\", text: `Halted, not Sunday` });\n    return null;\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 780,
        "wires": [
            [
                "e83878df31ca0eae"
            ]
        ]
    },
    {
        "id": "e83878df31ca0eae",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "7a4b0f08af941aea",
        "name": "Current priority",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_prioritize_battery",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "prioritize_battery",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1160,
        "y": 780,
        "wires": [
            [
                "3de01c4d2d7d1e60"
            ]
        ]
    },
    {
        "id": "0fd88dec02bd82f4",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "ea6cc613bfe841bb",
        "name": "Batteries (totals)",
        "func": "// batteries | calculate total and max. power delivered by batteries\nlet batteries = msg.batteries;\nlet batteries_total_power = 0;\nlet batteries_max_charging_power = 0;\nlet batteries_max_discharging_power = 0;\nlet batteries_available_energy = 0;\nlet batteries_max_energy = 0;\n\nbatteries.forEach(battery => {\n    batteries_total_power += Number(battery.power);\n    batteries_max_charging_power += Number(battery.charging_max);\n    batteries_max_discharging_power += Number(battery.discharging_max);\n    batteries_available_energy += Number(battery.energy - battery.energy_max*battery.soc_min/100);\n    batteries_max_energy += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_total_power\", batteries_total_power, true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_charge_power\", batteries_max_charging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_discharge_power\", batteries_max_discharging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_available_energy\",batteries_available_energy,true); // kWh usable\nRED.util.setMessageProperty(msg, \"batteries_max_energy\", batteries_max_energy, true); // kWh usable\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 680,
        "wires": [
            [
                "3f78c6a777f70e0b",
                "5879c49df831d7d1"
            ]
        ],
        "inputLabels": [
            "Mapping (from Home Battery IO)"
        ]
    },
    {
        "id": "d59bf530cfa1a51a",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "27e1bb709915ab2a",
        "name": "Energy max",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_total_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_total_energy",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1570,
        "y": 500,
        "wires": [
            [
                "5da7fd57a8978766"
            ]
        ]
    },
    {
        "id": "f2792a73e109c2b4",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "445db1a1b028a1a0",
        "name": "Loop end",
        "func": "// cleanup \ndelete msg.battery_index;\n\ndelete msg.battery_power;\ndelete msg.max_charge_power;\ndelete msg.max_discharge_power;\ndelete msg.battery_state_of_charge;\ndelete msg.charging_cutoff_capacity;\ndelete msg.discharging_cutoff_capacity;\ndelete msg.inverter_state;\ndelete msg.battery_remaining_capacity;\ndelete msg.battery_total_energy;\ndelete msg.rs485_control_mode;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 580,
        "wires": [
            [
                "fd4e39841be12338",
                "0fd88dec02bd82f4"
            ]
        ]
    },
    {
        "id": "530c5b48e3a83384",
        "type": "api-call-service",
        "z": "896149ae00e704f5",
        "g": "ec0cef9248af421c",
        "name": "Set total usable energy",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_total_available_energy"
        ],
        "labelId": [],
        "data": "{\"value\":$$.batteries_available_energy}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1760,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "3d973e1ecf1692b9",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "ce64d528f7526b9b",
        "name": "Full Stop Trigger",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.ev_is_charging",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "full_stop_trigger",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 140,
        "y": 940,
        "wires": [
            [
                "4747baf7d3ad444c"
            ]
        ]
    },
    {
        "id": "5879c49df831d7d1",
        "type": "rbe",
        "z": "896149ae00e704f5",
        "g": "ec0cef9248af421c",
        "name": "On change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "batteries_available_energy",
        "topi": "topic",
        "x": 1570,
        "y": 680,
        "wires": [
            [
                "530c5b48e3a83384"
            ]
        ]
    },
    {
        "id": "6127089a6b09fc20",
        "type": "switch",
        "z": "896149ae00e704f5",
        "g": "87e06966531158e0",
        "name": "Select rate limit",
        "property": "p1_rate_limit.save_power",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 660,
        "y": 280,
        "wires": [
            [
                "7fd87ced33d65773"
            ],
            [
                "da12b683f16c6c90"
            ]
        ]
    },
    {
        "id": "19baa8a0ae6ff146",
        "type": "delay",
        "z": "896149ae00e704f5",
        "g": "87e06966531158e0",
        "name": "Rate limit",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": true,
        "outputs": 2,
        "x": 980,
        "y": 280,
        "wires": [
            [
                "6a0d3b0a69e079f2"
            ],
            [
                "8d3983a18d0672b1"
            ]
        ],
        "outputLabels": [
            "Pass",
            ""
        ]
    },
    {
        "id": "da12b683f16c6c90",
        "type": "change",
        "z": "896149ae00e704f5",
        "g": "87e06966531158e0",
        "name": "1 msg/s",
        "rules": [
            {
                "t": "set",
                "p": "rate",
                "pt": "msg",
                "to": "1000",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 300,
        "wires": [
            [
                "19baa8a0ae6ff146"
            ]
        ]
    },
    {
        "id": "7fd87ced33d65773",
        "type": "change",
        "z": "896149ae00e704f5",
        "g": "87e06966531158e0",
        "name": "0.333 msg/s",
        "rules": [
            {
                "t": "set",
                "p": "rate",
                "pt": "msg",
                "to": "3000",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 830,
        "y": 260,
        "wires": [
            [
                "19baa8a0ae6ff146"
            ]
        ]
    },
    {
        "id": "7830bf5117267666",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "87e06966531158e0",
        "name": "P1 change (20W or 2%)",
        "func": "// Switch between low and high rate limiting to decrease load and power consumption\n// --\n// The flow should always be rate limited by atleast the total execution time of strategies\n// The flow should not lock up indefinitly when grid_power is constant.\n// In the latter case, a more relaxed rate limit can help reduce system load.\n// Devs: don't set msg.rate directly. Use nodes, so novice users can easily read the flow.\n\n// Thresholds for change in power, before switching to high rate limit\nconst THRESHOLD_POWER = 20; // Watt change\nconst THRESHOLD_PERCENT = 2; // Percentage\nRED.util.setMessageProperty(msg, \"p1_rate_limit.threshold_power\", THRESHOLD_POWER,true);\nRED.util.setMessageProperty(msg, \"p1_rate_limit.threshold_percent\", THRESHOLD_PERCENT, true);\n\n// Get the previous value from this node's context\n// If it doesn't exist yet, initialize it as null\nlet previousValue = context.get('previousValue') || null;\nlet currentValue = Number(msg.grid_power);\n\n// Save the current value for the next time the node is triggered\ncontext.set('previousValue', currentValue);\n\n// Default rate limiting\nRED.util.setMessageProperty(msg,\"p1_rate_limit.save_power\",true);\n\n// Check if we have a valid history to compare with\nif (previousValue !== null) {\n    let powerChange = Math.abs(currentValue - previousValue);\n    let percentageChange = previousValue !== 0 ? Math.abs((powerChange / previousValue) * 100):0;\n\n    // Condition: Absolute difference > N Watt AND percentage change > M %\n    if (powerChange > THRESHOLD_POWER && percentageChange > THRESHOLD_PERCENT) {\n        // Enable faster refresh rate\n        RED.util.setMessageProperty(msg,\"p1_rate_limit.save_power\",false);\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 280,
        "wires": [
            [
                "6127089a6b09fc20"
            ]
        ]
    },
    {
        "id": "117056516f4acad3",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "87e06966531158e0",
        "name": "CPU power saved",
        "func": "// Logger\nconst logger = global.get(\"logger\");\n\n// Passed or blocked\nconst hasPassed = msg.payload; // 0 = blocked, 1 = passed\n\n// 1. Get evaluations (Total attempts)\nlet evaluations = (context.get(\"p1_rate_limit_evaluations\") || 0) + 1;\ncontext.set(\"p1_rate_limit_evaluations\", evaluations);\n\n// 2. Increment and get passes (Filtered/successful events)\nlet passes = (context.get(\"p1_rate_limit_passes\") || 0) + hasPassed;\ncontext.set(\"p1_rate_limit_passes\", passes);\n\n// 3a. Calculate percentage (Rate of passing vs total evaluations)\nlet percentage = evaluations > 0 ? (passes / evaluations) * 100 : 0;\n// 3b. Display the percentage rate of not-passing as a measure of efficiency gained\npercentage = 100 - percentage;\n\n// 4. Update Node Status\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `Saved: ${percentage.toFixed(2)}% (${evaluations-passes}/${evaluations})`\n});\n\n// 5. Explain\n// On block\nif(hasPassed === 0) {\n    if(msg.p1_rate_limit.save_power === true) {\n        // This is good\n        logger(this, `<font color=\"#009ac7\">Power saved</font> by P1 Rate Limiter, execution stopped.`); \n    } else {\n        // This is not so good. P1 updates are coming in fast.\n        logger(this, `<font color=\"orange\">Blocked</font> by P1 Rate Limiter. ${Number(1000/msg.rate).toFixed(2)} messages per second exceeded.`); \n    }\n    \n    // Send message onward to debug dashboard\n    return msg;\n}\n// No output on pass\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1270,
        "y": 280,
        "wires": [
            [
                "74231ab0ac8a9bf3"
            ]
        ]
    },
    {
        "id": "b01af54fc746ef65",
        "type": "debug",
        "z": "896149ae00e704f5",
        "g": "ce64d528f7526b9b",
        "name": "Strategy evaluation",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 960,
        "wires": []
    },
    {
        "id": "3c49f1b6792b97f1",
        "type": "api-call-service",
        "z": "896149ae00e704f5",
        "g": "b47380234c403509",
        "name": "Show on dashboard",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_text.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_text.house_battery_strategy_active_sub_strategy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.ui_value_new}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_text",
        "service": "set_value",
        "x": 1760,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "e1d8e3f34380666f",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "b47380234c403509",
        "name": "current UI value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.house_battery_strategy_active_sub_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "ui_value_current",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1360,
        "y": 960,
        "wires": [
            [
                "4060a0352f8c87e8"
            ]
        ]
    },
    {
        "id": "4060a0352f8c87e8",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "b47380234c403509",
        "name": "on new UI value",
        "func": "// Block when undefined (don't update UI)\nif(msg.ui_value_current === undefined) return null;\n\n// We show the 2nd strategy in the trace (if available) on the dashboard as the 'active sub-strategy'\nconst secondTraceEntry = msg.strategy?.trace?.[1];\nif (secondTraceEntry) {\n    // Handle case where 2nd flow is present\n    msg.ui_value_new =  secondTraceEntry.flow;\n} else {\n    // Handle case where the 2nd flow is missing\n    // Get a sensible alternative\n    msg.ui_value_new = msg.strategy?.selected || \"\"; // don't use unknown or unavailable as these are reserved HA keywords\n}\n\n// Improve human readability\nif(msg.ui_value_new == \"Self-consumption\" && secondTraceEntry?.flow_settings?.discharge_disabled === true){\n    msg.ui_value_new = \"Self-consumption (charge only)\";\n}\nif(msg.ui_value_new == \"Self-consumption\" && secondTraceEntry?.flow_settings?.charge_disabled === true){\n    msg.ui_value_new = \"Self-consumption (no charging)\";\n}\n\n// Node status for devs\nnode.status({fill:\"grey\",shape:\"dot\",text:`new: ${msg.ui_value_new}`});\n\n// Block when equal (don't update UI)\nif(msg.ui_value_current === msg.ui_value_new) return null;\n\n// Pass otherwise\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1560,
        "y": 960,
        "wires": [
            [
                "3c49f1b6792b97f1"
            ]
        ]
    },
    {
        "id": "86c2fc69cf8670d3",
        "type": "ha-fire-event",
        "z": "896149ae00e704f5",
        "g": "f707a237741b883e",
        "name": "Show on debug board",
        "server": "176d29a.6f648d6",
        "version": 0,
        "event": "update_trace_sensor",
        "data": "{\t   \"trace\": strategy.trace ? strategy.trace : [],\t   \"start\": strategy.execution_start ? strategy.execution_start : 0,\t   \"end\": strategy.execution_end ? strategy.execution_end : 0,\t   \"log\": log ? log : []\t}",
        "dataType": "jsonata",
        "x": 1740,
        "y": 1320,
        "wires": [
            []
        ]
    },
    {
        "id": "8c7901c2d594eb5e",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "e65f575b74b19bb9",
        "name": "Debug mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_control_is_debug_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "debug_mode",
                "propertyType": "msg",
                "value": "ha_boolean",
                "valueType": "entityState"
            },
            {
                "property": "debug_mode",
                "propertyType": "global",
                "value": "ha_boolean",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 130,
        "y": 160,
        "wires": [
            [
                "ebd3c5326f8b1c63"
            ]
        ]
    },
    {
        "id": "e3109b4987bd2052",
        "type": "switch",
        "z": "896149ae00e704f5",
        "g": "f707a237741b883e",
        "name": "Debug mode?",
        "property": "debug_mode",
        "propertyType": "global",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1540,
        "y": 1320,
        "wires": [
            [
                "86c2fc69cf8670d3"
            ]
        ]
    },
    {
        "id": "82c713e12cd98ef6",
        "type": "server-state-changed",
        "z": "896149ae00e704f5",
        "g": "e65f575b74b19bb9",
        "name": "On debug",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 2,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_boolean.house_battery_control_is_debug_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "on",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 380,
        "y": 160,
        "wires": [
            [
                "7a5be6f3ef637ac6"
            ],
            []
        ]
    },
    {
        "id": "7a5be6f3ef637ac6",
        "type": "trigger",
        "z": "896149ae00e704f5",
        "g": "e65f575b74b19bb9",
        "name": "disable debug after 5 minutes",
        "op1": "",
        "op2": "off",
        "op1type": "nul",
        "op2type": "str",
        "duration": "5",
        "extend": false,
        "overrideDelay": false,
        "units": "min",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 590,
        "y": 160,
        "wires": [
            [
                "f9911b0521ab8c28"
            ]
        ]
    },
    {
        "id": "f9911b0521ab8c28",
        "type": "api-call-service",
        "z": "896149ae00e704f5",
        "g": "e65f575b74b19bb9",
        "name": "Turn debug OFF",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.house_battery_control_is_debug_mode"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_boolean",
        "service": "turn_off",
        "x": 820,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "ee3da4a66658939b",
        "type": "delay",
        "z": "896149ae00e704f5",
        "g": "7e6c83082c98a4e1",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1580,
        "y": 60,
        "wires": [
            [
                "17774e0c7ab34f0a"
            ]
        ]
    },
    {
        "id": "08b7c4f99857f738",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "ad7a5414466d8f84",
        "name": "Custom logger",
        "func": "/**\n * Custom Logger Function\n * * Provides centralized logging, node-status updates, and message tracing.\n * Specifically designed for Home Battery Control logic within Node-RED.\n * \n * Debug dashboard updating:\n * A msg needs to reach 'Strategy Evaluation' or be passed to the \"Show on debug board\" trigger node.\n * Errors are automatically passed to the \"Show on debug board\" trigger node.\n * \n * * @param {object} callingNode - The context of the calling node (pass 'this').\n * @param {string} text - The log message/explanation.\n * @param {string} level - Log level: 'log', 'warn', 'error', or 'info' (default: 'info').\n * \n * Note: anything above 'info' will also write to the Node-RED log files \n * \n * * @usage: \n * const log = global.get(\"logger\");\n * log(this, \"Charging cycle started\");\n */\nconst customLogger = (callingNode, text, level = 'info') => {\n    \n    // Log only when debug_mode is ON\n    const debug_mode = global.get(\"debug_mode\") || false;\n    if(debug_mode == false) return null;\n\n    // Max log elements to keep\n    const MAX_ELEMENTS = 100;\n\n    // Create the YYYY-MM-DD HH:MM:SS.mmm format\n    const now = new Date();\n    const timestamp = now.getHours().toString().padStart(2, '0') + \":\" +\n                now.getMinutes().toString().padStart(2, '0') + \":\" +\n                now.getSeconds().toString().padStart(2, '0') + \".\" +\n                now.getMilliseconds().toString().padStart(3, '0');\n\n    const formattedTimeLevel = `${timestamp} [${level.toLowerCase()}]`;\n    \n    // Get the name of the node or fallback to the ID\n    const nodeName = callingNode.__node__ ? callingNode.__node__.name || callingNode.__node__.id : undefined;\n    // Get the name of the Flow/Tab\n    const flowName = callingNode.env.get(\"NR_FLOW_NAME\") || \"Unknown flow\";\n    // Explain to the Home Battery Control user what is going on\n    const formattedExplenation = `[${flowName} >> ${nodeName}]: ${text}`;\n\n    // Level icons\n    let icon = \"\";\n    switch (level) {\n        case \"info\":\n            icon = \"\";\n            break;\n        case \"log\":\n            icon = \"\";\n            break;\n        case \"warn\":\n            icon = \"\";      \n            break;\n        case \"error\":\n            icon = \"\";\n            break;\n    }\n\n    // Enrich msg with log info\n    const msg = callingNode.msg;\n    (msg.log = msg.log || []).push({ timestamp: timestamp, level:level, flow:flowName, node:nodeName, payload: text, icon: icon});\n\n    if (msg.log.length > MAX_ELEMENTS) {\n        // Slice keeps the last X elements\n        msg.log = msg.log.slice(-MAX_ELEMENTS);\n    }\n\n    // Log to the Node-RED system log\n    switch (level) {\n        case \"log\":\n            node.log(`${formattedExplenation}`);\n            break;\n        case \"warn\":\n            node.warn(`${formattedExplenation}`);       \n            break;\n        case \"error\":\n            node.error(`${formattedExplenation}`, callingNode.msg);\n            break;\n        default:\n            // don't log to logfiles by default\n    }\n\n};\n\nglobal.set('logger', customLogger);\nglobal.set('unhandledException', \"\");\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1740,
        "y": 160,
        "wires": [
            [
                "05fd4084142a3320"
            ]
        ]
    },
    {
        "id": "6a0d3b0a69e079f2",
        "type": "change",
        "z": "896149ae00e704f5",
        "g": "87e06966531158e0",
        "name": "Pass",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "1",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1110,
        "y": 300,
        "wires": [
            [
                "117056516f4acad3",
                "60c49814c3c8fa48"
            ]
        ]
    },
    {
        "id": "8d3983a18d0672b1",
        "type": "change",
        "z": "896149ae00e704f5",
        "g": "87e06966531158e0",
        "name": "Block",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1110,
        "y": 260,
        "wires": [
            [
                "117056516f4acad3"
            ]
        ]
    },
    {
        "id": "c670a8188dbde4ad",
        "type": "link in",
        "z": "896149ae00e704f5",
        "g": "f707a237741b883e",
        "name": "Update debug dashboard",
        "links": [
            "74231ab0ac8a9bf3",
            "67760d289c0fadf0",
            "de078f117cac0b2c"
        ],
        "x": 1395,
        "y": 1260,
        "wires": [
            [
                "e3109b4987bd2052",
                "27426ce1abe86bed"
            ]
        ]
    },
    {
        "id": "74231ab0ac8a9bf3",
        "type": "link out",
        "z": "896149ae00e704f5",
        "g": "87e06966531158e0",
        "name": "goto Debug Dashboard update",
        "mode": "link",
        "links": [
            "c670a8188dbde4ad"
        ],
        "x": 1395,
        "y": 280,
        "wires": []
    },
    {
        "id": "d7af078f93c4d49c",
        "type": "catch",
        "z": "896149ae00e704f5",
        "g": "f707a237741b883e",
        "name": "Custom logger",
        "scope": [
            "08b7c4f99857f738"
        ],
        "uncaught": false,
        "x": 1340,
        "y": 1380,
        "wires": [
            [
                "e3109b4987bd2052",
                "c1a73ca9f605592a"
            ]
        ]
    },
    {
        "id": "c1a73ca9f605592a",
        "type": "debug",
        "z": "896149ae00e704f5",
        "g": "f707a237741b883e",
        "name": "Via Catch",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "counter",
        "x": 1520,
        "y": 1380,
        "wires": []
    },
    {
        "id": "27426ce1abe86bed",
        "type": "debug",
        "z": "896149ae00e704f5",
        "g": "f707a237741b883e",
        "name": "Via link",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "counter",
        "x": 1520,
        "y": 1260,
        "wires": []
    },
    {
        "id": "67760d289c0fadf0",
        "type": "link out",
        "z": "896149ae00e704f5",
        "g": "cd62a51934a7605b",
        "name": "link out 1",
        "mode": "link",
        "links": [
            "c670a8188dbde4ad"
        ],
        "x": 285,
        "y": 1060,
        "wires": []
    },
    {
        "id": "33f59e815c544c72",
        "type": "switch",
        "z": "896149ae00e704f5",
        "g": "87e06966531158e0",
        "name": "Skip rate limiter during debug",
        "property": "debug_mode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 180,
        "y": 280,
        "wires": [
            [
                "7830bf5117267666"
            ],
            [
                "60c49814c3c8fa48"
            ]
        ]
    },
    {
        "id": "ebd3c5326f8b1c63",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "e65f575b74b19bb9",
        "name": "Notice",
        "func": "// Explain when debugging\nif(msg.debug_mode == true){\n    const log = global.get(\"logger\");\n    log(this, \"P1 Rate limiter is *disabled* during *debug mode*\");\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 235,
        "y": 160,
        "wires": [
            [
                "33f59e815c544c72"
            ]
        ],
        "l": false
    },
    {
        "id": "e6794aecfb35f261",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "27e1bb709915ab2a",
        "name": "SoC min",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.marstek_m{{battery_index}}_discharging_cutoff_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "discharging_cutoff_capacity",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 980,
        "y": 500,
        "wires": [
            [
                "d5f43067dec64c67"
            ]
        ]
    },
    {
        "id": "d5f43067dec64c67",
        "type": "api-current-state",
        "z": "896149ae00e704f5",
        "g": "27e1bb709915ab2a",
        "name": "SoC max",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.marstek_m{{battery_index}}_charging_cutoff_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charging_cutoff_capacity",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1120,
        "y": 500,
        "wires": [
            [
                "bed6e6ec4422acde"
            ]
        ]
    },
    {
        "id": "05fd4084142a3320",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "ad7a5414466d8f84",
        "name": "Unhandled Exception",
        "func": "/**\n * Handles exceptions by extracting node details and routing them to a global logger.\n * This is designed to be called from within a Node-RED Function node or sub-flow.\n *\n * @param {Object} callingNode - The Node-RED 'this' context or msg object containing node metadata.\n * @param {Object} [callingNode.msg] - The message object associated with the error.\n * @param {Object} [callingNode.msg.error] - Error details provided by a Node-RED error catch.\n * @param {string} [callingNode.msg.error.message] - The specific error message.\n * @param {Object} [callingNode.msg.error.source] - The node that triggered the error.\n * * @example\n * // Usage in a Function Node:\n * const unhandledException = global.get('unhandledException');\n * unhandledException(this);\n */\nconst unhandledException = (callingNode) => {\n    // 1. Get the custom logger from global context\n    const log = global.get(\"logger\");\n\n    // 2. Extract error details from the msg object\n    const errorData = callingNode.msg?.error || {};\n    const errorMessage = errorData.message || \"Unknown error occurred\";\n    const sourceName = errorData.source ? (errorData.source.name || errorData.source.id) : \"Unknown Node\";\n    const sourceType = errorData.source ? errorData.source.type : \"unknown-type\";\n\n    // 3. Construct a user-friendly message for the logger\n    const friendlyMessage = `**Unhandled exception** (${sourceType} node) ${errorMessage}`;\n    callingNode.__node__ ??= {};\n    callingNode.__node__.name = sourceName;\n\n    // 4. Call the logger with level 'error'\n    // Note: the logger uses 'callingNode', we pass on whatever we have.\n    log(callingNode, friendlyMessage, 'error');\n\n};\n\nglobal.set('unhandledException', unhandledException);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1760,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "a916d5b455768326",
        "type": "catch",
        "z": "896149ae00e704f5",
        "g": "e5a8857331dda097",
        "name": "",
        "scope": null,
        "uncaught": true,
        "x": 1745,
        "y": 320,
        "wires": [
            [
                "f8b7d295f0527b7d"
            ]
        ],
        "l": false
    },
    {
        "id": "f8b7d295f0527b7d",
        "type": "function",
        "z": "896149ae00e704f5",
        "g": "e5a8857331dda097",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1795,
        "y": 320,
        "wires": [
            [
                "de078f117cac0b2c"
            ]
        ],
        "l": false
    },
    {
        "id": "de078f117cac0b2c",
        "type": "link out",
        "z": "896149ae00e704f5",
        "g": "e5a8857331dda097",
        "name": "link out 9",
        "mode": "link",
        "links": [
            "c670a8188dbde4ad"
        ],
        "x": 1845,
        "y": 320,
        "wires": []
    },
    {
        "id": "9445ea2e038dc4ff",
        "type": "api-current-state",
        "z": "71116bfb3e38272c",
        "g": "3976d86aa766d5a3",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 60,
        "wires": [
            [
                "4d1c080186bf44c1"
            ]
        ]
    },
    {
        "id": "3721d34b6a06e92e",
        "type": "function",
        "z": "71116bfb3e38272c",
        "g": "034635b1ad500f69",
        "name": "Set RS485 and Work Modes",
        "func": "// array for output \nlet outputArray = [];\n\n// battery to target\nconst target = `marstek_m${msg.battery_index}`;\n\n// Set | work mode\nconst workModeAction = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_user_work_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.work_mode)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.work_mode ? { payload: workModeAction, topic:\"user_work_mode\"}: null);\n\n// Set | rs485\nconst rs485Action = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_rs485_control_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.rs485)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.rs485 ? { payload: rs485Action, topic: \"rs485_control_mode\" } : null);\n\n// Store calls in msg to allow checking of loop results\nmsg.loop_result = { target, workModeAction, rs485Action };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Outputs\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 180,
        "wires": [
            [
                "c459bdbef50be840"
            ],
            [
                "6941c0d003d9dfc4"
            ],
            [
                "e99d7127740fa14c"
            ]
        ]
    },
    {
        "id": "4d1c080186bf44c1",
        "type": "function",
        "z": "71116bfb3e38272c",
        "g": "3976d86aa766d5a3",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// configurables\nlet workMode = null; // manual, anti-feed, ai, null = don't set or alter this setting\nlet rs485 = null;  // enable, disable, null = don't set or alter this setting\n\n// mode select\nswitch (msg.marstek_master_battery_mode) {\n    case \"Manual control\":\n        workMode = \"manual\";\n        rs485 = \"disable\";\n        break;\n    case \"Marstek control\":\n        // the user should select a work mode via the Marstek App or via select.marstek_mX_user_work_mode\n        rs485 = \"disable\";\n        break;\n    case \"Full control\":\n        rs485 = \"enable\";\n        break;\n    default:\n        node.status({fill:\"red\",shape:\"ring\",text:`Unhandled mode: ${msg.marstek_master_battery_mode}`});\n        return null; // stop flow\n}\n\n// Continue\nmsg.work_mode = workMode;\nmsg.rs485 = rs485;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 180,
        "wires": [
            [
                "3721d34b6a06e92e"
            ]
        ]
    },
    {
        "id": "e99d7127740fa14c",
        "type": "function",
        "z": "71116bfb3e38272c",
        "g": "034635b1ad500f69",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 240,
        "wires": [
            [
                "b1076b886d0ae381",
                "30f8033fefac3897"
            ]
        ]
    },
    {
        "id": "b1076b886d0ae381",
        "type": "switch",
        "z": "71116bfb3e38272c",
        "g": "034635b1ad500f69",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 640,
        "y": 240,
        "wires": [
            [
                "3721d34b6a06e92e"
            ],
            [
                "fd6b0418a04bd26e"
            ]
        ]
    },
    {
        "id": "c459bdbef50be840",
        "type": "api-call-service",
        "z": "71116bfb3e38272c",
        "g": "034635b1ad500f69",
        "name": "Set work mode",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 800,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "6941c0d003d9dfc4",
        "type": "api-call-service",
        "z": "71116bfb3e38272c",
        "g": "034635b1ad500f69",
        "name": "Set RS485",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 790,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "30f8033fefac3897",
        "type": "debug",
        "z": "71116bfb3e38272c",
        "g": "034635b1ad500f69",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 510,
        "y": 280,
        "wires": []
    },
    {
        "id": "fd6b0418a04bd26e",
        "type": "debug",
        "z": "71116bfb3e38272c",
        "g": "3976d86aa766d5a3",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 360,
        "wires": []
    },
    {
        "id": "ae01513077bdc25c",
        "type": "server-state-changed",
        "z": "71116bfb3e38272c",
        "g": "3976d86aa766d5a3",
        "name": "Master control mode",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "marstek_master_battery_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 150,
        "y": 60,
        "wires": [
            [
                "9445ea2e038dc4ff"
            ]
        ]
    },
    {
        "id": "f94bf3447ab1d3b6",
        "type": "server-state-changed",
        "z": "aefce97eaa15d031",
        "g": "1ee5df773a0c4c46",
        "name": "PID preset selected",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.house_battery_control_pid_presets"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 150,
        "y": 100,
        "wires": [
            [
                "85d81c076e277a20"
            ]
        ]
    },
    {
        "id": "d9895fc84a647ea7",
        "type": "api-call-service",
        "z": "aefce97eaa15d031",
        "g": "1ee5df773a0c4c46",
        "name": "Kp",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_kp"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "180c9ef663adb682",
        "type": "api-call-service",
        "z": "aefce97eaa15d031",
        "g": "1ee5df773a0c4c46",
        "name": "Ki",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_ki"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "3087a5414ad9b62b",
        "type": "api-call-service",
        "z": "aefce97eaa15d031",
        "g": "1ee5df773a0c4c46",
        "name": "Kd",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_kd"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "85d81c076e277a20",
        "type": "function",
        "z": "aefce97eaa15d031",
        "g": "1ee5df773a0c4c46",
        "name": "Presets",
        "func": "// See: house_battery_control.yaml > input_select: > house_battery_control_pid_presets\nconst preset = RED.util.getMessageProperty(msg,\"payload\");\nnode.status({fill:\"green\",shape:\"dot\",text:`${preset}`});\n\n\n// Default values\nlet Kp = 0; // Proportional gain\nlet Ki = 0; // Integral gain\nlet Kd = 0; // Differentiating gain\nlet Si = 0; // % Input smoothing (a Low pass moving average filter)\nlet So = 0; // % Output smoothing (a Low pass moving average filter)\n\nswitch (preset) {\n    // For people who have unstable systems with every other preset\n    case \"Very safe\":\n        Kp = 0.1;\n        Ki = 0.1;\n        Si = 0; // without Kd, this is preferred to be zero.\n        So = 10; // %\n        break;\n    // Good starting point for most\n    case \"Safe\":\n        Kp = 0.3;\n        Ki = 0.3;\n        Kd = 0.1;\n        Si = 20; // %\n        So = 0; // %\n        break;\n    // Gitcodebob's October 2025 settings for 3.2kWp PV and 5kW battery transformer power\n    case \"Regular\":\n        Kp = 0.3;\n        Ki = 0.4;\n        Kd = 0.8;\n        Si = 50; // % This high amount of filtering allows the stronger Kd\n        So = 10; // %\n        break;\n    default:\n        // Don't change values\n        return null;\n}\n\n// Prepare for three outputs\nreturn [\n    { \"payload\": Kp },\n    { \"payload\": Ki },\n    { \"payload\": Kd },\n    { \"payload\": Si },\n    { \"payload\": So }\n];",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 100,
        "wires": [
            [
                "d9895fc84a647ea7"
            ],
            [
                "180c9ef663adb682"
            ],
            [
                "3087a5414ad9b62b"
            ],
            [
                "65d44233d785dfd9"
            ],
            [
                "1b3bbed0be250d2b"
            ]
        ]
    },
    {
        "id": "65d44233d785dfd9",
        "type": "api-call-service",
        "z": "aefce97eaa15d031",
        "g": "1ee5df773a0c4c46",
        "name": "Input Smooth",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_signal_dampening"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 530,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "1b3bbed0be250d2b",
        "type": "api-call-service",
        "z": "aefce97eaa15d031",
        "g": "1ee5df773a0c4c46",
        "name": "Output Smoothing",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output_dampening"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 550,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "a5e9e484430e1720",
        "type": "link in",
        "z": "676ceac4c521834d",
        "g": "72059e541379a869",
        "name": "Charge PV",
        "links": [],
        "x": 100,
        "y": 160,
        "wires": [
            [
                "be2a48e071dee195"
            ]
        ],
        "l": true
    },
    {
        "id": "13aeb5c39ba83e0a",
        "type": "comment",
        "z": "676ceac4c521834d",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "bf548077ba6ca350",
        "type": "comment",
        "z": "676ceac4c521834d",
        "g": "72059e541379a869",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "87be4b85f89829b6",
        "type": "link out",
        "z": "676ceac4c521834d",
        "g": "9889d591bcc38e89",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 665,
        "y": 180,
        "wires": []
    },
    {
        "id": "d62d870eb44d3582",
        "type": "comment",
        "z": "676ceac4c521834d",
        "g": "9889d591bcc38e89",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 720,
        "y": 120,
        "wires": []
    },
    {
        "id": "682972c51f2870ed",
        "type": "function",
        "z": "676ceac4c521834d",
        "name": "Setup",
        "func": "// explain\nconst log = global.get(\"logger\");\nlog(this,\"Using self-consumption to charge with surplus PV\")\n\n// use the self consumption strategy to charge when there is PV surplus\nmsg.target = \"Self-consumption\";\n\n// tell that strategy to disalow discharging\nconst DISABLE_DISCHARGE = true;\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\",DISABLE_DISCHARGE,true);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 180,
        "wires": [
            [
                "17645a134fe6d941"
            ]
        ]
    },
    {
        "id": "17645a134fe6d941",
        "type": "link call",
        "z": "676ceac4c521834d",
        "name": "Self-consumption",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 470,
        "y": 180,
        "wires": [
            [
                "d612533a5317bb76",
                "87be4b85f89829b6"
            ]
        ]
    },
    {
        "id": "d612533a5317bb76",
        "type": "debug",
        "z": "676ceac4c521834d",
        "name": "Batteries charging?",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "batteries_charging",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 730,
        "y": 260,
        "wires": []
    },
    {
        "id": "be2a48e071dee195",
        "type": "change",
        "z": "676ceac4c521834d",
        "g": "72059e541379a869",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 90,
        "y": 200,
        "wires": [
            [
                "682972c51f2870ed"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "524b61f06ac20ae7",
        "type": "catch",
        "z": "676ceac4c521834d",
        "g": "6e6682265db1e9ee",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 55,
        "y": 300,
        "wires": [
            [
                "b068ce351aa5b926"
            ]
        ],
        "l": false
    },
    {
        "id": "b068ce351aa5b926",
        "type": "function",
        "z": "676ceac4c521834d",
        "g": "6e6682265db1e9ee",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 105,
        "y": 300,
        "wires": [
            [
                "0d26b7f936be7947"
            ]
        ],
        "l": false
    },
    {
        "id": "0d26b7f936be7947",
        "type": "link out",
        "z": "676ceac4c521834d",
        "g": "6e6682265db1e9ee",
        "name": "link out 4",
        "mode": "return",
        "links": [],
        "x": 155,
        "y": 300,
        "wires": []
    },
    {
        "id": "ad8e7555b3c120e3",
        "type": "comment",
        "z": "1d62f5f10ba713f5",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 140,
        "y": 60,
        "wires": []
    },
    {
        "id": "65734383849629c6",
        "type": "link in",
        "z": "1d62f5f10ba713f5",
        "g": "42159425f580075e",
        "name": "Charge",
        "links": [],
        "x": 110,
        "y": 220,
        "wires": [
            [
                "a7e9b0ce381f5391"
            ]
        ],
        "l": true
    },
    {
        "id": "fddebee8d55be594",
        "type": "comment",
        "z": "1d62f5f10ba713f5",
        "g": "42159425f580075e",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 130,
        "y": 140,
        "wires": []
    },
    {
        "id": "a7e9b0ce381f5391",
        "type": "change",
        "z": "1d62f5f10ba713f5",
        "g": "42159425f580075e",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 180,
        "wires": [
            [
                "fd473b331f7e4663"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "64d0bc689e0ec8d6",
        "type": "link out",
        "z": "1d62f5f10ba713f5",
        "g": "849ecaade3aef957",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 185,
        "y": 580,
        "wires": []
    },
    {
        "id": "bd97ba77809dd2c6",
        "type": "comment",
        "z": "1d62f5f10ba713f5",
        "g": "849ecaade3aef957",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 130,
        "y": 520,
        "wires": []
    },
    {
        "id": "69dca23dc0fde23a",
        "type": "link in",
        "z": "1d62f5f10ba713f5",
        "g": "849ecaade3aef957",
        "name": "link to End",
        "links": [
            "59b9f4945525df99",
            "1cecaa06aadd8cf2",
            "e5b39c30f5b3859f"
        ],
        "x": 75,
        "y": 580,
        "wires": [
            [
                "64d0bc689e0ec8d6"
            ]
        ]
    },
    {
        "id": "c72054350fa6275c",
        "type": "function",
        "z": "1d62f5f10ba713f5",
        "g": "5a81ff9e8db2ca54",
        "name": "Max power solution",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\nlog(this, \"Charge at **max. power**\");\n\n// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// build solution\nmsg.batteries.forEach(battery => {\n    const calculatedPower = Number(battery.charging_max);\n\n    solution_array.push({\n        id: battery.id,\n        mode: \"charge\",\n        power: calculatedPower\n    });\n\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 360,
        "wires": [
            [
                "aed94acf6dabea08"
            ]
        ]
    },
    {
        "id": "cac7cff4025e6a9c",
        "type": "link call",
        "z": "1d62f5f10ba713f5",
        "g": "5a81ff9e8db2ca54",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1140,
        "y": 400,
        "wires": [
            [
                "4bdab085defea2ee",
                "e5b39c30f5b3859f"
            ]
        ]
    },
    {
        "id": "1ef64b89e33e96de",
        "type": "switch",
        "z": "1d62f5f10ba713f5",
        "g": "5a81ff9e8db2ca54",
        "name": "Import at max power",
        "property": "house_battery_strategy_charge_has_max_power",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 760,
        "y": 380,
        "wires": [
            [
                "c72054350fa6275c"
            ],
            [
                "83fd4c160e428cf7"
            ]
        ]
    },
    {
        "id": "4bdab085defea2ee",
        "type": "debug",
        "z": "1d62f5f10ba713f5",
        "g": "5a81ff9e8db2ca54",
        "name": "Regulated",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1330,
        "y": 400,
        "wires": []
    },
    {
        "id": "4bb990f2c3abc24e",
        "type": "debug",
        "z": "1d62f5f10ba713f5",
        "g": "5a81ff9e8db2ca54",
        "name": "Maximum",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1320,
        "y": 360,
        "wires": []
    },
    {
        "id": "83fd4c160e428cf7",
        "type": "function",
        "z": "1d62f5f10ba713f5",
        "g": "5a81ff9e8db2ca54",
        "name": "Regulated power",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = msg.house_battery_strategy_charge_target_power;\n// tell PID to avoid discharge solutions during charging.\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\",true,true);\n\n// Finally\nlog(this, `**Regulated** charging. Limit grid power: ${Math.floor(msg.house_battery_strategy_charge_target_power)} W`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 400,
        "wires": [
            [
                "cac7cff4025e6a9c"
            ]
        ]
    },
    {
        "id": "aed94acf6dabea08",
        "type": "change",
        "z": "1d62f5f10ba713f5",
        "g": "5a81ff9e8db2ca54",
        "name": "Continue",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Charge",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 360,
        "wires": [
            [
                "4bb990f2c3abc24e",
                "e5b39c30f5b3859f"
            ]
        ]
    },
    {
        "id": "e5b39c30f5b3859f",
        "type": "link out",
        "z": "1d62f5f10ba713f5",
        "g": "5a81ff9e8db2ca54",
        "name": "go to End",
        "mode": "link",
        "links": [
            "69dca23dc0fde23a"
        ],
        "x": 1320,
        "y": 460,
        "wires": [],
        "l": true
    },
    {
        "id": "fbe734165a41f66d",
        "type": "api-current-state",
        "z": "1d62f5f10ba713f5",
        "g": "5a81ff9e8db2ca54",
        "name": "Use max power?",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_charge_has_max_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_charge_has_max_power",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 380,
        "wires": [
            [
                "082952f1b7f48d3b"
            ]
        ]
    },
    {
        "id": "082952f1b7f48d3b",
        "type": "api-current-state",
        "z": "1d62f5f10ba713f5",
        "g": "5a81ff9e8db2ca54",
        "name": "Grid power limit",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_charge_target_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_charge_target_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 560,
        "y": 380,
        "wires": [
            [
                "1ef64b89e33e96de"
            ]
        ]
    },
    {
        "id": "6c0337fdec2983e9",
        "type": "function",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Unknown -> Full stop",
        "func": "const log = global.get(\"logger\");\n\n// Unkown export goal\nlog(this, `**${msg.charge.goal}**; Charge goal not recognized. Fallback to **Full Stop**`,\"warn\");\n\n// Full stop\nmsg.target = \"Full stop\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 240,
        "wires": [
            [
                "8929eed5d72dfed2"
            ]
        ]
    },
    {
        "id": "8929eed5d72dfed2",
        "type": "link call",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 990,
        "y": 240,
        "wires": [
            [
                "59b9f4945525df99"
            ]
        ]
    },
    {
        "id": "fded88bfc00c76dd",
        "type": "api-current-state",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Energy reserve hi",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_charge_target_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charge.threshold_energy",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 200,
        "wires": [
            [
                "f380d11b820c4464"
            ]
        ]
    },
    {
        "id": "59b9f4945525df99",
        "type": "link out",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "go to End",
        "mode": "link",
        "links": [
            "69dca23dc0fde23a"
        ],
        "x": 1190,
        "y": 240,
        "wires": [],
        "l": true
    },
    {
        "id": "f1af526f892414eb",
        "type": "api-current-state",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "SoC reached",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_charge_target_soc",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charge.threshold_soc",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 780,
        "y": 160,
        "wires": [
            [
                "0a071e39f37a28d7"
            ]
        ]
    },
    {
        "id": "f380d11b820c4464",
        "type": "function",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Check if hi",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Charge until: ${msg.charge.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nvar energy_threshold = Number(RED.util.getMessageProperty(msg,\"charge.threshold_energy\"));\nif (energy_threshold === undefined || energy_threshold <= 0){\n    log(this,`Desired energy reserve invalid '${energy_threshold}' kWh. I've set it to ${Number(msg.batteries_max_energy).toFixed(1)} kWh`,\"warn\");\n    energy_threshold = Math.floor(Number(msg.batteries_max_energy)*10)/10;\n}\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining >= energy_threshold) {\n    msg.charge.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh`, 'info');\n} else {\n    msg.charge.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.charge.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.charge.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 200,
        "wires": [
            [
                "4667445f9a27a9d8",
                "55b3fc51c2f3a0f4"
            ]
        ]
    },
    {
        "id": "0a071e39f37a28d7",
        "type": "function",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Check if SoC",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this, `Charge until: ${msg.charge.goal}`);\n\n// 2. Extract average SoC and desired SoC level\nlet batteries = msg.batteries;\nlet soc_avg = 0;\nlet count = 0; // could use msg.battery_count\nbatteries.forEach(battery => {\n    soc_avg += battery.soc;\n    count++;\n});\n// 2.1 Current avg. SoC\nsoc_avg = Math.round(soc_avg / count * 100) / 100;\n// 2.2 Charge until SoC (100% as fallback)\nvar soc_threshold = Number(RED.util.getMessageProperty(msg,\"charge.threshold_soc\"));\nif (soc_threshold === undefined || soc_threshold < 12){\n    log(this, `Desired SoC not set correctly '${soc_threshold}' %. I've set it to 100%.`,\"warn\");\n    soc_threshold = 100;\n}\n\n// 3. Logic: Determine if SoC level is at or above desired level\nif (soc_avg >= soc_threshold) {\n    msg.charge.threshold_reached = true;\n\n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n} else {\n    msg.charge.threshold_reached = false;\n\n    // User friendly feedback via the custom logger\n    log(this, `[OK] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({\n    fill: msg.charge.threshold_reached ? \"red\" : \"green\",\n    shape: \"dot\",\n    text: `Threshold reached: ${msg.charge.threshold_reached}`\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 160,
        "wires": [
            [
                "4667445f9a27a9d8"
            ]
        ]
    },
    {
        "id": "d6d0c3edb4ce5d15",
        "type": "change",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Batteries are full",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 790,
        "y": 120,
        "wires": [
            [
                "d84d8c12d10e505e"
            ]
        ]
    },
    {
        "id": "d84d8c12d10e505e",
        "type": "function",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Check if full",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Charge until: ${msg.charge.goal}`);\n\n// 2. Extract energy level from msg (and handle missing properties)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nconst energy_max = Number(RED.util.getMessageProperty(msg, \"batteries_max_energy\")) || 0;\nif(energy_max == 0) log(this,`Batteries max energy missing! ${msg.batteries_max_energy}`);\n// 2.1 Check if every battery's SoC is at or over the max\nconst isAtMax = msg.batteries.every(battery => battery.soc >= battery.soc_max);\n\n// 3. Logic: Determine if energy level is over or near 99.9% of max eneregy\nif (isAtMax) {\n    msg.charge.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] All batteries are full or at SoC_max_ (${energy_remaining} kWh).`, 'info');\n} else {\n    msg.charge.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Battery level ${energy_remaining.toFixed(2)} kWh below ${energy_max.toFixed(2)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.charge.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.charge.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 120,
        "wires": [
            [
                "4667445f9a27a9d8"
            ]
        ]
    },
    {
        "id": "ad40872cb6be0ad4",
        "type": "switch",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Until reached",
        "property": "charge.threshold_reached",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1340,
        "y": 160,
        "wires": [
            [
                "f4a47ba5e8e0fcaa"
            ],
            [
                "1af4d6d4a4760a8f"
            ]
        ]
    },
    {
        "id": "f4a47ba5e8e0fcaa",
        "type": "function",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Yes -> Charge PV",
        "func": "// If any solar surplus remains, soak it up instead of waiting in Full stop.\nmsg.target = \"Charge PV\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1580,
        "y": 120,
        "wires": [
            [
                "0b4d1fdcfb6a20c3"
            ]
        ]
    },
    {
        "id": "0b4d1fdcfb6a20c3",
        "type": "link call",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 1760,
        "y": 120,
        "wires": [
            [
                "1cecaa06aadd8cf2"
            ]
        ]
    },
    {
        "id": "1cecaa06aadd8cf2",
        "type": "link out",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "go to End",
        "mode": "link",
        "links": [
            "69dca23dc0fde23a"
        ],
        "x": 1900,
        "y": 120,
        "wires": [],
        "l": true
    },
    {
        "id": "4667445f9a27a9d8",
        "type": "function",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Decided",
        "func": "const log = global.get(\"logger\");\n\nif(msg.charge.threshold_reached){\n    log(this,`Stop charging, Charge until ${msg.charge.goal} reached.`);\n} else {\n    log(this,`Continue charging.`);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1190,
        "y": 160,
        "wires": [
            [
                "ad40872cb6be0ad4"
            ]
        ]
    },
    {
        "id": "1346727f82d33b6c",
        "type": "switch",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Charge until",
        "property": "charge.goal",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "batteries are full",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "state of charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "energy reserve",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 4,
        "x": 590,
        "y": 180,
        "wires": [
            [
                "d6d0c3edb4ce5d15"
            ],
            [
                "f1af526f892414eb"
            ],
            [
                "fded88bfc00c76dd"
            ],
            [
                "6c0337fdec2983e9"
            ]
        ]
    },
    {
        "id": "b27ff494f6634ba9",
        "type": "api-current-state",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Goal",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_charge_goal",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charge.goal",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 180,
        "wires": [
            [
                "1346727f82d33b6c"
            ]
        ]
    },
    {
        "id": "fd473b331f7e4663",
        "type": "function",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "Init",
        "func": "msg.charge = {};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "b27ff494f6634ba9",
                "fe1672746de4d3e1"
            ]
        ]
    },
    {
        "id": "72855d465c41b0ba",
        "type": "function",
        "z": "1d62f5f10ba713f5",
        "g": "327d0c28a11a705b",
        "name": "Min/max",
        "func": "\n// Lower bound\nlet output = msg.charge.threshold_energy || 0; // kWh\noutput = Math.max(output, 0);\n\n// Upper bound\noutput = Math.min(output, msg.batteries_max_energy);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1800,
        "y": 200,
        "wires": [
            [
                "8a7bf3d74e7276cf"
            ]
        ]
    },
    {
        "id": "8a7bf3d74e7276cf",
        "type": "api-call-service",
        "z": "1d62f5f10ba713f5",
        "g": "327d0c28a11a705b",
        "name": "Set desired energy reserve",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_charge_target_energy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.payload}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2010,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "55b3fc51c2f3a0f4",
        "type": "rbe",
        "z": "1d62f5f10ba713f5",
        "g": "327d0c28a11a705b",
        "name": "Desired energy changed",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 1600,
        "y": 200,
        "wires": [
            [
                "72855d465c41b0ba"
            ]
        ]
    },
    {
        "id": "fe1672746de4d3e1",
        "type": "debug",
        "z": "1d62f5f10ba713f5",
        "g": "44362bab0730561d",
        "name": "debug 2",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 410,
        "y": 120,
        "wires": []
    },
    {
        "id": "80a6da8b34d1f912",
        "type": "catch",
        "z": "1d62f5f10ba713f5",
        "g": "a5850d6fc8d26fb3",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 75,
        "y": 420,
        "wires": [
            [
                "aebb282c786f309d"
            ]
        ],
        "l": false
    },
    {
        "id": "aebb282c786f309d",
        "type": "function",
        "z": "1d62f5f10ba713f5",
        "g": "a5850d6fc8d26fb3",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 125,
        "y": 420,
        "wires": [
            [
                "97b699bb128980d8"
            ]
        ],
        "l": false
    },
    {
        "id": "97b699bb128980d8",
        "type": "link out",
        "z": "1d62f5f10ba713f5",
        "g": "a5850d6fc8d26fb3",
        "name": "link out 3",
        "mode": "return",
        "links": [],
        "x": 175,
        "y": 420,
        "wires": []
    },
    {
        "id": "945de7fd5b370681",
        "type": "link in",
        "z": "43e2c4565d34c242",
        "g": "dfa924afde42337c",
        "name": "Dynamic",
        "links": [],
        "x": 100,
        "y": 160,
        "wires": [
            [
                "50dc607821101faf"
            ]
        ],
        "l": true
    },
    {
        "id": "f1d6f2b3922925ca",
        "type": "comment",
        "z": "43e2c4565d34c242",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "69d14213c816cde1",
        "type": "comment",
        "z": "43e2c4565d34c242",
        "g": "dfa924afde42337c",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "f4c768e760e225d6",
        "type": "link out",
        "z": "43e2c4565d34c242",
        "g": "05cb765beecd73cb",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 975,
        "y": 180,
        "wires": []
    },
    {
        "id": "f7919bf7f92d3335",
        "type": "comment",
        "z": "43e2c4565d34c242",
        "g": "05cb765beecd73cb",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 1030,
        "y": 120,
        "wires": []
    },
    {
        "id": "1a6246ca9abf2e83",
        "type": "api-render-template",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Cheapest",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{}",
        "resultsLocation": "dynamic.data_cheapest",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 460,
        "y": 660,
        "wires": [
            [
                "9860b755ba4b2d4e"
            ]
        ]
    },
    {
        "id": "c843bdeae79c0e58",
        "type": "api-render-template",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Expensive",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "",
        "resultsLocation": "dynamic.data_expensive",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 470,
        "y": 720,
        "wires": [
            [
                "8262ba7519609e5a"
            ]
        ]
    },
    {
        "id": "3deb7fec0af7839e",
        "type": "debug",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Complete message",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 910,
        "y": 1220,
        "wires": []
    },
    {
        "id": "9860b755ba4b2d4e",
        "type": "json",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "",
        "property": "dynamic.data_cheapest",
        "action": "obj",
        "pretty": false,
        "x": 555,
        "y": 660,
        "wires": [
            [
                "772f3e317433da1c"
            ]
        ],
        "l": false
    },
    {
        "id": "8262ba7519609e5a",
        "type": "json",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "",
        "property": "dynamic.data_expensive",
        "action": "obj",
        "pretty": false,
        "x": 575,
        "y": 720,
        "wires": [
            [
                "0bb50184686abc06"
            ]
        ],
        "l": false
    },
    {
        "id": "bbf0eca8289cd464",
        "type": "function",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Determine dynamic strategy",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// 1.   Input\n// Conversion\nconst CONVERSION_RATE = parseFloat(RED.util.getMessageProperty(msg, \"dynamic.value_conversion\")) || 1;\n\n// extract start/end date objects\nconst start_cheapest = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.start\"));\nconst start_expensive = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_expensive.start\"));\nconst end_cheapest = new Date(RED.util.getMessageProperty(msg, \"dynamic.data_cheapest.end\"));\nconst end_expensive = new Date(RED.util.getMessageProperty(msg, \"dynamic.data_expensive.end\"));\nlet isCheapestNext = true;\n// stored price cheapest period\nlet lastCheapestPrice = context.last_cheapest_price || 0; // unit: cents/kWh\nconst nextCheapestPrice = parseInt(RED.util.getMessageProperty(msg, \"dynamic.data_cheapest.average\") / CONVERSION_RATE * 100); // unit: cents/kWh \n// average price expensive period\nconst lastExpensivePrice = parseInt(RED.util.getMessageProperty(msg, \"dynamic.data_expensive.average\") / CONVERSION_RATE * 100); // unit: cents/kWh\n// threshold rate for cheapest period\nconst cheapestThresholdCents = parseInt(RED.util.getMessageProperty(msg, \"dynamic.threshold_cheapest_cents\")) || 0; // unit: cents\n// threshold delta for expensive period\nconst deltaThresholdCents = parseInt(RED.util.getMessageProperty(msg, \"dynamic.min_delta_cents\")) || 0; // unit: cents\n\n// 1.1  Enums\nconst STRATEGY = {\n    CHEAPEST: RED.util.getMessageProperty(msg,\"dynamic.strategy_cheapest\") || \"Charge\", \n    NEUTRAL: RED.util.getMessageProperty(msg,\"dynamic.strategy_default\") || \"Charge PV\",\n    EXPENSIVE: RED.util.getMessageProperty(msg,\"dynamic.strategy_expensive\") || \"Self-consumption\"\n}\n\n// 1.2  Defaults   \nmsg.dynamic.avg_cheapest_tariff = 0;\nmsg.dynamic.avg_expensive_tariff = 0;\nmsg.dynamic.avg_delta = 0;\n\n// 2.   Tariffs\n// Check if the Date objects are valid. If 'Invalid Date', stop and warn the user.\nif (isNaN(start_cheapest.getTime()) || isNaN(start_expensive.getTime())) {\n    // warn user\n    log(this, `One or both dates are invalid. Cheap = ${start_cheapest}, Expensive = ${start_expensive}`,\"warn\");\n    node.status({fill:\"red\",shape:\"ring\",text:`One or both dates are invalid: ${start_cheapest}, ${start_expensive}`});\n    // fallback strategy\n    flow.set(\"dynamic_strategy\", STRATEGY.NEUTRAL);\n    // proceed to UI\n    return msg;\n}\n\n// Check if cheapest lies before expensive\nif (start_cheapest < start_expensive) {\n    log(this, `Cheapest moment lies before expensive moment. Cheapest moment: ${start_cheapest}, Expensive = ${start_expensive}`);\n    // store the cheapest price to compare it with future expensive rates, to determine if it's economical to discharge.\n    context.last_cheapest_price = nextCheapestPrice; // store for next iteration\n    lastCheapestPrice = nextCheapestPrice; // used for this iteration\n    log(this, `Cheapest price set to ${lastCheapestPrice} cents`);\n}\n\nif (lastCheapestPrice == 0) {\n    log(this, `I can't recall the tariff used for charging. Cheapest price set to '${lastCheapestPrice}' cents`);\n}\n\n// delta > N cents ? -> charging is economical\nconst delta = (lastExpensivePrice - lastCheapestPrice); // unit: cents\n\n// UI values\nmsg.dynamic.avg_cheapest_tariff = lastCheapestPrice;\nmsg.dynamic.avg_expensive_tariff = lastExpensivePrice;\nmsg.dynamic.avg_delta = delta;\n\n// 3.   Strategy selection logic\n// for string time\nfunction isTimeInPeriod(startStr, endStr) {\n    const now = new Date();\n    const start = new Date(startStr);\n    const end = new Date(endStr);\n    return (now >= start && now < end);\n}\n// 3.1  is_now - which period have we entered?\nconst now = new Date();\n/** @type {boolean} */\nconst cheapestIsNow = now >= start_cheapest && now <= end_cheapest;\n// const cheapestIsNow = RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.is_now\");\n/** @type {boolean} */\nconst expensiveIsNow = now >= start_expensive && now <= end_expensive;\n// const expensiveIsNow = RED.util.getMessageProperty(msg, \"dynamic.data_expensive.is_now\");\n\n// 3.2  Set strategy\n// Default strategy\nmsg.dynamic.strategy = STRATEGY.NEUTRAL;\n\n// Cheapest period?\nif (cheapestIsNow && lastCheapestPrice <= cheapestThresholdCents) {\n    msg.dynamic.strategy = STRATEGY.CHEAPEST;\n    // Explain\n    log(this, `**Cheapest period is NOW**, price limit: ${lastCheapestPrice}/${cheapestThresholdCents} cents OK`);\n} else if(cheapestIsNow) {\n    // Explain why skipped\n    log(this, `**Cheapest period SKIPPED**, the cheapest period is too expensive today. Price limit: ${lastCheapestPrice}/${cheapestThresholdCents} cents.`);\n}\n\n// Expensive period?\nif (expensiveIsNow && delta >= deltaThresholdCents) {\n    msg.dynamic.strategy = STRATEGY.EXPENSIVE;\n    // Explain\n    log(this, `**Expensive period is NOW**, price delta: ${delta}>=${deltaThresholdCents} cents OK`);\n} else if(expensiveIsNow) {\n    // Explain why skipped\n    log(this, `**Expensive period SKIPPED**, price delta too small: ${lastExpensivePrice}-${lastCheapestPrice}=${delta} cents <= ${deltaThresholdCents} cents`); \n}\n\n// 3.3  Store the strategy in flow-context. The 'Execution' area will read from the flow-context.\nflow.set(\"dynamic_strategy\",msg.dynamic.strategy);\n\n// 4.   User feedback\n// Node status\nnode.status({ fill: \"blue\", shape: \"dot\", text: `${msg.dynamic.strategy}; ${cheapestIsNow} + ${expensiveIsNow} @ ${delta} cents` });\n// Explain\nlog(this, `Strategy set to **${msg.dynamic.strategy}**`);\n\n// Proceed to UI update\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 1140,
        "wires": [
            [
                "3deb7fec0af7839e",
                "f0163b0eeaf865e2",
                "110b3b19eb5133bc",
                "56ada86c06d721f7",
                "a95299c1bf1a13bc",
                "36c0d33885ed6329",
                "53acf427d49b2573",
                "1d789d31e8675fde",
                "20e01029024a4f0f"
            ]
        ]
    },
    {
        "id": "a66315a27f30818d",
        "type": "change",
        "z": "43e2c4565d34c242",
        "g": "6db710bf5c0d9ebd",
        "name": "Set strategy",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "dynamic_strategy",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 200,
        "wires": [
            [
                "6a70dd9bdcd5c801"
            ]
        ]
    },
    {
        "id": "d2d2d04b67466fbe",
        "type": "link call",
        "z": "43e2c4565d34c242",
        "g": "6db710bf5c0d9ebd",
        "name": "Sub-strategy",
        "links": [],
        "linkType": "dynamic",
        "timeout": "3",
        "x": 810,
        "y": 180,
        "wires": [
            [
                "f4c768e760e225d6"
            ]
        ]
    },
    {
        "id": "f0163b0eeaf865e2",
        "type": "api-call-service",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Cheapest Start",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_cheapest_start"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.start).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 900,
        "y": 940,
        "wires": [
            []
        ]
    },
    {
        "id": "110b3b19eb5133bc",
        "type": "api-call-service",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Cheapest End",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_cheapest_end"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.end).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 900,
        "y": 980,
        "wires": [
            []
        ]
    },
    {
        "id": "56ada86c06d721f7",
        "type": "api-call-service",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Expensive Start",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_expensive_start"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_expensive.start).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 900,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "a95299c1bf1a13bc",
        "type": "api-call-service",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Expensive End",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_expensive_end"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_expensive.end).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 900,
        "y": 1060,
        "wires": [
            []
        ]
    },
    {
        "id": "3361691261d2f519",
        "type": "inject",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Every 60 min",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "0 0-23 * * *",
        "once": false,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 380,
        "y": 420,
        "wires": [
            [
                "8ab73e892d2154d9"
            ]
        ]
    },
    {
        "id": "1a175947a9cf9868",
        "type": "switch",
        "z": "43e2c4565d34c242",
        "g": "6db710bf5c0d9ebd",
        "name": "Has strategy",
        "property": "dynamic_strategy",
        "propertyType": "flow",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 330,
        "y": 180,
        "wires": [
            [
                "82bc8c259e762fae"
            ],
            [
                "a66315a27f30818d"
            ]
        ]
    },
    {
        "id": "82bc8c259e762fae",
        "type": "change",
        "z": "43e2c4565d34c242",
        "g": "6db710bf5c0d9ebd",
        "name": "Set Full stop",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Full stop",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 160,
        "wires": [
            [
                "6a70dd9bdcd5c801"
            ]
        ]
    },
    {
        "id": "6957a57cc6e3bc51",
        "type": "inject",
        "z": "43e2c4565d34c242",
        "g": "48c46e82f679cf46",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 1520,
        "wires": [
            [
                "b598b6f2379450ed"
            ]
        ]
    },
    {
        "id": "b598b6f2379450ed",
        "type": "api-render-template",
        "z": "43e2c4565d34c242",
        "g": "48c46e82f679cf46",
        "name": "Cheapest",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "cheapest",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 500,
        "y": 1520,
        "wires": [
            [
                "8c069c2aa3530361"
            ]
        ]
    },
    {
        "id": "8c069c2aa3530361",
        "type": "json",
        "z": "43e2c4565d34c242",
        "g": "48c46e82f679cf46",
        "name": "",
        "property": "cheapest",
        "action": "obj",
        "pretty": false,
        "x": 595,
        "y": 1520,
        "wires": [
            [
                "94a388e6c2cac376"
            ]
        ],
        "l": false
    },
    {
        "id": "94a388e6c2cac376",
        "type": "api-render-template",
        "z": "43e2c4565d34c242",
        "g": "48c46e82f679cf46",
        "name": "Expensive",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    lowest=false,\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "expensive",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 750,
        "y": 1520,
        "wires": [
            [
                "7919837e29c1125d"
            ]
        ]
    },
    {
        "id": "7919837e29c1125d",
        "type": "json",
        "z": "43e2c4565d34c242",
        "g": "48c46e82f679cf46",
        "name": "",
        "property": "expensive",
        "action": "obj",
        "pretty": false,
        "x": 855,
        "y": 1520,
        "wires": [
            [
                "aeba7268ed3b560d",
                "954a07430e3bf915",
                "551330f71b044604"
            ]
        ],
        "l": false
    },
    {
        "id": "aeba7268ed3b560d",
        "type": "debug",
        "z": "43e2c4565d34c242",
        "g": "48c46e82f679cf46",
        "name": "Cheap",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "cheapest.start",
        "targetType": "msg",
        "statusVal": "cheapest.start",
        "statusType": "auto",
        "x": 990,
        "y": 1560,
        "wires": []
    },
    {
        "id": "954a07430e3bf915",
        "type": "debug",
        "z": "43e2c4565d34c242",
        "g": "48c46e82f679cf46",
        "name": "Expensive",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "expensive.start",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1010,
        "y": 1600,
        "wires": []
    },
    {
        "id": "2715a31140d45541",
        "type": "api-render-template",
        "z": "43e2c4565d34c242",
        "g": "2b9c51b9468b61d4",
        "name": "All Zonneplan",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    include_tomorrow=true,\n    hours=\"all\",\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "all_data",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 480,
        "y": 1700,
        "wires": [
            [
                "15bed74d128dd42c"
            ]
        ]
    },
    {
        "id": "2caea70fa7734239",
        "type": "inject",
        "z": "43e2c4565d34c242",
        "g": "2b9c51b9468b61d4",
        "name": "Fetch",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 1700,
        "wires": [
            [
                "2715a31140d45541"
            ]
        ]
    },
    {
        "id": "15bed74d128dd42c",
        "type": "json",
        "z": "43e2c4565d34c242",
        "g": "2b9c51b9468b61d4",
        "name": "",
        "property": "all_data",
        "action": "obj",
        "pretty": false,
        "x": 595,
        "y": 1700,
        "wires": [
            [
                "e7bcb8e91e50c70e",
                "af99a757b80e5498"
            ]
        ],
        "l": false
    },
    {
        "id": "8ab73e892d2154d9",
        "type": "delay",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 540,
        "y": 420,
        "wires": [
            [
                "a2e93b4c096f585c"
            ]
        ]
    },
    {
        "id": "3c087a25af39d14b",
        "type": "api-current-state",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Source",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_data_source",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.data_source",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 860,
        "y": 380,
        "wires": [
            [
                "02148ab5c5eaaaf9"
            ]
        ]
    },
    {
        "id": "ef1da1d3a7216433",
        "type": "function",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Data source settings",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n/*    From cheapes-energy-hours macro\n      See: https://github.com/TheFes/cheapest-energy-hours/blob/main/documentation/1-source_data.md#data-provider-settings\n\n      - None (default selection)\n      - Zonneplan\n      - Amber Electric\n      - EasyEnergy, EnergyZero (core)\n      - ENTSO-E\n      - Frank Energie\n      - GE-Spot\n      - Tibber, Nordpool (core)\n      - Tibber (custom)\n      - Nordpool (custom)\n      - PVPC (Spain)\n      - Octopus Energy\n      - Omie\n*/\n\nswitch (msg.dynamic.data_source) {\n      case \"None\":\n            // Handle the 'None' case (e.g., no supplier selected or data is unavailable)\n            log(this,\"No data source selected.\");\n            // Add config here...\n            break;\n\n      case \"Zonneplan\":\n            // Code for Zonneplan (a Dutch energy supplier)\n            log(this,\"Processing Zonneplan data.\");\n            // Add config here...\n            msg.dynamic.sensor='sensor.zonneplan_current_electricity_tariff'; // when using: https://github.com/fsaris/home-assistant-zonneplan-one\n            msg.dynamic.attr_all='forecast';\n            msg.dynamic.value_key='electricity_price';\n            msg.dynamic.value_conversion = 10000000; // whole currency / kWh\n            break;\n\n      case \"Amber Electric\":\n            // Code for Amber Electric (Australian energy retailer)\n            log(this,\"Processing Amber Electric data.\");\n            // Add config here...\n            msg.dynamic.attr_all='forecasts'; \n            msg.dynamic.time_key='start_time'; \n            msg.dynamic.value_key='per_kwh';\n            break;\n\n      case \"EasyEnergy, EnergyZero (core)\":\n            // Code for EasyEnergy and EnergyZero (core/default implementation)\n            log(this,\"Processing EasyEnergy/EnergyZero core data.\");\n            // Add config here...\n            break;\n\n      case \"ENTSO-E\":\n            // Code for ENTSO-E (European Network of Transmission System Operators for Electricity)\n            log(this,\"Processing ENTSO-E data.\");\n            // Add config here...\n            msg.dynamic.attr_today='prices_today'; \n            msg.dynamic.attr_tomorrow='prices_tomorrow'; \n            msg.dynamic.time_key='time';\n            msg.dynamic.value_key='price';\n            break;\n\n      case \"Frank Energie\":\n            // Code for Frank Energie (Dutch energy supplier)\n            log(this,\"Processing Frank Energie data.\");\n            // Add config here...\n            msg.dynamic.attr_all = 'prices'; \n            msg.dynamic.time_key = 'from'; \n            msg.dynamic.value_key = 'price';\n            break;\n\n      case \"GE-Spot\":\n            // Code for GE-Spot (Global Electric Spot price)\n            log(this,\"Processing GE-Spot data.\");\n            // Add config here...\n            msg.dynamic.attr_today = 'today_hourly_prices'; // using the hourly version. today_interval_prices is per 15 mins\n            msg.dynamic.attr_tomorrow = 'tomorrow_hourly_prices'; // using the hourly version\n            msg.dynamic.time_key = 'time'; \n            msg.dynamic.value_key = 'value';\n            break;\n\n      case \"Tibber, Nordpool (core)\":\n            // Code for Tibber and Nordpool (core/default implementation)\n            log(this,\"Processing Tibber/Nordpool core data.\");\n            // Add config here...\n            msg.dynamic.sensor = 'sensor.tibber_ceh_prices';\n            msg.dynamic.attr_today = 'today';\n            msg.dynamic.attr_tomorrow = 'tomorrow';\n            msg.dynamic.time_key = 'start';\n            msg.dynamic.value_key = 'value';\n            msg.dynamic.datetime_in_data = true; // datetime is in the data\n            break;\n\n      case \"Tibber (custom)\":\n            // Code for a custom Tibber setup/configuration\n            log(this,\"Processing Tibber custom data.\");\n            // Add config here...\n            msg.dynamic.attr_today = 'today';\n            msg.dynamic.attr_tomorrow = 'tomorrow';\n            msg.dynamic.datetime_in_data = false;\n            break;\n\n      case \"Nordpool (custom)\":\n            // Code for a custom Nordpool setup/configuration\n            log(this,\"Processing Nordpool custom data.\");\n            // Add config here...\n            break;\n\n      case \"PVPC (Spain)\":\n            // Code for PVPC (Voluntary Price for Small Consumers in Spain)\n            log(this,\"Processing Spanish PVPC data.\");\n            // Add config here...\n            break;\n\n      case \"Octopus Energy\":\n            // Code for Octopus Energy (UK/international energy supplier)\n            log(this,\"Processing Octopus Energy data.\");\n            // Add config here...\n            msg.dynamic.attr_all = 'rates'; \n            msg.dynamic.value_key = 'value_incl_vat';\n            break;\n\n      case \"Omie\":\n            // Code for Omie (Iberian Energy Market Operator)\n            log(this,\"Processing Omie data.\");\n            // Add config here...\n            break;\n\n      default:\n            // Code to execute if the supplier does not match any of the above cases\n            node.warn(`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            log(this,`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            // Add default error handling...\n}\n\nlog(this, \"Performing API calls...\");\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 600,
        "wires": [
            [
                "f9d73dbee7d1d101"
            ]
        ]
    },
    {
        "id": "0d1c173cfa69474f",
        "type": "api-current-state",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Cheapest N hrs",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_cheapest_hrs",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.cheapest_hrs",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1100,
        "y": 380,
        "wires": [
            [
                "88c7fbbb50fc9eb1"
            ]
        ]
    },
    {
        "id": "88c7fbbb50fc9eb1",
        "type": "api-current-state",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Expensive N hrs",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_expensive_hrs",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.expensive_hrs",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1100,
        "y": 420,
        "wires": [
            [
                "22b6bb41ec336a29"
            ]
        ]
    },
    {
        "id": "1a661e75892b6c74",
        "type": "inject",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Check period",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "*/15 0-23 * * *",
        "once": true,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 380,
        "y": 380,
        "wires": [
            [
                "a2c606034d1f2eaa"
            ]
        ]
    },
    {
        "id": "a2c606034d1f2eaa",
        "type": "function",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Init",
        "func": "msg.dynamic = {};\nmsg.log = [];\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 380,
        "wires": [
            [
                "3c087a25af39d14b"
            ]
        ]
    },
    {
        "id": "f9d73dbee7d1d101",
        "type": "function",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Generate templates",
        "func": "// final template initialization\nmsg.dynamic.template_cheapest = \"\";\nmsg.dynamic.template_expensive = \"\";\n\n// temporary template parts\nlet template_start = \"\";\nlet template_common = [];\nlet template_cheapest = [];\nlet template_expensive = [];\nlet template_all = [];\nlet template_end = \"\";\n\n// 1. IMPROVEMENT: Use radix 10 and Logical OR (||) for cleaner default handling\nconst cheapest_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.cheapest_hrs\"), 10) || 1;\nconst expensive_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.expensive_hrs\"), 10) || 1;\n\n// load the macro\ntemplate_start = `{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n`;\ntemplate_end = `) | to_json }}`;\n\n// collect arguments | strings\nconst stringKeys = [\n    'sensor',\n    'attr_all',\n    'value_key',\n    'attr_today',\n    'attr_tomorrow',\n    'time_key'\n];\n\nstringKeys.forEach(key => {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}='${msg.dynamic[key]}'`);\n    }\n});\n\n// collect arguments | boolean, integer\nconst otherKeys = [\n    'datetime_in_data',\n    'data_minutes',\n];\n\notherKeys.forEach(key => {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}=${msg.dynamic[key]}`);\n    }\n});\n\n// copy common items\ntemplate_cheapest = [...template_common];\ntemplate_expensive = [...template_common];\ntemplate_all = [...template_common];\n\n// collect arguments | cheapest specific\ntemplate_cheapest.push(`hours=${cheapest_hrs}`);\n// template_cheapest.push(`include_tomorrow=true`);\ntemplate_cheapest.push(`mode=\"all\"`);\n\n// collect arguments | expensive specific\ntemplate_expensive.push(`hours=${expensive_hrs}`);\n// template_expensive.push(`include_tomorrow=true`);\ntemplate_expensive.push(`lowest=false`);\ntemplate_expensive.push(`mode=\"all\"`);\n\n// collect all hours | via extra call\ntemplate_all.push(`hours=\"all\"`);\ntemplate_all.push(`include_tomorrow=true`);\ntemplate_all.push(`mode=\"all\"`);\n\n/**\n * Formats an array of strings into a single string:\n * - Each item starts with 4 spaces.\n * - Each item ends with a comma, except the last one.\n * - Items are separated by a newline.\n */\nfunction formatTemplateArray(array) {\n    if (!array || array.length === 0) {\n        return \"\";\n    }\n\n    const indent = \"    \"; \n\n    const formatted_lines = array.map((element, index) => {\n        const suffix = (index < array.length - 1) ? \",\" : \"\";\n        return `${indent}${element}${suffix}`;\n    });\n\n    return formatted_lines.join('\\n');\n}\n\n// generate string templates\nconst template_cheapest_string = formatTemplateArray(template_cheapest);\nconst template_expensive_string = formatTemplateArray(template_expensive);\nconst template_all_string = formatTemplateArray(template_all);\n\n// done\nmsg.dynamic.template_cheapest = `${template_start}${template_cheapest_string}${template_end}`;\nmsg.dynamic.template_expensive = `${template_start}${template_expensive_string}${template_end}`;\nmsg.dynamic.template_all = `${template_start}${template_all_string}${template_end}`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 600,
        "wires": [
            [
                "21e31d9b506fda62",
                "08ab42d46d6b4a73",
                "6bd50ca39c76d914",
                "1bd71d96b5e5525c"
            ]
        ]
    },
    {
        "id": "21e31d9b506fda62",
        "type": "debug",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Template cheapest",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_cheapest",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 850,
        "y": 620,
        "wires": []
    },
    {
        "id": "08ab42d46d6b4a73",
        "type": "debug",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Template expensive",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_expensive",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 860,
        "y": 580,
        "wires": []
    },
    {
        "id": "6bd50ca39c76d914",
        "type": "change",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_cheapest",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 660,
        "wires": [
            [
                "1a6246ca9abf2e83"
            ]
        ]
    },
    {
        "id": "772f3e317433da1c",
        "type": "change",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_expensive",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 720,
        "wires": [
            [
                "c843bdeae79c0e58"
            ]
        ]
    },
    {
        "id": "a8208c750ae4a8f5",
        "type": "change",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Cleanup",
        "rules": [
            {
                "t": "delete",
                "p": "template",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 340,
        "y": 840,
        "wires": [
            [
                "eef1de260499e2e8"
            ]
        ]
    },
    {
        "id": "36c0d33885ed6329",
        "type": "debug",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Log: activate 'debug mode' first",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "log",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 950,
        "y": 1260,
        "wires": []
    },
    {
        "id": "03e0666c92b71771",
        "type": "server-state-changed",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "User input",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.house_battery_strategy_dynamic_cheapest_hrs",
                "input_number.house_battery_strategy_dynamic_expensive_hrs",
                "input_select.house_battery_strategy_dynamic_data_source",
                "input_number.house_battery_strategy_dynamic_threshold_delta",
                "input_number.house_battery_strategy_dynamic_threshold_cheapest_period"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 360,
        "y": 340,
        "wires": [
            [
                "b345941d67039862"
            ]
        ]
    },
    {
        "id": "02148ab5c5eaaaf9",
        "type": "switch",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Source selected?",
        "property": "dynamic.data_source",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "None",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 965,
        "y": 380,
        "wires": [
            [
                "9518a456438a2d54"
            ],
            [
                "0d1c173cfa69474f"
            ]
        ],
        "l": false
    },
    {
        "id": "8420e8ebe5336bac",
        "type": "debug",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Not set",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1340,
        "y": 340,
        "wires": []
    },
    {
        "id": "53acf427d49b2573",
        "type": "api-call-service",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Avg cheap tariff",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_cheapest_avg_tariff"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_cheapest_tariff }",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 900,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "1d789d31e8675fde",
        "type": "api-call-service",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Avg expensive tariff",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_expensive_avg_tariff"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_expensive_tariff}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 910,
        "y": 1140,
        "wires": [
            []
        ]
    },
    {
        "id": "20e01029024a4f0f",
        "type": "api-call-service",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Avg delta",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_expensive_avg_delta"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_delta}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 880,
        "y": 1180,
        "wires": [
            []
        ]
    },
    {
        "id": "cb43481920102fc0",
        "type": "api-current-state",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Threshold delta",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_threshold_delta",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.min_delta_cents",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 360,
        "y": 1020,
        "wires": [
            [
                "213320a3faa32b56"
            ]
        ]
    },
    {
        "id": "9518a456438a2d54",
        "type": "change",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Set dynamic strategy to null",
        "rules": [
            {
                "t": "set",
                "p": "dynamic_strategy",
                "pt": "flow",
                "to": "null",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 340,
        "wires": [
            [
                "8420e8ebe5336bac"
            ]
        ]
    },
    {
        "id": "e7bcb8e91e50c70e",
        "type": "debug",
        "z": "43e2c4565d34c242",
        "g": "2b9c51b9468b61d4",
        "name": "All data",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "all_data",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 1700,
        "wires": []
    },
    {
        "id": "551330f71b044604",
        "type": "debug",
        "z": "43e2c4565d34c242",
        "g": "48c46e82f679cf46",
        "name": "Complete msg",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 1520,
        "wires": []
    },
    {
        "id": "50dc607821101faf",
        "type": "change",
        "z": "43e2c4565d34c242",
        "g": "dfa924afde42337c",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 90,
        "y": 200,
        "wires": [
            [
                "1a175947a9cf9868"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "6a70dd9bdcd5c801",
        "type": "function",
        "z": "43e2c4565d34c242",
        "g": "6db710bf5c0d9ebd",
        "name": "Selected",
        "func": "// Logger\nconst log = global.get(\"logger\");\nlog(this,`${msg.target} strategy`);\n\n// Status\nnode.status({fill:\"green\",shape:\"dot\",text:`${msg.target}`});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 180,
        "wires": [
            [
                "d2d2d04b67466fbe"
            ]
        ]
    },
    {
        "id": "5cf8996f6c686075",
        "type": "catch",
        "z": "43e2c4565d34c242",
        "g": "3be7aaf17aea51c8",
        "name": "",
        "scope": null,
        "uncaught": true,
        "x": 65,
        "y": 320,
        "wires": [
            [
                "d1479b091824388d"
            ]
        ],
        "l": false
    },
    {
        "id": "d1479b091824388d",
        "type": "function",
        "z": "43e2c4565d34c242",
        "g": "3be7aaf17aea51c8",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 115,
        "y": 320,
        "wires": [
            [
                "91b3355ce8069f27"
            ]
        ],
        "l": false
    },
    {
        "id": "91b3355ce8069f27",
        "type": "link out",
        "z": "43e2c4565d34c242",
        "g": "3be7aaf17aea51c8",
        "name": "link out 5",
        "mode": "return",
        "links": [],
        "x": 165,
        "y": 320,
        "wires": []
    },
    {
        "id": "e7e2014216c27578",
        "type": "api-current-state",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Threshold cheapest",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_threshold_cheapest_period",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.threshold_cheapest_cents",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 980,
        "wires": [
            [
                "cb43481920102fc0"
            ]
        ]
    },
    {
        "id": "213320a3faa32b56",
        "type": "api-current-state",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Strategy default",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_default",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.strategy_default",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 360,
        "y": 1060,
        "wires": [
            [
                "144cc66c5aa6fb0b"
            ]
        ]
    },
    {
        "id": "144cc66c5aa6fb0b",
        "type": "api-current-state",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Strategy cheapest",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_cheapest",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.strategy_cheapest",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 1100,
        "wires": [
            [
                "d96bb293f1c1ceef"
            ]
        ]
    },
    {
        "id": "d96bb293f1c1ceef",
        "type": "api-current-state",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "Strategy expensive",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_expensive",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.strategy_expensive",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 1140,
        "wires": [
            [
                "bbf0eca8289cd464"
            ]
        ]
    },
    {
        "id": "eef1de260499e2e8",
        "type": "function",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Cache data source",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\nconst dynamicData = msg.dynamic;\n\n// Helper to check for errors in the object\nconst isInvalid = (data) => {\n    if (!data) return true;\n    // Check if the stringified object contains \"error\"\n    return JSON.stringify(data).toLowerCase().includes(\"error\");\n};\n\nif (isInvalid(dynamicData)) {\n    // Explain issue\n    log(this, \"Invalid data received, clearing cache\", \"warn\");\n    // Clear cache\n    flow.set(\"cached_dynamic_data\", undefined);\n} else {\n    // Cache on success\n    log(this, \"Caching `msg.dynamic`\");\n    // Save the entire object to flow context\n    flow.set(\"cached_dynamic_data\", dynamicData);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 840,
        "wires": [
            [
                "89c9eb1d187f7737"
            ]
        ]
    },
    {
        "id": "541095778cf7ea18",
        "type": "catch",
        "z": "43e2c4565d34c242",
        "g": "fab67345066b14d4",
        "name": "Catch group",
        "scope": "group",
        "uncaught": false,
        "x": 1090,
        "y": 580,
        "wires": [
            [
                "1f1e3c94cb7cb585"
            ]
        ]
    },
    {
        "id": "016a52713f269f32",
        "type": "debug",
        "z": "43e2c4565d34c242",
        "g": "fab67345066b14d4",
        "name": "Strategy errors",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1320,
        "y": 580,
        "wires": []
    },
    {
        "id": "4d50c682eac8903e",
        "type": "comment",
        "z": "43e2c4565d34c242",
        "g": "fab67345066b14d4",
        "name": "Cheapest Energy Hours - errors",
        "info": "\"No valid sensor found\" if price_data is none and not valid_sensor,\n\"No valid data in {}\".format(sensor) if price_data is none and data == [] and valid_sensor,\n\"No valid data in provided price_data\" if price_data is not none and not valid_price_data,\n\"Time key '{}' not found in data\".format(time_key) if data and time_key not in data[0],\n\"Value key '{}' not found in data\".format(value_key) if data and value_key not in data[0],\n\"Invalid mode '{}' selected\".format(mode) if mode not in modes,\n\"Boolean input expected for include_today, '{}' can not be processed as a boolean\".format(include_today) if include_today | bool(\"\") is not boolean,\n\"Boolean input expected for include_tomorrow, '{}' can not be processed as a boolean\".format(include_tomorrow) if include_tomorrow | bool(\"\") is not boolean,\n\"Boolean input expected for look_ahead, '{}' can not be processed as a boolean\".format(look_ahead) if look_ahead | bool(\"\") is not boolean,\n\"Boolean input expected for lowest, '{}' can not be processed as a boolean\".format(lowest) if lowest | bool(\"\") is not boolean,\n\"Boolean input expected for latest_possible, '{}' can not be processed as a boolean\".format(latest_possible) if latest_possible | bool(\"\") is not boolean,\n\"Numeric input or percentage expected for price_tolerance, '{}' can not be processed as a float or percentage\".format(price_tolerance) if not valid_pt,\n\"Numeric input expected for kwh, '{}' can not be processed as a float\".format(kwh) if kwh is not none and not kwh | is_number,\n\"Selected program '{}' is not available or has no data\".format(program) if program is not none and w is none,\n\"Selected start parameter is after the end parameter\" if start_end and data,\n\"{} hours between start and end, where {} hours are required\".format(end_start, h | round(3)) if not start_end and end_start < h | round(3) and data,\n\"Invalid combination of source data points per hour '{}' and number of weight points '{}'\".format(dp, dph) if all_keys and not wp_check",
        "x": 1150,
        "y": 540,
        "wires": []
    },
    {
        "id": "1f1e3c94cb7cb585",
        "type": "function",
        "z": "43e2c4565d34c242",
        "g": "fab67345066b14d4",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1195,
        "y": 580,
        "wires": [
            [
                "016a52713f269f32"
            ]
        ],
        "l": false
    },
    {
        "id": "22b6bb41ec336a29",
        "type": "function",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Cache check",
        "func": "// Check if cache can be used or a new call to Data Source is required\nconst log = global.get('logger');\n\n// Retrieve stored data from flow context\nconst previousValues = flow.get(\"previous_sensor_values\") || {};\nconst cachedData = flow.get(\"cached_dynamic_data\");\n\n// Create a string or object to represent current state\nconst currentValues = {\n    src: msg.dynamic.data_source,\n    hc: msg.dynamic.cheapest_hrs,\n    he: msg.dynamic.expensive_hrs\n};\n\n// Compare current with previous (JSON stringify is a quick way to compare objects)\nconst inputsMatch = JSON.stringify(currentValues) === JSON.stringify(previousValues);\n\n// Determine cache hit\nif (inputsMatch && cachedData){\n    // Cache HIT\n    node.status({ fill: \"green\", shape: \"dot\", text: `Cache hit` });\n    log(this,`*CACHE HIT* using stored tariff data`);\n\n    // Attach cached data to the message so following nodes can use it\n    msg.dynamic = cachedData;\n\n    // Output #1\n    return [msg, null];\n\n} else {\n    // Cache MISS\n    node.status({ fill: \"green\", shape: \"ring\", text: `Cache miss: ${JSON.stringify(currentValues) }` });\n\n    // Save current values for the next run\n    flow.set(\"previous_sensor_values\", currentValues);\n    \n    // Output #2\n    return [null, msg];\n}",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1270,
        "y": 420,
        "wires": [
            [
                "fa3b6960bceef6ce"
            ],
            [
                "685af86a816c2521"
            ]
        ],
        "outputLabels": [
            "Cache HIT",
            "Cache MISS"
        ]
    },
    {
        "id": "fa3b6960bceef6ce",
        "type": "link out",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "from Cache Check ok",
        "mode": "link",
        "links": [
            "4c12a8b240ab8a88"
        ],
        "x": 1375,
        "y": 400,
        "wires": []
    },
    {
        "id": "25837266d45b787a",
        "type": "link in",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "link Fetch from Data Source",
        "links": [
            "685af86a816c2521"
        ],
        "x": 295,
        "y": 560,
        "wires": [
            [
                "ef1da1d3a7216433"
            ]
        ]
    },
    {
        "id": "685af86a816c2521",
        "type": "link out",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "from Cache Check NoK",
        "mode": "link",
        "links": [
            "25837266d45b787a"
        ],
        "x": 1375,
        "y": 440,
        "wires": []
    },
    {
        "id": "4c12a8b240ab8a88",
        "type": "link in",
        "z": "43e2c4565d34c242",
        "g": "ccaba979a2207c48",
        "name": "link Determine Strategy",
        "links": [
            "89c9eb1d187f7737",
            "fa3b6960bceef6ce"
        ],
        "x": 295,
        "y": 940,
        "wires": [
            [
                "e7e2014216c27578"
            ]
        ]
    },
    {
        "id": "89c9eb1d187f7737",
        "type": "link out",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "link out 12",
        "mode": "link",
        "links": [
            "4c12a8b240ab8a88"
        ],
        "x": 635,
        "y": 840,
        "wires": []
    },
    {
        "id": "a2e93b4c096f585c",
        "type": "function",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Clear Cache",
        "func": "// Clear cache\nflow.set(\"cached_dynamic_data\", undefined);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 635,
        "y": 420,
        "wires": [
            [
                "a2c606034d1f2eaa"
            ]
        ],
        "l": false
    },
    {
        "id": "af99a757b80e5498",
        "type": "ha-fire-event",
        "z": "43e2c4565d34c242",
        "g": "2b9c51b9468b61d4",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 0,
        "event": "update_energy_prices",
        "data": "msg.all_data",
        "dataType": "jsonata",
        "x": 760,
        "y": 1760,
        "wires": [
            []
        ]
    },
    {
        "id": "1d4a3f92488da986",
        "type": "api-render-template",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "All",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "",
        "resultsLocation": "dynamic.data_all",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 450,
        "y": 780,
        "wires": [
            [
                "b9a41d9435cf8abd"
            ]
        ]
    },
    {
        "id": "b9a41d9435cf8abd",
        "type": "json",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "",
        "property": "dynamic.data_all",
        "action": "obj",
        "pretty": false,
        "x": 535,
        "y": 780,
        "wires": [
            [
                "a8208c750ae4a8f5",
                "daff0725d784350d"
            ]
        ],
        "l": false
    },
    {
        "id": "0bb50184686abc06",
        "type": "change",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_all",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 780,
        "wires": [
            [
                "1d4a3f92488da986"
            ]
        ]
    },
    {
        "id": "97f82f3fae5a5912",
        "type": "ha-fire-event",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Update energy prices",
        "server": "176d29a.6f648d6",
        "version": 0,
        "event": "update_energy_prices",
        "data": "msg.dynamic.data_all",
        "dataType": "jsonata",
        "x": 860,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "1bd71d96b5e5525c",
        "type": "debug",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Template all",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_all",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 660,
        "wires": []
    },
    {
        "id": "daff0725d784350d",
        "type": "function",
        "z": "43e2c4565d34c242",
        "g": "67366e68865750d3",
        "name": "Convert price",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Conversion\nconst CONVERSION_RATE = parseFloat(RED.util.getMessageProperty(msg, \"dynamic.value_conversion\")) || 1;\n\n// Check if the list exists and is an array to prevent errors\nif (msg.dynamic && msg.dynamic.data_all && Array.isArray(msg.dynamic.data_all.list)) {\n    \n    // Create a new array where each value is multiplied\n    if (Array.isArray(msg.dynamic.data_all?.list)) {\n        msg.dynamic.data_all.list = msg.dynamic.data_all.list.map(v => v / CONVERSION_RATE * 100); // cents\n    }\n\n    // Update other fields\n    if (msg.dynamic.data_all?.average) {\n        msg.dynamic.data_all.average = parseInt(msg.dynamic.data_all.average / CONVERSION_RATE * 100); // cents\n    }\n} else {\n    // Do not continue\n    log(this,\"*price data not updated* price data missing\");\n    return null;\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 780,
        "wires": [
            [
                "97f82f3fae5a5912"
            ]
        ]
    },
    {
        "id": "e27caf3c58554974",
        "type": "inject",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 410,
        "y": 460,
        "wires": [
            [
                "e81dbb3b2450ad3a"
            ]
        ]
    },
    {
        "id": "e81dbb3b2450ad3a",
        "type": "api-call-service",
        "z": "43e2c4565d34c242",
        "g": "5b357349653af8f2",
        "name": "Debug ON",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.house_battery_control_is_debug_mode"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [
            {
                "property": "debug_mode",
                "propertyType": "global",
                "value": "true",
                "valueType": "bool"
            }
        ],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_boolean",
        "service": "turn_on",
        "x": 550,
        "y": 460,
        "wires": [
            [
                "a2e93b4c096f585c"
            ]
        ]
    },
    {
        "id": "fedca8b9c6861865",
        "type": "link in",
        "z": "5ca05ae5a089b8d2",
        "g": "c3404a37fd9ce4af",
        "name": "Full stop",
        "links": [],
        "x": 100,
        "y": 160,
        "wires": [
            [
                "86fc6690200ea1d5"
            ]
        ],
        "l": true
    },
    {
        "id": "5ac782a79cce3909",
        "type": "link out",
        "z": "5ca05ae5a089b8d2",
        "g": "807415e9b7aacdfa",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 505,
        "y": 180,
        "wires": []
    },
    {
        "id": "488bf4f7bb7829f7",
        "type": "function",
        "z": "5ca05ae5a089b8d2",
        "name": "Stop all batteries",
        "func": "// Logger\nconst log = global.get(\"logger\");\nlog(this,`full stop`);\n\n// Process\nlet solution_array = [];\n\n// Add a solution per battery\nmsg.batteries.forEach(battery => {\n    solution_array.push({ id: battery.id, \n    mode: \"stop\", // disengages Marstek Battery\n    power: 0 }); // set power to 0W\n});\n\n// OUTPUT\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "5ac782a79cce3909"
            ]
        ]
    },
    {
        "id": "b374e478ef33e8a4",
        "type": "comment",
        "z": "5ca05ae5a089b8d2",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "1dca26be7c0dd61b",
        "type": "comment",
        "z": "5ca05ae5a089b8d2",
        "g": "807415e9b7aacdfa",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 560,
        "y": 120,
        "wires": []
    },
    {
        "id": "4febdc440faf9d73",
        "type": "comment",
        "z": "5ca05ae5a089b8d2",
        "g": "c3404a37fd9ce4af",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "86fc6690200ea1d5",
        "type": "change",
        "z": "5ca05ae5a089b8d2",
        "g": "c3404a37fd9ce4af",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 200,
        "wires": [
            [
                "488bf4f7bb7829f7"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "527dbdfa3c0b7d81",
        "type": "catch",
        "z": "5ca05ae5a089b8d2",
        "g": "baecf4a2995e8afe",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 55,
        "y": 300,
        "wires": [
            [
                "dbd5b285d0e8b8d2"
            ]
        ],
        "l": false
    },
    {
        "id": "dbd5b285d0e8b8d2",
        "type": "function",
        "z": "5ca05ae5a089b8d2",
        "g": "baecf4a2995e8afe",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 105,
        "y": 300,
        "wires": [
            [
                "23b4b597108b5ea8"
            ]
        ],
        "l": false
    },
    {
        "id": "23b4b597108b5ea8",
        "type": "link out",
        "z": "5ca05ae5a089b8d2",
        "g": "baecf4a2995e8afe",
        "name": "link out 6",
        "mode": "return",
        "links": [],
        "x": 155,
        "y": 300,
        "wires": []
    },
    {
        "id": "3e88f5da0e69b42e",
        "type": "link in",
        "z": "e184a39d1337c413",
        "g": "2723688565a9c634",
        "name": "Self-consumption",
        "links": [],
        "x": 160,
        "y": 160,
        "wires": [
            [
                "2b0b72f6a6e652a6"
            ]
        ],
        "l": true
    },
    {
        "id": "c9840b5b8c7e49d7",
        "type": "comment",
        "z": "e184a39d1337c413",
        "g": "2723688565a9c634",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the Link In in this start group exactly after the option configured in your\nselect_input.house_battery_strategy\n\nfound in the file:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nWill point to the flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 150,
        "y": 120,
        "wires": []
    },
    {
        "id": "d26e930b1013bb21",
        "type": "comment",
        "z": "e184a39d1337c413",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "41747318b3f3f31d",
        "type": "server-state-changed",
        "z": "e184a39d1337c413",
        "g": "92e61a0d500abb84",
        "name": "User Ki change",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.house_battery_control_ki"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 100,
        "wires": [
            [
                "9e0bb28502245d26"
            ]
        ]
    },
    {
        "id": "9e0bb28502245d26",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "92e61a0d500abb84",
        "name": "Integral term adjust",
        "func": "// On change of Ki setting\nlet logdata = \"bumpless \";\nlet I_sum = flow.get(\"I_integral_sum\");\nlet Ki = msg.payload || 0;     // Integral gain\nlet Ki_last = context.get(\"house_battery_control_ki_last\")||0;\n\n// if Ki was or has become zero\nif(Ki == 0 || Ki_last == 0){\n    // passify the integral-sum\n    flow.set(\"I_integral_sum\",0);\n    context.set(\"house_battery_control_ki_last\", Ki);\n    logdata += `to/from 0, Ki=${Ki_last} -> ${Ki} | `;\n    // done\n    return { payload: logdata };\n}\n\n// change in Ki\nlet dKi = parseFloat(Ki/Ki_last);\nif(dKi <= 0) dKi = 1; // ignore erroneous changes\n\n// keep I-term constant by compensating the integral-sum for the change in Ki\n// e.g. if Ki got 10% smaller, then integral-sum should increase 10%, to keep the I-term constant\nlet I_sum_new = I_sum / dKi;\nlogdata += `change of I: from ${Ki_last} to ${Ki} (${dKi * 100}%) | `;\n\n// OUTFLOW\nflow.set(\"I_integral_sum\", I_sum_new);\ncontext.set(\"house_battery_control_ki_last\", Ki);\n\n// OUTPUT\nreturn { payload: logdata };",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\n// init last state\nlet Ki = flow.get(\"house_battery_control_ki\") || 0;\ncontext.set(\"house_battery_control_ki_last\", Ki);",
        "finalize": "",
        "libs": [],
        "x": 1730,
        "y": 160,
        "wires": [
            [
                "a512c47ab67139c1"
            ]
        ]
    },
    {
        "id": "33ecc7bc513540ea",
        "type": "comment",
        "z": "e184a39d1337c413",
        "g": "92e61a0d500abb84",
        "name": "Bumpless Ki changes",
        "info": "Recalc I-term whenever Ki changes\n\nNote: always be mindful of making changes to control parameters of systems in operation.",
        "x": 1740,
        "y": 60,
        "wires": []
    },
    {
        "id": "a512c47ab67139c1",
        "type": "debug",
        "z": "e184a39d1337c413",
        "g": "92e61a0d500abb84",
        "name": "Logdata",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1700,
        "y": 220,
        "wires": []
    },
    {
        "id": "b99d192bd81adb9c",
        "type": "switch",
        "z": "e184a39d1337c413",
        "g": "489c527c7313abfc",
        "name": "Check for custom/auto mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Manual control",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Marstek control",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1855,
        "y": 520,
        "wires": [
            [
                "0fd4752631dcec3a",
                "cd2ae66170b830ae"
            ],
            [
                "0fd4752631dcec3a",
                "cd2ae66170b830ae"
            ],
            [
                "cd2ae66170b830ae"
            ]
        ],
        "l": false
    },
    {
        "id": "cd2ae66170b830ae",
        "type": "debug",
        "z": "e184a39d1337c413",
        "g": "489c527c7313abfc",
        "name": "Master control switch",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2060,
        "y": 520,
        "wires": []
    },
    {
        "id": "7ce8c913944fc7cc",
        "type": "server-state-changed",
        "z": "e184a39d1337c413",
        "g": "489c527c7313abfc",
        "name": "Master control mode",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1730,
        "y": 520,
        "wires": [
            [
                "b99d192bd81adb9c"
            ]
        ]
    },
    {
        "id": "34e4aaedcf1d736b",
        "type": "api-call-service",
        "z": "e184a39d1337c413",
        "g": "489c527c7313abfc",
        "name": "Integral PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_i_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2050,
        "y": 360,
        "wires": [
            [
                "9deda6a4d55421d3"
            ]
        ]
    },
    {
        "id": "9deda6a4d55421d3",
        "type": "api-call-service",
        "z": "e184a39d1337c413",
        "g": "489c527c7313abfc",
        "name": "Differential PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_d_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2060,
        "y": 400,
        "wires": [
            [
                "2a2b58a2598e4907"
            ]
        ]
    },
    {
        "id": "0fd4752631dcec3a",
        "type": "api-call-service",
        "z": "e184a39d1337c413",
        "g": "489c527c7313abfc",
        "name": "Proportinal PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_p_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2060,
        "y": 320,
        "wires": [
            [
                "34e4aaedcf1d736b"
            ]
        ]
    },
    {
        "id": "2a2b58a2598e4907",
        "type": "api-call-service",
        "z": "e184a39d1337c413",
        "g": "489c527c7313abfc",
        "name": "PID Output to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2050,
        "y": 440,
        "wires": [
            [
                "d825c145ae53c8e3"
            ]
        ]
    },
    {
        "id": "d825c145ae53c8e3",
        "type": "change",
        "z": "e184a39d1337c413",
        "g": "489c527c7313abfc",
        "name": "Integral sum to zero",
        "rules": [
            {
                "t": "set",
                "p": "I_integral_sum",
                "pt": "flow",
                "to": "0",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2060,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "7913d5674b438fab",
        "type": "api-current-state",
        "z": "e184a39d1337c413",
        "g": "286f10603840ceb3",
        "name": "Target grid consumption",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_target_grid_consumption_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_target_grid_consumption_in_w",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 120,
        "wires": [
            [
                "77234f588c6afaf4"
            ]
        ],
        "info": "Set at 0 to strive for zero consumption"
    },
    {
        "id": "dd5f97660464a511",
        "type": "api-current-state",
        "z": "e184a39d1337c413",
        "g": "40f615ce16c4b2e1",
        "name": "Hysteresis",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_hysteresis_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_hysteresis_in_w",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1010,
        "y": 120,
        "wires": [
            [
                "249d2299dc07a4c6"
            ]
        ]
    },
    {
        "id": "16cd178b1d21594b",
        "type": "api-current-state",
        "z": "e184a39d1337c413",
        "g": "286f10603840ceb3",
        "name": "PID P-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_kp",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_kp",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 410,
        "y": 180,
        "wires": [
            [
                "92e069c4fc3861e3"
            ]
        ]
    },
    {
        "id": "92e069c4fc3861e3",
        "type": "api-current-state",
        "z": "e184a39d1337c413",
        "g": "286f10603840ceb3",
        "name": "PID I-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_ki",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_ki",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 590,
        "y": 180,
        "wires": [
            [
                "d59f5a16ea57793f"
            ]
        ]
    },
    {
        "id": "d59f5a16ea57793f",
        "type": "api-current-state",
        "z": "e184a39d1337c413",
        "g": "286f10603840ceb3",
        "name": "PID D-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_kd",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_kd",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 770,
        "y": 180,
        "wires": [
            [
                "683d4daf39f4e598"
            ]
        ]
    },
    {
        "id": "249d2299dc07a4c6",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "40f615ce16c4b2e1",
        "name": "Advanced settings",
        "func": "// 1. Hard coded advanced settings (flow level)\nflow.set(\"has_soc_charging_limiter\", true);         // slows charging from 90% to 100% to improve battery life\nflow.set(\"has_reverse_priority_discharge\", true);   // Prioritize discharging and charging the same battery when possible\nflow.set(\"master_gain\", 1);                         // Gain scheduling. Not Implemented!\n\n// 2. Configurable advanced settings (msg level)\nmsg.advanced_settings ||= {}; // creates 'advanced_settings' if it does net yet exist\nlet mas = msg.advanced_settings;\n\n// disable charge or dicharge solutions and changes them to stop solutions\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\", mas.discharge_disabled ?? false);\nRED.util.setMessageProperty(msg,\"advanced_settings.charge_disabled\", mas.charge_disabled ?? false);\n// The nullish coalescing (??) operator is a logical operator that returns its right-hand side operand when its left-hand side operand is null or undefined\n\n// 3. continue\nreturn msg;\n\n// Notes for home battery tinkerer friends:\n// Using RED.util.getMessageProperty / RED.util.setMessageProperty is more performant and safe.\n// If any part of the path (\"foo.bar\") is missing, it will return 'undefined' without throwing an error.",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1030,
        "y": 180,
        "wires": [
            [
                "72e3f43085489268"
            ]
        ]
    },
    {
        "id": "683d4daf39f4e598",
        "type": "api-current-state",
        "z": "e184a39d1337c413",
        "g": "40f615ce16c4b2e1",
        "name": "Idle time before Stop",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_idle_time",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "idle_time_minutes",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1040,
        "y": 80,
        "wires": [
            [
                "dd5f97660464a511"
            ]
        ]
    },
    {
        "id": "af966047935faa0d",
        "type": "comment",
        "z": "e184a39d1337c413",
        "g": "a53fb0a853ac670a",
        "name": "Setpoint ramping / damping",
        "info": "",
        "x": 460,
        "y": 460,
        "wires": []
    },
    {
        "id": "72e3f43085489268",
        "type": "api-current-state",
        "z": "e184a39d1337c413",
        "g": "a53fb0a853ac670a",
        "name": "Error signal dampening",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_error_signal_dampening",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_error_signal_dampening",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 340,
        "wires": [
            [
                "13eb9c583fc3cfdd"
            ]
        ]
    },
    {
        "id": "13eb9c583fc3cfdd",
        "type": "api-current-state",
        "z": "e184a39d1337c413",
        "g": "a53fb0a853ac670a",
        "name": "Output signal dampening",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_pid_output_dampening",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_pid_output_dampening",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 380,
        "wires": [
            [
                "0e2a5f169f67e8a3"
            ]
        ]
    },
    {
        "id": "0e2a5f169f67e8a3",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "a53fb0a853ac670a",
        "name": "Set: Error signal",
        "func": "// INPUTS\nlet P1_error_last = Number(context.get(\"p1_error_last\"))||0; // last error signal level in W\nlet dampening = Number(flow.get(\"house_battery_control_error_signal_dampening\")) || 0; // 0% - 100%\ndampening = dampening / 100; // to Number\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = Number(RED.util.getMessageProperty(msg,\"house_target_grid_consumption_in_w\")); // SP: target value\n\n// Calc error signal\nlet P1_error_unfiltered = P1_setpoint - P1_power;\n\n// Simple averaging filter\nlet P1_error_filtered = (1 - dampening) * P1_error_unfiltered + (dampening) * P1_error_last;\n\n// OUTFLOW\ncontext.set(\"p1_error_last\", P1_error_filtered);\n\n// OUTPUT\nmsg.grid_error = P1_error_filtered; // W (watt), error signal = SP - PV\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 420,
        "wires": [
            [
                "5f0c4cdaaabbc848"
            ]
        ]
    },
    {
        "id": "af60facf037aa8b5",
        "type": "comment",
        "z": "e184a39d1337c413",
        "g": "9cae1e81780f6ce0",
        "name": "Bumpless target grid consumption",
        "info": "The error value is used by default to calculate the derivative.\nWhen the target grid consumption (tgc) is changed, the system is takes the derivative of the process variable instead.\nThis prevents irratic behavior during sudden changes of the error or setpoint value.\n\ne.g. you change the setpoint from 0 to 100W \nThe error would make an instantanious jump and cause a huge derivative-term.\nThe pv stays continous and fluent.\n\nAfter 1 control tick the derivative is taken from error again.\nUntil the `tgc` is changed again.",
        "x": 780,
        "y": 440,
        "wires": []
    },
    {
        "id": "0b8a2a11d42eb8a6",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "9cae1e81780f6ce0",
        "name": "Derivative PV",
        "func": "var P1_power = msg.grid_power||0;\nvar P1_last_power = Number(context.get(\"p1_last_power\")) ||0;\n\n// PV derivative\nvar p1_derivative = P1_power - P1_last_power; // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_power\", P1_power);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 500,
        "wires": [
            [
                "beecf72a05a8eaee"
            ]
        ]
    },
    {
        "id": "1265f27ede4ef136",
        "type": "switch",
        "z": "e184a39d1337c413",
        "g": "9cae1e81780f6ce0",
        "name": "Target grid consumption unchanged",
        "property": "house_target_grid_consumption_in_w",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "",
                "vt": "prev"
            },
            {
                "t": "neq",
                "v": "",
                "vt": "prev"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 780,
        "y": 480,
        "wires": [
            [
                "390f41c303dfa5dd"
            ],
            [
                "0b8a2a11d42eb8a6"
            ]
        ]
    },
    {
        "id": "390f41c303dfa5dd",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "9cae1e81780f6ce0",
        "name": "Derivative Error",
        "func": "var P1_error = msg.grid_error||0;\nvar P1_last_error = Number(context.get(\"p1_last_error\")) ||0;\n\n// Error derivative\n// note: error = -PV\n// note: for simplicity we assume 1 second time steps\nlet p1_derivative = -(P1_error - P1_last_error); // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_error\", P1_error);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 460,
        "wires": [
            [
                "beecf72a05a8eaee"
            ]
        ]
    },
    {
        "id": "beecf72a05a8eaee",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "9cae1e81780f6ce0",
        "name": "Derivative final value",
        "func": "\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1240,
        "y": 480,
        "wires": [
            [
                "4a535ea5b5d712c7"
            ]
        ]
    },
    {
        "id": "5f0c4cdaaabbc848",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "ed840ffedfca971b",
        "name": "Deadband (15W)",
        "func": "// Deadband\n// Stop processing if error is within .. Watt of target grid consumption.\n// This to reduce CPU loads \n\n// Logger\nconst log = global.get(\"logger\");\n\n// P1\nlet P1_error = msg.grid_error; // Watt\nlet P1_deadband = 15; // Watt\n\n// TODO\n// based on last 'assignable power' and current error, if (error > assignable power) the system will never enter the deadband. And keep calculating each interation.\n// however since we don't know if the is the assignable power will change, until we calculate the Control Value / load balancer\n// we could end up in a deadlock if we simply stop execution here, based on assignable power alone.\n\n// Within Deadband\nif(Math.abs(P1_error) < P1_deadband) {\n    // stop processing\n    node.status({fill:\"yellow\",shape:\"dot\",text:`Halt, ${Math.round(Math.abs(P1_error))} W`});\n    log(this, `**Stopped processing** power saving, ${Math.round(Math.abs(P1_error))} W is within deadband of ${P1_deadband} W`);\n    msg.payload = 'halted by deadband';\n    return msg;\n} \n\n// Outside deadband\nnode.status({fill:\"green\",shape:\"dot\",text:`Pass, ${Math.round(Math.abs(P1_error))} W`});\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 340,
        "wires": [
            [
                "6ffae2de520d2ae0"
            ]
        ]
    },
    {
        "id": "4a535ea5b5d712c7",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "Calculate corrections",
        "func": "// Logger\nvar logdata = \"\"; // deprecated\nconst log = global.get(\"logger\");\n\n// Timing\nlet time_last = context.get('time_last') || Date.now(); // Milliseconds\nlet time_current = Date.now(); // Milliseconds\nlet time_delta = (time_current - time_last) / 1000; // Convert to seconds\n// note: due to inherent 1 sec intervals of P1 meter we omit dt terms. This is mostly for bug checking and optimizations.\n\n// Batteries\nvar B_power = msg.batteries_total_power; // charging is positive, discharging negative\nvar anti_windup_threshold = Number(flow.get(\"batteries_total_assignable_power\")) || 0; // max available charge/discharge power.\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = flow.get(\"house_target_grid_consumption_in_w\"); // SP: target value\nvar P1_error = msg.grid_error;  // W (watt), error signal = SP - PV\nvar P1_derivative = msg.grid_derivative; // Derivative of PV, not the error\n\n// PID values\nvar Kp = flow.get(\"house_battery_control_kp\") || 0.75;  // Proportional gain\nvar Ki = flow.get(\"house_battery_control_ki\") || 0;     // Integral gain        Ki = Kp/Ti\nvar Kd = flow.get(\"house_battery_control_kd\") || 0;     // Derivative gain      Kd = Kp*Td\n\n// helpers\nvar I_integral_sum = context.get('I_integral_sum') || 0;\nvar Gm = flow.get(\"master_gain\")||1; // gain scheduling\n\n// optimizations\nvar hysteresis = flow.get(\"house_battery_control_hysteresis_in_w\"); // W (watt)\n\n// advanced settings\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\");\nconst isChargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.charge_disabled\");\n\n// -- PID regulator --\n// Proportional term\nlet p_term = Gm * Kp * P1_error;\n\n// Integral term\nlet integral_max = 0;\nif (Ki > 0) {\n    // Integral term | integrate\n    I_integral_sum += P1_error; \n    // Integral term | apply anti-windup\n    integral_max = anti_windup_threshold / Ki; // the anti-windup value is set to the current controlable range of the batteries, given by the previous load balancer calculations\n    I_integral_sum = Math.min(Math.max(I_integral_sum, -integral_max), integral_max);\n} else {\n    // If Ki is 0, keep everything 0\n    I_integral_sum = 0;\n    integral_max = 0;\n}\n\n// Integral term | the term\nlet i_term = Ki * I_integral_sum;\n\n// Integral term | explain\nlogdata += `anti_windup_threshold=${anti_windup_threshold}, integral_max=${integral_max}| `; // deprecated\n\n// Differential term\nlet d_term = Gm * Kd * (-P1_derivative); // omitted '/time_delta'. inherent P1 refresh fequency.\n\n// Total PID output\nvar PID_output = p_term + i_term + d_term; // W (watt), the control input for the battery packs\n\n// Charging or Discharging states\nvar B_was_charging = context.get(\"batteries_charging_last\") || false;\nvar B_is_charging = PID_output > 0 ? true : false;\n\n// Explain\nlogdata += `U(${time_delta}s)[${PID_output}] = P(${Kp})[${p_term}] + I(${Ki})[${i_term}] + D(${Kd})[${d_term}] | `; // deprecated\nlog(this,`**PID Controller**`);\nlog(this,`Step size: ${time_delta} s`);\nif(Kp == 0 && Ki == 0 && Kd == 0) {\n    log(this, `<font color=\"orange\">**Controller disabled**</font> All PID gains are 0. Choose a PID preset or set gains > 0.`,\"warn\");\n} else {\n    log(this, `P-term: ${Math.floor(p_term)} W @ P-gain ${Kp}`);\n    log(this, `I-term: ${Math.floor(i_term)} W @ I-gain ${Ki} (max. ${anti_windup_threshold} W)`);\n    log(this, `D-term: ${Math.floor(d_term)} W @ D-gain ${Kd}`);\n    log(this, `**PID ${B_is_charging ? 'Charge' : 'Discharge'}:** ${Math.floor(p_term)} + ${Math.floor(i_term)} + ${Math.floor(d_term)} = **${Math.round(PID_output)} Watt**`);\n}\n\n// Only one of the advanced settings below can be active at once.\n// Advanced setting | discharge disabled\nif(isDischargeDisabled && !B_is_charging) {\n    // log explain\n    logdata += `Discharging disabled, PID unwound U(${time_delta})[0]=0+0+0 | `;\n    log(this,'**PID set to 0**. Discharge was disabled via `msg.advanced_settings`.');\n    // Set all PID terms to 0 and unwind integral sum\n    PID_output = 0;\n    p_term = 0;\n    i_term = 0;\n    d_term = 0;\n    I_integral_sum = 0; // unwind\n    // maintain charge scenario\n    B_is_charging = true;\n    \n// Advanced setting | charge disabled\n} else if (isChargeDisabled && B_is_charging) {\n    // log explain\n    logdata += `Charging disabled, PID unwound U(${time_delta})[0]=0+0+0 | `;\n    log(this,'**PID set to 0**. Charge was disabled via `msg.advanced_settings`.');\n    // Set all PID terms to 0 and unwind integral sum\n    PID_output = 0;\n    p_term = 0;\n    i_term = 0;\n    d_term = 0;\n    I_integral_sum = 0; // unwind\n    // maintain discharge scenario\n    B_is_charging = false;\n\n// Advanced setting | hysteresis\n} else if \n// prevents excessive switching between (dis)charge mode around the zero point.\n// if new PID_output lies within hysteresis, it will not switch charge mode. \n// set hysteresis to 0, to apply no hysteresis\n(B_is_charging !== B_was_charging && Math.abs(PID_output) < hysteresis){\n    // log explain\n    logdata += `Hysteresis prevented charge mode switch from ${B_was_charging ? \"charging\" : \"discharging\"} to ${B_is_charging ? \"charging\" : \"discharging\"} as ${Math.abs(PID_output)}W <= ${hysteresis}(hyst) | `;\n    log(this,`Hysteresis prevented charge mode switch from ${B_was_charging ? \"charging\" : \"discharging\"} to ${B_is_charging ? \"charging\" : \"discharging\"} as ${Math.abs(PID_output)}W <= ${hysteresis}(hyst)`);\n    // prevent negative charging or positive discharging values (not allowed)\n    PID_output = (PID_output < 0 && B_is_charging) || ((PID_output > 0 && !B_is_charging)) ? 0 : PID_output;\n    // maintain previous scenario\n    B_is_charging = B_was_charging;\n} \n\n// save for next iteration\ncontext.set(\"batteries_charging_last\", B_is_charging); //boolean\n\n// OUTFLOW\ncontext.set(\"time_last\", Date.now());\ncontext.set(\"I_integral_sum\", I_integral_sum);\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_charging\", B_is_charging, true);\nRED.util.setMessageProperty(msg, \"I_integral_sum\", I_integral_sum,true);\nmsg.payload = Number(PID_output);\n\n\nreturn [msg, // payload = PID_output\n        { payload: Number(P1_error)},\n        { payload: parseFloat(p_term)},\n        { payload: parseFloat(i_term)},\n        { payload: parseFloat(d_term)},\n        { payload: B_is_charging},\n        { payload: logdata }];",
        "outputs": 7,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 700,
        "wires": [
            [
                "cea41ec36a638d36"
            ],
            [
                "816fd55c2a6c9da0"
            ],
            [
                "6222f1affee6e1d3"
            ],
            [
                "1b5abf7326e94e89"
            ],
            [
                "6cb5f9c415ad542c"
            ],
            [
                "54eeded097177b56"
            ],
            [
                "eecf5f770104b73e"
            ]
        ],
        "inputLabels": [
            "battery_array"
        ]
    },
    {
        "id": "eecf5f770104b73e",
        "type": "debug",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "Logdata",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 1060,
        "wires": []
    },
    {
        "id": "816fd55c2a6c9da0",
        "type": "api-call-service",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "Error Signal",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_signal"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 730,
        "y": 760,
        "wires": [
            [
                "507c788f0acbdf5c"
            ]
        ]
    },
    {
        "id": "57b1e671994ce79a",
        "type": "api-call-service",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "PID Output",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 730,
        "y": 700,
        "wires": [
            [
                "2bdc609a4d5236ab"
            ]
        ]
    },
    {
        "id": "d6af403451692bb1",
        "type": "api-call-service",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "Proportinal term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_p_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 920,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "c5c81b813bef18ee",
        "type": "api-call-service",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "Integral term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_i_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 910,
        "y": 880,
        "wires": [
            []
        ]
    },
    {
        "id": "13cedb5ac2c99528",
        "type": "api-call-service",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "Differential term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_d_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 920,
        "y": 940,
        "wires": [
            []
        ]
    },
    {
        "id": "12445fefbe81761d",
        "type": "debug",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "Charging",
        "active": false,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 900,
        "y": 1060,
        "wires": []
    },
    {
        "id": "2bdc609a4d5236ab",
        "type": "smooth",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "",
        "property": "payload",
        "action": "sd",
        "count": "8",
        "round": "",
        "mult": "single",
        "reduce": false,
        "x": 900,
        "y": 700,
        "wires": [
            [
                "df2b5ebb83debc1b"
            ]
        ]
    },
    {
        "id": "df2b5ebb83debc1b",
        "type": "api-call-service",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "PID deviation",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output_deviation"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1070,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "507c788f0acbdf5c",
        "type": "smooth",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "",
        "property": "payload",
        "action": "sd",
        "count": "8",
        "round": "",
        "mult": "single",
        "reduce": false,
        "x": 900,
        "y": 760,
        "wires": [
            [
                "a401c28b2f97d446"
            ]
        ]
    },
    {
        "id": "a401c28b2f97d446",
        "type": "api-call-service",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "Error deviation",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_deviation"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1080,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "cea41ec36a638d36",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "Output dampening",
        "func": "// INPUT\nlet PID_unfiltered = msg.payload; // W Watt\nlet PID_last = context.get(\"PID_last\")||0; // W watt\nlet PID_damp = Number(flow.get(\"house_battery_control_pid_output_dampening\"))||0; // 0% - 100%\nPID_damp = PID_damp/100; // to Number\n\n// simple averaging filter\nlet PID_filtered = (1-PID_damp)*PID_unfiltered + (PID_damp)*PID_last;\n\n// OUTFLOW\ncontext.set(\"PID_last\", PID_filtered);\n\n// OUTPUT\nmsg.payload = Number(PID_filtered)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 660,
        "wires": [
            [
                "643312ca6cafd95c"
            ]
        ]
    },
    {
        "id": "643312ca6cafd95c",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "Output failsafe",
        "func": "// INFLOW\nlet maxCharge = msg.batteries_max_charge_power||undefined;\nlet maxDischarge = msg.batteries_max_discharge_power||undefined;\nlet isCharging = msg.batteries_charging||undefined;\nlet PID_output = msg.payload; // Watt\n\n// No failsafe\nif (maxCharge === undefined || maxDischarge == undefined) {\n    node.status({ fill: \"red\", shape: \"dot\", text: \"disabled\" });\n    node.warn(`Output Failsafe is INACTIVE. Max charge or discharge limits are undefined`);\n    // continue without safeguard\n    return msg;\n} \n\n// limit\nlet limit = 0;\n\n// charging state unknown\nif(isCharging === undefined) {\n    // limit on lowest of charge / discharge\n    limit = Math.min(maxCharge,maxDischarge);    \n}\n// charging state known\nlimit = isCharging ? maxCharge : maxDischarge;\n\n// Safe output\nif (PID_output <= limit){\n    node.status({ fill: \"green\", shape: \"dot\", text: \"safe\" });\n    return msg;\n} \n\n// Unsafe, limit output\nnode.status({ fill: \"yellow\", shape: \"ring\", text: \"power limiting\" });\nmsg.payload = Number(limit);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1080,
        "y": 660,
        "wires": [
            [
                "5d6112b5e9fa0f62",
                "57b1e671994ce79a"
            ]
        ]
    },
    {
        "id": "1b5abf7326e94e89",
        "type": "rbe",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 880,
        "wires": [
            [
                "c5c81b813bef18ee"
            ]
        ]
    },
    {
        "id": "5d6112b5e9fa0f62",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "adda2ff093095af5",
        "name": "Load distribution",
        "func": "// Logger\nconst log = global.get(\"logger\");\nlog(this,\"**PID load distribution**\");\n\n// INPUT\nvar batteries = msg.batteries; // Battery configuration as provided by `Home Batteries IO` flow\nvar isCharging = msg.batteries_charging; // Are we in a battery charging scenario?\nvar hasChargingLimiter = flow.get(\"has_soc_charging_limiter\") || false; // Battery life improvement\nvar hasReverseDischargePriority = flow.get(\"has_reverse_priority_discharge\") || false; // Prioritize (dis)charging the same battery\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\"); // Disallow discharging?\n\n// how much power do the batteries need to compensate?\nvar unassigned_power = Math.round(Math.abs(msg.payload)); // Power in W to compensate using batteries\nlog(this,`How much power do the batteries need to compensate: ${unassigned_power} W`);\n\n// inits \nvar solution_array = []; // load distribution solutions\nvar batteries_total_assignable_power = 0; // Current max. available total (dis)charge power. Exceeding this max should trigger the anti-windup routine for the Integral terms\n\n// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n/**\n** Battery life improvement (slow charge near max SoC)\n* @param {number} soc\n* @param {number} max_power\n*/\nfunction chargingLimiter(soc, max_power) {\n    // Must be greater than zero\n    let limitedPower = Math.max(0, max_power); \n\n    // Limit charge at high SoC\n    if (hasChargingLimiter) {\n        if (soc >= 98)      limitedPower = Math.min(300, limitedPower);\n        else if (soc >= 95) limitedPower = Math.min(500, limitedPower);\n        else if (soc >= 85) limitedPower = Math.min(1500, limitedPower);\n    }\n    return limitedPower;\n}\n\n/**\n* battery life improvement (disconnects battery only if the battery is not used for ... seconds)\n* @param {string | number} batteryID\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getStopSolution(batteryID) {\n    // idle time, before stop is given to inverter relay.\n    let time_idle_minimum = flow.get(\"idle_time_minutes\")*60*1000||0; // Milliseconds\n\n    // retrieve last registered active times for each battery based on their ids\n    let lasttime_active = context.get(\"lasttime_active\");\n    \n    // battery exists in register \n    if(lasttime_active[batteryID] !== undefined){\n        // timing\n        let time_last = lasttime_active[batteryID]; // Milliseconds \n        let time_now = Date.now();                  // Milliseconds \n        let time_idle = (time_now - time_last); // Milliseconds\n        \n        // battery is ready for STOP\n        if (time_idle >= time_idle_minimum) {\n            log(this,`Battery ${batteryID} [STOP]: 0 Watt and disconnect relay.`);\n            return {id: batteryID, mode: CMODE.STOP, power:0}; // STOP or 0 Watt disconnects relay\n        }\n        \n        // battery is kept IDLE, while awaiting minimum inactive time\n        log(this,`Battery ${batteryID} [IDLE]: 1 Watt for ${Math.round((time_idle_minimum-time_idle)/1000)}s. Keep relay engaged.`);\n        return { id: batteryID, mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE, power: 1 }; // 1 Watt keeps battery IDLE, keeping relay engaged\n    }\n\n    // battery missing in register\n    log(this,`Battery ${batteryID} [IDLE]: unknown last active time`);\n    return getActiveSolution(batteryID, 1); // set a last active time and engage idle state\n}\n\n/**\n* Get battery solution and register a last active time.\n* @param {any} batteryID\n* @param {number} assigned_power\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getActiveSolution(batteryID, assigned_power){\n    // register battery as active\n    let lasttime_active = context.get(\"lasttime_active\")||[]; // last registered active times for each battery based on their ids\n    lasttime_active[batteryID] = Date.now();\n    context.set(\"lasttime_active\", lasttime_active);\n\n    // solution\n    return {\n        id: batteryID,\n        mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE,\n        power: Math.round(assigned_power)\n    };\n}\n\n// -- BATTERY DISCHARGE PRIORITY\nif (!isCharging && hasReverseDischargePriority) {\n   batteries.reverse();\n}\n\n// -- LOAD BALANCER --\nbatteries.forEach((/** @type {{ id: any; soc: number; soc_min: number; soc_max: number; rs485: string; charging_max: number; discharging_max: any; }} */ battery) => {\n    \n    // Explain\n    log(this, `Battery ${battery.id}: ${battery.soc}% (min: ${battery.soc_min}%, max: ${battery.soc_max}%) ; RS485: ${battery.rs485=='enable'?'OK':'Nok'}`);\n\n    // track if the battery should be skipped and why\n    let skipReason = null;\n    if (battery.rs485 !== \"enable\") {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because RS485 is not 'enable'`;\n    } else if (isCharging && battery.soc >= battery.soc_max) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because SoC (${battery.soc}%) >= Max (${battery.soc_max}%) while charging`;\n    } else if (!isCharging && battery.soc <= battery.soc_min) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because SoC (${battery.soc}%) <= Min (${battery.soc_min}%) while discharging`;\n    } else if (!isCharging && isDischargeDisabled) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped, discharging was disabled via msg property`;\n    }\n\n    // battery NOT AVAIABLE, skip via soft stop\n    if (skipReason !== null) {\n        log(this, skipReason);                      // communicate reason\n        let solution = getStopSolution(battery.id); // get a soft stop solution for this battery\n        solution_array.push(solution);              // add solution, do not update last active time.\n        // next battery\n        return; \n    }\n\n    // battery is AVAILABLE, assign power\n    let battery_assignable_power = isCharging ? chargingLimiter(battery.soc, battery.charging_max) : battery.discharging_max;\n    let assign = Math.min(unassigned_power, battery_assignable_power);\n    \n    // select solution\n    var solution;\n    if (assign <= 0 ) {\n        // no power solution\n        solution = getStopSolution(battery.id); // a soft stop solution\n        assign = 0;\n    } else {\n        // assigned power solution\n        solution = getActiveSolution(battery.id, Math.round(assign));\n    }\n    solution_array.push(solution);\n    \n    // Explain: charge limiting\n    if(unassigned_power > battery_assignable_power && battery_assignable_power < battery.charging_max) {\n        log(this,`Charging limited to protect battery (${battery.soc}%): ${battery.charging_max}W -> ${battery_assignable_power}W`);\n    }\n    // Explain: solution result\n    log(this, `<font color=\"#009ac7\">Battery ${solution.id}</font>: assigned to ${solution.mode} with ${solution.power}W / ${isCharging ? battery.charging_max : battery.discharging_max }W max.`)\n\n    // remaining power to assign\n    unassigned_power -= assign;\n    batteries_total_assignable_power += Number(battery_assignable_power);\n});\n\n// battery discharge priority - put solutions back in initial order\nif (!isCharging && hasReverseDischargePriority) {\n    solution_array.reverse();\n}\n\n// store solutions in msg\nRED.util.setMessageProperty(msg, \"solutions\", solution_array,true);\n\n// OUTFLOW\nflow.set(\"batteries_total_assignable_power\", batteries_total_assignable_power); // this is set for the anti-windup calculation in the earlier 'calculate corrections' node, which will pick this up during next iteration.\n\n// OUTPUT\nreturn msg; // to Home Battery flow",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\ncontext.set(\"lasttime_active\",[]);",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 1160,
        "wires": [
            [
                "613b62b398624e27",
                "f6226c2306ee9ee8"
            ]
        ],
        "inputLabels": [
            "isCharging (boolean)"
        ]
    },
    {
        "id": "613b62b398624e27",
        "type": "debug",
        "z": "e184a39d1337c413",
        "g": "adda2ff093095af5",
        "name": "Load distribution",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "solutions",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 1160,
        "wires": []
    },
    {
        "id": "6ffae2de520d2ae0",
        "type": "switch",
        "z": "e184a39d1337c413",
        "g": "ed840ffedfca971b",
        "name": "Pass or Halt",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "halted by deadband",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "halted by deadband",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 340,
        "wires": [
            [
                "0a39a237120c812e"
            ],
            [
                "1265f27ede4ef136"
            ]
        ]
    },
    {
        "id": "f6226c2306ee9ee8",
        "type": "link out",
        "z": "e184a39d1337c413",
        "g": "0d6f19cec0c5c388",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 225,
        "y": 1240,
        "wires": []
    },
    {
        "id": "313746f89f906284",
        "type": "comment",
        "z": "e184a39d1337c413",
        "g": "0d6f19cec0c5c388",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 170,
        "y": 1180,
        "wires": []
    },
    {
        "id": "0a39a237120c812e",
        "type": "link out",
        "z": "e184a39d1337c413",
        "g": "ed840ffedfca971b",
        "name": "go to End",
        "mode": "link",
        "links": [
            "21acb676497f2452"
        ],
        "x": 1090,
        "y": 340,
        "wires": [],
        "inputLabels": [
            "Halt"
        ],
        "l": true
    },
    {
        "id": "21acb676497f2452",
        "type": "link in",
        "z": "e184a39d1337c413",
        "g": "0d6f19cec0c5c388",
        "name": "link to End",
        "links": [
            "0a39a237120c812e"
        ],
        "x": 105,
        "y": 1240,
        "wires": [
            [
                "f6226c2306ee9ee8"
            ]
        ]
    },
    {
        "id": "5c06841b47b468a5",
        "type": "api-call-service",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "Is charging",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "",
        "service": "",
        "x": 1070,
        "y": 1000,
        "wires": [
            []
        ]
    },
    {
        "id": "f20e44649ce394bd",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "Config action",
        "func": "const value = msg.payload;\nconst target = \"input_boolean.house_battery_control_is_charging\";\n\nmsg.payload = {\n    \"action\": value?\"input_boolean.turn_on\":\"input_boolean.turn_off\",\n    \"target\": {\n        \"entity_id\": [target]\n    },\n    \"data\": {}\n}\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 1000,
        "wires": [
            [
                "5c06841b47b468a5"
            ]
        ]
    },
    {
        "id": "9e94ec0db734b8ef",
        "type": "switch",
        "z": "e184a39d1337c413",
        "g": "286f10603840ceb3",
        "name": "Target",
        "property": "house_target_grid_consumption_in_w",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 390,
        "y": 120,
        "wires": [
            [
                "7562b977cfd31aa3"
            ],
            [
                "7913d5674b438fab"
            ]
        ]
    },
    {
        "id": "cfe162e53efce392",
        "type": "debug",
        "z": "e184a39d1337c413",
        "g": "286f10603840ceb3",
        "name": "Target",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "house_target_grid_consumption_in_w",
        "targetType": "msg",
        "statusVal": "house_target_grid_consumption_in_w",
        "statusType": "auto",
        "x": 790,
        "y": 100,
        "wires": []
    },
    {
        "id": "49508ff3632a4d89",
        "type": "server-state-changed",
        "z": "e184a39d1337c413",
        "g": "489c527c7313abfc",
        "name": "Strategy changes",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_text.house_battery_strategy_active_sub_strategy",
                "input_select.house_battery_strategy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 340,
        "wires": [
            [
                "267cf0b23eb8b5ba"
            ]
        ]
    },
    {
        "id": "267cf0b23eb8b5ba",
        "type": "switch",
        "z": "e184a39d1337c413",
        "g": "489c527c7313abfc",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full stop",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1855,
        "y": 340,
        "wires": [
            [
                "0fd4752631dcec3a"
            ]
        ],
        "l": false
    },
    {
        "id": "d304d131cf82b6e5",
        "type": "server-state-changed",
        "z": "e184a39d1337c413",
        "g": "489c527c7313abfc",
        "name": "Full stop trigger",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.ev_is_charging"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 420,
        "wires": [
            [
                "b22c73b405d4e045"
            ]
        ]
    },
    {
        "id": "b22c73b405d4e045",
        "type": "switch",
        "z": "e184a39d1337c413",
        "g": "489c527c7313abfc",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1855,
        "y": 420,
        "wires": [
            [
                "0fd4752631dcec3a"
            ]
        ],
        "l": false
    },
    {
        "id": "6222f1affee6e1d3",
        "type": "rbe",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 820,
        "wires": [
            [
                "d6af403451692bb1"
            ]
        ]
    },
    {
        "id": "6cb5f9c415ad542c",
        "type": "rbe",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 940,
        "wires": [
            [
                "13cedb5ac2c99528"
            ]
        ]
    },
    {
        "id": "54eeded097177b56",
        "type": "rbe",
        "z": "e184a39d1337c413",
        "g": "4e86a2ef81e3975b",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 1000,
        "wires": [
            [
                "f20e44649ce394bd",
                "12445fefbe81761d"
            ]
        ]
    },
    {
        "id": "2b0b72f6a6e652a6",
        "type": "change",
        "z": "e184a39d1337c413",
        "g": "2723688565a9c634",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 190,
        "y": 200,
        "wires": [
            [
                "9e94ec0db734b8ef"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "a5a6cf2c39391430",
        "type": "catch",
        "z": "e184a39d1337c413",
        "g": "4a92bbdb762ecdb9",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 95,
        "y": 320,
        "wires": [
            [
                "23cb9db5c6ec72c6"
            ]
        ],
        "l": false
    },
    {
        "id": "23cb9db5c6ec72c6",
        "type": "function",
        "z": "e184a39d1337c413",
        "g": "4a92bbdb762ecdb9",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 145,
        "y": 320,
        "wires": [
            [
                "4737d9d2ca4490b6"
            ]
        ],
        "l": false
    },
    {
        "id": "4737d9d2ca4490b6",
        "type": "link out",
        "z": "e184a39d1337c413",
        "g": "4a92bbdb762ecdb9",
        "name": "link out 7",
        "mode": "return",
        "links": [],
        "x": 195,
        "y": 320,
        "wires": []
    },
    {
        "id": "0687f28fd7a76e48",
        "type": "comment",
        "z": "5560f85f8090bf93",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 140,
        "y": 60,
        "wires": []
    },
    {
        "id": "23a49040e8762c14",
        "type": "link in",
        "z": "5560f85f8090bf93",
        "g": "1c447224bfccb47e",
        "name": "Sell",
        "links": [],
        "x": 110,
        "y": 220,
        "wires": [
            [
                "1585997ce4e375fa"
            ]
        ],
        "l": true
    },
    {
        "id": "6e6fa505265ed7d4",
        "type": "comment",
        "z": "5560f85f8090bf93",
        "g": "1c447224bfccb47e",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 130,
        "y": 140,
        "wires": []
    },
    {
        "id": "1585997ce4e375fa",
        "type": "change",
        "z": "5560f85f8090bf93",
        "g": "1c447224bfccb47e",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 180,
        "wires": [
            [
                "ff44b6c41fc405ef"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "4c391f0a7231e0d1",
        "type": "link out",
        "z": "5560f85f8090bf93",
        "g": "7000a014340b8aa4",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 185,
        "y": 580,
        "wires": []
    },
    {
        "id": "250d7fc386319ab1",
        "type": "comment",
        "z": "5560f85f8090bf93",
        "g": "7000a014340b8aa4",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 130,
        "y": 520,
        "wires": []
    },
    {
        "id": "80cc93e9d3c758c9",
        "type": "function",
        "z": "5560f85f8090bf93",
        "g": "63f47da4656147c6",
        "name": "Max power solution",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\nlog(this, \"Discharge at **max. power**\");\n\n// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// build solution\nmsg.batteries.forEach(battery => {\n    const calculatedPower = Number(battery.discharging_max);\n\n    solution_array.push({\n        id: battery.id,\n        mode: \"discharge\",\n        power: calculatedPower\n    });\n\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 360,
        "wires": [
            [
                "cbb1894870a4500c"
            ]
        ]
    },
    {
        "id": "ae2e9e3cee8a11c0",
        "type": "link call",
        "z": "5560f85f8090bf93",
        "g": "63f47da4656147c6",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1140,
        "y": 400,
        "wires": [
            [
                "8e67d1074e2b1f4f",
                "c2d00cbf314a1986"
            ]
        ]
    },
    {
        "id": "05e750be9ede996c",
        "type": "switch",
        "z": "5560f85f8090bf93",
        "g": "63f47da4656147c6",
        "name": "Export at max power",
        "property": "house_battery_strategy_sell_has_max_power",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 760,
        "y": 380,
        "wires": [
            [
                "80cc93e9d3c758c9"
            ],
            [
                "c303f76532ba3722"
            ]
        ]
    },
    {
        "id": "8e67d1074e2b1f4f",
        "type": "debug",
        "z": "5560f85f8090bf93",
        "g": "63f47da4656147c6",
        "name": "Regulated",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1330,
        "y": 400,
        "wires": []
    },
    {
        "id": "4f7753fdc47e1195",
        "type": "debug",
        "z": "5560f85f8090bf93",
        "g": "63f47da4656147c6",
        "name": "Maximum",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1320,
        "y": 360,
        "wires": []
    },
    {
        "id": "c303f76532ba3722",
        "type": "function",
        "z": "5560f85f8090bf93",
        "g": "63f47da4656147c6",
        "name": "Regulated power",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = -msg.house_battery_strategy_sell_target_power; // negative, we are exporting to grid.\n// tell PID to avoid charge solutions during Selling.\nRED.util.setMessageProperty(msg,\"advanced_settings.charge_disabled\",true,true);\n\n// Finally\nlog(this, `**Regulated** discharging. Max. grid power: ${Math.floor(msg.house_battery_strategy_sell_target_power)} W`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 400,
        "wires": [
            [
                "ae2e9e3cee8a11c0"
            ]
        ]
    },
    {
        "id": "cbb1894870a4500c",
        "type": "change",
        "z": "5560f85f8090bf93",
        "g": "63f47da4656147c6",
        "name": "Continue",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Charge",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 360,
        "wires": [
            [
                "4f7753fdc47e1195",
                "c2d00cbf314a1986"
            ]
        ]
    },
    {
        "id": "727ec8317fa8b94c",
        "type": "function",
        "z": "5560f85f8090bf93",
        "g": "5d0d14309a330b0a",
        "name": "Min/max",
        "func": "\n// Lower bound\nlet output = msg.sell.threshold_energy | 0; // kWh\noutput = Math.max(output, 0);\n\n// Upper bound\nlet max_reserve = 0; // kWh\nmsg.batteries.forEach(battery => {\n    max_reserve += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\noutput = Math.min(output, max_reserve);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1720,
        "y": 200,
        "wires": [
            [
                "f3d2032b57923bc1"
            ]
        ]
    },
    {
        "id": "f3d2032b57923bc1",
        "type": "api-call-service",
        "z": "5560f85f8090bf93",
        "g": "5d0d14309a330b0a",
        "name": "Set desired energy reserve",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_sell_target_energy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.payload}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1920,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "5c959a0e67fac748",
        "type": "rbe",
        "z": "5560f85f8090bf93",
        "g": "5d0d14309a330b0a",
        "name": "Desired energy changed",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 1530,
        "y": 200,
        "wires": [
            [
                "727ec8317fa8b94c"
            ]
        ]
    },
    {
        "id": "149db2e6fda1048e",
        "type": "api-current-state",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Goal",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_sell_goal",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.goal",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 180,
        "wires": [
            [
                "913f774385a11310"
            ]
        ]
    },
    {
        "id": "913f774385a11310",
        "type": "switch",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Sell until",
        "property": "sell.goal",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "batteries are empty",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "state of charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "energy reserve",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 4,
        "x": 580,
        "y": 180,
        "wires": [
            [
                "de451e4751f76e34"
            ],
            [
                "0d3c58e22f086ee2"
            ],
            [
                "f5dcd5acd1cc1825"
            ],
            [
                "554fe61d9e4f4966"
            ]
        ]
    },
    {
        "id": "554fe61d9e4f4966",
        "type": "function",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Unknown -> Full stop",
        "func": "const log = global.get(\"logger\");\n\n// Unkown export goal\nlog(this, `**${msg.sell.goal}**; Sell goal not recognized. Fallback to **Full Stop**`,\"warn\");\n\n// Full stop\nmsg.target = \"Full stop\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 240,
        "wires": [
            [
                "747d9f12df1b36f5"
            ]
        ]
    },
    {
        "id": "ff44b6c41fc405ef",
        "type": "function",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Init",
        "func": "msg.sell = {};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "149db2e6fda1048e"
            ]
        ]
    },
    {
        "id": "747d9f12df1b36f5",
        "type": "link call",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 940,
        "y": 240,
        "wires": [
            [
                "68ac9883e13717da"
            ]
        ]
    },
    {
        "id": "f5dcd5acd1cc1825",
        "type": "api-current-state",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Energy reserve low",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.threshold_energy",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 750,
        "y": 200,
        "wires": [
            [
                "e84c64bd23fd75de"
            ]
        ]
    },
    {
        "id": "ce270f2f20b38713",
        "type": "link in",
        "z": "5560f85f8090bf93",
        "g": "7000a014340b8aa4",
        "name": "link to End",
        "links": [
            "68ac9883e13717da",
            "397a9c7d1f920201",
            "c2d00cbf314a1986"
        ],
        "x": 75,
        "y": 580,
        "wires": [
            [
                "4c391f0a7231e0d1"
            ]
        ]
    },
    {
        "id": "68ac9883e13717da",
        "type": "link out",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "go to End",
        "mode": "link",
        "links": [
            "ce270f2f20b38713"
        ],
        "x": 1140,
        "y": 240,
        "wires": [],
        "l": true
    },
    {
        "id": "0d3c58e22f086ee2",
        "type": "api-current-state",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "SoC low",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_soc",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.threshold_soc",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 720,
        "y": 160,
        "wires": [
            [
                "ffcc3f03a7eb105b"
            ]
        ]
    },
    {
        "id": "e84c64bd23fd75de",
        "type": "function",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Check if low",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Sell until: ${msg.sell.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nvar energy_threshold = Number(RED.util.getMessageProperty(msg,\"sell.threshold_energy\"));\nif (energy_threshold === undefined || energy_threshold < 0){\n    log(this,`Desired energy reserve not set correctly '${energy_threshold}' kWh`,\"warn\");\n    energy_threshold = 0;\n}\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining <= energy_threshold) {\n    msg.sell.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.sell.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.sell.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 200,
        "wires": [
            [
                "0d670b1abdc56326",
                "5c959a0e67fac748"
            ]
        ]
    },
    {
        "id": "ffcc3f03a7eb105b",
        "type": "function",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Check if low",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this, `Sell until: ${msg.sell.goal}`);\n\n// 2. Extract average SoC and desired SoC level\nlet batteries = msg.batteries;\nlet soc_avg = 0;\nlet count = 0; // could use msg.battery_count\nbatteries.forEach(battery => {\n    soc_avg += battery.soc;\n    count++;\n});\n// 2a.  Current avg. SoC\nsoc_avg = Math.round(soc_avg / count * 100) / 100;\n// 2b.  Sell until SoC (12% as fallback)\nvar soc_threshold = Number(RED.util.getMessageProperty(msg,\"sell.threshold_soc\"));\nif (soc_threshold === undefined || soc_threshold < 12){\n    log(this, `Desired SoC not set correctly '${soc_threshold}' %. I've set it to 12%.`,\"warn\");\n    soc_threshold = 12;\n}\n\n// 3. Logic: Determine if SoC level is at or below desired level\nif (soc_avg <= msg.payload) {\n    msg.sell.threshold_reached = true;\n\n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n\n    // User friendly feedback via the custom logger\n    log(this, `[OK] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({\n    fill: msg.sell.threshold_reached ? \"red\" : \"green\",\n    shape: \"dot\",\n    text: `Threshold reached: ${msg.sell.threshold_reached}`\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 160,
        "wires": [
            [
                "0d670b1abdc56326"
            ]
        ]
    },
    {
        "id": "de451e4751f76e34",
        "type": "change",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Batteries are empty",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 120,
        "wires": [
            [
                "2d205a925226693d"
            ]
        ]
    },
    {
        "id": "2d205a925226693d",
        "type": "function",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Check if empty",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Sell until: ${msg.sell.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining <= 0) {\n    msg.sell.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] All batteries are empty or at SoC_min_ (${energy_remaining} kWh).`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Battery level ${energy_remaining.toFixed(2)} kWh above 0 kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.sell.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.sell.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 960,
        "y": 120,
        "wires": [
            [
                "0d670b1abdc56326"
            ]
        ]
    },
    {
        "id": "f4e2ac17a3a1fa1f",
        "type": "switch",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Until reached",
        "property": "sell.threshold_reached",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1290,
        "y": 160,
        "wires": [
            [
                "a3f9474e3a282c0d"
            ],
            [
                "15421437c9729318"
            ]
        ]
    },
    {
        "id": "a3f9474e3a282c0d",
        "type": "function",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Yes -> Full stop",
        "func": "\nmsg.target = \"Full stop\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1520,
        "y": 120,
        "wires": [
            [
                "3e0117fd21ee8699"
            ]
        ]
    },
    {
        "id": "3e0117fd21ee8699",
        "type": "link call",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 1680,
        "y": 120,
        "wires": [
            [
                "397a9c7d1f920201"
            ]
        ]
    },
    {
        "id": "397a9c7d1f920201",
        "type": "link out",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "go to End",
        "mode": "link",
        "links": [
            "ce270f2f20b38713"
        ],
        "x": 1820,
        "y": 120,
        "wires": [],
        "l": true
    },
    {
        "id": "0d670b1abdc56326",
        "type": "function",
        "z": "5560f85f8090bf93",
        "g": "892a7ef3c44be3b7",
        "name": "Decided",
        "func": "const log = global.get(\"logger\");\n\nif(msg.sell.threshold_reached){\n    log(this,`Stop discharging, Sell until ${msg.sell.goal} reached.`);\n} else {\n    log(this,`Continue discharging.`);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1140,
        "y": 160,
        "wires": [
            [
                "f4e2ac17a3a1fa1f"
            ]
        ]
    },
    {
        "id": "c2d00cbf314a1986",
        "type": "link out",
        "z": "5560f85f8090bf93",
        "g": "63f47da4656147c6",
        "name": "go to End",
        "mode": "link",
        "links": [
            "ce270f2f20b38713"
        ],
        "x": 1320,
        "y": 460,
        "wires": [],
        "l": true
    },
    {
        "id": "79bf5f08c5e3e32a",
        "type": "catch",
        "z": "5560f85f8090bf93",
        "g": "e0d8d71eefdf1dd7",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 75,
        "y": 420,
        "wires": [
            [
                "be738ca647956f14"
            ]
        ],
        "l": false
    },
    {
        "id": "5ebb90ca750f527c",
        "type": "api-current-state",
        "z": "5560f85f8090bf93",
        "g": "63f47da4656147c6",
        "name": "Use max power?",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_sell_has_max_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_sell_has_max_power",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 380,
        "wires": [
            [
                "f0935e40e4c2bf8b"
            ]
        ]
    },
    {
        "id": "f0935e40e4c2bf8b",
        "type": "api-current-state",
        "z": "5560f85f8090bf93",
        "g": "63f47da4656147c6",
        "name": "Grid power limit",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_sell_target_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 560,
        "y": 380,
        "wires": [
            [
                "05e750be9ede996c"
            ]
        ]
    },
    {
        "id": "be738ca647956f14",
        "type": "function",
        "z": "5560f85f8090bf93",
        "g": "e0d8d71eefdf1dd7",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 125,
        "y": 420,
        "wires": [
            [
                "0cf408811df047c5"
            ]
        ],
        "l": false
    },
    {
        "id": "0cf408811df047c5",
        "type": "link out",
        "z": "5560f85f8090bf93",
        "g": "e0d8d71eefdf1dd7",
        "name": "link out 2",
        "mode": "return",
        "links": [],
        "x": 175,
        "y": 420,
        "wires": []
    },
    {
        "id": "6bd77bbe501066aa",
        "type": "link in",
        "z": "9a0e893446c26063",
        "g": "a459df64905d9b19",
        "name": "Timed",
        "links": [],
        "x": 110,
        "y": 160,
        "wires": [
            [
                "e9c4097572299ed8"
            ]
        ],
        "l": true
    },
    {
        "id": "de4985c3b8e77266",
        "type": "comment",
        "z": "9a0e893446c26063",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 130,
        "y": 40,
        "wires": []
    },
    {
        "id": "22855ce20ff97d4b",
        "type": "comment",
        "z": "9a0e893446c26063",
        "g": "a459df64905d9b19",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 120,
        "y": 120,
        "wires": []
    },
    {
        "id": "511dd53be62577be",
        "type": "link out",
        "z": "9a0e893446c26063",
        "g": "6e733110b6527394",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 1255,
        "y": 520,
        "wires": []
    },
    {
        "id": "db46b8682c3dce9a",
        "type": "comment",
        "z": "9a0e893446c26063",
        "g": "6e733110b6527394",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 1310,
        "y": 460,
        "wires": []
    },
    {
        "id": "7ed0bffa2cd51adf",
        "type": "api-current-state",
        "z": "9a0e893446c26063",
        "g": "67431ee65fa08b83",
        "name": "Period A start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_a1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_a1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 550,
        "y": 120,
        "wires": [
            [
                "049bccc9ed4b07a9"
            ]
        ]
    },
    {
        "id": "049bccc9ed4b07a9",
        "type": "api-current-state",
        "z": "9a0e893446c26063",
        "g": "67431ee65fa08b83",
        "name": "Period A end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_a2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_a2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 120,
        "wires": [
            [
                "d5de970480264a45"
            ]
        ]
    },
    {
        "id": "92aa1909b8a07503",
        "type": "api-current-state",
        "z": "9a0e893446c26063",
        "g": "37190b7d1d24db11",
        "name": "Period B start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_b1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_b1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 220,
        "wires": [
            [
                "082ea5df6ede1394"
            ]
        ]
    },
    {
        "id": "082ea5df6ede1394",
        "type": "api-current-state",
        "z": "9a0e893446c26063",
        "g": "37190b7d1d24db11",
        "name": "Period B end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_b2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_b2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 220,
        "wires": [
            [
                "00c8c0d856df091b"
            ]
        ]
    },
    {
        "id": "d5de970480264a45",
        "type": "api-current-state",
        "z": "9a0e893446c26063",
        "g": "67431ee65fa08b83",
        "name": "Strat during A",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_a",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_a",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 120,
        "wires": [
            [
                "107d88137b2e4166"
            ]
        ]
    },
    {
        "id": "00c8c0d856df091b",
        "type": "api-current-state",
        "z": "9a0e893446c26063",
        "g": "37190b7d1d24db11",
        "name": "Strat during B",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_b",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_b",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 220,
        "wires": [
            [
                "361b605c37749a37"
            ]
        ]
    },
    {
        "id": "107d88137b2e4166",
        "type": "api-current-state",
        "z": "9a0e893446c26063",
        "g": "37190b7d1d24db11",
        "name": "Has period B",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_period_b",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_period_b",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 220,
        "wires": [
            [
                "92aa1909b8a07503"
            ]
        ]
    },
    {
        "id": "6dbf63cfe537808c",
        "type": "inject",
        "z": "9a0e893446c26063",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 40,
        "wires": [
            [
                "1ffa4cf0651fb6db"
            ]
        ]
    },
    {
        "id": "5a1a8f3d9c3fabce",
        "type": "change",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 460,
        "wires": [
            [
                "03efcfb13944c7ce"
            ]
        ]
    },
    {
        "id": "6276beee454b0faf",
        "type": "change",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "set Strat A",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_a",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 420,
        "wires": [
            [
                "fef8e9938f9c04d4",
                "2293a96189a7e6bc"
            ]
        ]
    },
    {
        "id": "03efcfb13944c7ce",
        "type": "switch",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "has period B",
        "property": "house_battery_strategy_timed_has_period_b",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 500,
        "wires": [
            [
                "fef8e9938f9c04d4",
                "c201dad8fc5e03ca"
            ],
            [
                "1c01da2540a3a36f"
            ]
        ]
    },
    {
        "id": "2e31cf3d98972bc0",
        "type": "function",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "config A",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_a1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_a2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 440,
        "wires": [
            [
                "e1e4a1198c575418"
            ]
        ]
    },
    {
        "id": "e1e4a1198c575418",
        "type": "time-range-switch",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "Period A",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 440,
        "wires": [
            [
                "6276beee454b0faf"
            ],
            [
                "5a1a8f3d9c3fabce"
            ]
        ]
    },
    {
        "id": "1c01da2540a3a36f",
        "type": "function",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "config B",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_b1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_b2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 580,
        "wires": [
            [
                "f201a4fe3f63e338"
            ]
        ]
    },
    {
        "id": "f201a4fe3f63e338",
        "type": "time-range-switch",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "Period B",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 580,
        "wires": [
            [
                "60b0be4ed6636e40"
            ],
            [
                "8a7093a5d4a8186c"
            ]
        ]
    },
    {
        "id": "60b0be4ed6636e40",
        "type": "change",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "set Strat B",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_b",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 560,
        "wires": [
            [
                "fef8e9938f9c04d4",
                "7125d42fb077af11"
            ]
        ]
    },
    {
        "id": "8a7093a5d4a8186c",
        "type": "change",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 600,
        "wires": [
            [
                "4f56bf0d99e521c5"
            ]
        ]
    },
    {
        "id": "1ffa4cf0651fb6db",
        "type": "api-current-state",
        "z": "9a0e893446c26063",
        "g": "117b470e420cdbdb",
        "name": "Default Strat",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_0",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_0",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 120,
        "wires": [
            [
                "7ed0bffa2cd51adf"
            ]
        ]
    },
    {
        "id": "f3a2126ec649bed7",
        "type": "link call",
        "z": "9a0e893446c26063",
        "g": "903595f5e42d7154",
        "name": "Sub strategy",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1080,
        "y": 520,
        "wires": [
            [
                "511dd53be62577be"
            ]
        ]
    },
    {
        "id": "fef8e9938f9c04d4",
        "type": "change",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "Select flow",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "timed_strategy",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 850,
        "y": 520,
        "wires": [
            [
                "f3a2126ec649bed7",
                "f4fb91b1d053877e"
            ]
        ]
    },
    {
        "id": "2293a96189a7e6bc",
        "type": "debug",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "A",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 420,
        "wires": []
    },
    {
        "id": "c201dad8fc5e03ca",
        "type": "debug",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 460,
        "wires": []
    },
    {
        "id": "7125d42fb077af11",
        "type": "debug",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "B",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 560,
        "wires": []
    },
    {
        "id": "9d5bc3fb6beeb590",
        "type": "debug",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 600,
        "wires": []
    },
    {
        "id": "f4fb91b1d053877e",
        "type": "debug",
        "z": "9a0e893446c26063",
        "g": "903595f5e42d7154",
        "name": "Target",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "target",
        "targetType": "msg",
        "statusVal": "target",
        "statusType": "auto",
        "x": 1060,
        "y": 460,
        "wires": []
    },
    {
        "id": "dad5602acce67ee0",
        "type": "api-current-state",
        "z": "9a0e893446c26063",
        "g": "bd64b4be97f657f1",
        "name": "Period C start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_c1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_c1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 320,
        "wires": [
            [
                "b84e3bdf51a7af16"
            ]
        ]
    },
    {
        "id": "b84e3bdf51a7af16",
        "type": "api-current-state",
        "z": "9a0e893446c26063",
        "g": "bd64b4be97f657f1",
        "name": "Period C end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_c2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_c2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 320,
        "wires": [
            [
                "dabb7e7a3ed2adb7"
            ]
        ]
    },
    {
        "id": "dabb7e7a3ed2adb7",
        "type": "api-current-state",
        "z": "9a0e893446c26063",
        "g": "bd64b4be97f657f1",
        "name": "Strat during C",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_c",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_c",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 320,
        "wires": [
            [
                "2e31cf3d98972bc0"
            ]
        ]
    },
    {
        "id": "361b605c37749a37",
        "type": "api-current-state",
        "z": "9a0e893446c26063",
        "g": "bd64b4be97f657f1",
        "name": "Has period C",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_period_c",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_period_c",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 320,
        "wires": [
            [
                "dad5602acce67ee0"
            ]
        ]
    },
    {
        "id": "4f56bf0d99e521c5",
        "type": "switch",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "has period C",
        "property": "house_battery_strategy_timed_has_period_c",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 640,
        "wires": [
            [
                "fef8e9938f9c04d4",
                "9d5bc3fb6beeb590"
            ],
            [
                "3933d7a1ec2cc79c"
            ]
        ]
    },
    {
        "id": "fa03edc1a23d6fb1",
        "type": "debug",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "C",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 700,
        "wires": []
    },
    {
        "id": "3933d7a1ec2cc79c",
        "type": "function",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "config C",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_c1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_c2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 720,
        "wires": [
            [
                "7b304f1333c82679"
            ]
        ]
    },
    {
        "id": "7b304f1333c82679",
        "type": "time-range-switch",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "Period C",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 720,
        "wires": [
            [
                "0f71edfec9200132"
            ],
            [
                "03a30ff3cd0768d8"
            ]
        ]
    },
    {
        "id": "0f71edfec9200132",
        "type": "change",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "set Strat C",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_c",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 700,
        "wires": [
            [
                "fa03edc1a23d6fb1",
                "fef8e9938f9c04d4"
            ]
        ]
    },
    {
        "id": "03a30ff3cd0768d8",
        "type": "change",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 740,
        "wires": [
            [
                "fef8e9938f9c04d4",
                "c85ac3a5125dfc4e"
            ]
        ]
    },
    {
        "id": "c85ac3a5125dfc4e",
        "type": "debug",
        "z": "9a0e893446c26063",
        "g": "d0c663c09ccb94f9",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 740,
        "wires": []
    },
    {
        "id": "e9c4097572299ed8",
        "type": "change",
        "z": "9a0e893446c26063",
        "g": "a459df64905d9b19",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 200,
        "wires": [
            [
                "1ffa4cf0651fb6db"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "8f9d9ad6aebfacfa",
        "type": "catch",
        "z": "9a0e893446c26063",
        "g": "d182a8ebdd6fce4b",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 65,
        "y": 320,
        "wires": [
            [
                "d8fe0be0b1a51ef7"
            ]
        ],
        "l": false
    },
    {
        "id": "d8fe0be0b1a51ef7",
        "type": "function",
        "z": "9a0e893446c26063",
        "g": "d182a8ebdd6fce4b",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 115,
        "y": 320,
        "wires": [
            [
                "64258a0ea5d78832"
            ]
        ],
        "l": false
    },
    {
        "id": "64258a0ea5d78832",
        "type": "link out",
        "z": "9a0e893446c26063",
        "g": "d182a8ebdd6fce4b",
        "name": "link out 8",
        "mode": "return",
        "links": [],
        "x": 165,
        "y": 320,
        "wires": []
    },
    {
        "id": "dfc42473c3e94b14",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.3",
            "node-red-node-smooth": "0.1.2",
            "node-red-contrib-time-range-switch": "1.2.0"
        }
    }
]
