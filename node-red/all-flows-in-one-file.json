[
    {
        "id": "acde727d4cb42aaa",
        "type": "tab",
        "label": "Home Battery Master Switch",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "db3d5e8e506ed595",
        "type": "tab",
        "label": "Home Battery PID presets",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "52c9c8914699459b",
        "type": "tab",
        "label": "Home Battery Start v4.3.3",
        "disabled": false,
        "info": "# Home battery control\r\nConsists of three flows:\r\n 1.  Start flow\r\n 1.  Control flow\r\n 1.  Master switch flow\r\n\r\n## Start flow\r\nThis is the starting point of your home battery control.\r\n\r\nIt starts with P1 measurement as a trigger.\r\nIt allows you to connect your battery sensors to the flow.\r\nIt ends with a function node, mapping your batteries to a battery_array\r\n\r\nThe battery_array is passed on to the control flow.\r\n\r\nWhen the control flow has calculated the desired corrections,\r\nit is passed back to this flow and applied to your batteries.",
        "env": []
    },
    {
        "id": "676ceac4c521834d",
        "type": "tab",
        "label": "Strategy Charge PV v4.3.3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "acf90364e6895494",
        "type": "tab",
        "label": "Strategy Charge v4.3.3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "14975b6f5363e1a8",
        "type": "tab",
        "label": "Strategy Dynamic v4.3.3",
        "disabled": false,
        "info": "Dynamic contract automated management",
        "env": []
    },
    {
        "id": "5ca05ae5a089b8d2",
        "type": "tab",
        "label": "Strategy Full stop v4.3.3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "ab649936ec5003a8",
        "type": "tab",
        "label": "Strategy Self-consumption v4.3.3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "e77ef29a0d741103",
        "type": "tab",
        "label": "Strategy Sell v4.3.3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "565472d31bbf94d6",
        "type": "tab",
        "label": "Strategy Timed v4.3.3",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "5b3831da1b35bb1d",
        "type": "group",
        "z": "acde727d4cb42aaa",
        "name": "Marstek master control switch",
        "style": {
            "label": true
        },
        "nodes": [
            "b9f84cc9f5a92c37",
            "db8935b06e0974bc",
            "ce0d5547e473555e",
            "64dc39c70599dfc4",
            "8b5ef482f35ef9c0"
        ],
        "x": 34,
        "y": 19,
        "w": 898,
        "h": 382
    },
    {
        "id": "f7c4130202d3fc9a",
        "type": "group",
        "z": "db3d5e8e506ed595",
        "name": "PID presets",
        "style": {
            "label": true
        },
        "nodes": [
            "7e47681b0b90d304",
            "12d5aaa80e1bb91b",
            "ae2642f17e0509aa",
            "07736a1f4286754d",
            "53db92119d4503d8",
            "da897ec87776e7ac",
            "821ed7febefca284"
        ],
        "x": 34,
        "y": 19,
        "w": 632,
        "h": 242
    },
    {
        "id": "47309eeeddad37dd",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Start",
        "style": {
            "label": true,
            "stroke": "#009ac7"
        },
        "nodes": [
            "e88a2a22e98331f7",
            "572b90ad72de2db4",
            "3bb80c685f5dffbe"
        ],
        "x": 34,
        "y": 19,
        "w": 652,
        "h": 82
    },
    {
        "id": "c2389c0b492c9c86",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Strategy selection",
        "style": {
            "label": true
        },
        "nodes": [
            "9af934c039dd4160",
            "49b4552212958120",
            "b6cfaaae61c2ab5d",
            "a8a702493df2362a",
            "02b9035c15eccf88",
            "e2bc27d66ecbb37a",
            "6c2865f36f95871d",
            "4a28992aa4ab8dbf"
        ],
        "x": 34,
        "y": 839,
        "w": 812,
        "h": 162
    },
    {
        "id": "b275014260a268f5",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Get batteries information",
        "style": {
            "label": true
        },
        "nodes": [
            "6708d088bf1bea54",
            "37bb273079d8a07d",
            "05d15b8796456269",
            "5c85204217272545",
            "1677eb562c842299",
            "1cbf70cdca0564a7",
            "d519e78d039ebdd4",
            "c380f606379a5d1e"
        ],
        "x": 28,
        "y": 379,
        "w": 1664,
        "h": 242
    },
    {
        "id": "18fa0fa26afc5e2a",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "On deploy and global logger",
        "style": {
            "label": true,
            "stroke": "#92d04f"
        },
        "nodes": [
            "5ff04af6ac3b3ac8",
            "f5f967aad10eaa46",
            "84cb41317c986889"
        ],
        "x": 1294,
        "y": 19,
        "w": 592,
        "h": 82
    },
    {
        "id": "bedf5e7cfbbb08ae",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Set Batteries",
        "style": {
            "label": true
        },
        "nodes": [
            "f54dab1eac570502",
            "fd5417c04f3f46d8",
            "9f20bb161f85c299",
            "a45585ec53875b97",
            "6164ecb2a7f01590",
            "303356a49aa21bb8",
            "50b780b89c4d458b"
        ],
        "x": 34,
        "y": 1019,
        "w": 858,
        "h": 342
    },
    {
        "id": "9e5eaeb5424fa705",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Battery priority",
        "style": {
            "label": true
        },
        "nodes": [
            "707e57cc9d80c1c4",
            "a5c2b5baa0daef04",
            "79e084940a21e2a0",
            "d4072f1ed8285936",
            "5512920e211340b7",
            "12ed3433da7af941",
            "e27ca6736994f2a2",
            "05709f29ec2f3a5e",
            "121a4935cb0cf64b"
        ],
        "x": 34,
        "y": 739,
        "w": 1852,
        "h": 82
    },
    {
        "id": "8b2e354dccd571e9",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Calculate totals",
        "style": {
            "label": true
        },
        "nodes": [
            "cf30b8e3347e871b"
        ],
        "x": 34,
        "y": 639,
        "w": 212,
        "h": 82
    },
    {
        "id": "d1760f49d88b8c18",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Rate limiter",
        "style": {
            "label": true
        },
        "nodes": [
            "b63962b0d48cc72e",
            "0d7e2fa8b04163ca",
            "1acca348555adf72",
            "142b3f6e6eef61c5",
            "242a43037dd51384",
            "f998af9f93370978",
            "d62c85af911988de",
            "c9b3426939827168",
            "a32e88e95de6a99c",
            "c1290f4e45d3e136"
        ],
        "x": 34,
        "y": 219,
        "w": 1402,
        "h": 122
    },
    {
        "id": "18846dd2ccb6b8a3",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Update UI: debug dashboard",
        "style": {
            "label": true,
            "stroke": "#3f5787"
        },
        "nodes": [
            "1384404e641cd150",
            "34d5920bcea00bd1",
            "c4c329decd25f94a",
            "bc929ea9453410e3",
            "4813b0642da5b375",
            "f4935b42f173f842"
        ],
        "x": 1234,
        "y": 1219,
        "w": 632,
        "h": 202
    },
    {
        "id": "3d2ce9212cc2f54e",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Update UI: usable energy",
        "style": {
            "label": true,
            "stroke": "#3f5787"
        },
        "nodes": [
            "e6dbf470abd5cbb0",
            "67f7cf0ecb40876b"
        ],
        "x": 1474,
        "y": 639,
        "w": 412,
        "h": 82
    },
    {
        "id": "3d5229715a1f55ed",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Update UI: active sub-strategy",
        "style": {
            "label": true,
            "stroke": "#3f5787"
        },
        "nodes": [
            "b5ae87025e947205",
            "5c9c40395e9574f5",
            "9e3c1dfd5cad854e"
        ],
        "x": 1254,
        "y": 919,
        "w": 632,
        "h": 82
    },
    {
        "id": "1a62ec01b467c889",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Insight",
        "style": {
            "label": true
        },
        "nodes": [
            "e06ddb61ac3fa529",
            "450ad3f210922762",
            "339220163710070f",
            "be7035a364493de8",
            "ff09b484f05bbde8"
        ],
        "x": 34,
        "y": 119,
        "w": 892,
        "h": 82
    },
    {
        "id": "772d5c1be97f0a16",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Log and Error handling",
        "style": {
            "stroke": "#ff3f3f",
            "label": true
        },
        "nodes": [
            "08f5fdb7f38ec302",
            "9d481f78dbe3e15f"
        ],
        "x": 1634,
        "y": 119,
        "w": 252,
        "h": 142
    },
    {
        "id": "2ed9a80737079874",
        "type": "group",
        "z": "52c9c8914699459b",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "8219a8e42f2d8841",
            "a85c30d990dba021",
            "50179ca8d725bdfe"
        ],
        "x": 1704,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "9889d591bcc38e89",
        "type": "group",
        "z": "676ceac4c521834d",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "87be4b85f89829b6",
            "d62d870eb44d3582"
        ],
        "x": 624,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "72059e541379a869",
        "type": "group",
        "z": "676ceac4c521834d",
        "name": "Start",
        "style": {
            "label": true
        },
        "nodes": [
            "a5e9e484430e1720",
            "bf548077ba6ca350",
            "be2a48e071dee195"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "6e6682265db1e9ee",
        "type": "group",
        "z": "676ceac4c521834d",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "524b61f06ac20ae7",
            "b068ce351aa5b926",
            "0d26b7f936be7947"
        ],
        "x": 14,
        "y": 259,
        "w": 182,
        "h": 82
    },
    {
        "id": "f98d86f9119b97c8",
        "type": "group",
        "z": "acf90364e6895494",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "c3438f8485ce1440",
            "9c90ed941bad8215",
            "2f866dd7572e406e"
        ],
        "x": 34,
        "y": 99,
        "w": 192,
        "h": 162
    },
    {
        "id": "aabefc3958b99589",
        "type": "group",
        "z": "acf90364e6895494",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "dacc76ec691f29dd",
            "8c915c6e011ad9ce",
            "f48f75f0f9f41c5a"
        ],
        "x": 34,
        "y": 479,
        "w": 192,
        "h": 142
    },
    {
        "id": "acd85c313a179ad1",
        "type": "group",
        "z": "acf90364e6895494",
        "name": "Export routine",
        "style": {
            "fill-opacity": "0.5",
            "label": true,
            "color": "#cccccc"
        },
        "nodes": [
            "544f7b5f8a7e2e5f",
            "3e05b666827f5ab3",
            "0fd7fb4aae300503",
            "f3a7efeae778fe97",
            "f8391ad8bb7299e8",
            "7a36d44164b63a66",
            "1b6bc04ad1edaaeb",
            "75ed5ed6a655b6b0",
            "0e22f7f0d91f8e14",
            "79cd66a5d0c5a0a1"
        ],
        "x": 254,
        "y": 319,
        "w": 1192,
        "h": 182
    },
    {
        "id": "cf76f88e2d0b6b5d",
        "type": "group",
        "z": "acf90364e6895494",
        "name": "Decide import or stop",
        "style": {
            "label": true
        },
        "nodes": [
            "5ee6ad7859def0a5",
            "61cb693de420fcc4",
            "a1853cedd6a4de2a",
            "b25ccc2a1d23ab8c",
            "b7a4fb09268788ef",
            "4627f06802b810e4",
            "5a45c394ce22d5bc",
            "34db30ed0ace9850",
            "3ba77ad27aab03ae",
            "61cc6de76d25a391",
            "43c0d94c059d5555",
            "6c389d45d1ea769b",
            "85e67e4a2d60524c",
            "1c81dabddcb02085",
            "7cb5b047aa774535",
            "bae1fdb045d8953f",
            "7045b1796ad3123d",
            "49ac1529018b02b8",
            "9d043a8d975d248d",
            "405d5a3227088f7d"
        ],
        "x": 254,
        "y": 79,
        "w": 1928,
        "h": 207
    },
    {
        "id": "c0793a4f4fa04e17",
        "type": "group",
        "z": "acf90364e6895494",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "e5710e5722a62ecb",
            "ae704ead76c1420b",
            "53589d34db53d176"
        ],
        "x": 34,
        "y": 379,
        "w": 182,
        "h": 82
    },
    {
        "id": "46497598dbd9e9ee",
        "type": "group",
        "z": "14975b6f5363e1a8",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "7f8a072b3ee09975",
            "733fb56e80bff2dc"
        ],
        "x": 934,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "5db10a20e0dd06b3",
        "type": "group",
        "z": "14975b6f5363e1a8",
        "name": "Home battery start",
        "style": {
            "label": true
        },
        "nodes": [
            "9e4f52bdefdaaaa0",
            "90587e0927e8aeb0",
            "7b2e7b9ebad81a31"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "c4abcdadddca94b8",
        "type": "group",
        "z": "14975b6f5363e1a8",
        "name": "Set dynamic strategy on",
        "style": {
            "label": true
        },
        "nodes": [
            "8872e96a558ef448",
            "6db52f5df28e071d",
            "1e9ca1074e1edceb",
            "c3e1145a39680abf",
            "4f4f1b6e67a30afe",
            "3457fc35c3b7087f",
            "8a11850114531fc8",
            "66b57d6637cfadb4",
            "a35cf4e779e09fbb",
            "9b03180e47c0ddf0",
            "5fa32b6aff16ca75",
            "9ff38a5ef6e582a4",
            "5ca77832c97c6f3c",
            "34b0068e095ea86f",
            "beb4ff24b4b8562d",
            "9c39d968ab65452f",
            "7fff7bb0c69da24a",
            "cb7c0de40d2ba570",
            "63caf6ef501274d4",
            "d14eecae2f628cc0",
            "8baf7a8bca626f1a",
            "79fe8f7cb43086b5",
            "14dfd4a18fdc3126",
            "fe9d10b494abc5a7",
            "c78b4e15dfb514dd",
            "c15319afc50e922c",
            "85f6dd8a93235509",
            "99119cc93c6cdcc4",
            "a884af48600be5c2",
            "0c735b92e205c0c0",
            "b5e11bf0fddced8d",
            "a10bb26ddb8a5ea8",
            "1ef00a59cbcb4772",
            "f4b1dd2d52e46081"
        ],
        "x": 234,
        "y": 279,
        "w": 1492,
        "h": 702
    },
    {
        "id": "bf724a3d55e9fc66",
        "type": "group",
        "z": "14975b6f5363e1a8",
        "name": "Execute",
        "style": {
            "label": true
        },
        "nodes": [
            "848d7f239ac703db",
            "3ccd08ef5be34846",
            "db8c13461b3b9091",
            "87d34cbd4954621c",
            "45d16441c1a4d7b3"
        ],
        "x": 234,
        "y": 119,
        "w": 672,
        "h": 122
    },
    {
        "id": "20909aa0de389bf6",
        "type": "group",
        "z": "14975b6f5363e1a8",
        "name": "Test area",
        "style": {
            "label": true
        },
        "nodes": [
            "ac6a032a5d15bf77",
            "be57bb0565d23939",
            "e9cc30749a5121b4",
            "f693251258633cd6",
            "89ee16ccac7cd2ad",
            "2b9ff7fb6e9d6bf5",
            "89019ec9b4041e43",
            "37fcd96bb0ef062c"
        ],
        "x": 234,
        "y": 1019,
        "w": 912,
        "h": 162
    },
    {
        "id": "9969e1f72d0b7236",
        "type": "group",
        "z": "14975b6f5363e1a8",
        "name": "All data",
        "style": {
            "label": true
        },
        "nodes": [
            "719ff618f7ca2376",
            "e9bb86a4e54c5052",
            "b2bc04a3efb38c09",
            "d70764aae439f14b"
        ],
        "x": 234,
        "y": 1659,
        "w": 572,
        "h": 82
    },
    {
        "id": "36273e2ec1912b5b",
        "type": "group",
        "z": "14975b6f5363e1a8",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "a2d3614dfb17fe47",
            "b5866f9aa2b37c76",
            "5486ae2d26979420"
        ],
        "x": 24,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "c3404a37fd9ce4af",
        "type": "group",
        "z": "5ca05ae5a089b8d2",
        "name": "Strategy start",
        "style": {
            "label": true
        },
        "nodes": [
            "fedca8b9c6861865",
            "4febdc440faf9d73",
            "86fc6690200ea1d5"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "807415e9b7aacdfa",
        "type": "group",
        "z": "5ca05ae5a089b8d2",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "5ac782a79cce3909",
            "1dca26be7c0dd61b"
        ],
        "x": 464,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "baecf4a2995e8afe",
        "type": "group",
        "z": "5ca05ae5a089b8d2",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "527dbdfa3c0b7d81",
            "dbd5b285d0e8b8d2",
            "23b4b597108b5ea8"
        ],
        "x": 14,
        "y": 259,
        "w": 182,
        "h": 82
    },
    {
        "id": "5271f96dc7c112a4",
        "type": "group",
        "z": "ab649936ec5003a8",
        "name": "Strategy start",
        "style": {
            "fill": "#ffffff",
            "label": true
        },
        "nodes": [
            "1be4da0d75e45a96",
            "8e3725ba65b07a2a",
            "d4343a51125ccdab"
        ],
        "x": 54,
        "y": 79,
        "w": 212,
        "h": 162
    },
    {
        "id": "8630dad118ebd003",
        "type": "group",
        "z": "ab649936ec5003a8",
        "name": "Battery solutions",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "4b6743df002beb3e",
            "024f56d639e52f5d",
            "fe3bd39ee2b999af"
        ],
        "x": 64,
        "y": 1139,
        "w": 202,
        "h": 142
    },
    {
        "id": "9b4a06585508d834",
        "type": "group",
        "z": "ab649936ec5003a8",
        "name": "Bumpless operation",
        "style": {
            "label": true,
            "stroke": "#bfdbef"
        },
        "nodes": [
            "714da9cf65f2306e",
            "8128162c69a1d5d2",
            "4672636ffc125dbb",
            "6cee40362e88eb29"
        ],
        "x": 1614,
        "y": 19,
        "w": 252,
        "h": 242
    },
    {
        "id": "c1a0edd1034ce527",
        "type": "group",
        "z": "ab649936ec5003a8",
        "name": "Bumpless operation - switching control modes",
        "style": {
            "stroke": "#bfdbef",
            "label": true
        },
        "nodes": [
            "3c069a284fb88cb8",
            "2c052a6043213335",
            "ef2b4d94afca2335",
            "2a99bba814229d62",
            "b989db7ba36bd9b8",
            "e36368accc35ec44",
            "0ac1265e5b6a081b",
            "be4d162a616e400e",
            "3ab6f677420a1643",
            "4df9eb09c05acc4b",
            "9b8bdd8b09e00720",
            "b684f654bf13813c"
        ],
        "x": 1614,
        "y": 279,
        "w": 592,
        "h": 289.5
    },
    {
        "id": "c984065022545566",
        "type": "group",
        "z": "ab649936ec5003a8",
        "name": "Inputs",
        "style": {
            "fill": "#7fb7df",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "805549b5bb79c598",
            "e3dca719d51b04b0"
        ],
        "x": 288,
        "y": 13,
        "w": 904,
        "h": 234
    },
    {
        "id": "9e4f72ca6f793259",
        "type": "group",
        "z": "ab649936ec5003a8",
        "name": "Pre processing",
        "style": {
            "fill": "#bfdbef",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "aa86505827b85572",
            "c804bc50fc65d906",
            "185541e56b8b8a3c"
        ],
        "x": 288,
        "y": 273,
        "w": 1104,
        "h": 294
    },
    {
        "id": "32b1c70698d0197d",
        "type": "group",
        "z": "ab649936ec5003a8",
        "name": "Control",
        "style": {
            "fill": "#7fb7df",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "eaf26e698ab1310a",
            "6a196c081e1ca3ef"
        ],
        "x": 288,
        "y": 593,
        "w": 924,
        "h": 634
    },
    {
        "id": "3da3756e03e79934",
        "type": "group",
        "z": "ab649936ec5003a8",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "fcfcc1a78161251b",
            "1e332a115c8fded2",
            "ad03e54599bc4146"
        ],
        "x": 54,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "8c445bc062decbcc",
        "type": "group",
        "z": "e77ef29a0d741103",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "6dadf397f2f6b3bd",
            "ef5a08d8ffcd7110",
            "11906312b0cb6efa"
        ],
        "x": 34,
        "y": 99,
        "w": 192,
        "h": 162
    },
    {
        "id": "5e1e1f49d44e8b30",
        "type": "group",
        "z": "e77ef29a0d741103",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "7998507fa346fe3d",
            "ae9357a8119887bd",
            "1be6518cea60edc0"
        ],
        "x": 34,
        "y": 479,
        "w": 192,
        "h": 142
    },
    {
        "id": "10bdc9982eb2e3f5",
        "type": "group",
        "z": "e77ef29a0d741103",
        "name": "Export routine",
        "style": {
            "fill-opacity": "0.5",
            "label": true,
            "color": "#cccccc"
        },
        "nodes": [
            "8ddc03d7b7f3c009",
            "1cab3db414f0c263",
            "b2d4a202f2685181",
            "78e90bb395c0dbed",
            "9dcdc76e0bd7c4ab",
            "3d1362c4480436b3",
            "f9e95a63d7c7c20b",
            "a4e67dfad40aa29b",
            "30d3a0c0b2fbd1ee",
            "05fc785d0fc1f322"
        ],
        "x": 254,
        "y": 319,
        "w": 1192,
        "h": 182
    },
    {
        "id": "973bb4c97953a2b2",
        "type": "group",
        "z": "e77ef29a0d741103",
        "name": "Decide export or stop",
        "style": {
            "label": true
        },
        "nodes": [
            "ccd97d526145218b",
            "702ccad6e2cbceab",
            "d8ac0234fd05fef3",
            "fa141ca0faa264a1",
            "f83c002bea913080",
            "7200f55023f46f04",
            "529b8999db742c26",
            "73d55eb55311595d",
            "22aa1a8dcb03e6e5",
            "4717108485222f24",
            "c208504aa23bef5c",
            "a997b439f01cc853",
            "ef87f4e1c4d13f4c",
            "8823264060d2fd83",
            "c40455a8c54319d9",
            "f004af2ab6db360d",
            "3f1d0d1588b39515",
            "f321edb9d2d83087",
            "6adb6d0c1201ee54"
        ],
        "x": 254,
        "y": 79,
        "w": 1838,
        "h": 207
    },
    {
        "id": "77471167526c99a1",
        "type": "group",
        "z": "e77ef29a0d741103",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "3b98705984e28841",
            "ca666c90b1c9969f",
            "cfb79189db97fb6d"
        ],
        "x": 34,
        "y": 379,
        "w": 182,
        "h": 82
    },
    {
        "id": "bf4a177b0973bf60",
        "type": "group",
        "z": "565472d31bbf94d6",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "147d332b0661fd93",
            "46db1ca78901a81a"
        ],
        "x": 1214,
        "y": 419,
        "w": 192,
        "h": 142
    },
    {
        "id": "f351846034cb37db",
        "type": "group",
        "z": "565472d31bbf94d6",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "aa901028487fda57",
            "36d0bfe4dfb4f1ad",
            "a40720f2962ad767"
        ],
        "x": 24,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "a4c2255a364ee81e",
        "type": "group",
        "z": "565472d31bbf94d6",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "64f008151046897a",
            "a257c8ae8c0d645a",
            "443ecb9004966257"
        ],
        "x": 454,
        "y": 79,
        "w": 532,
        "h": 82
    },
    {
        "id": "0d15ba99fc93cc6b",
        "type": "group",
        "z": "565472d31bbf94d6",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "d9587ef14ec1bc40",
            "556ff9cd3a9294a6",
            "b7b06ea09cbb4a2e",
            "51c1932610a9e86b"
        ],
        "x": 254,
        "y": 179,
        "w": 732,
        "h": 82
    },
    {
        "id": "b633b5e15993e0d6",
        "type": "group",
        "z": "565472d31bbf94d6",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "bfc867f58d4e467d"
        ],
        "x": 254,
        "y": 79,
        "w": 192,
        "h": 82
    },
    {
        "id": "08eca2e18a0ac453",
        "type": "group",
        "z": "565472d31bbf94d6",
        "name": "Determine sub-strategy based on time period",
        "style": {
            "label": true
        },
        "nodes": [
            "99abfd44ef05f1c9",
            "5896bb5aa8446dea",
            "9d74ec5ccde0dd52",
            "8a4c0f0248911c49",
            "4922f6025aed4be0",
            "eee90004eabfba55",
            "aede54d2d757b5fa",
            "bc1bd7be720bbe3c",
            "93bd3c05704c2217",
            "621149c4156f5e2c",
            "736b18fd4caaf56e",
            "b746a642455620f1",
            "ef6841be6b3946bf",
            "db42d487c2a39f19",
            "1737f34a39997ce3",
            "c46e822a8176c726",
            "71d7c5895ac89155",
            "aba39d4d9a9f7fcf",
            "e962b70c672d2a77",
            "fea4fe092fcccf5e",
            "11ac32f37c71e6d2"
        ],
        "x": 254,
        "y": 379,
        "w": 692,
        "h": 402
    },
    {
        "id": "798b3b3b301d9113",
        "type": "group",
        "z": "565472d31bbf94d6",
        "name": "Execute sub-strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "0a02d392a3de1ef6",
            "d52956cca05d6d22"
        ],
        "x": 984,
        "y": 419,
        "w": 192,
        "h": 142
    },
    {
        "id": "cb501137f9834535",
        "type": "group",
        "z": "565472d31bbf94d6",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "03f807ef302dcd0b",
            "950fcd1c9f28362f",
            "d8222b605a245b59",
            "76b6003837ed2f4a"
        ],
        "x": 254,
        "y": 279,
        "w": 732,
        "h": 82
    },
    {
        "id": "75aa197258115847",
        "type": "group",
        "z": "565472d31bbf94d6",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "ca28a29d799a7941",
            "fb1e6798b3ce474e",
            "41fc4c8efb88419a"
        ],
        "x": 24,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "8b5ef482f35ef9c0",
        "type": "group",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "964d538dd74d6c05",
            "0a5e50316b0d2b70",
            "9875fb4be6ce951f",
            "3141628fc4063a26",
            "9f47be1a4b1c355b",
            "06cec7476db26e79"
        ],
        "x": 414,
        "y": 99,
        "w": 492,
        "h": 222
    },
    {
        "id": "1677eb562c842299",
        "type": "group",
        "z": "52c9c8914699459b",
        "g": "b275014260a268f5",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "fb25bee5c67c58b3",
            "6508555562eef85e",
            "6c3889bd1bf63fe4",
            "c166e94487fedb9f",
            "a192dd2ec11fc220",
            "04b3971201cebd38",
            "e2fe2b2a85e8dd63",
            "3562e6184550b441",
            "714f61920d832af6",
            "a446d3ff918ec709"
        ],
        "x": 54,
        "y": 459,
        "w": 1612,
        "h": 82
    },
    {
        "id": "a45585ec53875b97",
        "type": "group",
        "z": "52c9c8914699459b",
        "g": "bedf5e7cfbbb08ae",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "fd3742c16651aa53",
            "5c1c44aa85f4edf2",
            "510844d6f3d6ec0f",
            "3f044a06b65be3dd",
            "2829e1d475c8ba8d",
            "ad35d00896669f77",
            "d3b34dbf44620283"
        ],
        "x": 314,
        "y": 1059,
        "w": 552,
        "h": 222
    },
    {
        "id": "9d043a8d975d248d",
        "type": "group",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "UI helper | set bounds for charge levels",
        "style": {
            "label": true,
            "stroke": "#3f93cf"
        },
        "nodes": [
            "dcaadb585f1b53a6",
            "947b46137c18f49b",
            "e50a791becbf6d1d"
        ],
        "x": 1464,
        "y": 159,
        "w": 692,
        "h": 82
    },
    {
        "id": "805549b5bb79c598",
        "type": "group",
        "z": "ab649936ec5003a8",
        "g": "c984065022545566",
        "name": "PID control inputs",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "dd0cc9762913d1db",
            "e9bf02259a6ecc0b",
            "06cfedaa81143368",
            "c324a93074b6e1fc",
            "d0f39168348cc038",
            "b890d7ba6c18f852",
            "3904652fd20ee276",
            "3f905823ddb6a8b1",
            "0082aa413582ab07"
        ],
        "x": 314,
        "y": 59,
        "w": 572,
        "h": 162
    },
    {
        "id": "e3dca719d51b04b0",
        "type": "group",
        "z": "ab649936ec5003a8",
        "g": "c984065022545566",
        "name": "Advanced features",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "1a961ede118a6d23",
            "bc7b56734abfb680",
            "722dfe99613280ac"
        ],
        "x": 914,
        "y": 39,
        "w": 252,
        "h": 182
    },
    {
        "id": "aa86505827b85572",
        "type": "group",
        "z": "ab649936ec5003a8",
        "g": "9e4f72ca6f793259",
        "name": "",
        "style": {
            "fill": "#ffffff",
            "label": true
        },
        "nodes": [
            "265987f795ab6051",
            "1541f06bbe603bf7",
            "1ed209c7d959a1c9",
            "1cedf7d85305828f"
        ],
        "x": 314,
        "y": 299,
        "w": 292,
        "h": 202
    },
    {
        "id": "c804bc50fc65d906",
        "type": "group",
        "z": "ab649936ec5003a8",
        "g": "9e4f72ca6f793259",
        "name": "Derivative - incl. bumpless operation",
        "style": {
            "label": true,
            "stroke": "#a4a4a4",
            "fill": "#ffffff"
        },
        "nodes": [
            "1a899c14f7559cee",
            "36b95740489adc7d",
            "eaa76629a0cdef9e",
            "6f9c9d096d7e0b9e",
            "4a4079d3e25c7e71"
        ],
        "x": 614,
        "y": 399,
        "w": 752,
        "h": 142
    },
    {
        "id": "185541e56b8b8a3c",
        "type": "group",
        "z": "ab649936ec5003a8",
        "g": "9e4f72ca6f793259",
        "name": "Processing required? ",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "93cfae05413d6893",
            "b4af701da6471fb3",
            "13c3ef285d60acdd"
        ],
        "x": 614,
        "y": 299,
        "w": 562,
        "h": 82
    },
    {
        "id": "eaf26e698ab1310a",
        "type": "group",
        "z": "ab649936ec5003a8",
        "g": "32b1c70698d0197d",
        "name": "PID controller",
        "style": {
            "label": true,
            "fill": "#ffffff",
            "color": "#3f3f3f"
        },
        "nodes": [
            "4da0fc165f249710",
            "764265c01b255e9e",
            "a08ea21098e3aa24",
            "34bc921932788e6b",
            "3c70ed30ae7d88b4",
            "ae5e4985c9c3d921",
            "b7f8246b058029e0",
            "dcbaf2c03edb16a5",
            "4da9d58fa844c7d6",
            "571ee1569bc2cde2",
            "4243807f05e15d17",
            "95cd1e4e56a5c34b",
            "55ddf1defd60268b",
            "0924bf623b7764e5",
            "f32cb03abc33125b",
            "a0f43e4c238d1e4c",
            "2dc86ab16ef6e934",
            "5d387a509968ca82",
            "3ed98e6437179b08",
            "836ddcc064563249"
        ],
        "x": 314,
        "y": 619,
        "w": 872,
        "h": 482
    },
    {
        "id": "6a196c081e1ca3ef",
        "type": "group",
        "z": "ab649936ec5003a8",
        "g": "32b1c70698d0197d",
        "name": "Distribution",
        "style": {
            "label": true,
            "fill": "#ffffff",
            "color": "#3f3f3f"
        },
        "nodes": [
            "9839c948e5837948",
            "ce084a7d3ebd2772"
        ],
        "x": 314,
        "y": 1119,
        "w": 452,
        "h": 82
    },
    {
        "id": "6adb6d0c1201ee54",
        "type": "group",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "UI helper | set bounds for charge levels",
        "style": {
            "label": true,
            "stroke": "#3f93cf"
        },
        "nodes": [
            "54877b224d3c485a",
            "fd4b568c70976982",
            "26a6fb39925f6219"
        ],
        "x": 1394,
        "y": 159,
        "w": 672,
        "h": 82
    },
    {
        "id": "728a3f886f7dc0af",
        "type": "junction",
        "z": "52c9c8914699459b",
        "x": 40,
        "y": 360,
        "wires": [
            [
                "5c85204217272545"
            ]
        ]
    },
    {
        "id": "49ac1529018b02b8",
        "type": "junction",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "x": 1490,
        "y": 260,
        "wires": [
            [
                "0e22f7f0d91f8e14"
            ]
        ]
    },
    {
        "id": "85f6dd8a93235509",
        "type": "junction",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "x": 600,
        "y": 320,
        "wires": [
            [
                "cb7c0de40d2ba570"
            ]
        ]
    },
    {
        "id": "b890d7ba6c18f852",
        "type": "junction",
        "z": "ab649936ec5003a8",
        "g": "805549b5bb79c598",
        "x": 460,
        "y": 100,
        "wires": [
            [
                "3f905823ddb6a8b1"
            ]
        ]
    },
    {
        "id": "3f905823ddb6a8b1",
        "type": "junction",
        "z": "ab649936ec5003a8",
        "g": "805549b5bb79c598",
        "x": 700,
        "y": 100,
        "wires": [
            [
                "3904652fd20ee276",
                "0082aa413582ab07"
            ]
        ]
    },
    {
        "id": "0082aa413582ab07",
        "type": "junction",
        "z": "ab649936ec5003a8",
        "g": "805549b5bb79c598",
        "x": 720,
        "y": 120,
        "wires": [
            [
                "e9bf02259a6ecc0b"
            ]
        ]
    },
    {
        "id": "f321edb9d2d83087",
        "type": "junction",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "x": 1440,
        "y": 260,
        "wires": [
            [
                "30d3a0c0b2fbd1ee"
            ]
        ]
    },
    {
        "id": "176d29a.6f648d6",
        "type": "server",
        "name": "Home Assistant",
        "addon": true,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "",
        "connectionDelay": false,
        "cacheJson": false,
        "heartbeat": false,
        "heartbeatInterval": "",
        "statusSeparator": "",
        "enableGlobalContextStore": false
    },
    {
        "id": "b9f84cc9f5a92c37",
        "type": "api-current-state",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 60,
        "wires": [
            [
                "db8935b06e0974bc"
            ]
        ]
    },
    {
        "id": "964d538dd74d6c05",
        "type": "function",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Set RS485 and Work Modes",
        "func": "// array for output \nlet outputArray = [];\n\n// battery to target\nconst target = `marstek_m${msg.battery_index}`;\n\n// Set | work mode\nconst workModeAction = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_user_work_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.work_mode)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.work_mode ? { payload: workModeAction, topic:\"user_work_mode\"}: null);\n\n// Set | rs485\nconst rs485Action = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_rs485_control_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.rs485)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.rs485 ? { payload: rs485Action, topic: \"rs485_control_mode\" } : null);\n\n// Store calls in msg to allow checking of loop results\nmsg.loop_result = { target, workModeAction, rs485Action };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Outputs\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 180,
        "wires": [
            [
                "0a5e50316b0d2b70"
            ],
            [
                "9875fb4be6ce951f"
            ],
            [
                "9f47be1a4b1c355b"
            ]
        ]
    },
    {
        "id": "db8935b06e0974bc",
        "type": "function",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// configurables\nlet workMode = null; // manual, anti-feed, ai, null = don't set or alter this setting\nlet rs485 = null;  // enable, disable, null = don't set or alter this setting\n\n// mode select\nswitch (msg.marstek_master_battery_mode) {\n    case \"Manual control\":\n        workMode = \"manual\";\n        rs485 = \"disable\";\n        break;\n    case \"Marstek control\":\n        // the user should select a work mode via the Marstek App or via select.marstek_mX_user_work_mode\n        rs485 = \"disable\";\n        break;\n    case \"Full control\":\n        rs485 = \"enable\";\n        break;\n    default:\n        node.status({fill:\"red\",shape:\"ring\",text:`Unhandled mode: ${msg.marstek_master_battery_mode}`});\n        return null; // stop flow\n}\n\n// Continue\nmsg.work_mode = workMode;\nmsg.rs485 = rs485;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 180,
        "wires": [
            [
                "964d538dd74d6c05"
            ]
        ]
    },
    {
        "id": "9f47be1a4b1c355b",
        "type": "function",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 240,
        "wires": [
            [
                "3141628fc4063a26",
                "06cec7476db26e79"
            ]
        ]
    },
    {
        "id": "3141628fc4063a26",
        "type": "switch",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 640,
        "y": 240,
        "wires": [
            [
                "964d538dd74d6c05"
            ],
            [
                "ce0d5547e473555e"
            ]
        ]
    },
    {
        "id": "0a5e50316b0d2b70",
        "type": "api-call-service",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Set work mode",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 800,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "9875fb4be6ce951f",
        "type": "api-call-service",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Set RS485",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 790,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "06cec7476db26e79",
        "type": "debug",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 510,
        "y": 280,
        "wires": []
    },
    {
        "id": "ce0d5547e473555e",
        "type": "debug",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 360,
        "wires": []
    },
    {
        "id": "64dc39c70599dfc4",
        "type": "server-state-changed",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Master control mode",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "marstek_master_battery_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 150,
        "y": 60,
        "wires": [
            [
                "b9f84cc9f5a92c37"
            ]
        ]
    },
    {
        "id": "7e47681b0b90d304",
        "type": "server-state-changed",
        "z": "db3d5e8e506ed595",
        "g": "f7c4130202d3fc9a",
        "name": "PID preset selected",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.house_battery_control_pid_presets"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 150,
        "y": 100,
        "wires": [
            [
                "53db92119d4503d8"
            ]
        ]
    },
    {
        "id": "12d5aaa80e1bb91b",
        "type": "api-call-service",
        "z": "db3d5e8e506ed595",
        "g": "f7c4130202d3fc9a",
        "name": "Kp",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_kp"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "ae2642f17e0509aa",
        "type": "api-call-service",
        "z": "db3d5e8e506ed595",
        "g": "f7c4130202d3fc9a",
        "name": "Ki",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_ki"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "07736a1f4286754d",
        "type": "api-call-service",
        "z": "db3d5e8e506ed595",
        "g": "f7c4130202d3fc9a",
        "name": "Kd",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_kd"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "53db92119d4503d8",
        "type": "function",
        "z": "db3d5e8e506ed595",
        "g": "f7c4130202d3fc9a",
        "name": "Presets",
        "func": "// See: house_battery_control.yaml > input_select: > house_battery_control_pid_presets\nconst preset = RED.util.getMessageProperty(msg,\"payload\");\nnode.status({fill:\"green\",shape:\"dot\",text:`${preset}`});\n\n\n// Default values\nlet Kp = 0; // Proportional gain\nlet Ki = 0; // Integral gain\nlet Kd = 0; // Differentiating gain\nlet Si = 0; // % Input smoothing (a Low pass moving average filter)\nlet So = 0; // % Output smoothing (a Low pass moving average filter)\n\nswitch (preset) {\n    // For people who have unstable systems with every other preset\n    case \"Very safe\":\n        Kp = 0.1;\n        Ki = 0.1;\n        Si = 0; // without Kd, this is preferred to be zero.\n        So = 10; // %\n        break;\n    // Good starting point for most\n    case \"Safe\":\n        Kp = 0.3;\n        Ki = 0.3;\n        Kd = 0.1;\n        Si = 20; // %\n        So = 0; // %\n        break;\n    // Gitcodebob's October 2025 settings for 3.2kWp PV and 5kW battery transformer power\n    case \"Regular\":\n        Kp = 0.3;\n        Ki = 0.4;\n        Kd = 0.8;\n        Si = 50; // % This high amount of filtering allows the stronger Kd\n        So = 10; // %\n        break;\n    default:\n        // Don't change values\n        return null;\n}\n\n// Prepare for three outputs\nreturn [\n    { \"payload\": Kp },\n    { \"payload\": Ki },\n    { \"payload\": Kd },\n    { \"payload\": Si },\n    { \"payload\": So }\n];",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 100,
        "wires": [
            [
                "12d5aaa80e1bb91b"
            ],
            [
                "ae2642f17e0509aa"
            ],
            [
                "07736a1f4286754d"
            ],
            [
                "da897ec87776e7ac"
            ],
            [
                "821ed7febefca284"
            ]
        ]
    },
    {
        "id": "da897ec87776e7ac",
        "type": "api-call-service",
        "z": "db3d5e8e506ed595",
        "g": "f7c4130202d3fc9a",
        "name": "Input Smooth",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_signal_dampening"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 530,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "821ed7febefca284",
        "type": "api-call-service",
        "z": "db3d5e8e506ed595",
        "g": "f7c4130202d3fc9a",
        "name": "Output Smoothing",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output_dampening"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 550,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "e88a2a22e98331f7",
        "type": "server-state-changed",
        "z": "52c9c8914699459b",
        "g": "47309eeeddad37dd",
        "name": "P1 meter",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.p1_meter_power"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": false,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "grid_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "timestamp",
                "propertyType": "msg",
                "value": "",
                "valueType": "date"
            }
        ],
        "x": 120,
        "y": 60,
        "wires": [
            [
                "572b90ad72de2db4"
            ]
        ]
    },
    {
        "id": "572b90ad72de2db4",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "47309eeeddad37dd",
        "name": "Master Control Mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.marstek_master_battery_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "master_mode",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 300,
        "y": 60,
        "wires": [
            [
                "3bb80c685f5dffbe"
            ]
        ]
    },
    {
        "id": "3bb80c685f5dffbe",
        "type": "switch",
        "z": "52c9c8914699459b",
        "g": "47309eeeddad37dd",
        "name": "when in \"Full Control\" mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 540,
        "y": 60,
        "wires": [
            [
                "e06ddb61ac3fa529"
            ]
        ]
    },
    {
        "id": "9af934c039dd4160",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "c2389c0b492c9c86",
        "name": "Battery Strategy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy",
                "propertyType": "flow",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 140,
        "y": 880,
        "wires": [
            [
                "6c2865f36f95871d"
            ]
        ]
    },
    {
        "id": "49b4552212958120",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "c2389c0b492c9c86",
        "name": "Strategy selection",
        "func": "// Logger\nconst logger = global.get(\"logger\");\n\n// INFLOW\nlet strategy = flow.get(\"house_battery_strategy\");\n\n// Configure msg.strategy object\nRED.util.setMessageProperty(msg,\"strategy.selected\",strategy,true);\nRED.util.setMessageProperty(msg,\"strategy.trace\",[],true);\n\n// stop on error\nif(msg.batteries === undefined) {\n    logger(this, \"Battery configuration undefined\", \"error\");\n    return null;\n}\nif(strategy === undefined) {\n    logger(this, \"Battery strategy undefined\", \"error\");\n    return null;\n}\n\n// select target flow based on the input_select `house_battery_strategy`\nmsg.target = `${strategy}`;\n\n// full stop trigger overrules ALL selected strategies\nconst stopTrigger = RED.util.getMessageProperty(msg,\"full_stop_trigger\");\nif(stopTrigger == \"on\" || stopTrigger === true || stopTrigger === 1) {\n    msg.target = 'Full stop';\n    // Explain\n    logger(this, `**Full Stop** strategy selected, due to (EV) stop trigger: '${stopTrigger}'`);\n}\n\n// add execution marker\nRED.util.setMessageProperty(msg,\"strategy.execution_start\",Date.now()); // when do we start executing the selected strategy\n\n// OUTPUT\nnode.status({fill:\"grey\",shape:\"dot\",text:msg.target});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 880,
        "wires": [
            [
                "a8a702493df2362a",
                "b6cfaaae61c2ab5d"
            ]
        ]
    },
    {
        "id": "b6cfaaae61c2ab5d",
        "type": "link call",
        "z": "52c9c8914699459b",
        "g": "c2389c0b492c9c86",
        "name": "Call \"Link in\" node",
        "links": [],
        "linkType": "dynamic",
        "timeout": "1.2",
        "x": 410,
        "y": 920,
        "wires": [
            [
                "02b9035c15eccf88",
                "e2bc27d66ecbb37a"
            ]
        ]
    },
    {
        "id": "a8a702493df2362a",
        "type": "debug",
        "z": "52c9c8914699459b",
        "g": "c2389c0b492c9c86",
        "name": "Input msg",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 680,
        "y": 880,
        "wires": []
    },
    {
        "id": "02b9035c15eccf88",
        "type": "debug",
        "z": "52c9c8914699459b",
        "g": "c2389c0b492c9c86",
        "name": "Returned msg",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 920,
        "wires": []
    },
    {
        "id": "e2bc27d66ecbb37a",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "c2389c0b492c9c86",
        "name": "Strategy evaluation",
        "func": "// add execution marker\nlet execution_end = Date.now();\nRED.util.setMessageProperty(msg, \"strategy.execution_end\", execution_end);\n\n// retrieve execution markers\nlet execution_start = RED.util.getMessageProperty(msg,\"strategy.execution_start\");\n\n// report execution time\nif (execution_start !== undefined && execution_end !== undefined) {\n    // exec time\n    let execution_time = (execution_end - execution_start) / 1000; // seconds\n    // report\n    if (execution_time <= 0) node.status({ fill: \"red\", shape: \"dot\", text: `negative or zero timing` });\n    if (execution_time > 0) node.status({ fill: \"green\", shape: \"dot\", text: `${execution_time} sec`});\n    if (execution_time >= 0.7) node.status({ fill: \"yellow\", shape: \"dot\", text: `${execution_time} sec` });\n    if (execution_time >= 1) node.status({ fill: \"red\", shape: \"dot\", text: `${execution_time} sec` });\n\n} else {\n    node.status({fill:\"grey\",shape:\"dot\",text:\"timing error\"});\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 960,
        "wires": [
            [
                "9f20bb161f85c299",
                "4a28992aa4ab8dbf",
                "b5ae87025e947205"
            ]
        ]
    },
    {
        "id": "6708d088bf1bea54",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "b275014260a268f5",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// Init an array for battery status and value information\nmsg.batteries = [];\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 420,
        "wires": [
            [
                "fb25bee5c67c58b3"
            ]
        ]
    },
    {
        "id": "1cbf70cdca0564a7",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "b275014260a268f5",
        "name": "Mapping",
        "func": "// Map to batteries array\nmsg.batteries.push({\n    id: `M${msg.battery_index}`,\n    power: parseInt(msg.battery_power,10),\n    charging_max: parseInt(msg.max_charge_power,10),\n    discharging_max: parseInt(msg.max_discharge_power,10),\n    soc: parseInt(msg.battery_state_of_charge,10),\n    soc_max: parseInt(msg.charging_cutoff_capacity,10),\n    soc_min: parseInt(msg.discharging_cutoff_capacity,10),\n    inverter: String(msg.inverter_state),\n    energy: Number(msg.battery_remaining_capacity),\n    energy_max: Number(msg.battery_total_energy),\n    rs485: String(msg.rs485_control_mode)\n    });\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 580,
        "wires": [
            [
                "d519e78d039ebdd4"
            ]
        ]
    },
    {
        "id": "37bb273079d8a07d",
        "type": "switch",
        "z": "52c9c8914699459b",
        "g": "b275014260a268f5",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 420,
        "y": 580,
        "wires": [
            [
                "fb25bee5c67c58b3"
            ],
            [
                "c380f606379a5d1e"
            ]
        ]
    },
    {
        "id": "05d15b8796456269",
        "type": "debug",
        "z": "52c9c8914699459b",
        "g": "b275014260a268f5",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 770,
        "y": 580,
        "wires": []
    },
    {
        "id": "5c85204217272545",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "b275014260a268f5",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 420,
        "wires": [
            [
                "6708d088bf1bea54"
            ]
        ]
    },
    {
        "id": "fb25bee5c67c58b3",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "1677eb562c842299",
        "name": "Control mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "select.marstek_m{{battery_index}}_rs485_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "rs485_control_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 160,
        "y": 500,
        "wires": [
            [
                "e2fe2b2a85e8dd63"
            ]
        ]
    },
    {
        "id": "6508555562eef85e",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "1677eb562c842299",
        "name": "SoC",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_state_of_charge",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_state_of_charge",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 850,
        "y": 500,
        "wires": [
            [
                "714f61920d832af6"
            ]
        ]
    },
    {
        "id": "6c3889bd1bf63fe4",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "1677eb562c842299",
        "name": "Inverter state",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_inverter_state",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "inverter_state",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1270,
        "y": 500,
        "wires": [
            [
                "a192dd2ec11fc220"
            ]
        ]
    },
    {
        "id": "c166e94487fedb9f",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "1677eb562c842299",
        "name": "Max discharge power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_discharge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_discharge_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 680,
        "y": 500,
        "wires": [
            [
                "6508555562eef85e"
            ]
        ]
    },
    {
        "id": "a192dd2ec11fc220",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "1677eb562c842299",
        "name": "Energy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_remaining_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_remaining_capacity",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1420,
        "y": 500,
        "wires": [
            [
                "3562e6184550b441"
            ]
        ]
    },
    {
        "id": "04b3971201cebd38",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "1677eb562c842299",
        "name": "Max charge power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_charge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_charge_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 470,
        "y": 500,
        "wires": [
            [
                "c166e94487fedb9f"
            ]
        ]
    },
    {
        "id": "e2fe2b2a85e8dd63",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "1677eb562c842299",
        "name": "Power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_power",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "battery_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 310,
        "y": 500,
        "wires": [
            [
                "04b3971201cebd38"
            ]
        ]
    },
    {
        "id": "5ff04af6ac3b3ac8",
        "type": "api-call-service",
        "z": "52c9c8914699459b",
        "g": "18fa0fa26afc5e2a",
        "name": "Node-RED status: OK",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.house_battery_control_has_node_red"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_boolean",
        "service": "turn_on",
        "x": 1760,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "f5f967aad10eaa46",
        "type": "inject",
        "z": "52c9c8914699459b",
        "g": "18fa0fa26afc5e2a",
        "name": "On deploy",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.1",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1410,
        "y": 60,
        "wires": [
            [
                "84cb41317c986889",
                "08f5fdb7f38ec302"
            ]
        ]
    },
    {
        "id": "fd3742c16651aa53",
        "type": "api-call-service",
        "z": "52c9c8914699459b",
        "g": "a45585ec53875b97",
        "name": "Set mode (charge/discharge/stop)",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 660,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "5c1c44aa85f4edf2",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "a45585ec53875b97",
        "name": "Set Batteries",
        "func": "// Logger\nconst log = global.get(\"logger\");\n\n// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n// Output format and target\nlet outputArray = [];\nlet solution = msg.solutions[msg.battery_index-1]; // Base-0, thus -1\nif (solution === undefined) {\n    log(this,`Can't find solution for index ${msg.battery_index - 1} in ${msg.solutions}, aborting...`,\"error\");\n    return null;\n}\nlet target = `marstek_${solution.id.toLowerCase()}`;\n\n// Safety | Id exists\nlet battery = msg.batteries.find(battery => battery.id === solution.id);\nif (battery === undefined) {\n    log(`Can't set battery ${solution.id}, aborting...`,\"error\");\n    return null;\n}\n// Safety | Power limit\nsolution.power = Math.min(solution.power, solution.mode == CMODE.CHARGE ? battery.charging_max: battery.discharging_max);\n\n// Set | Mode\nconst serviceCallMode = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_forcible_charge_discharge`]\n    },\n    \"data\": {\n         \"option\": String(solution.mode) // forced charge mode (stop, charge, discharge)\n    }\n};\n// Add topic to allow correct 'on change' filtering\noutputArray.push({payload: serviceCallMode, topic:solution.id});\n\n// Set | Power\nconst serviceCallPower = {\n    \"action\": \"number.set_value\",\n    \"target\": {\n        \"entity_id\": [\n            `number.${target}_forcible_charge_power`,\n            `number.${target}_forcible_discharge_power`\n            ]\n    },\n    \"data\": {\n        \"value\": Number(solution.power)\n    } \n};\n// Add topic to allow correct 'on change' filtering\noutputArray.push({payload: serviceCallPower, topic:solution.id});\n\n// Store service calls in msg to allow checking of loop results\nmsg.loop_result = { target, serviceCallMode, serviceCallPower };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Explain\nlog(this,`${target} ${String(solution.mode)} @ ${Number(solution.power)} Watt`);\n\n// Output\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 1140,
        "wires": [
            [
                "fd3742c16651aa53"
            ],
            [
                "d3b34dbf44620283"
            ],
            [
                "3f044a06b65be3dd"
            ]
        ],
        "inputLabels": [
            "Msg with a battery_index"
        ],
        "outputLabels": [
            "Select MODE",
            "Set POWER",
            "Msg"
        ]
    },
    {
        "id": "f54dab1eac570502",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "bedf5e7cfbbb08ae",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = msg.battery_count;\n\n// Debug\nRED.util.setMessageProperty(msg, \"debug\", `## Cohort ${Date.now()} ##`);\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 1140,
        "wires": [
            [
                "5c1c44aa85f4edf2"
            ]
        ]
    },
    {
        "id": "510844d6f3d6ec0f",
        "type": "switch",
        "z": "52c9c8914699459b",
        "g": "a45585ec53875b97",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 740,
        "y": 1200,
        "wires": [
            [
                "5c1c44aa85f4edf2"
            ],
            [
                "6164ecb2a7f01590"
            ]
        ]
    },
    {
        "id": "3f044a06b65be3dd",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "a45585ec53875b97",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index -= 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 1200,
        "wires": [
            [
                "510844d6f3d6ec0f",
                "ad35d00896669f77"
            ]
        ]
    },
    {
        "id": "2829e1d475c8ba8d",
        "type": "api-call-service",
        "z": "52c9c8914699459b",
        "g": "a45585ec53875b97",
        "name": "Set power (W)",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 760,
        "y": 1140,
        "wires": [
            []
        ]
    },
    {
        "id": "fd5417c04f3f46d8",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "bedf5e7cfbbb08ae",
        "name": "Timing start",
        "func": "RED.util.setMessageProperty(msg,\"setbatteries.execution_start\",Date.now());\nRED.util.setMessageProperty(msg,\"setbatteries.marker\", `M1_${Date.now()}`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 1100,
        "wires": [
            [
                "f54dab1eac570502"
            ]
        ]
    },
    {
        "id": "9f20bb161f85c299",
        "type": "switch",
        "z": "52c9c8914699459b",
        "g": "bedf5e7cfbbb08ae",
        "name": "solutions present",
        "property": "solutions",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "undefined",
                "vt": "jsonata"
            },
            {
                "t": "neq",
                "v": "undefined",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 150,
        "y": 1060,
        "wires": [
            [
                "50b780b89c4d458b"
            ],
            [
                "fd5417c04f3f46d8"
            ]
        ]
    },
    {
        "id": "6164ecb2a7f01590",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "bedf5e7cfbbb08ae",
        "name": "Timing end",
        "func": "let start = RED.util.getMessageProperty(msg,\"setbatteries.execution_start\");\nlet end = Date.now();\nlet delta = end - start;\nlet timingString = `${delta/1000} sec`;\n\nnode.status({fill:\"green\",shape:\"dot\",text: timingString});\nmsg.delta = delta;\nmsg.timing = timingString;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 1320,
        "wires": [
            [
                "303356a49aa21bb8",
                "34d5920bcea00bd1"
            ]
        ]
    },
    {
        "id": "ad35d00896669f77",
        "type": "debug",
        "z": "52c9c8914699459b",
        "g": "a45585ec53875b97",
        "name": "Step result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 750,
        "y": 1240,
        "wires": []
    },
    {
        "id": "d3b34dbf44620283",
        "type": "rbe",
        "z": "52c9c8914699459b",
        "g": "a45585ec53875b97",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 590,
        "y": 1140,
        "wires": [
            [
                "2829e1d475c8ba8d"
            ]
        ]
    },
    {
        "id": "303356a49aa21bb8",
        "type": "debug",
        "z": "52c9c8914699459b",
        "g": "bedf5e7cfbbb08ae",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "debug",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 270,
        "y": 1320,
        "wires": []
    },
    {
        "id": "d519e78d039ebdd4",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "b275014260a268f5",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 580,
        "wires": [
            [
                "37bb273079d8a07d"
            ]
        ]
    },
    {
        "id": "707e57cc9d80c1c4",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "9e5eaeb5424fa705",
        "name": "Update battery order",
        "func": "// Cycles battery priority as follows\n// M=1 [1,2,3,4] | M=2 [2,3,4,1] | M=3 [3,4,1,2] | etc.\n// With M the battery to prioritize\n\n// msg.batteries (original order)\nlet currentArray = msg.batteries;\n\n// Prioritize the Mth battery\nconst M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// 1st battery has prio? Skip and continue without change\nif (M==1) return msg;\n\n// N equals the number of items to take from the front to the back of the array, effectivly rotating battery priority\nconst N = M - 1; // base-0 version of M\nnode.status({fill:\"blue\",shape:\"ring\",text:`N = ${N}`});\n\n// 1. Check if the array is valid and long enough\nif (!Array.isArray(currentArray) || currentArray.length < N) {\n    // Send an error or the original array back if the array is invalid/too short\n    node.error(`Array is not valid or shorter than ${N} items.`, msg);\n    return null;\n}\n\n// 2. Get the first N items (these will go to the back)\n// slice(0, N) retrieves elements from the start (index 0) up to index N (exclusive).\nlet firstN = currentArray.slice(0, N);\n\n// 3. Get the remaining items (these will stay at the front)\n// slice(N) retrieves elements from index N to the end of the array.\nlet remaining = currentArray.slice(N);\n\n// 4. Concatenate them: remaining items (front) + first N items (back)\nlet newArray = remaining.concat(firstN);\n\n// 5. Place the new array back into msg.batteries\nmsg.batteries = newArray;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 780,
        "wires": [
            [
                "9af934c039dd4160"
            ]
        ]
    },
    {
        "id": "a5c2b5baa0daef04",
        "type": "inject",
        "z": "52c9c8914699459b",
        "g": "9e5eaeb5424fa705",
        "name": "Every day 02:00",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 02 * * *",
        "once": false,
        "onceDelay": "5",
        "topic": "cycle_battery_priority",
        "payload": "",
        "payloadType": "date",
        "x": 610,
        "y": 780,
        "wires": [
            [
                "e27ca6736994f2a2"
            ]
        ]
    },
    {
        "id": "79e084940a21e2a0",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "9e5eaeb5424fa705",
        "name": "Change priority",
        "func": "// Current prioritized battery is the Mth battery\nlet M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// Prioritize the next battery\nM += 1;\n\n// If the next battery does not exist, prioritize the first again\nif(M > msg.battery_count) M = 1;\n\n// Pass along as payload\nmsg.payload = M;\n\n// Show which battery has priority\nnode.status({fill:\"green\",shape:\"dot\",text:`Prioritize battery #${M}`});\n\n// Done\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1540,
        "y": 780,
        "wires": [
            [
                "12ed3433da7af941"
            ]
        ]
    },
    {
        "id": "d4072f1ed8285936",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "9e5eaeb5424fa705",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1350,
        "y": 780,
        "wires": [
            [
                "79e084940a21e2a0"
            ]
        ]
    },
    {
        "id": "5512920e211340b7",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "9e5eaeb5424fa705",
        "name": "Prioritize battery M",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_prioritize_battery",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "prioritize_battery",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 780,
        "wires": [
            [
                "707e57cc9d80c1c4"
            ]
        ]
    },
    {
        "id": "12ed3433da7af941",
        "type": "api-call-service",
        "z": "52c9c8914699459b",
        "g": "9e5eaeb5424fa705",
        "name": "Update prioritized battery",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_prioritize_battery"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1750,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "e27ca6736994f2a2",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "9e5eaeb5424fa705",
        "name": "Desired interval",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_control_priority_change_interval",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 780,
        "wires": [
            [
                "05709f29ec2f3a5e"
            ]
        ]
    },
    {
        "id": "05709f29ec2f3a5e",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "9e5eaeb5424fa705",
        "name": "Check interval ",
        "func": "// Manual priority, never pass\nif(msg.payload == \"Never\") {\n    node.status({fill:\"yellow\",shape:\"dot\",text:\"Auto cycle disabled\"});\n    return null;\n}\n\n// Daily interval, always pass\nif(msg.payload == \"Daily\") {\n    node.status({ fill: \"green\", shape: \"dot\", text: `Pass` });\n    return msg;\n}\n\n// Weekly interval\nconst today = new Date();\n// Get the day of the week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)\nconst dayOfWeek = today.getDay();\n\n// Check if the day is Sunday (which is represented by the number 0)\nif (dayOfWeek === 0) {\n    // If it is Sunday, pass\n    node.status({ fill: \"green\", shape: \"dot\", text: `Passed on Sunday` });\n    return msg;\n} else {\n    // If it is not Sunday, stop\n    node.status({ fill: \"yellow\", shape: \"dot\", text: `Halted, not Sunday` });\n    return null;\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 780,
        "wires": [
            [
                "121a4935cb0cf64b"
            ]
        ]
    },
    {
        "id": "121a4935cb0cf64b",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "9e5eaeb5424fa705",
        "name": "Current priority",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_prioritize_battery",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "prioritize_battery",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1160,
        "y": 780,
        "wires": [
            [
                "d4072f1ed8285936"
            ]
        ]
    },
    {
        "id": "cf30b8e3347e871b",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "8b2e354dccd571e9",
        "name": "Batteries (totals)",
        "func": "// batteries | calculate total and max. power delivered by batteries\nlet batteries = msg.batteries;\nlet batteries_total_power = 0;\nlet batteries_max_charging_power = 0;\nlet batteries_max_discharging_power = 0;\nlet batteries_available_energy = 0;\nlet batteries_max_energy = 0;\n\nbatteries.forEach(battery => {\n    batteries_total_power += Number(battery.power);\n    batteries_max_charging_power += Number(battery.charging_max);\n    batteries_max_discharging_power += Number(battery.discharging_max);\n    batteries_available_energy += Number(battery.energy - battery.energy_max*battery.soc_min/100);\n    batteries_max_energy += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_total_power\", batteries_total_power, true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_charge_power\", batteries_max_charging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_discharge_power\", batteries_max_discharging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_available_energy\",batteries_available_energy,true); // kWh usable\nRED.util.setMessageProperty(msg, \"batteries_max_energy\", batteries_max_energy, true); // kWh usable\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 680,
        "wires": [
            [
                "5512920e211340b7",
                "67f7cf0ecb40876b"
            ]
        ],
        "inputLabels": [
            "Mapping (from Home Battery IO)"
        ]
    },
    {
        "id": "3562e6184550b441",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "1677eb562c842299",
        "name": "Energy max",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_total_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_total_energy",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1570,
        "y": 500,
        "wires": [
            [
                "1cbf70cdca0564a7"
            ]
        ]
    },
    {
        "id": "c380f606379a5d1e",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "b275014260a268f5",
        "name": "Loop end",
        "func": "// cleanup \ndelete msg.battery_index;\n\ndelete msg.battery_power;\ndelete msg.max_charge_power;\ndelete msg.max_discharge_power;\ndelete msg.battery_state_of_charge;\ndelete msg.charging_cutoff_capacity;\ndelete msg.discharging_cutoff_capacity;\ndelete msg.inverter_state;\ndelete msg.battery_remaining_capacity;\ndelete msg.battery_total_energy;\ndelete msg.rs485_control_mode;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 580,
        "wires": [
            [
                "05d15b8796456269",
                "cf30b8e3347e871b"
            ]
        ]
    },
    {
        "id": "e6dbf470abd5cbb0",
        "type": "api-call-service",
        "z": "52c9c8914699459b",
        "g": "3d2ce9212cc2f54e",
        "name": "Set total usable energy",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_total_available_energy"
        ],
        "labelId": [],
        "data": "{\"value\":$$.batteries_available_energy}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1760,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "6c2865f36f95871d",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "c2389c0b492c9c86",
        "name": "Full Stop Trigger",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.ev_is_charging",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "full_stop_trigger",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 140,
        "y": 940,
        "wires": [
            [
                "49b4552212958120"
            ]
        ]
    },
    {
        "id": "67f7cf0ecb40876b",
        "type": "rbe",
        "z": "52c9c8914699459b",
        "g": "3d2ce9212cc2f54e",
        "name": "On change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "batteries_available_energy",
        "topi": "topic",
        "x": 1570,
        "y": 680,
        "wires": [
            [
                "e6dbf470abd5cbb0"
            ]
        ]
    },
    {
        "id": "b63962b0d48cc72e",
        "type": "switch",
        "z": "52c9c8914699459b",
        "g": "d1760f49d88b8c18",
        "name": "Select rate limit",
        "property": "p1_rate_limit.save_power",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 660,
        "y": 280,
        "wires": [
            [
                "142b3f6e6eef61c5"
            ],
            [
                "1acca348555adf72"
            ]
        ]
    },
    {
        "id": "0d7e2fa8b04163ca",
        "type": "delay",
        "z": "52c9c8914699459b",
        "g": "d1760f49d88b8c18",
        "name": "Rate limit",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": true,
        "outputs": 2,
        "x": 980,
        "y": 280,
        "wires": [
            [
                "d62c85af911988de"
            ],
            [
                "c9b3426939827168"
            ]
        ],
        "outputLabels": [
            "Pass",
            ""
        ]
    },
    {
        "id": "1acca348555adf72",
        "type": "change",
        "z": "52c9c8914699459b",
        "g": "d1760f49d88b8c18",
        "name": "1 msg/s",
        "rules": [
            {
                "t": "set",
                "p": "rate",
                "pt": "msg",
                "to": "1000",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 300,
        "wires": [
            [
                "0d7e2fa8b04163ca"
            ]
        ]
    },
    {
        "id": "142b3f6e6eef61c5",
        "type": "change",
        "z": "52c9c8914699459b",
        "g": "d1760f49d88b8c18",
        "name": "0.333 msg/s",
        "rules": [
            {
                "t": "set",
                "p": "rate",
                "pt": "msg",
                "to": "3000",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 830,
        "y": 260,
        "wires": [
            [
                "0d7e2fa8b04163ca"
            ]
        ]
    },
    {
        "id": "242a43037dd51384",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "d1760f49d88b8c18",
        "name": "P1 change (20W or 2%)",
        "func": "// Switch between low and high rate limiting to decrease load and power consumption\n// --\n// The flow should always be rate limited by atleast the total execution time of strategies\n// The flow should not lock up indefinitly when grid_power is constant.\n// In the latter case, a more relaxed rate limit can help reduce system load.\n// Devs: don't set msg.rate directly. Use nodes, so novice users can easily read the flow.\n\n// Thresholds for change in power, before switching to high rate limit\nconst THRESHOLD_POWER = 20; // Watt change\nconst THRESHOLD_PERCENT = 2; // Percentage\nRED.util.setMessageProperty(msg, \"p1_rate_limit.threshold_power\", THRESHOLD_POWER,true);\nRED.util.setMessageProperty(msg, \"p1_rate_limit.threshold_percent\", THRESHOLD_PERCENT, true);\n\n// Get the previous value from this node's context\n// If it doesn't exist yet, initialize it as null\nlet previousValue = context.get('previousValue') || null;\nlet currentValue = Number(msg.grid_power);\n\n// Save the current value for the next time the node is triggered\ncontext.set('previousValue', currentValue);\n\n// Default rate limiting\nRED.util.setMessageProperty(msg,\"p1_rate_limit.save_power\",true);\n\n// Check if we have a valid history to compare with\nif (previousValue !== null) {\n    let powerChange = Math.abs(currentValue - previousValue);\n    let percentageChange = previousValue !== 0 ? Math.abs((powerChange / previousValue) * 100):0;\n\n    // Condition: Absolute difference > N Watt AND percentage change > M %\n    if (powerChange > THRESHOLD_POWER && percentageChange > THRESHOLD_PERCENT) {\n        // Enable faster refresh rate\n        RED.util.setMessageProperty(msg,\"p1_rate_limit.save_power\",false);\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 280,
        "wires": [
            [
                "b63962b0d48cc72e"
            ]
        ]
    },
    {
        "id": "f998af9f93370978",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "d1760f49d88b8c18",
        "name": "CPU power saved",
        "func": "// Logger\nconst logger = global.get(\"logger\");\n\n// Passed or blocked\nconst hasPassed = msg.payload; // 0 = blocked, 1 = passed\n\n// 1. Get evaluations (Total attempts)\nlet evaluations = (context.get(\"p1_rate_limit_evaluations\") || 0) + 1;\ncontext.set(\"p1_rate_limit_evaluations\", evaluations);\n\n// 2. Increment and get passes (Filtered/successful events)\nlet passes = (context.get(\"p1_rate_limit_passes\") || 0) + hasPassed;\ncontext.set(\"p1_rate_limit_passes\", passes);\n\n// 3a. Calculate percentage (Rate of passing vs total evaluations)\nlet percentage = evaluations > 0 ? (passes / evaluations) * 100 : 0;\n// 3b. Display the percentage rate of not-passing as a measure of efficiency gained\npercentage = 100 - percentage;\n\n// 4. Update Node Status\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `Saved: ${percentage.toFixed(2)}% (${evaluations-passes}/${evaluations})`\n});\n\n// 5. Explain\n// On block\nif(hasPassed === 0) {\n    if(msg.p1_rate_limit.save_power === true) {\n        // This is good\n        logger(this, `<font color=\"#009ac7\">Power saved</font> by P1 Rate Limiter, execution stopped.`); \n    } else {\n        // This is not so good. P1 updates are coming in fast.\n        logger(this, `<font color=\"orange\">Blocked</font> by P1 Rate Limiter. ${Number(1000/msg.rate).toFixed(2)} messages per second exceeded.`); \n    }\n    \n    // Send message onward to debug dashboard\n    return msg;\n}\n// No output on pass\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1270,
        "y": 280,
        "wires": [
            [
                "a32e88e95de6a99c"
            ]
        ]
    },
    {
        "id": "4a28992aa4ab8dbf",
        "type": "debug",
        "z": "52c9c8914699459b",
        "g": "c2389c0b492c9c86",
        "name": "Strategy evaluation",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 960,
        "wires": []
    },
    {
        "id": "5c9c40395e9574f5",
        "type": "api-call-service",
        "z": "52c9c8914699459b",
        "g": "3d5229715a1f55ed",
        "name": "Show on dashboard",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_text.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_text.house_battery_strategy_active_sub_strategy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.ui_value_new}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_text",
        "service": "set_value",
        "x": 1760,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "b5ae87025e947205",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "3d5229715a1f55ed",
        "name": "current UI value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.house_battery_strategy_active_sub_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "ui_value_current",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1360,
        "y": 960,
        "wires": [
            [
                "9e3c1dfd5cad854e"
            ]
        ]
    },
    {
        "id": "9e3c1dfd5cad854e",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "3d5229715a1f55ed",
        "name": "on new UI value",
        "func": "// Block when undefined (don't update UI)\nif(msg.ui_value_current === undefined) return null;\n\n// We show the 2nd strategy in the trace (if available) on the dashboard as the 'active sub-strategy'\nconst secondTraceEntry = msg.strategy?.trace?.[1];\nif (secondTraceEntry) {\n    // Handle case where 2nd flow is present\n    msg.ui_value_new =  secondTraceEntry.flow;\n} else {\n    // Handle case where the 2nd flow is missing\n    // Get a sensible alternative\n    msg.ui_value_new = msg.strategy?.selected || \"\"; // don't use unknown or unavailable as these are reserved HA keywords\n}\n\n// Improve human readability\nif(msg.ui_value_new == \"Self-consumption\" && secondTraceEntry?.flow_settings?.discharge_disabled === true){\n    msg.ui_value_new = \"Self-consumption (charge only)\";\n}\nif(msg.ui_value_new == \"Self-consumption\" && secondTraceEntry?.flow_settings?.charge_disabled === true){\n    msg.ui_value_new = \"Self-consumption (no charging)\";\n}\n\n// Node status for devs\nnode.status({fill:\"grey\",shape:\"dot\",text:`new: ${msg.ui_value_new}`});\n\n// Block when equal (don't update UI)\nif(msg.ui_value_current === msg.ui_value_new) return null;\n\n// Pass otherwise\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1560,
        "y": 960,
        "wires": [
            [
                "5c9c40395e9574f5"
            ]
        ]
    },
    {
        "id": "1384404e641cd150",
        "type": "ha-fire-event",
        "z": "52c9c8914699459b",
        "g": "18846dd2ccb6b8a3",
        "name": "Show on debug board",
        "server": "176d29a.6f648d6",
        "version": 0,
        "event": "update_trace_sensor",
        "data": "{\t   \"trace\": strategy.trace ? strategy.trace : [],\t   \"start\": strategy.execution_start ? strategy.execution_start : 0,\t   \"end\": strategy.execution_end ? strategy.execution_end : 0,\t   \"log\": log ? log : []\t}",
        "dataType": "jsonata",
        "x": 1740,
        "y": 1320,
        "wires": [
            []
        ]
    },
    {
        "id": "e06ddb61ac3fa529",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "1a62ec01b467c889",
        "name": "Debug mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_control_is_debug_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "debug_mode",
                "propertyType": "msg",
                "value": "ha_boolean",
                "valueType": "entityState"
            },
            {
                "property": "debug_mode",
                "propertyType": "global",
                "value": "ha_boolean",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 130,
        "y": 160,
        "wires": [
            [
                "450ad3f210922762"
            ]
        ]
    },
    {
        "id": "34d5920bcea00bd1",
        "type": "switch",
        "z": "52c9c8914699459b",
        "g": "18846dd2ccb6b8a3",
        "name": "Debug mode?",
        "property": "debug_mode",
        "propertyType": "global",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1540,
        "y": 1320,
        "wires": [
            [
                "1384404e641cd150"
            ]
        ]
    },
    {
        "id": "339220163710070f",
        "type": "server-state-changed",
        "z": "52c9c8914699459b",
        "g": "1a62ec01b467c889",
        "name": "On debug",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 2,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_boolean.house_battery_control_is_debug_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "on",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 380,
        "y": 160,
        "wires": [
            [
                "be7035a364493de8"
            ],
            []
        ]
    },
    {
        "id": "be7035a364493de8",
        "type": "trigger",
        "z": "52c9c8914699459b",
        "g": "1a62ec01b467c889",
        "name": "disable debug after 5 minutes",
        "op1": "",
        "op2": "off",
        "op1type": "nul",
        "op2type": "str",
        "duration": "5",
        "extend": false,
        "overrideDelay": false,
        "units": "min",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 590,
        "y": 160,
        "wires": [
            [
                "ff09b484f05bbde8"
            ]
        ]
    },
    {
        "id": "ff09b484f05bbde8",
        "type": "api-call-service",
        "z": "52c9c8914699459b",
        "g": "1a62ec01b467c889",
        "name": "Turn debug OFF",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.house_battery_control_is_debug_mode"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_boolean",
        "service": "turn_off",
        "x": 820,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "84cb41317c986889",
        "type": "delay",
        "z": "52c9c8914699459b",
        "g": "18fa0fa26afc5e2a",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1580,
        "y": 60,
        "wires": [
            [
                "5ff04af6ac3b3ac8"
            ]
        ]
    },
    {
        "id": "08f5fdb7f38ec302",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "772d5c1be97f0a16",
        "name": "Custom logger",
        "func": "/**\n * Custom Logger Function\n * * Provides centralized logging, node-status updates, and message tracing.\n * Specifically designed for Home Battery Control logic within Node-RED.\n * \n * Debug dashboard updating:\n * A msg needs to reach 'Strategy Evaluation' or be passed to the \"Show on debug board\" trigger node.\n * Errors are automatically passed to the \"Show on debug board\" trigger node.\n * \n * * @param {object} callingNode - The context of the calling node (pass 'this').\n * @param {string} text - The log message/explanation.\n * @param {string} level - Log level: 'log', 'warn', 'error', or 'info' (default: 'info').\n * \n * Note: anything above 'info' will also write to the Node-RED log files \n * \n * * @usage: \n * const log = global.get(\"logger\");\n * log(this, \"Charging cycle started\");\n */\nconst customLogger = (callingNode, text, level = 'info') => {\n    \n    // Log only when debug_mode is ON\n    const debug_mode = global.get(\"debug_mode\") || false;\n    if(debug_mode == false) return null;\n\n    // Max log elements to keep\n    const MAX_ELEMENTS = 100;\n\n    // Create the YYYY-MM-DD HH:MM:SS.mmm format\n    const now = new Date();\n    const timestamp = now.getHours().toString().padStart(2, '0') + \":\" +\n                now.getMinutes().toString().padStart(2, '0') + \":\" +\n                now.getSeconds().toString().padStart(2, '0') + \".\" +\n                now.getMilliseconds().toString().padStart(3, '0');\n\n    const formattedTimeLevel = `${timestamp} [${level.toLowerCase()}]`;\n    \n    // Get the name of the node or fallback to the ID\n    const nodeName = callingNode.__node__ ? callingNode.__node__.name || callingNode.__node__.id : undefined;\n    // Get the name of the Flow/Tab\n    const flowName = callingNode.env.get(\"NR_FLOW_NAME\") || \"Unknown flow\";\n    // Explain to the Home Battery Control user what is going on\n    const formattedExplenation = `[${flowName} >> ${nodeName}]: ${text}`;\n\n    // Level icons\n    let icon = \"\";\n    switch (level) {\n        case \"info\":\n            icon = \"\";\n            break;\n        case \"log\":\n            icon = \"\";\n            break;\n        case \"warn\":\n            icon = \"\";      \n            break;\n        case \"error\":\n            icon = \"\";\n            break;\n    }\n\n    // Enrich msg with log info\n    const msg = callingNode.msg;\n    (msg.log = msg.log || []).push({ timestamp: timestamp, level:level, flow:flowName, node:nodeName, payload: text, icon: icon});\n\n    if (msg.log.length > MAX_ELEMENTS) {\n        // Slice keeps the last X elements\n        msg.log = msg.log.slice(-MAX_ELEMENTS);\n    }\n\n    // Log to the Node-RED system log\n    switch (level) {\n        case \"log\":\n            node.log(`${formattedExplenation}`);\n            break;\n        case \"warn\":\n            node.warn(`${formattedExplenation}`);       \n            break;\n        case \"error\":\n            node.error(`${formattedExplenation}`, callingNode.msg);\n            break;\n        default:\n            // don't log to logfiles by default\n    }\n\n};\n\nglobal.set('logger', customLogger);\nglobal.set('unhandledException', \"\");\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1740,
        "y": 160,
        "wires": [
            [
                "9d481f78dbe3e15f"
            ]
        ]
    },
    {
        "id": "d62c85af911988de",
        "type": "change",
        "z": "52c9c8914699459b",
        "g": "d1760f49d88b8c18",
        "name": "Pass",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "1",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1110,
        "y": 300,
        "wires": [
            [
                "f998af9f93370978",
                "728a3f886f7dc0af"
            ]
        ]
    },
    {
        "id": "c9b3426939827168",
        "type": "change",
        "z": "52c9c8914699459b",
        "g": "d1760f49d88b8c18",
        "name": "Block",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1110,
        "y": 260,
        "wires": [
            [
                "f998af9f93370978"
            ]
        ]
    },
    {
        "id": "c4c329decd25f94a",
        "type": "link in",
        "z": "52c9c8914699459b",
        "g": "18846dd2ccb6b8a3",
        "name": "Update debug dashboard",
        "links": [
            "a32e88e95de6a99c",
            "50b780b89c4d458b"
        ],
        "x": 1395,
        "y": 1260,
        "wires": [
            [
                "34d5920bcea00bd1",
                "f4935b42f173f842"
            ]
        ]
    },
    {
        "id": "a32e88e95de6a99c",
        "type": "link out",
        "z": "52c9c8914699459b",
        "g": "d1760f49d88b8c18",
        "name": "goto Debug Dashboard update",
        "mode": "link",
        "links": [
            "c4c329decd25f94a"
        ],
        "x": 1395,
        "y": 280,
        "wires": []
    },
    {
        "id": "bc929ea9453410e3",
        "type": "catch",
        "z": "52c9c8914699459b",
        "g": "18846dd2ccb6b8a3",
        "name": "Custom logger",
        "scope": [
            "08f5fdb7f38ec302"
        ],
        "uncaught": false,
        "x": 1340,
        "y": 1380,
        "wires": [
            [
                "34d5920bcea00bd1",
                "4813b0642da5b375"
            ]
        ]
    },
    {
        "id": "4813b0642da5b375",
        "type": "debug",
        "z": "52c9c8914699459b",
        "g": "18846dd2ccb6b8a3",
        "name": "Via Catch",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "counter",
        "x": 1520,
        "y": 1380,
        "wires": []
    },
    {
        "id": "f4935b42f173f842",
        "type": "debug",
        "z": "52c9c8914699459b",
        "g": "18846dd2ccb6b8a3",
        "name": "Via link",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "counter",
        "x": 1520,
        "y": 1260,
        "wires": []
    },
    {
        "id": "50b780b89c4d458b",
        "type": "link out",
        "z": "52c9c8914699459b",
        "g": "bedf5e7cfbbb08ae",
        "name": "link out 1",
        "mode": "link",
        "links": [
            "c4c329decd25f94a"
        ],
        "x": 285,
        "y": 1060,
        "wires": []
    },
    {
        "id": "c1290f4e45d3e136",
        "type": "switch",
        "z": "52c9c8914699459b",
        "g": "d1760f49d88b8c18",
        "name": "Skip rate limiter during debug",
        "property": "debug_mode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 180,
        "y": 280,
        "wires": [
            [
                "242a43037dd51384"
            ],
            [
                "728a3f886f7dc0af"
            ]
        ]
    },
    {
        "id": "450ad3f210922762",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "1a62ec01b467c889",
        "name": "Notice",
        "func": "// Explain when debugging\nif(msg.debug_mode == true){\n    const log = global.get(\"logger\");\n    log(this, \"P1 Rate limiter is *disabled* during *debug mode*\");\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 235,
        "y": 160,
        "wires": [
            [
                "c1290f4e45d3e136"
            ]
        ],
        "l": false
    },
    {
        "id": "714f61920d832af6",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "1677eb562c842299",
        "name": "SoC min",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.marstek_m{{battery_index}}_discharging_cutoff_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "discharging_cutoff_capacity",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 980,
        "y": 500,
        "wires": [
            [
                "a446d3ff918ec709"
            ]
        ]
    },
    {
        "id": "a446d3ff918ec709",
        "type": "api-current-state",
        "z": "52c9c8914699459b",
        "g": "1677eb562c842299",
        "name": "SoC max",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.marstek_m{{battery_index}}_charging_cutoff_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charging_cutoff_capacity",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1120,
        "y": 500,
        "wires": [
            [
                "6c3889bd1bf63fe4"
            ]
        ]
    },
    {
        "id": "9d481f78dbe3e15f",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "772d5c1be97f0a16",
        "name": "Unhandled Exception",
        "func": "/**\n * Handles exceptions by extracting node details and routing them to a global logger.\n * This is designed to be called from within a Node-RED Function node or sub-flow.\n *\n * @param {Object} callingNode - The Node-RED 'this' context or msg object containing node metadata.\n * @param {Object} [callingNode.msg] - The message object associated with the error.\n * @param {Object} [callingNode.msg.error] - Error details provided by a Node-RED error catch.\n * @param {string} [callingNode.msg.error.message] - The specific error message.\n * @param {Object} [callingNode.msg.error.source] - The node that triggered the error.\n * * @example\n * // Usage in a Function Node:\n * const unhandledException = global.get('unhandledException');\n * unhandledException(this);\n */\nconst unhandledException = (callingNode) => {\n    // 1. Get the custom logger from global context\n    const log = global.get(\"logger\");\n\n    // 2. Extract error details from the msg object\n    const errorData = callingNode.msg?.error || {};\n    const errorMessage = errorData.message || \"Unknown error occurred\";\n    const sourceName = errorData.source ? (errorData.source.name || errorData.source.id) : \"Unknown Node\";\n    const sourceType = errorData.source ? errorData.source.type : \"unknown-type\";\n\n    // 3. Construct a user-friendly message for the logger\n    const friendlyMessage = `**Unhandled exception** (${sourceType} node) ${errorMessage}`;\n    callingNode.__node__ ??= {};\n    callingNode.__node__.name = sourceName;\n\n    // 4. Call the logger with level 'error'\n    // Note: the logger uses 'callingNode', we pass on whatever we have.\n    log(callingNode, friendlyMessage, 'error');\n\n};\n\nglobal.set('unhandledException', unhandledException);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1760,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "8219a8e42f2d8841",
        "type": "catch",
        "z": "52c9c8914699459b",
        "g": "2ed9a80737079874",
        "name": "",
        "scope": null,
        "uncaught": true,
        "x": 1745,
        "y": 320,
        "wires": [
            [
                "a85c30d990dba021"
            ]
        ],
        "l": false
    },
    {
        "id": "a85c30d990dba021",
        "type": "function",
        "z": "52c9c8914699459b",
        "g": "2ed9a80737079874",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1795,
        "y": 320,
        "wires": [
            [
                "50179ca8d725bdfe"
            ]
        ],
        "l": false
    },
    {
        "id": "50179ca8d725bdfe",
        "type": "link out",
        "z": "52c9c8914699459b",
        "g": "2ed9a80737079874",
        "name": "link out 9",
        "mode": "return",
        "links": [],
        "x": 1845,
        "y": 320,
        "wires": []
    },
    {
        "id": "a5e9e484430e1720",
        "type": "link in",
        "z": "676ceac4c521834d",
        "g": "72059e541379a869",
        "name": "Charge PV",
        "links": [],
        "x": 100,
        "y": 160,
        "wires": [
            [
                "be2a48e071dee195"
            ]
        ],
        "l": true
    },
    {
        "id": "13aeb5c39ba83e0a",
        "type": "comment",
        "z": "676ceac4c521834d",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "bf548077ba6ca350",
        "type": "comment",
        "z": "676ceac4c521834d",
        "g": "72059e541379a869",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "87be4b85f89829b6",
        "type": "link out",
        "z": "676ceac4c521834d",
        "g": "9889d591bcc38e89",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 665,
        "y": 180,
        "wires": []
    },
    {
        "id": "d62d870eb44d3582",
        "type": "comment",
        "z": "676ceac4c521834d",
        "g": "9889d591bcc38e89",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 720,
        "y": 120,
        "wires": []
    },
    {
        "id": "682972c51f2870ed",
        "type": "function",
        "z": "676ceac4c521834d",
        "name": "Setup",
        "func": "// explain\nconst log = global.get(\"logger\");\nlog(this,\"Using self-consumption to charge with surplus PV\")\n\n// use the self consumption strategy to charge when there is PV surplus\nmsg.target = \"Self-consumption\";\n\n// tell that strategy to disalow discharging\nconst DISABLE_DISCHARGE = true;\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\",DISABLE_DISCHARGE,true);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 180,
        "wires": [
            [
                "17645a134fe6d941"
            ]
        ]
    },
    {
        "id": "17645a134fe6d941",
        "type": "link call",
        "z": "676ceac4c521834d",
        "name": "Self-consumption",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 470,
        "y": 180,
        "wires": [
            [
                "d612533a5317bb76",
                "87be4b85f89829b6"
            ]
        ]
    },
    {
        "id": "d612533a5317bb76",
        "type": "debug",
        "z": "676ceac4c521834d",
        "name": "Batteries charging?",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "batteries_charging",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 730,
        "y": 260,
        "wires": []
    },
    {
        "id": "be2a48e071dee195",
        "type": "change",
        "z": "676ceac4c521834d",
        "g": "72059e541379a869",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 90,
        "y": 200,
        "wires": [
            [
                "682972c51f2870ed"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "524b61f06ac20ae7",
        "type": "catch",
        "z": "676ceac4c521834d",
        "g": "6e6682265db1e9ee",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 55,
        "y": 300,
        "wires": [
            [
                "b068ce351aa5b926"
            ]
        ],
        "l": false
    },
    {
        "id": "b068ce351aa5b926",
        "type": "function",
        "z": "676ceac4c521834d",
        "g": "6e6682265db1e9ee",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 105,
        "y": 300,
        "wires": [
            [
                "0d26b7f936be7947"
            ]
        ],
        "l": false
    },
    {
        "id": "0d26b7f936be7947",
        "type": "link out",
        "z": "676ceac4c521834d",
        "g": "6e6682265db1e9ee",
        "name": "link out 4",
        "mode": "return",
        "links": [],
        "x": 155,
        "y": 300,
        "wires": []
    },
    {
        "id": "60612cfd6fa3414c",
        "type": "comment",
        "z": "acf90364e6895494",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 140,
        "y": 60,
        "wires": []
    },
    {
        "id": "c3438f8485ce1440",
        "type": "link in",
        "z": "acf90364e6895494",
        "g": "f98d86f9119b97c8",
        "name": "Charge",
        "links": [],
        "x": 110,
        "y": 220,
        "wires": [
            [
                "2f866dd7572e406e"
            ]
        ],
        "l": true
    },
    {
        "id": "9c90ed941bad8215",
        "type": "comment",
        "z": "acf90364e6895494",
        "g": "f98d86f9119b97c8",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 130,
        "y": 140,
        "wires": []
    },
    {
        "id": "2f866dd7572e406e",
        "type": "change",
        "z": "acf90364e6895494",
        "g": "f98d86f9119b97c8",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 180,
        "wires": [
            [
                "7045b1796ad3123d"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "dacc76ec691f29dd",
        "type": "link out",
        "z": "acf90364e6895494",
        "g": "aabefc3958b99589",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 185,
        "y": 580,
        "wires": []
    },
    {
        "id": "8c915c6e011ad9ce",
        "type": "comment",
        "z": "acf90364e6895494",
        "g": "aabefc3958b99589",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 130,
        "y": 520,
        "wires": []
    },
    {
        "id": "f48f75f0f9f41c5a",
        "type": "link in",
        "z": "acf90364e6895494",
        "g": "aabefc3958b99589",
        "name": "link to End",
        "links": [
            "b25ccc2a1d23ab8c",
            "85e67e4a2d60524c",
            "75ed5ed6a655b6b0"
        ],
        "x": 75,
        "y": 580,
        "wires": [
            [
                "dacc76ec691f29dd"
            ]
        ]
    },
    {
        "id": "544f7b5f8a7e2e5f",
        "type": "function",
        "z": "acf90364e6895494",
        "g": "acd85c313a179ad1",
        "name": "Max power solution",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\nlog(this, \"Charge at **max. power**\");\n\n// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// build solution\nmsg.batteries.forEach(battery => {\n    const calculatedPower = Number(battery.charging_max);\n\n    solution_array.push({\n        id: battery.id,\n        mode: \"charge\",\n        power: calculatedPower\n    });\n\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 360,
        "wires": [
            [
                "1b6bc04ad1edaaeb"
            ]
        ]
    },
    {
        "id": "3e05b666827f5ab3",
        "type": "link call",
        "z": "acf90364e6895494",
        "g": "acd85c313a179ad1",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1140,
        "y": 400,
        "wires": [
            [
                "f3a7efeae778fe97",
                "75ed5ed6a655b6b0"
            ]
        ]
    },
    {
        "id": "0fd7fb4aae300503",
        "type": "switch",
        "z": "acf90364e6895494",
        "g": "acd85c313a179ad1",
        "name": "Import at max power",
        "property": "house_battery_strategy_charge_has_max_power",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 760,
        "y": 380,
        "wires": [
            [
                "544f7b5f8a7e2e5f"
            ],
            [
                "7a36d44164b63a66"
            ]
        ]
    },
    {
        "id": "f3a7efeae778fe97",
        "type": "debug",
        "z": "acf90364e6895494",
        "g": "acd85c313a179ad1",
        "name": "Regulated",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1330,
        "y": 400,
        "wires": []
    },
    {
        "id": "f8391ad8bb7299e8",
        "type": "debug",
        "z": "acf90364e6895494",
        "g": "acd85c313a179ad1",
        "name": "Maximum",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1320,
        "y": 360,
        "wires": []
    },
    {
        "id": "7a36d44164b63a66",
        "type": "function",
        "z": "acf90364e6895494",
        "g": "acd85c313a179ad1",
        "name": "Regulated power",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = msg.house_battery_strategy_charge_target_power;\n// tell PID to avoid discharge solutions during charging.\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\",true,true);\n\n// Finally\nlog(this, `**Regulated** charging. Limit grid power: ${Math.floor(msg.house_battery_strategy_charge_target_power)} W`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 400,
        "wires": [
            [
                "3e05b666827f5ab3"
            ]
        ]
    },
    {
        "id": "1b6bc04ad1edaaeb",
        "type": "change",
        "z": "acf90364e6895494",
        "g": "acd85c313a179ad1",
        "name": "Continue",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Charge",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 360,
        "wires": [
            [
                "f8391ad8bb7299e8",
                "75ed5ed6a655b6b0"
            ]
        ]
    },
    {
        "id": "75ed5ed6a655b6b0",
        "type": "link out",
        "z": "acf90364e6895494",
        "g": "acd85c313a179ad1",
        "name": "go to End",
        "mode": "link",
        "links": [
            "f48f75f0f9f41c5a"
        ],
        "x": 1320,
        "y": 460,
        "wires": [],
        "l": true
    },
    {
        "id": "0e22f7f0d91f8e14",
        "type": "api-current-state",
        "z": "acf90364e6895494",
        "g": "acd85c313a179ad1",
        "name": "Use max power?",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_charge_has_max_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_charge_has_max_power",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 380,
        "wires": [
            [
                "79cd66a5d0c5a0a1"
            ]
        ]
    },
    {
        "id": "79cd66a5d0c5a0a1",
        "type": "api-current-state",
        "z": "acf90364e6895494",
        "g": "acd85c313a179ad1",
        "name": "Grid power limit",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_charge_target_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_charge_target_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 560,
        "y": 380,
        "wires": [
            [
                "0fd7fb4aae300503"
            ]
        ]
    },
    {
        "id": "5ee6ad7859def0a5",
        "type": "function",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Unknown -> Full stop",
        "func": "const log = global.get(\"logger\");\n\n// Unkown export goal\nlog(this, `**${msg.charge.goal}**; Charge goal not recognized. Fallback to **Full Stop**`,\"warn\");\n\n// Full stop\nmsg.target = \"Full stop\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 240,
        "wires": [
            [
                "61cb693de420fcc4"
            ]
        ]
    },
    {
        "id": "61cb693de420fcc4",
        "type": "link call",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 990,
        "y": 240,
        "wires": [
            [
                "b25ccc2a1d23ab8c"
            ]
        ]
    },
    {
        "id": "a1853cedd6a4de2a",
        "type": "api-current-state",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Energy reserve hi",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_charge_target_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charge.threshold_energy",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 200,
        "wires": [
            [
                "4627f06802b810e4"
            ]
        ]
    },
    {
        "id": "b25ccc2a1d23ab8c",
        "type": "link out",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "go to End",
        "mode": "link",
        "links": [
            "f48f75f0f9f41c5a"
        ],
        "x": 1190,
        "y": 240,
        "wires": [],
        "l": true
    },
    {
        "id": "b7a4fb09268788ef",
        "type": "api-current-state",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "SoC reached",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_charge_target_soc",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charge.threshold_soc",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 780,
        "y": 160,
        "wires": [
            [
                "5a45c394ce22d5bc"
            ]
        ]
    },
    {
        "id": "4627f06802b810e4",
        "type": "function",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Check if hi",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Charge until: ${msg.charge.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nvar energy_threshold = Number(RED.util.getMessageProperty(msg,\"charge.threshold_energy\"));\nif (energy_threshold === undefined || energy_threshold <= 0){\n    log(this,`Desired energy reserve invalid '${energy_threshold}' kWh. I've set it to ${Number(msg.batteries_max_energy).toFixed(1)} kWh`,\"warn\");\n    energy_threshold = Math.floor(Number(msg.batteries_max_energy)*10)/10;\n}\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining >= energy_threshold) {\n    msg.charge.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh`, 'info');\n} else {\n    msg.charge.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.charge.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.charge.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 200,
        "wires": [
            [
                "1c81dabddcb02085",
                "e50a791becbf6d1d"
            ]
        ]
    },
    {
        "id": "5a45c394ce22d5bc",
        "type": "function",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Check if SoC",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this, `Charge until: ${msg.charge.goal}`);\n\n// 2. Extract average SoC and desired SoC level\nlet batteries = msg.batteries;\nlet soc_avg = 0;\nlet count = 0; // could use msg.battery_count\nbatteries.forEach(battery => {\n    soc_avg += battery.soc;\n    count++;\n});\n// 2.1 Current avg. SoC\nsoc_avg = Math.round(soc_avg / count * 100) / 100;\n// 2.2 Charge until SoC (100% as fallback)\nvar soc_threshold = Number(RED.util.getMessageProperty(msg,\"charge.threshold_soc\"));\nif (soc_threshold === undefined || soc_threshold < 12){\n    log(this, `Desired SoC not set correctly '${soc_threshold}' %. I've set it to 100%.`,\"warn\");\n    soc_threshold = 100;\n}\n\n// 3. Logic: Determine if SoC level is at or above desired level\nif (soc_avg >= soc_threshold) {\n    msg.charge.threshold_reached = true;\n\n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n} else {\n    msg.charge.threshold_reached = false;\n\n    // User friendly feedback via the custom logger\n    log(this, `[OK] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({\n    fill: msg.charge.threshold_reached ? \"red\" : \"green\",\n    shape: \"dot\",\n    text: `Threshold reached: ${msg.charge.threshold_reached}`\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 160,
        "wires": [
            [
                "1c81dabddcb02085"
            ]
        ]
    },
    {
        "id": "34db30ed0ace9850",
        "type": "change",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Batteries are full",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 790,
        "y": 120,
        "wires": [
            [
                "3ba77ad27aab03ae"
            ]
        ]
    },
    {
        "id": "3ba77ad27aab03ae",
        "type": "function",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Check if full",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Charge until: ${msg.charge.goal}`);\n\n// 2. Extract energy level from msg (and handle missing properties)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nconst energy_max = Number(RED.util.getMessageProperty(msg, \"batteries_max_energy\")) || 0;\nif(energy_max == 0) log(this,`Batteries max energy missing! ${msg.batteries_max_energy}`);\n// 2.1 Check if every battery's SoC is at or over the max\nconst isAtMax = msg.batteries.every(battery => battery.soc >= battery.soc_max);\n\n// 3. Logic: Determine if energy level is over or near 99.9% of max eneregy\nif (isAtMax) {\n    msg.charge.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] All batteries are full or at SoC_max_ (${energy_remaining} kWh).`, 'info');\n} else {\n    msg.charge.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Battery level ${energy_remaining.toFixed(2)} kWh below ${energy_max.toFixed(2)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.charge.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.charge.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 120,
        "wires": [
            [
                "1c81dabddcb02085"
            ]
        ]
    },
    {
        "id": "61cc6de76d25a391",
        "type": "switch",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Until reached",
        "property": "charge.threshold_reached",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1340,
        "y": 160,
        "wires": [
            [
                "43c0d94c059d5555"
            ],
            [
                "49ac1529018b02b8"
            ]
        ]
    },
    {
        "id": "43c0d94c059d5555",
        "type": "function",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Yes -> Charge PV",
        "func": "// If any solar surplus remains, soak it up instead of waiting in Full stop.\nmsg.target = \"Charge PV\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1580,
        "y": 120,
        "wires": [
            [
                "6c389d45d1ea769b"
            ]
        ]
    },
    {
        "id": "6c389d45d1ea769b",
        "type": "link call",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 1760,
        "y": 120,
        "wires": [
            [
                "85e67e4a2d60524c"
            ]
        ]
    },
    {
        "id": "85e67e4a2d60524c",
        "type": "link out",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "go to End",
        "mode": "link",
        "links": [
            "f48f75f0f9f41c5a"
        ],
        "x": 1900,
        "y": 120,
        "wires": [],
        "l": true
    },
    {
        "id": "1c81dabddcb02085",
        "type": "function",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Decided",
        "func": "const log = global.get(\"logger\");\n\nif(msg.charge.threshold_reached){\n    log(this,`Stop charging, Charge until ${msg.charge.goal} reached.`);\n} else {\n    log(this,`Continue charging.`);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1190,
        "y": 160,
        "wires": [
            [
                "61cc6de76d25a391"
            ]
        ]
    },
    {
        "id": "7cb5b047aa774535",
        "type": "switch",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Charge until",
        "property": "charge.goal",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "batteries are full",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "state of charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "energy reserve",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 4,
        "x": 590,
        "y": 180,
        "wires": [
            [
                "34db30ed0ace9850"
            ],
            [
                "b7a4fb09268788ef"
            ],
            [
                "a1853cedd6a4de2a"
            ],
            [
                "5ee6ad7859def0a5"
            ]
        ]
    },
    {
        "id": "bae1fdb045d8953f",
        "type": "api-current-state",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Goal",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_charge_goal",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charge.goal",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 180,
        "wires": [
            [
                "7cb5b047aa774535"
            ]
        ]
    },
    {
        "id": "7045b1796ad3123d",
        "type": "function",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "Init",
        "func": "msg.charge = {};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "bae1fdb045d8953f",
                "405d5a3227088f7d"
            ]
        ]
    },
    {
        "id": "dcaadb585f1b53a6",
        "type": "function",
        "z": "acf90364e6895494",
        "g": "9d043a8d975d248d",
        "name": "Min/max",
        "func": "\n// Lower bound\nlet output = msg.charge.threshold_energy || 0; // kWh\noutput = Math.max(output, 0);\n\n// Upper bound\noutput = Math.min(output, msg.batteries_max_energy);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1800,
        "y": 200,
        "wires": [
            [
                "947b46137c18f49b"
            ]
        ]
    },
    {
        "id": "947b46137c18f49b",
        "type": "api-call-service",
        "z": "acf90364e6895494",
        "g": "9d043a8d975d248d",
        "name": "Set desired energy reserve",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_charge_target_energy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.payload}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2010,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "e50a791becbf6d1d",
        "type": "rbe",
        "z": "acf90364e6895494",
        "g": "9d043a8d975d248d",
        "name": "Desired energy changed",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 1600,
        "y": 200,
        "wires": [
            [
                "dcaadb585f1b53a6"
            ]
        ]
    },
    {
        "id": "405d5a3227088f7d",
        "type": "debug",
        "z": "acf90364e6895494",
        "g": "cf76f88e2d0b6b5d",
        "name": "debug 2",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 410,
        "y": 120,
        "wires": []
    },
    {
        "id": "e5710e5722a62ecb",
        "type": "catch",
        "z": "acf90364e6895494",
        "g": "c0793a4f4fa04e17",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 75,
        "y": 420,
        "wires": [
            [
                "ae704ead76c1420b"
            ]
        ],
        "l": false
    },
    {
        "id": "ae704ead76c1420b",
        "type": "function",
        "z": "acf90364e6895494",
        "g": "c0793a4f4fa04e17",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 125,
        "y": 420,
        "wires": [
            [
                "53589d34db53d176"
            ]
        ],
        "l": false
    },
    {
        "id": "53589d34db53d176",
        "type": "link out",
        "z": "acf90364e6895494",
        "g": "c0793a4f4fa04e17",
        "name": "link out 3",
        "mode": "return",
        "links": [],
        "x": 175,
        "y": 420,
        "wires": []
    },
    {
        "id": "9e4f52bdefdaaaa0",
        "type": "link in",
        "z": "14975b6f5363e1a8",
        "g": "5db10a20e0dd06b3",
        "name": "Dynamic",
        "links": [],
        "x": 100,
        "y": 160,
        "wires": [
            [
                "7b2e7b9ebad81a31"
            ]
        ],
        "l": true
    },
    {
        "id": "af7341b4d591cbdc",
        "type": "comment",
        "z": "14975b6f5363e1a8",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "90587e0927e8aeb0",
        "type": "comment",
        "z": "14975b6f5363e1a8",
        "g": "5db10a20e0dd06b3",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "7f8a072b3ee09975",
        "type": "link out",
        "z": "14975b6f5363e1a8",
        "g": "46497598dbd9e9ee",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 975,
        "y": 180,
        "wires": []
    },
    {
        "id": "733fb56e80bff2dc",
        "type": "comment",
        "z": "14975b6f5363e1a8",
        "g": "46497598dbd9e9ee",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 1030,
        "y": 120,
        "wires": []
    },
    {
        "id": "6db52f5df28e071d",
        "type": "api-render-template",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Cheapest",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{}",
        "resultsLocation": "dynamic.data_cheapest",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 460,
        "y": 560,
        "wires": [
            [
                "4f4f1b6e67a30afe"
            ]
        ]
    },
    {
        "id": "1e9ca1074e1edceb",
        "type": "api-render-template",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Expensive",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "",
        "resultsLocation": "dynamic.data_expensive",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 470,
        "y": 620,
        "wires": [
            [
                "3457fc35c3b7087f"
            ]
        ]
    },
    {
        "id": "c3e1145a39680abf",
        "type": "debug",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Complete message",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 900,
        "wires": []
    },
    {
        "id": "4f4f1b6e67a30afe",
        "type": "json",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "",
        "property": "dynamic.data_cheapest",
        "action": "obj",
        "pretty": false,
        "x": 555,
        "y": 560,
        "wires": [
            [
                "14dfd4a18fdc3126"
            ]
        ],
        "l": false
    },
    {
        "id": "3457fc35c3b7087f",
        "type": "json",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "",
        "property": "dynamic.data_expensive",
        "action": "obj",
        "pretty": false,
        "x": 575,
        "y": 620,
        "wires": [
            [
                "fe9d10b494abc5a7"
            ]
        ],
        "l": false
    },
    {
        "id": "8872e96a558ef448",
        "type": "function",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Determine dynamic strategy",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Extract start date objects\nlet start_cheapest = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.start\"));\nlet start_expensive = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_expensive.start\"));\nlet isCheapestNext = true;\nlet lastCheapestPrice = context.last_cheapest_price || 0;\nlet deltaThreshold = parseFloat(RED.util.getMessageProperty(msg,\"dynamic.min_delta_cents\")/100) || 0; // 100 cents = 1 Cr\n\n// Enums\nconst STRATEGY = {\n    CHEAPEST: \"Charge\", \n    NEUTRAL: \"Charge PV\",\n    EXPENSIVE: \"Self-consumption\"\n}\n\n// Conversion\nconst CONVERSION_RATE = parseFloat(RED.util.getMessageProperty(msg,\"dynamic.value_conversion\")) || 1;\n\n// Check if the Date objects are valid. If 'Invalid Date', stop and warn the user.\nif (isNaN(start_cheapest.getTime()) || isNaN(start_expensive.getTime())) {\n    node.warn(`One or both dates are invalid. Cheap = ${start_cheapest}, Expensive = ${start_expensive}`);\n    log(this, `One or both dates are invalid. Cheap = ${start_cheapest}, Expensive = ${start_expensive}`,\"warn\");\n}\n\n// Check if cheapest lies before expensive\nif (start_cheapest < start_expensive) {\n    log(this, `Cheapest moment lies before expensive moment. Cheapest moment: ${start_cheapest}, Expensive = ${start_expensive}`);\n    // store the cheapest price to compare it with future expensive rates, to determine if it's economical to discharge.\n    context.last_cheapest_price = RED.util.getMessageProperty(msg, \"dynamic.data_cheapest.average\"); // /kWh rate\n    lastCheapestPrice = context.last_cheapest_price;\n    log(this, `Cheapest price set to ${lastCheapestPrice}`);\n}\n\nif (lastCheapestPrice == 0) {\n    log(this, `I can't recall the tariff used for charging. Cheapest price set to ${lastCheapestPrice}`);\n}\n\n// // Format the Date object to HH:MM based on locale options.\n// // We use 'nl-NL' locale, but any will work if it uses : as separator\n// const startCheapHHMM = start_cheapest.toLocaleTimeString('nl-NL', {\n//     hour: '2-digit',        // Ensure the hour is two digits (e.g., 03)\n//     minute: '2-digit',      // Ensure the minute is two digits (e.g., 00)\n//     hour12: false           // Force 24-hour format (00-23)\n// });                         // Result: \"03:00\"\n// msg.cheapest.startHHMM = startCheapHHMM;\n\n\n// const endHHMM = end.toLocaleTimeString('nl-NL', {\n//     hour: '2-digit',        // Ensure the hour is two digits (e.g., 03)\n//     minute: '2-digit',      // Ensure the minute is two digits (e.g., 00)\n//     hour12: false           // Force 24-hour format (00-23)\n// });   \n\n// is_now\n/** @type {boolean} */\nconst cheapestIsNow = RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.is_now\");\n/** @type {boolean} */\nconst expensiveIsNow = RED.util.getMessageProperty(msg, \"dynamic.data_expensive.is_now\");\n\n// Determine if it is economical to start charging\nmsg.dynamic.strategy = STRATEGY.NEUTRAL;\n// average price expensive\nconst lastExpensivePrice = RED.util.getMessageProperty(msg, \"dynamic.data_expensive.average\"); // /kWh rate\n// delta >  0,06 = charging is economical\nconst delta = (lastExpensivePrice - lastCheapestPrice) / CONVERSION_RATE; // \n\n// UI values\nmsg.dynamic.avg_cheapest_tariff = parseFloat((lastCheapestPrice / CONVERSION_RATE).toFixed(2));\nmsg.dynamic.avg_expensive_tariff = parseFloat((lastExpensivePrice / CONVERSION_RATE).toFixed(2));\nmsg.dynamic.avg_delta = parseFloat(delta.toFixed(2));\n\n// Set strategy\nif (cheapestIsNow) msg.dynamic.strategy = STRATEGY.CHEAPEST;\nif (expensiveIsNow && delta >= deltaThreshold) {\n    msg.dynamic.strategy = STRATEGY.EXPENSIVE;\n} else if(expensiveIsNow) {\n    // log\n    log(this, `Expensive period is now. However not using batteries. The tariff difference between cheap and expensive periods is too small: ${(lastExpensivePrice / CONVERSION_RATE).toFixed(4)}-${(lastCheapestPrice / CONVERSION_RATE).toFixed(4) }=${delta.toFixed(4)} < ${deltaThreshold}.`);    \n}\n\n// Store the strategy in flow-context. The 'Execution' area will read from the flow-context.\nflow.set(\"dynamic_strategy\",msg.dynamic.strategy);\n\n// Node status\nnode.status({ fill: \"blue\", shape: \"dot\", text: `${msg.dynamic.strategy}; ${cheapestIsNow} + ${expensiveIsNow} @ ${delta.toFixed(4)}` });\n\n// Log\nlog(this, `Dynamic strat set to ${msg.dynamic.strategy}. \nCheapest period now? ${cheapestIsNow}. \nExpensive period now? ${expensiveIsNow}.`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 740,
        "wires": [
            [
                "c3e1145a39680abf",
                "8a11850114531fc8",
                "66b57d6637cfadb4",
                "a35cf4e779e09fbb",
                "9b03180e47c0ddf0",
                "c78b4e15dfb514dd",
                "0c735b92e205c0c0",
                "b5e11bf0fddced8d",
                "a10bb26ddb8a5ea8"
            ]
        ]
    },
    {
        "id": "848d7f239ac703db",
        "type": "change",
        "z": "14975b6f5363e1a8",
        "g": "bf724a3d55e9fc66",
        "name": "Set strategy",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "dynamic_strategy",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 200,
        "wires": [
            [
                "45d16441c1a4d7b3"
            ]
        ]
    },
    {
        "id": "3ccd08ef5be34846",
        "type": "link call",
        "z": "14975b6f5363e1a8",
        "g": "bf724a3d55e9fc66",
        "name": "Sub-strategy",
        "links": [],
        "linkType": "dynamic",
        "timeout": "3",
        "x": 810,
        "y": 180,
        "wires": [
            [
                "7f8a072b3ee09975"
            ]
        ]
    },
    {
        "id": "8a11850114531fc8",
        "type": "api-call-service",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Cheapest Start",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_cheapest_start"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.start).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 820,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "66b57d6637cfadb4",
        "type": "api-call-service",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Cheapest End",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_cheapest_end"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.end).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 820,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "a35cf4e779e09fbb",
        "type": "api-call-service",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Expensive Start",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_expensive_start"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_expensive.start).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 820,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "9b03180e47c0ddf0",
        "type": "api-call-service",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Expensive End",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_expensive_end"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_expensive.end).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 820,
        "y": 740,
        "wires": [
            []
        ]
    },
    {
        "id": "5fa32b6aff16ca75",
        "type": "inject",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Every 30 min (cron)",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "*/30 0-23 * * *",
        "once": false,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 380,
        "y": 400,
        "wires": [
            [
                "9ff38a5ef6e582a4"
            ]
        ]
    },
    {
        "id": "db8c13461b3b9091",
        "type": "switch",
        "z": "14975b6f5363e1a8",
        "g": "bf724a3d55e9fc66",
        "name": "Has strategy",
        "property": "dynamic_strategy",
        "propertyType": "flow",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 330,
        "y": 180,
        "wires": [
            [
                "87d34cbd4954621c"
            ],
            [
                "848d7f239ac703db"
            ]
        ]
    },
    {
        "id": "87d34cbd4954621c",
        "type": "change",
        "z": "14975b6f5363e1a8",
        "g": "bf724a3d55e9fc66",
        "name": "Set Full stop",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Full stop",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 160,
        "wires": [
            [
                "45d16441c1a4d7b3"
            ]
        ]
    },
    {
        "id": "be57bb0565d23939",
        "type": "inject",
        "z": "14975b6f5363e1a8",
        "g": "20909aa0de389bf6",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 1060,
        "wires": [
            [
                "ac6a032a5d15bf77"
            ]
        ]
    },
    {
        "id": "ac6a032a5d15bf77",
        "type": "api-render-template",
        "z": "14975b6f5363e1a8",
        "g": "20909aa0de389bf6",
        "name": "Cheapest",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "cheapest",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 500,
        "y": 1060,
        "wires": [
            [
                "e9cc30749a5121b4"
            ]
        ]
    },
    {
        "id": "e9cc30749a5121b4",
        "type": "json",
        "z": "14975b6f5363e1a8",
        "g": "20909aa0de389bf6",
        "name": "",
        "property": "cheapest",
        "action": "obj",
        "pretty": false,
        "x": 595,
        "y": 1060,
        "wires": [
            [
                "f693251258633cd6"
            ]
        ],
        "l": false
    },
    {
        "id": "f693251258633cd6",
        "type": "api-render-template",
        "z": "14975b6f5363e1a8",
        "g": "20909aa0de389bf6",
        "name": "Expensive",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    lowest=false,\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "expensive",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 750,
        "y": 1060,
        "wires": [
            [
                "89ee16ccac7cd2ad"
            ]
        ]
    },
    {
        "id": "89ee16ccac7cd2ad",
        "type": "json",
        "z": "14975b6f5363e1a8",
        "g": "20909aa0de389bf6",
        "name": "",
        "property": "expensive",
        "action": "obj",
        "pretty": false,
        "x": 855,
        "y": 1060,
        "wires": [
            [
                "2b9ff7fb6e9d6bf5",
                "89019ec9b4041e43",
                "37fcd96bb0ef062c"
            ]
        ],
        "l": false
    },
    {
        "id": "2b9ff7fb6e9d6bf5",
        "type": "debug",
        "z": "14975b6f5363e1a8",
        "g": "20909aa0de389bf6",
        "name": "Cheap",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "cheapest.start",
        "targetType": "msg",
        "statusVal": "cheapest.start",
        "statusType": "auto",
        "x": 990,
        "y": 1100,
        "wires": []
    },
    {
        "id": "89019ec9b4041e43",
        "type": "debug",
        "z": "14975b6f5363e1a8",
        "g": "20909aa0de389bf6",
        "name": "Expensive",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "expensive.start",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1010,
        "y": 1140,
        "wires": []
    },
    {
        "id": "719ff618f7ca2376",
        "type": "api-render-template",
        "z": "14975b6f5363e1a8",
        "g": "9969e1f72d0b7236",
        "name": "All Zonneplan",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    include_tomorrow=true,\n    hours=\"all\",\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "all_data",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 480,
        "y": 1700,
        "wires": [
            [
                "b2bc04a3efb38c09"
            ]
        ]
    },
    {
        "id": "e9bb86a4e54c5052",
        "type": "inject",
        "z": "14975b6f5363e1a8",
        "g": "9969e1f72d0b7236",
        "name": "Fetch",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 1700,
        "wires": [
            [
                "719ff618f7ca2376"
            ]
        ]
    },
    {
        "id": "b2bc04a3efb38c09",
        "type": "json",
        "z": "14975b6f5363e1a8",
        "g": "9969e1f72d0b7236",
        "name": "",
        "property": "all_data",
        "action": "obj",
        "pretty": false,
        "x": 595,
        "y": 1700,
        "wires": [
            [
                "d70764aae439f14b"
            ]
        ],
        "l": false
    },
    {
        "id": "9ff38a5ef6e582a4",
        "type": "delay",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 560,
        "y": 400,
        "wires": [
            [
                "cb7c0de40d2ba570"
            ]
        ]
    },
    {
        "id": "5ca77832c97c6f3c",
        "type": "api-current-state",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Source",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_data_source",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.data_source",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 360,
        "wires": [
            [
                "beb4ff24b4b8562d"
            ]
        ]
    },
    {
        "id": "34b0068e095ea86f",
        "type": "function",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Data source settings",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n/*    From cheapes-energy-hours macro\n      See: https://github.com/TheFes/cheapest-energy-hours/blob/main/documentation/1-source_data.md#data-provider-settings\n\n      - None (default selection)\n      - Zonneplan\n      - Amber Electric\n      - EasyEnergy, EnergyZero (core)\n      - ENTSO-E\n      - Frank Energie\n      - GE-Spot\n      - Tibber, Nordpool (core)\n      - Tibber (custom)\n      - Nordpool (custom)\n      - PVPC (Spain)\n      - Octopus Energy\n      - Omie\n*/\n\nswitch (msg.dynamic.data_source) {\n      case \"None\":\n            // Handle the 'None' case (e.g., no supplier selected or data is unavailable)\n            log(this,\"No data source selected.\");\n            // Add config here...\n            break;\n\n      case \"Zonneplan\":\n            // Code for Zonneplan (a Dutch energy supplier)\n            log(this,\"Processing Zonneplan data.\");\n            // Add config here...\n            msg.dynamic.sensor='sensor.zonneplan_current_electricity_tariff'; // when using: https://github.com/fsaris/home-assistant-zonneplan-one\n            msg.dynamic.attr_all='forecast';\n            msg.dynamic.value_key='electricity_price';\n            msg.dynamic.value_conversion = 10000000; // whole currency / kWh\n            break;\n\n      case \"Amber Electric\":\n            // Code for Amber Electric (Australian energy retailer)\n            log(this,\"Processing Amber Electric data.\");\n            // Add config here...\n            msg.dynamic.attr_all='forecasts'; \n            msg.dynamic.time_key='start_time'; \n            msg.dynamic.value_key='per_kwh';\n            break;\n\n      case \"EasyEnergy, EnergyZero (core)\":\n            // Code for EasyEnergy and EnergyZero (core/default implementation)\n            log(this,\"Processing EasyEnergy/EnergyZero core data.\");\n            // Add config here...\n            break;\n\n      case \"ENTSO-E\":\n            // Code for ENTSO-E (European Network of Transmission System Operators for Electricity)\n            log(this,\"Processing ENTSO-E data.\");\n            // Add config here...\n            msg.dynamic.attr_today='prices_today'; \n            msg.dynamic.attr_tomorrow='prices_tomorrow'; \n            msg.dynamic.time_key='time';\n            msg.dynamic.value_key='price';\n            break;\n\n      case \"Frank Energie\":\n            // Code for Frank Energie (Dutch energy supplier)\n            log(this,\"Processing Frank Energie data.\");\n            // Add config here...\n            msg.dynamic.attr_all = 'prices'; \n            msg.dynamic.time_key = 'from'; \n            msg.dynamic.value_key = 'price';\n            break;\n\n      case \"GE-Spot\":\n            // Code for GE-Spot (Global Electric Spot price)\n            log(this,\"Processing GE-Spot data.\");\n            // Add config here...\n            msg.dynamic.attr_today = 'today_hourly_prices'; // using the hourly version. today_interval_prices is per 15 mins\n            msg.dynamic.attr_tomorrow = 'tomorrow_hourly_prices'; // using the hourly version\n            msg.dynamic.time_key = 'time'; \n            msg.dynamic.value_key = 'value';\n            break;\n\n      case \"Tibber, Nordpool (core)\":\n            // Code for Tibber and Nordpool (core/default implementation)\n            log(this,\"Processing Tibber/Nordpool core data.\");\n            // Add config here...\n            msg.dynamic.sensor = 'sensor.tibber_ceh_prices';\n            msg.dynamic.attr_today = 'today';\n            msg.dynamic.attr_tomorrow = 'tomorrow';\n            msg.dynamic.time_key = 'start';\n            msg.dynamic.value_key = 'value';\n            msg.dynamic.datetime_in_data = true; // datetime is in the data\n            break;\n\n      case \"Tibber (custom)\":\n            // Code for a custom Tibber setup/configuration\n            log(this,\"Processing Tibber custom data.\");\n            // Add config here...\n            msg.dynamic.attr_today = 'today';\n            msg.dynamic.attr_tomorrow = 'tomorrow';\n            msg.dynamic.datetime_in_data = false;\n            break;\n\n      case \"Nordpool (custom)\":\n            // Code for a custom Nordpool setup/configuration\n            log(this,\"Processing Nordpool custom data.\");\n            // Add config here...\n            break;\n\n      case \"PVPC (Spain)\":\n            // Code for PVPC (Voluntary Price for Small Consumers in Spain)\n            log(this,\"Processing Spanish PVPC data.\");\n            // Add config here...\n            break;\n\n      case \"Octopus Energy\":\n            // Code for Octopus Energy (UK/international energy supplier)\n            log(this,\"Processing Octopus Energy data.\");\n            // Add config here...\n            msg.dynamic.attr_all = 'rates'; \n            msg.dynamic.value_key = 'value_incl_vat';\n            break;\n\n      case \"Omie\":\n            // Code for Omie (Iberian Energy Market Operator)\n            log(this,\"Processing Omie data.\");\n            // Add config here...\n            break;\n\n      default:\n            // Code to execute if the supplier does not match any of the above cases\n            node.warn(`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            log(this,`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            // Add default error handling...\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 480,
        "wires": [
            [
                "63caf6ef501274d4"
            ]
        ]
    },
    {
        "id": "beb4ff24b4b8562d",
        "type": "api-current-state",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Cheapest N hrs",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_cheapest_hrs",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.cheapest_hrs",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 960,
        "y": 360,
        "wires": [
            [
                "9c39d968ab65452f"
            ]
        ]
    },
    {
        "id": "9c39d968ab65452f",
        "type": "api-current-state",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Expensive N hrs",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_expensive_hrs",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.expensive_hrs",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1140,
        "y": 360,
        "wires": [
            [
                "1ef00a59cbcb4772"
            ]
        ]
    },
    {
        "id": "7fff7bb0c69da24a",
        "type": "inject",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "On start",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 340,
        "y": 360,
        "wires": [
            [
                "cb7c0de40d2ba570"
            ]
        ]
    },
    {
        "id": "cb7c0de40d2ba570",
        "type": "function",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Init",
        "func": "msg.dynamic = {};\nmsg.log = [];\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 360,
        "wires": [
            [
                "5ca77832c97c6f3c"
            ]
        ]
    },
    {
        "id": "63caf6ef501274d4",
        "type": "function",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Generate templates",
        "func": "// final template initialization\nmsg.dynamic.template_cheapest = \"\";\nmsg.dynamic.template_expensive = \"\";\n\n// temporary template parts\nlet template_start = \"\";\nlet template_common = [];\nlet template_cheapest = [];\nlet template_expensive = [];\nlet template_end = \"\";\n\n// 1. IMPROVEMENT: Use radix 10 and Logical OR (||) for cleaner default handling\nconst cheapest_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.cheapest_hrs\"), 10) || 1;\nconst expensive_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.expensive_hrs\"), 10) || 1;\n\n// load the macro\ntemplate_start = `{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n`;\ntemplate_end = `) | to_json }}`;\n\n// collect arguments | strings\nconst stringKeys = [\n    'sensor',\n    'attr_all',\n    'value_key',\n    'attr_today',\n    'attr_tomorrow',\n    'time_key'\n];\n\nstringKeys.forEach(key => {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}='${msg.dynamic[key]}'`);\n    }\n});\n\n// collect arguments | boolean, integer\nconst otherKeys = [\n    'datetime_in_data',\n    'data_minutes',\n];\n\notherKeys.forEach(key => {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}=${msg.dynamic[key]}`);\n    }\n});\n\n// copy common items\ntemplate_cheapest = [...template_common];\ntemplate_expensive = [...template_common];\n\n// collect arguments | cheapest specific\ntemplate_cheapest.push(`hours=${cheapest_hrs}`);\n// template_cheapest.push(`include_tomorrow=true`);\ntemplate_cheapest.push(`mode=\"all\"`);\n\n// collect arguments | expensive specific\ntemplate_expensive.push(`hours=${expensive_hrs}`);\n// template_expensive.push(`include_tomorrow=true`);\ntemplate_expensive.push(`lowest=false`);\ntemplate_expensive.push(`mode=\"all\"`);\n\n/**\n * Formats an array of strings into a single string:\n * - Each item starts with 4 spaces.\n * - Each item ends with a comma, except the last one.\n * - Items are separated by a newline.\n */\nfunction formatTemplateArray(array) {\n    if (!array || array.length === 0) {\n        return \"\";\n    }\n\n    const indent = \"    \"; \n\n    const formatted_lines = array.map((element, index) => {\n        const suffix = (index < array.length - 1) ? \",\" : \"\";\n        return `${indent}${element}${suffix}`;\n    });\n\n    return formatted_lines.join('\\n');\n}\n\n// generate string templates\nconst template_cheapest_string = formatTemplateArray(template_cheapest);\nconst template_expensive_string = formatTemplateArray(template_expensive);\n\n// done\nmsg.dynamic.template_cheapest = `${template_start}${template_cheapest_string}${template_end}`;\nmsg.dynamic.template_expensive = `${template_start}${template_expensive_string}${template_end}`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 480,
        "wires": [
            [
                "d14eecae2f628cc0",
                "8baf7a8bca626f1a",
                "79fe8f7cb43086b5"
            ]
        ]
    },
    {
        "id": "d14eecae2f628cc0",
        "type": "debug",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Template cheapest",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_cheapest",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 480,
        "wires": []
    },
    {
        "id": "8baf7a8bca626f1a",
        "type": "debug",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Template expensive",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_expensive",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 840,
        "y": 520,
        "wires": []
    },
    {
        "id": "79fe8f7cb43086b5",
        "type": "change",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_cheapest",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 560,
        "wires": [
            [
                "6db52f5df28e071d"
            ]
        ]
    },
    {
        "id": "14dfd4a18fdc3126",
        "type": "change",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_expensive",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 620,
        "wires": [
            [
                "1e9ca1074e1edceb"
            ]
        ]
    },
    {
        "id": "fe9d10b494abc5a7",
        "type": "change",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Cleanup",
        "rules": [
            {
                "t": "delete",
                "p": "template",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 340,
        "y": 680,
        "wires": [
            [
                "8872e96a558ef448"
            ]
        ]
    },
    {
        "id": "c78b4e15dfb514dd",
        "type": "debug",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Log: activate 'debug mode' first",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "log",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 870,
        "y": 940,
        "wires": []
    },
    {
        "id": "c15319afc50e922c",
        "type": "server-state-changed",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "User input",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.house_battery_strategy_dynamic_cheapest_hrs",
                "input_number.house_battery_strategy_dynamic_expensive_hrs",
                "input_select.house_battery_strategy_dynamic_data_source",
                "input_number.house_battery_strategy_dynamic_threshold_delta"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 340,
        "y": 320,
        "wires": [
            [
                "85f6dd8a93235509"
            ]
        ]
    },
    {
        "id": "99119cc93c6cdcc4",
        "type": "switch",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Source selected?",
        "property": "dynamic.data_source",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "None",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1395,
        "y": 360,
        "wires": [
            [
                "f4b1dd2d52e46081"
            ],
            [
                "34b0068e095ea86f"
            ]
        ],
        "l": false
    },
    {
        "id": "a884af48600be5c2",
        "type": "debug",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Not set",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1620,
        "y": 340,
        "wires": []
    },
    {
        "id": "0c735b92e205c0c0",
        "type": "api-call-service",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Avg cheap tariff",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_cheapest_avg_tariff"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_cheapest_tariff }",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 820,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "b5e11bf0fddced8d",
        "type": "api-call-service",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Avg expensive tariff",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_expensive_avg_tariff"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_expensive_tariff}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 830,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "a10bb26ddb8a5ea8",
        "type": "api-call-service",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Avg delta",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_expensive_avg_delta"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_delta}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 800,
        "y": 860,
        "wires": [
            []
        ]
    },
    {
        "id": "1ef00a59cbcb4772",
        "type": "api-current-state",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "Threshold",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_threshold_delta",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.min_delta_cents",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1300,
        "y": 360,
        "wires": [
            [
                "99119cc93c6cdcc4"
            ]
        ]
    },
    {
        "id": "f4b1dd2d52e46081",
        "type": "change",
        "z": "14975b6f5363e1a8",
        "g": "c4abcdadddca94b8",
        "name": "null",
        "rules": [
            {
                "t": "set",
                "p": "dynamic_strategy",
                "pt": "flow",
                "to": "null",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1490,
        "y": 340,
        "wires": [
            [
                "a884af48600be5c2"
            ]
        ]
    },
    {
        "id": "d70764aae439f14b",
        "type": "debug",
        "z": "14975b6f5363e1a8",
        "g": "9969e1f72d0b7236",
        "name": "All data",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "all_data",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 1700,
        "wires": []
    },
    {
        "id": "37fcd96bb0ef062c",
        "type": "debug",
        "z": "14975b6f5363e1a8",
        "g": "20909aa0de389bf6",
        "name": "Complete msg",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 1060,
        "wires": []
    },
    {
        "id": "7b2e7b9ebad81a31",
        "type": "change",
        "z": "14975b6f5363e1a8",
        "g": "5db10a20e0dd06b3",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 90,
        "y": 200,
        "wires": [
            [
                "db8c13461b3b9091"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "45d16441c1a4d7b3",
        "type": "function",
        "z": "14975b6f5363e1a8",
        "g": "bf724a3d55e9fc66",
        "name": "Selected",
        "func": "// Logger\nconst log = global.get(\"logger\");\nlog(this,`${msg.target} strategy`);\n\n// Status\nnode.status({fill:\"green\",shape:\"dot\",text:`${msg.target}`});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 180,
        "wires": [
            [
                "3ccd08ef5be34846"
            ]
        ]
    },
    {
        "id": "a2d3614dfb17fe47",
        "type": "catch",
        "z": "14975b6f5363e1a8",
        "g": "36273e2ec1912b5b",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 65,
        "y": 320,
        "wires": [
            [
                "b5866f9aa2b37c76"
            ]
        ],
        "l": false
    },
    {
        "id": "b5866f9aa2b37c76",
        "type": "function",
        "z": "14975b6f5363e1a8",
        "g": "36273e2ec1912b5b",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 115,
        "y": 320,
        "wires": [
            [
                "5486ae2d26979420"
            ]
        ],
        "l": false
    },
    {
        "id": "5486ae2d26979420",
        "type": "link out",
        "z": "14975b6f5363e1a8",
        "g": "36273e2ec1912b5b",
        "name": "link out 5",
        "mode": "return",
        "links": [],
        "x": 165,
        "y": 320,
        "wires": []
    },
    {
        "id": "fedca8b9c6861865",
        "type": "link in",
        "z": "5ca05ae5a089b8d2",
        "g": "c3404a37fd9ce4af",
        "name": "Full stop",
        "links": [],
        "x": 100,
        "y": 160,
        "wires": [
            [
                "86fc6690200ea1d5"
            ]
        ],
        "l": true
    },
    {
        "id": "5ac782a79cce3909",
        "type": "link out",
        "z": "5ca05ae5a089b8d2",
        "g": "807415e9b7aacdfa",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 505,
        "y": 180,
        "wires": []
    },
    {
        "id": "488bf4f7bb7829f7",
        "type": "function",
        "z": "5ca05ae5a089b8d2",
        "name": "Stop all batteries",
        "func": "// Logger\nconst log = global.get(\"logger\");\nlog(this,`full stop`);\n\n// Process\nlet solution_array = [];\n\n// Add a solution per battery\nmsg.batteries.forEach(battery => {\n    solution_array.push({ id: battery.id, \n    mode: \"stop\", // disengages Marstek Battery\n    power: 0 }); // set power to 0W\n});\n\n// OUTPUT\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "5ac782a79cce3909"
            ]
        ]
    },
    {
        "id": "b374e478ef33e8a4",
        "type": "comment",
        "z": "5ca05ae5a089b8d2",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "1dca26be7c0dd61b",
        "type": "comment",
        "z": "5ca05ae5a089b8d2",
        "g": "807415e9b7aacdfa",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 560,
        "y": 120,
        "wires": []
    },
    {
        "id": "4febdc440faf9d73",
        "type": "comment",
        "z": "5ca05ae5a089b8d2",
        "g": "c3404a37fd9ce4af",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "86fc6690200ea1d5",
        "type": "change",
        "z": "5ca05ae5a089b8d2",
        "g": "c3404a37fd9ce4af",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 200,
        "wires": [
            [
                "488bf4f7bb7829f7"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "527dbdfa3c0b7d81",
        "type": "catch",
        "z": "5ca05ae5a089b8d2",
        "g": "baecf4a2995e8afe",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 55,
        "y": 300,
        "wires": [
            [
                "dbd5b285d0e8b8d2"
            ]
        ],
        "l": false
    },
    {
        "id": "dbd5b285d0e8b8d2",
        "type": "function",
        "z": "5ca05ae5a089b8d2",
        "g": "baecf4a2995e8afe",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 105,
        "y": 300,
        "wires": [
            [
                "23b4b597108b5ea8"
            ]
        ],
        "l": false
    },
    {
        "id": "23b4b597108b5ea8",
        "type": "link out",
        "z": "5ca05ae5a089b8d2",
        "g": "baecf4a2995e8afe",
        "name": "link out 6",
        "mode": "return",
        "links": [],
        "x": 155,
        "y": 300,
        "wires": []
    },
    {
        "id": "1be4da0d75e45a96",
        "type": "link in",
        "z": "ab649936ec5003a8",
        "g": "5271f96dc7c112a4",
        "name": "Self-consumption",
        "links": [],
        "x": 160,
        "y": 160,
        "wires": [
            [
                "d4343a51125ccdab"
            ]
        ],
        "l": true
    },
    {
        "id": "8e3725ba65b07a2a",
        "type": "comment",
        "z": "ab649936ec5003a8",
        "g": "5271f96dc7c112a4",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the Link In in this start group exactly after the option configured in your\nselect_input.house_battery_strategy\n\nfound in the file:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nWill point to the flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 150,
        "y": 120,
        "wires": []
    },
    {
        "id": "2a4cd474719a2212",
        "type": "comment",
        "z": "ab649936ec5003a8",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "714da9cf65f2306e",
        "type": "server-state-changed",
        "z": "ab649936ec5003a8",
        "g": "9b4a06585508d834",
        "name": "User Ki change",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.house_battery_control_ki"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 100,
        "wires": [
            [
                "8128162c69a1d5d2"
            ]
        ]
    },
    {
        "id": "8128162c69a1d5d2",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "9b4a06585508d834",
        "name": "Integral term adjust",
        "func": "// On change of Ki setting\nlet logdata = \"bumpless \";\nlet I_sum = flow.get(\"I_integral_sum\");\nlet Ki = msg.payload || 0;     // Integral gain\nlet Ki_last = context.get(\"house_battery_control_ki_last\")||0;\n\n// if Ki was or has become zero\nif(Ki == 0 || Ki_last == 0){\n    // passify the integral-sum\n    flow.set(\"I_integral_sum\",0);\n    context.set(\"house_battery_control_ki_last\", Ki);\n    logdata += `to/from 0, Ki=${Ki_last} -> ${Ki} | `;\n    // done\n    return { payload: logdata };\n}\n\n// change in Ki\nlet dKi = parseFloat(Ki/Ki_last);\nif(dKi <= 0) dKi = 1; // ignore erroneous changes\n\n// keep I-term constant by compensating the integral-sum for the change in Ki\n// e.g. if Ki got 10% smaller, then integral-sum should increase 10%, to keep the I-term constant\nlet I_sum_new = I_sum / dKi;\nlogdata += `change of I: from ${Ki_last} to ${Ki} (${dKi * 100}%) | `;\n\n// OUTFLOW\nflow.set(\"I_integral_sum\", I_sum_new);\ncontext.set(\"house_battery_control_ki_last\", Ki);\n\n// OUTPUT\nreturn { payload: logdata };",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\n// init last state\nlet Ki = flow.get(\"house_battery_control_ki\") || 0;\ncontext.set(\"house_battery_control_ki_last\", Ki);",
        "finalize": "",
        "libs": [],
        "x": 1730,
        "y": 160,
        "wires": [
            [
                "6cee40362e88eb29"
            ]
        ]
    },
    {
        "id": "4672636ffc125dbb",
        "type": "comment",
        "z": "ab649936ec5003a8",
        "g": "9b4a06585508d834",
        "name": "Bumpless Ki changes",
        "info": "Recalc I-term whenever Ki changes\n\nNote: always be mindful of making changes to control parameters of systems in operation.",
        "x": 1740,
        "y": 60,
        "wires": []
    },
    {
        "id": "6cee40362e88eb29",
        "type": "debug",
        "z": "ab649936ec5003a8",
        "g": "9b4a06585508d834",
        "name": "Logdata",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1700,
        "y": 220,
        "wires": []
    },
    {
        "id": "3c069a284fb88cb8",
        "type": "switch",
        "z": "ab649936ec5003a8",
        "g": "c1a0edd1034ce527",
        "name": "Check for custom/auto mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Manual control",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Marstek control",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1855,
        "y": 520,
        "wires": [
            [
                "e36368accc35ec44",
                "2c052a6043213335"
            ],
            [
                "e36368accc35ec44",
                "2c052a6043213335"
            ],
            [
                "2c052a6043213335"
            ]
        ],
        "l": false
    },
    {
        "id": "2c052a6043213335",
        "type": "debug",
        "z": "ab649936ec5003a8",
        "g": "c1a0edd1034ce527",
        "name": "Master control switch",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2060,
        "y": 520,
        "wires": []
    },
    {
        "id": "ef2b4d94afca2335",
        "type": "server-state-changed",
        "z": "ab649936ec5003a8",
        "g": "c1a0edd1034ce527",
        "name": "Master control mode",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1730,
        "y": 520,
        "wires": [
            [
                "3c069a284fb88cb8"
            ]
        ]
    },
    {
        "id": "2a99bba814229d62",
        "type": "api-call-service",
        "z": "ab649936ec5003a8",
        "g": "c1a0edd1034ce527",
        "name": "Integral PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_i_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2050,
        "y": 360,
        "wires": [
            [
                "b989db7ba36bd9b8"
            ]
        ]
    },
    {
        "id": "b989db7ba36bd9b8",
        "type": "api-call-service",
        "z": "ab649936ec5003a8",
        "g": "c1a0edd1034ce527",
        "name": "Differential PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_d_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2060,
        "y": 400,
        "wires": [
            [
                "0ac1265e5b6a081b"
            ]
        ]
    },
    {
        "id": "e36368accc35ec44",
        "type": "api-call-service",
        "z": "ab649936ec5003a8",
        "g": "c1a0edd1034ce527",
        "name": "Proportinal PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_p_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2060,
        "y": 320,
        "wires": [
            [
                "2a99bba814229d62"
            ]
        ]
    },
    {
        "id": "0ac1265e5b6a081b",
        "type": "api-call-service",
        "z": "ab649936ec5003a8",
        "g": "c1a0edd1034ce527",
        "name": "PID Output to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2050,
        "y": 440,
        "wires": [
            [
                "be4d162a616e400e"
            ]
        ]
    },
    {
        "id": "be4d162a616e400e",
        "type": "change",
        "z": "ab649936ec5003a8",
        "g": "c1a0edd1034ce527",
        "name": "Integral sum to zero",
        "rules": [
            {
                "t": "set",
                "p": "I_integral_sum",
                "pt": "flow",
                "to": "0",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2060,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "dd0cc9762913d1db",
        "type": "api-current-state",
        "z": "ab649936ec5003a8",
        "g": "805549b5bb79c598",
        "name": "Target grid consumption",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_target_grid_consumption_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_target_grid_consumption_in_w",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 120,
        "wires": [
            [
                "3f905823ddb6a8b1"
            ]
        ],
        "info": "Set at 0 to strive for zero consumption"
    },
    {
        "id": "722dfe99613280ac",
        "type": "api-current-state",
        "z": "ab649936ec5003a8",
        "g": "e3dca719d51b04b0",
        "name": "Hysteresis",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_hysteresis_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_hysteresis_in_w",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1010,
        "y": 120,
        "wires": [
            [
                "1a961ede118a6d23"
            ]
        ]
    },
    {
        "id": "e9bf02259a6ecc0b",
        "type": "api-current-state",
        "z": "ab649936ec5003a8",
        "g": "805549b5bb79c598",
        "name": "PID P-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_kp",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_kp",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 410,
        "y": 180,
        "wires": [
            [
                "06cfedaa81143368"
            ]
        ]
    },
    {
        "id": "06cfedaa81143368",
        "type": "api-current-state",
        "z": "ab649936ec5003a8",
        "g": "805549b5bb79c598",
        "name": "PID I-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_ki",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_ki",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 590,
        "y": 180,
        "wires": [
            [
                "c324a93074b6e1fc"
            ]
        ]
    },
    {
        "id": "c324a93074b6e1fc",
        "type": "api-current-state",
        "z": "ab649936ec5003a8",
        "g": "805549b5bb79c598",
        "name": "PID D-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_kd",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_kd",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 770,
        "y": 180,
        "wires": [
            [
                "bc7b56734abfb680"
            ]
        ]
    },
    {
        "id": "1a961ede118a6d23",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "e3dca719d51b04b0",
        "name": "Advanced settings",
        "func": "// 1. Hard coded advanced settings (flow level)\nflow.set(\"has_soc_charging_limiter\", true);         // slows charging from 90% to 100% to improve battery life\nflow.set(\"has_reverse_priority_discharge\", true);   // Prioritize discharging and charging the same battery when possible\nflow.set(\"master_gain\", 1);                         // Gain scheduling. Not Implemented!\n\n// 2. Configurable advanced settings (msg level)\nmsg.advanced_settings ||= {}; // creates 'advanced_settings' if it does net yet exist\nlet mas = msg.advanced_settings;\n\n// disable charge or dicharge solutions and changes them to stop solutions\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\", mas.discharge_disabled ?? false);\nRED.util.setMessageProperty(msg,\"advanced_settings.charge_disabled\", mas.charge_disabled ?? false);\n// The nullish coalescing (??) operator is a logical operator that returns its right-hand side operand when its left-hand side operand is null or undefined\n\n// 3. continue\nreturn msg;\n\n// Notes for home battery tinkerer friends:\n// Using RED.util.getMessageProperty / RED.util.setMessageProperty is more performant and safe.\n// If any part of the path (\"foo.bar\") is missing, it will return 'undefined' without throwing an error.",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1030,
        "y": 180,
        "wires": [
            [
                "1541f06bbe603bf7"
            ]
        ]
    },
    {
        "id": "bc7b56734abfb680",
        "type": "api-current-state",
        "z": "ab649936ec5003a8",
        "g": "e3dca719d51b04b0",
        "name": "Idle time before Stop",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_idle_time",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "idle_time_minutes",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1040,
        "y": 80,
        "wires": [
            [
                "722dfe99613280ac"
            ]
        ]
    },
    {
        "id": "265987f795ab6051",
        "type": "comment",
        "z": "ab649936ec5003a8",
        "g": "aa86505827b85572",
        "name": "Setpoint ramping / damping",
        "info": "",
        "x": 460,
        "y": 460,
        "wires": []
    },
    {
        "id": "1541f06bbe603bf7",
        "type": "api-current-state",
        "z": "ab649936ec5003a8",
        "g": "aa86505827b85572",
        "name": "Error signal dampening",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_error_signal_dampening",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_error_signal_dampening",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 340,
        "wires": [
            [
                "1ed209c7d959a1c9"
            ]
        ]
    },
    {
        "id": "1ed209c7d959a1c9",
        "type": "api-current-state",
        "z": "ab649936ec5003a8",
        "g": "aa86505827b85572",
        "name": "Output signal dampening",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_pid_output_dampening",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_pid_output_dampening",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 380,
        "wires": [
            [
                "1cedf7d85305828f"
            ]
        ]
    },
    {
        "id": "1cedf7d85305828f",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "aa86505827b85572",
        "name": "Set: Error signal",
        "func": "// INPUTS\nlet P1_error_last = Number(context.get(\"p1_error_last\"))||0; // last error signal level in W\nlet dampening = Number(flow.get(\"house_battery_control_error_signal_dampening\")) || 0; // 0% - 100%\ndampening = dampening / 100; // to Number\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = Number(RED.util.getMessageProperty(msg,\"house_target_grid_consumption_in_w\")); // SP: target value\n\n// Calc error signal\nlet P1_error_unfiltered = P1_setpoint - P1_power;\n\n// Simple averaging filter\nlet P1_error_filtered = (1 - dampening) * P1_error_unfiltered + (dampening) * P1_error_last;\n\n// OUTFLOW\ncontext.set(\"p1_error_last\", P1_error_filtered);\n\n// OUTPUT\nmsg.grid_error = P1_error_filtered; // W (watt), error signal = SP - PV\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 420,
        "wires": [
            [
                "93cfae05413d6893"
            ]
        ]
    },
    {
        "id": "1a899c14f7559cee",
        "type": "comment",
        "z": "ab649936ec5003a8",
        "g": "c804bc50fc65d906",
        "name": "Bumpless target grid consumption",
        "info": "The error value is used by default to calculate the derivative.\nWhen the target grid consumption (tgc) is changed, the system is takes the derivative of the process variable instead.\nThis prevents irratic behavior during sudden changes of the error or setpoint value.\n\ne.g. you change the setpoint from 0 to 100W \nThe error would make an instantanious jump and cause a huge derivative-term.\nThe pv stays continous and fluent.\n\nAfter 1 control tick the derivative is taken from error again.\nUntil the `tgc` is changed again.",
        "x": 780,
        "y": 440,
        "wires": []
    },
    {
        "id": "36b95740489adc7d",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "c804bc50fc65d906",
        "name": "Derivative PV",
        "func": "var P1_power = msg.grid_power||0;\nvar P1_last_power = Number(context.get(\"p1_last_power\")) ||0;\n\n// PV derivative\nvar p1_derivative = P1_power - P1_last_power; // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_power\", P1_power);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 500,
        "wires": [
            [
                "4a4079d3e25c7e71"
            ]
        ]
    },
    {
        "id": "eaa76629a0cdef9e",
        "type": "switch",
        "z": "ab649936ec5003a8",
        "g": "c804bc50fc65d906",
        "name": "Target grid consumption unchanged",
        "property": "house_target_grid_consumption_in_w",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "",
                "vt": "prev"
            },
            {
                "t": "neq",
                "v": "",
                "vt": "prev"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 780,
        "y": 480,
        "wires": [
            [
                "6f9c9d096d7e0b9e"
            ],
            [
                "36b95740489adc7d"
            ]
        ]
    },
    {
        "id": "6f9c9d096d7e0b9e",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "c804bc50fc65d906",
        "name": "Derivative Error",
        "func": "var P1_error = msg.grid_error||0;\nvar P1_last_error = Number(context.get(\"p1_last_error\")) ||0;\n\n// Error derivative\n// note: error = -PV\n// note: for simplicity we assume 1 second time steps\nlet p1_derivative = -(P1_error - P1_last_error); // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_error\", P1_error);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 460,
        "wires": [
            [
                "4a4079d3e25c7e71"
            ]
        ]
    },
    {
        "id": "4a4079d3e25c7e71",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "c804bc50fc65d906",
        "name": "Derivative final value",
        "func": "\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1240,
        "y": 480,
        "wires": [
            [
                "4da0fc165f249710"
            ]
        ]
    },
    {
        "id": "93cfae05413d6893",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "185541e56b8b8a3c",
        "name": "Deadband (15W)",
        "func": "// Deadband\n// Stop processing if error is within .. Watt of target grid consumption.\n// This to reduce CPU loads \n\n// Logger\nconst log = global.get(\"logger\");\n\n// P1\nlet P1_error = msg.grid_error; // Watt\nlet P1_deadband = 15; // Watt\n\n// TODO\n// based on last 'assignable power' and current error, if (error > assignable power) the system will never enter the deadband. And keep calculating each interation.\n// however since we don't know if the is the assignable power will change, until we calculate the Control Value / load balancer\n// we could end up in a deadlock if we simply stop execution here, based on assignable power alone.\n\n// Within Deadband\nif(Math.abs(P1_error) < P1_deadband) {\n    // stop processing\n    node.status({fill:\"yellow\",shape:\"dot\",text:`Halt, ${Math.round(Math.abs(P1_error))} W`});\n    log(this, `**Stopped processing** power saving, ${Math.round(Math.abs(P1_error))} W is within deadband of ${P1_deadband} W`);\n    msg.payload = 'halted by deadband';\n    return msg;\n} \n\n// Outside deadband\nnode.status({fill:\"green\",shape:\"dot\",text:`Pass, ${Math.round(Math.abs(P1_error))} W`});\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 340,
        "wires": [
            [
                "b4af701da6471fb3"
            ]
        ]
    },
    {
        "id": "4da0fc165f249710",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "Calculate corrections",
        "func": "// Logger\nvar logdata = \"\"; // deprecated\nconst log = global.get(\"logger\");\n\n// Timing\nlet time_last = context.get('time_last') || Date.now(); // Milliseconds\nlet time_current = Date.now(); // Milliseconds\nlet time_delta = (time_current - time_last) / 1000; // Convert to seconds\n// note: due to inherent 1 sec intervals of P1 meter we omit dt terms. This is mostly for bug checking and optimizations.\n\n// Batteries\nvar B_power = msg.batteries_total_power; // charging is positive, discharging negative\nvar anti_windup_threshold = Number(flow.get(\"batteries_total_assignable_power\")) || 0; // max available charge/discharge power.\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = flow.get(\"house_target_grid_consumption_in_w\"); // SP: target value\nvar P1_error = msg.grid_error;  // W (watt), error signal = SP - PV\nvar P1_derivative = msg.grid_derivative; // Derivative of PV, not the error\n\n// PID values\nvar Kp = flow.get(\"house_battery_control_kp\") || 0.75;  // Proportional gain\nvar Ki = flow.get(\"house_battery_control_ki\") || 0;     // Integral gain        Ki = Kp/Ti\nvar Kd = flow.get(\"house_battery_control_kd\") || 0;     // Derivative gain      Kd = Kp*Td\n\n// helpers\nvar I_integral_sum = context.get('I_integral_sum') || 0;\nvar Gm = flow.get(\"master_gain\")||1; // gain scheduling\n\n// optimizations\nvar hysteresis = flow.get(\"house_battery_control_hysteresis_in_w\"); // W (watt)\n\n// advanced settings\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\");\nconst isChargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.charge_disabled\");\n\n// -- PID regulator --\n// Proportional term\nlet p_term = Gm * Kp * P1_error;\n\n// Integral term\nlet integral_max = 0;\nif (Ki > 0) {\n    // Integral term | integrate\n    I_integral_sum += P1_error; \n    // Integral term | apply anti-windup\n    integral_max = anti_windup_threshold / Ki; // the anti-windup value is set to the current controlable range of the batteries, given by the previous load balancer calculations\n    I_integral_sum = Math.min(Math.max(I_integral_sum, -integral_max), integral_max);\n} else {\n    // If Ki is 0, keep everything 0\n    I_integral_sum = 0;\n    integral_max = 0;\n}\n\n// Integral term | the term\nlet i_term = Ki * I_integral_sum;\n\n// Integral term | explain\nlogdata += `anti_windup_threshold=${anti_windup_threshold}, integral_max=${integral_max}| `; // deprecated\n\n// Differential term\nlet d_term = Gm * Kd * (-P1_derivative); // omitted '/time_delta'. inherent P1 refresh fequency.\n\n// Total PID output\nvar PID_output = p_term + i_term + d_term; // W (watt), the control input for the battery packs\n\n// Charging or Discharging states\nvar B_was_charging = context.get(\"batteries_charging_last\") || false;\nvar B_is_charging = PID_output > 0 ? true : false;\n\n// Explain\nlogdata += `U(${time_delta}s)[${PID_output}] = P(${Kp})[${p_term}] + I(${Ki})[${i_term}] + D(${Kd})[${d_term}] | `; // deprecated\nlog(this,`**PID Controller**`);\nlog(this,`Step size: ${time_delta} s`);\nif(Kp == 0 && Ki == 0 && Kd == 0) {\n    log(this, `<font color=\"orange\">**Controller disabled**</font> All PID gains are 0. Choose a PID preset or set gains > 0.`,\"warn\");\n} else {\n    log(this, `P-term: ${Math.floor(p_term)} W @ P-gain ${Kp}`);\n    log(this, `I-term: ${Math.floor(i_term)} W @ I-gain ${Ki} (max. ${anti_windup_threshold} W)`);\n    log(this, `D-term: ${Math.floor(d_term)} W @ D-gain ${Kd}`);\n    log(this, `**PID ${B_is_charging ? 'Charge' : 'Discharge'}:** ${Math.floor(p_term)} + ${Math.floor(i_term)} + ${Math.floor(d_term)} = **${Math.round(PID_output)} Watt**`);\n}\n\n// Only one of the advanced settings below can be active at once.\n// Advanced setting | discharge disabled\nif(isDischargeDisabled && !B_is_charging) {\n    // log explain\n    logdata += `Discharging disabled, PID unwound U(${time_delta})[0]=0+0+0 | `;\n    log(this,'**PID set to 0**. Discharge was disabled via `msg.advanced_settings`.');\n    // Set all PID terms to 0 and unwind integral sum\n    PID_output = 0;\n    p_term = 0;\n    i_term = 0;\n    d_term = 0;\n    I_integral_sum = 0; // unwind\n    // maintain charge scenario\n    B_is_charging = true;\n    \n// Advanced setting | charge disabled\n} else if (isChargeDisabled && B_is_charging) {\n    // log explain\n    logdata += `Charging disabled, PID unwound U(${time_delta})[0]=0+0+0 | `;\n    log(this,'**PID set to 0**. Charge was disabled via `msg.advanced_settings`.');\n    // Set all PID terms to 0 and unwind integral sum\n    PID_output = 0;\n    p_term = 0;\n    i_term = 0;\n    d_term = 0;\n    I_integral_sum = 0; // unwind\n    // maintain discharge scenario\n    B_is_charging = false;\n\n// Advanced setting | hysteresis\n} else if \n// prevents excessive switching between (dis)charge mode around the zero point.\n// if new PID_output lies within hysteresis, it will not switch charge mode. \n// set hysteresis to 0, to apply no hysteresis\n(B_is_charging !== B_was_charging && Math.abs(PID_output) < hysteresis){\n    // log explain\n    logdata += `Hysteresis prevented charge mode switch from ${B_was_charging ? \"charging\" : \"discharging\"} to ${B_is_charging ? \"charging\" : \"discharging\"} as ${Math.abs(PID_output)}W <= ${hysteresis}(hyst) | `;\n    log(this,`Hysteresis prevented charge mode switch from ${B_was_charging ? \"charging\" : \"discharging\"} to ${B_is_charging ? \"charging\" : \"discharging\"} as ${Math.abs(PID_output)}W <= ${hysteresis}(hyst)`);\n    // prevent negative charging or positive discharging values (not allowed)\n    PID_output = (PID_output < 0 && B_is_charging) || ((PID_output > 0 && !B_is_charging)) ? 0 : PID_output;\n    // maintain previous scenario\n    B_is_charging = B_was_charging;\n} \n\n// save for next iteration\ncontext.set(\"batteries_charging_last\", B_is_charging); //boolean\n\n// OUTFLOW\ncontext.set(\"time_last\", Date.now());\ncontext.set(\"I_integral_sum\", I_integral_sum);\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_charging\", B_is_charging, true);\nRED.util.setMessageProperty(msg, \"I_integral_sum\", I_integral_sum,true);\nmsg.payload = Number(PID_output);\n\n\nreturn [msg, // payload = PID_output\n        { payload: Number(P1_error)},\n        { payload: parseFloat(p_term)},\n        { payload: parseFloat(i_term)},\n        { payload: parseFloat(d_term)},\n        { payload: B_is_charging},\n        { payload: logdata }];",
        "outputs": 7,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 700,
        "wires": [
            [
                "55ddf1defd60268b"
            ],
            [
                "a08ea21098e3aa24"
            ],
            [
                "5d387a509968ca82"
            ],
            [
                "f32cb03abc33125b"
            ],
            [
                "3ed98e6437179b08"
            ],
            [
                "836ddcc064563249"
            ],
            [
                "764265c01b255e9e"
            ]
        ],
        "inputLabels": [
            "battery_array"
        ]
    },
    {
        "id": "764265c01b255e9e",
        "type": "debug",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "Logdata",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 1060,
        "wires": []
    },
    {
        "id": "a08ea21098e3aa24",
        "type": "api-call-service",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "Error Signal",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_signal"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 730,
        "y": 760,
        "wires": [
            [
                "4243807f05e15d17"
            ]
        ]
    },
    {
        "id": "34bc921932788e6b",
        "type": "api-call-service",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "PID Output",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 730,
        "y": 700,
        "wires": [
            [
                "4da9d58fa844c7d6"
            ]
        ]
    },
    {
        "id": "3c70ed30ae7d88b4",
        "type": "api-call-service",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "Proportinal term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_p_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 920,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "ae5e4985c9c3d921",
        "type": "api-call-service",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "Integral term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_i_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 910,
        "y": 880,
        "wires": [
            []
        ]
    },
    {
        "id": "b7f8246b058029e0",
        "type": "api-call-service",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "Differential term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_d_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 920,
        "y": 940,
        "wires": [
            []
        ]
    },
    {
        "id": "dcbaf2c03edb16a5",
        "type": "debug",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "Charging",
        "active": false,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 900,
        "y": 1060,
        "wires": []
    },
    {
        "id": "4da9d58fa844c7d6",
        "type": "smooth",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "",
        "property": "payload",
        "action": "sd",
        "count": "8",
        "round": "",
        "mult": "single",
        "reduce": false,
        "x": 900,
        "y": 700,
        "wires": [
            [
                "571ee1569bc2cde2"
            ]
        ]
    },
    {
        "id": "571ee1569bc2cde2",
        "type": "api-call-service",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "PID deviation",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output_deviation"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1070,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "4243807f05e15d17",
        "type": "smooth",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "",
        "property": "payload",
        "action": "sd",
        "count": "8",
        "round": "",
        "mult": "single",
        "reduce": false,
        "x": 900,
        "y": 760,
        "wires": [
            [
                "95cd1e4e56a5c34b"
            ]
        ]
    },
    {
        "id": "95cd1e4e56a5c34b",
        "type": "api-call-service",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "Error deviation",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_deviation"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1080,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "55ddf1defd60268b",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "Output dampening",
        "func": "// INPUT\nlet PID_unfiltered = msg.payload; // W Watt\nlet PID_last = context.get(\"PID_last\")||0; // W watt\nlet PID_damp = Number(flow.get(\"house_battery_control_pid_output_dampening\"))||0; // 0% - 100%\nPID_damp = PID_damp/100; // to Number\n\n// simple averaging filter\nlet PID_filtered = (1-PID_damp)*PID_unfiltered + (PID_damp)*PID_last;\n\n// OUTFLOW\ncontext.set(\"PID_last\", PID_filtered);\n\n// OUTPUT\nmsg.payload = Number(PID_filtered)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 660,
        "wires": [
            [
                "0924bf623b7764e5"
            ]
        ]
    },
    {
        "id": "0924bf623b7764e5",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "Output failsafe",
        "func": "// INFLOW\nlet maxCharge = msg.batteries_max_charge_power||undefined;\nlet maxDischarge = msg.batteries_max_discharge_power||undefined;\nlet isCharging = msg.batteries_charging||undefined;\nlet PID_output = msg.payload; // Watt\n\n// No failsafe\nif (maxCharge === undefined || maxDischarge == undefined) {\n    node.status({ fill: \"red\", shape: \"dot\", text: \"disabled\" });\n    node.warn(`Output Failsafe is INACTIVE. Max charge or discharge limits are undefined`);\n    // continue without safeguard\n    return msg;\n} \n\n// limit\nlet limit = 0;\n\n// charging state unknown\nif(isCharging === undefined) {\n    // limit on lowest of charge / discharge\n    limit = Math.min(maxCharge,maxDischarge);    \n}\n// charging state known\nlimit = isCharging ? maxCharge : maxDischarge;\n\n// Safe output\nif (PID_output <= limit){\n    node.status({ fill: \"green\", shape: \"dot\", text: \"safe\" });\n    return msg;\n} \n\n// Unsafe, limit output\nnode.status({ fill: \"yellow\", shape: \"ring\", text: \"power limiting\" });\nmsg.payload = Number(limit);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1080,
        "y": 660,
        "wires": [
            [
                "9839c948e5837948",
                "34bc921932788e6b"
            ]
        ]
    },
    {
        "id": "f32cb03abc33125b",
        "type": "rbe",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 880,
        "wires": [
            [
                "ae5e4985c9c3d921"
            ]
        ]
    },
    {
        "id": "9839c948e5837948",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "6a196c081e1ca3ef",
        "name": "Load distribution",
        "func": "// Logger\nconst log = global.get(\"logger\");\nlog(this,\"**PID load distribution**\");\n\n// INPUT\nvar batteries = msg.batteries; // Battery configuration as provided by `Home Batteries IO` flow\nvar isCharging = msg.batteries_charging; // Are we in a battery charging scenario?\nvar hasChargingLimiter = flow.get(\"has_soc_charging_limiter\") || false; // Battery life improvement\nvar hasReverseDischargePriority = flow.get(\"has_reverse_priority_discharge\") || false; // Prioritize (dis)charging the same battery\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\"); // Disallow discharging?\n\n// how much power do the batteries need to compensate?\nvar unassigned_power = Math.round(Math.abs(msg.payload)); // Power in W to compensate using batteries\nlog(this,`How much power do the batteries need to compensate: ${unassigned_power} W`);\n\n// inits \nvar solution_array = []; // load distribution solutions\nvar batteries_total_assignable_power = 0; // Current max. available total (dis)charge power. Exceeding this max should trigger the anti-windup routine for the Integral terms\n\n// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n/**\n** Battery life improvement (slow charge near max SoC)\n* @param {number} soc\n* @param {number} max_power\n*/\nfunction chargingLimiter(soc, max_power) {\n    // Must be greater than zero\n    let limitedPower = Math.max(0, max_power); \n\n    // Limit charge at high SoC\n    if (hasChargingLimiter) {\n        if (soc >= 98)      limitedPower = Math.min(300, limitedPower);\n        else if (soc >= 95) limitedPower = Math.min(500, limitedPower);\n        else if (soc >= 85) limitedPower = Math.min(1500, limitedPower);\n    }\n    return limitedPower;\n}\n\n/**\n* battery life improvement (disconnects battery only if the battery is not used for ... seconds)\n* @param {string | number} batteryID\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getStopSolution(batteryID) {\n    // idle time, before stop is given to inverter relay.\n    let time_idle_minimum = flow.get(\"idle_time_minutes\")*60*1000||0; // Milliseconds\n\n    // retrieve last registered active times for each battery based on their ids\n    let lasttime_active = context.get(\"lasttime_active\");\n    \n    // battery exists in register \n    if(lasttime_active[batteryID] !== undefined){\n        // timing\n        let time_last = lasttime_active[batteryID]; // Milliseconds \n        let time_now = Date.now();                  // Milliseconds \n        let time_idle = (time_now - time_last); // Milliseconds\n        \n        // battery is ready for STOP\n        if (time_idle >= time_idle_minimum) {\n            log(this,`Battery ${batteryID} [STOP]: 0 Watt and disconnect relay.`);\n            return {id: batteryID, mode: CMODE.STOP, power:0}; // STOP or 0 Watt disconnects relay\n        }\n        \n        // battery is kept IDLE, while awaiting minimum inactive time\n        log(this,`Battery ${batteryID} [IDLE]: 1 Watt for ${Math.round((time_idle_minimum-time_idle)/1000)}s. Keep relay engaged.`);\n        return { id: batteryID, mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE, power: 1 }; // 1 Watt keeps battery IDLE, keeping relay engaged\n    }\n\n    // battery missing in register\n    log(this,`Battery ${batteryID} [IDLE]: unknown last active time`);\n    return getActiveSolution(batteryID, 1); // set a last active time and engage idle state\n}\n\n/**\n* Get battery solution and register a last active time.\n* @param {any} batteryID\n* @param {number} assigned_power\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getActiveSolution(batteryID, assigned_power){\n    // register battery as active\n    let lasttime_active = context.get(\"lasttime_active\")||[]; // last registered active times for each battery based on their ids\n    lasttime_active[batteryID] = Date.now();\n    context.set(\"lasttime_active\", lasttime_active);\n\n    // solution\n    return {\n        id: batteryID,\n        mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE,\n        power: Math.round(assigned_power)\n    };\n}\n\n// -- BATTERY DISCHARGE PRIORITY\nif (!isCharging && hasReverseDischargePriority) {\n   batteries.reverse();\n}\n\n// -- LOAD BALANCER --\nbatteries.forEach((/** @type {{ id: any; soc: number; soc_min: number; soc_max: number; rs485: string; charging_max: number; discharging_max: any; }} */ battery) => {\n    \n    // Explain\n    log(this, `Battery ${battery.id}: ${battery.soc}% (min: ${battery.soc_min}%, max: ${battery.soc_max}%) ; RS485: ${battery.rs485=='enable'?'OK':'Nok'}`);\n\n    // track if the battery should be skipped and why\n    let skipReason = null;\n    if (battery.rs485 !== \"enable\") {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because RS485 is not 'enable'`;\n    } else if (isCharging && battery.soc >= battery.soc_max) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because SoC (${battery.soc}%) >= Max (${battery.soc_max}%) while charging`;\n    } else if (!isCharging && battery.soc <= battery.soc_min) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because SoC (${battery.soc}%) <= Min (${battery.soc_min}%) while discharging`;\n    } else if (!isCharging && isDischargeDisabled) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped, discharging was disabled via msg property`;\n    }\n\n    // battery NOT AVAIABLE, skip via soft stop\n    if (skipReason !== null) {\n        log(this, skipReason);                      // communicate reason\n        let solution = getStopSolution(battery.id); // get a soft stop solution for this battery\n        solution_array.push(solution);              // add solution, do not update last active time.\n        // next battery\n        return; \n    }\n\n    // battery is AVAILABLE, assign power\n    let battery_assignable_power = isCharging ? chargingLimiter(battery.soc, battery.charging_max) : battery.discharging_max;\n    let assign = Math.min(unassigned_power, battery_assignable_power);\n    \n    // select solution\n    var solution;\n    if (assign <= 0 ) {\n        // no power solution\n        solution = getStopSolution(battery.id); // a soft stop solution\n        assign = 0;\n    } else {\n        // assigned power solution\n        solution = getActiveSolution(battery.id, Math.round(assign));\n    }\n    solution_array.push(solution);\n    \n    // Explain: charge limiting\n    if(unassigned_power > battery_assignable_power && battery_assignable_power < battery.charging_max) {\n        log(this,`Charging limited to protect battery (${battery.soc}%): ${battery.charging_max}W -> ${battery_assignable_power}W`);\n    }\n    // Explain: solution result\n    log(this, `<font color=\"#009ac7\">Battery ${solution.id}</font>: assigned to ${solution.mode} with ${solution.power}W / ${isCharging ? battery.charging_max : battery.discharging_max }W max.`)\n\n    // remaining power to assign\n    unassigned_power -= assign;\n    batteries_total_assignable_power += Number(battery_assignable_power);\n});\n\n// battery discharge priority - put solutions back in initial order\nif (!isCharging && hasReverseDischargePriority) {\n    solution_array.reverse();\n}\n\n// store solutions in msg\nRED.util.setMessageProperty(msg, \"solutions\", solution_array,true);\n\n// OUTFLOW\nflow.set(\"batteries_total_assignable_power\", batteries_total_assignable_power); // this is set for the anti-windup calculation in the earlier 'calculate corrections' node, which will pick this up during next iteration.\n\n// OUTPUT\nreturn msg; // to Home Battery flow",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\ncontext.set(\"lasttime_active\",[]);",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 1160,
        "wires": [
            [
                "ce084a7d3ebd2772",
                "4b6743df002beb3e"
            ]
        ],
        "inputLabels": [
            "isCharging (boolean)"
        ]
    },
    {
        "id": "ce084a7d3ebd2772",
        "type": "debug",
        "z": "ab649936ec5003a8",
        "g": "6a196c081e1ca3ef",
        "name": "Load distribution",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "solutions",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 1160,
        "wires": []
    },
    {
        "id": "b4af701da6471fb3",
        "type": "switch",
        "z": "ab649936ec5003a8",
        "g": "185541e56b8b8a3c",
        "name": "Pass or Halt",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "halted by deadband",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "halted by deadband",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 340,
        "wires": [
            [
                "13c3ef285d60acdd"
            ],
            [
                "eaa76629a0cdef9e"
            ]
        ]
    },
    {
        "id": "4b6743df002beb3e",
        "type": "link out",
        "z": "ab649936ec5003a8",
        "g": "8630dad118ebd003",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 225,
        "y": 1240,
        "wires": []
    },
    {
        "id": "024f56d639e52f5d",
        "type": "comment",
        "z": "ab649936ec5003a8",
        "g": "8630dad118ebd003",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 170,
        "y": 1180,
        "wires": []
    },
    {
        "id": "13c3ef285d60acdd",
        "type": "link out",
        "z": "ab649936ec5003a8",
        "g": "185541e56b8b8a3c",
        "name": "go to End",
        "mode": "link",
        "links": [
            "fe3bd39ee2b999af"
        ],
        "x": 1090,
        "y": 340,
        "wires": [],
        "inputLabels": [
            "Halt"
        ],
        "l": true
    },
    {
        "id": "fe3bd39ee2b999af",
        "type": "link in",
        "z": "ab649936ec5003a8",
        "g": "8630dad118ebd003",
        "name": "link to End",
        "links": [
            "13c3ef285d60acdd"
        ],
        "x": 105,
        "y": 1240,
        "wires": [
            [
                "4b6743df002beb3e"
            ]
        ]
    },
    {
        "id": "a0f43e4c238d1e4c",
        "type": "api-call-service",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "Is charging",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "",
        "service": "",
        "x": 1070,
        "y": 1000,
        "wires": [
            []
        ]
    },
    {
        "id": "2dc86ab16ef6e934",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "Config action",
        "func": "const value = msg.payload;\nconst target = \"input_boolean.house_battery_control_is_charging\";\n\nmsg.payload = {\n    \"action\": value?\"input_boolean.turn_on\":\"input_boolean.turn_off\",\n    \"target\": {\n        \"entity_id\": [target]\n    },\n    \"data\": {}\n}\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 1000,
        "wires": [
            [
                "a0f43e4c238d1e4c"
            ]
        ]
    },
    {
        "id": "d0f39168348cc038",
        "type": "switch",
        "z": "ab649936ec5003a8",
        "g": "805549b5bb79c598",
        "name": "Target",
        "property": "house_target_grid_consumption_in_w",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 390,
        "y": 120,
        "wires": [
            [
                "b890d7ba6c18f852"
            ],
            [
                "dd0cc9762913d1db"
            ]
        ]
    },
    {
        "id": "3904652fd20ee276",
        "type": "debug",
        "z": "ab649936ec5003a8",
        "g": "805549b5bb79c598",
        "name": "Target",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "house_target_grid_consumption_in_w",
        "targetType": "msg",
        "statusVal": "house_target_grid_consumption_in_w",
        "statusType": "auto",
        "x": 790,
        "y": 100,
        "wires": []
    },
    {
        "id": "3ab6f677420a1643",
        "type": "server-state-changed",
        "z": "ab649936ec5003a8",
        "g": "c1a0edd1034ce527",
        "name": "Strategy changes",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_text.house_battery_strategy_active_sub_strategy",
                "input_select.house_battery_strategy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 340,
        "wires": [
            [
                "4df9eb09c05acc4b"
            ]
        ]
    },
    {
        "id": "4df9eb09c05acc4b",
        "type": "switch",
        "z": "ab649936ec5003a8",
        "g": "c1a0edd1034ce527",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full stop",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1855,
        "y": 340,
        "wires": [
            [
                "e36368accc35ec44"
            ]
        ],
        "l": false
    },
    {
        "id": "9b8bdd8b09e00720",
        "type": "server-state-changed",
        "z": "ab649936ec5003a8",
        "g": "c1a0edd1034ce527",
        "name": "Full stop trigger",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.ev_is_charging"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 420,
        "wires": [
            [
                "b684f654bf13813c"
            ]
        ]
    },
    {
        "id": "b684f654bf13813c",
        "type": "switch",
        "z": "ab649936ec5003a8",
        "g": "c1a0edd1034ce527",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1855,
        "y": 420,
        "wires": [
            [
                "e36368accc35ec44"
            ]
        ],
        "l": false
    },
    {
        "id": "5d387a509968ca82",
        "type": "rbe",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 820,
        "wires": [
            [
                "3c70ed30ae7d88b4"
            ]
        ]
    },
    {
        "id": "3ed98e6437179b08",
        "type": "rbe",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 940,
        "wires": [
            [
                "b7f8246b058029e0"
            ]
        ]
    },
    {
        "id": "836ddcc064563249",
        "type": "rbe",
        "z": "ab649936ec5003a8",
        "g": "eaf26e698ab1310a",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 1000,
        "wires": [
            [
                "2dc86ab16ef6e934",
                "dcbaf2c03edb16a5"
            ]
        ]
    },
    {
        "id": "d4343a51125ccdab",
        "type": "change",
        "z": "ab649936ec5003a8",
        "g": "5271f96dc7c112a4",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 190,
        "y": 200,
        "wires": [
            [
                "d0f39168348cc038"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "fcfcc1a78161251b",
        "type": "catch",
        "z": "ab649936ec5003a8",
        "g": "3da3756e03e79934",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 95,
        "y": 320,
        "wires": [
            [
                "1e332a115c8fded2"
            ]
        ],
        "l": false
    },
    {
        "id": "1e332a115c8fded2",
        "type": "function",
        "z": "ab649936ec5003a8",
        "g": "3da3756e03e79934",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 145,
        "y": 320,
        "wires": [
            [
                "ad03e54599bc4146"
            ]
        ],
        "l": false
    },
    {
        "id": "ad03e54599bc4146",
        "type": "link out",
        "z": "ab649936ec5003a8",
        "g": "3da3756e03e79934",
        "name": "link out 7",
        "mode": "return",
        "links": [],
        "x": 195,
        "y": 320,
        "wires": []
    },
    {
        "id": "92d4dc71fa150f5a",
        "type": "comment",
        "z": "e77ef29a0d741103",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 140,
        "y": 60,
        "wires": []
    },
    {
        "id": "6dadf397f2f6b3bd",
        "type": "link in",
        "z": "e77ef29a0d741103",
        "g": "8c445bc062decbcc",
        "name": "Sell",
        "links": [],
        "x": 110,
        "y": 220,
        "wires": [
            [
                "11906312b0cb6efa"
            ]
        ],
        "l": true
    },
    {
        "id": "ef5a08d8ffcd7110",
        "type": "comment",
        "z": "e77ef29a0d741103",
        "g": "8c445bc062decbcc",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 130,
        "y": 140,
        "wires": []
    },
    {
        "id": "11906312b0cb6efa",
        "type": "change",
        "z": "e77ef29a0d741103",
        "g": "8c445bc062decbcc",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 180,
        "wires": [
            [
                "3f1d0d1588b39515"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "7998507fa346fe3d",
        "type": "link out",
        "z": "e77ef29a0d741103",
        "g": "5e1e1f49d44e8b30",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 185,
        "y": 580,
        "wires": []
    },
    {
        "id": "ae9357a8119887bd",
        "type": "comment",
        "z": "e77ef29a0d741103",
        "g": "5e1e1f49d44e8b30",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 130,
        "y": 520,
        "wires": []
    },
    {
        "id": "8ddc03d7b7f3c009",
        "type": "function",
        "z": "e77ef29a0d741103",
        "g": "10bdc9982eb2e3f5",
        "name": "Max power solution",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\nlog(this, \"Discharge at **max. power**\");\n\n// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// build solution\nmsg.batteries.forEach(battery => {\n    const calculatedPower = Number(battery.discharging_max);\n\n    solution_array.push({\n        id: battery.id,\n        mode: \"discharge\",\n        power: calculatedPower\n    });\n\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 360,
        "wires": [
            [
                "f9e95a63d7c7c20b"
            ]
        ]
    },
    {
        "id": "1cab3db414f0c263",
        "type": "link call",
        "z": "e77ef29a0d741103",
        "g": "10bdc9982eb2e3f5",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1140,
        "y": 400,
        "wires": [
            [
                "78e90bb395c0dbed",
                "a4e67dfad40aa29b"
            ]
        ]
    },
    {
        "id": "b2d4a202f2685181",
        "type": "switch",
        "z": "e77ef29a0d741103",
        "g": "10bdc9982eb2e3f5",
        "name": "Export at max power",
        "property": "house_battery_strategy_sell_has_max_power",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 760,
        "y": 380,
        "wires": [
            [
                "8ddc03d7b7f3c009"
            ],
            [
                "3d1362c4480436b3"
            ]
        ]
    },
    {
        "id": "78e90bb395c0dbed",
        "type": "debug",
        "z": "e77ef29a0d741103",
        "g": "10bdc9982eb2e3f5",
        "name": "Regulated",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1330,
        "y": 400,
        "wires": []
    },
    {
        "id": "9dcdc76e0bd7c4ab",
        "type": "debug",
        "z": "e77ef29a0d741103",
        "g": "10bdc9982eb2e3f5",
        "name": "Maximum",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1320,
        "y": 360,
        "wires": []
    },
    {
        "id": "3d1362c4480436b3",
        "type": "function",
        "z": "e77ef29a0d741103",
        "g": "10bdc9982eb2e3f5",
        "name": "Regulated power",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = -msg.house_battery_strategy_sell_target_power; // negative, we are exporting to grid.\n// tell PID to avoid charge solutions during Selling.\nRED.util.setMessageProperty(msg,\"advanced_settings.charge_disabled\",true,true);\n\n// Finally\nlog(this, `**Regulated** discharging. Max. grid power: ${Math.floor(msg.house_battery_strategy_sell_target_power)} W`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 400,
        "wires": [
            [
                "1cab3db414f0c263"
            ]
        ]
    },
    {
        "id": "f9e95a63d7c7c20b",
        "type": "change",
        "z": "e77ef29a0d741103",
        "g": "10bdc9982eb2e3f5",
        "name": "Continue",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Charge",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 360,
        "wires": [
            [
                "9dcdc76e0bd7c4ab",
                "a4e67dfad40aa29b"
            ]
        ]
    },
    {
        "id": "54877b224d3c485a",
        "type": "function",
        "z": "e77ef29a0d741103",
        "g": "6adb6d0c1201ee54",
        "name": "Min/max",
        "func": "\n// Lower bound\nlet output = msg.sell.threshold_energy | 0; // kWh\noutput = Math.max(output, 0);\n\n// Upper bound\nlet max_reserve = 0; // kWh\nmsg.batteries.forEach(battery => {\n    max_reserve += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\noutput = Math.min(output, max_reserve);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1720,
        "y": 200,
        "wires": [
            [
                "fd4b568c70976982"
            ]
        ]
    },
    {
        "id": "fd4b568c70976982",
        "type": "api-call-service",
        "z": "e77ef29a0d741103",
        "g": "6adb6d0c1201ee54",
        "name": "Set desired energy reserve",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_sell_target_energy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.payload}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1920,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "26a6fb39925f6219",
        "type": "rbe",
        "z": "e77ef29a0d741103",
        "g": "6adb6d0c1201ee54",
        "name": "Desired energy changed",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 1530,
        "y": 200,
        "wires": [
            [
                "54877b224d3c485a"
            ]
        ]
    },
    {
        "id": "f004af2ab6db360d",
        "type": "api-current-state",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Goal",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_sell_goal",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.goal",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 180,
        "wires": [
            [
                "c40455a8c54319d9"
            ]
        ]
    },
    {
        "id": "c40455a8c54319d9",
        "type": "switch",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Sell until",
        "property": "sell.goal",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "batteries are empty",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "state of charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "energy reserve",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 4,
        "x": 580,
        "y": 180,
        "wires": [
            [
                "73d55eb55311595d"
            ],
            [
                "f83c002bea913080"
            ],
            [
                "d8ac0234fd05fef3"
            ],
            [
                "ccd97d526145218b"
            ]
        ]
    },
    {
        "id": "ccd97d526145218b",
        "type": "function",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Unknown -> Full stop",
        "func": "const log = global.get(\"logger\");\n\n// Unkown export goal\nlog(this, `**${msg.sell.goal}**; Sell goal not recognized. Fallback to **Full Stop**`,\"warn\");\n\n// Full stop\nmsg.target = \"Full stop\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 240,
        "wires": [
            [
                "702ccad6e2cbceab"
            ]
        ]
    },
    {
        "id": "3f1d0d1588b39515",
        "type": "function",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Init",
        "func": "msg.sell = {};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "f004af2ab6db360d"
            ]
        ]
    },
    {
        "id": "702ccad6e2cbceab",
        "type": "link call",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 940,
        "y": 240,
        "wires": [
            [
                "fa141ca0faa264a1"
            ]
        ]
    },
    {
        "id": "d8ac0234fd05fef3",
        "type": "api-current-state",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Energy reserve low",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.threshold_energy",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 750,
        "y": 200,
        "wires": [
            [
                "7200f55023f46f04"
            ]
        ]
    },
    {
        "id": "1be6518cea60edc0",
        "type": "link in",
        "z": "e77ef29a0d741103",
        "g": "5e1e1f49d44e8b30",
        "name": "link to End",
        "links": [
            "fa141ca0faa264a1",
            "ef87f4e1c4d13f4c",
            "a4e67dfad40aa29b"
        ],
        "x": 75,
        "y": 580,
        "wires": [
            [
                "7998507fa346fe3d"
            ]
        ]
    },
    {
        "id": "fa141ca0faa264a1",
        "type": "link out",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "go to End",
        "mode": "link",
        "links": [
            "1be6518cea60edc0"
        ],
        "x": 1140,
        "y": 240,
        "wires": [],
        "l": true
    },
    {
        "id": "f83c002bea913080",
        "type": "api-current-state",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "SoC low",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_soc",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.threshold_soc",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 720,
        "y": 160,
        "wires": [
            [
                "529b8999db742c26"
            ]
        ]
    },
    {
        "id": "7200f55023f46f04",
        "type": "function",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Check if low",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Sell until: ${msg.sell.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nvar energy_threshold = Number(RED.util.getMessageProperty(msg,\"sell.threshold_energy\"));\nif (energy_threshold === undefined || energy_threshold < 0){\n    log(this,`Desired energy reserve not set correctly '${energy_threshold}' kWh`,\"warn\");\n    energy_threshold = 0;\n}\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining <= energy_threshold) {\n    msg.sell.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.sell.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.sell.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 200,
        "wires": [
            [
                "8823264060d2fd83",
                "26a6fb39925f6219"
            ]
        ]
    },
    {
        "id": "529b8999db742c26",
        "type": "function",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Check if low",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this, `Sell until: ${msg.sell.goal}`);\n\n// 2. Extract average SoC and desired SoC level\nlet batteries = msg.batteries;\nlet soc_avg = 0;\nlet count = 0; // could use msg.battery_count\nbatteries.forEach(battery => {\n    soc_avg += battery.soc;\n    count++;\n});\n// 2a.  Current avg. SoC\nsoc_avg = Math.round(soc_avg / count * 100) / 100;\n// 2b.  Sell until SoC (12% as fallback)\nvar soc_threshold = Number(RED.util.getMessageProperty(msg,\"sell.threshold_soc\"));\nif (soc_threshold === undefined || soc_threshold < 12){\n    log(this, `Desired SoC not set correctly '${soc_threshold}' %. I've set it to 12%.`,\"warn\");\n    soc_threshold = 12;\n}\n\n// 3. Logic: Determine if SoC level is at or below desired level\nif (soc_avg <= msg.payload) {\n    msg.sell.threshold_reached = true;\n\n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n\n    // User friendly feedback via the custom logger\n    log(this, `[OK] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({\n    fill: msg.sell.threshold_reached ? \"red\" : \"green\",\n    shape: \"dot\",\n    text: `Threshold reached: ${msg.sell.threshold_reached}`\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 160,
        "wires": [
            [
                "8823264060d2fd83"
            ]
        ]
    },
    {
        "id": "73d55eb55311595d",
        "type": "change",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Batteries are empty",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 120,
        "wires": [
            [
                "22aa1a8dcb03e6e5"
            ]
        ]
    },
    {
        "id": "22aa1a8dcb03e6e5",
        "type": "function",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Check if empty",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Sell until: ${msg.sell.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining <= 0) {\n    msg.sell.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] All batteries are empty or at SoC_min_ (${energy_remaining} kWh).`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Battery level ${energy_remaining.toFixed(2)} kWh above 0 kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.sell.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.sell.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 960,
        "y": 120,
        "wires": [
            [
                "8823264060d2fd83"
            ]
        ]
    },
    {
        "id": "4717108485222f24",
        "type": "switch",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Until reached",
        "property": "sell.threshold_reached",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1290,
        "y": 160,
        "wires": [
            [
                "c208504aa23bef5c"
            ],
            [
                "f321edb9d2d83087"
            ]
        ]
    },
    {
        "id": "c208504aa23bef5c",
        "type": "function",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Yes -> Full stop",
        "func": "\nmsg.target = \"Full stop\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1520,
        "y": 120,
        "wires": [
            [
                "a997b439f01cc853"
            ]
        ]
    },
    {
        "id": "a997b439f01cc853",
        "type": "link call",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 1680,
        "y": 120,
        "wires": [
            [
                "ef87f4e1c4d13f4c"
            ]
        ]
    },
    {
        "id": "ef87f4e1c4d13f4c",
        "type": "link out",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "go to End",
        "mode": "link",
        "links": [
            "1be6518cea60edc0"
        ],
        "x": 1820,
        "y": 120,
        "wires": [],
        "l": true
    },
    {
        "id": "8823264060d2fd83",
        "type": "function",
        "z": "e77ef29a0d741103",
        "g": "973bb4c97953a2b2",
        "name": "Decided",
        "func": "const log = global.get(\"logger\");\n\nif(msg.sell.threshold_reached){\n    log(this,`Stop discharging, Sell until ${msg.sell.goal} reached.`);\n} else {\n    log(this,`Continue discharging.`);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1140,
        "y": 160,
        "wires": [
            [
                "4717108485222f24"
            ]
        ]
    },
    {
        "id": "a4e67dfad40aa29b",
        "type": "link out",
        "z": "e77ef29a0d741103",
        "g": "10bdc9982eb2e3f5",
        "name": "go to End",
        "mode": "link",
        "links": [
            "1be6518cea60edc0"
        ],
        "x": 1320,
        "y": 460,
        "wires": [],
        "l": true
    },
    {
        "id": "3b98705984e28841",
        "type": "catch",
        "z": "e77ef29a0d741103",
        "g": "77471167526c99a1",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 75,
        "y": 420,
        "wires": [
            [
                "ca666c90b1c9969f"
            ]
        ],
        "l": false
    },
    {
        "id": "30d3a0c0b2fbd1ee",
        "type": "api-current-state",
        "z": "e77ef29a0d741103",
        "g": "10bdc9982eb2e3f5",
        "name": "Use max power?",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_sell_has_max_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_sell_has_max_power",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 380,
        "wires": [
            [
                "05fc785d0fc1f322"
            ]
        ]
    },
    {
        "id": "05fc785d0fc1f322",
        "type": "api-current-state",
        "z": "e77ef29a0d741103",
        "g": "10bdc9982eb2e3f5",
        "name": "Grid power limit",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_sell_target_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 560,
        "y": 380,
        "wires": [
            [
                "b2d4a202f2685181"
            ]
        ]
    },
    {
        "id": "ca666c90b1c9969f",
        "type": "function",
        "z": "e77ef29a0d741103",
        "g": "77471167526c99a1",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 125,
        "y": 420,
        "wires": [
            [
                "cfb79189db97fb6d"
            ]
        ],
        "l": false
    },
    {
        "id": "cfb79189db97fb6d",
        "type": "link out",
        "z": "e77ef29a0d741103",
        "g": "77471167526c99a1",
        "name": "link out 2",
        "mode": "return",
        "links": [],
        "x": 175,
        "y": 420,
        "wires": []
    },
    {
        "id": "aa901028487fda57",
        "type": "link in",
        "z": "565472d31bbf94d6",
        "g": "f351846034cb37db",
        "name": "Timed",
        "links": [],
        "x": 110,
        "y": 160,
        "wires": [
            [
                "a40720f2962ad767"
            ]
        ],
        "l": true
    },
    {
        "id": "5ef69e69fbec8a37",
        "type": "comment",
        "z": "565472d31bbf94d6",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 130,
        "y": 40,
        "wires": []
    },
    {
        "id": "36d0bfe4dfb4f1ad",
        "type": "comment",
        "z": "565472d31bbf94d6",
        "g": "f351846034cb37db",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 120,
        "y": 120,
        "wires": []
    },
    {
        "id": "147d332b0661fd93",
        "type": "link out",
        "z": "565472d31bbf94d6",
        "g": "bf4a177b0973bf60",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 1255,
        "y": 520,
        "wires": []
    },
    {
        "id": "46db1ca78901a81a",
        "type": "comment",
        "z": "565472d31bbf94d6",
        "g": "bf4a177b0973bf60",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 1310,
        "y": 460,
        "wires": []
    },
    {
        "id": "64f008151046897a",
        "type": "api-current-state",
        "z": "565472d31bbf94d6",
        "g": "a4c2255a364ee81e",
        "name": "Period A start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_a1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_a1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 550,
        "y": 120,
        "wires": [
            [
                "a257c8ae8c0d645a"
            ]
        ]
    },
    {
        "id": "a257c8ae8c0d645a",
        "type": "api-current-state",
        "z": "565472d31bbf94d6",
        "g": "a4c2255a364ee81e",
        "name": "Period A end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_a2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_a2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 120,
        "wires": [
            [
                "443ecb9004966257"
            ]
        ]
    },
    {
        "id": "d9587ef14ec1bc40",
        "type": "api-current-state",
        "z": "565472d31bbf94d6",
        "g": "0d15ba99fc93cc6b",
        "name": "Period B start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_b1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_b1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 220,
        "wires": [
            [
                "556ff9cd3a9294a6"
            ]
        ]
    },
    {
        "id": "556ff9cd3a9294a6",
        "type": "api-current-state",
        "z": "565472d31bbf94d6",
        "g": "0d15ba99fc93cc6b",
        "name": "Period B end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_b2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_b2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 220,
        "wires": [
            [
                "b7b06ea09cbb4a2e"
            ]
        ]
    },
    {
        "id": "443ecb9004966257",
        "type": "api-current-state",
        "z": "565472d31bbf94d6",
        "g": "a4c2255a364ee81e",
        "name": "Strat during A",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_a",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_a",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 120,
        "wires": [
            [
                "51c1932610a9e86b"
            ]
        ]
    },
    {
        "id": "b7b06ea09cbb4a2e",
        "type": "api-current-state",
        "z": "565472d31bbf94d6",
        "g": "0d15ba99fc93cc6b",
        "name": "Strat during B",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_b",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_b",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 220,
        "wires": [
            [
                "76b6003837ed2f4a"
            ]
        ]
    },
    {
        "id": "51c1932610a9e86b",
        "type": "api-current-state",
        "z": "565472d31bbf94d6",
        "g": "0d15ba99fc93cc6b",
        "name": "Has period B",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_period_b",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_period_b",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 220,
        "wires": [
            [
                "d9587ef14ec1bc40"
            ]
        ]
    },
    {
        "id": "5a4bbcea1bf35e23",
        "type": "inject",
        "z": "565472d31bbf94d6",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 40,
        "wires": [
            [
                "bfc867f58d4e467d"
            ]
        ]
    },
    {
        "id": "99abfd44ef05f1c9",
        "type": "change",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 460,
        "wires": [
            [
                "9d74ec5ccde0dd52"
            ]
        ]
    },
    {
        "id": "5896bb5aa8446dea",
        "type": "change",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "set Strat A",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_a",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 420,
        "wires": [
            [
                "db42d487c2a39f19",
                "621149c4156f5e2c"
            ]
        ]
    },
    {
        "id": "9d74ec5ccde0dd52",
        "type": "switch",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "has period B",
        "property": "house_battery_strategy_timed_has_period_b",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 500,
        "wires": [
            [
                "db42d487c2a39f19",
                "736b18fd4caaf56e"
            ],
            [
                "eee90004eabfba55"
            ]
        ]
    },
    {
        "id": "8a4c0f0248911c49",
        "type": "function",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "config A",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_a1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_a2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 440,
        "wires": [
            [
                "4922f6025aed4be0"
            ]
        ]
    },
    {
        "id": "4922f6025aed4be0",
        "type": "time-range-switch",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "Period A",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 440,
        "wires": [
            [
                "5896bb5aa8446dea"
            ],
            [
                "99abfd44ef05f1c9"
            ]
        ]
    },
    {
        "id": "eee90004eabfba55",
        "type": "function",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "config B",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_b1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_b2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 580,
        "wires": [
            [
                "aede54d2d757b5fa"
            ]
        ]
    },
    {
        "id": "aede54d2d757b5fa",
        "type": "time-range-switch",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "Period B",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 580,
        "wires": [
            [
                "bc1bd7be720bbe3c"
            ],
            [
                "93bd3c05704c2217"
            ]
        ]
    },
    {
        "id": "bc1bd7be720bbe3c",
        "type": "change",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "set Strat B",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_b",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 560,
        "wires": [
            [
                "db42d487c2a39f19",
                "b746a642455620f1"
            ]
        ]
    },
    {
        "id": "93bd3c05704c2217",
        "type": "change",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 600,
        "wires": [
            [
                "1737f34a39997ce3"
            ]
        ]
    },
    {
        "id": "bfc867f58d4e467d",
        "type": "api-current-state",
        "z": "565472d31bbf94d6",
        "g": "b633b5e15993e0d6",
        "name": "Default Strat",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_0",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_0",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 120,
        "wires": [
            [
                "64f008151046897a"
            ]
        ]
    },
    {
        "id": "0a02d392a3de1ef6",
        "type": "link call",
        "z": "565472d31bbf94d6",
        "g": "798b3b3b301d9113",
        "name": "Sub strategy",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1080,
        "y": 520,
        "wires": [
            [
                "147d332b0661fd93"
            ]
        ]
    },
    {
        "id": "db42d487c2a39f19",
        "type": "change",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "Select flow",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "timed_strategy",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 850,
        "y": 520,
        "wires": [
            [
                "0a02d392a3de1ef6",
                "d52956cca05d6d22"
            ]
        ]
    },
    {
        "id": "621149c4156f5e2c",
        "type": "debug",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "A",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 420,
        "wires": []
    },
    {
        "id": "736b18fd4caaf56e",
        "type": "debug",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 460,
        "wires": []
    },
    {
        "id": "b746a642455620f1",
        "type": "debug",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "B",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 560,
        "wires": []
    },
    {
        "id": "ef6841be6b3946bf",
        "type": "debug",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 600,
        "wires": []
    },
    {
        "id": "d52956cca05d6d22",
        "type": "debug",
        "z": "565472d31bbf94d6",
        "g": "798b3b3b301d9113",
        "name": "Target",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "target",
        "targetType": "msg",
        "statusVal": "target",
        "statusType": "auto",
        "x": 1060,
        "y": 460,
        "wires": []
    },
    {
        "id": "03f807ef302dcd0b",
        "type": "api-current-state",
        "z": "565472d31bbf94d6",
        "g": "cb501137f9834535",
        "name": "Period C start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_c1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_c1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 320,
        "wires": [
            [
                "950fcd1c9f28362f"
            ]
        ]
    },
    {
        "id": "950fcd1c9f28362f",
        "type": "api-current-state",
        "z": "565472d31bbf94d6",
        "g": "cb501137f9834535",
        "name": "Period C end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_c2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_c2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 320,
        "wires": [
            [
                "d8222b605a245b59"
            ]
        ]
    },
    {
        "id": "d8222b605a245b59",
        "type": "api-current-state",
        "z": "565472d31bbf94d6",
        "g": "cb501137f9834535",
        "name": "Strat during C",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_c",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_c",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 320,
        "wires": [
            [
                "8a4c0f0248911c49"
            ]
        ]
    },
    {
        "id": "76b6003837ed2f4a",
        "type": "api-current-state",
        "z": "565472d31bbf94d6",
        "g": "cb501137f9834535",
        "name": "Has period C",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_period_c",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_period_c",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 320,
        "wires": [
            [
                "03f807ef302dcd0b"
            ]
        ]
    },
    {
        "id": "1737f34a39997ce3",
        "type": "switch",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "has period C",
        "property": "house_battery_strategy_timed_has_period_c",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 640,
        "wires": [
            [
                "db42d487c2a39f19",
                "ef6841be6b3946bf"
            ],
            [
                "71d7c5895ac89155"
            ]
        ]
    },
    {
        "id": "c46e822a8176c726",
        "type": "debug",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "C",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 700,
        "wires": []
    },
    {
        "id": "71d7c5895ac89155",
        "type": "function",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "config C",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_c1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_c2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 720,
        "wires": [
            [
                "aba39d4d9a9f7fcf"
            ]
        ]
    },
    {
        "id": "aba39d4d9a9f7fcf",
        "type": "time-range-switch",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "Period C",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 720,
        "wires": [
            [
                "e962b70c672d2a77"
            ],
            [
                "fea4fe092fcccf5e"
            ]
        ]
    },
    {
        "id": "e962b70c672d2a77",
        "type": "change",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "set Strat C",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_c",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 700,
        "wires": [
            [
                "c46e822a8176c726",
                "db42d487c2a39f19"
            ]
        ]
    },
    {
        "id": "fea4fe092fcccf5e",
        "type": "change",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 740,
        "wires": [
            [
                "db42d487c2a39f19",
                "11ac32f37c71e6d2"
            ]
        ]
    },
    {
        "id": "11ac32f37c71e6d2",
        "type": "debug",
        "z": "565472d31bbf94d6",
        "g": "08eca2e18a0ac453",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 740,
        "wires": []
    },
    {
        "id": "a40720f2962ad767",
        "type": "change",
        "z": "565472d31bbf94d6",
        "g": "f351846034cb37db",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 200,
        "wires": [
            [
                "bfc867f58d4e467d"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "ca28a29d799a7941",
        "type": "catch",
        "z": "565472d31bbf94d6",
        "g": "75aa197258115847",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 65,
        "y": 320,
        "wires": [
            [
                "fb1e6798b3ce474e"
            ]
        ],
        "l": false
    },
    {
        "id": "fb1e6798b3ce474e",
        "type": "function",
        "z": "565472d31bbf94d6",
        "g": "75aa197258115847",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 115,
        "y": 320,
        "wires": [
            [
                "41fc4c8efb88419a"
            ]
        ],
        "l": false
    },
    {
        "id": "41fc4c8efb88419a",
        "type": "link out",
        "z": "565472d31bbf94d6",
        "g": "75aa197258115847",
        "name": "link out 8",
        "mode": "return",
        "links": [],
        "x": 165,
        "y": 320,
        "wires": []
    },
    {
        "id": "60f00d58ee4e9e78",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.3",
            "node-red-node-smooth": "0.1.2",
            "node-red-contrib-time-range-switch": "1.2.0"
        }
    }
]