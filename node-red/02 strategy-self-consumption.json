[
    {
        "id": "a099d47fc07b3cee",
        "type": "tab",
        "label": "Home Battery Start",
        "disabled": false,
        "info": "# Home battery control\r\nConsists of three flows:\r\n 1.  Start flow\r\n 1.  Control flow\r\n 1.  Master switch flow\r\n\r\n## Start flow\r\nThis is the starting point of your home battery control.\r\n\r\nIt starts with P1 measurement as a trigger.\r\nIt allows you to connect your battery sensors to the flow.\r\nIt ends with a function node, mapping your batteries to a battery_array\r\n\r\nThe battery_array is passed on to the control flow.\r\n\r\nWhen the control flow has calculated the desired corrections,\r\nit is passed back to this flow and applied to your batteries.",
        "env": []
    },
    {
        "id": "acde727d4cb42aaa",
        "type": "tab",
        "label": "Home Battery Master Switch",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "0a25621f3d1c985f",
        "type": "tab",
        "label": "Home Battery Test",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "c1a9925591b564a7",
        "type": "tab",
        "label": "Strategy Self-consumption",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "9c775009242a5a6b",
        "type": "tab",
        "label": "Strategy Full stop ",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "68f2a63283f405e0",
        "type": "tab",
        "label": "Close-in optimize",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "a5fa1fcc1b306096",
        "type": "tab",
        "label": "HBC configuration UI",
        "disabled": true,
        "info": "",
        "env": []
    },
    {
        "id": "9607d149c944acaa",
        "type": "tab",
        "label": "Home Battery PID presets",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "d0dfbedc3d5c0181",
        "type": "tab",
        "label": "Super Strategy",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "0199f18df097aa8f",
        "type": "tab",
        "label": "Strategy Timed",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "517b5f5313a242c5",
        "type": "tab",
        "label": "Strategy Charge",
        "disabled": false,
        "info": "Charges batteries to desired energy level\r\nregardless of available PV/Grid power mix.",
        "env": []
    },
    {
        "id": "95489b12daee74f5",
        "type": "tab",
        "label": "Strategy Dynamic",
        "disabled": false,
        "info": "Dynamic contract automated management",
        "env": []
    },
    {
        "id": "676ceac4c521834d",
        "type": "tab",
        "label": "Strategy Charge PV",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "fc3b0636793881be",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "Start",
        "style": {
            "label": true
        },
        "nodes": [
            "1d0932b9cdfe2cc0",
            "057b9222c17d4046",
            "b5940f2c8939de70"
        ],
        "x": 34,
        "y": 19,
        "w": 652,
        "h": 82
    },
    {
        "id": "4776ad4f0339c6ae",
        "type": "group",
        "z": "0a25621f3d1c985f",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "7ec432c49bd7aad2",
            "6c10fd50e5e23c5c",
            "807fecff3dd1e9d7",
            "c32afffb5ac57d79",
            "5caaf9fa7ecd954b"
        ],
        "x": 54,
        "y": 159,
        "w": 692,
        "h": 142
    },
    {
        "id": "fe54093811b6a7fe",
        "type": "group",
        "z": "0a25621f3d1c985f",
        "name": "Hit \"Do a test\" to perform a test",
        "style": {
            "label": true
        },
        "nodes": [
            "ac7f5f881b0f026f",
            "869beb2c2332637b",
            "16e609e6f5bfaff8"
        ],
        "x": 54,
        "y": 59,
        "w": 732,
        "h": 82
    },
    {
        "id": "d94668c8ae9cf8a1",
        "type": "group",
        "z": "0a25621f3d1c985f",
        "name": "Set state",
        "style": {
            "label": true
        },
        "nodes": [
            "931cccdaaeafbd38",
            "f0629b49c28c5864",
            "5cfda233ce27dc73",
            "f4e777264f65f640"
        ],
        "x": 54,
        "y": 319,
        "w": 412,
        "h": 162
    },
    {
        "id": "d6af2a36d0dfdda5",
        "type": "group",
        "z": "0a25621f3d1c985f",
        "name": "Set power",
        "style": {
            "label": true
        },
        "nodes": [
            "bc9e96111f996807",
            "275647d6fa79f142",
            "26629155a2d9c3ba",
            "8cd5b26ec5d86f60"
        ],
        "x": 474,
        "y": 319,
        "w": 412,
        "h": 162
    },
    {
        "id": "a5b8a03b1e2f2371",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "Strategy selection",
        "style": {
            "label": true
        },
        "nodes": [
            "e63433bdfbdd57e9",
            "06dd855a34065b5d",
            "d1bd5fbe28bdd070",
            "b658a34d31bcd8f3",
            "712cd7b2343eead6",
            "7f303dfb944dfc04",
            "b0cd2895e3545c27"
        ],
        "x": 34,
        "y": 719,
        "w": 812,
        "h": 162
    },
    {
        "id": "0bd042d837a592d2",
        "type": "group",
        "z": "9c775009242a5a6b",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "26460a293ad3466a",
            "fd021c46fa86cb98"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "cd31f39c38ae6c21",
        "type": "group",
        "z": "9c775009242a5a6b",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "c1e3cac395f0b1cb",
            "5b9d0683cbf0cf39"
        ],
        "x": 464,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "e2c385d3b03e57bc",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Strategy start",
        "style": {
            "fill": "#ffffff",
            "label": true
        },
        "nodes": [
            "7a0cd93e9df76c48",
            "a56daa760b9feeb1",
            "c0cde540d8bc752b"
        ],
        "x": 54,
        "y": 79,
        "w": 212,
        "h": 162
    },
    {
        "id": "419f0c8ca2d0601a",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Battery solutions",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "67116260f2e09362",
            "999fa888c5e5e56b",
            "fb0eeeb7ddf70b28"
        ],
        "x": 64,
        "y": 1139,
        "w": 202,
        "h": 142
    },
    {
        "id": "3be8354628cecb12",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Bumpless operation",
        "style": {
            "label": true,
            "stroke": "#bfdbef"
        },
        "nodes": [
            "2b06415ad41aae3a",
            "957baac6682de3d3",
            "40290752a7c02655",
            "6273b550e193d38b"
        ],
        "x": 1614,
        "y": 159,
        "w": 252,
        "h": 242
    },
    {
        "id": "94b7ae0409093e17",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Bumpless operation - switching control modes",
        "style": {
            "stroke": "#bfdbef",
            "label": true
        },
        "nodes": [
            "787d4a4302cc3783",
            "58b3c35be6a1ea9c",
            "5a05ae43285d5398",
            "eca69e12794c1c0b",
            "f5e5091687ccc093",
            "cfc64f84a4532120",
            "8a50bc3d63d7a248",
            "a414c1013e9b72aa",
            "9f357837ab8c534f",
            "fae5e93e1a95d5ed",
            "0d36f7d78102ff6d",
            "8439426a432c3f9c"
        ],
        "x": 1614,
        "y": 419,
        "w": 592,
        "h": 289.5
    },
    {
        "id": "7ab490ceca7cff35",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Load distribution debug option",
        "style": {
            "label": true
        },
        "nodes": [
            "7ca8801a84b11ae8",
            "95f5050249137fbc",
            "6a1707cb3cef46f2"
        ],
        "x": 1614,
        "y": 19,
        "w": 452,
        "h": 122
    },
    {
        "id": "81135409fdd98a36",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Inputs",
        "style": {
            "fill": "#7fb7df",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "d3eeef5879f195b1",
            "54cf41d4c27eeebe"
        ],
        "x": 288,
        "y": 13,
        "w": 904,
        "h": 234
    },
    {
        "id": "83d2c9113c9411c2",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Pre processing",
        "style": {
            "fill": "#bfdbef",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "086689c5c8bba4b6",
            "991409971787deec",
            "1fadb46f18a01ebe"
        ],
        "x": 288,
        "y": 273,
        "w": 1104,
        "h": 294
    },
    {
        "id": "2884d4b5e34912da",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Control",
        "style": {
            "fill": "#7fb7df",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "21c8ea25ac313948",
            "7242528b056e3c47"
        ],
        "x": 288,
        "y": 593,
        "w": 924,
        "h": 654
    },
    {
        "id": "937c3952d6bb2e19",
        "type": "group",
        "z": "a5fa1fcc1b306096",
        "name": "Field types",
        "style": {
            "label": true
        },
        "nodes": [
            "58d6c7b724b10666",
            "e740f315724f3d1a",
            "e60f983d4392917d",
            "9d500a3c6b154999"
        ],
        "x": 494,
        "y": 63,
        "w": 172,
        "h": 658,
        "info": "Allow users to easily find the right sensors/selects/etc."
    },
    {
        "id": "9873daf982c701e7",
        "type": "group",
        "z": "a5fa1fcc1b306096",
        "name": "Test readout",
        "style": {
            "label": true
        },
        "nodes": [
            "c04872de572310e0",
            "f8b1b99ed5b34b59",
            "7bc1318c6e070317",
            "7a4b7e517f4cf506",
            "c223121624220b75"
        ],
        "x": 194,
        "y": 939,
        "w": 812,
        "h": 162
    },
    {
        "id": "0d03e2a33f3a64b3",
        "type": "group",
        "z": "a5fa1fcc1b306096",
        "name": "HA fields (read)",
        "style": {
            "label": true
        },
        "nodes": [
            "64d24e6545b1f86f",
            "3805ea99193c192c",
            "79aede9e29152eb5",
            "967320583833cbad",
            "1cb5651fd3cd98f7",
            "a71c7d4cd9e9ecb6",
            "1a684759a42f72ef",
            "c0114cdc7b15fba9",
            "9a53b5725a7ae343",
            "15d0a55aad6896dc",
            "892e1829e04b12de",
            "a0c32b752bed188a",
            "521c90d39990183f",
            "11b529145ce5d713",
            "45e6ad9cded99ea2"
        ],
        "x": 684,
        "y": 63,
        "w": 104,
        "h": 798
    },
    {
        "id": "795071f84cc65671",
        "type": "group",
        "z": "a5fa1fcc1b306096",
        "name": "NR dashboard ",
        "style": {
            "label": true
        },
        "nodes": [
            "c659d02c18f850a9",
            "028a4c9c51e7eccd",
            "aa7fa18db5e480cc",
            "7df02adfcd4128ea",
            "a755b33f1730e891",
            "14124387949b0fee",
            "7867622927f0d077",
            "ebb77d5a4bb73b23",
            "b39feae3a058ace5",
            "1f8079b3d993b6ff",
            "3c2735a64344066e",
            "77426ad1f331d3f8",
            "af5a6883b065a9fc",
            "4d3e69a2b3b4e1bd",
            "8d2077410a644d6e"
        ],
        "x": 854,
        "y": 63,
        "w": 352,
        "h": 798
    },
    {
        "id": "e9025250f91b9eb0",
        "type": "group",
        "z": "a5fa1fcc1b306096",
        "name": "Store NR into HA fields on change",
        "style": {
            "label": true
        },
        "nodes": [
            "3323e8b0f6c0ee75",
            "edf81a129949f7af",
            "c2f36f14e0eb1058"
        ],
        "x": 1234,
        "y": 59,
        "w": 512,
        "h": 266
    },
    {
        "id": "23508a0784b7a764",
        "type": "group",
        "z": "0a25621f3d1c985f",
        "name": "Battery setting looper",
        "style": {
            "label": true
        },
        "nodes": [
            "952dcb76faf9377b",
            "d37894c2b1e074da",
            "e2c98a4a11d3119b",
            "7d491da9cff1228d",
            "ed583566b7d2e5a5",
            "1de0ea92dde0cb92",
            "32c18b304ab18eef",
            "40b65d5d85625cf3",
            "b6036af3515b400f",
            "ef5d062ab8c5730b",
            "317a70d47e45df87",
            "544d7fe378e8f4f1",
            "b1a0880f8fb62bf2",
            "10e04cfa04d1fb5f",
            "3cb20d31ca53816b"
        ],
        "x": 54,
        "y": 499,
        "w": 792,
        "h": 342
    },
    {
        "id": "6fad59f7a8530963",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "Get batteries information",
        "style": {
            "label": true
        },
        "nodes": [
            "dbe474c91266b428",
            "7d6705c1829e0683",
            "1933f2623fa0fffb",
            "ceb31920f185d64b",
            "b63f2e905b829e5b",
            "64a533741de02153",
            "bbe037f4bc3425fc",
            "023bfc9b8ac21db1"
        ],
        "x": 28,
        "y": 259,
        "w": 1664,
        "h": 242
    },
    {
        "id": "ea78c084bba20424",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "On deploy",
        "style": {
            "label": true
        },
        "nodes": [
            "ad80dc99baec6552",
            "42d70237afb8b3a7"
        ],
        "x": 734,
        "y": 19,
        "w": 432,
        "h": 82
    },
    {
        "id": "5778369e644d84d7",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "Set Batteries",
        "style": {
            "label": true
        },
        "nodes": [
            "95295516124d818d",
            "4d6fd96944872ba1",
            "15830b9747f8132e",
            "d77f3b233b9d9a45",
            "8b0aa863bb6493fd",
            "77163ca9f43e8fb7"
        ],
        "x": 34,
        "y": 899,
        "w": 838,
        "h": 342
    },
    {
        "id": "0a3ea32230e8832c",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "Battery priority",
        "style": {
            "label": true
        },
        "nodes": [
            "db8e14c359673211",
            "b98d8b6d56dc5e39",
            "9f9dd1b6c8a68339",
            "1cc51c4bd0523e93",
            "1c419030271bee64",
            "c9b6b8b729161188",
            "64c9954af597093d",
            "1dac3194a67aeec2",
            "641cc1cf21ace75a"
        ],
        "x": 34,
        "y": 619,
        "w": 1852,
        "h": 82
    },
    {
        "id": "99dab2f005d99056",
        "type": "group",
        "z": "0a25621f3d1c985f",
        "name": "Generic action node",
        "style": {
            "label": true
        },
        "nodes": [
            "721c6c9f8abb8939",
            "85e53fe14fe8c336",
            "53bdff08247dc43b"
        ],
        "x": 874,
        "y": 499,
        "w": 572,
        "h": 82
    },
    {
        "id": "137e6287c81f0267",
        "type": "group",
        "z": "0a25621f3d1c985f",
        "name": "Battery reordering",
        "style": {
            "label": true
        },
        "nodes": [
            "6b3e5f2f22e3df05",
            "61aeb6b570e5d0f6",
            "149a6d03c4420699"
        ],
        "x": 54,
        "y": 859,
        "w": 512,
        "h": 82
    },
    {
        "id": "e0392b58deafbac5",
        "type": "group",
        "z": "9607d149c944acaa",
        "name": "PID presets",
        "style": {
            "label": true
        },
        "nodes": [
            "31c856d793e13a5a",
            "25cba6b981ba48e9",
            "6fb5deee8886bb3e",
            "60b793ebc78a6296",
            "3276d3d01db332b2",
            "19c8fac4c2f92720",
            "a50096cebdd74d31"
        ],
        "x": 34,
        "y": 19,
        "w": 632,
        "h": 242
    },
    {
        "id": "c1e44a160c59f1a9",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "0be9d3b9ef3576fd"
        ],
        "x": 34,
        "y": 519,
        "w": 212,
        "h": 82
    },
    {
        "id": "0ebd537b21479320",
        "type": "group",
        "z": "d0dfbedc3d5c0181",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "f96598748a8bae33",
            "0a1e9d8398df4f95"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "7b06827dfd179ecf",
        "type": "group",
        "z": "d0dfbedc3d5c0181",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "3911c0977b5b0e4d",
            "f03f0f67c20f201e"
        ],
        "x": 944,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "5b3831da1b35bb1d",
        "type": "group",
        "z": "acde727d4cb42aaa",
        "name": "Marstek master control switch",
        "style": {
            "label": true
        },
        "nodes": [
            "b9f84cc9f5a92c37",
            "db8935b06e0974bc",
            "ce0d5547e473555e",
            "64dc39c70599dfc4",
            "8b5ef482f35ef9c0"
        ],
        "x": 34,
        "y": 19,
        "w": 898,
        "h": 382
    },
    {
        "id": "7d5d20208cad641e",
        "type": "group",
        "z": "0199f18df097aa8f",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "9ce9ba35eda99c46",
            "f0ecfb0d25bf1e0f"
        ],
        "x": 24,
        "y": 739,
        "w": 192,
        "h": 142
    },
    {
        "id": "130c2473c32bd786",
        "type": "group",
        "z": "0199f18df097aa8f",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "e2fbefe0a92c8b87",
            "df3ea4464fdd6253"
        ],
        "x": 24,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "bf29fe0ee25b592b",
        "type": "group",
        "z": "0199f18df097aa8f",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "942bbcc0b79ffec6",
            "84cab4abb90d1f7a",
            "dfa151f727d68ad2"
        ],
        "x": 454,
        "y": 79,
        "w": 532,
        "h": 82
    },
    {
        "id": "f9db7587adf69bfa",
        "type": "group",
        "z": "0199f18df097aa8f",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "97a70bb440ca8984",
            "d82f98b7e93d3eac",
            "78f0fd728bec341e",
            "cb3cb1afa5ceda3d"
        ],
        "x": 254,
        "y": 179,
        "w": 732,
        "h": 82
    },
    {
        "id": "115c88f19a6e3add",
        "type": "group",
        "z": "0199f18df097aa8f",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "c669dabc5fa09ae2"
        ],
        "x": 254,
        "y": 79,
        "w": 192,
        "h": 82
    },
    {
        "id": "263441dd7d34de1c",
        "type": "group",
        "z": "0199f18df097aa8f",
        "name": "Determine sub-strategy based on time period",
        "style": {
            "label": true
        },
        "nodes": [
            "8eaa8fd948be1fad",
            "8de067121fbfd939",
            "3108d0a11fcf542f",
            "7bc56c05b65b8a56",
            "9353d27b9ba49389",
            "3c647acc433c766d",
            "3919eb10fa97d04d",
            "98697d12039611bf",
            "c7b14890ae2578d1",
            "83a1051adc959e8c",
            "30c98e7546f78b88",
            "0cde47a17becc07d",
            "5518e5a61cfe69c6",
            "7775e04676756c1e",
            "cd148224059fdaae",
            "319d772dc1a3f413",
            "7d3b97b9302eaf46",
            "8a7f41b1448ba249",
            "1ac5564bbb7c6d7f",
            "273d6cb45a191bcc",
            "90f20fce6d8576ce"
        ],
        "x": 254,
        "y": 379,
        "w": 692,
        "h": 402
    },
    {
        "id": "1df1a3a3dcbc7925",
        "type": "group",
        "z": "517b5f5313a242c5",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "62fe191e903de8b2",
            "3c519efd38a22bf5"
        ],
        "x": 34,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "843e88284fbc94bf",
        "type": "group",
        "z": "517b5f5313a242c5",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "b5bd859bd4a37c5a",
            "9e4f8a5401e67f74"
        ],
        "x": 34,
        "y": 339,
        "w": 192,
        "h": 142
    },
    {
        "id": "9e0b88ccf18279a0",
        "type": "group",
        "z": "517b5f5313a242c5",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "975b518a9af0ba5e",
            "17407e109402eedb",
            "8f45bbf25d832781"
        ],
        "x": 254,
        "y": 119,
        "w": 752,
        "h": 82
    },
    {
        "id": "38d625c4fd161b7b",
        "type": "group",
        "z": "517b5f5313a242c5",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "6f08540f9f5fe765",
            "59946b67fc40e542",
            "ded0c5838fefe02a",
            "55e38b7af412c9b6",
            "9e65fbe7fb9407f5",
            "5e0b433df0b89085",
            "e0daa87d53914f89",
            "8f3f500f37b1f30a",
            "11a3c17551b6872e",
            "558a963fa8d37e13",
            "c62978a7d936dfba"
        ],
        "x": 254,
        "y": 219,
        "w": 1152,
        "h": 162
    },
    {
        "id": "69b5b1e8def42772",
        "type": "group",
        "z": "517b5f5313a242c5",
        "name": "UI helper | set bounds for charge levels",
        "style": {
            "label": true
        },
        "nodes": [
            "51c020c73fa6193c",
            "5145f9dafdea029b",
            "a46cfe2ab1e217ad"
        ],
        "x": 254,
        "y": 19,
        "w": 672,
        "h": 82
    },
    {
        "id": "a9c604eb640d5087",
        "type": "group",
        "z": "0a25621f3d1c985f",
        "name": "Cheapest hour integration",
        "style": {
            "label": true
        },
        "nodes": [
            "1b87bb9331aa7957",
            "03999a11700893e1",
            "06742153914f176c",
            "77a60a41e79103b6",
            "bc3b82ace59b9797",
            "0ff3238209d01e07",
            "b43975f0bd7d3bcc",
            "1c53d1727770d10f",
            "dd12fb024f91a46c",
            "d21932c2d5c60e3c",
            "6904fb44493109bc",
            "a79347dc7b41ced3"
        ],
        "x": 54,
        "y": 979,
        "w": 1032,
        "h": 222
    },
    {
        "id": "ff30c86c22bf31c8",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "45ca4e9b170ae0e4",
            "c855da432b5a589a"
        ],
        "x": 14,
        "y": 239,
        "w": 192,
        "h": 142
    },
    {
        "id": "ee5f9b06bf7efa46",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "Home battery start",
        "style": {
            "label": true
        },
        "nodes": [
            "2c4ec860ab1a8f79",
            "471fda4979e7fc76"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "9889d591bcc38e89",
        "type": "group",
        "z": "676ceac4c521834d",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "87be4b85f89829b6",
            "d62d870eb44d3582"
        ],
        "x": 624,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "72059e541379a869",
        "type": "group",
        "z": "676ceac4c521834d",
        "name": "Start",
        "style": {
            "label": true
        },
        "nodes": [
            "a5e9e484430e1720",
            "bf548077ba6ca350"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "635af4e3e7a252ce",
        "type": "group",
        "z": "0199f18df097aa8f",
        "name": "Execute sub-strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "31b352bcf0b5fa22",
            "1ff8dd8a7bb8c098",
            "4a78e8501fe52d32",
            "08145a57bee1f1d9",
            "e3ff5478297e2295"
        ],
        "x": 994,
        "y": 579,
        "w": 692,
        "h": 202
    },
    {
        "id": "e0ed6822bd47bca9",
        "type": "group",
        "z": "0199f18df097aa8f",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "568d79926c754129",
            "c5ad0abaf680c75b",
            "7d02914f2aaf8cda",
            "83e9ba4b673403f7"
        ],
        "x": 254,
        "y": 279,
        "w": 732,
        "h": 82
    },
    {
        "id": "9c68fafd28d3b4fc",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "Set dynamic strategy on",
        "style": {
            "label": true
        },
        "nodes": [
            "adbbd358b213f08e",
            "2e5b6b44c86f80e3",
            "0799b280bf62758e",
            "5cb60087e09c8852",
            "34a30e529baf678b",
            "1908addf7c5bfb93",
            "89368e429aa3d7d0",
            "e83d728f6cf5d437",
            "dc266592c79676c7",
            "ea704e53eb20315f",
            "c0fe420fa716d4ca",
            "1990213302cf1876",
            "98d7f59f0b7eab92",
            "de24e0e941d08b62",
            "5534a44cf66a84bd",
            "1d49e10959ab22bc",
            "3d76aa4d40d9ede2",
            "127bc4a04263b3c0",
            "7f75e4fa1c2d86a0",
            "f5f223200fbada06",
            "fedfd15cd6cddaed",
            "f65eeae181ccbc8a",
            "af541182589224a7",
            "da4428dd14db9967",
            "cba4fb540a66e4e6",
            "03f47a2f3212cb6b",
            "b97bd9a51080da68",
            "1247084c53315208",
            "4b8c5bc2b8cf6c4d",
            "6e287097dc4e0236",
            "403a9dfa33392328",
            "67e38494d0337403",
            "f1168e015522bbfc",
            "141ebe1a0441a814"
        ],
        "x": 234,
        "y": 299,
        "w": 1492,
        "h": 702
    },
    {
        "id": "70d1049fc896f1cd",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "Execute",
        "style": {
            "label": true
        },
        "nodes": [
            "ec06caa7c9e6a95d",
            "31e4a5e372bcb73f",
            "8cddc8961385f28e",
            "81b460c063969182",
            "e5f74756a260df5b",
            "2b50d9094cb8a9a8"
        ],
        "x": 234,
        "y": 119,
        "w": 572,
        "h": 122
    },
    {
        "id": "c6507e8b14c27c81",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "Test area",
        "style": {
            "label": true
        },
        "nodes": [
            "92e35d100ca61070",
            "6e2f9d4be7e18c3a",
            "30af788462a325c7",
            "d05798a95b8cf195",
            "04d57a78a2fc3095",
            "320df01bc7436680",
            "d8004c43e9b3d8d0",
            "99545071b9bdfd66"
        ],
        "x": 234,
        "y": 1019,
        "w": 912,
        "h": 162
    },
    {
        "id": "1237795be79af24c",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "All data",
        "style": {
            "label": true
        },
        "nodes": [
            "1f3454b85f32ab4c",
            "338407c8c442244c",
            "3f94e4f380add2e8",
            "079e2531ed154c01"
        ],
        "x": 234,
        "y": 1659,
        "w": 572,
        "h": 82
    },
    {
        "id": "149d3bed7854fec1",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "Rate limiter",
        "style": {
            "label": true
        },
        "nodes": [
            "e2a3a19c3da30059",
            "8ddd86470cf105f4",
            "660d380dfd258f53",
            "563c57a7746c3a96",
            "898cc8a1b89a0f72",
            "ca528d9c66c9f8d6"
        ],
        "x": 34,
        "y": 119,
        "w": 1032,
        "h": 122
    },
    {
        "id": "50913cc784b36803",
        "type": "group",
        "z": "517b5f5313a242c5",
        "name": "Update UI - active sub-strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "9421868a18b49122",
            "4be8af1b84064f71",
            "639f30448513315c",
            "db167c26a387f791",
            "be7ea7d80408d0b2"
        ],
        "x": 254,
        "y": 439,
        "w": 992,
        "h": 82
    },
    {
        "id": "a982ce2192b36fd5",
        "type": "group",
        "z": "676ceac4c521834d",
        "name": "Update UI: active sub-strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "ce6bb883d5b1f007",
            "33fd9ce7833604ba",
            "bba58df78152ef59",
            "32caf8e345be7b6e",
            "0d8f2f25053a7fdf",
            "28c212820d1b1899"
        ],
        "x": 614,
        "y": 319,
        "w": 552,
        "h": 142
    },
    {
        "id": "28a2ae1ba720d063",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "Update UI: active sub strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "16efd2b03d6dece5",
            "87e5752435e0ca42",
            "600f70a08a900d1c"
        ],
        "x": 834,
        "y": 139,
        "w": 692,
        "h": 82
    },
    {
        "id": "d3eeef5879f195b1",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "81135409fdd98a36",
        "name": "PID control inputs",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "8baa774c2b027a30",
            "5aa64580ae12f4b2",
            "409b51e049035eb9",
            "526cad5fede1f966",
            "de5eedecc97994b4",
            "8591421549956ee1",
            "f6b196faaa1eff2f",
            "6286320aa2c67f78",
            "2244ab645dede1ed"
        ],
        "x": 314,
        "y": 59,
        "w": 572,
        "h": 162
    },
    {
        "id": "54cf41d4c27eeebe",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "81135409fdd98a36",
        "name": "Advanced features",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "7e1e11d0eb34edae",
            "dde5b40cb7fe1ff8",
            "597ae0e8b54ce90b"
        ],
        "x": 914,
        "y": 39,
        "w": 252,
        "h": 182
    },
    {
        "id": "086689c5c8bba4b6",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "83d2c9113c9411c2",
        "name": "",
        "style": {
            "fill": "#ffffff",
            "label": true
        },
        "nodes": [
            "8b9359ba6370a958",
            "affa3d29d06490e4",
            "d87e5fb7584a366b",
            "d8cf3fee789fa491"
        ],
        "x": 314,
        "y": 299,
        "w": 292,
        "h": 202
    },
    {
        "id": "991409971787deec",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "83d2c9113c9411c2",
        "name": "Derivative - incl. bumpless operation",
        "style": {
            "label": true,
            "stroke": "#a4a4a4",
            "fill": "#ffffff"
        },
        "nodes": [
            "de3671b9c7503ce3",
            "d2868e3da06e78d5",
            "6f0b3716cc693cd6",
            "e8409a2a051286bf",
            "5b44917d48154dea"
        ],
        "x": 614,
        "y": 399,
        "w": 752,
        "h": 142
    },
    {
        "id": "1fadb46f18a01ebe",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "83d2c9113c9411c2",
        "name": "Processing required? ",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "9b70f054ec8bbbb1",
            "735046e00914a975",
            "7636353795317949"
        ],
        "x": 614,
        "y": 299,
        "w": 562,
        "h": 82
    },
    {
        "id": "21c8ea25ac313948",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "2884d4b5e34912da",
        "name": "PID controller",
        "style": {
            "label": true,
            "fill": "#ffffff",
            "color": "#3f3f3f"
        },
        "nodes": [
            "028f43a44d1bec69",
            "53039b668ab0a97e",
            "235494cc1d2a6b97",
            "5c62450063520ee9",
            "d6e0a13720d2ceb3",
            "9f823db632bbd13f",
            "ea8b44a09b499968",
            "d739d29aebbdb0e0",
            "bc8a24344b2ae2ca",
            "a79b2b6c56ce7751",
            "4854534dc7c83892",
            "7cdef29145623758",
            "4cafd473afb89158",
            "cbc863ac4c6ce1b8",
            "cfa0372c07314b8d",
            "e52abd366fd81c67",
            "0c60f5ca1f25e34b",
            "59bee8c6b6be159f",
            "526d83d6881fd8ce",
            "129ec2777a861d77"
        ],
        "x": 314,
        "y": 619,
        "w": 872,
        "h": 482
    },
    {
        "id": "7242528b056e3c47",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "2884d4b5e34912da",
        "name": "Distribution",
        "style": {
            "label": true,
            "fill": "#ffffff",
            "color": "#3f3f3f"
        },
        "nodes": [
            "2ef3fc5bd6a33686",
            "3640364ae79b69ec"
        ],
        "x": 314,
        "y": 1119,
        "w": 452,
        "h": 102
    },
    {
        "id": "b63f2e905b829e5b",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "a91127871ba39241",
            "325f396f7e8ad2a8",
            "d01fc0ee854e249a",
            "f384e6c0da2834c8",
            "08d4efea54467ac1",
            "7831dd84510fdfaa",
            "4e53830356f33b07",
            "208060fed37273fc",
            "f3e427d4451be530",
            "a882514e64e6f538"
        ],
        "x": 54,
        "y": 339,
        "w": 1612,
        "h": 82
    },
    {
        "id": "d77f3b233b9d9a45",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "g": "5778369e644d84d7",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "e1927196c4198cbf",
            "047542bb597a3048",
            "df4b99688f85df0a",
            "e25994f6e85e901c",
            "4decf8d91d6ccacb",
            "084ac27446297f16",
            "1e4f762143a12bba"
        ],
        "x": 294,
        "y": 939,
        "w": 552,
        "h": 222
    },
    {
        "id": "8b5ef482f35ef9c0",
        "type": "group",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "964d538dd74d6c05",
            "0a5e50316b0d2b70",
            "9875fb4be6ce951f",
            "3141628fc4063a26",
            "9f47be1a4b1c355b",
            "06cec7476db26e79"
        ],
        "x": 414,
        "y": 99,
        "w": 492,
        "h": 222
    },
    {
        "id": "74fd3ebe5074968f",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Update UI - active sub-strategy, when self-consumption is the user's chosen strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "9b57c772140e180c",
            "2097b7751515ee67",
            "e15313e16be26caf",
            "a05a0479326a6694",
            "f4fb55acf071af78",
            "e3e8e650d75e615e"
        ],
        "x": 1604,
        "y": 739,
        "w": 1062,
        "h": 82
    },
    {
        "id": "36d3d713969b2832",
        "type": "group",
        "z": "9c775009242a5a6b",
        "name": "Update UI - active sub-strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "c23de8e8ab568b52",
            "f322b34904d4944b",
            "72ce79bf6a03a3d6",
            "b890d6c270915ce5",
            "3363b72314098044"
        ],
        "x": 474,
        "y": 259,
        "w": 1012,
        "h": 82
    },
    {
        "id": "8591421549956ee1",
        "type": "junction",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "x": 460,
        "y": 100,
        "wires": [
            [
                "6286320aa2c67f78"
            ]
        ]
    },
    {
        "id": "25349ae9d88ba324",
        "type": "junction",
        "z": "517b5f5313a242c5",
        "x": 1220,
        "y": 400,
        "wires": [
            [
                "b5bd859bd4a37c5a",
                "4be8af1b84064f71"
            ]
        ]
    },
    {
        "id": "6286320aa2c67f78",
        "type": "junction",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "x": 700,
        "y": 100,
        "wires": [
            [
                "f6b196faaa1eff2f",
                "2244ab645dede1ed"
            ]
        ]
    },
    {
        "id": "2244ab645dede1ed",
        "type": "junction",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "x": 720,
        "y": 120,
        "wires": [
            [
                "5aa64580ae12f4b2"
            ]
        ]
    },
    {
        "id": "b97bd9a51080da68",
        "type": "junction",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "x": 600,
        "y": 340,
        "wires": [
            [
                "127bc4a04263b3c0"
            ]
        ]
    },
    {
        "id": "2b50d9094cb8a9a8",
        "type": "junction",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "x": 600,
        "y": 180,
        "wires": [
            [
                "31e4a5e372bcb73f",
                "8cddc8961385f28e",
                "87e5752435e0ca42"
            ]
        ]
    },
    {
        "id": "176d29a.6f648d6",
        "type": "server",
        "name": "Home Assistant",
        "addon": true,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "",
        "connectionDelay": false,
        "cacheJson": false,
        "heartbeat": false,
        "heartbeatInterval": "",
        "statusSeparator": "",
        "enableGlobalContextStore": false
    },
    {
        "id": "9d24f764bb2240b1",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.3",
            "node-red-dashboard": "3.6.6",
            "node-red-node-smooth": "0.1.2",
            "node-red-contrib-time-range-switch": "1.2.0"
        }
    },
    {
        "id": "70c03d3c8fdd552a",
        "type": "ui_base",
        "theme": {
            "name": "theme-light",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
            },
            "themeState": {
                "base-color": {
                    "default": "#0094CE",
                    "value": "#0094CE",
                    "edited": false
                },
                "page-titlebar-backgroundColor": {
                    "value": "#0094CE",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#fafafa",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#1bbfff",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#111111",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#0094ce",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "base-font": {
                    "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
                }
            },
            "angularTheme": {
                "primary": "indigo",
                "accents": "blue",
                "warn": "red",
                "background": "grey",
                "palette": "light"
            }
        },
        "site": {
            "name": "Node-RED Dashboard",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "lockMenu": "false",
            "allowTempTheme": "true",
            "dateFormat": "DD/MM/YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "a6add08339130589",
        "type": "ui_tab",
        "name": "Home",
        "icon": "dashboard",
        "disabled": false,
        "hidden": false
    },
    {
        "id": "dc57595d461379a1",
        "type": "ui_group",
        "name": "Battery 1",
        "tab": "a6add08339130589",
        "order": 2,
        "disp": true,
        "width": "12",
        "collapse": true,
        "className": ""
    },
    {
        "id": "54991681ca09e29d",
        "type": "ui_group",
        "name": "Battery 2",
        "tab": "a6add08339130589",
        "order": 3,
        "disp": true,
        "width": "12",
        "collapse": false,
        "className": ""
    },
    {
        "id": "ab91aa3e54c948ec",
        "type": "ui_group",
        "name": "Battery 3",
        "tab": "a6add08339130589",
        "order": 4,
        "disp": true,
        "width": "12",
        "collapse": true,
        "className": ""
    },
    {
        "id": "9bfeb0b645386875",
        "type": "ui_group",
        "name": "Grid",
        "tab": "a6add08339130589",
        "order": 1,
        "disp": true,
        "width": "12",
        "collapse": false,
        "className": ""
    },
    {
        "id": "1d0932b9cdfe2cc0",
        "type": "server-state-changed",
        "z": "a099d47fc07b3cee",
        "g": "fc3b0636793881be",
        "name": "P1 meter",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.p1_meter_power"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": false,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "grid_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "timestamp",
                "propertyType": "msg",
                "value": "",
                "valueType": "date"
            }
        ],
        "x": 120,
        "y": 60,
        "wires": [
            [
                "057b9222c17d4046"
            ]
        ]
    },
    {
        "id": "057b9222c17d4046",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "fc3b0636793881be",
        "name": "Master Control Mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.marstek_master_battery_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "master_mode",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 300,
        "y": 60,
        "wires": [
            [
                "b5940f2c8939de70"
            ]
        ]
    },
    {
        "id": "b5940f2c8939de70",
        "type": "switch",
        "z": "a099d47fc07b3cee",
        "g": "fc3b0636793881be",
        "name": "when in \"Full Control\" mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 540,
        "y": 60,
        "wires": [
            [
                "898cc8a1b89a0f72"
            ]
        ]
    },
    {
        "id": "e63433bdfbdd57e9",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Battery Strategy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy",
                "propertyType": "flow",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 140,
        "y": 760,
        "wires": [
            [
                "b0cd2895e3545c27"
            ]
        ]
    },
    {
        "id": "06dd855a34065b5d",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Strategy selection",
        "func": "// INFLOW\nlet strategy = flow.get(\"house_battery_strategy\");\n\n// stop on error\nif(msg.batteries === undefined) {\n    node.error(\"Battery configuration undefined\", msg);\n    return null;\n}\nif(strategy === undefined) {\n    node.error(\"Battery strategy undefined\", msg);\n    return null;\n}\n\n// select target flow based on the input_select `house_battery_strategy`\nmsg.target = `${strategy}`;\n\n// full stop trigger overrules ALL selected strategies\nconst stopTrigger = RED.util.getMessageProperty(msg,\"full_stop_trigger\");\nif(stopTrigger == \"on\" || stopTrigger === true) {\n    msg.target = 'Full stop';\n}\n\n// add execution marker\nRED.util.setMessageProperty(msg,\"strategy.execution_start\",Date.now()); // when do we start executing the selected strategy\n\n// OUTPUT\nnode.status({fill:\"grey\",shape:\"dot\",text:msg.target});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 760,
        "wires": [
            [
                "b658a34d31bcd8f3",
                "d1bd5fbe28bdd070"
            ]
        ]
    },
    {
        "id": "d1bd5fbe28bdd070",
        "type": "link call",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Call \"Link in\" node",
        "links": [],
        "linkType": "dynamic",
        "timeout": "1.2",
        "x": 410,
        "y": 800,
        "wires": [
            [
                "712cd7b2343eead6",
                "7f303dfb944dfc04"
            ]
        ]
    },
    {
        "id": "b658a34d31bcd8f3",
        "type": "debug",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Input parameters",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 760,
        "wires": []
    },
    {
        "id": "712cd7b2343eead6",
        "type": "debug",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Returned solutions",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 800,
        "wires": []
    },
    {
        "id": "7f303dfb944dfc04",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Strategy evaluation",
        "func": "// add execution marker\nlet execution_end = Date.now();\nRED.util.setMessageProperty(msg, \"strategy.execution_end\", execution_end);\n\n// retrieve execution markers\nlet execution_start = RED.util.getMessageProperty(msg,\"strategy.execution_start\");\n\n// report execution time\nif (execution_start !== undefined && execution_end !== undefined) {\n    // exec time\n    let execution_time = (execution_end - execution_start) / 1000; // seconds\n    // report\n    if (execution_time <= 0) node.status({ fill: \"red\", shape: \"dot\", text: `negative or zero timing` });\n    if (execution_time > 0) node.status({ fill: \"green\", shape: \"dot\", text: `${execution_time} sec`});\n    if (execution_time >= 0.7) node.status({ fill: \"yellow\", shape: \"dot\", text: `${execution_time} sec` });\n    if (execution_time >= 1) node.status({ fill: \"red\", shape: \"dot\", text: `${execution_time} sec` });\n\n} else {\n    node.status({fill:\"grey\",shape:\"dot\",text:\"timing error\"});\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 840,
        "wires": [
            [
                "15830b9747f8132e"
            ]
        ]
    },
    {
        "id": "dbe474c91266b428",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// Init an array for battery status and value information\nmsg.batteries = [];\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 300,
        "wires": [
            [
                "a91127871ba39241"
            ]
        ]
    },
    {
        "id": "64a533741de02153",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Mapping",
        "func": "// Map to batteries array\nmsg.batteries.push({\n    id: `M${msg.battery_index}`,\n    power: parseInt(msg.battery_power,10),\n    charging_max: parseInt(msg.max_charge_power,10),\n    discharging_max: parseInt(msg.max_discharge_power,10),\n    soc: parseInt(msg.battery_state_of_charge,10),\n    soc_max: parseInt(msg.charging_cutoff_capacity,10),\n    soc_min: parseInt(msg.discharging_cutoff_capacity,10),\n    inverter: String(msg.inverter_state),\n    energy: Number(msg.battery_remaining_capacity),\n    energy_max: Number(msg.battery_total_energy),\n    rs485: String(msg.rs485_control_mode)\n    });\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 460,
        "wires": [
            [
                "bbe037f4bc3425fc"
            ]
        ]
    },
    {
        "id": "7d6705c1829e0683",
        "type": "switch",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 420,
        "y": 460,
        "wires": [
            [
                "a91127871ba39241"
            ],
            [
                "023bfc9b8ac21db1"
            ]
        ]
    },
    {
        "id": "1933f2623fa0fffb",
        "type": "debug",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 770,
        "y": 460,
        "wires": []
    },
    {
        "id": "ceb31920f185d64b",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 300,
        "wires": [
            [
                "dbe474c91266b428"
            ]
        ]
    },
    {
        "id": "a91127871ba39241",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Control mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "select.marstek_m{{battery_index}}_rs485_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "rs485_control_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 160,
        "y": 380,
        "wires": [
            [
                "4e53830356f33b07"
            ]
        ]
    },
    {
        "id": "325f396f7e8ad2a8",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "SoC",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_state_of_charge",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_state_of_charge",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 850,
        "y": 380,
        "wires": [
            [
                "f3e427d4451be530"
            ]
        ]
    },
    {
        "id": "d01fc0ee854e249a",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Inverter state",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_inverter_state",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "inverter_state",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1270,
        "y": 380,
        "wires": [
            [
                "08d4efea54467ac1"
            ]
        ]
    },
    {
        "id": "f384e6c0da2834c8",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Max discharge power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_discharge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_discharge_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 680,
        "y": 380,
        "wires": [
            [
                "325f396f7e8ad2a8"
            ]
        ]
    },
    {
        "id": "08d4efea54467ac1",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Energy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_remaining_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_remaining_capacity",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1420,
        "y": 380,
        "wires": [
            [
                "208060fed37273fc"
            ]
        ]
    },
    {
        "id": "7831dd84510fdfaa",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Max charge power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_charge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_charge_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 470,
        "y": 380,
        "wires": [
            [
                "f384e6c0da2834c8"
            ]
        ]
    },
    {
        "id": "4e53830356f33b07",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_power",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "battery_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 310,
        "y": 380,
        "wires": [
            [
                "7831dd84510fdfaa"
            ]
        ]
    },
    {
        "id": "ad80dc99baec6552",
        "type": "api-call-service",
        "z": "a099d47fc07b3cee",
        "g": "ea78c084bba20424",
        "name": "Node-RED status: ON",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.house_battery_control_has_node_red"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_boolean",
        "service": "turn_on",
        "x": 1040,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "42d70237afb8b3a7",
        "type": "inject",
        "z": "a099d47fc07b3cee",
        "g": "ea78c084bba20424",
        "name": "On deploy",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "2",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 850,
        "y": 60,
        "wires": [
            [
                "ad80dc99baec6552"
            ]
        ]
    },
    {
        "id": "e1927196c4198cbf",
        "type": "api-call-service",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "Set mode (charge/discharge/stop)",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 640,
        "y": 980,
        "wires": [
            []
        ]
    },
    {
        "id": "047542bb597a3048",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "Set Batteries",
        "func": "// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n// Output format and target\nlet outputArray = [];\nlet solution = msg.solutions[msg.battery_index-1]; // Base-0, thus -1\nif(solution === undefined) {\n    node.error(`Can't find solution for index ${msg.battery_index - 1} in ${msg.solutions}, aborting...`);\n    return null;\n}\nlet target = `marstek_${solution.id.toLowerCase()}`;\n\n// Safety | Id exists\nlet battery = msg.batteries.find(battery => battery.id === solution.id);\nif (battery === undefined) {\n    node.error(`Can't set battery ${solution.id}, aborting...`);\n    return null;\n}\n// Safety | Power limit\nsolution.power = Math.min(solution.power, solution.mode == CMODE.CHARGE ? battery.charging_max: battery.discharging_max);\n\n// Set | Mode\nconst serviceCallMode = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_forcible_charge_discharge`]\n    },\n    \"data\": {\n         \"option\": String(solution.mode) // forced charge mode (stop, charge, discharge)\n    }\n};\n// Add topic to allow correct 'on change' filtering\noutputArray.push({payload: serviceCallMode, topic:solution.id});\n\n// Set | Power\nconst serviceCallPower = {\n    \"action\": \"number.set_value\",\n    \"target\": {\n        \"entity_id\": [\n            `number.${target}_forcible_charge_power`,\n            `number.${target}_forcible_discharge_power`\n            ]\n    },\n    \"data\": {\n        \"value\": Number(solution.power)\n    } \n};\n// Add topic to allow correct 'on change' filtering\noutputArray.push({payload: serviceCallPower, topic:solution.id});\n\n// Store service calls in msg to allow checking of loop results\nmsg.loop_result = { target, serviceCallMode, serviceCallPower };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Output\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 1020,
        "wires": [
            [
                "e1927196c4198cbf"
            ],
            [
                "1e4f762143a12bba"
            ],
            [
                "e25994f6e85e901c"
            ]
        ],
        "inputLabels": [
            "Msg with a battery_index"
        ],
        "outputLabels": [
            "Select MODE",
            "Set POWER",
            "Msg"
        ]
    },
    {
        "id": "95295516124d818d",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "5778369e644d84d7",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = msg.battery_count;\n\n// Debug\nRED.util.setMessageProperty(msg, \"debug\", `## Cohort ${Date.now()} ##`);\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 1020,
        "wires": [
            [
                "047542bb597a3048"
            ]
        ]
    },
    {
        "id": "df4b99688f85df0a",
        "type": "switch",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 720,
        "y": 1080,
        "wires": [
            [
                "047542bb597a3048"
            ],
            [
                "8b0aa863bb6493fd"
            ]
        ]
    },
    {
        "id": "e25994f6e85e901c",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index -= 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 1080,
        "wires": [
            [
                "df4b99688f85df0a",
                "084ac27446297f16"
            ]
        ]
    },
    {
        "id": "4decf8d91d6ccacb",
        "type": "api-call-service",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "Set power (W)",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 740,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "4d6fd96944872ba1",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "5778369e644d84d7",
        "name": "timing start",
        "func": "RED.util.setMessageProperty(msg,\"setbatteries.execution_start\",Date.now());\nRED.util.setMessageProperty(msg,\"setbatteries.marker\", `M1_${Date.now()}`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 980,
        "wires": [
            [
                "95295516124d818d"
            ]
        ]
    },
    {
        "id": "15830b9747f8132e",
        "type": "switch",
        "z": "a099d47fc07b3cee",
        "g": "5778369e644d84d7",
        "name": "solutions present",
        "property": "solutions",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "undefined",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 150,
        "y": 940,
        "wires": [
            [
                "4d6fd96944872ba1"
            ]
        ]
    },
    {
        "id": "8b0aa863bb6493fd",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "5778369e644d84d7",
        "name": "timing end",
        "func": "let start = RED.util.getMessageProperty(msg,\"setbatteries.execution_start\");\nlet end = Date.now();\nlet delta = end - start;\nlet timingString = `${delta/1000} sec`;\n\nnode.status({fill:\"green\",shape:\"dot\",text: timingString});\nmsg.delta = delta;\nmsg.timing = timingString;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 1140,
        "wires": [
            [
                "77163ca9f43e8fb7"
            ]
        ]
    },
    {
        "id": "084ac27446297f16",
        "type": "debug",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "Step result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 730,
        "y": 1120,
        "wires": []
    },
    {
        "id": "1e4f762143a12bba",
        "type": "rbe",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 570,
        "y": 1020,
        "wires": [
            [
                "4decf8d91d6ccacb"
            ]
        ]
    },
    {
        "id": "77163ca9f43e8fb7",
        "type": "debug",
        "z": "a099d47fc07b3cee",
        "g": "5778369e644d84d7",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "debug",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 110,
        "y": 1200,
        "wires": []
    },
    {
        "id": "bbe037f4bc3425fc",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 460,
        "wires": [
            [
                "7d6705c1829e0683"
            ]
        ]
    },
    {
        "id": "db8e14c359673211",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Update battery order",
        "func": "// Cycles battery priority as follows\n// M=1 [1,2,3,4] | M=2 [2,3,4,1] | M=3 [3,4,1,2] | etc.\n// With M the battery to prioritize\n\n// msg.batteries (original order)\nlet currentArray = msg.batteries;\n\n// Prioritize the Mth battery\nconst M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// 1st battery has prio? Skip and continue without change\nif (M==1) return msg;\n\n// N equals the number of items to take from the front to the back of the array, effectivly rotating battery priority\nconst N = M - 1; // base-0 version of M\nnode.status({fill:\"blue\",shape:\"ring\",text:`N = ${N}`});\n\n// 1. Check if the array is valid and long enough\nif (!Array.isArray(currentArray) || currentArray.length < N) {\n    // Send an error or the original array back if the array is invalid/too short\n    node.error(`Array is not valid or shorter than ${N} items.`, msg);\n    return null;\n}\n\n// 2. Get the first N items (these will go to the back)\n// slice(0, N) retrieves elements from the start (index 0) up to index N (exclusive).\nlet firstN = currentArray.slice(0, N);\n\n// 3. Get the remaining items (these will stay at the front)\n// slice(N) retrieves elements from index N to the end of the array.\nlet remaining = currentArray.slice(N);\n\n// 4. Concatenate them: remaining items (front) + first N items (back)\nlet newArray = remaining.concat(firstN);\n\n// 5. Place the new array back into msg.batteries\nmsg.batteries = newArray;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 660,
        "wires": [
            [
                "e63433bdfbdd57e9"
            ]
        ]
    },
    {
        "id": "b98d8b6d56dc5e39",
        "type": "inject",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Every day 02:00",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 02 * * *",
        "once": false,
        "onceDelay": "5",
        "topic": "cycle_battery_priority",
        "payload": "",
        "payloadType": "date",
        "x": 610,
        "y": 660,
        "wires": [
            [
                "64c9954af597093d"
            ]
        ]
    },
    {
        "id": "9f9dd1b6c8a68339",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Change priority",
        "func": "// Current prioritized battery is the Mth battery\nlet M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// Prioritize the next battery\nM += 1;\n\n// If the next battery does not exist, prioritize the first again\nif(M > msg.battery_count) M = 1;\n\n// Pass along as payload\nmsg.payload = M;\n\n// Show which battery has priority\nnode.status({fill:\"green\",shape:\"dot\",text:`Prioritize battery #${M}`});\n\n// Done\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1540,
        "y": 660,
        "wires": [
            [
                "c9b6b8b729161188"
            ]
        ]
    },
    {
        "id": "1cc51c4bd0523e93",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1350,
        "y": 660,
        "wires": [
            [
                "9f9dd1b6c8a68339"
            ]
        ]
    },
    {
        "id": "1c419030271bee64",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Prioritize battery M",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_prioritize_battery",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "prioritize_battery",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 660,
        "wires": [
            [
                "db8e14c359673211"
            ]
        ]
    },
    {
        "id": "c9b6b8b729161188",
        "type": "api-call-service",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Update prioritized battery",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_prioritize_battery"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1750,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "64c9954af597093d",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Desired interval",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_control_priority_change_interval",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 660,
        "wires": [
            [
                "1dac3194a67aeec2"
            ]
        ]
    },
    {
        "id": "1dac3194a67aeec2",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Check interval ",
        "func": "// Manual priority, never pass\nif(msg.payload == \"Never\") {\n    node.status({fill:\"yellow\",shape:\"dot\",text:\"Auto cycle disabled\"});\n    return null;\n}\n\n// Daily interval, always pass\nif(msg.payload == \"Daily\") {\n    node.status({ fill: \"green\", shape: \"dot\", text: `Pass` });\n    return msg;\n}\n\n// Weekly interval\nconst today = new Date();\n// Get the day of the week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)\nconst dayOfWeek = today.getDay();\n\n// Check if the day is Sunday (which is represented by the number 0)\nif (dayOfWeek === 0) {\n    // If it is Sunday, pass\n    node.status({ fill: \"green\", shape: \"dot\", text: `Passed on Sunday` });\n    return msg;\n} else {\n    // If it is not Sunday, stop\n    node.status({ fill: \"yellow\", shape: \"dot\", text: `Halted, not Sunday` });\n    return null;\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 660,
        "wires": [
            [
                "641cc1cf21ace75a"
            ]
        ]
    },
    {
        "id": "641cc1cf21ace75a",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Current priority",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_prioritize_battery",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "prioritize_battery",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1160,
        "y": 660,
        "wires": [
            [
                "1cc51c4bd0523e93"
            ]
        ]
    },
    {
        "id": "0be9d3b9ef3576fd",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "c1e44a160c59f1a9",
        "name": "Batteries (totals)",
        "func": "// batteries | calculate total and max. power delivered by batteries\nlet batteries = msg.batteries;\nlet batteries_total_power = 0;\nlet batteries_max_charging_power = 0;\nlet batteries_max_discharging_power = 0;\nlet batteries_available_energy = 0;\n\nbatteries.forEach(battery => {\n    batteries_total_power += Number(battery.power);\n    batteries_max_charging_power += Number(battery.charging_max);\n    batteries_max_discharging_power += Number(battery.discharging_max);\n    batteries_available_energy += Number(battery.energy - battery.energy_max*battery.soc_min/100);\n});\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_total_power\", batteries_total_power, true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_charge_power\", batteries_max_charging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_discharge_power\", batteries_max_discharging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_available_energy\",batteries_available_energy,true); // kWh effective\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 560,
        "wires": [
            [
                "1c419030271bee64",
                "ce28e80550ab9b42"
            ]
        ],
        "inputLabels": [
            "Mapping (from Home Battery IO)"
        ]
    },
    {
        "id": "208060fed37273fc",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Energy max",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_total_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_total_energy",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1570,
        "y": 380,
        "wires": [
            [
                "64a533741de02153"
            ]
        ]
    },
    {
        "id": "023bfc9b8ac21db1",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Loop end",
        "func": "// cleanup \ndelete msg.battery_index;\n\ndelete msg.battery_power;\ndelete msg.max_charge_power;\ndelete msg.max_discharge_power;\ndelete msg.battery_state_of_charge;\ndelete msg.charging_cutoff_capacity;\ndelete msg.discharging_cutoff_capacity;\ndelete msg.inverter_state;\ndelete msg.battery_remaining_capacity;\ndelete msg.battery_total_energy;\ndelete msg.rs485_control_mode;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 460,
        "wires": [
            [
                "1933f2623fa0fffb",
                "0be9d3b9ef3576fd"
            ]
        ]
    },
    {
        "id": "f27b588385633b97",
        "type": "api-call-service",
        "z": "a099d47fc07b3cee",
        "name": "Set total usable energy",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_total_available_energy"
        ],
        "labelId": [],
        "data": "{\"value\":$$.batteries_available_energy}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 540,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "b0cd2895e3545c27",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Full Stop Trigger",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.ev_is_charging",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "full_stop_trigger",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 140,
        "y": 820,
        "wires": [
            [
                "06dd855a34065b5d"
            ]
        ]
    },
    {
        "id": "ce28e80550ab9b42",
        "type": "rbe",
        "z": "a099d47fc07b3cee",
        "name": "On change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "batteries_available_energy",
        "topi": "topic",
        "x": 350,
        "y": 560,
        "wires": [
            [
                "f27b588385633b97"
            ]
        ]
    },
    {
        "id": "f3e427d4451be530",
        "type": "change",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "SoC min",
        "rules": [
            {
                "t": "set",
                "p": "discharging_cutoff_capacity",
                "pt": "msg",
                "to": "12",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 980,
        "y": 380,
        "wires": [
            [
                "a882514e64e6f538"
            ]
        ]
    },
    {
        "id": "a882514e64e6f538",
        "type": "change",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "SoC max",
        "rules": [
            {
                "t": "set",
                "p": "charging_cutoff_capacity",
                "pt": "msg",
                "to": "100",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1120,
        "y": 380,
        "wires": [
            [
                "d01fc0ee854e249a"
            ]
        ]
    },
    {
        "id": "e2a3a19c3da30059",
        "type": "switch",
        "z": "a099d47fc07b3cee",
        "g": "149d3bed7854fec1",
        "name": "Select rate limit",
        "property": "rate_limit",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 380,
        "y": 180,
        "wires": [
            [
                "563c57a7746c3a96"
            ],
            [
                "660d380dfd258f53"
            ]
        ]
    },
    {
        "id": "8ddd86470cf105f4",
        "type": "delay",
        "z": "a099d47fc07b3cee",
        "g": "149d3bed7854fec1",
        "name": "Rate limit (drop)",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": true,
        "outputs": 1,
        "x": 720,
        "y": 200,
        "wires": [
            [
                "ceb31920f185d64b",
                "ca528d9c66c9f8d6"
            ]
        ]
    },
    {
        "id": "660d380dfd258f53",
        "type": "change",
        "z": "a099d47fc07b3cee",
        "g": "149d3bed7854fec1",
        "name": "1 msg/s",
        "rules": [
            {
                "t": "set",
                "p": "rate",
                "pt": "msg",
                "to": "1000",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 540,
        "y": 200,
        "wires": [
            [
                "8ddd86470cf105f4"
            ]
        ]
    },
    {
        "id": "563c57a7746c3a96",
        "type": "change",
        "z": "a099d47fc07b3cee",
        "g": "149d3bed7854fec1",
        "name": "0.333 msg/s",
        "rules": [
            {
                "t": "set",
                "p": "rate",
                "pt": "msg",
                "to": "3000",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 550,
        "y": 160,
        "wires": [
            [
                "8ddd86470cf105f4"
            ]
        ]
    },
    {
        "id": "898cc8a1b89a0f72",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "149d3bed7854fec1",
        "name": "P1 change (20W or 2%)",
        "func": "// Switch between low and high rate limiting to decrease load and power consumption\n// --\n// The flow should always be rate limited by atleast the total execution time of strategies\n// The flow should not lock up indefinitly when grid_power is constant.\n// In the latter case, a more relaxed rate limit can help reduce system load.\n// Devs: don't set msg.rate directly. Use nodes, so novice users can easily read the flow.\n\n// Count the number of evaluations\nlet evaluationCount = Number(context.get(\"p1_rate_limit_evaluations\")) + 1 || 1;\ncontext.set(\"p1_rate_limit_evaluations\", evaluationCount);\nmsg.rate_limit_evaluations = evaluationCount;\n\n// Get the previous value from this node's context\n// If it doesn't exist yet, initialize it as null\nlet previousValue = context.get('previousValue') || null;\nlet currentValue = Number(msg.grid_power);\n\n// Save the current value for the next time the node is triggered\ncontext.set('previousValue', currentValue);\n\n// Default no limiting\nmsg.rate_limit = false;\n\n// Check if we have a valid history to compare with\nif (previousValue !== null) {\n    let absoluteDiff = Math.abs(currentValue - previousValue);\n    let percentageChange = previousValue !== 0 ? Math.abs((absoluteDiff / previousValue) * 100):0;\n\n    // Condition: Absolute difference > N Watt AND percentage change > M %\n    if (absoluteDiff > 20 && percentageChange > 2) {\n\n        // Enable rate limit\n        msg.rate_limit = true;\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 170,
        "y": 180,
        "wires": [
            [
                "e2a3a19c3da30059"
            ]
        ]
    },
    {
        "id": "ca528d9c66c9f8d6",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "149d3bed7854fec1",
        "name": "CPU power saved",
        "func": "// 1. Get evaluations (Total attempts)\nlet evaluations = Number(RED.util.getMessageProperty(msg,\"rate_limit_evaluations\")) || 0;\n\n// 2. Increment and get passes (Filtered/successful events)\nlet passes = (context.get(\"p1_rate_limit_passes\") || 0) + 1;\ncontext.set(\"p1_rate_limit_passes\", passes);\n\n// 3a. Calculate percentage (Rate of passing vs total evaluations)\nlet percentage = evaluations > 0 ? (passes / evaluations) * 100 : 0;\n// 3b. Display the percentage rate of not-passing as a measure of efficiency gained\npercentage = 100 - percentage;\n\n// 4. Update Node Status\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `Saved: ${percentage.toFixed(2)}% (${evaluations-passes}/${evaluations})`\n});\n\n// No output\nreturn null;\n\n/*\n// Counters\nlet passesCount = context.get(\"p1_rate_limit_passes\") || 0;\ncontext.set(\"p1_rate_limit_passes\", passesCount++);\n\nlet evaluationCount = Number(flow.get(\"p1_rate_limit_evaluations\")) || 0;\n\n// Percentage\nlet percentage = 0;\nif(passesCount !== 0) {\n    percentage = evaluationCount/passesCount * 100;\n    percentage = Number(percentage.toFixed(2));  // 2 decimals\n}\n\n// Node info\nnode.status({fill:\"blue\",shape:\"dot\",text:`${percentage} %`});\n\nreturn null; */",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "b9f84cc9f5a92c37",
        "type": "api-current-state",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 60,
        "wires": [
            [
                "db8935b06e0974bc"
            ]
        ]
    },
    {
        "id": "964d538dd74d6c05",
        "type": "function",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Set RS485 and Work Modes",
        "func": "// array for output \nlet outputArray = [];\n\n// battery to target\nconst target = `marstek_m${msg.battery_index}`;\n\n// Set | work mode\nconst workModeAction = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_user_work_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.work_mode)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.work_mode ? { payload: workModeAction, topic:\"user_work_mode\"}: null);\n\n// Set | rs485\nconst rs485Action = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_rs485_control_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.rs485)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.rs485 ? { payload: rs485Action, topic: \"rs485_control_mode\" } : null);\n\n// Store calls in msg to allow checking of loop results\nmsg.loop_result = { target, workModeAction, rs485Action };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Outputs\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 180,
        "wires": [
            [
                "0a5e50316b0d2b70"
            ],
            [
                "9875fb4be6ce951f"
            ],
            [
                "9f47be1a4b1c355b"
            ]
        ]
    },
    {
        "id": "db8935b06e0974bc",
        "type": "function",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// configurables\nlet workMode = null; // manual, anti-feed, ai, null = don't set or alter this setting\nlet rs485 = null;  // enable, disable, null = don't set or alter this setting\n\n// mode select\nswitch (msg.marstek_master_battery_mode) {\n    case \"Manual control\":\n        workMode = \"manual\";\n        rs485 = \"disable\";\n        break;\n    case \"Marstek control\":\n        // the user should select a work mode via the Marstek App or via select.marstek_mX_user_work_mode\n        rs485 = \"disable\";\n        break;\n    case \"Full control\":\n        rs485 = \"enable\";\n        break;\n    default:\n        node.status({fill:\"red\",shape:\"ring\",text:`Unhandled mode: ${msg.marstek_master_battery_mode}`});\n        return null; // stop flow\n}\n\n// Continue\nmsg.work_mode = workMode;\nmsg.rs485 = rs485;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 180,
        "wires": [
            [
                "964d538dd74d6c05"
            ]
        ]
    },
    {
        "id": "9f47be1a4b1c355b",
        "type": "function",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 240,
        "wires": [
            [
                "3141628fc4063a26",
                "06cec7476db26e79"
            ]
        ]
    },
    {
        "id": "3141628fc4063a26",
        "type": "switch",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 640,
        "y": 240,
        "wires": [
            [
                "964d538dd74d6c05"
            ],
            [
                "ce0d5547e473555e"
            ]
        ]
    },
    {
        "id": "0a5e50316b0d2b70",
        "type": "api-call-service",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Set work mode",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 800,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "9875fb4be6ce951f",
        "type": "api-call-service",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Set RS485",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 790,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "06cec7476db26e79",
        "type": "debug",
        "z": "acde727d4cb42aaa",
        "g": "8b5ef482f35ef9c0",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 510,
        "y": 280,
        "wires": []
    },
    {
        "id": "ce0d5547e473555e",
        "type": "debug",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 360,
        "wires": []
    },
    {
        "id": "64dc39c70599dfc4",
        "type": "server-state-changed",
        "z": "acde727d4cb42aaa",
        "g": "5b3831da1b35bb1d",
        "name": "Master control mode",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "marstek_master_battery_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 150,
        "y": 60,
        "wires": [
            [
                "b9f84cc9f5a92c37"
            ]
        ]
    },
    {
        "id": "7ec432c49bd7aad2",
        "type": "debug",
        "z": "0a25621f3d1c985f",
        "g": "4776ad4f0339c6ae",
        "name": "M1 Forcible mode",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 610,
        "y": 200,
        "wires": []
    },
    {
        "id": "6c10fd50e5e23c5c",
        "type": "debug",
        "z": "0a25621f3d1c985f",
        "g": "4776ad4f0339c6ae",
        "name": "M1 power",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 580,
        "y": 260,
        "wires": []
    },
    {
        "id": "807fecff3dd1e9d7",
        "type": "api-call-service",
        "z": "0a25621f3d1c985f",
        "g": "4776ad4f0339c6ae",
        "name": "Output charge/discharge/stop M1",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "select.select_option",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "select.marstek_m1_forcible_charge_discharge"
        ],
        "labelId": [],
        "data": "{\"option\":\"{{ payload }}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "select",
        "service": "select_option",
        "x": 360,
        "y": 200,
        "wires": [
            [
                "7ec432c49bd7aad2"
            ]
        ]
    },
    {
        "id": "c32afffb5ac57d79",
        "type": "api-call-service",
        "z": "0a25621f3d1c985f",
        "g": "4776ad4f0339c6ae",
        "name": "Output (dis)charge power M1",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "number.marstek_m1_forcible_discharge_power",
            "number.marstek_m1_forcible_charge_power"
        ],
        "labelId": [],
        "data": "{\"value\":\"{{ payload }}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "number",
        "service": "set_value",
        "x": 340,
        "y": 260,
        "wires": [
            [
                "6c10fd50e5e23c5c"
            ]
        ]
    },
    {
        "id": "931cccdaaeafbd38",
        "type": "inject",
        "z": "0a25621f3d1c985f",
        "g": "d94668c8ae9cf8a1",
        "name": "Charge",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "charge_mode",
        "payload": "charge",
        "payloadType": "str",
        "x": 150,
        "y": 360,
        "wires": [
            [
                "f0629b49c28c5864"
            ]
        ]
    },
    {
        "id": "5caaf9fa7ecd954b",
        "type": "function",
        "z": "0a25621f3d1c985f",
        "g": "4776ad4f0339c6ae",
        "name": "Input",
        "func": "let test_array = [];\nlet charge_mode = flow.get(\"forcible_charge_discharge\")||\"stop\";\nlet power = Number(flow.get(\"power\"));\n\n// Charge mode\ntest_array.push({payload: charge_mode});\n// Power\ntest_array.push({payload: power});\n\nreturn test_array;",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 200,
        "wires": [
            [
                "807fecff3dd1e9d7"
            ],
            [
                "c32afffb5ac57d79"
            ]
        ]
    },
    {
        "id": "ac7f5f881b0f026f",
        "type": "api-current-state",
        "z": "0a25621f3d1c985f",
        "g": "fe54093811b6a7fe",
        "name": "Master Control Mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.marstek_master_battery_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "master_mode",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 360,
        "y": 100,
        "wires": [
            [
                "869beb2c2332637b"
            ]
        ]
    },
    {
        "id": "869beb2c2332637b",
        "type": "switch",
        "z": "0a25621f3d1c985f",
        "g": "fe54093811b6a7fe",
        "name": "when in \"Manual Control\" mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Manual control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 630,
        "y": 100,
        "wires": [
            [
                "5caaf9fa7ecd954b"
            ]
        ]
    },
    {
        "id": "16e609e6f5bfaff8",
        "type": "inject",
        "z": "0a25621f3d1c985f",
        "g": "fe54093811b6a7fe",
        "name": "Do a test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 100,
        "wires": [
            [
                "ac7f5f881b0f026f"
            ]
        ]
    },
    {
        "id": "f0629b49c28c5864",
        "type": "function",
        "z": "0a25621f3d1c985f",
        "g": "d94668c8ae9cf8a1",
        "name": "charge state",
        "func": "flow.set(\"forcible_charge_discharge\", msg.payload); // stop, charge, discharge\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "5cfda233ce27dc73",
        "type": "inject",
        "z": "0a25621f3d1c985f",
        "g": "d94668c8ae9cf8a1",
        "name": "Discharge",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "charge_mode",
        "payload": "discharge",
        "payloadType": "str",
        "x": 160,
        "y": 400,
        "wires": [
            [
                "f0629b49c28c5864"
            ]
        ]
    },
    {
        "id": "f4e777264f65f640",
        "type": "inject",
        "z": "0a25621f3d1c985f",
        "g": "d94668c8ae9cf8a1",
        "name": "Stop",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "charge_mode",
        "payload": "stop",
        "payloadType": "str",
        "x": 150,
        "y": 440,
        "wires": [
            [
                "f0629b49c28c5864"
            ]
        ]
    },
    {
        "id": "bc9e96111f996807",
        "type": "inject",
        "z": "0a25621f3d1c985f",
        "g": "d6af2a36d0dfdda5",
        "name": "200 W",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "power",
        "payload": "200",
        "payloadType": "num",
        "x": 570,
        "y": 360,
        "wires": [
            [
                "8cd5b26ec5d86f60"
            ]
        ]
    },
    {
        "id": "275647d6fa79f142",
        "type": "inject",
        "z": "0a25621f3d1c985f",
        "g": "d6af2a36d0dfdda5",
        "name": "1 W",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "power",
        "payload": "1",
        "payloadType": "num",
        "x": 570,
        "y": 400,
        "wires": [
            [
                "8cd5b26ec5d86f60"
            ]
        ]
    },
    {
        "id": "26629155a2d9c3ba",
        "type": "inject",
        "z": "0a25621f3d1c985f",
        "g": "d6af2a36d0dfdda5",
        "name": "0 W",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "power",
        "payload": "0",
        "payloadType": "num",
        "x": 570,
        "y": 440,
        "wires": [
            [
                "8cd5b26ec5d86f60"
            ]
        ]
    },
    {
        "id": "8cd5b26ec5d86f60",
        "type": "function",
        "z": "0a25621f3d1c985f",
        "g": "d6af2a36d0dfdda5",
        "name": "set power",
        "func": "flow.set(\"power\", msg.payload); // Watt\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "952dcb76faf9377b",
        "type": "inject",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 540,
        "wires": [
            [
                "1de0ea92dde0cb92"
            ]
        ]
    },
    {
        "id": "d37894c2b1e074da",
        "type": "function",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "For each (init)",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = msg.battery_count;\n\n// Init an array for battery status and value information\nmsg.batteries = [];\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 540,
        "wires": [
            [
                "32c18b304ab18eef"
            ]
        ]
    },
    {
        "id": "e2c98a4a11d3119b",
        "type": "function",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "Mapping",
        "func": "node.warn(msg.battery_index);\n\n// { id: \"M1\", \n//       power: M1_power, charging_max: M1_charging_max, discharging_max: M1_discharging_max,\n//       soc: M1_soc, soc_min: M1_soc_min, soc_max: M1_soc_max,\n//       rs485: M1_control_mode \n//     }\n\n// Map to batteries array\nmsg.batteries.push({\n    id: `M${msg.battery_index}`,\n    power: msg.battery_power,\n    charging_max: msg.max_charge_power,\n    discharging_max: msg.max_discharge_power,\n    soc: msg.battery_state_of_charge,\n    soc_max: msg.charging_cutoff_capacity,\n    soc_min: msg.discharging_cutoff_capacity,\n    inverter: msg.inverter_state,\n    cap_remaining: msg.battery_remaining_capacity,\n    rs485: msg.rs485_control_mode\n    });\n\n// Step index down\nmsg.battery_index -= 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 720,
        "wires": [
            [
                "7d491da9cff1228d"
            ]
        ]
    },
    {
        "id": "7d491da9cff1228d",
        "type": "switch",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 140,
        "y": 760,
        "wires": [
            [
                "32c18b304ab18eef"
            ],
            [
                "ed583566b7d2e5a5"
            ]
        ]
    },
    {
        "id": "ed583566b7d2e5a5",
        "type": "debug",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "Loop result",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 150,
        "y": 800,
        "wires": []
    },
    {
        "id": "1de0ea92dde0cb92",
        "type": "api-current-state",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "Battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 310,
        "y": 540,
        "wires": [
            [
                "d37894c2b1e074da"
            ]
        ]
    },
    {
        "id": "40b65d5d85625cf3",
        "type": "api-current-state",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "SoC",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_state_of_charge",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_state_of_charge",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 310,
        "y": 640,
        "wires": [
            [
                "ef5d062ab8c5730b"
            ]
        ]
    },
    {
        "id": "b6036af3515b400f",
        "type": "api-current-state",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "Inverter state",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_inverter_state",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "inverter_state",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 330,
        "y": 680,
        "wires": [
            [
                "b1a0880f8fb62bf2"
            ]
        ]
    },
    {
        "id": "ef5d062ab8c5730b",
        "type": "api-current-state",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "SoC min",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_discharging_cutoff_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "discharging_cutoff_capacity",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 480,
        "y": 640,
        "wires": [
            [
                "317a70d47e45df87"
            ]
        ]
    },
    {
        "id": "317a70d47e45df87",
        "type": "api-current-state",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "SoC max",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_charging_cutoff_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charging_cutoff_capacity",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 680,
        "y": 640,
        "wires": [
            [
                "b6036af3515b400f"
            ]
        ]
    },
    {
        "id": "544d7fe378e8f4f1",
        "type": "api-current-state",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "Max discharge power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_discharge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_discharge_power",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 720,
        "y": 600,
        "wires": [
            [
                "40b65d5d85625cf3"
            ]
        ]
    },
    {
        "id": "b1a0880f8fb62bf2",
        "type": "api-current-state",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "Capacity remaining",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_remaining_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_remaining_capacity",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 510,
        "y": 680,
        "wires": [
            [
                "e2c98a4a11d3119b"
            ]
        ]
    },
    {
        "id": "10e04cfa04d1fb5f",
        "type": "api-current-state",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "Max charge power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_charge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_charge_power",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 510,
        "y": 600,
        "wires": [
            [
                "544d7fe378e8f4f1"
            ]
        ]
    },
    {
        "id": "3cb20d31ca53816b",
        "type": "api-current-state",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "Power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_power",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "battery_power",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 310,
        "y": 600,
        "wires": [
            [
                "10e04cfa04d1fb5f"
            ]
        ]
    },
    {
        "id": "32c18b304ab18eef",
        "type": "api-current-state",
        "z": "0a25621f3d1c985f",
        "g": "23508a0784b7a764",
        "name": "Control mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "select.marstek_m{{battery_index}}_rs485_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "rs485_control_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 160,
        "y": 600,
        "wires": [
            [
                "3cb20d31ca53816b"
            ]
        ]
    },
    {
        "id": "721c6c9f8abb8939",
        "type": "inject",
        "z": "0a25621f3d1c985f",
        "g": "99dab2f005d99056",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 980,
        "y": 540,
        "wires": [
            [
                "85e53fe14fe8c336"
            ]
        ]
    },
    {
        "id": "85e53fe14fe8c336",
        "type": "function",
        "z": "0a25621f3d1c985f",
        "g": "99dab2f005d99056",
        "name": "For each (inti)",
        "func": "const value = \"charge\"; //msg.payload;\nconst target = \"select.marstek_m1_forcible_charge_discharge\"; //msg.topic;\n\nmsg.payload = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [target]\n    },\n    \"data\": {\n        \"option\": value\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1140,
        "y": 540,
        "wires": [
            [
                "53bdff08247dc43b"
            ]
        ]
    },
    {
        "id": "53bdff08247dc43b",
        "type": "api-call-service",
        "z": "0a25621f3d1c985f",
        "g": "99dab2f005d99056",
        "name": "Set Marstek Battery",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "last",
        "blockInputOverrides": false,
        "domain": "select",
        "service": "select_option",
        "x": 1330,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "6b3e5f2f22e3df05",
        "type": "inject",
        "z": "0a25621f3d1c985f",
        "g": "137e6287c81f0267",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "prioritize_battery",
                "v": "3",
                "vt": "num"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 900,
        "wires": [
            [
                "61aeb6b570e5d0f6"
            ]
        ]
    },
    {
        "id": "61aeb6b570e5d0f6",
        "type": "function",
        "z": "0a25621f3d1c985f",
        "g": "137e6287c81f0267",
        "name": "Battery order",
        "func": "// msg.batteries (original order)\n// let oldArray = [{id:\"M1\"},{id:\"M2\"},{id:\"M3\"}];\nlet oldArray = [1,2,3,4];\n\n// Prioritize the Mth battery\nconst M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// N equals the number of items to take from the front to the back of the array, effectivly rotating battery priority\nconst N = M - 1; // base-0 version of M\nnode.status({fill:\"blue\",shape:\"ring\",text:`N = ${N}`});\n\n// 1. Check if the array is valid and long enough\nif (!Array.isArray(oldArray) || oldArray.length < N) {\n    // Send an error or the original array back if the array is invalid/too short\n    node.error(`Array is not valid or shorter than ${N} items.`, msg);\n    return null; \n}\n\n// 2. Get the first N items (these will go to the back)\n// slice(0, N) retrieves elements from the start (index 0) up to index N (exclusive).\nlet firstN = oldArray.slice(0, N);\n\n// 3. Get the remaining items (these will stay at the front)\n// slice(N) retrieves elements from index N to the end of the array.\nlet remaining = oldArray.slice(N);\n\n// 4. Concatenate them: remaining items (front) + first N items (back)\nlet newArray = remaining.concat(firstN);\n\n// 5. Place the new array back into msg.batteries\nmsg.batteries = newArray;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 900,
        "wires": [
            [
                "149a6d03c4420699"
            ]
        ]
    },
    {
        "id": "149a6d03c4420699",
        "type": "debug",
        "z": "0a25621f3d1c985f",
        "g": "137e6287c81f0267",
        "name": "Result",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "batteries",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 470,
        "y": 900,
        "wires": []
    },
    {
        "id": "1b87bb9331aa7957",
        "type": "inject",
        "z": "0a25621f3d1c985f",
        "g": "a9c604eb640d5087",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 1020,
        "wires": [
            [
                "1c53d1727770d10f"
            ]
        ]
    },
    {
        "id": "03999a11700893e1",
        "type": "api-current-state",
        "z": "0a25621f3d1c985f",
        "g": "a9c604eb640d5087",
        "name": "Cheapest hour",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.cheapest_hour",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 460,
        "y": 1020,
        "wires": [
            [
                "dd12fb024f91a46c"
            ]
        ]
    },
    {
        "id": "06742153914f176c",
        "type": "debug",
        "z": "0a25621f3d1c985f",
        "g": "a9c604eb640d5087",
        "name": "Cheapest hours",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 940,
        "y": 1020,
        "wires": []
    },
    {
        "id": "77a60a41e79103b6",
        "type": "api-render-template",
        "z": "0a25621f3d1c985f",
        "g": "a9c604eb640d5087",
        "name": "Cheapest template",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    hours=2,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "payload",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 470,
        "y": 1100,
        "wires": [
            [
                "d21932c2d5c60e3c"
            ]
        ]
    },
    {
        "id": "bc3b82ace59b9797",
        "type": "debug",
        "z": "0a25621f3d1c985f",
        "g": "a9c604eb640d5087",
        "name": "Cheapest template",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 950,
        "y": 1100,
        "wires": []
    },
    {
        "id": "0ff3238209d01e07",
        "type": "function",
        "z": "0a25621f3d1c985f",
        "g": "a9c604eb640d5087",
        "name": "function 1",
        "func": "const output = RED.util.getMessageProperty(msg,\"payload.start\");\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 1160,
        "wires": [
            []
        ]
    },
    {
        "id": "b43975f0bd7d3bcc",
        "type": "json",
        "z": "0a25621f3d1c985f",
        "g": "a9c604eb640d5087",
        "name": "",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 770,
        "y": 1100,
        "wires": [
            [
                "bc3b82ace59b9797",
                "0ff3238209d01e07"
            ]
        ]
    },
    {
        "id": "1c53d1727770d10f",
        "type": "function",
        "z": "0a25621f3d1c985f",
        "g": "a9c604eb640d5087",
        "name": "Timing",
        "func": "// add execution marker\nRED.util.setMessageProperty(msg,\"execution_start\",Date.now()); \n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 1020,
        "wires": [
            [
                "03999a11700893e1",
                "77a60a41e79103b6"
            ]
        ]
    },
    {
        "id": "dd12fb024f91a46c",
        "type": "function",
        "z": "0a25621f3d1c985f",
        "g": "a9c604eb640d5087",
        "name": "Time trap",
        "func": "// add execution marker\nlet execution_end = Date.now();\nRED.util.setMessageProperty(msg, \"execution_end\", execution_end);\n\n// retrieve execution markers\nlet execution_start = RED.util.getMessageProperty(msg,\"execution_start\");\n\n// report execution time\nif (execution_start !== undefined && execution_end !== undefined) {\n    // exec time\n    let execution_time = (execution_end - execution_start) / 1000; // seconds\n    // report\n    if (execution_time <= 0) node.status({ fill: \"red\", shape: \"dot\", text: `negative or zero timing` });\n    if (execution_time > 0) node.status({ fill: \"green\", shape: \"dot\", text: `${execution_time} sec`});\n    if (execution_time >= 0.7) node.status({ fill: \"yellow\", shape: \"dot\", text: `${execution_time} sec` });\n    if (execution_time >= 1) node.status({ fill: \"red\", shape: \"dot\", text: `${execution_time} sec` });\n\n} else {\n    node.status({fill:\"grey\",shape:\"dot\",text:\"timing error\"});\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 1020,
        "wires": [
            [
                "6904fb44493109bc"
            ]
        ]
    },
    {
        "id": "d21932c2d5c60e3c",
        "type": "function",
        "z": "0a25621f3d1c985f",
        "g": "a9c604eb640d5087",
        "name": "Time trap",
        "func": "// add execution marker\nlet execution_end = Date.now();\nRED.util.setMessageProperty(msg, \"execution_end\", execution_end);\n\n// retrieve execution markers\nlet execution_start = RED.util.getMessageProperty(msg,\"execution_start\");\n\n// report execution time\nif (execution_start !== undefined && execution_end !== undefined) {\n    // exec time\n    let execution_time = (execution_end - execution_start) / 1000; // seconds\n    // report\n    if (execution_time <= 0) node.status({ fill: \"red\", shape: \"dot\", text: `negative or zero timing` });\n    if (execution_time > 0) node.status({ fill: \"green\", shape: \"dot\", text: `${execution_time} sec`});\n    if (execution_time >= 0.7) node.status({ fill: \"yellow\", shape: \"dot\", text: `${execution_time} sec` });\n    if (execution_time >= 1) node.status({ fill: \"red\", shape: \"dot\", text: `${execution_time} sec` });\n\n} else {\n    node.status({fill:\"grey\",shape:\"dot\",text:\"timing error\"});\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 1100,
        "wires": [
            [
                "b43975f0bd7d3bcc"
            ]
        ]
    },
    {
        "id": "6904fb44493109bc",
        "type": "json",
        "z": "0a25621f3d1c985f",
        "g": "a9c604eb640d5087",
        "name": "",
        "property": "payload",
        "action": "str",
        "pretty": false,
        "x": 770,
        "y": 1020,
        "wires": [
            [
                "06742153914f176c"
            ]
        ]
    },
    {
        "id": "a79347dc7b41ced3",
        "type": "comment",
        "z": "0a25621f3d1c985f",
        "g": "a9c604eb640d5087",
        "name": "Notes",
        "info": "Using a template node is 4x slower... \n... than a state node.\n\nHowever, having multiple template_sensors \nin HA and only using 1 of them is not ideal either.\nAnd letting users comment and uncomment the right sensors \nis too unfriendly. This would lead to large amounts of code\nin the config.yaml and even the few lines that are \ncurrently there generate a lot of help requests.\n\nUX should be paramount.",
        "x": 250,
        "y": 1100,
        "wires": []
    },
    {
        "id": "7a0cd93e9df76c48",
        "type": "link in",
        "z": "c1a9925591b564a7",
        "g": "e2c385d3b03e57bc",
        "name": "Self-consumption",
        "links": [],
        "x": 95,
        "y": 160,
        "wires": [
            [
                "de5eedecc97994b4",
                "c0cde540d8bc752b"
            ]
        ]
    },
    {
        "id": "a56daa760b9feeb1",
        "type": "comment",
        "z": "c1a9925591b564a7",
        "g": "e2c385d3b03e57bc",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the Link In in this start group exactly after the option configured in your\nselect_input.house_battery_strategy\n\nfound in the file:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nWill point to the flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 150,
        "y": 120,
        "wires": []
    },
    {
        "id": "5188a2bc82313c2e",
        "type": "comment",
        "z": "c1a9925591b564a7",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "2b06415ad41aae3a",
        "type": "server-state-changed",
        "z": "c1a9925591b564a7",
        "g": "3be8354628cecb12",
        "name": "User Ki change",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.house_battery_control_ki"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 240,
        "wires": [
            [
                "957baac6682de3d3"
            ]
        ]
    },
    {
        "id": "957baac6682de3d3",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "3be8354628cecb12",
        "name": "Integral term adjust",
        "func": "// On change of Ki setting\nlet logdata = \"bumpless \";\nlet I_sum = flow.get(\"I_integral_sum\");\nlet Ki = msg.payload || 0;     // Integral gain\nlet Ki_last = context.get(\"house_battery_control_ki_last\")||0;\n\n// if Ki was or has become zero\nif(Ki == 0 || Ki_last == 0){\n    // passify the integral-sum\n    flow.set(\"I_integral_sum\",0);\n    context.set(\"house_battery_control_ki_last\", Ki);\n    logdata += `to/from 0, Ki=${Ki_last} -> ${Ki} | `;\n    // done\n    return { payload: logdata };\n}\n\n// change in Ki\nlet dKi = parseFloat(Ki/Ki_last);\nif(dKi <= 0) dKi = 1; // ignore erroneous changes\n\n// keep I-term constant by compensating the integral-sum for the change in Ki\n// e.g. if Ki got 10% smaller, then integral-sum should increase 10%, to keep the I-term constant\nlet I_sum_new = I_sum / dKi;\nlogdata += `change of I: from ${Ki_last} to ${Ki} (${dKi * 100}%) | `;\n\n// OUTFLOW\nflow.set(\"I_integral_sum\", I_sum_new);\ncontext.set(\"house_battery_control_ki_last\", Ki);\n\n// OUTPUT\nreturn { payload: logdata };",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\n// init last state\nlet Ki = flow.get(\"house_battery_control_ki\") || 0;\ncontext.set(\"house_battery_control_ki_last\", Ki);",
        "finalize": "",
        "libs": [],
        "x": 1730,
        "y": 300,
        "wires": [
            [
                "6273b550e193d38b"
            ]
        ]
    },
    {
        "id": "40290752a7c02655",
        "type": "comment",
        "z": "c1a9925591b564a7",
        "g": "3be8354628cecb12",
        "name": "Bumpless Ki changes",
        "info": "Recalc I-term whenever Ki changes\n\nNote: always be mindful of making changes to control parameters of systems in operation.",
        "x": 1740,
        "y": 200,
        "wires": []
    },
    {
        "id": "6273b550e193d38b",
        "type": "debug",
        "z": "c1a9925591b564a7",
        "g": "3be8354628cecb12",
        "name": "Logdata",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1700,
        "y": 360,
        "wires": []
    },
    {
        "id": "787d4a4302cc3783",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Check for custom/auto mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Manual control",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Marstek control",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1855,
        "y": 660,
        "wires": [
            [
                "cfc64f84a4532120",
                "58b3c35be6a1ea9c"
            ],
            [
                "cfc64f84a4532120",
                "58b3c35be6a1ea9c"
            ],
            [
                "58b3c35be6a1ea9c"
            ]
        ],
        "l": false
    },
    {
        "id": "58b3c35be6a1ea9c",
        "type": "debug",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Master control switch",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2060,
        "y": 660,
        "wires": []
    },
    {
        "id": "5a05ae43285d5398",
        "type": "server-state-changed",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Master control mode",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1730,
        "y": 660,
        "wires": [
            [
                "787d4a4302cc3783"
            ]
        ]
    },
    {
        "id": "eca69e12794c1c0b",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Integral PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_i_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2050,
        "y": 500,
        "wires": [
            [
                "f5e5091687ccc093"
            ]
        ]
    },
    {
        "id": "f5e5091687ccc093",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Differential PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_d_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2060,
        "y": 540,
        "wires": [
            [
                "8a50bc3d63d7a248"
            ]
        ]
    },
    {
        "id": "cfc64f84a4532120",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Proportinal PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_p_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2060,
        "y": 460,
        "wires": [
            [
                "eca69e12794c1c0b"
            ]
        ]
    },
    {
        "id": "8a50bc3d63d7a248",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "PID Output to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2050,
        "y": 580,
        "wires": [
            [
                "a414c1013e9b72aa"
            ]
        ]
    },
    {
        "id": "a414c1013e9b72aa",
        "type": "change",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Integral sum to zero",
        "rules": [
            {
                "t": "set",
                "p": "I_integral_sum",
                "pt": "flow",
                "to": "0",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2060,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "7ca8801a84b11ae8",
        "type": "inject",
        "z": "c1a9925591b564a7",
        "g": "7ab490ceca7cff35",
        "name": "Debug FALSE",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "false",
        "payloadType": "bool",
        "x": 1730,
        "y": 100,
        "wires": [
            [
                "95f5050249137fbc"
            ]
        ]
    },
    {
        "id": "95f5050249137fbc",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "7ab490ceca7cff35",
        "name": "Set debug true/false",
        "func": "flow.set(\"LoadDistribution_debug_enabled\", msg.payload);\nnode.warn(\"Debug flag set to: \" + msg.payload);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1940,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "6a1707cb3cef46f2",
        "type": "inject",
        "z": "c1a9925591b564a7",
        "g": "7ab490ceca7cff35",
        "name": "Debug TRUE",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "x": 1730,
        "y": 60,
        "wires": [
            [
                "95f5050249137fbc"
            ]
        ]
    },
    {
        "id": "8baa774c2b027a30",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "name": "Target grid consumption",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_target_grid_consumption_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_target_grid_consumption_in_w",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 120,
        "wires": [
            [
                "6286320aa2c67f78"
            ]
        ],
        "info": "Set at 0 to strive for zero consumption"
    },
    {
        "id": "597ae0e8b54ce90b",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "54cf41d4c27eeebe",
        "name": "Hysteresis",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_hysteresis_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_hysteresis_in_w",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1010,
        "y": 120,
        "wires": [
            [
                "7e1e11d0eb34edae"
            ]
        ]
    },
    {
        "id": "5aa64580ae12f4b2",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "name": "PID P-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_kp",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_kp",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 410,
        "y": 180,
        "wires": [
            [
                "409b51e049035eb9"
            ]
        ]
    },
    {
        "id": "409b51e049035eb9",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "name": "PID I-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_ki",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_ki",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 590,
        "y": 180,
        "wires": [
            [
                "526cad5fede1f966"
            ]
        ]
    },
    {
        "id": "526cad5fede1f966",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "name": "PID D-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_kd",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_kd",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 770,
        "y": 180,
        "wires": [
            [
                "dde5b40cb7fe1ff8"
            ]
        ]
    },
    {
        "id": "7e1e11d0eb34edae",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "54cf41d4c27eeebe",
        "name": "Advanced settings",
        "func": "// 1. Hard coded advanced settings (flow level)\nflow.set(\"has_soc_charging_limiter\", true);         // slows charging from 90% to 100% to improve battery life\nflow.set(\"has_reverse_priority_discharge\", true);   // Prioritize discharging and charging the same battery when possible\nflow.set(\"master_gain\", 1);                         // Gain scheduling. Not Implemented!\n\n// 2. Configurable advanced settings (msg level)\nRED.util.setMessageProperty(msg,\"advanced_settings.self_consumption_at\",Date.now(),true); // creates 'advanced_settings' if it does net yet exist\nlet mas = msg.advanced_settings;\n\n// disable dicharge solutions and changes them to stop solutions\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\", mas.discharge_disabled ?? false);\n\n// 3. continue\nreturn msg;\n\n// Notes for home battery tinkerer friends:\n// Using RED.util.getMessageProperty / RED.util.setMessageProperty is more performant and safe.\n// If any part of the path (\"foo.bar\") is missing, it will return 'undefined' without throwing an error.\n//\n// The nullish coalescing (??) operator is a logical operator that returns its right-hand side operand when its left-hand side operand is null or undefined,\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1030,
        "y": 180,
        "wires": [
            [
                "affa3d29d06490e4"
            ]
        ]
    },
    {
        "id": "dde5b40cb7fe1ff8",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "54cf41d4c27eeebe",
        "name": "Idle time before Stop",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_idle_time",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "idle_time_minutes",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1040,
        "y": 80,
        "wires": [
            [
                "597ae0e8b54ce90b"
            ]
        ]
    },
    {
        "id": "8b9359ba6370a958",
        "type": "comment",
        "z": "c1a9925591b564a7",
        "g": "086689c5c8bba4b6",
        "name": "Setpoint ramping / damping",
        "info": "",
        "x": 460,
        "y": 460,
        "wires": []
    },
    {
        "id": "affa3d29d06490e4",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "086689c5c8bba4b6",
        "name": "Error signal dampening",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_error_signal_dampening",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_error_signal_dampening",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 340,
        "wires": [
            [
                "d87e5fb7584a366b"
            ]
        ]
    },
    {
        "id": "d87e5fb7584a366b",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "086689c5c8bba4b6",
        "name": "Output signal dampening",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_pid_output_dampening",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_pid_output_dampening",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 380,
        "wires": [
            [
                "d8cf3fee789fa491"
            ]
        ]
    },
    {
        "id": "d8cf3fee789fa491",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "086689c5c8bba4b6",
        "name": "Set: Error signal",
        "func": "// INPUTS\nlet P1_error_last = Number(context.get(\"p1_error_last\"))||0; // last error signal level in W\nlet dampening = Number(flow.get(\"house_battery_control_error_signal_dampening\")) || 0; // 0% - 100%\ndampening = dampening / 100; // to Number\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = Number(RED.util.getMessageProperty(msg,\"house_target_grid_consumption_in_w\")); // SP: target value\n\n// Calc error signal\nlet P1_error_unfiltered = P1_setpoint - P1_power;\n\n// Simple averaging filter\nlet P1_error_filtered = (1 - dampening) * P1_error_unfiltered + (dampening) * P1_error_last;\n\n// OUTFLOW\ncontext.set(\"p1_error_last\", P1_error_filtered);\n\n// OUTPUT\nmsg.grid_error = P1_error_filtered; // W (watt), error signal = SP - PV\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 420,
        "wires": [
            [
                "9b70f054ec8bbbb1"
            ]
        ]
    },
    {
        "id": "de3671b9c7503ce3",
        "type": "comment",
        "z": "c1a9925591b564a7",
        "g": "991409971787deec",
        "name": "Bumpless target grid consumption",
        "info": "The error value is used by default to calculate the derivative.\nWhen the target grid consumption (tgc) is changed, the system is takes the derivative of the process variable instead.\nThis prevents irratic behavior during sudden changes of the error or setpoint value.\n\ne.g. you change the setpoint from 0 to 100W \nThe error would make an instantanious jump and cause a huge derivative-term.\nThe pv stays continous and fluent.\n\nAfter 1 control tick the derivative is taken from error again.\nUntil the `tgc` is changed again.",
        "x": 780,
        "y": 440,
        "wires": []
    },
    {
        "id": "d2868e3da06e78d5",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "991409971787deec",
        "name": "Derivative PV",
        "func": "var P1_power = msg.grid_power||0;\nvar P1_last_power = Number(context.get(\"p1_last_power\")) ||0;\n\n// PV derivative\nvar p1_derivative = P1_power - P1_last_power; // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_power\", P1_power);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 500,
        "wires": [
            [
                "5b44917d48154dea"
            ]
        ]
    },
    {
        "id": "6f0b3716cc693cd6",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "991409971787deec",
        "name": "Target grid consumption unchanged",
        "property": "house_target_grid_consumption_in_w",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "",
                "vt": "prev"
            },
            {
                "t": "neq",
                "v": "",
                "vt": "prev"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 780,
        "y": 480,
        "wires": [
            [
                "e8409a2a051286bf"
            ],
            [
                "d2868e3da06e78d5"
            ]
        ]
    },
    {
        "id": "e8409a2a051286bf",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "991409971787deec",
        "name": "Derivative Error",
        "func": "var P1_error = msg.grid_error||0;\nvar P1_last_error = Number(context.get(\"p1_last_error\")) ||0;\n\n// Error derivative\n// note: error = -PV\n// note: for simplicity we assume 1 second time steps\nlet p1_derivative = -(P1_error - P1_last_error); // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_error\", P1_error);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 460,
        "wires": [
            [
                "5b44917d48154dea"
            ]
        ]
    },
    {
        "id": "5b44917d48154dea",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "991409971787deec",
        "name": "Derivative final value",
        "func": "\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1240,
        "y": 480,
        "wires": [
            [
                "028f43a44d1bec69"
            ]
        ]
    },
    {
        "id": "9b70f054ec8bbbb1",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "1fadb46f18a01ebe",
        "name": "Deadband (15W)",
        "func": "// Deadband\n// Stop processing if error is within .. Watt of target grid consumption.\n// This to reduce CPU loads \n\nlet P1_error = msg.grid_error; // Watt\nlet P1_deadband = 15; // Watt\n\n// TODO\n// based on last 'assignable power' and current error, if (error > assignable power) the system will never enter the deadband. And keep calculating each interation.\n// however since we don't know if the is the assignable power will change, until we calculate the Control Value / load balancer\n// we could end up in a deadlock if we simply stop execution here, based on assignable power alone.\n\n// Within Deadband\nif(Math.abs(P1_error) < P1_deadband) {\n    // stop processing\n    node.status({fill:\"yellow\",shape:\"dot\",text:`Halt, ${Math.round(Math.abs(P1_error))} W`});\n    // node.log(`Stopped processing | P1_error is within deadband of ${P1_deadband}`);\n    msg.payload = 'halted by deadband';\n    return msg;\n} \n\n// Outside deadband\nnode.status({fill:\"green\",shape:\"dot\",text:`Pass, ${Math.round(Math.abs(P1_error))} W`});\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 340,
        "wires": [
            [
                "735046e00914a975"
            ]
        ]
    },
    {
        "id": "028f43a44d1bec69",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Calculate corrections",
        "func": "var logdata = \"\";\n\n// Timing\nlet time_last = context.get('time_last') || Date.now(); // Milliseconds\nlet time_current = Date.now(); // Milliseconds\nlet time_delta = (time_current - time_last) / 1000; // Convert to seconds\n// note: due to inherent 1 sec intervals of P1 meter we omit dt terms. This is mostly for bug checking and optimizations.\n\n// Batteries\nvar B_power = msg.batteries_total_power; // charging is positive, discharging negative\nvar anti_windup_threshold = Number(flow.get(\"batteries_total_assignable_power\")) || 0; // max available charge/discharge power.\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = flow.get(\"house_target_grid_consumption_in_w\"); // SP: target value\nvar P1_error = msg.grid_error;  // W (watt), error signal = SP - PV\nvar P1_derivative = msg.grid_derivative; // Derivative of PV, not the error\n\n// PID values\nvar Kp = flow.get(\"house_battery_control_kp\") || 0.75;  // Proportional gain\nvar Ki = flow.get(\"house_battery_control_ki\") || 0;     // Integral gain        Ki = Kp/Ti\nvar Kd = flow.get(\"house_battery_control_kd\") || 0;     // Derivative gain      Kd = Kp*Td\n\n// helpers\nvar I_integral_sum = context.get('I_integral_sum') || 0;\nvar Gm = flow.get(\"master_gain\")||1; // gain scheduling\n\n// optimizations\nvar hysteresis = flow.get(\"house_battery_control_hysteresis_in_w\"); // W (watt)\n\n// advanced settings\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\"); \n\n// -- PID regulator --\n// Proportional term\nlet p_term = Gm * Kp * P1_error;\n\n// Integral term | integrate\nI_integral_sum += P1_error; \n\n// Integral term | apply anti-windup \nlet integral_max = anti_windup_threshold / Ki; // the anti-windup value is set to the current controlable range of the batteries, given by the previous load balancer calculations\nI_integral_sum = Math.min(Math.max(I_integral_sum, -integral_max), integral_max);\n\n// Integral term | the term\nlet i_term = Ki * I_integral_sum;\nlogdata += `anti_windup_threshold=${anti_windup_threshold}, integral_max=${integral_max}| `;\n\n// Differential term\nlet d_term = Gm * Kd * (-P1_derivative); // omitted '/time_delta'. inherent P1 refresh fequency.\n\n// Total PID output\nvar PID_output = p_term + i_term + d_term; // W (watt), the control input for the battery packs\nlogdata += `U(${time_delta}s)[${PID_output}] = P(${Kp})[${p_term}] + I(${Ki})[${i_term}] + D(${Kd})[${d_term}] | `;\n\n// Charging or Discharging states\nvar B_was_charging = context.get(\"batteries_charging_last\") || false;\nvar B_is_charging = PID_output > 0 ? true : false;\n\n// Advanced setting | discharge disabled\nif(isDischargeDisabled && !B_is_charging) {\n    // log explain\n    logdata += `Discharging disabled, PID unwound U(${time_delta})[0]=0+0+0 | `;\n    // Set all PID terms to 0 and unwind integral sum\n    PID_output = 0;\n    p_term = 0;\n    i_term = 0;\n    d_term = 0;\n    I_integral_sum = 0; // unwind\n    // maintain charge scenario\n    B_is_charging = true;\n} else if \n// Advanced setting | hysteresis\n// prevents excessive switching between (dis)charge mode around the zero point.\n// if new PID_output lies within hysteresis, it will not switch charge mode. \n// set hysteresis to 0, to apply no hysteresis\n(B_is_charging !== B_was_charging && Math.abs(PID_output) < hysteresis){\n    // log explain\n    logdata += `Hysteresis prevented charge mode switch from ${B_was_charging ? \"charging\" : \"discharging\"} to ${B_is_charging ? \"charging\" : \"discharging\"} as ${Math.abs(PID_output)}W <= ${hysteresis}(hyst) | `;\n    // prevent negative charging or positive discharging values (not allowed)\n    PID_output = (PID_output < 0 && B_is_charging) || ((PID_output > 0 && !B_is_charging)) ? 0 : PID_output;\n    // maintain previous scenario\n    B_is_charging = B_was_charging;\n} \n\n// save for next iteration\ncontext.set(\"batteries_charging_last\", B_is_charging); //boolean\n\n// OUTFLOW\ncontext.set(\"time_last\", Date.now());\ncontext.set(\"I_integral_sum\", I_integral_sum);\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_charging\", B_is_charging, true);\nRED.util.setMessageProperty(msg, \"I_integral_sum\", I_integral_sum,true);\nmsg.payload = Number(PID_output);\n\n\nreturn [msg, // payload = PID_output\n        { payload: Number(P1_error)},\n        { payload: parseFloat(p_term)},\n        { payload: parseFloat(i_term)},\n        { payload: parseFloat(d_term)},\n        { payload: B_is_charging},\n        { payload: logdata }];",
        "outputs": 7,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 700,
        "wires": [
            [
                "4cafd473afb89158"
            ],
            [
                "235494cc1d2a6b97"
            ],
            [
                "59bee8c6b6be159f"
            ],
            [
                "cfa0372c07314b8d"
            ],
            [
                "526d83d6881fd8ce"
            ],
            [
                "129ec2777a861d77"
            ],
            [
                "53039b668ab0a97e"
            ]
        ],
        "inputLabels": [
            "battery_array"
        ]
    },
    {
        "id": "53039b668ab0a97e",
        "type": "debug",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Logdata",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 1060,
        "wires": []
    },
    {
        "id": "235494cc1d2a6b97",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Error Signal",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_signal"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 730,
        "y": 760,
        "wires": [
            [
                "4854534dc7c83892"
            ]
        ]
    },
    {
        "id": "5c62450063520ee9",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "PID Output",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 730,
        "y": 700,
        "wires": [
            [
                "bc8a24344b2ae2ca"
            ]
        ]
    },
    {
        "id": "d6e0a13720d2ceb3",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Proportinal term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_p_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 920,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "9f823db632bbd13f",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Integral term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_i_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 910,
        "y": 880,
        "wires": [
            []
        ]
    },
    {
        "id": "ea8b44a09b499968",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Differential term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_d_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 920,
        "y": 940,
        "wires": [
            []
        ]
    },
    {
        "id": "d739d29aebbdb0e0",
        "type": "debug",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Charging",
        "active": false,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 900,
        "y": 1060,
        "wires": []
    },
    {
        "id": "bc8a24344b2ae2ca",
        "type": "smooth",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "",
        "property": "payload",
        "action": "sd",
        "count": "8",
        "round": "",
        "mult": "single",
        "reduce": false,
        "x": 900,
        "y": 700,
        "wires": [
            [
                "a79b2b6c56ce7751"
            ]
        ]
    },
    {
        "id": "a79b2b6c56ce7751",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "PID deviation",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output_deviation"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1070,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "4854534dc7c83892",
        "type": "smooth",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "",
        "property": "payload",
        "action": "sd",
        "count": "8",
        "round": "",
        "mult": "single",
        "reduce": false,
        "x": 900,
        "y": 760,
        "wires": [
            [
                "7cdef29145623758"
            ]
        ]
    },
    {
        "id": "7cdef29145623758",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Error deviation",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_deviation"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1080,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "4cafd473afb89158",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Output dampening",
        "func": "// INPUT\nlet PID_unfiltered = msg.payload; // W Watt\nlet PID_last = context.get(\"PID_last\")||0; // W watt\nlet PID_damp = Number(flow.get(\"house_battery_control_pid_output_dampening\"))||0; // 0% - 100%\nPID_damp = PID_damp/100; // to Number\n\n// simple averaging filter\nlet PID_filtered = (1-PID_damp)*PID_unfiltered + (PID_damp)*PID_last;\n\n// OUTFLOW\ncontext.set(\"PID_last\", PID_filtered);\n\n// OUTPUT\nmsg.payload = Number(PID_filtered)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 660,
        "wires": [
            [
                "cbc863ac4c6ce1b8"
            ]
        ]
    },
    {
        "id": "cbc863ac4c6ce1b8",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Output failsafe",
        "func": "// INFLOW\nlet maxCharge = msg.batteries_max_charge_power||undefined;\nlet maxDischarge = msg.batteries_max_discharge_power||undefined;\nlet isCharging = msg.batteries_charging||undefined;\nlet PID_output = msg.payload; // Watt\n\n// No failsafe\nif (maxCharge === undefined || maxDischarge == undefined) {\n    node.status({ fill: \"red\", shape: \"dot\", text: \"disabled\" });\n    node.warn(`Output Failsafe is INACTIVE. Max charge or discharge limits are undefined`);\n    // continue without safeguard\n    return msg;\n} \n\n// limit\nlet limit = 0;\n\n// charging state unknown\nif(isCharging === undefined) {\n    // limit on lowest of charge / discharge\n    limit = Math.min(maxCharge,maxDischarge);    \n}\n// charging state known\nlimit = isCharging ? maxCharge : maxDischarge;\n\n// Safe output\nif (PID_output <= limit){\n    node.status({ fill: \"green\", shape: \"dot\", text: \"safe\" });\n    return msg;\n} \n\n// Unsafe, limit output\nnode.status({ fill: \"yellow\", shape: \"ring\", text: \"power limiting\" });\nmsg.payload = Number(limit);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1080,
        "y": 660,
        "wires": [
            [
                "2ef3fc5bd6a33686",
                "5c62450063520ee9"
            ]
        ]
    },
    {
        "id": "cfa0372c07314b8d",
        "type": "rbe",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 880,
        "wires": [
            [
                "9f823db632bbd13f"
            ]
        ]
    },
    {
        "id": "2ef3fc5bd6a33686",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "7242528b056e3c47",
        "name": "Load distribution",
        "func": "//Debug toggle\nlet debugLog = flow.get(\"LoadDistribution_debug_enabled\") === true;\n\n// INPUT\nvar batteries = msg.batteries; // Battery configuration as provided by `Home Batteries IO` flow\nvar isCharging = msg.batteries_charging; // Are we in a battery charging scenario?\nvar hasChargingLimiter = flow.get(\"has_soc_charging_limiter\") || false; // Battery life improvement\nvar hasReverseDischargePriority = flow.get(\"has_reverse_priority_discharge\") || false; // Prioritize (dis)charging the same battery\nvar logdata = `Charging=${isCharging} | `; // logging for node-red debug node\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\"); // Disallow discharging?\n\n// how much power do the batteries need to compensate?\nvar unassigned_power = Math.round(Math.abs(msg.payload)); // Power in W to compensate using batteries\nlogdata += `Unassigned power ${unassigned_power} W | `;\n\n// inits \nvar solution_array = []; // load distribution solutions\nvar batteries_total_assignable_power = 0; // Current max. available total (dis)charge power. Exceeding this max should trigger the anti-windup routine for the Integral terms\n\n// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n// debug output function\nfunction debug(message) {\n    if (debugLog) {\n        node.warn(message);\n        node.status({fill:\"yellow\",shape:\"ring\",text:\"debugging\"});\n    } else {\n        node.status({fill:\"green\",shape:\"dot\",text:\"operating\"});\n    }\n}\ndebug(`=== Cycle #${Date.now()} ===`);\n\n// battery life improvement (slow charge near max SoC)\n/**\n* @param {number} soc\n* @param {number} max_power\n*/\nfunction chargingLimiter(soc, max_power) {\n    if(max_power < 0) max_power = 0;\n    if (!hasChargingLimiter) return max_power;\n    if (soc >= 98) return Math.min(300, max_power);\n    if (soc >= 95) return Math.min(500, max_power);\n    if (soc >= 85) return Math.min(1500, max_power);\n    return max_power;\n}\nif (isCharging) logdata += `Charge limiting based on SoC | `;\n\n/**\n* battery life improvement (disconnects battery only if the battery is not used for ... seconds)\n* @param {string | number} batteryID\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getStopSolution(batteryID) {\n    // idle time, before stop is given to inverter relay.\n    let time_idle_minimum = flow.get(\"idle_time_minutes\")*60*1000||0; // Milliseconds\n\n    // retrieve last registered active times for each battery based on their ids\n    let lasttime_active = context.get(\"lasttime_active\");\n    \n    // battery exists in register \n    if(lasttime_active[batteryID] !== undefined){\n        // timing\n        let time_last = lasttime_active[batteryID]; // Milliseconds \n        let time_now = Date.now();                  // Milliseconds \n        let time_idle = (time_now - time_last); // Milliseconds\n        \n        // battery is ready for STOP\n        if (time_idle >= time_idle_minimum) return {id: batteryID, mode: CMODE.STOP, power:0}; // STOP or 0 Watt disconnects relay\n        // battery is kept IDLE, while awaiting minimum inactive time\n        logdata += `Idle: ${batteryID} ${Math.round(time_idle/1000)}s | `;\n        return { id: batteryID, mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE, power: 1 }; // 1 Watt keeps battery IDLE, keeping relay engaged\n    }\n\n    // battery missing in register\n    logdata += `'Idle: ${batteryID}' unknown last active time | `;\n    debug(`[IDLE] Battery '${batteryID}' unknown last active time`);\n    return getActiveSolution(batteryID, 1); // set a last active time and engage idle state\n}\nlogdata += \"Idle before stop | \";\n\n/**\n* Get battery solution and register a last active time.\n* @param {any} batteryID\n* @param {number} assigned_power\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getActiveSolution(batteryID, assigned_power){\n    // register battery as active\n    let lasttime_active = context.get(\"lasttime_active\")||[]; // last registered active times for each battery based on their ids\n    lasttime_active[batteryID] = Date.now();\n    context.set(\"lasttime_active\", lasttime_active);\n\n    // solution\n    return {\n        id: batteryID,\n        mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE,\n        power: Math.round(assigned_power)\n    };\n}\n\n// -- BATTERY DISCHARGE PRIORITY\nif (!isCharging && hasReverseDischargePriority) {\n   batteries.reverse();\n}\n\n// -- LOAD BALANCER --\nbatteries.forEach((/** @type {{ id: any; soc: number; soc_min: number; soc_max: number; rs485: string; charging_max: number; discharging_max: any; }} */ battery) => {\n  \n    debug(`[CHECK] Battery ${battery.id}: SoC=${battery.soc}%, Min=${battery.soc_min}%, Max=${battery.soc_max}%, RS485=${battery.rs485}, isCharging=${isCharging}`);\n\n    // track if the battery should be skipped and why\n    let skipReason = null;\n    if (battery.rs485 !== \"enable\") {\n        skipReason = `[SKIP] Battery ${battery.id}: skipped because RS485 is not 'enable'`;\n    } else if (isCharging && battery.soc >= battery.soc_max) {\n        skipReason = `[SKIP] Battery ${battery.id}: skipped because SoC (${battery.soc}%) >= Max (${battery.soc_max}%) while charging`;\n    } else if (!isCharging && battery.soc <= battery.soc_min) {\n        skipReason = `[SKIP] Battery ${battery.id}: skipped because SoC (${battery.soc}%) <= Min (${battery.soc_min}%) while discharging`;\n    } else if (!isCharging && isDischargeDisabled) {\n        skipReason = `[SKIP] Battery ${battery.id}: skipped, discharging was disabled via msg property`;\n    }\n\n    // battery NOT AVAIABLE, skip via soft stop\n    if (skipReason !== null) {\n        debug(skipReason);                          // communicate reason\n        let solution = getStopSolution(battery.id); // get a soft stop solution for this battery\n        solution_array.push(solution);              // add solution, do not update last active time.\n        // next battery\n        return; \n    }\n\n    // battery is AVAILABLE, assign power\n    let battery_assignable_power = isCharging ? chargingLimiter(battery.soc, battery.charging_max) : battery.discharging_max;\n    let assign = Math.min(unassigned_power, battery_assignable_power);\n    \n    // select solution\n    var solution;\n    if (assign <= 0 ) {\n        // no power solution\n        solution = getStopSolution(battery.id); // a soft stop solution\n        assign = 0;\n    } else {\n        // assigned power solution\n        solution = getActiveSolution(battery.id, Math.round(assign));\n    }\n    solution_array.push(solution);\n    \n    // log\n    debug(`[ASSIGN] Battery ${solution.id}: allowed to ${solution.mode} with ${solution.power}W`);\n\n    // remaining power to assign\n    unassigned_power -= assign;\n    batteries_total_assignable_power += Number(battery_assignable_power);\n    //node.warn(`[BATTERY] UPDATE: ID=${battery.id}, new_unassigned=${unassigned_power}W, total_assignable=${batteries_total_assignable_power}W`);\n});\n\n// battery discharge priority - put solutions back in initial order\nif (!isCharging && hasReverseDischargePriority) {\n    solution_array.reverse();\n}\n\n// OUTFLOW\nflow.set(\"batteries_total_assignable_power\", batteries_total_assignable_power); // this is set for the anti-windup calculation in the earlier 'calculate corrections' node, which will pick this up during next iteration.\nlogdata += `batteries_total_assignable_power ${batteries_total_assignable_power} | `;\n\n// OUTPUT\nsolution_array.forEach(solution => { \n    logdata += `Solution: ${solution.id}, ${solution.mode} ${solution.power} W | `;\n});\nRED.util.setMessageProperty(msg, \"solutions\", solution_array,true);\n\n// TWO OUTPUT NODES\nreturn [\n    { payload: logdata },    // debug output\n    msg , // to Home Battery flow\n    ]; ",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\ncontext.set(\"lasttime_active\",[]);",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 1180,
        "wires": [
            [
                "3640364ae79b69ec"
            ],
            [
                "67116260f2e09362"
            ]
        ],
        "inputLabels": [
            "isCharging (boolean)"
        ]
    },
    {
        "id": "3640364ae79b69ec",
        "type": "debug",
        "z": "c1a9925591b564a7",
        "g": "7242528b056e3c47",
        "name": "Load distribution",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 1160,
        "wires": []
    },
    {
        "id": "735046e00914a975",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "1fadb46f18a01ebe",
        "name": "Pass or Halt",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "halted by deadband",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "halted by deadband",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 340,
        "wires": [
            [
                "7636353795317949"
            ],
            [
                "6f0b3716cc693cd6"
            ]
        ]
    },
    {
        "id": "67116260f2e09362",
        "type": "link out",
        "z": "c1a9925591b564a7",
        "g": "419f0c8ca2d0601a",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 225,
        "y": 1240,
        "wires": []
    },
    {
        "id": "999fa888c5e5e56b",
        "type": "comment",
        "z": "c1a9925591b564a7",
        "g": "419f0c8ca2d0601a",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 170,
        "y": 1180,
        "wires": []
    },
    {
        "id": "7636353795317949",
        "type": "link out",
        "z": "c1a9925591b564a7",
        "g": "1fadb46f18a01ebe",
        "name": "go to End",
        "mode": "link",
        "links": [
            "fb0eeeb7ddf70b28"
        ],
        "x": 1090,
        "y": 340,
        "wires": [],
        "inputLabels": [
            "Halt"
        ],
        "l": true
    },
    {
        "id": "fb0eeeb7ddf70b28",
        "type": "link in",
        "z": "c1a9925591b564a7",
        "g": "419f0c8ca2d0601a",
        "name": "link to End",
        "links": [
            "7636353795317949"
        ],
        "x": 105,
        "y": 1240,
        "wires": [
            [
                "67116260f2e09362"
            ]
        ]
    },
    {
        "id": "e52abd366fd81c67",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Is charging",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "",
        "service": "",
        "x": 1070,
        "y": 1000,
        "wires": [
            []
        ]
    },
    {
        "id": "0c60f5ca1f25e34b",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Config action",
        "func": "const value = msg.payload;\nconst target = \"input_boolean.house_battery_control_is_charging\";\n\nmsg.payload = {\n    \"action\": value?\"input_boolean.turn_on\":\"input_boolean.turn_off\",\n    \"target\": {\n        \"entity_id\": [target]\n    },\n    \"data\": {}\n}\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 1000,
        "wires": [
            [
                "e52abd366fd81c67"
            ]
        ]
    },
    {
        "id": "de5eedecc97994b4",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "name": "Target",
        "property": "house_target_grid_consumption_in_w",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 390,
        "y": 120,
        "wires": [
            [
                "8591421549956ee1"
            ],
            [
                "8baa774c2b027a30"
            ]
        ]
    },
    {
        "id": "f6b196faaa1eff2f",
        "type": "debug",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "name": "Target",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "house_target_grid_consumption_in_w",
        "targetType": "msg",
        "statusVal": "house_target_grid_consumption_in_w",
        "statusType": "auto",
        "x": 790,
        "y": 100,
        "wires": []
    },
    {
        "id": "9f357837ab8c534f",
        "type": "server-state-changed",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Strategy changes",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_text.house_battery_strategy_active_sub_strategy",
                "input_select.house_battery_strategy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 480,
        "wires": [
            [
                "fae5e93e1a95d5ed"
            ]
        ]
    },
    {
        "id": "fae5e93e1a95d5ed",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full stop",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1855,
        "y": 480,
        "wires": [
            [
                "cfc64f84a4532120"
            ]
        ],
        "l": false
    },
    {
        "id": "0d36f7d78102ff6d",
        "type": "server-state-changed",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Full stop trigger",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.ev_is_charging"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 560,
        "wires": [
            [
                "8439426a432c3f9c"
            ]
        ]
    },
    {
        "id": "8439426a432c3f9c",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1855,
        "y": 560,
        "wires": [
            [
                "cfc64f84a4532120"
            ]
        ],
        "l": false
    },
    {
        "id": "59bee8c6b6be159f",
        "type": "rbe",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 820,
        "wires": [
            [
                "d6e0a13720d2ceb3"
            ]
        ]
    },
    {
        "id": "526d83d6881fd8ce",
        "type": "rbe",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 940,
        "wires": [
            [
                "ea8b44a09b499968"
            ]
        ]
    },
    {
        "id": "129ec2777a861d77",
        "type": "rbe",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 1000,
        "wires": [
            [
                "0c60f5ca1f25e34b",
                "d739d29aebbdb0e0"
            ]
        ]
    },
    {
        "id": "9b57c772140e180c",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "74fd3ebe5074968f",
        "name": "Active sub strategy text field",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_text.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_text.house_battery_strategy_active_sub_strategy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.target}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_text",
        "service": "set_value",
        "x": 2520,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "2097b7751515ee67",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "74fd3ebe5074968f",
        "name": "User strategy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "master_strategy",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1750,
        "y": 780,
        "wires": [
            [
                "e15313e16be26caf"
            ]
        ]
    },
    {
        "id": "e15313e16be26caf",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "74fd3ebe5074968f",
        "name": "is Self-con.",
        "property": "master_strategy",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Self-consumption",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1910,
        "y": 780,
        "wires": [
            [
                "a05a0479326a6694"
            ]
        ]
    },
    {
        "id": "a05a0479326a6694",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "74fd3ebe5074968f",
        "name": "sub strategy UI value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.house_battery_strategy_active_sub_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "ui_value",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 2100,
        "y": 780,
        "wires": [
            [
                "f4fb55acf071af78"
            ]
        ]
    },
    {
        "id": "f4fb55acf071af78",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "74fd3ebe5074968f",
        "name": "On difference",
        "func": "// This flow is the target flow\nmsg.target = \"Self-consumption\";\n\n// Block when equal\nif(msg.ui_value === msg.target) return null;\n\n// Pass otherwise\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2300,
        "y": 780,
        "wires": [
            [
                "9b57c772140e180c"
            ]
        ]
    },
    {
        "id": "c0cde540d8bc752b",
        "type": "link out",
        "z": "c1a9925591b564a7",
        "g": "e2c385d3b03e57bc",
        "name": "update UI",
        "mode": "link",
        "links": [
            "e3e8e650d75e615e",
            "d46f95eb7ddf515a"
        ],
        "x": 180,
        "y": 200,
        "wires": [],
        "l": true
    },
    {
        "id": "e3e8e650d75e615e",
        "type": "link in",
        "z": "c1a9925591b564a7",
        "g": "74fd3ebe5074968f",
        "name": "Update UI - active sub-strategy",
        "links": [
            "c0cde540d8bc752b"
        ],
        "x": 1645,
        "y": 780,
        "wires": [
            [
                "2097b7751515ee67"
            ]
        ]
    },
    {
        "id": "26460a293ad3466a",
        "type": "link in",
        "z": "9c775009242a5a6b",
        "g": "0bd042d837a592d2",
        "name": "Full stop",
        "links": [],
        "x": 120,
        "y": 180,
        "wires": [
            [
                "e8765c8c2f9d4414"
            ]
        ],
        "l": true
    },
    {
        "id": "c1e3cac395f0b1cb",
        "type": "link out",
        "z": "9c775009242a5a6b",
        "g": "cd31f39c38ae6c21",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 505,
        "y": 180,
        "wires": []
    },
    {
        "id": "e8765c8c2f9d4414",
        "type": "function",
        "z": "9c775009242a5a6b",
        "name": "Stop all batteries",
        "func": "// INPUT\n// Home Battery Start payload\n\n// Process\nlet solution_array = [];\n\n// Add a solution per battery\nmsg.batteries.forEach(battery => {\n    solution_array.push({ id: battery.id, \n    mode: \"stop\", // disengages Marstek Battery\n    power: 0 }); // set power to 0W\n});\n\n// OUTPUT\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "c1e3cac395f0b1cb",
                "f322b34904d4944b"
            ]
        ]
    },
    {
        "id": "9972c8e39e2f5320",
        "type": "comment",
        "z": "9c775009242a5a6b",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "5b9d0683cbf0cf39",
        "type": "comment",
        "z": "9c775009242a5a6b",
        "g": "cd31f39c38ae6c21",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 560,
        "y": 120,
        "wires": []
    },
    {
        "id": "fd021c46fa86cb98",
        "type": "comment",
        "z": "9c775009242a5a6b",
        "g": "0bd042d837a592d2",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "c23de8e8ab568b52",
        "type": "api-call-service",
        "z": "9c775009242a5a6b",
        "g": "36d3d713969b2832",
        "name": "Active sub strategy text field",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_text.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_text.house_battery_strategy_active_sub_strategy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.target}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_text",
        "service": "set_value",
        "x": 1340,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "f322b34904d4944b",
        "type": "api-current-state",
        "z": "9c775009242a5a6b",
        "g": "36d3d713969b2832",
        "name": "User strategy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "master_strategy",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 300,
        "wires": [
            [
                "72ce79bf6a03a3d6"
            ]
        ]
    },
    {
        "id": "72ce79bf6a03a3d6",
        "type": "switch",
        "z": "9c775009242a5a6b",
        "g": "36d3d713969b2832",
        "name": "is Full stop",
        "property": "master_strategy",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full stop",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 730,
        "y": 300,
        "wires": [
            [
                "b890d6c270915ce5"
            ]
        ]
    },
    {
        "id": "b890d6c270915ce5",
        "type": "api-current-state",
        "z": "9c775009242a5a6b",
        "g": "36d3d713969b2832",
        "name": "sub strategy UI value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.house_battery_strategy_active_sub_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "ui_value",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 920,
        "y": 300,
        "wires": [
            [
                "3363b72314098044"
            ]
        ]
    },
    {
        "id": "3363b72314098044",
        "type": "function",
        "z": "9c775009242a5a6b",
        "g": "36d3d713969b2832",
        "name": "On difference",
        "func": "// This flow is the target flow\nmsg.target = \"Full stop\";\n\n// Block when equal\nif(msg.ui_value === msg.target) return null;\n\n// Pass otherwise\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1120,
        "y": 300,
        "wires": [
            [
                "c23de8e8ab568b52"
            ]
        ]
    },
    {
        "id": "803767396fa679ed",
        "type": "inject",
        "z": "68f2a63283f405e0",
        "name": "21:30 switch off",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "30 21 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 150,
        "y": 60,
        "wires": [
            [
                "411cefe91d46cc88"
            ]
        ]
    },
    {
        "id": "411cefe91d46cc88",
        "type": "api-call-service",
        "z": "68f2a63283f405e0",
        "name": "Close-in boiler off",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.athom_smart_plug_v2_f255b3_switch"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "switch",
        "service": "turn_off",
        "x": 390,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "23e1b7cd9875d4bb",
        "type": "api-call-service",
        "z": "68f2a63283f405e0",
        "name": "Close-in boiler on",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.athom_smart_plug_v2_f255b3_switch"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "switch",
        "service": "turn_on",
        "x": 390,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "62c90b19dd6db3a7",
        "type": "inject",
        "z": "68f2a63283f405e0",
        "name": "07:00 switch on",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 07 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 150,
        "y": 120,
        "wires": [
            [
                "23e1b7cd9875d4bb"
            ]
        ]
    },
    {
        "id": "9afb63606c29bf41",
        "type": "function",
        "z": "a5fa1fcc1b306096",
        "name": "get all entities",
        "func": "// Get all entities from global\nconst allEntities = global.get('homeassistant.homeAssistant.states');\nmsg.all_entities = allEntities;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 280,
        "wires": [
            [
                "58d6c7b724b10666",
                "e740f315724f3d1a",
                "e60f983d4392917d",
                "9d500a3c6b154999"
            ]
        ]
    },
    {
        "id": "765f822f5f64f3a9",
        "type": "inject",
        "z": "a5fa1fcc1b306096",
        "name": "Initialize",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "180",
        "crontab": "",
        "once": true,
        "onceDelay": "1",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 200,
        "y": 280,
        "wires": [
            [
                "9afb63606c29bf41"
            ]
        ]
    },
    {
        "id": "c659d02c18f850a9",
        "type": "ui_dropdown",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "",
        "label": "Battery 1 | RS485 control mode",
        "tooltip": "Enabled/disabled sensor",
        "place": "Select option",
        "group": "dc57595d461379a1",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 1010,
        "y": 260,
        "wires": [
            [
                "3323e8b0f6c0ee75"
            ]
        ]
    },
    {
        "id": "3323e8b0f6c0ee75",
        "type": "function",
        "z": "a5fa1fcc1b306096",
        "g": "e9025250f91b9eb0",
        "name": "set input_text",
        "func": "const value = msg.payload;\nconst target = msg.topic;\n\nmsg.payload = {\n    \"action\": \"input_text.set_value\",\n    \"target\": {\n        \"entity_id\": [target]\n    },\n    \"data\": {\n        \"value\": value\n    }\n}\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 284,
        "wires": [
            [
                "edf81a129949f7af"
            ]
        ]
    },
    {
        "id": "028a4c9c51e7eccd",
        "type": "ui_dropdown",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "",
        "label": "Battery 2 | RS485 control mode",
        "tooltip": "",
        "place": "Select option",
        "group": "54991681ca09e29d",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 1010,
        "y": 300,
        "wires": [
            [
                "3323e8b0f6c0ee75"
            ]
        ]
    },
    {
        "id": "aa7fa18db5e480cc",
        "type": "ui_dropdown",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "",
        "label": "Battery 3 | RS485 control mode",
        "tooltip": "",
        "place": "Select option",
        "group": "ab91aa3e54c948ec",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 1010,
        "y": 340,
        "wires": [
            [
                "3323e8b0f6c0ee75"
            ]
        ]
    },
    {
        "id": "64d24e6545b1f86f",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.hbc_entity_m1_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 260,
        "wires": [
            [
                "c659d02c18f850a9"
            ]
        ],
        "l": false
    },
    {
        "id": "edf81a129949f7af",
        "type": "api-call-service",
        "z": "a5fa1fcc1b306096",
        "g": "e9025250f91b9eb0",
        "name": "Set persistant (dynamic)",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": true,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 1610,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "58d6c7b724b10666",
        "type": "function",
        "z": "a5fa1fcc1b306096",
        "g": "937c3952d6bb2e19",
        "name": "selects",
        "func": "const allEntities = RED.util.getMessageProperty(msg,\"all_entities\");\n\nlet selectOptions = [];\n\n// Loop through all entities\nfor (const [entityId, entityState] of Object.entries(allEntities)) {\n    // Filter on 'sensor' domain\n    if (entityId.startsWith('select.')) {\n\n        // Label for user: use friendly_name, or entity_id\n        const name = entityState.attributes.friendly_name || entityId;\n        const obj = {};\n        obj[name] = entityId;\n        selectOptions.push(obj); \n    }\n}\n\n// Provide the UI Dropdown node with options\nmsg.options = selectOptions;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 280,
        "wires": [
            [
                "64d24e6545b1f86f",
                "3805ea99193c192c",
                "79aede9e29152eb5"
            ]
        ]
    },
    {
        "id": "c04872de572310e0",
        "type": "inject",
        "z": "a5fa1fcc1b306096",
        "g": "9873daf982c701e7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 300,
        "y": 1000,
        "wires": [
            [
                "f8b1b99ed5b34b59",
                "c223121624220b75"
            ]
        ]
    },
    {
        "id": "f8b1b99ed5b34b59",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "9873daf982c701e7",
        "name": "get config",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.gekozen_sensor_entity_picker",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "entity_id",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 460,
        "y": 1000,
        "wires": [
            [
                "7a4b7e517f4cf506"
            ]
        ]
    },
    {
        "id": "7bc1318c6e070317",
        "type": "debug",
        "z": "a5fa1fcc1b306096",
        "g": "9873daf982c701e7",
        "name": "Value from configured config",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 840,
        "y": 980,
        "wires": []
    },
    {
        "id": "7a4b7e517f4cf506",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "9873daf982c701e7",
        "name": "get value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "{{ entity_id }}",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 620,
        "y": 980,
        "wires": [
            [
                "7bc1318c6e070317"
            ]
        ]
    },
    {
        "id": "c223121624220b75",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "9873daf982c701e7",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.m1_battery_charging_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 740,
        "y": 1060,
        "wires": [
            []
        ]
    },
    {
        "id": "7df02adfcd4128ea",
        "type": "ui_dropdown",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "",
        "label": "Battery 1 | Power",
        "tooltip": "e.g. sensor.marstek_m1_battery_power",
        "place": "Select option",
        "group": "dc57595d461379a1",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 970,
        "y": 500,
        "wires": [
            [
                "3323e8b0f6c0ee75"
            ]
        ]
    },
    {
        "id": "e740f315724f3d1a",
        "type": "function",
        "z": "a5fa1fcc1b306096",
        "g": "937c3952d6bb2e19",
        "name": "sensors",
        "func": "const allEntities = RED.util.getMessageProperty(msg,\"all_entities\");\n\nlet selectOptions = [];\n\n// Loop through all entities\nfor (const [entityId, entityState] of Object.entries(allEntities)) {\n    // Filter on 'sensor' domain\n    if (entityId.startsWith('sensor.')) {\n\n        // Label for user: use friendly_name, or entity_id\n        const name = entityState.attributes.friendly_name || entityId;\n        const obj = {};\n        obj[name] = entityId;\n        selectOptions.push(obj); \n    }\n}\n\n// Provide the UI Dropdown node with options\nmsg.options = selectOptions;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 460,
        "wires": [
            [
                "967320583833cbad",
                "892e1829e04b12de",
                "15d0a55aad6896dc",
                "a0c32b752bed188a",
                "521c90d39990183f"
            ]
        ]
    },
    {
        "id": "3805ea99193c192c",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.hbc_entity_m2_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 300,
        "wires": [
            [
                "028a4c9c51e7eccd"
            ]
        ],
        "l": false
    },
    {
        "id": "79aede9e29152eb5",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.hbc_entity_m3_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 340,
        "wires": [
            [
                "aa7fa18db5e480cc"
            ]
        ],
        "l": false
    },
    {
        "id": "967320583833cbad",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.gekozen_sensor_entity_picker",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 500,
        "wires": [
            [
                "7df02adfcd4128ea"
            ]
        ],
        "l": false
    },
    {
        "id": "e60f983d4392917d",
        "type": "function",
        "z": "a5fa1fcc1b306096",
        "g": "937c3952d6bb2e19",
        "name": "booleans",
        "func": "const allEntities = RED.util.getMessageProperty(msg,\"all_entities\");\n\nlet selectOptions = [];\n\n// Loop through all entities\nfor (const [entityId, entityState] of Object.entries(allEntities)) {\n    // Filter on 'sensor' domain\n    if (entityId.startsWith('input_boolean.')) {\n\n        // Label for user: use friendly_name, or entity_id\n        const name = entityState.attributes.friendly_name || entityId;\n        const obj = {};\n        obj[name] = entityId;\n        selectOptions.push(obj); \n    }\n}\n\n// Provide the UI Dropdown node with options\nmsg.options = selectOptions;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 104,
        "wires": [
            [
                "1cb5651fd3cd98f7",
                "11b529145ce5d713",
                "45e6ad9cded99ea2"
            ]
        ]
    },
    {
        "id": "9d500a3c6b154999",
        "type": "function",
        "z": "a5fa1fcc1b306096",
        "g": "937c3952d6bb2e19",
        "name": "numbers",
        "func": "const allEntities = RED.util.getMessageProperty(msg,\"all_entities\");\n\nlet selectOptions = [];\n\n// Loop through all entities\nfor (const [entityId, entityState] of Object.entries(allEntities)) {\n    // Filter on 'sensor' domain\n    if (entityId.startsWith('number.')) {\n\n        // Label for user: use friendly_name, or entity_id\n        const name = entityState.attributes.friendly_name || entityId;\n        const obj = {};\n        obj[name] = entityId;\n        selectOptions.push(obj); \n    }\n}\n\n// Provide the UI Dropdown node with options\nmsg.options = selectOptions;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 680,
        "wires": [
            [
                "a71c7d4cd9e9ecb6",
                "1a684759a42f72ef",
                "c0114cdc7b15fba9",
                "9a53b5725a7ae343"
            ]
        ]
    },
    {
        "id": "1cb5651fd3cd98f7",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.hbc_has_battery_1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 104,
        "wires": [
            [
                "7867622927f0d077"
            ]
        ],
        "l": false
    },
    {
        "id": "a71c7d4cd9e9ecb6",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.hbc_entity_m1_max_charge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 680,
        "wires": [
            [
                "a755b33f1730e891"
            ]
        ],
        "l": false
    },
    {
        "id": "a755b33f1730e891",
        "type": "ui_dropdown",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "",
        "label": "Battery 1 | max charge power",
        "tooltip": "Max charging power in kWh",
        "place": "Select option",
        "group": "dc57595d461379a1",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 1000,
        "y": 680,
        "wires": [
            [
                "3323e8b0f6c0ee75"
            ]
        ]
    },
    {
        "id": "1a684759a42f72ef",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.hbc_entity_m1_max_discharge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 720,
        "wires": [
            [
                "14124387949b0fee"
            ]
        ],
        "l": false
    },
    {
        "id": "14124387949b0fee",
        "type": "ui_dropdown",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "",
        "label": "Battery 1 | max discharge power",
        "tooltip": "Max discharging power in kWh",
        "place": "Select option",
        "group": "dc57595d461379a1",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 1010,
        "y": 720,
        "wires": [
            [
                "3323e8b0f6c0ee75"
            ]
        ]
    },
    {
        "id": "7867622927f0d077",
        "type": "ui_switch",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "Battery 1 | enabled",
        "label": "Enable",
        "tooltip": "Enable the use of battery #1",
        "group": "dc57595d461379a1",
        "order": 5,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "topic",
        "topicType": "msg",
        "style": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "onicon": "",
        "oncolor": "",
        "offvalue": "false",
        "offvalueType": "bool",
        "officon": "",
        "offcolor": "",
        "animate": false,
        "className": "",
        "x": 970,
        "y": 104,
        "wires": [
            [
                "c2f36f14e0eb1058"
            ]
        ]
    },
    {
        "id": "ebb77d5a4bb73b23",
        "type": "ui_dropdown",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "",
        "label": "Battery 1 | State of Charge (SoC)",
        "tooltip": "e.g. sensor.marstek_m1_battery_state_of_charge",
        "place": "Select option",
        "group": "dc57595d461379a1",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 1020,
        "y": 540,
        "wires": [
            [
                "3323e8b0f6c0ee75"
            ]
        ]
    },
    {
        "id": "892e1829e04b12de",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.hbc_entity_m1_battery_state_of_charge",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 540,
        "wires": [
            [
                "ebb77d5a4bb73b23"
            ]
        ],
        "l": false
    },
    {
        "id": "c0114cdc7b15fba9",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.hbc_entity_m1_charging_cutoff_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 780,
        "wires": [
            [
                "b39feae3a058ace5"
            ]
        ],
        "l": false
    },
    {
        "id": "b39feae3a058ace5",
        "type": "ui_dropdown",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "",
        "label": "Battery 1 | Charging cutoff capacity",
        "tooltip": "e.g. number.marstek_m1_charging_cutoff_capacity",
        "place": "Select option",
        "group": "dc57595d461379a1",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 1020,
        "y": 780,
        "wires": [
            [
                "3323e8b0f6c0ee75"
            ]
        ]
    },
    {
        "id": "9a53b5725a7ae343",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.hbc_entity_m1_discharging_cutoff_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 820,
        "wires": [
            [
                "1f8079b3d993b6ff"
            ]
        ],
        "l": false
    },
    {
        "id": "1f8079b3d993b6ff",
        "type": "ui_dropdown",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "",
        "label": "Battery 1 | Disharging cutoff capacity",
        "tooltip": "e.g. number.marstek_m1_discharging_cutoff_capacity",
        "place": "Select option",
        "group": "dc57595d461379a1",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 1030,
        "y": 820,
        "wires": [
            [
                "3323e8b0f6c0ee75"
            ]
        ]
    },
    {
        "id": "15d0a55aad6896dc",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.hbc_entity_p1_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 460,
        "wires": [
            [
                "3c2735a64344066e"
            ]
        ],
        "l": false
    },
    {
        "id": "3c2735a64344066e",
        "type": "ui_dropdown",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "",
        "label": "P1 meter power",
        "tooltip": "See: /config/template_sensors/template_sensor_house_battery_control.yaml",
        "place": "Select option",
        "group": "9bfeb0b645386875",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 960,
        "y": 460,
        "wires": [
            [
                "3323e8b0f6c0ee75"
            ]
        ]
    },
    {
        "id": "a0c32b752bed188a",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.hbc_entity_m1_inverter_state",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 576,
        "wires": [
            [
                "77426ad1f331d3f8"
            ]
        ],
        "l": false
    },
    {
        "id": "77426ad1f331d3f8",
        "type": "ui_dropdown",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "",
        "label": "Battery 1 | Inverter state",
        "tooltip": "e.g. sensor.marstek_m1_inverter_state",
        "place": "Select option",
        "group": "dc57595d461379a1",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 990,
        "y": 576,
        "wires": [
            [
                "3323e8b0f6c0ee75"
            ]
        ]
    },
    {
        "id": "521c90d39990183f",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.hbc_entity_m1_battery_remaining_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 616,
        "wires": [
            [
                "af5a6883b065a9fc"
            ]
        ],
        "l": false
    },
    {
        "id": "af5a6883b065a9fc",
        "type": "ui_dropdown",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "",
        "label": "Battery 1 | Remaining capacity (kWh)",
        "tooltip": "e.g. sensor.marstek_m1_battery_remaining_capacity",
        "place": "Select option",
        "group": "dc57595d461379a1",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 1030,
        "y": 616,
        "wires": [
            [
                "3323e8b0f6c0ee75"
            ]
        ]
    },
    {
        "id": "11b529145ce5d713",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.hbc_has_battery_2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 140,
        "wires": [
            [
                "4d3e69a2b3b4e1bd"
            ]
        ],
        "l": false
    },
    {
        "id": "45e6ad9cded99ea2",
        "type": "api-current-state",
        "z": "a5fa1fcc1b306096",
        "g": "0d03e2a33f3a64b3",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.hbc_has_battery_3",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 725,
        "y": 180,
        "wires": [
            [
                "8d2077410a644d6e"
            ]
        ],
        "l": false
    },
    {
        "id": "4d3e69a2b3b4e1bd",
        "type": "ui_switch",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "Battery 2 | enabled",
        "label": "Enable",
        "tooltip": "Enable the use of battery #2",
        "group": "54991681ca09e29d",
        "order": 5,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "topic",
        "topicType": "msg",
        "style": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "onicon": "",
        "oncolor": "",
        "offvalue": "false",
        "offvalueType": "bool",
        "officon": "",
        "offcolor": "",
        "animate": false,
        "className": "",
        "x": 970,
        "y": 140,
        "wires": [
            [
                "c2f36f14e0eb1058"
            ]
        ]
    },
    {
        "id": "8d2077410a644d6e",
        "type": "ui_switch",
        "z": "a5fa1fcc1b306096",
        "g": "795071f84cc65671",
        "name": "Battery 3 | enabled",
        "label": "Enable",
        "tooltip": "Enable the use of battery #3",
        "group": "ab91aa3e54c948ec",
        "order": 5,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "topic",
        "topicType": "msg",
        "style": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "onicon": "",
        "oncolor": "",
        "offvalue": "false",
        "offvalueType": "bool",
        "officon": "",
        "offcolor": "",
        "animate": false,
        "className": "",
        "x": 970,
        "y": 180,
        "wires": [
            [
                "c2f36f14e0eb1058"
            ]
        ]
    },
    {
        "id": "c2f36f14e0eb1058",
        "type": "function",
        "z": "a5fa1fcc1b306096",
        "g": "e9025250f91b9eb0",
        "name": "set input_boolean",
        "func": "const value = msg.payload;\nconst target = msg.topic;\n\nmsg.payload = {\n    \"action\": value?\"input_boolean.turn_on\":\"input_boolean.turn_off\",\n    \"target\": {\n        \"entity_id\": [target]\n    },\n    \"data\": {}\n}\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1350,
        "y": 100,
        "wires": [
            [
                "edf81a129949f7af"
            ]
        ]
    },
    {
        "id": "31c856d793e13a5a",
        "type": "server-state-changed",
        "z": "9607d149c944acaa",
        "g": "e0392b58deafbac5",
        "name": "PID preset selected",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.house_battery_control_pid_presets"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 150,
        "y": 100,
        "wires": [
            [
                "3276d3d01db332b2"
            ]
        ]
    },
    {
        "id": "25cba6b981ba48e9",
        "type": "api-call-service",
        "z": "9607d149c944acaa",
        "g": "e0392b58deafbac5",
        "name": "Kp",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_kp"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "6fb5deee8886bb3e",
        "type": "api-call-service",
        "z": "9607d149c944acaa",
        "g": "e0392b58deafbac5",
        "name": "Ki",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_ki"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "60b793ebc78a6296",
        "type": "api-call-service",
        "z": "9607d149c944acaa",
        "g": "e0392b58deafbac5",
        "name": "Kd",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_kd"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "3276d3d01db332b2",
        "type": "function",
        "z": "9607d149c944acaa",
        "g": "e0392b58deafbac5",
        "name": "Presets",
        "func": "// See: house_battery_control.yaml > input_select: > house_battery_control_pid_presets\nconst preset = RED.util.getMessageProperty(msg,\"payload\");\nnode.status({fill:\"green\",shape:\"dot\",text:`${preset}`});\n\n\n// Default values\nlet Kp = 0; // Proportional gain\nlet Ki = 0; // Integral gain\nlet Kd = 0; // Differentiating gain\nlet Si = 0; // % Input smoothing (a Low pass moving average filter)\nlet So = 0; // % Output smoothing (a Low pass moving average filter)\n\nswitch (preset) {\n    // For people who have unstable systems with every other preset\n    case \"Very safe\":\n        Kp = 0.1;\n        Ki = 0.1;\n        Si = 0; // without Kd, this is preferred to be zero.\n        So = 10; // %\n        break;\n    // Good starting point for most\n    case \"Safe\":\n        Kp = 0.3;\n        Ki = 0.3;\n        Kd = 0.1;\n        Si = 20; // %\n        So = 0; // %\n        break;\n    // Gitcodebob's October 2025 settings for 3.2kWp PV and 5kW battery transformer power\n    case \"Regular\":\n        Kp = 0.3;\n        Ki = 0.4;\n        Kd = 0.8;\n        Si = 50; // % This high amount of filtering allows the stronger Kd\n        So = 10; // %\n        break;\n    default:\n        // Don't change values\n        return null;\n}\n\n// Prepare for three outputs\nreturn [\n    { \"payload\": Kp },\n    { \"payload\": Ki },\n    { \"payload\": Kd },\n    { \"payload\": Si },\n    { \"payload\": So }\n];",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 100,
        "wires": [
            [
                "25cba6b981ba48e9"
            ],
            [
                "6fb5deee8886bb3e"
            ],
            [
                "60b793ebc78a6296"
            ],
            [
                "19c8fac4c2f92720"
            ],
            [
                "a50096cebdd74d31"
            ]
        ]
    },
    {
        "id": "19c8fac4c2f92720",
        "type": "api-call-service",
        "z": "9607d149c944acaa",
        "g": "e0392b58deafbac5",
        "name": "Input Smooth",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_signal_dampening"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 530,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "a50096cebdd74d31",
        "type": "api-call-service",
        "z": "9607d149c944acaa",
        "g": "e0392b58deafbac5",
        "name": "Output Smoothing",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output_dampening"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 550,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "cfdae21b426b2b66",
        "type": "function",
        "z": "d0dfbedc3d5c0181",
        "name": "Example: select new strategy every minute",
        "func": "function selectOptionBasedOnMinute() {\n  // 1. Get the current date and time\n  const now = new Date();\n\n  // 2. Extract the current minute (0 to 59)\n  const minute = now.getMinutes();\n\n  // 3. Use the modulo operator to map the minute to 0, 1, or 2\n  // 60 minutes / 3 options = 20 minutes per option (roughly)\n  const remainder = minute % 3; // remainder will be 0, 1, or 2\n\n  // 4. Map the result (0, 1, 2) to the desired options (1, 2, 3)\n  const selectedOption = remainder + 1;\n\n  console.log(`Current Minute: ${minute}`);\n  console.log(`Selected Option: ${selectedOption}`);\n\n  return selectedOption;\n}\n\n// Example usage:\nmsg.demo = selectOptionBasedOnMinute();\nnode.status({fill:\"green\",shape:\"dot\",text:`Option = ${msg.demo}`});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 180,
        "wires": [
            [
                "4d386d6e3bcdc2ab"
            ]
        ]
    },
    {
        "id": "fecdc20c8bd6e2e3",
        "type": "comment",
        "z": "d0dfbedc3d5c0181",
        "name": "Home Battery Super Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 140,
        "y": 40,
        "wires": []
    },
    {
        "id": "f96598748a8bae33",
        "type": "link in",
        "z": "d0dfbedc3d5c0181",
        "g": "0ebd537b21479320",
        "name": "Super strategy",
        "links": [],
        "x": 165,
        "y": 180,
        "wires": [
            [
                "cfdae21b426b2b66"
            ]
        ]
    },
    {
        "id": "0a1e9d8398df4f95",
        "type": "comment",
        "z": "d0dfbedc3d5c0181",
        "g": "0ebd537b21479320",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "3911c0977b5b0e4d",
        "type": "link out",
        "z": "d0dfbedc3d5c0181",
        "g": "7b06827dfd179ecf",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 985,
        "y": 180,
        "wires": []
    },
    {
        "id": "f03f0f67c20f201e",
        "type": "comment",
        "z": "d0dfbedc3d5c0181",
        "g": "7b06827dfd179ecf",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 1040,
        "y": 120,
        "wires": []
    },
    {
        "id": "4d386d6e3bcdc2ab",
        "type": "switch",
        "z": "d0dfbedc3d5c0181",
        "name": "",
        "property": "demo",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "2",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "3",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 630,
        "y": 180,
        "wires": [
            [
                "4ec9510153a16a6c"
            ],
            [
                "96c47534fac35b7e"
            ],
            [
                "a467deabe85bee3d"
            ]
        ]
    },
    {
        "id": "4ec9510153a16a6c",
        "type": "link call",
        "z": "d0dfbedc3d5c0181",
        "name": "",
        "links": [
            "26460a293ad3466a"
        ],
        "linkType": "static",
        "timeout": "30",
        "x": 760,
        "y": 140,
        "wires": [
            [
                "3911c0977b5b0e4d"
            ]
        ]
    },
    {
        "id": "96c47534fac35b7e",
        "type": "link call",
        "z": "d0dfbedc3d5c0181",
        "name": "",
        "links": [
            "7a0cd93e9df76c48"
        ],
        "linkType": "static",
        "timeout": "30",
        "x": 790,
        "y": 180,
        "wires": [
            [
                "3911c0977b5b0e4d"
            ]
        ]
    },
    {
        "id": "a467deabe85bee3d",
        "type": "link call",
        "z": "d0dfbedc3d5c0181",
        "name": "",
        "links": [
            "a5e9e484430e1720"
        ],
        "linkType": "static",
        "timeout": "30",
        "x": 770,
        "y": 220,
        "wires": [
            [
                "3911c0977b5b0e4d"
            ]
        ]
    },
    {
        "id": "91c8e3521703335b",
        "type": "comment",
        "z": "d0dfbedc3d5c0181",
        "name": "About this example",
        "info": "This example illustraties a \"Super Strategy\".\n\nWhich is a strategy that governs the selection of other sub-strategies and stays in control.\nThis is the advised flow pattern to design advanced strategies and reuse existing flows.",
        "x": 330,
        "y": 100,
        "wires": []
    },
    {
        "id": "e2fbefe0a92c8b87",
        "type": "link in",
        "z": "0199f18df097aa8f",
        "g": "130c2473c32bd786",
        "name": "Timed",
        "links": [],
        "x": 175,
        "y": 180,
        "wires": [
            [
                "c669dabc5fa09ae2"
            ]
        ]
    },
    {
        "id": "7dce7367da5a0686",
        "type": "comment",
        "z": "0199f18df097aa8f",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 130,
        "y": 40,
        "wires": []
    },
    {
        "id": "df3ea4464fdd6253",
        "type": "comment",
        "z": "0199f18df097aa8f",
        "g": "130c2473c32bd786",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 120,
        "y": 120,
        "wires": []
    },
    {
        "id": "9ce9ba35eda99c46",
        "type": "link out",
        "z": "0199f18df097aa8f",
        "g": "7d5d20208cad641e",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 65,
        "y": 840,
        "wires": []
    },
    {
        "id": "f0ecfb0d25bf1e0f",
        "type": "comment",
        "z": "0199f18df097aa8f",
        "g": "7d5d20208cad641e",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 120,
        "y": 780,
        "wires": []
    },
    {
        "id": "942bbcc0b79ffec6",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "bf29fe0ee25b592b",
        "name": "Period A start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_a1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_a1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 550,
        "y": 120,
        "wires": [
            [
                "84cab4abb90d1f7a"
            ]
        ]
    },
    {
        "id": "84cab4abb90d1f7a",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "bf29fe0ee25b592b",
        "name": "Period A end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_a2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_a2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 120,
        "wires": [
            [
                "dfa151f727d68ad2"
            ]
        ]
    },
    {
        "id": "97a70bb440ca8984",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "f9db7587adf69bfa",
        "name": "Period B start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_b1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_b1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 220,
        "wires": [
            [
                "d82f98b7e93d3eac"
            ]
        ]
    },
    {
        "id": "d82f98b7e93d3eac",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "f9db7587adf69bfa",
        "name": "Period B end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_b2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_b2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 220,
        "wires": [
            [
                "78f0fd728bec341e"
            ]
        ]
    },
    {
        "id": "dfa151f727d68ad2",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "bf29fe0ee25b592b",
        "name": "Strat during A",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_a",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_a",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 120,
        "wires": [
            [
                "cb3cb1afa5ceda3d"
            ]
        ]
    },
    {
        "id": "78f0fd728bec341e",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "f9db7587adf69bfa",
        "name": "Strat during B",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_b",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_b",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 220,
        "wires": [
            [
                "83e9ba4b673403f7"
            ]
        ]
    },
    {
        "id": "cb3cb1afa5ceda3d",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "f9db7587adf69bfa",
        "name": "Has period B",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_period_b",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_period_b",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 220,
        "wires": [
            [
                "97a70bb440ca8984"
            ]
        ]
    },
    {
        "id": "57eb83baaca02db6",
        "type": "inject",
        "z": "0199f18df097aa8f",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 130,
        "y": 260,
        "wires": [
            [
                "c669dabc5fa09ae2"
            ]
        ]
    },
    {
        "id": "8eaa8fd948be1fad",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 460,
        "wires": [
            [
                "3108d0a11fcf542f"
            ]
        ]
    },
    {
        "id": "8de067121fbfd939",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "set Strat A",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_a",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 420,
        "wires": [
            [
                "7775e04676756c1e",
                "83a1051adc959e8c"
            ]
        ]
    },
    {
        "id": "3108d0a11fcf542f",
        "type": "switch",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "has period B",
        "property": "house_battery_strategy_timed_has_period_b",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 500,
        "wires": [
            [
                "7775e04676756c1e",
                "30c98e7546f78b88"
            ],
            [
                "3c647acc433c766d"
            ]
        ]
    },
    {
        "id": "7bc56c05b65b8a56",
        "type": "function",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "config A",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_a1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_a2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 440,
        "wires": [
            [
                "9353d27b9ba49389"
            ]
        ]
    },
    {
        "id": "9353d27b9ba49389",
        "type": "time-range-switch",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "Period A",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 440,
        "wires": [
            [
                "8de067121fbfd939"
            ],
            [
                "8eaa8fd948be1fad"
            ]
        ]
    },
    {
        "id": "3c647acc433c766d",
        "type": "function",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "config B",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_b1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_b2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 580,
        "wires": [
            [
                "3919eb10fa97d04d"
            ]
        ]
    },
    {
        "id": "3919eb10fa97d04d",
        "type": "time-range-switch",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "Period B",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 580,
        "wires": [
            [
                "98697d12039611bf"
            ],
            [
                "c7b14890ae2578d1"
            ]
        ]
    },
    {
        "id": "98697d12039611bf",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "set Strat B",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_b",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 560,
        "wires": [
            [
                "7775e04676756c1e",
                "0cde47a17becc07d"
            ]
        ]
    },
    {
        "id": "c7b14890ae2578d1",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 600,
        "wires": [
            [
                "cd148224059fdaae"
            ]
        ]
    },
    {
        "id": "c669dabc5fa09ae2",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "115c88f19a6e3add",
        "name": "Default Strat",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_0",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_0",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 120,
        "wires": [
            [
                "942bbcc0b79ffec6"
            ]
        ]
    },
    {
        "id": "31b352bcf0b5fa22",
        "type": "api-call-service",
        "z": "0199f18df097aa8f",
        "g": "635af4e3e7a252ce",
        "name": "Active sub strategy text field",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_text.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_text.house_battery_strategy_active_sub_strategy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.target}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_text",
        "service": "set_value",
        "x": 1540,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "1ff8dd8a7bb8c098",
        "type": "link call",
        "z": "0199f18df097aa8f",
        "g": "635af4e3e7a252ce",
        "name": "Sub strategy",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1090,
        "y": 740,
        "wires": [
            [
                "9ce9ba35eda99c46"
            ]
        ]
    },
    {
        "id": "7775e04676756c1e",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "Select flow",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "timed_strategy",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 850,
        "y": 520,
        "wires": [
            [
                "1ff8dd8a7bb8c098",
                "4a78e8501fe52d32",
                "08145a57bee1f1d9"
            ]
        ]
    },
    {
        "id": "83a1051adc959e8c",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "A",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 420,
        "wires": []
    },
    {
        "id": "30c98e7546f78b88",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 460,
        "wires": []
    },
    {
        "id": "0cde47a17becc07d",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "B",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 560,
        "wires": []
    },
    {
        "id": "5518e5a61cfe69c6",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 600,
        "wires": []
    },
    {
        "id": "4a78e8501fe52d32",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "635af4e3e7a252ce",
        "name": "Target",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "target",
        "targetType": "msg",
        "statusVal": "target",
        "statusType": "auto",
        "x": 1070,
        "y": 680,
        "wires": []
    },
    {
        "id": "568d79926c754129",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "e0ed6822bd47bca9",
        "name": "Period C start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_c1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_c1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 320,
        "wires": [
            [
                "c5ad0abaf680c75b"
            ]
        ]
    },
    {
        "id": "c5ad0abaf680c75b",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "e0ed6822bd47bca9",
        "name": "Period C end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_c2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_c2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 320,
        "wires": [
            [
                "7d02914f2aaf8cda"
            ]
        ]
    },
    {
        "id": "7d02914f2aaf8cda",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "e0ed6822bd47bca9",
        "name": "Strat during C",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_c",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_c",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 320,
        "wires": [
            [
                "7bc56c05b65b8a56"
            ]
        ]
    },
    {
        "id": "83e9ba4b673403f7",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "e0ed6822bd47bca9",
        "name": "Has period C",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_period_c",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_period_c",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 320,
        "wires": [
            [
                "568d79926c754129"
            ]
        ]
    },
    {
        "id": "cd148224059fdaae",
        "type": "switch",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "has period C",
        "property": "house_battery_strategy_timed_has_period_c",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 640,
        "wires": [
            [
                "7775e04676756c1e",
                "5518e5a61cfe69c6"
            ],
            [
                "7d3b97b9302eaf46"
            ]
        ]
    },
    {
        "id": "319d772dc1a3f413",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "C",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 700,
        "wires": []
    },
    {
        "id": "7d3b97b9302eaf46",
        "type": "function",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "config C",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_c1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_c2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 720,
        "wires": [
            [
                "8a7f41b1448ba249"
            ]
        ]
    },
    {
        "id": "8a7f41b1448ba249",
        "type": "time-range-switch",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "Period C",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 720,
        "wires": [
            [
                "1ac5564bbb7c6d7f"
            ],
            [
                "273d6cb45a191bcc"
            ]
        ]
    },
    {
        "id": "1ac5564bbb7c6d7f",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "set Strat C",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_c",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 700,
        "wires": [
            [
                "319d772dc1a3f413",
                "7775e04676756c1e"
            ]
        ]
    },
    {
        "id": "273d6cb45a191bcc",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 740,
        "wires": [
            [
                "7775e04676756c1e",
                "90f20fce6d8576ce"
            ]
        ]
    },
    {
        "id": "90f20fce6d8576ce",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 740,
        "wires": []
    },
    {
        "id": "08145a57bee1f1d9",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "635af4e3e7a252ce",
        "name": "sub strategy UI value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.house_battery_strategy_active_sub_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "ui_value",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1120,
        "y": 620,
        "wires": [
            [
                "e3ff5478297e2295"
            ]
        ]
    },
    {
        "id": "e3ff5478297e2295",
        "type": "function",
        "z": "0199f18df097aa8f",
        "g": "635af4e3e7a252ce",
        "name": "On difference",
        "func": "// Block when equal\nif(msg.ui_value === msg.target) return null;\n\n// Pass otherwise\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1320,
        "y": 620,
        "wires": [
            [
                "31b352bcf0b5fa22"
            ]
        ]
    },
    {
        "id": "6f08540f9f5fe765",
        "type": "function",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Max power solution",
        "func": "// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// battery life improvement (slow charge near max SoC)\n/**\n* @param {number} soc\n* @param {number} max_power\n*/\nfunction chargingLimiter(soc, max_power) {\n    if (soc == 100) return Math.min(0, max_power);\n    if (soc >= 98) return Math.min(300, max_power);\n    if (soc >= 95) return Math.min(500, max_power);\n    if (soc >= 85) return Math.min(1500, max_power);\n    return max_power;\n}\n\n// build solution\nmsg.batteries.forEach(battery => {\n    solution_array.push({\n        id: battery.id,\n        mode: \"charge\",\n        power: chargingLimiter(battery.soc, battery.charging_max)\n    });\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 260,
        "wires": [
            [
                "c62978a7d936dfba"
            ]
        ]
    },
    {
        "id": "2b46959cdb3a5434",
        "type": "comment",
        "z": "517b5f5313a242c5",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 140,
        "y": 40,
        "wires": []
    },
    {
        "id": "62fe191e903de8b2",
        "type": "link in",
        "z": "517b5f5313a242c5",
        "g": "1df1a3a3dcbc7925",
        "name": "Charge",
        "links": [],
        "x": 185,
        "y": 180,
        "wires": [
            [
                "975b518a9af0ba5e"
            ]
        ]
    },
    {
        "id": "3c519efd38a22bf5",
        "type": "comment",
        "z": "517b5f5313a242c5",
        "g": "1df1a3a3dcbc7925",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 130,
        "y": 120,
        "wires": []
    },
    {
        "id": "b5bd859bd4a37c5a",
        "type": "link out",
        "z": "517b5f5313a242c5",
        "g": "843e88284fbc94bf",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 75,
        "y": 440,
        "wires": []
    },
    {
        "id": "9e4f8a5401e67f74",
        "type": "comment",
        "z": "517b5f5313a242c5",
        "g": "843e88284fbc94bf",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 130,
        "y": 380,
        "wires": []
    },
    {
        "id": "975b518a9af0ba5e",
        "type": "api-current-state",
        "z": "517b5f5313a242c5",
        "g": "9e0b88ccf18279a0",
        "name": "Desired energy reserve",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_timed_target_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_target_energy",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 390,
        "y": 160,
        "wires": [
            [
                "8f45bbf25d832781",
                "a46cfe2ab1e217ad"
            ]
        ]
    },
    {
        "id": "17407e109402eedb",
        "type": "api-current-state",
        "z": "517b5f5313a242c5",
        "g": "9e0b88ccf18279a0",
        "name": "Or charge at max power?",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_max_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_max_power",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 870,
        "y": 160,
        "wires": [
            [
                "59946b67fc40e542"
            ]
        ]
    },
    {
        "id": "8f45bbf25d832781",
        "type": "api-current-state",
        "z": "517b5f5313a242c5",
        "g": "9e0b88ccf18279a0",
        "name": "Desired charging power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_timed_target_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_target_power",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 630,
        "y": 160,
        "wires": [
            [
                "17407e109402eedb"
            ]
        ]
    },
    {
        "id": "59946b67fc40e542",
        "type": "switch",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Check desired energy reserve",
        "property": "batteries_available_energy",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "house_battery_strategy_timed_target_energy",
                "vt": "msg"
            },
            {
                "t": "gte",
                "v": "house_battery_strategy_timed_target_energy",
                "vt": "msg"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 410,
        "y": 300,
        "wires": [
            [
                "9e65fbe7fb9407f5"
            ],
            [
                "558a963fa8d37e13"
            ]
        ],
        "info": "batteries_available_energy is calculated in the Start flow"
    },
    {
        "id": "ded0c5838fefe02a",
        "type": "link call",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Call flow",
        "links": [
            "26460a293ad3466a"
        ],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1040,
        "y": 340,
        "wires": [
            [
                "5e0b433df0b89085",
                "25349ae9d88ba324"
            ]
        ]
    },
    {
        "id": "55e38b7af412c9b6",
        "type": "link call",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Call flow",
        "links": [
            "7a0cd93e9df76c48"
        ],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1040,
        "y": 300,
        "wires": [
            [
                "25349ae9d88ba324",
                "e0daa87d53914f89"
            ]
        ]
    },
    {
        "id": "9e65fbe7fb9407f5",
        "type": "switch",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Charge at max power",
        "property": "house_battery_strategy_timed_has_max_power",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 660,
        "y": 280,
        "wires": [
            [
                "6f08540f9f5fe765"
            ],
            [
                "11a3c17551b6872e"
            ]
        ]
    },
    {
        "id": "5e0b433df0b89085",
        "type": "debug",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Full stop",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1280,
        "y": 340,
        "wires": []
    },
    {
        "id": "e0daa87d53914f89",
        "type": "debug",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Regulated",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1290,
        "y": 300,
        "wires": []
    },
    {
        "id": "8f3f500f37b1f30a",
        "type": "debug",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Maximum",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1280,
        "y": 260,
        "wires": []
    },
    {
        "id": "51c020c73fa6193c",
        "type": "function",
        "z": "517b5f5313a242c5",
        "g": "69b5b1e8def42772",
        "name": "Min/max",
        "func": "\n// Lower bound\nlet output = msg.payload | 0; // kWh\noutput = Math.max(msg.payload, 0);\n\n// Upper bound\nlet max_reserve = 0; // kWh\nmsg.batteries.forEach(battery => {\n    max_reserve += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\noutput = Math.min(output, max_reserve);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 60,
        "wires": [
            [
                "5145f9dafdea029b"
            ]
        ]
    },
    {
        "id": "5145f9dafdea029b",
        "type": "api-call-service",
        "z": "517b5f5313a242c5",
        "g": "69b5b1e8def42772",
        "name": "Set desired energy reserve",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_timed_target_energy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.payload}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 780,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "a46cfe2ab1e217ad",
        "type": "rbe",
        "z": "517b5f5313a242c5",
        "g": "69b5b1e8def42772",
        "name": "Desired energy changed",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 390,
        "y": 60,
        "wires": [
            [
                "51c020c73fa6193c"
            ]
        ]
    },
    {
        "id": "11a3c17551b6872e",
        "type": "function",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Regulated power",
        "func": "// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = msg.house_battery_strategy_timed_target_power;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 300,
        "wires": [
            [
                "55e38b7af412c9b6"
            ]
        ]
    },
    {
        "id": "558a963fa8d37e13",
        "type": "function",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Full stop ",
        "func": "msg.target = \"Full stop\";\nnode.status({fill:\"grey\",shape:\"dot\",text:`${Math.round(msg.batteries_available_energy*100)/100} of ${msg.house_battery_strategy_timed_target_energy} kWh in reserve`});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 340,
        "wires": [
            [
                "ded0c5838fefe02a"
            ]
        ]
    },
    {
        "id": "9421868a18b49122",
        "type": "api-call-service",
        "z": "517b5f5313a242c5",
        "g": "50913cc784b36803",
        "name": "Active sub strategy text field",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_text.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_text.house_battery_strategy_active_sub_strategy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.target}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_text",
        "service": "set_value",
        "x": 1100,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "c62978a7d936dfba",
        "type": "change",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Continue",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Charge",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1040,
        "y": 260,
        "wires": [
            [
                "8f3f500f37b1f30a",
                "25349ae9d88ba324"
            ]
        ]
    },
    {
        "id": "639f30448513315c",
        "type": "switch",
        "z": "517b5f5313a242c5",
        "g": "50913cc784b36803",
        "name": "is Charge",
        "property": "master_strategy",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Charge",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 500,
        "y": 480,
        "wires": [
            [
                "db167c26a387f791"
            ]
        ]
    },
    {
        "id": "4be8af1b84064f71",
        "type": "api-current-state",
        "z": "517b5f5313a242c5",
        "g": "50913cc784b36803",
        "name": "User strategy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "master_strategy",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 480,
        "wires": [
            [
                "639f30448513315c"
            ]
        ]
    },
    {
        "id": "db167c26a387f791",
        "type": "api-current-state",
        "z": "517b5f5313a242c5",
        "g": "50913cc784b36803",
        "name": "sub strategy UI value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.house_battery_strategy_active_sub_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "ui_value",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 680,
        "y": 480,
        "wires": [
            [
                "be7ea7d80408d0b2"
            ]
        ]
    },
    {
        "id": "be7ea7d80408d0b2",
        "type": "function",
        "z": "517b5f5313a242c5",
        "g": "50913cc784b36803",
        "name": "On difference",
        "func": "// Block when equal\nif(msg.ui_value === msg.target) return null;\n\n// Pass otherwise\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 880,
        "y": 480,
        "wires": [
            [
                "9421868a18b49122"
            ]
        ]
    },
    {
        "id": "2c4ec860ab1a8f79",
        "type": "link in",
        "z": "95489b12daee74f5",
        "g": "ee5f9b06bf7efa46",
        "name": "Dynamic",
        "links": [],
        "x": 165,
        "y": 180,
        "wires": [
            [
                "81b460c063969182"
            ]
        ]
    },
    {
        "id": "57a9ce1a5a7bb9ef",
        "type": "comment",
        "z": "95489b12daee74f5",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "471fda4979e7fc76",
        "type": "comment",
        "z": "95489b12daee74f5",
        "g": "ee5f9b06bf7efa46",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "45ca4e9b170ae0e4",
        "type": "link out",
        "z": "95489b12daee74f5",
        "g": "ff30c86c22bf31c8",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 55,
        "y": 340,
        "wires": []
    },
    {
        "id": "c855da432b5a589a",
        "type": "comment",
        "z": "95489b12daee74f5",
        "g": "ff30c86c22bf31c8",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 110,
        "y": 280,
        "wires": []
    },
    {
        "id": "2e5b6b44c86f80e3",
        "type": "api-render-template",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Cheapest",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{}",
        "resultsLocation": "dynamic.data_cheapest",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 460,
        "y": 580,
        "wires": [
            [
                "34a30e529baf678b"
            ]
        ]
    },
    {
        "id": "0799b280bf62758e",
        "type": "api-render-template",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Expensive",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "",
        "resultsLocation": "dynamic.data_expensive",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 470,
        "y": 640,
        "wires": [
            [
                "1908addf7c5bfb93"
            ]
        ]
    },
    {
        "id": "5cb60087e09c8852",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Complete message",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 920,
        "wires": []
    },
    {
        "id": "34a30e529baf678b",
        "type": "json",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "",
        "property": "dynamic.data_cheapest",
        "action": "obj",
        "pretty": false,
        "x": 555,
        "y": 580,
        "wires": [
            [
                "af541182589224a7"
            ]
        ],
        "l": false
    },
    {
        "id": "1908addf7c5bfb93",
        "type": "json",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "",
        "property": "dynamic.data_expensive",
        "action": "obj",
        "pretty": false,
        "x": 575,
        "y": 640,
        "wires": [
            [
                "da4428dd14db9967"
            ]
        ],
        "l": false
    },
    {
        "id": "adbbd358b213f08e",
        "type": "function",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Determine dynamic strategy",
        "func": "// Extract start date objects\nlet start_cheapest = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.start\"));\nlet start_expensive = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_expensive.start\"));\nlet isCheapestNext = true;\nlet lastCheapestPrice = context.last_cheapest_price || 0;\nlet deltaThreshold = parseFloat(RED.util.getMessageProperty(msg,\"dynamic.min_delta_cents\")/100) || 0; // 100 cents = 1 Cr\n\n// Enums\nconst STRATEGY = {\n    CHEAPEST: \"Charge\", \n    NEUTRAL: \"Charge PV\",\n    EXPENSIVE: \"Self-consumption\"\n}\n\n// Conversion\nconst CONVERSION_RATE = parseFloat(RED.util.getMessageProperty(msg,\"dynamic.value_conversion\")) || 1;\n\n// Check if the Date objects are valid. If 'Invalid Date', stop and warn the user.\nif (isNaN(start_cheapest.getTime()) || isNaN(start_expensive.getTime())) {\n    node.warn(`One or both dates are invalid. Cheap = ${start_cheapest}, Expensive = ${start_expensive}`);\n    msg.log ? msg.log.push(`One or both dates are invalid. Cheap = ${start_cheapest}, Expensive = ${start_expensive}`):null;\n}\n\n// Check if cheapest lies before expensive\nif (start_cheapest < start_expensive) {\n    msg.log ? msg.log.push(`Cheapest moment lies before expensive moment. Cheapest moment: ${start_cheapest}, Expensive = ${start_expensive}`): null;\n    // store the cheapest price to compare it with future expensive rates, to determine if it's economical to discharge.\n    context.last_cheapest_price = RED.util.getMessageProperty(msg, \"dynamic.data_cheapest.average\"); // /kWh rate\n    lastCheapestPrice = context.last_cheapest_price;\n    msg.log ? msg.log.push(`Cheapest price set to ${lastCheapestPrice}`):null;\n}\n\nif (lastCheapestPrice == 0) {\n    msg.log ? msg.log.push(`I can't recall the tariff used for charging. Cheapest price set to ${lastCheapestPrice}`):null;\n}\n\n// // Format the Date object to HH:MM based on locale options.\n// // We use 'nl-NL' locale, but any will work if it uses : as separator\n// const startCheapHHMM = start_cheapest.toLocaleTimeString('nl-NL', {\n//     hour: '2-digit',        // Ensure the hour is two digits (e.g., 03)\n//     minute: '2-digit',      // Ensure the minute is two digits (e.g., 00)\n//     hour12: false           // Force 24-hour format (00-23)\n// });                         // Result: \"03:00\"\n// msg.cheapest.startHHMM = startCheapHHMM;\n\n\n// const endHHMM = end.toLocaleTimeString('nl-NL', {\n//     hour: '2-digit',        // Ensure the hour is two digits (e.g., 03)\n//     minute: '2-digit',      // Ensure the minute is two digits (e.g., 00)\n//     hour12: false           // Force 24-hour format (00-23)\n// });   \n\n// is_now\n/** @type {boolean} */\nconst cheapestIsNow = RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.is_now\");\n/** @type {boolean} */\nconst expensiveIsNow = RED.util.getMessageProperty(msg, \"dynamic.data_expensive.is_now\");\n\n// Determine if it is economical to start charging\nmsg.dynamic.strategy = STRATEGY.NEUTRAL;\n// average price expensive\nconst lastExpensivePrice = RED.util.getMessageProperty(msg, \"dynamic.data_expensive.average\"); // /kWh rate\n// delta >  0,06 = charging is economical\nconst delta = (lastExpensivePrice - lastCheapestPrice) / CONVERSION_RATE; // \n\n// UI values\nmsg.dynamic.avg_cheapest_tariff = parseFloat((lastCheapestPrice / CONVERSION_RATE).toFixed(2));\nmsg.dynamic.avg_expensive_tariff = parseFloat((lastExpensivePrice / CONVERSION_RATE).toFixed(2));\nmsg.dynamic.avg_delta = parseFloat(delta.toFixed(2));\n\n// Set strategy\nif (cheapestIsNow) msg.dynamic.strategy = STRATEGY.CHEAPEST;\nif (expensiveIsNow && delta >= deltaThreshold) {\n    msg.dynamic.strategy = STRATEGY.EXPENSIVE;\n} else if(expensiveIsNow) {\n    // log\n    msg.log ? msg.log.push(`Expensive period, but not using batteries. The tariff difference between cheap and expensive periods is too small: ${(lastExpensivePrice / CONVERSION_RATE).toFixed(4)}-${(lastCheapestPrice / CONVERSION_RATE).toFixed(4) }=${delta.toFixed(4)} < ${deltaThreshold}.`) : null;    \n}\n\n// Store the strategy in flow-context. The 'Execution' area will read from the flow-context.\nflow.set(\"dynamic_strategy\",msg.dynamic.strategy);\n\n// Node status\nnode.status({ fill: \"blue\", shape: \"dot\", text: `${msg.dynamic.strategy}; ${cheapestIsNow} + ${expensiveIsNow} @ ${delta.toFixed(4)}` });\n\n// Log\nmsg.log ? msg.log.push(`Dynamic strat set to ${msg.dynamic.strategy}. \nCheapest period now? ${cheapestIsNow}. \nExpensive period now? ${expensiveIsNow}.`):null;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 760,
        "wires": [
            [
                "5cb60087e09c8852",
                "89368e429aa3d7d0",
                "e83d728f6cf5d437",
                "dc266592c79676c7",
                "ea704e53eb20315f",
                "cba4fb540a66e4e6",
                "6e287097dc4e0236",
                "403a9dfa33392328",
                "67e38494d0337403"
            ]
        ]
    },
    {
        "id": "ec06caa7c9e6a95d",
        "type": "change",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "name": "Set strategy",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "dynamic_strategy",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 200,
        "wires": [
            [
                "2b50d9094cb8a9a8"
            ]
        ]
    },
    {
        "id": "31e4a5e372bcb73f",
        "type": "link call",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "name": "Sub-strategy",
        "links": [],
        "linkType": "dynamic",
        "timeout": "3",
        "x": 690,
        "y": 200,
        "wires": [
            [
                "45ca4e9b170ae0e4"
            ]
        ]
    },
    {
        "id": "89368e429aa3d7d0",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Cheapest Start",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_cheapest_start"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.start).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 820,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "e83d728f6cf5d437",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Cheapest End",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_cheapest_end"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.end).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 820,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "dc266592c79676c7",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Expensive Start",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_expensive_start"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_expensive.start).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 820,
        "y": 720,
        "wires": [
            []
        ]
    },
    {
        "id": "ea704e53eb20315f",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Expensive End",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_expensive_end"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_expensive.end).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 820,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "8cddc8961385f28e",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "name": "Sub-strategy",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "target",
        "targetType": "msg",
        "statusVal": "target",
        "statusType": "auto",
        "x": 690,
        "y": 160,
        "wires": []
    },
    {
        "id": "c0fe420fa716d4ca",
        "type": "inject",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Every 30 min (cron)",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "*/30 0-23 * * *",
        "once": false,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 380,
        "y": 420,
        "wires": [
            [
                "1990213302cf1876"
            ]
        ]
    },
    {
        "id": "81b460c063969182",
        "type": "switch",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "name": "Has strategy",
        "property": "dynamic_strategy",
        "propertyType": "flow",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 330,
        "y": 180,
        "wires": [
            [
                "e5f74756a260df5b"
            ],
            [
                "ec06caa7c9e6a95d"
            ]
        ]
    },
    {
        "id": "e5f74756a260df5b",
        "type": "change",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "name": "Set Full stop",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Full stop",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 160,
        "wires": [
            [
                "2b50d9094cb8a9a8"
            ]
        ]
    },
    {
        "id": "16efd2b03d6dece5",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "28a2ae1ba720d063",
        "name": "Active sub strategy text field",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_text.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_text.house_battery_strategy_active_sub_strategy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.target}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_text",
        "service": "set_value",
        "x": 1380,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "6e2f9d4be7e18c3a",
        "type": "inject",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 1060,
        "wires": [
            [
                "92e35d100ca61070"
            ]
        ]
    },
    {
        "id": "92e35d100ca61070",
        "type": "api-render-template",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "Cheapest",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "cheapest",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 500,
        "y": 1060,
        "wires": [
            [
                "30af788462a325c7"
            ]
        ]
    },
    {
        "id": "30af788462a325c7",
        "type": "json",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "",
        "property": "cheapest",
        "action": "obj",
        "pretty": false,
        "x": 595,
        "y": 1060,
        "wires": [
            [
                "d05798a95b8cf195"
            ]
        ],
        "l": false
    },
    {
        "id": "d05798a95b8cf195",
        "type": "api-render-template",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "Expensive",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    lowest=false,\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "expensive",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 750,
        "y": 1060,
        "wires": [
            [
                "04d57a78a2fc3095"
            ]
        ]
    },
    {
        "id": "04d57a78a2fc3095",
        "type": "json",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "",
        "property": "expensive",
        "action": "obj",
        "pretty": false,
        "x": 855,
        "y": 1060,
        "wires": [
            [
                "320df01bc7436680",
                "d8004c43e9b3d8d0",
                "99545071b9bdfd66"
            ]
        ],
        "l": false
    },
    {
        "id": "320df01bc7436680",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "Cheap",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "cheapest.start",
        "targetType": "msg",
        "statusVal": "cheapest.start",
        "statusType": "auto",
        "x": 990,
        "y": 1100,
        "wires": []
    },
    {
        "id": "d8004c43e9b3d8d0",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "Expensive",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "expensive.start",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1010,
        "y": 1140,
        "wires": []
    },
    {
        "id": "1f3454b85f32ab4c",
        "type": "api-render-template",
        "z": "95489b12daee74f5",
        "g": "1237795be79af24c",
        "name": "All Zonneplan",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    include_tomorrow=true,\n    hours=\"all\",\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "all_data",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 480,
        "y": 1700,
        "wires": [
            [
                "3f94e4f380add2e8"
            ]
        ]
    },
    {
        "id": "338407c8c442244c",
        "type": "inject",
        "z": "95489b12daee74f5",
        "g": "1237795be79af24c",
        "name": "Fetch",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 1700,
        "wires": [
            [
                "1f3454b85f32ab4c"
            ]
        ]
    },
    {
        "id": "3f94e4f380add2e8",
        "type": "json",
        "z": "95489b12daee74f5",
        "g": "1237795be79af24c",
        "name": "",
        "property": "all_data",
        "action": "obj",
        "pretty": false,
        "x": 595,
        "y": 1700,
        "wires": [
            [
                "079e2531ed154c01"
            ]
        ],
        "l": false
    },
    {
        "id": "1990213302cf1876",
        "type": "delay",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 560,
        "y": 420,
        "wires": [
            [
                "127bc4a04263b3c0"
            ]
        ]
    },
    {
        "id": "98d7f59f0b7eab92",
        "type": "api-current-state",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Source",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_data_source",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.data_source",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 380,
        "wires": [
            [
                "5534a44cf66a84bd"
            ]
        ]
    },
    {
        "id": "de24e0e941d08b62",
        "type": "function",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Data source settings",
        "func": "/*    From cheapes-energy-hours macro\n      See: https://github.com/TheFes/cheapest-energy-hours/blob/main/documentation/1-source_data.md#data-provider-settings\n\n      - None (default selection)\n      - Zonneplan\n      - Amber Electric\n      - EasyEnergy, EnergyZero (core)\n      - ENTSO-E\n      - Frank Energie\n      - GE-Spot\n      - Tibber, Nordpool (core)\n      - Tibber (custom)\n      - Nordpool (custom)\n      - PVPC (Spain)\n      - Octopus Energy\n      - Omie\n*/\n\nswitch (msg.dynamic.data_source) {\n      case \"None\":\n            // Handle the 'None' case (e.g., no supplier selected or data is unavailable)\n            msg.log.push(\"No data source selected.\");\n            // Add config here...\n            break;\n\n      case \"Zonneplan\":\n            // Code for Zonneplan (a Dutch energy supplier)\n            msg.log.push(\"Processing Zonneplan data.\");\n            // Add config here...\n            msg.dynamic.sensor='sensor.zonneplan_current_electricity_tariff'; // when using: https://github.com/fsaris/home-assistant-zonneplan-one\n            msg.dynamic.attr_all='forecast';\n            msg.dynamic.value_key='electricity_price';\n            msg.dynamic.value_conversion = 10000000; // whole currency / kWh\n            break;\n\n      case \"Amber Electric\":\n            // Code for Amber Electric (Australian energy retailer)\n            msg.log.push(\"Processing Amber Electric data.\");\n            // Add config here...\n            msg.dynamic.attr_all='forecasts'; \n            msg.dynamic.time_key='start_time'; \n            msg.dynamic.value_key='per_kwh';\n            break;\n\n      case \"EasyEnergy, EnergyZero (core)\":\n            // Code for EasyEnergy and EnergyZero (core/default implementation)\n            msg.log.push(\"Processing EasyEnergy/EnergyZero core data.\");\n            // Add config here...\n            break;\n\n      case \"ENTSO-E\":\n            // Code for ENTSO-E (European Network of Transmission System Operators for Electricity)\n            msg.log.push(\"Processing ENTSO-E data.\");\n            // Add config here...\n            msg.dynamic.attr_today='prices_today'; \n            msg.dynamic.attr_tomorrow='prices_tomorrow'; \n            msg.dynamic.time_key='time';\n            msg.dynamic.value_key='price';\n            break;\n\n      case \"Frank Energie\":\n            // Code for Frank Energie (Dutch energy supplier)\n            msg.log.push(\"Processing Frank Energie data.\");\n            // Add config here...\n            msg.dynamic.attr_all = 'prices'; \n            msg.dynamic.time_key = 'from'; \n            msg.dynamic.value_key = 'price';\n            break;\n\n      case \"GE-Spot\":\n            // Code for GE-Spot (Global Electric Spot price)\n            msg.log.push(\"Processing GE-Spot data.\");\n            // Add config here...\n            msg.dynamic.attr_today = 'today_hourly_prices'; // using the hourly version. today_interval_prices is per 15 mins\n            msg.dynamic.attr_tomorrow = 'tomorrow_hourly_prices'; // using the hourly version\n            msg.dynamic.time_key = 'time'; \n            msg.dynamic.value_key = 'value';\n            break;\n\n      case \"Tibber, Nordpool (core)\":\n            // Code for Tibber and Nordpool (core/default implementation)\n            msg.log.push(\"Processing Tibber/Nordpool core data.\");\n            // Add config here...\n            msg.dynamic.sensor = 'sensor.tibber_ceh_prices';\n            msg.dynamic.attr_today = 'today';\n            msg.dynamic.attr_tomorrow = 'tomorrow';\n            msg.dynamic.time_key = 'start';\n            msg.dynamic.value_key = 'value';\n            msg.dynamic.datetime_in_data = true; // datetime is in the data\n            break;\n\n      case \"Tibber (custom)\":\n            // Code for a custom Tibber setup/configuration\n            msg.log.push(\"Processing Tibber custom data.\");\n            // Add config here...\n            msg.dynamic.attr_today = 'today';\n            msg.dynamic.attr_tomorrow = 'tomorrow';\n            msg.dynamic.datetime_in_data = false;\n            break;\n\n      case \"Nordpool (custom)\":\n            // Code for a custom Nordpool setup/configuration\n            msg.log.push(\"Processing Nordpool custom data.\");\n            // Add config here...\n            break;\n\n      case \"PVPC (Spain)\":\n            // Code for PVPC (Voluntary Price for Small Consumers in Spain)\n            msg.log.push(\"Processing Spanish PVPC data.\");\n            // Add config here...\n            break;\n\n      case \"Octopus Energy\":\n            // Code for Octopus Energy (UK/international energy supplier)\n            msg.log.push(\"Processing Octopus Energy data.\");\n            // Add config here...\n            msg.dynamic.attr_all = 'rates'; \n            msg.dynamic.value_key = 'value_incl_vat';\n            break;\n\n      case \"Omie\":\n            // Code for Omie (Iberian Energy Market Operator)\n            msg.log.push(\"Processing Omie data.\");\n            // Add config here...\n            break;\n\n      default:\n            // Code to execute if the supplier does not match any of the above cases\n            node.warn(`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            msg.log.push(`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            // Add default error handling...\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 500,
        "wires": [
            [
                "7f75e4fa1c2d86a0"
            ]
        ]
    },
    {
        "id": "5534a44cf66a84bd",
        "type": "api-current-state",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Cheapest N hrs",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_cheapest_hrs",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.cheapest_hrs",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 960,
        "y": 380,
        "wires": [
            [
                "1d49e10959ab22bc"
            ]
        ]
    },
    {
        "id": "1d49e10959ab22bc",
        "type": "api-current-state",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Expensive N hrs",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_expensive_hrs",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.expensive_hrs",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1140,
        "y": 380,
        "wires": [
            [
                "f1168e015522bbfc"
            ]
        ]
    },
    {
        "id": "3d76aa4d40d9ede2",
        "type": "inject",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "On start",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 340,
        "y": 380,
        "wires": [
            [
                "127bc4a04263b3c0"
            ]
        ]
    },
    {
        "id": "127bc4a04263b3c0",
        "type": "function",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Init",
        "func": "msg.dynamic = {};\nmsg.log = [];\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 380,
        "wires": [
            [
                "98d7f59f0b7eab92"
            ]
        ]
    },
    {
        "id": "7f75e4fa1c2d86a0",
        "type": "function",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Generate templates",
        "func": "// final template initialization\nmsg.dynamic.template_cheapest = \"\";\nmsg.dynamic.template_expensive = \"\";\n\n// temporary template parts\nlet template_start = \"\";\nlet template_common = [];\nlet template_cheapest = [];\nlet template_expensive = [];\nlet template_end = \"\";\n\n// 1. IMPROVEMENT: Use radix 10 and Logical OR (||) for cleaner default handling\nconst cheapest_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.cheapest_hrs\"), 10) || 1;\nconst expensive_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.expensive_hrs\"), 10) || 1;\n\n// load the macro\ntemplate_start = `{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n`;\ntemplate_end = `) | to_json }}`;\n\n// collect arguments | strings\nconst stringKeys = [\n    'sensor',\n    'attr_all',\n    'value_key',\n    'attr_today',\n    'attr_tomorrow',\n    'time_key'\n];\n\nstringKeys.forEach(key => {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}='${msg.dynamic[key]}'`);\n    }\n});\n\n// collect arguments | boolean, integer\nconst otherKeys = [\n    'datetime_in_data',\n    'data_minutes',\n];\n\notherKeys.forEach(key => {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}=${msg.dynamic[key]}`);\n    }\n});\n\n// copy common items\ntemplate_cheapest = [...template_common];\ntemplate_expensive = [...template_common];\n\n// collect arguments | cheapest specific\ntemplate_cheapest.push(`hours=${cheapest_hrs}`);\ntemplate_cheapest.push(`include_tomorrow=true`);\ntemplate_cheapest.push(`mode=\"all\"`);\n\n// collect arguments | expensive specific\ntemplate_expensive.push(`hours=${expensive_hrs}`);\ntemplate_expensive.push(`include_tomorrow=true`);\ntemplate_expensive.push(`lowest=false`);\ntemplate_expensive.push(`mode=\"all\"`);\n\n/**\n * Formats an array of strings into a single string:\n * - Each item starts with 4 spaces.\n * - Each item ends with a comma, except the last one.\n * - Items are separated by a newline.\n */\nfunction formatTemplateArray(array) {\n    if (!array || array.length === 0) {\n        return \"\";\n    }\n\n    const indent = \"    \"; \n\n    const formatted_lines = array.map((element, index) => {\n        const suffix = (index < array.length - 1) ? \",\" : \"\";\n        return `${indent}${element}${suffix}`;\n    });\n\n    return formatted_lines.join('\\n');\n}\n\n// generate string templates\nconst template_cheapest_string = formatTemplateArray(template_cheapest);\nconst template_expensive_string = formatTemplateArray(template_expensive);\n\n// done\nmsg.dynamic.template_cheapest = `${template_start}${template_cheapest_string}${template_end}`;\nmsg.dynamic.template_expensive = `${template_start}${template_expensive_string}${template_end}`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 500,
        "wires": [
            [
                "f5f223200fbada06",
                "fedfd15cd6cddaed",
                "f65eeae181ccbc8a"
            ]
        ]
    },
    {
        "id": "f5f223200fbada06",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Template cheapest",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_cheapest",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 500,
        "wires": []
    },
    {
        "id": "fedfd15cd6cddaed",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Template expensive",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_expensive",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 840,
        "y": 540,
        "wires": []
    },
    {
        "id": "f65eeae181ccbc8a",
        "type": "change",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_cheapest",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 580,
        "wires": [
            [
                "2e5b6b44c86f80e3"
            ]
        ]
    },
    {
        "id": "af541182589224a7",
        "type": "change",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_expensive",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 640,
        "wires": [
            [
                "0799b280bf62758e"
            ]
        ]
    },
    {
        "id": "da4428dd14db9967",
        "type": "change",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Cleanup",
        "rules": [
            {
                "t": "delete",
                "p": "template",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 340,
        "y": 700,
        "wires": [
            [
                "adbbd358b213f08e"
            ]
        ]
    },
    {
        "id": "cba4fb540a66e4e6",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Log only",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "log",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 960,
        "wires": []
    },
    {
        "id": "03f47a2f3212cb6b",
        "type": "server-state-changed",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "User input",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.house_battery_strategy_dynamic_cheapest_hrs",
                "input_number.house_battery_strategy_dynamic_expensive_hrs",
                "input_select.house_battery_strategy_dynamic_data_source",
                "input_number.house_battery_strategy_dynamic_threshold_delta"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 340,
        "y": 340,
        "wires": [
            [
                "b97bd9a51080da68"
            ]
        ]
    },
    {
        "id": "1247084c53315208",
        "type": "switch",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Source selected?",
        "property": "dynamic.data_source",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "None",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1395,
        "y": 380,
        "wires": [
            [
                "141ebe1a0441a814"
            ],
            [
                "de24e0e941d08b62"
            ]
        ],
        "l": false
    },
    {
        "id": "4b8c5bc2b8cf6c4d",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Not set",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1620,
        "y": 360,
        "wires": []
    },
    {
        "id": "6e287097dc4e0236",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Avg cheap tariff",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_cheapest_avg_tariff"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_cheapest_tariff }",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 820,
        "y": 800,
        "wires": [
            []
        ]
    },
    {
        "id": "403a9dfa33392328",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Avg expensive tariff",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_expensive_avg_tariff"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_expensive_tariff}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 830,
        "y": 840,
        "wires": [
            []
        ]
    },
    {
        "id": "67e38494d0337403",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Avg delta",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_expensive_avg_delta"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_delta}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 800,
        "y": 880,
        "wires": [
            []
        ]
    },
    {
        "id": "f1168e015522bbfc",
        "type": "api-current-state",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Threshold",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_threshold_delta",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.min_delta_cents",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1300,
        "y": 380,
        "wires": [
            [
                "1247084c53315208"
            ]
        ]
    },
    {
        "id": "141ebe1a0441a814",
        "type": "change",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "null",
        "rules": [
            {
                "t": "set",
                "p": "dynamic_strategy",
                "pt": "flow",
                "to": "null",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1490,
        "y": 360,
        "wires": [
            [
                "4b8c5bc2b8cf6c4d"
            ]
        ]
    },
    {
        "id": "079e2531ed154c01",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "1237795be79af24c",
        "name": "All data",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "all_data",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 1700,
        "wires": []
    },
    {
        "id": "99545071b9bdfd66",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "Complete msg",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 1060,
        "wires": []
    },
    {
        "id": "87e5752435e0ca42",
        "type": "api-current-state",
        "z": "95489b12daee74f5",
        "g": "28a2ae1ba720d063",
        "name": "sub strategy UI value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.house_battery_strategy_active_sub_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "ui_value",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 960,
        "y": 180,
        "wires": [
            [
                "600f70a08a900d1c"
            ]
        ]
    },
    {
        "id": "600f70a08a900d1c",
        "type": "function",
        "z": "95489b12daee74f5",
        "g": "28a2ae1ba720d063",
        "name": "On difference",
        "func": "// Block when equal\nif(msg.ui_value === msg.target) return null;\n\n// Pass otherwise\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1160,
        "y": 180,
        "wires": [
            [
                "16efd2b03d6dece5"
            ]
        ]
    },
    {
        "id": "a5e9e484430e1720",
        "type": "link in",
        "z": "676ceac4c521834d",
        "g": "72059e541379a869",
        "name": "Charge PV",
        "links": [],
        "x": 165,
        "y": 180,
        "wires": [
            [
                "682972c51f2870ed"
            ]
        ]
    },
    {
        "id": "13aeb5c39ba83e0a",
        "type": "comment",
        "z": "676ceac4c521834d",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "bf548077ba6ca350",
        "type": "comment",
        "z": "676ceac4c521834d",
        "g": "72059e541379a869",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "87be4b85f89829b6",
        "type": "link out",
        "z": "676ceac4c521834d",
        "g": "9889d591bcc38e89",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 665,
        "y": 180,
        "wires": []
    },
    {
        "id": "d62d870eb44d3582",
        "type": "comment",
        "z": "676ceac4c521834d",
        "g": "9889d591bcc38e89",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 720,
        "y": 120,
        "wires": []
    },
    {
        "id": "682972c51f2870ed",
        "type": "function",
        "z": "676ceac4c521834d",
        "name": "Setup",
        "func": "// use the self consumption strategy to charge when there is PV surplus\nmsg.target = \"Self-consumption\";\n\n// tell that strategy to disalow discharging\nconst DISABLE_DISCHARGE = true;\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\",DISABLE_DISCHARGE,true);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 180,
        "wires": [
            [
                "17645a134fe6d941"
            ]
        ]
    },
    {
        "id": "17645a134fe6d941",
        "type": "link call",
        "z": "676ceac4c521834d",
        "name": "Self-consumption",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 470,
        "y": 180,
        "wires": [
            [
                "d612533a5317bb76",
                "87be4b85f89829b6",
                "33fd9ce7833604ba"
            ]
        ]
    },
    {
        "id": "d612533a5317bb76",
        "type": "debug",
        "z": "676ceac4c521834d",
        "name": "Batteries charging?",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "batteries_charging",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 730,
        "y": 260,
        "wires": []
    },
    {
        "id": "ce6bb883d5b1f007",
        "type": "api-call-service",
        "z": "676ceac4c521834d",
        "g": "a982ce2192b36fd5",
        "name": "Active sub strategy text field",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_text.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_text.house_battery_strategy_active_sub_strategy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.target}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_text",
        "service": "set_value",
        "x": 1020,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "33fd9ce7833604ba",
        "type": "api-current-state",
        "z": "676ceac4c521834d",
        "g": "a982ce2192b36fd5",
        "name": "User strategy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "master_strategy",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 360,
        "wires": [
            [
                "bba58df78152ef59"
            ]
        ]
    },
    {
        "id": "bba58df78152ef59",
        "type": "switch",
        "z": "676ceac4c521834d",
        "g": "a982ce2192b36fd5",
        "name": "is Charge PV",
        "property": "master_strategy",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Charge PV",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 870,
        "y": 360,
        "wires": [
            [
                "32caf8e345be7b6e"
            ]
        ]
    },
    {
        "id": "32caf8e345be7b6e",
        "type": "function",
        "z": "676ceac4c521834d",
        "g": "a982ce2192b36fd5",
        "name": "Name sub-strategy",
        "func": "msg.target = \"Charge PV\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1050,
        "y": 360,
        "wires": [
            [
                "0d8f2f25053a7fdf"
            ]
        ]
    },
    {
        "id": "0d8f2f25053a7fdf",
        "type": "api-current-state",
        "z": "676ceac4c521834d",
        "g": "a982ce2192b36fd5",
        "name": "UI value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.house_battery_strategy_active_sub_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "ui_value",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 655,
        "y": 420,
        "wires": [
            [
                "28c212820d1b1899"
            ]
        ],
        "l": false
    },
    {
        "id": "28c212820d1b1899",
        "type": "function",
        "z": "676ceac4c521834d",
        "g": "a982ce2192b36fd5",
        "name": "On difference",
        "func": "// Block when equal\nif(msg.ui_value === msg.target) return null;\n\n// Pass otherwise\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 420,
        "wires": [
            [
                "ce6bb883d5b1f007"
            ]
        ]
    }
]