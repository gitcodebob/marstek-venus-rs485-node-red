views:
  - type: sections
    path: home-battery-control
    max_columns: 3
    title: Home battery control
    icon: mdi:home
    sections:
      - type: grid
        cards:
          - type: heading
            heading: Onboarding
            heading_style: title
            icon: mdi:cog-outline
          - type: markdown
            content: '### Step 1'
            text_only: true
          - type: entities
            entities:
              - entity: input_number.house_battery_count
          - type: markdown
            content: '### Step 2'
            text_only: true
          - type: markdown
            content: >-
              <font color=orange><ha-icon icon="mdi:alert"></ha-icon> **Grid
              power n/a**</font>


              Configure your P1 power sensor. 


              1. Edit the file

              `packages/house_battery_control_config.yaml` 

              1. Find the `<< YOUR GRID POWER SENSOR HERE` tag 

              1. Enter your sensor indicating your grid power usage in Watts.
            visibility:
              - condition: or
                conditions:
                  - condition: state
                    entity: sensor.p1_meter_power
                    state: unavailable
                  - condition: state
                    entity: sensor.p1_meter_power
                    state: unknown
          - type: markdown
            content: >+
              <font color=green><ha-icon icon="mdi:check"></ha-icon></font> Grid
              power sensor


            visibility:
              - condition: not
                conditions:
                  - condition: or
                    conditions:
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unavailable
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unknown
          - type: heading
            icon: mdi:pen
            heading: Open file editor
            heading_style: subtitle
            tap_action:
              action: navigate
              navigation_path: /core_configurator
          - type: markdown
            content: '### Step 3'
            text_only: true
          - type: markdown
            content: >-
              <ha-icon icon="mdi:alert"></ha-icon> Import and deploy <font
              color=red>Node-RED</font> scripts.
            visibility:
              - condition: state
                entity: input_boolean.house_battery_control_has_node_red
                state_not: 'on'
          - type: markdown
            content: >-
              <font color=green><ha-icon icon="mdi:check"></ha-icon></font>
              Node-RED ready
            visibility:
              - condition: state
                entity: input_boolean.house_battery_control_has_node_red
                state: 'on'
          - type: markdown
            content: '### Step 4'
            text_only: true
          - type: markdown
            content: >-
              Set the Master Battery Control to `Full Control` only after
              reviewing and checking all installation instructions. 


              Pick a battery charging strategy e.g. `self-consumption` and you
              are done!
          - type: markdown
            content: '### Done'
            text_only: true
            visibility:
              - condition: state
                entity: input_boolean.house_battery_control_has_node_red
                state: 'on'
              - condition: not
                conditions:
                  - condition: or
                    conditions:
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unavailable
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unknown
          - show_name: false
            show_icon: true
            type: button
            entity: input_boolean.house_battery_control_onboarding_finished
            grid_options:
              columns: 2
              rows: 1
            icon: mdi:eye-off-outline
            hold_action:
              action: toggle
            visibility:
              - condition: state
                entity: input_boolean.house_battery_control_has_node_red
                state: 'on'
              - condition: not
                conditions:
                  - condition: or
                    conditions:
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unavailable
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unknown
            icon_height: 25px
          - type: markdown
            text_only: true
            grid_options:
              columns: 9
              rows: 1
            content: |-
              ---
              Hide onboarding
            visibility:
              - condition: state
                entity: input_boolean.house_battery_control_has_node_red
                state: 'on'
              - condition: not
                conditions:
                  - condition: or
                    conditions:
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unavailable
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unknown
          - type: markdown
            content: >-
              _You can find battery settings and unhide onboarding on the
              settings tab._
            grid_options:
              columns: full
              rows: auto
            text_only: true
            visibility:
              - condition: state
                entity: input_boolean.house_battery_control_has_node_red
                state: 'on'
              - condition: not
                conditions:
                  - condition: or
                    conditions:
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unavailable
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unknown
        visibility:
          - condition: not
            conditions:
              - condition: state
                entity: input_boolean.house_battery_control_onboarding_finished
                state: 'on'
      - type: grid
        cards:
          - type: heading
            heading: Master Battery Control
            heading_style: title
            icon: mdi:gamepad-variant-outline
          - type: tile
            grid_options:
              columns: full
            visibility:
              - condition: state
                entity: sensor.ev_is_charging
                state: 'on'
              - condition: state
                entity: input_select.marstek_master_battery_mode
                state: Full control
            entity: sensor.ev_is_charging
            name: EV is charging - Full Stop strategy is active
            color: red
            hide_state: true
            vertical: false
            features_position: bottom
          - features:
              - type: select-options
            type: tile
            entity: input_select.marstek_master_battery_mode
            features_position: bottom
            vertical: false
            show_entity_picture: false
            hide_state: true
            name: Control Mode
            icon: mdi:camera-control
          - type: tile
            entity: input_select.house_battery_strategy
            name: Choose strategy
            show_entity_picture: false
            hide_state: true
            vertical: false
            features:
              - type: select-options
            features_position: bottom
            visibility:
              - condition: state
                entity: input_select.marstek_master_battery_mode
                state: Full control
          - type: heading
            icon: mdi:alert
            heading: 'Dynamic strategy: Full Stop. Please configure dynamic strategy'
            heading_style: subtitle
            tap_action:
              action: navigate
              navigation_path: /home-battery/1
            visibility:
              - condition: state
                entity: input_select.house_battery_strategy_dynamic_data_source
                state: None
              - condition: state
                entity: input_select.house_battery_strategy
                state: Dynamic
          - type: heading
            icon: mdi:information-slab-circle
            heading: 'About strategies '
            heading_style: subtitle
            tap_action:
              action: url
              url_path: >-
                https://gitcodebob.github.io/marstek-venus-rs485-node-red/03-strategies.html
          - type: entities
            entities:
              - entity: input_text.house_battery_strategy_active_sub_strategy
                type: simple-entity
                name: Executing (flow)
            grid_options:
              columns: 12
              rows: auto
            show_header_toggle: false
            state_color: false
            no_background: true
            visibility:
              - condition: state
                entity: input_select.marstek_master_battery_mode
                state: Full control
          - type: history-graph
            entities:
              - entity: input_select.house_battery_strategy
                name: Chosen strategy
              - entity: input_text.house_battery_strategy_active_sub_strategy
                name: Executing
            visibility:
              - condition: state
                entity: input_select.marstek_master_battery_mode
                state: Full control
            hours_to_show: 12
          - type: markdown
            content: |-
              <font color="grey">

              #### Your energy and battery usage</font>
            text_only: true
          - type: history-graph
            entities:
              - entity: input_number.house_battery_control_pid_output
                name: PID control
              - entity: sensor.p1_meter_power
                name: Grid power
              - entity: select.marstek_m1_forcible_charge_discharge
                name: M1
              - entity: select.marstek_m2_forcible_charge_discharge
                name: M2
              - entity: select.marstek_m3_forcible_charge_discharge
                name: M3
              - entity: select.marstek_m4_forcible_charge_discharge
                name: M4
            hours_to_show: 0.05
          - type: heading
            icon: mdi:information
            heading: Self-consumption
            heading_style: subtitle
            tap_action:
              action: navigate
              navigation_path: /home-battery/advanced-settings
          - type: markdown
            content: >-
              <font color=orange><ha-icon icon="mdi:alert"></ha-icon> High
              controller sensitivity, monitor your system</font> use at your own
              risk.
            visibility:
              - condition: or
                conditions:
                  - condition: numeric_state
                    entity: input_number.house_battery_control_kp
                    above: 0.5
                  - condition: numeric_state
                    entity: input_number.house_battery_control_ki
                    above: 0.5
                  - condition: numeric_state
                    entity: input_number.house_battery_control_kd
                    above: 0.5
                  - condition: numeric_state
                    entity: input_number.house_battery_control_error_signal_dampening
                    above: 70
                    below: 0
                  - condition: numeric_state
                    entity: input_number.house_battery_control_pid_output_dampening
                    above: 50
            text_only: true
          - type: entities
            entities:
              - entity: input_select.house_battery_control_pid_presets
                name: Controller sensitivity
          - type: heading
            icon: ''
            heading: Configure custom values
            heading_style: subtitle
            tap_action:
              action: navigate
              navigation_path: /home-battery/advanced-settings
      - type: grid
        cards:
          - type: heading
            heading: Basic battery information
            heading_style: title
            icon: mdi:home-battery-outline
          - type: tile
            entity: sensor.battery_time_remaining
            name: Battery remaining
            icon: mdi:battery-clock
            show_entity_picture: false
            hide_state: false
            vertical: false
            features_position: bottom
            grid_options:
              columns: full
              rows: 1
          - type: heading
            heading: Marstek M1
            heading_style: subtitle
            icon: ''
            visibility:
              - condition: state
                entity: sensor.marstek_m1_device_name
                state_not: unknown
          - type: glance
            entities:
              - entity: sensor.marstek_m1_battery_state_of_charge
                name: M1 SoC
              - entity: sensor.marstek_m1_battery_power
                name: M1 Power
              - entity: number.marstek_m1_max_charge_power
                name: Max Charge
              - entity: number.marstek_m1_max_discharge_power
                name: Max Discharge
            visibility:
              - condition: state
                entity: sensor.marstek_m1_device_name
                state_not: unknown
          - type: heading
            heading: Marstek M2
            heading_style: subtitle
            icon: ''
            visibility:
              - condition: and
                conditions:
                  - condition: state
                    entity: sensor.marstek_m2_device_name
                    state_not: unknown
                  - condition: numeric_state
                    entity: input_number.house_battery_count
                    above: 1
          - type: glance
            entities:
              - entity: sensor.marstek_m2_battery_state_of_charge
                name: M2 SoC
              - entity: sensor.marstek_m2_battery_power
                name: M2 Power
              - entity: number.marstek_m2_max_charge_power
                name: Max Charge
              - entity: number.marstek_m2_max_discharge_power
                name: Max Discharge
            visibility:
              - condition: and
                conditions:
                  - condition: state
                    entity: sensor.marstek_m2_device_name
                    state_not: unknown
                  - condition: numeric_state
                    entity: input_number.house_battery_count
                    above: 1
          - type: heading
            heading: Marstek M3
            heading_style: subtitle
            icon: ''
            visibility:
              - condition: and
                conditions:
                  - condition: state
                    entity: sensor.marstek_m3_device_name
                    state_not: unknown
                  - condition: numeric_state
                    entity: input_number.house_battery_count
                    above: 2
          - type: glance
            entities:
              - entity: sensor.marstek_m3_battery_state_of_charge
                name: M3 SoC
              - entity: sensor.marstek_m3_battery_power
                name: M3 Power
              - entity: number.marstek_m3_max_charge_power
                name: Max Charge
              - entity: number.marstek_m3_max_discharge_power
                name: Max Discharge
            visibility:
              - condition: and
                conditions:
                  - condition: state
                    entity: sensor.marstek_m3_device_name
                    state_not: unknown
                  - condition: numeric_state
                    entity: input_number.house_battery_count
                    above: 2
          - type: heading
            heading: Marstek M4
            heading_style: subtitle
            icon: ''
            visibility:
              - condition: and
                conditions:
                  - condition: state
                    entity: sensor.marstek_m4_device_name
                    state_not: unknown
                  - condition: numeric_state
                    entity: input_number.house_battery_count
                    above: 3
          - type: glance
            entities:
              - entity: sensor.marstek_m4_battery_state_of_charge
                name: M4 SoC
              - entity: sensor.marstek_m4_battery_power
                name: M4 Power
              - entity: number.marstek_m4_max_charge_power
                name: Max Charge
              - entity: number.marstek_m4_max_discharge_power
                name: Max Discharge
            visibility:
              - condition: and
                conditions:
                  - condition: state
                    entity: sensor.marstek_m4_device_name
                    state_not: unknown
                  - condition: numeric_state
                    entity: input_number.house_battery_count
                    above: 3
          - type: heading
            heading: Info and guides
            heading_style: title
            icon: mdi:book-open-page-variant
          - type: heading
            icon: mdi:information-slab-circle
            heading: Online documentation
            heading_style: subtitle
            tap_action:
              action: url
              url_path: https://gitcodebob.github.io/marstek-venus-rs485-node-red/
          - type: heading
            icon: mdi:youtube-subscription
            heading: Youtube (playlist)
            heading_style: subtitle
            tap_action:
              action: url
              url_path: >-
                https://www.youtube.com/playlist?list=PL9wonDMnFmzvm-ln2iHdRE5niDD3ikrKn
    header:
      card:
        type: markdown
        content: '### Home Battery Control *(v4.0.0)*'
        text_only: true
    cards: []
  - type: sections
    max_columns: 3
    icon: mdi:transmission-tower-off
    path: ''
    sections:
      - type: grid
        cards:
          - type: heading
            heading: PID controller (advanced settings)
            heading_style: title
            icon: mdi:cog-box
          - type: markdown
            content: >-
              <font color="grey"><i>These settings tune how aggressive the
              system tries to keep the grid power at the desired power level.
              Too aggressive is unstable! Too safe  will toss efficiency. This
              PID control can outperform Vendor made software by a great margin,
              according to community feedback.

              </i></font>
            text_only: true
          - type: heading
            icon: mdi:information
            heading: Help | setup and tuning PID control
            heading_style: subtitle
            tap_action:
              action: url
              url_path: >-
                https://gitcodebob.github.io/marstek-venus-rs485-node-red/04-setup-self-consumption.html
          - type: markdown
            content: >-
              <font color=yellow><ha-icon icon="mdi:alert"></ha-icon> High
              values - monitor your system</font>, use at your own risk.
            visibility:
              - condition: or
                conditions:
                  - condition: numeric_state
                    entity: input_number.house_battery_control_kp
                    above: 0.5
                  - condition: numeric_state
                    entity: input_number.house_battery_control_ki
                    above: 0.5
                  - condition: numeric_state
                    entity: input_number.house_battery_control_kd
                    above: 0.5
                  - condition: numeric_state
                    entity: input_number.house_battery_control_error_signal_dampening
                    above: 70
                    below: 0
                  - condition: numeric_state
                    entity: input_number.house_battery_control_pid_output_dampening
                    above: 50
            text_only: true
          - type: entities
            entities:
              - entity: input_select.house_battery_control_pid_presets
                name: PID presets
              - entity: input_number.house_battery_control_kp
                name: Proportional gain (Kp)
              - entity: input_number.house_battery_control_ki
                name: Integral gain (Ki)
              - entity: input_number.house_battery_control_kd
                name: Differential gain (Kd)
              - entity: input_number.house_battery_control_error_signal_dampening
                name: Input smoothing
                secondary_info: none
              - entity: input_number.house_battery_control_pid_output_dampening
                name: Output smoothing
              - entity: input_number.house_target_grid_consumption_in_w
                name: Target grid consumption
      - type: grid
        cards:
          - type: heading
            heading: PID history
            heading_style: title
            icon: mdi:cog-box
          - type: markdown
            content: >-
              <font color="grey"><i>Use **PID History** for tuning. It shows the
              internal controller values:


              * **Input (W):** Grid power error (Current vs. Desired)

              * **Output (W):** Target battery power

              * **Output (W):** P-term + I-term + D-term


              </i></font>
            text_only: true
            grid_options:
              columns: full
          - title: PID analysis
            type: history-graph
            entities:
              - entity: input_number.house_battery_control_pid_output
                name: PID output
              - entity: sensor.p1_meter_power
                name: Grid power
              - entity: input_number.house_battery_control_error_signal
                name: PID input
              - entity: input_number.house_battery_control_p_term
                name: P-term
              - entity: input_number.house_battery_control_i_term
                name: I-term
              - entity: input_number.house_battery_control_d_term
                name: D-term
            grid_options:
              columns: full
            hours_to_show: 0.1
        column_span: 2
    title: Self-consumption
    cards: []
    badges:
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: input_select.house_battery_strategy
        name: Choose strategy
        tap_action:
          action: more-info
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: input_text.house_battery_strategy_active_sub_strategy
        show_entity_picture: false
        name: Executing
    header:
      layout: center
      badges_position: top
      badges_wrap: scroll
      card:
        type: markdown
        content: >-
          ### Self-consumption strategy (NoM)

          The **PID controller** steers your batteries to keep grid usage near
          target, _e.g. 0 Watt_, and is used by: 

          _Self-consumption, Charge PV, Charge (regulated), Peak shaving and
          more..._
        text_only: true
  - type: sections
    max_columns: 4
    title: Charge/Sell
    sections:
      - type: grid
        cards:
          - type: heading
            heading: Charge strategy
            heading_style: title
            icon: mdi:battery-charging-80
          - type: heading
            icon: mdi:information-slab-circle
            heading: Settings documentation
            heading_style: subtitle
            tap_action:
              action: url
              url_path: >-
                https://gitcodebob.github.io/marstek-venus-rs485-node-red/03-strategies.html#charge-from-grid
          - type: entities
            entities:
              - entity: input_number.house_battery_strategy_timed_target_energy
                name: Target energy reserve
              - entity: input_boolean.house_battery_strategy_timed_has_max_power
              - type: conditional
                conditions:
                  - entity: input_boolean.house_battery_strategy_timed_has_max_power
                    state: 'off'
                row:
                  type: input-number-entity
                  entity: input_number.house_battery_strategy_timed_target_power
                  name: Target grid consumption
                  icon: mdi:home-import-outline
          - type: markdown
            content: >-
              <font color=grey>_Target energy reserve = desired  usable energy
              in your batteries (e.g. above 12% SoC)_

              </font>
            text_only: true
    icon: mdi:transmission-tower-export
    cards: []
    badges:
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: input_select.house_battery_strategy
        name: Choose strategy
        tap_action:
          action: more-info
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: input_text.house_battery_strategy_active_sub_strategy
        show_entity_picture: false
        name: Executing
    header:
      layout: center
      badges_position: top
      badges_wrap: scroll
  - type: sections
    max_columns: 3
    title: Timed/Dynamic
    icon: mdi:timer-cog-outline
    sections:
      - type: grid
        cards:
          - type: heading
            heading: Timed strategy
            heading_style: title
          - type: heading
            icon: mdi:youtube
            heading: Using the timed strategy
            heading_style: subtitle
            tap_action:
              action: url
              url_path: https://youtu.be/UbeJaRjFK_o?t=53s
          - type: entities
            entities:
              - entity: input_select.house_battery_strategy_timed_strat_0
                name: Default strategy
            grid_options:
              columns: 9
              rows: auto
          - clock_style: digital
            clock_size: small
            show_seconds: false
            no_background: true
            type: clock
            grid_options:
              columns: 3
              rows: 1
            title: Time
            face_style: markers
          - type: entities
            entities:
              - entity: input_datetime.house_battery_strategy_timed_period_a1
              - entity: input_select.house_battery_strategy_timed_strat_a
              - entity: input_datetime.house_battery_strategy_timed_period_a2
          - type: tile
            grid_options:
              columns: full
            entity: input_boolean.house_battery_strategy_timed_has_period_b
            name: Add period
            icon: mdi:plus
            color: blue-grey
            show_entity_picture: false
            hide_state: true
            vertical: false
            tap_action:
              action: toggle
            features_position: bottom
            visibility:
              - condition: state
                entity: input_boolean.house_battery_strategy_timed_has_period_b
                state: 'off'
          - type: entities
            entities:
              - entity: input_datetime.house_battery_strategy_timed_period_b1
              - entity: input_select.house_battery_strategy_timed_strat_b
              - entity: input_datetime.house_battery_strategy_timed_period_b2
            visibility:
              - condition: state
                entity: input_boolean.house_battery_strategy_timed_has_period_b
                state: 'on'
          - type: tile
            entity: input_boolean.house_battery_strategy_timed_has_period_c
            name: Add period
            icon: mdi:plus
            color: blue-grey
            show_entity_picture: false
            hide_state: true
            vertical: false
            tap_action:
              action: toggle
            features_position: bottom
            visibility:
              - condition: and
                conditions:
                  - condition: state
                    entity: input_boolean.house_battery_strategy_timed_has_period_b
                    state: 'on'
                  - condition: state
                    entity: input_boolean.house_battery_strategy_timed_has_period_c
                    state: 'off'
          - type: tile
            entity: input_boolean.house_battery_strategy_timed_has_period_b
            name: Remove period
            icon: mdi:minus
            color: red
            show_entity_picture: false
            hide_state: true
            vertical: false
            tap_action:
              action: toggle
            features_position: bottom
            visibility:
              - condition: and
                conditions:
                  - condition: state
                    entity: input_boolean.house_battery_strategy_timed_has_period_b
                    state: 'on'
                  - condition: state
                    entity: input_boolean.house_battery_strategy_timed_has_period_c
                    state: 'off'
          - type: entities
            entities:
              - entity: input_datetime.house_battery_strategy_timed_period_c1
              - entity: input_select.house_battery_strategy_timed_strat_c
              - entity: input_datetime.house_battery_strategy_timed_period_c2
            visibility:
              - condition: state
                entity: input_boolean.house_battery_strategy_timed_has_period_c
                state: 'on'
          - type: tile
            grid_options:
              columns: full
            visibility:
              - condition: state
                entity: input_boolean.house_battery_strategy_timed_has_period_c
                state: 'on'
            entity: input_boolean.house_battery_strategy_timed_has_period_c
            name: Remove period
            icon: mdi:minus
            color: red
            show_entity_picture: false
            hide_state: true
            vertical: false
            tap_action:
              action: toggle
            features_position: bottom
      - type: grid
        cards:
          - type: heading
            heading: Dynamic strategy
            heading_style: title
          - type: markdown
            content: >-
              <font color=orange><ha-icon icon="mdi:alert"></ha-icon> Cheapest
              Hours integration not installed</font>


              This strategy uses [the Cheapest Hours integration from
              TheFes](https://github.com/TheFes/cheapest-energy-hours/tree/main?tab=readme-ov-file#how-to-install).

              Please install via HACS or follow his instructions.
            text_only: true
            visibility:
              - condition: or
                conditions:
                  - condition: state
                    entity: update.cheapest_energy_hours_update
                    state: unavailable
                  - condition: state
                    entity: update.cheapest_energy_hours_update
                    state: unknown
          - type: heading
            icon: mdi:information
            heading_style: subtitle
            tap_action:
              action: url
              url_path: >-
                https://gitcodebob.github.io/marstek-venus-rs485-node-red/05-setup-dynamic.html#setup-getting-dynamic-up-and-running
            visibility:
              - condition: or
                conditions:
                  - condition: state
                    entity: update.cheapest_energy_hours_update
                    state: unavailable
                  - condition: state
                    entity: update.cheapest_energy_hours_update
                    state: unknown
            heading: Setup instructions dynamic strategy
          - type: heading
            icon: mdi:information
            heading: Using the dynamic strategy
            heading_style: subtitle
            tap_action:
              action: url
              url_path: >-
                https://gitcodebob.github.io/marstek-venus-rs485-node-red/05-setup-dynamic.html#use-the-dynamic-strategy
            visibility:
              - condition: not
                conditions:
                  - condition: state
                    entity: update.cheapest_energy_hours_update
                    state: unavailable
                  - condition: state
                    entity: update.cheapest_energy_hours_update
                    state: unknown
          - type: entities
            entities:
              - entity: input_select.house_battery_strategy_dynamic_data_source
          - type: entities
            entities:
              - entity: input_number.house_battery_strategy_dynamic_threshold_delta
                name: Minimum price delta
          - type: tile
            entity: input_number.house_battery_strategy_dynamic_cheapest_hrs
            hide_state: true
            vertical: false
            features:
              - type: numeric-input
                style: buttons
            features_position: bottom
          - type: tile
            entity: input_number.house_battery_strategy_dynamic_expensive_hrs
            hide_state: true
            vertical: false
            features:
              - type: numeric-input
                style: buttons
            features_position: bottom
          - type: heading
            icon: mdi:information
            heading_style: subtitle
            heading: Calculated periods and tariffs
            tap_action:
              action: url
              url_path: >-
                https://gitcodebob.github.io/marstek-venus-rs485-node-red/05-setup-dynamic.html#period-startend-times-read-only
          - type: entities
            entities:
              - entity: input_datetime.house_battery_strategy_dynamic_cheapest_start
                type: simple-entity
              - entity: input_datetime.house_battery_strategy_dynamic_cheapest_end
                type: simple-entity
              - entity: input_datetime.house_battery_strategy_dynamic_expensive_start
                type: simple-entity
              - entity: input_datetime.house_battery_strategy_dynamic_expensive_end
                type: simple-entity
            visibility:
              - condition: state
                entity: input_select.house_battery_strategy_dynamic_data_source
                state_not: None
          - show_name: true
            show_icon: true
            show_state: true
            type: glance
            entities:
              - entity: >-
                  input_number.house_battery_strategy_dynamic_expensive_avg_tariff
                type: simple-entity
                name: Expensive period
              - entity: >-
                  input_number.house_battery_strategy_dynamic_cheapest_avg_tariff
                type: simple-entity
                name: Charged at
              - entity: >-
                  input_number.house_battery_strategy_dynamic_expensive_avg_delta
                type: simple-entity
                name: Price delta
            visibility:
              - condition: state
                entity: input_select.house_battery_strategy_dynamic_data_source
                state_not: None
          - type: markdown
            content: >-
              #### Information

              | Period      | Strategy |

              | ----------- | ----------- |

              | Default     | Charge PV   |

              | Cheapest    | Charge      |

              | Expensive   | Self-consumption |


              1. _Use the settings on this dashboard to tune the strategies_

              1. _Timed and Dynamic share the same settings_

              1. _Note: currently it is not possible to change the strategy per
              period via this dashboard_
    cards: []
    badges:
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: input_select.house_battery_strategy
        name: Choose strategy
        tap_action:
          action: more-info
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: input_text.house_battery_strategy_active_sub_strategy
        show_entity_picture: false
        name: Executing
    header:
      layout: center
      badges_position: top
      badges_wrap: scroll
  - type: sections
    max_columns: 3
    icon: mdi:spider-outline
    path: ''
    background:
      opacity: 10
      alignment: center
      size: cover
      repeat: repeat
      attachment: fixed
    sections:
      - type: grid
        cards:
          - type: heading
            heading: Node-RED
            heading_style: title
          - type: heading
            icon: mdi:list-status
            heading: ðŸ•µï¸ Flow trace
            heading_style: subtitle
          - type: markdown
            content: >-
              **Strategy:** {{ states('input_select.house_battery_strategy')}}

              ***

              {% set history = state_attr('sensor.home_battery_control_trace',
              'history') or [] %} {% set start_ts =
              state_attr('sensor.home_battery_control_trace', 'start') %} {% set
              end_ts = state_attr('sensor.home_battery_control_trace', 'end') %}
              {% set start_dt = (start_ts / 1000) | as_datetime if start_ts is
              number else as_datetime(start_ts) %} {% set end_dt = (end_ts /
              1000) | as_datetime if end_ts is number else as_datetime(end_ts)
              %} {% set total_dt = (end_dt - start_dt).total_seconds() if end_dt
              and start_dt else 0 %}

              Flows used

              | Step | Flow | Duration |

              | :--- | :--- | :--- |

              {% set first_ts = history[0].timestamp if history|length > 0 else
              end_ts %} {% set first_dt = (first_ts / 1000) | as_datetime if
              first_ts is number else as_datetime(first_ts) %} {% set d0 =
              (first_dt - start_dt).total_seconds() if first_dt and start_dt
              else 0 %} | 0 | Home battery start | `{{ "{:.3f}".format(d0) }}s`
              |

              {% for entry in history -%}
                {%- set ts = entry.timestamp -%}
                {%- set current_dt = (ts / 1000) | as_datetime if ts is number else as_datetime(ts) -%}
                {%- if not loop.last -%}
                  {%- set next_ts = history[loop.index].timestamp -%}
                {%- else -%}
                  {%- set next_ts = end_ts -%}
                {%- endif -%}    
                {%- set next_dt = (next_ts / 1000) | as_datetime if next_ts is number else as_datetime(next_ts) -%}
                {%- set delta = (next_dt - current_dt).total_seconds() if next_dt and current_dt else 0 -%}
                | {{ loop.index }} | {{ entry.flow }} | `{{ "{:.3f}".format(delta) }}s` |
              {% endfor %} | âœ”ï¸ | Home Battery Start | `Done` |


              **Total `{{ "{:.3f}".format(total_dt) }}s`** spent in strategy
              flows
      - type: grid
        cards:
          - type: heading
            heading: Insight
            heading_style: title
          - type: heading
            icon: mdi:list-box-outline
            heading: ðŸ“‹ Explenations (last 100 items)
            heading_style: subtitle
          - type: markdown
            content: >
              {% set logs = state_attr('sensor.home_battery_control_log', 'log')
              %}  {% if logs %}

              | Time |  | Flow | Node | Explenation |

              | :--- | :--- | :--- | :--- | :--- |
                {%- for entry in logs %}
                {%- set color = '#009ac7' -%}
                {%- if entry.level == 'log' %}{% set color = '#38cd9e' -%}
                {%- elif entry.level == 'warn' %}{% set color = 'orange' -%}
                {%- elif entry.level == 'error' %}{% set color = 'red' -%}
                {%- endif %}
                | {{ entry.timestamp }} | {{ entry.icon }} |<font color="{{color}}">{{ entry.flow }}</font> | {{ entry.node }} |{{ entry.payload }} |
                {%- endfor %}
              {% else %}
                No logs available
              {% endif %}
            grid_options:
              columns: full
        column_span: 2
    header:
      card:
        type: markdown
        text_only: true
        content: >-
          ### Debug

          Need help figuring out what is going on? 

          Hit **Debug mode**. _Auto-off after 5min._

          ðŸ“˜ [Troubleshooting
          documentation](https://gitcodebob.github.io/marstek-venus-rs485-node-red/07-troubleshooting.html)
      layout: center
      badges_position: top
      badges_wrap: scroll
    badges:
      - type: entity
        show_name: true
        show_state: false
        show_icon: true
        entity: input_boolean.house_battery_control_is_debug_mode
        tap_action:
          action: toggle
        name:
          type: entity
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: input_select.house_battery_strategy
        name: Choose strategy
        tap_action:
          action: more-info
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: input_text.house_battery_strategy_active_sub_strategy
        show_entity_picture: false
        name: Executing
    cards: []
  - type: sections
    max_columns: 3
    title: Advanced settings
    path: advanced-settings
    icon: mdi:cog-outline
    sections:
      - type: grid
        cards:
          - type: heading
            heading: General
            heading_style: title
            icon: mdi:home
          - type: entities
            entities:
              - entity: input_number.house_battery_count
          - type: tile
            visibility:
              - condition: state
                entity: input_boolean.house_battery_control_has_node_red
                state: 'on'
              - condition: not
                conditions:
                  - condition: or
                    conditions:
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unavailable
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unknown
            entity: input_boolean.house_battery_control_onboarding_finished
            name: Show/Hide onboarding
            icon: mdi:eye-off-outline
            color: disabled
            show_entity_picture: false
            hide_state: true
            vertical: false
            tap_action:
              action: toggle
            features_position: bottom
            grid_options:
              columns: full
      - type: grid
        cards:
          - type: heading
            heading: Battery life
            heading_style: title
            icon: mdi:medication
          - type: heading
            icon: mdi:information
            heading: Cycle which battery to charge first
            heading_style: subtitle
            tap_action:
              action: url
              url_path: >-
                https://github.com/gitcodebob/marstek-venus-rs485-node-red/blob/main/README.md#advanced-features
          - show_name: true
            show_icon: true
            show_state: true
            type: glance
            entities:
              - entity: input_number.house_battery_control_prioritize_battery
                name: 'Battery #'
              - entity: input_select.house_battery_control_priority_change_interval
            state_color: false
            columns: 3
          - type: heading
            icon: mdi:information
            heading: Optimize stop and go behavior
            heading_style: subtitle
            tap_action:
              action: url
              url_path: >-
                https://github.com/gitcodebob/marstek-venus-rs485-node-red?tab=readme-ov-file#battery-life
          - type: entities
            entities:
              - entity: input_number.house_battery_control_idle_time
                name: Stop after Idle for
              - entity: input_number.house_battery_control_hysteresis_in_w
                name: 'Hysteresis '
                secondary_info: none
      - type: grid
        cards:
          - type: heading
            heading: EV Stop Trigger
            heading_style: title
            icon: mdi:power-plug-off
          - type: markdown
            content: >-
              <font color=grey>The Stop Trigger will OVERRULE ALL active
              strategies.

              _E.g. use to disengage your home batteries when EV is
              charging_</font>
            text_only: true
          - type: entities
            entities:
              - entity: input_text.house_battery_strategy_ev_sensor_entity_id
                secondary_info: none
          - type: markdown
            content: >-
              <font color=grey>Enter the `entity_id` of an `input_boolean` or
              `on/off template_sensor` in the field above</font>
            text_only: true
          - type: tile
            grid_options:
              columns: full
            entity: sensor.ev_is_charging
            name: EV stop trigger
            vertical: false
            features_position: bottom
          - type: markdown
            content: >-
              <font color=grey>The `EV stop trigger` should now indicate wether
              an all stop has been triggered. Stop trigger 'on' = batteries
              'Full stop'.</font>
            text_only: true
      - type: grid
        cards:
          - type: markdown
            content: '---'
            grid_options:
              columns: full
            text_only: true
        column_span: 3
      - type: grid
        cards:
          - type: heading
            icon: mdi:power-plug-battery
            heading: Marstek M1
            heading_style: title
          - type: vertical-stack
            cards:
              - type: markdown
                content: '**<font color="#9b9b9b">Discharging</font>**'
                text_only: true
              - type: tile
                entity: input_number.marstek_m1_discharging_cutoff_capacity
                name: Cutoff capacity
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
              - type: tile
                entity: number.marstek_m1_max_discharge_power
                name: Max Power
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
            grid_options:
              columns: 12
              rows: auto
          - type: vertical-stack
            cards:
              - type: markdown
                content: '**<font color="#9b9b9b">Charging</font>**'
                text_only: true
              - type: tile
                grid_options:
                  columns: 12
                  rows: 2
                entity: input_number.marstek_m1_charging_cutoff_capacity
                name: Cutoff capacity
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
              - type: tile
                grid_options:
                  columns: 12
                  rows: 2
                entity: number.marstek_m1_max_charge_power
                name: 'Max. Power '
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
          - type: heading
            icon: mdi:information-slab-circle
            heading: Cutoff capacities
            heading_style: subtitle
            tap_action:
              action: url
              url_path: >-
                https://gitcodebob.github.io/marstek-venus-rs485-node-red/06-advanced-features.html#chargingdischarging-limits
      - type: grid
        cards:
          - type: heading
            icon: mdi:power-plug-battery
            heading: Marstek M2
            heading_style: title
          - type: vertical-stack
            cards:
              - type: markdown
                content: '**<font color="#9b9b9b">Discharging</font>**'
                text_only: true
              - type: tile
                entity: input_number.marstek_m2_discharging_cutoff_capacity
                name: Cutoff capacity
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
              - type: tile
                entity: number.marstek_m2_max_discharge_power
                name: Max Power
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
            grid_options:
              columns: 12
              rows: auto
          - type: vertical-stack
            cards:
              - type: markdown
                content: '**<font color="#9b9b9b">Charging</font>**'
                text_only: true
              - type: tile
                grid_options:
                  columns: 12
                  rows: 2
                entity: input_number.marstek_m2_charging_cutoff_capacity
                name: Cutoff capacity
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
              - type: tile
                grid_options:
                  columns: 12
                  rows: 2
                entity: number.marstek_m2_max_charge_power
                name: 'Max. Power '
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
        visibility:
          - condition: numeric_state
            entity: input_number.house_battery_count
            above: 1
      - type: grid
        cards:
          - type: heading
            icon: mdi:power-plug-battery
            heading: Marstek M3
            heading_style: title
          - type: vertical-stack
            cards:
              - type: markdown
                content: '**<font color="#9b9b9b">Discharging</font>**'
                text_only: true
              - type: tile
                entity: input_number.marstek_m3_discharging_cutoff_capacity
                name: Cutoff capacity
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
              - type: tile
                entity: number.marstek_m3_max_discharge_power
                name: Max Power
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
            grid_options:
              columns: 12
              rows: auto
          - type: vertical-stack
            cards:
              - type: markdown
                content: '**<font color="#9b9b9b">Charging</font>**'
                text_only: true
              - type: tile
                grid_options:
                  columns: 12
                  rows: 2
                entity: input_number.marstek_m3_charging_cutoff_capacity
                name: Cutoff capacity
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
              - type: tile
                grid_options:
                  columns: 12
                  rows: 2
                entity: number.marstek_m3_max_charge_power
                name: 'Max. Power '
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
        visibility:
          - condition: numeric_state
            entity: input_number.house_battery_count
            above: 2
      - type: grid
        cards:
          - type: heading
            icon: mdi:power-plug-battery
            heading: Marstek M4
            heading_style: title
          - type: vertical-stack
            cards:
              - type: markdown
                content: '**<font color="#9b9b9b">Discharging</font>**'
                text_only: true
              - type: tile
                entity: input_number.marstek_m4_discharging_cutoff_capacity
                name: Cutoff capacity
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
              - type: tile
                entity: number.marstek_m4_max_discharge_power
                name: Max Power
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
            grid_options:
              columns: 12
              rows: auto
          - type: vertical-stack
            cards:
              - type: markdown
                content: '**<font color="#9b9b9b">Charging</font>**'
                text_only: true
              - type: tile
                grid_options:
                  columns: 12
                  rows: 2
                entity: input_number.marstek_m4_charging_cutoff_capacity
                name: Cutoff capacity
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
              - type: tile
                grid_options:
                  columns: 12
                  rows: 2
                entity: number.marstek_m4_max_charge_power
                name: 'Max. Power '
                hide_state: true
                vertical: false
                features:
                  - type: numeric-input
                    style: buttons
                features_position: inline
        visibility:
          - condition: numeric_state
            entity: input_number.house_battery_count
            above: 3
    cards: []
    badges:
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: input_select.house_battery_strategy
        name: Choose strategy
        tap_action:
          action: more-info
      - type: entity
        show_name: true
        show_state: true
        show_icon: true
        entity: input_text.house_battery_strategy_active_sub_strategy
        show_entity_picture: false
        name: Executing
    header:
      layout: center
      badges_position: top
      badges_wrap: scroll
