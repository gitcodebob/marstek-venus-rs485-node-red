views:
  - type: sections
    path: home-battery-control
    max_columns: 3
    title: Home battery control
    icon: mdi:home-battery-outline
    sections:
      - type: grid
        cards:
          - type: heading
            heading: Configuration
            heading_style: title
            icon: mdi:cog-outline
          - type: markdown
            content: '### Step 1'
            text_only: true
          - type: entities
            entities:
              - entity: input_number.house_battery_count
          - type: markdown
            content: '### Step 2'
            text_only: true
          - type: markdown
            content: >-
              <font color=yellow><ha-icon icon="mdi:alert"></ha-icon> **Grid
              power n/a**</font>


              Configure your P1 power sensor. 


              1. Edit the file

              `packages/house_battery_control_config.yaml` 

              1. Find the `<< YOUR GRID POWER SENSOR HERE` tag 

              1. Enter your sensor indicating your grid power usage in Watts.
            visibility:
              - condition: or
                conditions:
                  - condition: state
                    entity: sensor.p1_meter_power
                    state: unavailable
                  - condition: state
                    entity: sensor.p1_meter_power
                    state: unknown
          - type: markdown
            content: >+
              <font color=green><ha-icon icon="mdi:check"></ha-icon></font> Grid
              power sensor


            visibility:
              - condition: not
                conditions:
                  - condition: or
                    conditions:
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unavailable
                      - condition: state
                        entity: sensor.p1_meter_power
                        state: unknown
          - type: heading
            icon: mdi:pen
            heading: Open file editor
            heading_style: subtitle
            tap_action:
              action: url
              url_path: /core_configurator/ingress
          - type: markdown
            content: '### Step 3'
            text_only: true
          - type: markdown
            content: >-
              <ha-icon icon="mdi:alert"></ha-icon> Import and deploy <font
              color=red>Node-RED</font> scripts.
            visibility:
              - condition: state
                entity: input_boolean.house_battery_control_has_node_red
                state_not: 'on'
          - type: markdown
            content: >-
              <font color=green><ha-icon icon="mdi:check"></ha-icon></font>
              Node-RED ready
            visibility:
              - condition: state
                entity: input_boolean.house_battery_control_has_node_red
                state: 'on'
          - type: markdown
            content: '### Step 4'
            text_only: true
          - type: markdown
            content: >-
              Set the Master Battery Control to `Full Control` only after
              reviewing and checking all installation instructions. 


              Pick a battery charging strategy e.g. `self-consumption` and you
              are done!
      - type: grid
        cards:
          - type: heading
            heading: Master Battery Control
            heading_style: title
            icon: mdi:gamepad-variant-outline
          - features:
              - type: select-options
            type: tile
            entity: input_select.marstek_master_battery_mode
            features_position: bottom
            vertical: false
            show_entity_picture: false
            hide_state: true
            name: Control Mode
            icon: mdi:camera-control
          - features:
              - type: select-options
            type: tile
            entity: input_select.house_battery_strategy
            features_position: bottom
            vertical: false
            hide_state: true
            show_entity_picture: false
            name: Full Control Strategy
          - type: history-graph
            entities:
              - entity: input_number.house_battery_control_pid_output
              - entity: sensor.p1_meter_power
              - entity: select.marstek_m1_forcible_charge_discharge
                name: M1
              - entity: select.marstek_m2_forcible_charge_discharge
                name: M2
              - entity: select.marstek_m3_forcible_charge_discharge
                name: M3
            hours_to_show: 0.05
          - type: markdown
            content: '### Settings'
            text_only: true
          - type: heading
            icon: mdi:information
            heading: Charge this battery first
            heading_style: subtitle
            tap_action:
              action: url
              url_path: >-
                https://github.com/gitcodebob/marstek-venus-rs485-node-red/blob/main/README.md#advanced-features
          - show_name: true
            show_icon: true
            show_state: true
            type: glance
            entities:
              - entity: input_number.house_battery_control_prioritize_battery
                name: 'Battery #'
              - entity: input_select.house_battery_control_priority_change_interval
            state_color: false
            columns: 3
          - type: heading
            icon: mdi:information
            heading: Battery life improvement
            heading_style: subtitle
            tap_action:
              action: url
              url_path: >-
                https://github.com/gitcodebob/marstek-venus-rs485-node-red?tab=readme-ov-file#battery-life
          - type: entities
            entities:
              - entity: input_number.house_battery_control_idle_time
                name: Stop after Idle for
              - entity: input_number.house_battery_control_hysteresis_in_w
                name: 'Hysteresis '
                secondary_info: none
          - type: markdown
            content: '### PID settings'
            text_only: true
          - type: markdown
            content: >-
              <font color=yellow><ha-icon icon="mdi:alert"></ha-icon> **High
              values - monitor your system**</font>

              Use at your own risk.
            visibility:
              - condition: or
                conditions:
                  - condition: numeric_state
                    entity: input_number.house_battery_control_kp
                    above: 0.5
                  - condition: numeric_state
                    entity: input_number.house_battery_control_ki
                    above: 0.5
                  - condition: numeric_state
                    entity: input_number.house_battery_control_kd
                    above: 0.5
                  - condition: numeric_state
                    entity: input_number.house_battery_control_error_signal_dampening
                    above: 0.7
                    below: 0
                  - condition: numeric_state
                    entity: input_number.house_battery_control_pid_output_dampening
                    above: 0.5
            text_only: true
          - type: heading
            icon: mdi:information
            heading: PID setup and tuning (howto)
            heading_style: subtitle
            tap_action:
              action: url
              url_path: >-
                https://github.com/gitcodebob/marstek-venus-rs485-node-red?tab=readme-ov-file#operation-and-tuning-minimal
          - type: entities
            entities:
              - entity: input_select.house_battery_control_pid_presets
                name: PID presets
              - entity: input_number.house_battery_control_kp
                name: Proportional gain (Kp)
              - entity: input_number.house_battery_control_ki
                name: Integral gain (Ki)
              - entity: input_number.house_battery_control_kd
                name: Differential gain (Kd)
              - entity: input_number.house_battery_control_error_signal_dampening
                name: Input smoothing
                secondary_info: none
              - entity: input_number.house_battery_control_pid_output_dampening
                name: Output smoothing
              - entity: input_number.house_target_grid_consumption_in_w
                name: Target grid consumption
          - type: markdown
            content: '#### "Grid charge or Wait" strategy'
            text_only: true
          - type: entities
            show_header_toggle: false
            entities:
              - entity: input_datetime.strategy_accu_grid_charge_or_wait_start_at
                name: Start grid charging / wait at
              - entity: input_datetime.strategy_accu_grid_charge_or_wait_stop_at
                name: Stop grid charging / wait at
              - entity: input_boolean.strategy_accu_grid_charge_or_wait_charge_enabled
                name: Charge during strategy
              - entity: >-
                  input_number.strategy_accu_grid_charge_or_wait_total_target_capacity
                name: Grid charging target capacity
              - entity: >-
                  input_select.strategy_accu_grid_charge_or_wait_switch_to_strategy_when_finished
                name: Switch to strategy when finished
      - type: grid
        cards:
          - type: heading
            heading: Basic battery information
            heading_style: title
            icon: mdi:home-battery-outline
          - type: tile
            entity: sensor.battery_time_remaining
            icon: mdi:battery-clock
            show_entity_picture: false
            hide_state: false
            vertical: false
            features_position: bottom
            grid_options:
              columns: full
          - type: heading
            heading: Marstek M1
            heading_style: subtitle
            icon: ''
            visibility:
              - condition: state
                entity: sensor.marstek_m1_device_name
                state_not: unknown
          - type: glance
            entities:
              - entity: sensor.marstek_m1_battery_state_of_charge
                name: M1 SoC
              - entity: sensor.marstek_m1_battery_power
                name: M1 Power
              - entity: number.marstek_m1_max_charge_power
                name: Max Charge
              - entity: number.marstek_m1_max_discharge_power
                name: Max Discharge
            visibility:
              - condition: state
                entity: sensor.marstek_m1_device_name
                state_not: unknown
          - type: heading
            heading: Marstek M2
            heading_style: subtitle
            icon: ''
            visibility:
              - condition: and
                conditions:
                  - condition: state
                    entity: sensor.marstek_m2_device_name
                    state_not: unknown
                  - condition: numeric_state
                    entity: input_number.house_battery_count
                    above: 1
          - type: glance
            entities:
              - entity: sensor.marstek_m2_battery_state_of_charge
                name: M2 SoC
              - entity: sensor.marstek_m2_battery_power
                name: M2 Power
              - entity: number.marstek_m2_max_charge_power
                name: Max Charge
              - entity: number.marstek_m2_max_discharge_power
                name: Max Discharge
            visibility:
              - condition: and
                conditions:
                  - condition: state
                    entity: sensor.marstek_m2_device_name
                    state_not: unknown
                  - condition: numeric_state
                    entity: input_number.house_battery_count
                    above: 1
          - type: heading
            heading: Marstek M3
            heading_style: subtitle
            icon: ''
            visibility:
              - condition: and
                conditions:
                  - condition: state
                    entity: sensor.marstek_m3_device_name
                    state_not: unknown
                  - condition: numeric_state
                    entity: input_number.house_battery_count
                    above: 2
          - type: glance
            entities:
              - entity: sensor.marstek_m3_battery_state_of_charge
                name: M3 SoC
              - entity: sensor.marstek_m3_battery_power
                name: M3 Power
              - entity: number.marstek_m3_max_charge_power
                name: Max Charge
              - entity: number.marstek_m3_max_discharge_power
                name: Max Discharge
            visibility:
              - condition: and
                conditions:
                  - condition: state
                    entity: sensor.marstek_m3_device_name
                    state_not: unknown
                  - condition: numeric_state
                    entity: input_number.house_battery_count
                    above: 2
      - cards:
          - type: heading
            heading: Histrory
          - title: PID analysis
            type: history-graph
            entities:
              - entity: input_number.house_battery_control_error_signal
              - entity: sensor.p1_meter_vermogen
              - entity: input_number.house_battery_control_pid_output
              - entity: input_number.house_battery_control_p_term
              - entity: input_number.house_battery_control_i_term
              - entity: input_number.house_battery_control_d_term
            grid_options:
              columns: full
            hours_to_show: 0.1
        column_span: 3
    header:
      card:
        type: markdown
        content: |-
          # Home batteries
          Configuration and settings (v2.3.0)
        text_only: true
